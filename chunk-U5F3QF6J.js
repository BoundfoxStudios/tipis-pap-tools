import{a as ws}from"./chunk-IUOXFPV3.js";import{a as Xe,b as Fs,c as Jr,d as Ne}from"./chunk-TMC7WMLO.js";var kn=Object.defineProperty,Vn=(n,t,e)=>t in n?kn(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,ot=(n,t,e)=>(Vn(n,typeof t!="symbol"?t+"":t,e),e),zr=(n,t,e)=>{if(!t.has(n))throw TypeError("Cannot "+e)},z=(n,t,e)=>(zr(n,t,"read from private field"),e?e.call(n):t.get(n)),je=(n,t,e)=>{if(t.has(n))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(n):t.set(n,e)},$e=(n,t,e,i)=>(zr(n,t,"write to private field"),i?i.call(n,e):t.set(n,e),e),Ei=(n,t,e,i)=>({set _(s){$e(n,t,s,e)},get _(){return z(n,t,i)}}),Gn=(n,t,e)=>(zr(n,t,"access private method"),e),J=class n{static WithinEpsilon(t,e,i=1401298e-51){return Math.abs(t-e)<=i}static ToHex(t){let e=t.toString(16);return t<=15?("0"+e).toUpperCase():e.toUpperCase()}static Sign(t){return t=+t,t===0||isNaN(t)?t:t>0?1:-1}static Clamp(t,e=0,i=1){return Math.min(i,Math.max(e,t))}static Log2(t){return Math.log(t)*Math.LOG2E}static ILog2(t){if(Math.log2)return Math.floor(Math.log2(t));if(t<0)return NaN;if(t===0)return-1/0;let e=0;if(t<1){for(;t<1;)e++,t=t*2;e=-e}else if(t>1)for(;t>1;)e++,t=Math.floor(t/2);return e}static Repeat(t,e){return t-Math.floor(t/e)*e}static Normalize(t,e,i){return(t-e)/(i-e)}static Denormalize(t,e,i){return t*(i-e)+e}static DeltaAngle(t,e){let i=n.Repeat(e-t,360);return i>180&&(i-=360),i}static PingPong(t,e){let i=n.Repeat(t,e*2);return e-Math.abs(i-e)}static SmoothStep(t,e,i){let s=n.Clamp(i);return s=-2*s*s*s+3*s*s,e*s+t*(1-s)}static MoveTowards(t,e,i){let s=0;return Math.abs(e-t)<=i?s=e:s=t+n.Sign(e-t)*i,s}static MoveTowardsAngle(t,e,i){let s=n.DeltaAngle(t,e),r=0;return-i<s&&s<i?r=e:(e=t+s,r=n.MoveTowards(t,e,i)),r}static Lerp(t,e,i){return t+(e-t)*i}static LerpAngle(t,e,i){let s=n.Repeat(e-t,360);return s>180&&(s-=360),t+s*n.Clamp(i)}static InverseLerp(t,e,i){let s=0;return t!=e?s=n.Clamp((i-t)/(e-t)):s=0,s}static Hermite(t,e,i,s,r){let a=r*r,o=r*a,h=2*o-3*a+1,l=-2*o+3*a,c=o-2*a+r,d=o-a;return t*h+i*l+e*c+s*d}static Hermite1stDerivative(t,e,i,s,r){let a=r*r;return(a-r)*6*t+(3*a-4*r+1)*e+(-a+r)*6*i+(3*a-2*r)*s}static RandomRange(t,e){return t===e?t:Math.random()*(e-t)+t}static RangeToPercent(t,e,i){return(t-e)/(i-e)}static PercentToRange(t,e,i){return(i-e)*t+e}static NormalizeRadians(t){return t-=n.TwoPi*Math.floor((t+Math.PI)/n.TwoPi),t}static HCF(t,e){let i=t%e;return i===0?e:n.HCF(e,i)}};J.TwoPi=Math.PI*2;var ni=1/2.2,ai=2.2,_e=.001,we=class n{static BuildArray(t,e){let i=[];for(let s=0;s<t;++s)i.push(e());return i}static BuildTuple(t,e){return n.BuildArray(t,e)}};function Wn(n,t,e){let i=n[t];if(typeof i!="function")return null;let s=function(){let r=n.length,a=s.previous.apply(n,arguments);return e(t,r),a};return i.next=s,s.previous=i,n[t]=s,()=>{let r=s.previous;if(!r)return;let a=s.next;a?(r.next=a,a.previous=r):(r.next=void 0,n[t]=r),s.next=void 0,s.previous=void 0}}var zn=["push","splice","pop","shift","unshift"];function vn(n,t){let e=zn.map(i=>Wn(n,i,t));return()=>{e.forEach(i=>{i?.()})}}var En={};function Ye(n,t){En[n]=t}function Zt(n){return En[n]}var Je=class n{static SetMatrixPrecision(t){if(n.MatrixTrackPrecisionChange=!1,t&&!n.MatrixUse64Bits&&n.MatrixTrackedMatrices)for(let e=0;e<n.MatrixTrackedMatrices.length;++e){let i=n.MatrixTrackedMatrices[e],s=i._m;i._m=new Array(16);for(let r=0;r<16;++r)i._m[r]=s[r]}n.MatrixUse64Bits=t,n.MatrixCurrentType=n.MatrixUse64Bits?Array:Float32Array,n.MatrixTrackedMatrices=null}};Je.MatrixUse64Bits=!1;Je.MatrixTrackPrecisionChange=!0;Je.MatrixCurrentType=Float32Array;Je.MatrixTrackedMatrices=[];var Q=class{static get LastCreatedEngine(){return this.Instances.length===0?null:this.Instances[this.Instances.length-1]}static get LastCreatedScene(){return this._LastCreatedScene}};Q.Instances=new Array;Q._LastCreatedScene=null;Q.UseFallbackTexture=!0;Q.FallbackTexture="";var Ke=n=>parseInt(n.toString().replace(/\W/g,"")),ve=class n{constructor(t=0,e=0){this.x=t,this.y=e}toString(){return`{X: ${this.x} Y: ${this.y}}`}getClassName(){return"Vector2"}getHashCode(){let t=Ke(this.x),e=Ke(this.y),i=t;return i=i*397^e,i}toArray(t,e=0){return t[e]=this.x,t[e+1]=this.y,this}fromArray(t,e=0){return n.FromArrayToRef(t,e,this),this}asArray(){let t=new Array;return this.toArray(t,0),t}copyFrom(t){return this.x=t.x,this.y=t.y,this}copyFromFloats(t,e){return this.x=t,this.y=e,this}set(t,e){return this.copyFromFloats(t,e)}add(t){return new this.constructor(this.x+t.x,this.y+t.y)}addToRef(t,e){return e.x=this.x+t.x,e.y=this.y+t.y,e}addInPlace(t){return this.x+=t.x,this.y+=t.y,this}addVector3(t){return new this.constructor(this.x+t.x,this.y+t.y)}subtract(t){return new this.constructor(this.x-t.x,this.y-t.y)}subtractToRef(t,e){return e.x=this.x-t.x,e.y=this.y-t.y,e}subtractInPlace(t){return this.x-=t.x,this.y-=t.y,this}multiplyInPlace(t){return this.x*=t.x,this.y*=t.y,this}multiply(t){return new this.constructor(this.x*t.x,this.y*t.y)}multiplyToRef(t,e){return e.x=this.x*t.x,e.y=this.y*t.y,e}multiplyByFloats(t,e){return new this.constructor(this.x*t,this.y*e)}divide(t){return new this.constructor(this.x/t.x,this.y/t.y)}divideToRef(t,e){return e.x=this.x/t.x,e.y=this.y/t.y,e}divideInPlace(t){return this.divideToRef(t,this)}negate(){return new this.constructor(-this.x,-this.y)}negateInPlace(){return this.x*=-1,this.y*=-1,this}negateToRef(t){return t.copyFromFloats(this.x*-1,this.y*-1)}scaleInPlace(t){return this.x*=t,this.y*=t,this}scale(t){let e=new this.constructor(0,0);return this.scaleToRef(t,e),e}scaleToRef(t,e){return e.x=this.x*t,e.y=this.y*t,e}scaleAndAddToRef(t,e){return e.x+=this.x*t,e.y+=this.y*t,e}equals(t){return t&&this.x===t.x&&this.y===t.y}equalsWithEpsilon(t,e=_e){return t&&J.WithinEpsilon(this.x,t.x,e)&&J.WithinEpsilon(this.y,t.y,e)}floor(){return new this.constructor(Math.floor(this.x),Math.floor(this.y))}fract(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y))}rotateToRef(t,e){let i=Math.cos(t),s=Math.sin(t);return e.x=i*this.x-s*this.y,e.y=s*this.x+i*this.y,e}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSquared(){return this.x*this.x+this.y*this.y}normalize(){return n.NormalizeToRef(this,this),this}clone(){return new this.constructor(this.x,this.y)}static Zero(){return new n(0,0)}static One(){return new n(1,1)}static get ZeroReadOnly(){return n._ZeroReadOnly}static FromArray(t,e=0){return new n(t[e],t[e+1])}static FromArrayToRef(t,e,i){return i.x=t[e],i.y=t[e+1],i}static CatmullRom(t,e,i,s,r){let a=r*r,o=r*a,h=.5*(2*e.x+(-t.x+i.x)*r+(2*t.x-5*e.x+4*i.x-s.x)*a+(-t.x+3*e.x-3*i.x+s.x)*o),l=.5*(2*e.y+(-t.y+i.y)*r+(2*t.y-5*e.y+4*i.y-s.y)*a+(-t.y+3*e.y-3*i.y+s.y)*o);return new t.constructor(h,l)}static Clamp(t,e,i){let s=t.x;s=s>i.x?i.x:s,s=s<e.x?e.x:s;let r=t.y;return r=r>i.y?i.y:r,r=r<e.y?e.y:r,new t.constructor(s,r)}static Hermite(t,e,i,s,r){let a=r*r,o=r*a,h=2*o-3*a+1,l=-2*o+3*a,c=o-2*a+r,d=o-a,u=t.x*h+i.x*l+e.x*c+s.x*d,f=t.y*h+i.y*l+e.y*c+s.y*d;return new t.constructor(u,f)}static Hermite1stDerivative(t,e,i,s,r){let a=new t.constructor;return this.Hermite1stDerivativeToRef(t,e,i,s,r,a),a}static Hermite1stDerivativeToRef(t,e,i,s,r,a){let o=r*r;return a.x=(o-r)*6*t.x+(3*o-4*r+1)*e.x+(-o+r)*6*i.x+(3*o-2*r)*s.x,a.y=(o-r)*6*t.y+(3*o-4*r+1)*e.y+(-o+r)*6*i.y+(3*o-2*r)*s.y,a}static Lerp(t,e,i){let s=t.x+(e.x-t.x)*i,r=t.y+(e.y-t.y)*i;return new t.constructor(s,r)}static Dot(t,e){return t.x*e.x+t.y*e.y}static Normalize(t){let e=new t.constructor;return this.NormalizeToRef(t,e),e}static NormalizeToRef(t,e){let i=t.length();return i===0||(e.x=t.x/i,e.y=t.y/i),e}static Minimize(t,e){let i=t.x<e.x?t.x:e.x,s=t.y<e.y?t.y:e.y;return new t.constructor(i,s)}static Maximize(t,e){let i=t.x>e.x?t.x:e.x,s=t.y>e.y?t.y:e.y;return new t.constructor(i,s)}static Transform(t,e){let i=new t.constructor;return n.TransformToRef(t,e,i),i}static TransformToRef(t,e,i){let s=e.m,r=t.x*s[0]+t.y*s[4]+s[12],a=t.x*s[1]+t.y*s[5]+s[13];return i.x=r,i.y=a,i}static PointInTriangle(t,e,i,s){let r=.5*(-i.y*s.x+e.y*(-i.x+s.x)+e.x*(i.y-s.y)+i.x*s.y),a=r<0?-1:1,o=(e.y*s.x-e.x*s.y+(s.y-e.y)*t.x+(e.x-s.x)*t.y)*a,h=(e.x*i.y-e.y*i.x+(e.y-i.y)*t.x+(i.x-e.x)*t.y)*a;return o>0&&h>0&&o+h<2*r*a}static Distance(t,e){return Math.sqrt(n.DistanceSquared(t,e))}static DistanceSquared(t,e){let i=t.x-e.x,s=t.y-e.y;return i*i+s*s}static Center(t,e){let i=new t.constructor;return n.CenterToRef(t,e,i)}static CenterToRef(t,e,i){return i.copyFromFloats((t.x+e.x)/2,(t.y+e.y)/2)}static DistanceOfPointFromSegment(t,e,i){let s=n.DistanceSquared(e,i);if(s===0)return n.Distance(t,e);let r=i.subtract(e),a=Math.max(0,Math.min(1,n.Dot(t.subtract(e),r)/s)),o=e.add(r.multiplyByFloats(a,a));return n.Distance(t,o)}};ve._ZeroReadOnly=ve.Zero();var v=class n{constructor(t=0,e=0,i=0){this._isDirty=!0,this._x=t,this._y=e,this._z=i}get x(){return this._x}set x(t){this._x=t,this._isDirty=!0}get y(){return this._y}set y(t){this._y=t,this._isDirty=!0}get z(){return this._z}set z(t){this._z=t,this._isDirty=!0}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z}}`}getClassName(){return"Vector3"}getHashCode(){let t=Ke(this._x),e=Ke(this._y),i=Ke(this._z),s=t;return s=s*397^e,s=s*397^i,s}asArray(){let t=[];return this.toArray(t,0),t}toArray(t,e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,this}fromArray(t,e=0){return n.FromArrayToRef(t,e,this),this}toQuaternion(){return se.RotationYawPitchRoll(this._y,this._x,this._z)}addInPlace(t){return this.addInPlaceFromFloats(t._x,t._y,t._z)}addInPlaceFromFloats(t,e,i){return this.x+=t,this.y+=e,this.z+=i,this}add(t){return new this.constructor(this._x+t._x,this._y+t._y,this._z+t._z)}addToRef(t,e){return e.copyFromFloats(this._x+t._x,this._y+t._y,this._z+t._z)}subtractInPlace(t){return this.x-=t._x,this.y-=t._y,this.z-=t._z,this}subtract(t){return new this.constructor(this._x-t._x,this._y-t._y,this._z-t._z)}subtractToRef(t,e){return this.subtractFromFloatsToRef(t._x,t._y,t._z,e)}subtractFromFloats(t,e,i){return new this.constructor(this._x-t,this._y-e,this._z-i)}subtractFromFloatsToRef(t,e,i,s){return s.copyFromFloats(this._x-t,this._y-e,this._z-i)}negate(){return new this.constructor(-this._x,-this._y,-this._z)}negateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this}negateToRef(t){return t.copyFromFloats(this._x*-1,this._y*-1,this._z*-1)}scaleInPlace(t){return this.x*=t,this.y*=t,this.z*=t,this}scale(t){return new this.constructor(this._x*t,this._y*t,this._z*t)}scaleToRef(t,e){return e.copyFromFloats(this._x*t,this._y*t,this._z*t)}getNormalToRef(t){let e=this.length(),i=Math.acos(this.y/e),s=Math.atan2(this.z,this.x);i>Math.PI/2?i-=Math.PI/2:i+=Math.PI/2;let r=e*Math.sin(i)*Math.cos(s),a=e*Math.cos(i),o=e*Math.sin(i)*Math.sin(s);return t.set(r,a,o),t}applyRotationQuaternionToRef(t,e){let i=t.w*this.x+t.y*this.z-t.z*this.y,s=t.w*this.y+t.z*this.x-t.x*this.z,r=t.w*this.z+t.x*this.y-t.y*this.x,a=-t.x*this.x-t.y*this.y-t.z*this.z;return e.x=i*t.w+a*-t.x+s*-t.z-r*-t.y,e.y=s*t.w+a*-t.y+r*-t.x-i*-t.z,e.z=r*t.w+a*-t.z+i*-t.y-s*-t.x,e}applyRotationQuaternionInPlace(t){return this.applyRotationQuaternionToRef(t,this)}applyRotationQuaternion(t){return this.applyRotationQuaternionToRef(t,new this.constructor)}scaleAndAddToRef(t,e){return e.addInPlaceFromFloats(this._x*t,this._y*t,this._z*t)}projectOnPlane(t,e){let i=new this.constructor;return this.projectOnPlaneToRef(t,e,i),i}projectOnPlaneToRef(t,e,i){let s=t.normal,r=t.d,a=V.Vector3[0];this.subtractToRef(e,a),a.normalize();let o=n.Dot(a,s);if(Math.abs(o)<Math.pow(10,-10))i.setAll(1/0);else{let h=-(n.Dot(e,s)+r)/o,l=a.scaleInPlace(h);e.addToRef(l,i)}return i}equals(t){return t&&this._x===t._x&&this._y===t._y&&this._z===t._z}equalsWithEpsilon(t,e=_e){return t&&J.WithinEpsilon(this._x,t._x,e)&&J.WithinEpsilon(this._y,t._y,e)&&J.WithinEpsilon(this._z,t._z,e)}equalsToFloats(t,e,i){return this._x===t&&this._y===e&&this._z===i}multiplyInPlace(t){return this.x*=t._x,this.y*=t._y,this.z*=t._z,this}multiply(t){return this.multiplyByFloats(t._x,t._y,t._z)}multiplyToRef(t,e){return e.copyFromFloats(this._x*t._x,this._y*t._y,this._z*t._z)}multiplyByFloats(t,e,i){return new this.constructor(this._x*t,this._y*e,this._z*i)}divide(t){return new this.constructor(this._x/t._x,this._y/t._y,this._z/t._z)}divideToRef(t,e){return e.copyFromFloats(this._x/t._x,this._y/t._y,this._z/t._z)}divideInPlace(t){return this.divideToRef(t,this)}minimizeInPlace(t){return this.minimizeInPlaceFromFloats(t._x,t._y,t._z)}maximizeInPlace(t){return this.maximizeInPlaceFromFloats(t._x,t._y,t._z)}minimizeInPlaceFromFloats(t,e,i){return t<this._x&&(this.x=t),e<this._y&&(this.y=e),i<this._z&&(this.z=i),this}maximizeInPlaceFromFloats(t,e,i){return t>this._x&&(this.x=t),e>this._y&&(this.y=e),i>this._z&&(this.z=i),this}isNonUniformWithinEpsilon(t){let e=Math.abs(this._x),i=Math.abs(this._y);if(!J.WithinEpsilon(e,i,t))return!0;let s=Math.abs(this._z);return!J.WithinEpsilon(e,s,t)||!J.WithinEpsilon(i,s,t)}get isNonUniform(){let t=Math.abs(this._x),e=Math.abs(this._y);if(t!==e)return!0;let i=Math.abs(this._z);return t!==i}floor(){return new this.constructor(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z))}fract(){return new this.constructor(this._x-Math.floor(this._x),this._y-Math.floor(this._y),this._z-Math.floor(this._z))}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z}get hasAZeroComponent(){return this._x*this._y*this._z===0}normalize(){return this.normalizeFromLength(this.length())}reorderInPlace(t){return t=t.toLowerCase(),t==="xyz"?this:(V.Vector3[0].copyFrom(this),["x","y","z"].forEach((e,i)=>{this[e]=V.Vector3[0][t[i]]}),this)}rotateByQuaternionToRef(t,e){return t.toRotationMatrix(V.Matrix[0]),n.TransformCoordinatesToRef(this,V.Matrix[0],e),e}rotateByQuaternionAroundPointToRef(t,e,i){return this.subtractToRef(e,V.Vector3[0]),V.Vector3[0].rotateByQuaternionToRef(t,V.Vector3[0]),e.addToRef(V.Vector3[0],i),i}cross(t){let e=new this.constructor;return n.CrossToRef(this,t,e)}normalizeFromLength(t){return t===0||t===1?this:this.scaleInPlace(1/t)}normalizeToNew(){let t=new this.constructor(0,0,0);return this.normalizeToRef(t),t}normalizeToRef(t){let e=this.length();return e===0||e===1?t.copyFromFloats(this._x,this._y,this._z):this.scaleToRef(1/e,t)}clone(){return new this.constructor(this._x,this._y,this._z)}copyFrom(t){return this.copyFromFloats(t._x,t._y,t._z)}copyFromFloats(t,e,i){return this.x=t,this.y=e,this.z=i,this}set(t,e,i){return this.copyFromFloats(t,e,i)}setAll(t){return this.x=this.y=this.z=t,this}static GetClipFactor(t,e,i,s){let r=n.Dot(t,i)-s,a=n.Dot(e,i)-s;return r/(r-a)}static GetAngleBetweenVectors(t,e,i){let s=t.normalizeToRef(V.Vector3[1]),r=e.normalizeToRef(V.Vector3[2]),a=n.Dot(s,r);a=J.Clamp(a,-1,1);let o=Math.acos(a),h=V.Vector3[3];return n.CrossToRef(s,r,h),n.Dot(h,i)>0?isNaN(o)?0:o:isNaN(o)?-Math.PI:-Math.acos(a)}static GetAngleBetweenVectorsOnPlane(t,e,i){V.Vector3[0].copyFrom(t);let s=V.Vector3[0];V.Vector3[1].copyFrom(e);let r=V.Vector3[1];V.Vector3[2].copyFrom(i);let a=V.Vector3[2],o=V.Vector3[3],h=V.Vector3[4];s.normalize(),r.normalize(),a.normalize(),n.CrossToRef(a,s,o),n.CrossToRef(o,a,h);let l=Math.atan2(n.Dot(r,o),n.Dot(r,h));return J.NormalizeRadians(l)}static PitchYawRollToMoveBetweenPointsToRef(t,e,i){let s=C.Vector3[0];return e.subtractToRef(t,s),i.y=Math.atan2(s.x,s.z)||0,i.x=Math.atan2(Math.sqrt(s.x**2+s.z**2),s.y)||0,i.z=0,i}static PitchYawRollToMoveBetweenPoints(t,e){let i=n.Zero();return n.PitchYawRollToMoveBetweenPointsToRef(t,e,i)}static SlerpToRef(t,e,i,s){i=J.Clamp(i,0,1);let r=V.Vector3[0],a=V.Vector3[1];r.copyFrom(t);let o=r.length();r.normalizeFromLength(o),a.copyFrom(e);let h=a.length();a.normalizeFromLength(h);let l=n.Dot(r,a),c,d;if(l<1-_e){let u=Math.acos(l),f=1/Math.sin(u);c=Math.sin((1-i)*u)*f,d=Math.sin(i*u)*f}else c=1-i,d=i;return r.scaleInPlace(c),a.scaleInPlace(d),s.copyFrom(r).addInPlace(a),s.scaleInPlace(J.Lerp(o,h,i)),s}static SmoothToRef(t,e,i,s,r){return n.SlerpToRef(t,e,s===0?1:i/s,r),r}static FromArray(t,e=0){return new n(t[e],t[e+1],t[e+2])}static FromFloatArray(t,e){return n.FromArray(t,e)}static FromArrayToRef(t,e,i){return i.x=t[e],i.y=t[e+1],i.z=t[e+2],i}static FromFloatArrayToRef(t,e,i){return n.FromArrayToRef(t,e,i)}static FromFloatsToRef(t,e,i,s){return s.copyFromFloats(t,e,i),s}static Zero(){return new n(0,0,0)}static One(){return new n(1,1,1)}static Up(){return new n(0,1,0)}static get UpReadOnly(){return n._UpReadOnly}static get DownReadOnly(){return n._DownReadOnly}static get RightReadOnly(){return n._RightReadOnly}static get LeftReadOnly(){return n._LeftReadOnly}static get LeftHandedForwardReadOnly(){return n._LeftHandedForwardReadOnly}static get RightHandedForwardReadOnly(){return n._RightHandedForwardReadOnly}static get ZeroReadOnly(){return n._ZeroReadOnly}static Down(){return new n(0,-1,0)}static Forward(t=!1){return new n(0,0,t?-1:1)}static Backward(t=!1){return new n(0,0,t?1:-1)}static Right(){return new n(1,0,0)}static Left(){return new n(-1,0,0)}static TransformCoordinates(t,e){let i=n.Zero();return n.TransformCoordinatesToRef(t,e,i),i}static TransformCoordinatesToRef(t,e,i){return n.TransformCoordinatesFromFloatsToRef(t._x,t._y,t._z,e,i),i}static TransformCoordinatesFromFloatsToRef(t,e,i,s,r){let a=s.m,o=t*a[0]+e*a[4]+i*a[8]+a[12],h=t*a[1]+e*a[5]+i*a[9]+a[13],l=t*a[2]+e*a[6]+i*a[10]+a[14],c=1/(t*a[3]+e*a[7]+i*a[11]+a[15]);return r.x=o*c,r.y=h*c,r.z=l*c,r}static TransformNormal(t,e){let i=n.Zero();return n.TransformNormalToRef(t,e,i),i}static TransformNormalToRef(t,e,i){return this.TransformNormalFromFloatsToRef(t._x,t._y,t._z,e,i),i}static TransformNormalFromFloatsToRef(t,e,i,s,r){let a=s.m;return r.x=t*a[0]+e*a[4]+i*a[8],r.y=t*a[1]+e*a[5]+i*a[9],r.z=t*a[2]+e*a[6]+i*a[10],r}static CatmullRom(t,e,i,s,r){let a=r*r,o=r*a,h=.5*(2*e._x+(-t._x+i._x)*r+(2*t._x-5*e._x+4*i._x-s._x)*a+(-t._x+3*e._x-3*i._x+s._x)*o),l=.5*(2*e._y+(-t._y+i._y)*r+(2*t._y-5*e._y+4*i._y-s._y)*a+(-t._y+3*e._y-3*i._y+s._y)*o),c=.5*(2*e._z+(-t._z+i._z)*r+(2*t._z-5*e._z+4*i._z-s._z)*a+(-t._z+3*e._z-3*i._z+s._z)*o);return new t.constructor(h,l,c)}static Clamp(t,e,i){let s=new t.constructor;return n.ClampToRef(t,e,i,s),s}static ClampToRef(t,e,i,s){let r=t._x;r=r>i._x?i._x:r,r=r<e._x?e._x:r;let a=t._y;a=a>i._y?i._y:a,a=a<e._y?e._y:a;let o=t._z;return o=o>i._z?i._z:o,o=o<e._z?e._z:o,s.copyFromFloats(r,a,o),s}static CheckExtends(t,e,i){e.minimizeInPlace(t),i.maximizeInPlace(t)}static Hermite(t,e,i,s,r){let a=r*r,o=r*a,h=2*o-3*a+1,l=-2*o+3*a,c=o-2*a+r,d=o-a,u=t._x*h+i._x*l+e._x*c+s._x*d,f=t._y*h+i._y*l+e._y*c+s._y*d,_=t._z*h+i._z*l+e._z*c+s._z*d;return new t.constructor(u,f,_)}static Hermite1stDerivative(t,e,i,s,r){let a=new t.constructor;return this.Hermite1stDerivativeToRef(t,e,i,s,r,a),a}static Hermite1stDerivativeToRef(t,e,i,s,r,a){let o=r*r;return a.x=(o-r)*6*t.x+(3*o-4*r+1)*e.x+(-o+r)*6*i.x+(3*o-2*r)*s.x,a.y=(o-r)*6*t.y+(3*o-4*r+1)*e.y+(-o+r)*6*i.y+(3*o-2*r)*s.y,a.z=(o-r)*6*t.z+(3*o-4*r+1)*e.z+(-o+r)*6*i.z+(3*o-2*r)*s.z,a}static Lerp(t,e,i){let s=new t.constructor(0,0,0);return n.LerpToRef(t,e,i,s),s}static LerpToRef(t,e,i,s){return s.x=t._x+(e._x-t._x)*i,s.y=t._y+(e._y-t._y)*i,s.z=t._z+(e._z-t._z)*i,s}static Dot(t,e){return t._x*e._x+t._y*e._y+t._z*e._z}static Cross(t,e){let i=new t.constructor;return n.CrossToRef(t,e,i),i}static CrossToRef(t,e,i){let s=t._y*e._z-t._z*e._y,r=t._z*e._x-t._x*e._z,a=t._x*e._y-t._y*e._x;return i.copyFromFloats(s,r,a),i}static Normalize(t){let e=n.Zero();return n.NormalizeToRef(t,e),e}static NormalizeToRef(t,e){return t.normalizeToRef(e),e}static Project(t,e,i,s){let r=new t.constructor;return n.ProjectToRef(t,e,i,s,r),r}static ProjectToRef(t,e,i,s,r){let a=s.width,o=s.height,h=s.x,l=s.y,c=V.Matrix[1];P.FromValuesToRef(a/2,0,0,0,0,-o/2,0,0,0,0,.5,0,h+a/2,o/2+l,.5,1,c);let d=V.Matrix[0];return e.multiplyToRef(i,d),d.multiplyToRef(c,d),n.TransformCoordinatesToRef(t,d,r),r}static Reflect(t,e){return this.ReflectToRef(t,e,new n)}static ReflectToRef(t,e,i){let s=C.Vector3[0];return s.copyFrom(e).scaleInPlace(2*n.Dot(t,e)),i.copyFrom(t).subtractInPlace(s)}static _UnprojectFromInvertedMatrixToRef(t,e,i){n.TransformCoordinatesToRef(t,e,i);let s=e.m,r=t._x*s[3]+t._y*s[7]+t._z*s[11]+s[15];return J.WithinEpsilon(r,1)&&i.scaleInPlace(1/r),i}static UnprojectFromTransform(t,e,i,s,r){return this.Unproject(t,e,i,s,r,P.IdentityReadOnly)}static Unproject(t,e,i,s,r,a){let o=new t.constructor;return n.UnprojectToRef(t,e,i,s,r,a,o),o}static UnprojectToRef(t,e,i,s,r,a,o){return n.UnprojectFloatsToRef(t._x,t._y,t._z,e,i,s,r,a,o),o}static UnprojectFloatsToRef(t,e,i,s,r,a,o,h,l){var c;let d=V.Matrix[0];a.multiplyToRef(o,d),d.multiplyToRef(h,d),d.invert();let u=V.Vector3[0];return u.x=t/s*2-1,u.y=-(e/r*2-1),!((c=Q.LastCreatedEngine)===null||c===void 0)&&c.isNDCHalfZRange?u.z=i:u.z=2*i-1,n._UnprojectFromInvertedMatrixToRef(u,d,l),l}static Minimize(t,e){let i=new t.constructor;return i.copyFrom(t),i.minimizeInPlace(e),i}static Maximize(t,e){let i=new t.constructor;return i.copyFrom(t),i.maximizeInPlace(e),i}static Distance(t,e){return Math.sqrt(n.DistanceSquared(t,e))}static DistanceSquared(t,e){let i=t._x-e._x,s=t._y-e._y,r=t._z-e._z;return i*i+s*s+r*r}static ProjectOnTriangleToRef(t,e,i,s,r){let a=V.Vector3[0],o=V.Vector3[1],h=V.Vector3[2],l=V.Vector3[3],c=V.Vector3[4];i.subtractToRef(e,a),s.subtractToRef(e,o),s.subtractToRef(i,h);let d=a.length(),u=o.length(),f=h.length();if(d<_e||u<_e||f<_e)return r.copyFrom(e),n.Distance(t,e);t.subtractToRef(e,c),n.CrossToRef(a,o,l);let _=l.length();if(_<_e)return r.copyFrom(e),n.Distance(t,e);l.normalizeFromLength(_);let g=c.length();if(g<_e)return r.copyFrom(e),0;c.normalizeFromLength(g);let p=n.Dot(l,c),E=V.Vector3[5],T=V.Vector3[6];E.copyFrom(l).scaleInPlace(-g*p),T.copyFrom(t).addInPlace(E);let R=V.Vector3[4],y=V.Vector3[5],M=V.Vector3[7],b=V.Vector3[8];R.copyFrom(a).scaleInPlace(1/d),b.copyFrom(o).scaleInPlace(1/u),R.addInPlace(b).scaleInPlace(-1),y.copyFrom(a).scaleInPlace(-1/d),b.copyFrom(h).scaleInPlace(1/f),y.addInPlace(b).scaleInPlace(-1),M.copyFrom(h).scaleInPlace(-1/f),b.copyFrom(o).scaleInPlace(-1/u),M.addInPlace(b).scaleInPlace(-1);let x=V.Vector3[9],F;x.copyFrom(T).subtractInPlace(e),n.CrossToRef(R,x,b),F=n.Dot(b,l);let I=F;x.copyFrom(T).subtractInPlace(i),n.CrossToRef(y,x,b),F=n.Dot(b,l);let N=F;x.copyFrom(T).subtractInPlace(s),n.CrossToRef(M,x,b),F=n.Dot(b,l);let G=F,Y=V.Vector3[10],q,j;I>0&&N<0?(Y.copyFrom(a),q=e,j=i):N>0&&G<0?(Y.copyFrom(h),q=i,j=s):(Y.copyFrom(o).scaleInPlace(-1),q=s,j=e);let $=V.Vector3[9],Te=V.Vector3[4];if(q.subtractToRef(T,b),j.subtractToRef(T,$),n.CrossToRef(b,$,Te),!(n.Dot(Te,l)<0))return r.copyFrom(T),Math.abs(g*p);let Se=V.Vector3[5];n.CrossToRef(Y,Te,Se),Se.normalize();let ye=V.Vector3[9];ye.copyFrom(q).subtractInPlace(T);let Ie=ye.length();if(Ie<_e)return r.copyFrom(q),n.Distance(t,q);ye.normalizeFromLength(Ie);let We=n.Dot(Se,ye),ze=V.Vector3[7];ze.copyFrom(T).addInPlace(Se.scaleInPlace(Ie*We)),b.copyFrom(ze).subtractInPlace(q),g=Y.length(),Y.normalizeFromLength(g);let nt=n.Dot(b,Y)/Math.max(g,_e);return nt=J.Clamp(nt,0,1),ze.copyFrom(q).addInPlace(Y.scaleInPlace(nt*g)),r.copyFrom(ze),n.Distance(t,ze)}static Center(t,e){return n.CenterToRef(t,e,n.Zero())}static CenterToRef(t,e,i){return i.copyFromFloats((t._x+e._x)/2,(t._y+e._y)/2,(t._z+e._z)/2)}static RotationFromAxis(t,e,i){let s=new t.constructor;return n.RotationFromAxisToRef(t,e,i,s),s}static RotationFromAxisToRef(t,e,i,s){let r=V.Quaternion[0];return se.RotationQuaternionFromAxisToRef(t,e,i,r),r.toEulerAnglesToRef(s),s}};v._UpReadOnly=v.Up();v._DownReadOnly=v.Down();v._LeftHandedForwardReadOnly=v.Forward(!1);v._RightHandedForwardReadOnly=v.Forward(!0);v._RightReadOnly=v.Right();v._LeftReadOnly=v.Left();v._ZeroReadOnly=v.Zero();var it=class n{constructor(t=0,e=0,i=0,s=0){this.x=t,this.y=e,this.z=i,this.w=s}toString(){return`{X: ${this.x} Y: ${this.y} Z: ${this.z} W: ${this.w}}`}getClassName(){return"Vector4"}getHashCode(){let t=Ke(this.x),e=Ke(this.y),i=Ke(this.z),s=Ke(this.w),r=t;return r=r*397^e,r=r*397^i,r=r*397^s,r}asArray(){let t=new Array;return this.toArray(t,0),t}toArray(t,e){return e===void 0&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,this}fromArray(t,e=0){return n.FromArrayToRef(t,e,this),this}addInPlace(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}add(t){return new this.constructor(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)}addToRef(t,e){return e.x=this.x+t.x,e.y=this.y+t.y,e.z=this.z+t.z,e.w=this.w+t.w,e}subtractInPlace(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}subtract(t){return new this.constructor(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)}subtractToRef(t,e){return e.x=this.x-t.x,e.y=this.y-t.y,e.z=this.z-t.z,e.w=this.w-t.w,e}subtractFromFloats(t,e,i,s){return new this.constructor(this.x-t,this.y-e,this.z-i,this.w-s)}subtractFromFloatsToRef(t,e,i,s,r){return r.x=this.x-t,r.y=this.y-e,r.z=this.z-i,r.w=this.w-s,r}negate(){return new this.constructor(-this.x,-this.y,-this.z,-this.w)}negateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this}negateToRef(t){return t.copyFromFloats(this.x*-1,this.y*-1,this.z*-1,this.w*-1)}scaleInPlace(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}scale(t){return new this.constructor(this.x*t,this.y*t,this.z*t,this.w*t)}scaleToRef(t,e){return e.x=this.x*t,e.y=this.y*t,e.z=this.z*t,e.w=this.w*t,e}scaleAndAddToRef(t,e){return e.x+=this.x*t,e.y+=this.y*t,e.z+=this.z*t,e.w+=this.w*t,e}equals(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}equalsWithEpsilon(t,e=_e){return t&&J.WithinEpsilon(this.x,t.x,e)&&J.WithinEpsilon(this.y,t.y,e)&&J.WithinEpsilon(this.z,t.z,e)&&J.WithinEpsilon(this.w,t.w,e)}equalsToFloats(t,e,i,s){return this.x===t&&this.y===e&&this.z===i&&this.w===s}multiplyInPlace(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}multiply(t){return new this.constructor(this.x*t.x,this.y*t.y,this.z*t.z,this.w*t.w)}multiplyToRef(t,e){return e.x=this.x*t.x,e.y=this.y*t.y,e.z=this.z*t.z,e.w=this.w*t.w,e}multiplyByFloats(t,e,i,s){return new this.constructor(this.x*t,this.y*e,this.z*i,this.w*s)}divide(t){return new this.constructor(this.x/t.x,this.y/t.y,this.z/t.z,this.w/t.w)}divideToRef(t,e){return e.x=this.x/t.x,e.y=this.y/t.y,e.z=this.z/t.z,e.w=this.w/t.w,e}divideInPlace(t){return this.divideToRef(t,this)}minimizeInPlace(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),t.w<this.w&&(this.w=t.w),this}maximizeInPlace(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),t.w>this.w&&(this.w=t.w),this}floor(){return new this.constructor(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z),Math.floor(this.w))}fract(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y),this.z-Math.floor(this.z),this.w-Math.floor(this.w))}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}normalize(){let t=this.length();return t===0?this:this.scaleInPlace(1/t)}toVector3(){return new v(this.x,this.y,this.z)}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copyFrom(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}copyFromFloats(t,e,i,s){return this.x=t,this.y=e,this.z=i,this.w=s,this}set(t,e,i,s){return this.copyFromFloats(t,e,i,s)}setAll(t){return this.x=this.y=this.z=this.w=t,this}static FromArray(t,e){return e||(e=0),new n(t[e],t[e+1],t[e+2],t[e+3])}static FromArrayToRef(t,e,i){return i.x=t[e],i.y=t[e+1],i.z=t[e+2],i.w=t[e+3],i}static FromFloatArrayToRef(t,e,i){return n.FromArrayToRef(t,e,i),i}static FromFloatsToRef(t,e,i,s,r){return r.x=t,r.y=e,r.z=i,r.w=s,r}static Zero(){return new n(0,0,0,0)}static One(){return new n(1,1,1,1)}static get ZeroReadOnly(){return n._ZeroReadOnly}static Normalize(t){let e=n.Zero();return n.NormalizeToRef(t,e),e}static NormalizeToRef(t,e){return e.copyFrom(t),e.normalize(),e}static Minimize(t,e){let i=new t.constructor;return i.copyFrom(t),i.minimizeInPlace(e),i}static Maximize(t,e){let i=new t.constructor;return i.copyFrom(t),i.maximizeInPlace(e),i}static Distance(t,e){return Math.sqrt(n.DistanceSquared(t,e))}static DistanceSquared(t,e){let i=t.x-e.x,s=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return i*i+s*s+r*r+a*a}static Center(t,e){return n.CenterToRef(t,e,n.Zero())}static CenterToRef(t,e,i){return i.copyFromFloats((t.x+e.x)/2,(t.y+e.y)/2,(t.z+e.z)/2,(t.w+e.w)/2)}static TransformCoordinates(t,e){let i=n.Zero();return n.TransformCoordinatesToRef(t,e,i),i}static TransformCoordinatesToRef(t,e,i){return n.TransformCoordinatesFromFloatsToRef(t._x,t._y,t._z,e,i),i}static TransformCoordinatesFromFloatsToRef(t,e,i,s,r){let a=s.m,o=t*a[0]+e*a[4]+i*a[8]+a[12],h=t*a[1]+e*a[5]+i*a[9]+a[13],l=t*a[2]+e*a[6]+i*a[10]+a[14],c=t*a[3]+e*a[7]+i*a[11]+a[15];return r.x=o,r.y=h,r.z=l,r.w=c,r}static TransformNormal(t,e){let i=new t.constructor;return n.TransformNormalToRef(t,e,i),i}static TransformNormalToRef(t,e,i){let s=e.m,r=t.x*s[0]+t.y*s[4]+t.z*s[8],a=t.x*s[1]+t.y*s[5]+t.z*s[9],o=t.x*s[2]+t.y*s[6]+t.z*s[10];return i.x=r,i.y=a,i.z=o,i.w=t.w,i}static TransformNormalFromFloatsToRef(t,e,i,s,r,a){let o=r.m;return a.x=t*o[0]+e*o[4]+i*o[8],a.y=t*o[1]+e*o[5]+i*o[9],a.z=t*o[2]+e*o[6]+i*o[10],a.w=s,a}static FromVector3(t,e=0){return new n(t._x,t._y,t._z,e)}};it._ZeroReadOnly=it.Zero();var se=class n{constructor(t=0,e=0,i=0,s=1){this._isDirty=!0,this._x=t,this._y=e,this._z=i,this._w=s}get x(){return this._x}set x(t){this._x=t,this._isDirty=!0}get y(){return this._y}set y(t){this._y=t,this._isDirty=!0}get z(){return this._z}set z(t){this._z=t,this._isDirty=!0}get w(){return this._w}set w(t){this._w=t,this._isDirty=!0}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z} W: ${this._w}}`}getClassName(){return"Quaternion"}getHashCode(){let t=Ke(this._x),e=Ke(this._y),i=Ke(this._z),s=Ke(this._w),r=t;return r=r*397^e,r=r*397^i,r=r*397^s,r}asArray(){return[this._x,this._y,this._z,this._w]}toArray(t,e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,this}equals(t){return t&&this._x===t._x&&this._y===t._y&&this._z===t._z&&this._w===t._w}equalsWithEpsilon(t,e=_e){return t&&J.WithinEpsilon(this._x,t._x,e)&&J.WithinEpsilon(this._y,t._y,e)&&J.WithinEpsilon(this._z,t._z,e)&&J.WithinEpsilon(this._w,t._w,e)}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copyFrom(t){return this.x=t._x,this.y=t._y,this.z=t._z,this.w=t._w,this}copyFromFloats(t,e,i,s){return this.x=t,this.y=e,this.z=i,this.w=s,this}set(t,e,i,s){return this.copyFromFloats(t,e,i,s)}add(t){return new this.constructor(this._x+t._x,this._y+t._y,this._z+t._z,this._w+t._w)}addInPlace(t){return this._x+=t._x,this._y+=t._y,this._z+=t._z,this._w+=t._w,this}subtract(t){return new this.constructor(this._x-t._x,this._y-t._y,this._z-t._z,this._w-t._w)}subtractInPlace(t){return this._x-=t._x,this._y-=t._y,this._z-=t._z,this._w-=t._w,this}scale(t){return new this.constructor(this._x*t,this._y*t,this._z*t,this._w*t)}scaleToRef(t,e){return e.x=this._x*t,e.y=this._y*t,e.z=this._z*t,e.w=this._w*t,e}scaleInPlace(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}scaleAndAddToRef(t,e){return e.x+=this._x*t,e.y+=this._y*t,e.z+=this._z*t,e.w+=this._w*t,e}multiply(t){let e=new this.constructor(0,0,0,1);return this.multiplyToRef(t,e),e}multiplyToRef(t,e){let i=this._x*t._w+this._y*t._z-this._z*t._y+this._w*t._x,s=-this._x*t._z+this._y*t._w+this._z*t._x+this._w*t._y,r=this._x*t._y-this._y*t._x+this._z*t._w+this._w*t._z,a=-this._x*t._x-this._y*t._y-this._z*t._z+this._w*t._w;return e.copyFromFloats(i,s,r,a),e}multiplyInPlace(t){return this.multiplyToRef(t,this),this}conjugateToRef(t){return t.copyFromFloats(-this._x,-this._y,-this._z,this._w),t}conjugateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this}conjugate(){return new this.constructor(-this._x,-this._y,-this._z,this._w)}invert(){let t=this.conjugate(),e=this.lengthSquared();return e==0||e==1||t.scaleInPlace(1/e),t}invertInPlace(){this.conjugateInPlace();let t=this.lengthSquared();return t==0||t==1?this:(this.scaleInPlace(1/t),this)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this.lengthSquared())}normalize(){let t=this.length();if(t===0)return this;let e=1/t;return this.scaleInPlace(e),this}normalizeToNew(){let t=this.length();if(t===0)return this.clone();let e=1/t;return this.scale(e)}toEulerAngles(){let t=v.Zero();return this.toEulerAnglesToRef(t),t}toEulerAnglesToRef(t){let e=this._z,i=this._x,s=this._y,r=this._w,a=s*e-i*r,o=.4999999;if(a<-o)t.y=2*Math.atan2(s,r),t.x=Math.PI/2,t.z=0;else if(a>o)t.y=2*Math.atan2(s,r),t.x=-Math.PI/2,t.z=0;else{let h=r*r,l=e*e,c=i*i,d=s*s;t.z=Math.atan2(2*(i*s+e*r),-l-c+d+h),t.x=Math.asin(-2*a),t.y=Math.atan2(2*(e*i+s*r),l-c-d+h)}return t}toRotationMatrix(t){return P.FromQuaternionToRef(this,t),t}fromRotationMatrix(t){return n.FromRotationMatrixToRef(t,this),this}static FromRotationMatrix(t){let e=new n;return n.FromRotationMatrixToRef(t,e),e}static FromRotationMatrixToRef(t,e){let i=t.m,s=i[0],r=i[4],a=i[8],o=i[1],h=i[5],l=i[9],c=i[2],d=i[6],u=i[10],f=s+h+u,_;return f>0?(_=.5/Math.sqrt(f+1),e.w=.25/_,e.x=(d-l)*_,e.y=(a-c)*_,e.z=(o-r)*_):s>h&&s>u?(_=2*Math.sqrt(1+s-h-u),e.w=(d-l)/_,e.x=.25*_,e.y=(r+o)/_,e.z=(a+c)/_):h>u?(_=2*Math.sqrt(1+h-s-u),e.w=(a-c)/_,e.x=(r+o)/_,e.y=.25*_,e.z=(l+d)/_):(_=2*Math.sqrt(1+u-s-h),e.w=(o-r)/_,e.x=(a+c)/_,e.y=(l+d)/_,e.z=.25*_),e}static Dot(t,e){return t._x*e._x+t._y*e._y+t._z*e._z+t._w*e._w}static AreClose(t,e,i=.1){let s=n.Dot(t,e);return 1-s*s<=i}static SmoothToRef(t,e,i,s,r){let a=s===0?1:i/s;return a=J.Clamp(a,0,1),n.SlerpToRef(t,e,a,r),r}static Zero(){return new n(0,0,0,0)}static Inverse(t){return new t.constructor(-t._x,-t._y,-t._z,t._w)}static InverseToRef(t,e){return e.set(-t._x,-t._y,-t._z,t._w),e}static Identity(){return new n(0,0,0,1)}static IsIdentity(t){return t&&t._x===0&&t._y===0&&t._z===0&&t._w===1}static RotationAxis(t,e){return n.RotationAxisToRef(t,e,new n)}static RotationAxisToRef(t,e,i){let s=Math.sin(e/2);return t.normalize(),i.w=Math.cos(e/2),i.x=t._x*s,i.y=t._y*s,i.z=t._z*s,i}static FromArray(t,e){return e||(e=0),new n(t[e],t[e+1],t[e+2],t[e+3])}static FromArrayToRef(t,e,i){return i.x=t[e],i.y=t[e+1],i.z=t[e+2],i.w=t[e+3],i}static FromEulerAngles(t,e,i){let s=new n;return n.RotationYawPitchRollToRef(e,t,i,s),s}static FromEulerAnglesToRef(t,e,i,s){return n.RotationYawPitchRollToRef(e,t,i,s),s}static FromEulerVector(t){let e=new n;return n.RotationYawPitchRollToRef(t._y,t._x,t._z,e),e}static FromEulerVectorToRef(t,e){return n.RotationYawPitchRollToRef(t._y,t._x,t._z,e),e}static FromUnitVectorsToRef(t,e,i){let s=v.Dot(t,e)+1;return s<_e?Math.abs(t.x)>Math.abs(t.z)?i.set(-t.y,t.x,0,0):i.set(0,-t.z,t.y,0):(v.CrossToRef(t,e,C.Vector3[0]),i.set(C.Vector3[0].x,C.Vector3[0].y,C.Vector3[0].z,s)),i.normalize()}static RotationYawPitchRoll(t,e,i){let s=new n;return n.RotationYawPitchRollToRef(t,e,i,s),s}static RotationYawPitchRollToRef(t,e,i,s){let r=i*.5,a=e*.5,o=t*.5,h=Math.sin(r),l=Math.cos(r),c=Math.sin(a),d=Math.cos(a),u=Math.sin(o),f=Math.cos(o);return s.x=f*c*l+u*d*h,s.y=u*d*l-f*c*h,s.z=f*d*h-u*c*l,s.w=f*d*l+u*c*h,s}static RotationAlphaBetaGamma(t,e,i){let s=new n;return n.RotationAlphaBetaGammaToRef(t,e,i,s),s}static RotationAlphaBetaGammaToRef(t,e,i,s){let r=(i+t)*.5,a=(i-t)*.5,o=e*.5;return s.x=Math.cos(a)*Math.sin(o),s.y=Math.sin(a)*Math.sin(o),s.z=Math.sin(r)*Math.cos(o),s.w=Math.cos(r)*Math.cos(o),s}static RotationQuaternionFromAxis(t,e,i){let s=new n(0,0,0,0);return n.RotationQuaternionFromAxisToRef(t,e,i,s),s}static RotationQuaternionFromAxisToRef(t,e,i,s){let r=V.Matrix[0];return P.FromXYZAxesToRef(t.normalize(),e.normalize(),i.normalize(),r),n.FromRotationMatrixToRef(r,s),s}static FromLookDirectionLH(t,e){let i=new n;return n.FromLookDirectionLHToRef(t,e,i),i}static FromLookDirectionLHToRef(t,e,i){let s=V.Matrix[0];return P.LookDirectionLHToRef(t,e,s),n.FromRotationMatrixToRef(s,i),i}static FromLookDirectionRH(t,e){let i=new n;return n.FromLookDirectionRHToRef(t,e,i),i}static FromLookDirectionRHToRef(t,e,i){let s=V.Matrix[0];return P.LookDirectionRHToRef(t,e,s),n.FromRotationMatrixToRef(s,i)}static Slerp(t,e,i){let s=n.Identity();return n.SlerpToRef(t,e,i,s),s}static SlerpToRef(t,e,i,s){let r,a,o=t._x*e._x+t._y*e._y+t._z*e._z+t._w*e._w,h=!1;if(o<0&&(h=!0,o=-o),o>.999999)a=1-i,r=h?-i:i;else{let l=Math.acos(o),c=1/Math.sin(l);a=Math.sin((1-i)*l)*c,r=h?-Math.sin(i*l)*c:Math.sin(i*l)*c}return s.x=a*t._x+r*e._x,s.y=a*t._y+r*e._y,s.z=a*t._z+r*e._z,s.w=a*t._w+r*e._w,s}static Hermite(t,e,i,s,r){let a=r*r,o=r*a,h=2*o-3*a+1,l=-2*o+3*a,c=o-2*a+r,d=o-a,u=t._x*h+i._x*l+e._x*c+s._x*d,f=t._y*h+i._y*l+e._y*c+s._y*d,_=t._z*h+i._z*l+e._z*c+s._z*d,g=t._w*h+i._w*l+e._w*c+s._w*d;return new t.constructor(u,f,_,g)}static Hermite1stDerivative(t,e,i,s,r){let a=new t.constructor;return this.Hermite1stDerivativeToRef(t,e,i,s,r,a),a}static Hermite1stDerivativeToRef(t,e,i,s,r,a){let o=r*r;return a.x=(o-r)*6*t.x+(3*o-4*r+1)*e.x+(-o+r)*6*i.x+(3*o-2*r)*s.x,a.y=(o-r)*6*t.y+(3*o-4*r+1)*e.y+(-o+r)*6*i.y+(3*o-2*r)*s.y,a.z=(o-r)*6*t.z+(3*o-4*r+1)*e.z+(-o+r)*6*i.z+(3*o-2*r)*s.z,a.w=(o-r)*6*t.w+(3*o-4*r+1)*e.w+(-o+r)*6*i.w+(3*o-2*r)*s.w,a}},P=class n{constructor(){this._isIdentity=!1,this._isIdentityDirty=!0,this._isIdentity3x2=!0,this._isIdentity3x2Dirty=!0,this.updateFlag=-1,Je.MatrixTrackPrecisionChange&&Je.MatrixTrackedMatrices.push(this),this._m=new Je.MatrixCurrentType(16),this.markAsUpdated()}static get Use64Bits(){return Je.MatrixUse64Bits}get m(){return this._m}markAsUpdated(){this.updateFlag=n._UpdateFlagSeed++,this._isIdentity=!1,this._isIdentity3x2=!1,this._isIdentityDirty=!0,this._isIdentity3x2Dirty=!0}_updateIdentityStatus(t,e=!1,i=!1,s=!0){this._isIdentity=t,this._isIdentity3x2=t||i,this._isIdentityDirty=this._isIdentity?!1:e,this._isIdentity3x2Dirty=this._isIdentity3x2?!1:s}isIdentity(){if(this._isIdentityDirty){this._isIdentityDirty=!1;let t=this._m;this._isIdentity=t[0]===1&&t[1]===0&&t[2]===0&&t[3]===0&&t[4]===0&&t[5]===1&&t[6]===0&&t[7]===0&&t[8]===0&&t[9]===0&&t[10]===1&&t[11]===0&&t[12]===0&&t[13]===0&&t[14]===0&&t[15]===1}return this._isIdentity}isIdentityAs3x2(){return this._isIdentity3x2Dirty&&(this._isIdentity3x2Dirty=!1,this._m[0]!==1||this._m[5]!==1||this._m[15]!==1?this._isIdentity3x2=!1:this._m[1]!==0||this._m[2]!==0||this._m[3]!==0||this._m[4]!==0||this._m[6]!==0||this._m[7]!==0||this._m[8]!==0||this._m[9]!==0||this._m[10]!==0||this._m[11]!==0||this._m[12]!==0||this._m[13]!==0||this._m[14]!==0?this._isIdentity3x2=!1:this._isIdentity3x2=!0),this._isIdentity3x2}determinant(){if(this._isIdentity===!0)return 1;let t=this._m,e=t[0],i=t[1],s=t[2],r=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8],d=t[9],u=t[10],f=t[11],_=t[12],g=t[13],p=t[14],E=t[15],T=u*E-p*f,R=d*E-g*f,y=d*p-g*u,M=c*E-_*f,b=c*p-u*_,x=c*g-_*d,F=+(o*T-h*R+l*y),I=-(a*T-h*M+l*b),N=+(a*R-o*M+l*x),G=-(a*y-o*b+h*x);return e*F+i*I+s*N+r*G}toArray(){return this._m}asArray(){return this._m}invert(){return this.invertToRef(this),this}reset(){return n.FromValuesToRef(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,this),this._updateIdentityStatus(!1),this}add(t){let e=new this.constructor;return this.addToRef(t,e),e}addToRef(t,e){let i=this._m,s=e._m,r=t.m;for(let a=0;a<16;a++)s[a]=i[a]+r[a];return e.markAsUpdated(),e}addToSelf(t){let e=this._m,i=t.m;for(let s=0;s<16;s++)e[s]+=i[s];return this.markAsUpdated(),this}invertToRef(t){if(this._isIdentity===!0)return n.IdentityToRef(t),t;let e=this._m,i=e[0],s=e[1],r=e[2],a=e[3],o=e[4],h=e[5],l=e[6],c=e[7],d=e[8],u=e[9],f=e[10],_=e[11],g=e[12],p=e[13],E=e[14],T=e[15],R=f*T-E*_,y=u*T-p*_,M=u*E-p*f,b=d*T-g*_,x=d*E-f*g,F=d*p-g*u,I=+(h*R-l*y+c*M),N=-(o*R-l*b+c*x),G=+(o*y-h*b+c*F),Y=-(o*M-h*x+l*F),q=i*I+s*N+r*G+a*Y;if(q===0)return t.copyFrom(this),t;let j=1/q,$=l*T-E*c,Te=h*T-p*c,Se=h*E-p*l,ye=o*T-g*c,Ie=o*E-g*l,We=o*p-g*h,ze=l*_-f*c,nt=h*_-u*c,Xi=h*f-u*l,Hi=o*_-d*c,Ki=o*f-d*l,Yi=o*u-d*h,As=-(s*R-r*y+a*M),Rs=+(i*R-r*b+a*x),ys=-(i*y-s*b+a*F),Cs=+(i*M-s*x+r*F),Is=+(s*$-r*Te+a*Se),Ps=-(i*$-r*ye+a*Ie),Ds=+(i*Te-s*ye+a*We),Tt=-(i*Se-s*Ie+r*We),St=-(s*ze-r*nt+a*Xi),bt=+(i*ze-r*Hi+a*Ki),xt=-(i*nt-s*Hi+a*Yi),Un=+(i*Xi-s*Ki+r*Yi);return n.FromValuesToRef(I*j,As*j,Is*j,St*j,N*j,Rs*j,Ps*j,bt*j,G*j,ys*j,Ds*j,xt*j,Y*j,Cs*j,Tt*j,Un*j,t),t}addAtIndex(t,e){return this._m[t]+=e,this.markAsUpdated(),this}multiplyAtIndex(t,e){return this._m[t]*=e,this.markAsUpdated(),this}setTranslationFromFloats(t,e,i){return this._m[12]=t,this._m[13]=e,this._m[14]=i,this.markAsUpdated(),this}addTranslationFromFloats(t,e,i){return this._m[12]+=t,this._m[13]+=e,this._m[14]+=i,this.markAsUpdated(),this}setTranslation(t){return this.setTranslationFromFloats(t._x,t._y,t._z)}getTranslation(){return new v(this._m[12],this._m[13],this._m[14])}getTranslationToRef(t){return t.x=this._m[12],t.y=this._m[13],t.z=this._m[14],t}removeRotationAndScaling(){let t=this.m;return n.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,t[12],t[13],t[14],t[15],this),this._updateIdentityStatus(t[12]===0&&t[13]===0&&t[14]===0&&t[15]===1),this}multiply(t){let e=new this.constructor;return this.multiplyToRef(t,e),e}copyFrom(t){t.copyToArray(this._m);let e=t;return this.updateFlag=e.updateFlag,this._updateIdentityStatus(e._isIdentity,e._isIdentityDirty,e._isIdentity3x2,e._isIdentity3x2Dirty),this}copyToArray(t,e=0){let i=this._m;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t[e+9]=i[9],t[e+10]=i[10],t[e+11]=i[11],t[e+12]=i[12],t[e+13]=i[13],t[e+14]=i[14],t[e+15]=i[15],this}multiplyToRef(t,e){return this._isIdentity?(e.copyFrom(t),e):t._isIdentity?(e.copyFrom(this),e):(this.multiplyToArray(t,e._m,0),e.markAsUpdated(),e)}multiplyToArray(t,e,i){let s=this._m,r=t.m,a=s[0],o=s[1],h=s[2],l=s[3],c=s[4],d=s[5],u=s[6],f=s[7],_=s[8],g=s[9],p=s[10],E=s[11],T=s[12],R=s[13],y=s[14],M=s[15],b=r[0],x=r[1],F=r[2],I=r[3],N=r[4],G=r[5],Y=r[6],q=r[7],j=r[8],$=r[9],Te=r[10],Se=r[11],ye=r[12],Ie=r[13],We=r[14],ze=r[15];return e[i]=a*b+o*N+h*j+l*ye,e[i+1]=a*x+o*G+h*$+l*Ie,e[i+2]=a*F+o*Y+h*Te+l*We,e[i+3]=a*I+o*q+h*Se+l*ze,e[i+4]=c*b+d*N+u*j+f*ye,e[i+5]=c*x+d*G+u*$+f*Ie,e[i+6]=c*F+d*Y+u*Te+f*We,e[i+7]=c*I+d*q+u*Se+f*ze,e[i+8]=_*b+g*N+p*j+E*ye,e[i+9]=_*x+g*G+p*$+E*Ie,e[i+10]=_*F+g*Y+p*Te+E*We,e[i+11]=_*I+g*q+p*Se+E*ze,e[i+12]=T*b+R*N+y*j+M*ye,e[i+13]=T*x+R*G+y*$+M*Ie,e[i+14]=T*F+R*Y+y*Te+M*We,e[i+15]=T*I+R*q+y*Se+M*ze,this}equals(t){let e=t;if(!e)return!1;if((this._isIdentity||e._isIdentity)&&!this._isIdentityDirty&&!e._isIdentityDirty)return this._isIdentity&&e._isIdentity;let i=this.m,s=e.m;return i[0]===s[0]&&i[1]===s[1]&&i[2]===s[2]&&i[3]===s[3]&&i[4]===s[4]&&i[5]===s[5]&&i[6]===s[6]&&i[7]===s[7]&&i[8]===s[8]&&i[9]===s[9]&&i[10]===s[10]&&i[11]===s[11]&&i[12]===s[12]&&i[13]===s[13]&&i[14]===s[14]&&i[15]===s[15]}clone(){let t=new this.constructor;return t.copyFrom(this),t}getClassName(){return"Matrix"}getHashCode(){let t=Ke(this._m[0]);for(let e=1;e<16;e++)t=t*397^Ke(this._m[e]);return t}decomposeToTransformNode(t){return t.rotationQuaternion=t.rotationQuaternion||new se,this.decompose(t.scaling,t.rotationQuaternion,t.position)}decompose(t,e,i,s){if(this._isIdentity)return i&&i.setAll(0),t&&t.setAll(1),e&&e.copyFromFloats(0,0,0,1),!0;let r=this._m;if(i&&i.copyFromFloats(r[12],r[13],r[14]),t=t||V.Vector3[0],t.x=Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]),t.y=Math.sqrt(r[4]*r[4]+r[5]*r[5]+r[6]*r[6]),t.z=Math.sqrt(r[8]*r[8]+r[9]*r[9]+r[10]*r[10]),s){let a=s.scaling.x<0?-1:1,o=s.scaling.y<0?-1:1,h=s.scaling.z<0?-1:1;t.x*=a,t.y*=o,t.z*=h}else this.determinant()<=0&&(t.y*=-1);if(t._x===0||t._y===0||t._z===0)return e&&e.copyFromFloats(0,0,0,1),!1;if(e){let a=1/t._x,o=1/t._y,h=1/t._z;n.FromValuesToRef(r[0]*a,r[1]*a,r[2]*a,0,r[4]*o,r[5]*o,r[6]*o,0,r[8]*h,r[9]*h,r[10]*h,0,0,0,0,1,V.Matrix[0]),se.FromRotationMatrixToRef(V.Matrix[0],e)}return!0}getRow(t){if(t<0||t>3)return null;let e=t*4;return new it(this._m[e+0],this._m[e+1],this._m[e+2],this._m[e+3])}getRowToRef(t,e){if(t>=0&&t<3){let i=t*4;e.x=this._m[i+0],e.y=this._m[i+1],e.z=this._m[i+2],e.w=this._m[i+3]}return e}setRow(t,e){return this.setRowFromFloats(t,e.x,e.y,e.z,e.w)}transpose(){let t=new this.constructor;return n.TransposeToRef(this,t),t}transposeToRef(t){return n.TransposeToRef(this,t),t}setRowFromFloats(t,e,i,s,r){if(t<0||t>3)return this;let a=t*4;return this._m[a+0]=e,this._m[a+1]=i,this._m[a+2]=s,this._m[a+3]=r,this.markAsUpdated(),this}scale(t){let e=new this.constructor;return this.scaleToRef(t,e),e}scaleToRef(t,e){for(let i=0;i<16;i++)e._m[i]=this._m[i]*t;return e.markAsUpdated(),e}scaleAndAddToRef(t,e){for(let i=0;i<16;i++)e._m[i]+=this._m[i]*t;return e.markAsUpdated(),e}toNormalMatrix(t){let e=V.Matrix[0];this.invertToRef(e),e.transposeToRef(t);let i=t._m;return n.FromValuesToRef(i[0],i[1],i[2],0,i[4],i[5],i[6],0,i[8],i[9],i[10],0,0,0,0,1,t),t}getRotationMatrix(){let t=new this.constructor;return this.getRotationMatrixToRef(t),t}getRotationMatrixToRef(t){let e=V.Vector3[0];if(!this.decompose(e))return n.IdentityToRef(t),t;let i=this._m,s=1/e._x,r=1/e._y,a=1/e._z;return n.FromValuesToRef(i[0]*s,i[1]*s,i[2]*s,0,i[4]*r,i[5]*r,i[6]*r,0,i[8]*a,i[9]*a,i[10]*a,0,0,0,0,1,t),t}toggleModelMatrixHandInPlace(){let t=this._m;return t[2]*=-1,t[6]*=-1,t[8]*=-1,t[9]*=-1,t[14]*=-1,this.markAsUpdated(),this}toggleProjectionMatrixHandInPlace(){let t=this._m;return t[8]*=-1,t[9]*=-1,t[10]*=-1,t[11]*=-1,this.markAsUpdated(),this}static FromArray(t,e=0){let i=new n;return n.FromArrayToRef(t,e,i),i}static FromArrayToRef(t,e,i){for(let s=0;s<16;s++)i._m[s]=t[s+e];return i.markAsUpdated(),i}static FromFloat32ArrayToRefScaled(t,e,i,s){for(let r=0;r<16;r++)s._m[r]=t[r+e]*i;return s.markAsUpdated(),s}static get IdentityReadOnly(){return n._IdentityReadOnly}static FromValuesToRef(t,e,i,s,r,a,o,h,l,c,d,u,f,_,g,p,E){let T=E._m;T[0]=t,T[1]=e,T[2]=i,T[3]=s,T[4]=r,T[5]=a,T[6]=o,T[7]=h,T[8]=l,T[9]=c,T[10]=d,T[11]=u,T[12]=f,T[13]=_,T[14]=g,T[15]=p,E.markAsUpdated()}static FromValues(t,e,i,s,r,a,o,h,l,c,d,u,f,_,g,p){let E=new n,T=E._m;return T[0]=t,T[1]=e,T[2]=i,T[3]=s,T[4]=r,T[5]=a,T[6]=o,T[7]=h,T[8]=l,T[9]=c,T[10]=d,T[11]=u,T[12]=f,T[13]=_,T[14]=g,T[15]=p,E.markAsUpdated(),E}static Compose(t,e,i){let s=new n;return n.ComposeToRef(t,e,i,s),s}static ComposeToRef(t,e,i,s){let r=s._m,a=e._x,o=e._y,h=e._z,l=e._w,c=a+a,d=o+o,u=h+h,f=a*c,_=a*d,g=a*u,p=o*d,E=o*u,T=h*u,R=l*c,y=l*d,M=l*u,b=t._x,x=t._y,F=t._z;return r[0]=(1-(p+T))*b,r[1]=(_+M)*b,r[2]=(g-y)*b,r[3]=0,r[4]=(_-M)*x,r[5]=(1-(f+T))*x,r[6]=(E+R)*x,r[7]=0,r[8]=(g+y)*F,r[9]=(E-R)*F,r[10]=(1-(f+p))*F,r[11]=0,r[12]=i._x,r[13]=i._y,r[14]=i._z,r[15]=1,s.markAsUpdated(),s}static Identity(){let t=n.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return t._updateIdentityStatus(!0),t}static IdentityToRef(t){return n.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,t),t._updateIdentityStatus(!0),t}static Zero(){let t=n.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return t._updateIdentityStatus(!1),t}static RotationX(t){let e=new n;return n.RotationXToRef(t,e),e}static Invert(t){let e=new t.constructor;return t.invertToRef(e),e}static RotationXToRef(t,e){let i=Math.sin(t),s=Math.cos(t);return n.FromValuesToRef(1,0,0,0,0,s,i,0,0,-i,s,0,0,0,0,1,e),e._updateIdentityStatus(s===1&&i===0),e}static RotationY(t){let e=new n;return n.RotationYToRef(t,e),e}static RotationYToRef(t,e){let i=Math.sin(t),s=Math.cos(t);return n.FromValuesToRef(s,0,-i,0,0,1,0,0,i,0,s,0,0,0,0,1,e),e._updateIdentityStatus(s===1&&i===0),e}static RotationZ(t){let e=new n;return n.RotationZToRef(t,e),e}static RotationZToRef(t,e){let i=Math.sin(t),s=Math.cos(t);return n.FromValuesToRef(s,i,0,0,-i,s,0,0,0,0,1,0,0,0,0,1,e),e._updateIdentityStatus(s===1&&i===0),e}static RotationAxis(t,e){let i=new n;return n.RotationAxisToRef(t,e,i),i}static RotationAxisToRef(t,e,i){let s=Math.sin(-e),r=Math.cos(-e),a=1-r;t.normalize();let o=i._m;return o[0]=t._x*t._x*a+r,o[1]=t._x*t._y*a-t._z*s,o[2]=t._x*t._z*a+t._y*s,o[3]=0,o[4]=t._y*t._x*a+t._z*s,o[5]=t._y*t._y*a+r,o[6]=t._y*t._z*a-t._x*s,o[7]=0,o[8]=t._z*t._x*a-t._y*s,o[9]=t._z*t._y*a+t._x*s,o[10]=t._z*t._z*a+r,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,i.markAsUpdated(),i}static RotationAlignToRef(t,e,i){let s=v.Dot(e,t),r=i._m;if(s<-1+_e)r[0]=-1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=-1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0;else{let a=v.Cross(e,t),o=1/(1+s);r[0]=a._x*a._x*o+s,r[1]=a._y*a._x*o-a._z,r[2]=a._z*a._x*o+a._y,r[3]=0,r[4]=a._x*a._y*o+a._z,r[5]=a._y*a._y*o+s,r[6]=a._z*a._y*o-a._x,r[7]=0,r[8]=a._x*a._z*o-a._y,r[9]=a._y*a._z*o+a._x,r[10]=a._z*a._z*o+s,r[11]=0}return r[12]=0,r[13]=0,r[14]=0,r[15]=1,i.markAsUpdated(),i}static RotationYawPitchRoll(t,e,i){let s=new n;return n.RotationYawPitchRollToRef(t,e,i,s),s}static RotationYawPitchRollToRef(t,e,i,s){return se.RotationYawPitchRollToRef(t,e,i,V.Quaternion[0]),V.Quaternion[0].toRotationMatrix(s),s}static Scaling(t,e,i){let s=new n;return n.ScalingToRef(t,e,i,s),s}static ScalingToRef(t,e,i,s){return n.FromValuesToRef(t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1,s),s._updateIdentityStatus(t===1&&e===1&&i===1),s}static Translation(t,e,i){let s=new n;return n.TranslationToRef(t,e,i,s),s}static TranslationToRef(t,e,i,s){return n.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,t,e,i,1,s),s._updateIdentityStatus(t===0&&e===0&&i===0),s}static Lerp(t,e,i){let s=new t.constructor;return n.LerpToRef(t,e,i,s),s}static LerpToRef(t,e,i,s){let r=s._m,a=t.m,o=e.m;for(let h=0;h<16;h++)r[h]=a[h]*(1-i)+o[h]*i;return s.markAsUpdated(),s}static DecomposeLerp(t,e,i){let s=new t.constructor;return n.DecomposeLerpToRef(t,e,i,s),s}static DecomposeLerpToRef(t,e,i,s){let r=V.Vector3[0],a=V.Quaternion[0],o=V.Vector3[1];t.decompose(r,a,o);let h=V.Vector3[2],l=V.Quaternion[1],c=V.Vector3[3];e.decompose(h,l,c);let d=V.Vector3[4];v.LerpToRef(r,h,i,d);let u=V.Quaternion[2];se.SlerpToRef(a,l,i,u);let f=V.Vector3[5];return v.LerpToRef(o,c,i,f),n.ComposeToRef(d,u,f,s),s}static LookAtLH(t,e,i){let s=new n;return n.LookAtLHToRef(t,e,i,s),s}static LookAtLHToRef(t,e,i,s){let r=V.Vector3[0],a=V.Vector3[1],o=V.Vector3[2];e.subtractToRef(t,o),o.normalize(),v.CrossToRef(i,o,r);let h=r.lengthSquared();h===0?r.x=1:r.normalizeFromLength(Math.sqrt(h)),v.CrossToRef(o,r,a),a.normalize();let l=-v.Dot(r,t),c=-v.Dot(a,t),d=-v.Dot(o,t);n.FromValuesToRef(r._x,a._x,o._x,0,r._y,a._y,o._y,0,r._z,a._z,o._z,0,l,c,d,1,s)}static LookAtRH(t,e,i){let s=new n;return n.LookAtRHToRef(t,e,i,s),s}static LookAtRHToRef(t,e,i,s){let r=V.Vector3[0],a=V.Vector3[1],o=V.Vector3[2];t.subtractToRef(e,o),o.normalize(),v.CrossToRef(i,o,r);let h=r.lengthSquared();h===0?r.x=1:r.normalizeFromLength(Math.sqrt(h)),v.CrossToRef(o,r,a),a.normalize();let l=-v.Dot(r,t),c=-v.Dot(a,t),d=-v.Dot(o,t);return n.FromValuesToRef(r._x,a._x,o._x,0,r._y,a._y,o._y,0,r._z,a._z,o._z,0,l,c,d,1,s),s}static LookDirectionLH(t,e){let i=new n;return n.LookDirectionLHToRef(t,e,i),i}static LookDirectionLHToRef(t,e,i){let s=V.Vector3[0];s.copyFrom(t),s.scaleInPlace(-1);let r=V.Vector3[1];return v.CrossToRef(e,s,r),n.FromValuesToRef(r._x,r._y,r._z,0,e._x,e._y,e._z,0,s._x,s._y,s._z,0,0,0,0,1,i),i}static LookDirectionRH(t,e){let i=new n;return n.LookDirectionRHToRef(t,e,i),i}static LookDirectionRHToRef(t,e,i){let s=V.Vector3[2];return v.CrossToRef(e,t,s),n.FromValuesToRef(s._x,s._y,s._z,0,e._x,e._y,e._z,0,t._x,t._y,t._z,0,0,0,0,1,i),i}static OrthoLH(t,e,i,s,r){let a=new n;return n.OrthoLHToRef(t,e,i,s,a,r),a}static OrthoLHToRef(t,e,i,s,r,a){let o=i,h=s,l=2/t,c=2/e,d=2/(h-o),u=-(h+o)/(h-o);return n.FromValuesToRef(l,0,0,0,0,c,0,0,0,0,d,0,0,0,u,1,r),a&&r.multiplyToRef(Bt,r),r._updateIdentityStatus(l===1&&c===1&&d===1&&u===0),r}static OrthoOffCenterLH(t,e,i,s,r,a,o){let h=new n;return n.OrthoOffCenterLHToRef(t,e,i,s,r,a,h,o),h}static OrthoOffCenterLHToRef(t,e,i,s,r,a,o,h){let l=r,c=a,d=2/(e-t),u=2/(s-i),f=2/(c-l),_=-(c+l)/(c-l),g=(t+e)/(t-e),p=(s+i)/(i-s);return n.FromValuesToRef(d,0,0,0,0,u,0,0,0,0,f,0,g,p,_,1,o),h&&o.multiplyToRef(Bt,o),o.markAsUpdated(),o}static OrthoOffCenterRH(t,e,i,s,r,a,o){let h=new n;return n.OrthoOffCenterRHToRef(t,e,i,s,r,a,h,o),h}static OrthoOffCenterRHToRef(t,e,i,s,r,a,o,h){return n.OrthoOffCenterLHToRef(t,e,i,s,r,a,o,h),o._m[10]*=-1,o}static PerspectiveLH(t,e,i,s,r,a=0){let o=new n,h=i,l=s,c=2*h/t,d=2*h/e,u=(l+h)/(l-h),f=-2*l*h/(l-h),_=Math.tan(a);return n.FromValuesToRef(c,0,0,0,0,d,0,_,0,0,u,1,0,0,f,0,o),r&&o.multiplyToRef(Bt,o),o._updateIdentityStatus(!1),o}static PerspectiveFovLH(t,e,i,s,r,a=0,o=!1){let h=new n;return n.PerspectiveFovLHToRef(t,e,i,s,h,!0,r,a,o),h}static PerspectiveFovLHToRef(t,e,i,s,r,a=!0,o,h=0,l=!1){let c=i,d=s,u=1/Math.tan(t*.5),f=a?u/e:u,_=a?u:u*e,g=l&&c===0?-1:d!==0?(d+c)/(d-c):1,p=l&&c===0?2*d:d!==0?-2*d*c/(d-c):-2*c,E=Math.tan(h);return n.FromValuesToRef(f,0,0,0,0,_,0,E,0,0,g,1,0,0,p,0,r),o&&r.multiplyToRef(Bt,r),r._updateIdentityStatus(!1),r}static PerspectiveFovReverseLHToRef(t,e,i,s,r,a=!0,o,h=0){let l=1/Math.tan(t*.5),c=a?l/e:l,d=a?l:l*e,u=Math.tan(h);return n.FromValuesToRef(c,0,0,0,0,d,0,u,0,0,-i,1,0,0,1,0,r),o&&r.multiplyToRef(Bt,r),r._updateIdentityStatus(!1),r}static PerspectiveFovRH(t,e,i,s,r,a=0,o=!1){let h=new n;return n.PerspectiveFovRHToRef(t,e,i,s,h,!0,r,a,o),h}static PerspectiveFovRHToRef(t,e,i,s,r,a=!0,o,h=0,l=!1){let c=i,d=s,u=1/Math.tan(t*.5),f=a?u/e:u,_=a?u:u*e,g=l&&c===0?1:d!==0?-(d+c)/(d-c):-1,p=l&&c===0?2*d:d!==0?-2*d*c/(d-c):-2*c,E=Math.tan(h);return n.FromValuesToRef(f,0,0,0,0,_,0,E,0,0,g,-1,0,0,p,0,r),o&&r.multiplyToRef(Bt,r),r._updateIdentityStatus(!1),r}static PerspectiveFovReverseRHToRef(t,e,i,s,r,a=!0,o,h=0){let l=1/Math.tan(t*.5),c=a?l/e:l,d=a?l:l*e,u=Math.tan(h);return n.FromValuesToRef(c,0,0,0,0,d,0,u,0,0,-i,-1,0,0,-1,0,r),o&&r.multiplyToRef(Bt,r),r._updateIdentityStatus(!1),r}static PerspectiveFovWebVRToRef(t,e,i,s,r=!1,a,o=0){let h=r?-1:1,l=Math.tan(t.upDegrees*Math.PI/180),c=Math.tan(t.downDegrees*Math.PI/180),d=Math.tan(t.leftDegrees*Math.PI/180),u=Math.tan(t.rightDegrees*Math.PI/180),f=2/(d+u),_=2/(l+c),g=Math.tan(o),p=s._m;return p[0]=f,p[1]=p[2]=p[3]=p[4]=0,p[5]=_,p[6]=0,p[7]=g,p[8]=(d-u)*f*.5,p[9]=-((l-c)*_*.5),p[10]=-i/(e-i),p[11]=1*h,p[12]=p[13]=p[15]=0,p[14]=-(2*i*e)/(i-e),a&&s.multiplyToRef(Bt,s),s.markAsUpdated(),s}static GetFinalMatrix(t,e,i,s,r,a){let o=t.width,h=t.height,l=t.x,c=t.y,d=n.FromValues(o/2,0,0,0,0,-h/2,0,0,0,0,a-r,0,l+o/2,h/2+c,r,1),u=new e.constructor;return e.multiplyToRef(i,u),u.multiplyToRef(s,u),u.multiplyToRef(d,u)}static GetAsMatrix2x2(t){let e=t.m,i=[e[0],e[1],e[4],e[5]];return Je.MatrixUse64Bits?i:new Float32Array(i)}static GetAsMatrix3x3(t){let e=t.m,i=[e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10]];return Je.MatrixUse64Bits?i:new Float32Array(i)}static Transpose(t){let e=new t.constructor;return n.TransposeToRef(t,e),e}static TransposeToRef(t,e){let i=e._m,s=t.m;return i[0]=s[0],i[1]=s[4],i[2]=s[8],i[3]=s[12],i[4]=s[1],i[5]=s[5],i[6]=s[9],i[7]=s[13],i[8]=s[2],i[9]=s[6],i[10]=s[10],i[11]=s[14],i[12]=s[3],i[13]=s[7],i[14]=s[11],i[15]=s[15],e.markAsUpdated(),e._updateIdentityStatus(t._isIdentity,t._isIdentityDirty),e}static Reflection(t){let e=new n;return n.ReflectionToRef(t,e),e}static ReflectionToRef(t,e){t.normalize();let i=t.normal.x,s=t.normal.y,r=t.normal.z,a=-2*i,o=-2*s,h=-2*r;return n.FromValuesToRef(a*i+1,o*i,h*i,0,a*s,o*s+1,h*s,0,a*r,o*r,h*r+1,0,a*t.d,o*t.d,h*t.d,1,e),e}static FromXYZAxesToRef(t,e,i,s){return n.FromValuesToRef(t._x,t._y,t._z,0,e._x,e._y,e._z,0,i._x,i._y,i._z,0,0,0,0,1,s),s}static FromQuaternionToRef(t,e){let i=t._x*t._x,s=t._y*t._y,r=t._z*t._z,a=t._x*t._y,o=t._z*t._w,h=t._z*t._x,l=t._y*t._w,c=t._y*t._z,d=t._x*t._w;return e._m[0]=1-2*(s+r),e._m[1]=2*(a+o),e._m[2]=2*(h-l),e._m[3]=0,e._m[4]=2*(a-o),e._m[5]=1-2*(r+i),e._m[6]=2*(c+d),e._m[7]=0,e._m[8]=2*(h+l),e._m[9]=2*(c-d),e._m[10]=1-2*(s+i),e._m[11]=0,e._m[12]=0,e._m[13]=0,e._m[14]=0,e._m[15]=1,e.markAsUpdated(),e}};P._UpdateFlagSeed=0;P._IdentityReadOnly=P.Identity();var V=class{};V.Vector3=we.BuildTuple(11,v.Zero);V.Matrix=we.BuildTuple(2,P.Identity);V.Quaternion=we.BuildTuple(3,se.Zero);var C=class{};C.Vector2=we.BuildTuple(3,ve.Zero);C.Vector3=we.BuildTuple(13,v.Zero);C.Vector4=we.BuildTuple(3,it.Zero);C.Quaternion=we.BuildTuple(2,se.Zero);C.Matrix=we.BuildTuple(8,P.Identity);Ye("BABYLON.Vector2",ve);Ye("BABYLON.Vector3",v);Ye("BABYLON.Vector4",it);Ye("BABYLON.Matrix",P);var Bt=P.FromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1),Vs=class{constructor(t,e=!1,i,s){this.initialize(t,e,i,s)}initialize(t,e=!1,i,s){return this.mask=t,this.skipNextObservers=e,this.target=i,this.currentTarget=s,this}},Gs=class{constructor(t,e,i=null){this.callback=t,this.mask=e,this.scope=i,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1}},D=class n{constructor(t){this._observers=new Array,this._numObserversMarkedAsDeleted=0,this._eventState=new Vs(0),t&&(this._onObserverAdded=t)}static FromPromise(t,e){let i=new n;return t.then(s=>{i.notifyObservers(s)}).catch(s=>{if(e)e.notifyObservers(s);else throw s}),i}get observers(){return this._observers}add(t,e=-1,i=!1,s=null,r=!1){if(!t)return null;let a=new Gs(t,e,s);return a.unregisterOnNextCall=r,i?this._observers.unshift(a):this._observers.push(a),this._onObserverAdded&&this._onObserverAdded(a),a}addOnce(t){return this.add(t,void 0,void 0,void 0,!0)}remove(t){return t&&this._observers.indexOf(t)!==-1?(this._deferUnregister(t),!0):!1}removeCallback(t,e){for(let i=0;i<this._observers.length;i++){let s=this._observers[i];if(!s._willBeUnregistered&&s.callback===t&&(!e||e===s.scope))return this._deferUnregister(s),!0}return!1}_deferUnregister(t){this._numObserversMarkedAsDeleted++,t.unregisterOnNextCall=!1,t._willBeUnregistered=!0,setTimeout(()=>{this._remove(t)},0)}_remove(t){if(!t)return!1;let e=this._observers.indexOf(t);return e!==-1?(this._numObserversMarkedAsDeleted--,this._observers.splice(e,1),!0):!1}makeObserverTopPriority(t){this._remove(t),this._observers.unshift(t)}makeObserverBottomPriority(t){this._remove(t),this._observers.push(t)}notifyObservers(t,e=-1,i,s,r){if(!this._observers.length)return!0;let a=this._eventState;a.mask=e,a.target=i,a.currentTarget=s,a.skipNextObservers=!1,a.lastReturnValue=t,a.userInfo=r;for(let o of this._observers)if(!o._willBeUnregistered&&(o.mask&e&&(o.unregisterOnNextCall&&this._deferUnregister(o),o.scope?a.lastReturnValue=o.callback.apply(o.scope,[t,a]):a.lastReturnValue=o.callback(t,a)),a.skipNextObservers))return!1;return!0}notifyObserver(t,e,i=-1){if(t._willBeUnregistered)return;let s=this._eventState;s.mask=i,s.skipNextObservers=!1,t.unregisterOnNextCall&&this._deferUnregister(t),t.callback(e,s)}hasObservers(){return this._observers.length-this._numObserversMarkedAsDeleted>0}clear(){this._observers=new Array,this._onObserverAdded=null}clone(){let t=new n;return t._observers=this._observers.slice(0),t}hasSpecificMask(t=-1){for(let e of this._observers)if(e.mask&t||e.mask===t)return!0;return!1}},Ws=class{constructor(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}get wrapU(){return this._cachedWrapU}set wrapU(t){this._cachedWrapU=t}get wrapV(){return this._cachedWrapV}set wrapV(t){this._cachedWrapV=t}get wrapR(){return this._cachedWrapR}set wrapR(t){this._cachedWrapR=t}get anisotropicFilteringLevel(){return this._cachedAnisotropicFilteringLevel}set anisotropicFilteringLevel(t){this._cachedAnisotropicFilteringLevel=t}get comparisonFunction(){return this._comparisonFunction}set comparisonFunction(t){this._comparisonFunction=t}get useMipMaps(){return this._useMipMaps}set useMipMaps(t){this._useMipMaps=t}setParameters(t=1,e=1,i=1,s=1,r=2,a=0){return this._cachedWrapU=t,this._cachedWrapV=e,this._cachedWrapR=i,this._cachedAnisotropicFilteringLevel=s,this.samplingMode=r,this._comparisonFunction=a,this}compareSampler(t){return this._cachedWrapU===t._cachedWrapU&&this._cachedWrapV===t._cachedWrapV&&this._cachedWrapR===t._cachedWrapR&&this._cachedAnisotropicFilteringLevel===t._cachedAnisotropicFilteringLevel&&this.samplingMode===t.samplingMode&&this._comparisonFunction===t._comparisonFunction&&this._useMipMaps===t._useMipMaps}},xe;(function(n){n[n.Unknown=0]="Unknown",n[n.Url=1]="Url",n[n.Temp=2]="Temp",n[n.Raw=3]="Raw",n[n.Dynamic=4]="Dynamic",n[n.RenderTarget=5]="RenderTarget",n[n.MultiRenderTarget=6]="MultiRenderTarget",n[n.Cube=7]="Cube",n[n.CubeRaw=8]="CubeRaw",n[n.CubePrefiltered=9]="CubePrefiltered",n[n.Raw3D=10]="Raw3D",n[n.Raw2DArray=11]="Raw2DArray",n[n.DepthStencil=12]="DepthStencil",n[n.CubeRawRGBD=13]="CubeRawRGBD",n[n.Depth=14]="Depth"})(xe||(xe={}));var oi=(()=>{class n extends Ws{constructor(e,i,s=!1){super(),this.isReady=!1,this.isCube=!1,this.is3D=!1,this.is2DArray=!1,this.isMultiview=!1,this.url="",this.generateMipMaps=!1,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new D,this.onErrorObservable=new D,this.onRebuildCallback=null,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=!1,this._invertVScale=!1,this._associatedChannel=-1,this._source=xe.Unknown,this._buffer=null,this._bufferView=null,this._bufferViewArray=null,this._bufferViewArrayArray=null,this._size=0,this._extension="",this._files=null,this._workingCanvas=null,this._workingContext=null,this._cachedCoordinatesMode=null,this._isDisabled=!1,this._compression=null,this._sphericalPolynomial=null,this._sphericalPolynomialPromise=null,this._sphericalPolynomialComputed=!1,this._lodGenerationScale=0,this._lodGenerationOffset=0,this._useSRGBBuffer=!1,this._lodTextureHigh=null,this._lodTextureMid=null,this._lodTextureLow=null,this._isRGBD=!1,this._linearSpecularLOD=!1,this._irradianceTexture=null,this._hardwareTexture=null,this._maxLodLevel=null,this._references=1,this._gammaSpace=null,this._engine=e,this._source=i,this._uniqueId=n._Counter++,s||(this._hardwareTexture=e._createHardwareTexture())}get useMipMaps(){return this.generateMipMaps}set useMipMaps(e){this.generateMipMaps=e}get uniqueId(){return this._uniqueId}_setUniqueId(e){this._uniqueId=e}getEngine(){return this._engine}get source(){return this._source}incrementReferences(){this._references++}updateSize(e,i,s=1){this._engine.updateTextureDimensions(this,e,i,s),this.width=e,this.height=i,this.depth=s,this.baseWidth=e,this.baseHeight=i,this.baseDepth=s,this._size=e*i*s}_rebuild(){var e;if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){let s=this.onRebuildCallback(this),r=a=>{a._swapAndDie(this,!1),this.isReady=s.isReady};s.isAsync?s.proxy.then(r):r(s.proxy);return}let i;switch(this.source){case xe.Temp:break;case xe.Url:i=this._engine.createTexture((e=this._originalUrl)!==null&&e!==void 0?e:this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,s=>{s._swapAndDie(this,!1),this.isReady=!0},null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer);return;case xe.Raw:i=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,void 0,this._useSRGBBuffer),i._swapAndDie(this,!1),this.isReady=!0;break;case xe.Raw3D:i=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),i._swapAndDie(this,!1),this.isReady=!0;break;case xe.Raw2DArray:i=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),i._swapAndDie(this,!1),this.isReady=!0;break;case xe.Dynamic:i=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),i._swapAndDie(this,!1),this._engine.updateDynamicTexture(this,this._engine.getRenderingCanvas(),this.invertY,void 0,void 0,!0);break;case xe.Cube:i=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,()=>{i._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer);return;case xe.CubeRaw:i=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),i._swapAndDie(this,!1),this.isReady=!0;break;case xe.CubeRawRGBD:return;case xe.CubePrefiltered:i=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,s=>{s&&s._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension),i._sphericalPolynomial=this._sphericalPolynomial;return}}_swapAndDie(e,i=!0){var s;(s=this._hardwareTexture)===null||s===void 0||s.setUsage(e._source,this.generateMipMaps,this.isCube,this.width,this.height),e._hardwareTexture=this._hardwareTexture,i&&(e._isRGBD=this._isRGBD),this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(e._irradianceTexture&&e._irradianceTexture.dispose(),e._irradianceTexture=this._irradianceTexture);let r=this._engine.getLoadedTexturesCache(),a=r.indexOf(this);a!==-1&&r.splice(a,1),a=r.indexOf(e),a===-1&&r.push(e)}dispose(){this._references--,this.onLoadedObservable.clear(),this.onErrorObservable.clear(),this._references===0&&(this._engine._releaseTexture(this),this._hardwareTexture=null)}}return n._Counter=0,n})();function Oe(){return typeof window<"u"}function Tn(){return typeof navigator<"u"}function Di(){return typeof document<"u"}function Xr(n){let t="",e=n.firstChild;for(;e;)e.nodeType===3&&(t+=e.textContent),e=e.nextSibling;return t}var zs={IsWindowObjectExist:Oe,IsNavigatorAvailable:Tn,IsDocumentAvailable:Di,GetDOMTextContent:Xr};function H(n){return`${n} needs to be imported before as it contains a side-effect required by your code.`}var O=class n{static _CheckLimit(t,e){let i=n._LogLimitOutputs[t];return i?i.current++:(i={limit:e,current:1},n._LogLimitOutputs[t]=i),i.current<=i.limit}static _GenerateLimitMessage(t,e=1){var i;let s=n._LogLimitOutputs[t];if(!s||!n.MessageLimitReached)return;let r=this._Levels[e];s.current===s.limit&&n[r.name](n.MessageLimitReached.replace(/%LIMIT%/g,""+s.limit).replace(/%TYPE%/g,(i=r.name)!==null&&i!==void 0?i:""))}static _AddLogEntry(t){n._LogCache=t+n._LogCache,n.OnNewCacheEntry&&n.OnNewCacheEntry(t)}static _FormatMessage(t){let e=s=>s<10?"0"+s:""+s,i=new Date;return"["+e(i.getHours())+":"+e(i.getMinutes())+":"+e(i.getSeconds())+"]: "+t}static _LogDisabled(t,e){}static _LogEnabled(t=1,e,i){if(i!==void 0&&!n._CheckLimit(e,i))return;let s=n._FormatMessage(e),r=this._Levels[t];r.logFunc&&r.logFunc("BJS - "+s);let a=`<div style='color:${r.color}'>${s}</div><br>`;n._AddLogEntry(a),n._GenerateLimitMessage(e,t)}static get LogCache(){return n._LogCache}static ClearLogCache(){n._LogCache="",n._LogLimitOutputs={},n.errorsCount=0}static set LogLevels(t){n.Log=n._LogDisabled,n.Warn=n._LogDisabled,n.Error=n._LogDisabled,[n.MessageLogLevel,n.WarningLogLevel,n.ErrorLogLevel].forEach(e=>{if((t&e)===e){let i=this._Levels[e];n[i.name]=n._LogEnabled.bind(n,e)}})}};O.NoneLogLevel=0;O.MessageLogLevel=1;O.WarningLogLevel=2;O.ErrorLogLevel=4;O.AllLogLevel=7;O.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.";O._LogCache="";O._LogLimitOutputs={};O._Levels=[{},{color:"white",logFunc:console.log,name:"Log"},{color:"orange",logFunc:console.warn,name:"Warn"},{},{color:"red",logFunc:console.error,name:"Error"}];O.errorsCount=0;O.Log=O._LogEnabled.bind(O,O.MessageLogLevel);O.Warn=O._LogEnabled.bind(O,O.WarningLogLevel);O.Error=O._LogEnabled.bind(O,O.ErrorLogLevel);var Xn="attribute",Hn="varying",jt=class{constructor(){this.children=[]}isValid(t){return!0}process(t,e){var i,s,r,a,o,h;let l="";if(this.line){let c=this.line,d=e.processor;if(d){d.lineProcessor&&(c=d.lineProcessor(c,e.isFragment,e.processingContext));let u=(s=(i=e.processor)===null||i===void 0?void 0:i.attributeKeywordName)!==null&&s!==void 0?s:Xn,f=e.isFragment&&!((r=e.processor)===null||r===void 0)&&r.varyingFragmentKeywordName?(a=e.processor)===null||a===void 0?void 0:a.varyingFragmentKeywordName:!e.isFragment&&!((o=e.processor)===null||o===void 0)&&o.varyingVertexKeywordName?(h=e.processor)===null||h===void 0?void 0:h.varyingVertexKeywordName:Hn;!e.isFragment&&d.attributeProcessor&&this.line.startsWith(u)?c=d.attributeProcessor(this.line,t,e.processingContext):d.varyingProcessor&&this.line.startsWith(f)?c=d.varyingProcessor(this.line,e.isFragment,t,e.processingContext):d.uniformProcessor&&d.uniformRegexp&&d.uniformRegexp.test(this.line)?e.lookForClosingBracketForUniformBuffer||(c=d.uniformProcessor(this.line,e.isFragment,t,e.processingContext)):d.uniformBufferProcessor&&d.uniformBufferRegexp&&d.uniformBufferRegexp.test(this.line)?e.lookForClosingBracketForUniformBuffer||(c=d.uniformBufferProcessor(this.line,e.isFragment,e.processingContext),e.lookForClosingBracketForUniformBuffer=!0):d.textureProcessor&&d.textureRegexp&&d.textureRegexp.test(this.line)?c=d.textureProcessor(this.line,e.isFragment,t,e.processingContext):(d.uniformProcessor||d.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!e.lookForClosingBracketForUniformBuffer&&(/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?d.uniformProcessor&&(c=d.uniformProcessor(this.line,e.isFragment,t,e.processingContext)):d.uniformBufferProcessor&&(c=d.uniformBufferProcessor(this.line,e.isFragment,e.processingContext),e.lookForClosingBracketForUniformBuffer=!0)),e.lookForClosingBracketForUniformBuffer&&this.line.indexOf("}")!==-1&&(e.lookForClosingBracketForUniformBuffer=!1,d.endOfUniformBufferProcessor&&(c=d.endOfUniformBufferProcessor(this.line,e.isFragment,e.processingContext)))}l+=c+`\r
`}return this.children.forEach(c=>{l+=c.process(t,e)}),this.additionalDefineKey&&(t[this.additionalDefineKey]=this.additionalDefineValue||"true"),l}},Xs=class{constructor(){this._lines=[]}get currentLine(){return this._lines[this.lineIndex]}get canRead(){return this.lineIndex<this._lines.length-1}set lines(t){this._lines.length=0;for(let e of t){if(e[0]==="#"){this._lines.push(e);continue}if(e.trim().startsWith("//")){this._lines.push(e);continue}let i=e.split(";");for(let s=0;s<i.length;s++){let r=i[s];r=r.trim(),r&&this._lines.push(r+(s!==i.length-1?";":""))}}}},Ai=class extends jt{process(t,e){for(let i=0;i<this.children.length;i++){let s=this.children[i];if(s.isValid(t))return s.process(t,e)}return""}},Hs=class extends jt{isValid(t){return this.testExpression.isTrue(t)}},Wi=(()=>{class n{isTrue(e){return!0}static postfixToInfix(e){let i=[];for(let s of e)if(n._OperatorPriority[s]===void 0)i.push(s);else{let r=i[i.length-1],a=i[i.length-2];i.length-=2,i.push(`(${a}${s}${r})`)}return i[i.length-1]}static infixToPostfix(e){let i=[],s=-1,r=()=>{c=c.trim(),c!==""&&(i.push(c),c="")},a=d=>{s<n._Stack.length-1&&(n._Stack[++s]=d)},o=()=>n._Stack[s],h=()=>s===-1?"!!INVALID EXPRESSION!!":n._Stack[s--],l=0,c="";for(;l<e.length;){let d=e.charAt(l),u=l<e.length-1?e.substr(l,2):"";if(d==="(")c="",a(d);else if(d===")"){for(r();s!==-1&&o()!=="(";)i.push(h());h()}else if(n._OperatorPriority[u]>1){for(r();s!==-1&&n._OperatorPriority[o()]>=n._OperatorPriority[u];)i.push(h());a(u),l++}else c+=d;l++}for(r();s!==-1;)o()==="("?h():i.push(h());return i}}return n._OperatorPriority={")":0,"(":1,"||":2,"&&":3},n._Stack=["","","","","","","","","","","","","","","","","","","",""],n})(),ri=class extends Wi{constructor(t,e=!1){super(),this.define=t,this.not=e}isTrue(t){let e=t[this.define]!==void 0;return this.not&&(e=!e),e}},Ks=class extends Wi{isTrue(t){return this.leftOperand.isTrue(t)||this.rightOperand.isTrue(t)}},Ys=class extends Wi{isTrue(t){return this.leftOperand.isTrue(t)&&this.rightOperand.isTrue(t)}},js=class extends Wi{constructor(t,e,i){super(),this.define=t,this.operand=e,this.testValue=i}isTrue(t){let e=t[this.define];e===void 0&&(e=this.define);let i=!1,s=parseInt(e),r=parseInt(this.testValue);switch(this.operand){case">":i=s>r;break;case"<":i=s<r;break;case"<=":i=s<=r;break;case">=":i=s>=r;break;case"==":i=s===r;break}return i}},Fe;(function(n){n[n.GLSL=0]="GLSL",n[n.WGSL=1]="WGSL"})(Fe||(Fe={}));var Kn=/defined\s*?\((.+?)\)/g,Os=/defined\s*?\[(.+?)\]/g,en=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g,Yt=class n{static Initialize(t){t.processor&&t.processor.initializeShaders&&t.processor.initializeShaders(t.processingContext)}static Process(t,e,i,s){var r;!((r=e.processor)===null||r===void 0)&&r.preProcessShaderCode&&(t=e.processor.preProcessShaderCode(t,e.isFragment)),this._ProcessIncludes(t,e,a=>{e.processCodeAfterIncludes&&(a=e.processCodeAfterIncludes(e.isFragment?"fragment":"vertex",a));let o=this._ProcessShaderConversion(a,e,s);i(o,a)})}static PreProcess(t,e,i,s){var r;!((r=e.processor)===null||r===void 0)&&r.preProcessShaderCode&&(t=e.processor.preProcessShaderCode(t,e.isFragment)),this._ProcessIncludes(t,e,a=>{e.processCodeAfterIncludes&&(a=e.processCodeAfterIncludes(e.isFragment?"fragment":"vertex",a));let o=this._ApplyPreProcessing(a,e,s);i(o,a)})}static Finalize(t,e,i){return!i.processor||!i.processor.finalizeShaders?{vertexCode:t,fragmentCode:e}:i.processor.finalizeShaders(t,e,i.processingContext)}static _ProcessPrecision(t,e){var i;if(!((i=e.processor)===null||i===void 0)&&i.noPrecision)return t;let s=e.shouldUseHighPrecisionShader;return t.indexOf("precision highp float")===-1?s?t=`precision highp float;
`+t:t=`precision mediump float;
`+t:s||(t=t.replace("precision highp float","precision mediump float")),t}static _ExtractOperation(t){let e=/defined\((.+)\)/.exec(t);if(e&&e.length)return new ri(e[1].trim(),t[0]==="!");let i=["==",">=","<=","<",">"],s="",r=0;for(s of i)if(r=t.indexOf(s),r>-1)break;if(r===-1)return new ri(t);let a=t.substring(0,r).trim(),o=t.substring(r+s.length).trim();return new js(a,s,o)}static _BuildSubExpression(t){t=t.replace(Kn,"defined[$1]");let e=Wi.infixToPostfix(t),i=[];for(let r of e)if(r!=="||"&&r!=="&&")i.push(r);else if(i.length>=2){let a=i[i.length-1],o=i[i.length-2];i.length-=2;let h=r=="&&"?new Ys:new Ks;typeof a=="string"&&(a=a.replace(Os,"defined($1)")),typeof o=="string"&&(o=o.replace(Os,"defined($1)")),h.leftOperand=typeof o=="string"?this._ExtractOperation(o):o,h.rightOperand=typeof a=="string"?this._ExtractOperation(a):a,i.push(h)}let s=i[i.length-1];return typeof s=="string"&&(s=s.replace(Os,"defined($1)")),typeof s=="string"?this._ExtractOperation(s):s}static _BuildExpression(t,e){let i=new Hs,s=t.substring(0,e),r=t.substring(e);return r=r.substring(0,(r.indexOf("//")+1||r.length+1)-1).trim(),s==="#ifdef"?i.testExpression=new ri(r):s==="#ifndef"?i.testExpression=new ri(r,!0):i.testExpression=this._BuildSubExpression(r),i}static _MoveCursorWithinIf(t,e,i){let s=t.currentLine;for(;this._MoveCursor(t,i);){s=t.currentLine;let r=s.substring(0,5).toLowerCase();if(r==="#else"){let a=new jt;e.children.push(a),this._MoveCursor(t,a);return}else if(r==="#elif"){let a=this._BuildExpression(s,5);e.children.push(a),i=a}}}static _MoveCursor(t,e){for(;t.canRead;){t.lineIndex++;let i=t.currentLine,s=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/.exec(i);if(s&&s.length)switch(s[0]){case"#ifdef":{let r=new Ai;e.children.push(r);let a=this._BuildExpression(i,6);r.children.push(a),this._MoveCursorWithinIf(t,r,a);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{let r=new Ai;e.children.push(r);let a=this._BuildExpression(i,7);r.children.push(a),this._MoveCursorWithinIf(t,r,a);break}case"#if":{let r=new Ai,a=this._BuildExpression(i,3);e.children.push(r),r.children.push(a),this._MoveCursorWithinIf(t,r,a);break}}else{let r=new jt;if(r.line=i,e.children.push(r),i[0]==="#"&&i[1]==="d"){let a=i.replace(";","").split(" ");r.additionalDefineKey=a[1],a.length===3&&(r.additionalDefineValue=a[2])}}}return!1}static _EvaluatePreProcessors(t,e,i){let s=new jt,r=new Xs;return r.lineIndex=-1,r.lines=t.split(`
`),this._MoveCursor(r,s),s.process(e,i)}static _PreparePreProcessors(t,e){var i;let s=t.defines,r={};for(let a of s){let o=a.replace("#define","").replace(";","").trim().split(" ");r[o[0]]=o.length>1?o[1]:""}return((i=t.processor)===null||i===void 0?void 0:i.shaderLanguage)===Fe.GLSL&&(r.GL_ES="true"),r.__VERSION__=t.version,r[t.platformName]="true",e._getGlobalDefines(r),r}static _ProcessShaderConversion(t,e,i){let s=this._ProcessPrecision(t,e);if(!e.processor||e.processor.shaderLanguage===Fe.GLSL&&s.indexOf("#version 3")!==-1&&(s=s.replace("#version 300 es",""),!e.processor.parseGLES3))return s;let r=e.defines,a=this._PreparePreProcessors(e,i);return e.processor.preProcessor&&(s=e.processor.preProcessor(s,r,e.isFragment,e.processingContext)),s=this._EvaluatePreProcessors(s,a,e),e.processor.postProcessor&&(s=e.processor.postProcessor(s,r,e.isFragment,e.processingContext,i)),i._features.needShaderCodeInlining&&(s=i.inlineShaderCode(s)),s}static _ApplyPreProcessing(t,e,i){var s,r;let a=t,o=e.defines,h=this._PreparePreProcessors(e,i);return!((s=e.processor)===null||s===void 0)&&s.preProcessor&&(a=e.processor.preProcessor(a,o,e.isFragment,e.processingContext)),a=this._EvaluatePreProcessors(a,h,e),!((r=e.processor)===null||r===void 0)&&r.postProcessor&&(a=e.processor.postProcessor(a,o,e.isFragment,e.processingContext,i)),i._features.needShaderCodeInlining&&(a=i.inlineShaderCode(a)),a}static _ProcessIncludes(t,e,i){let s=en.exec(t),r=new String(t),a=!1;for(;s!=null;){let o=s[1];if(o.indexOf("__decl__")!==-1&&(o=o.replace(/__decl__/,""),e.supportsUniformBuffers&&(o=o.replace(/Vertex/,"Ubo"),o=o.replace(/Fragment/,"Ubo")),o=o+"Declaration"),e.includesShadersStore[o]){let h=e.includesShadersStore[o];if(s[2]){let l=s[3].split(",");for(let c=0;c<l.length;c+=2){let d=new RegExp(l[c],"g"),u=l[c+1];h=h.replace(d,u)}}if(s[4]){let l=s[5];if(l.indexOf("..")!==-1){let c=l.split(".."),d=parseInt(c[0]),u=parseInt(c[1]),f=h.slice(0);h="",isNaN(u)&&(u=e.indexParameters[c[1]]);for(let _=d;_<u;_++)e.supportsUniformBuffers||(f=f.replace(/light\{X\}.(\w*)/g,(g,p)=>p+"{X}")),h+=f.replace(/\{X\}/g,_.toString())+`
`}else e.supportsUniformBuffers||(h=h.replace(/light\{X\}.(\w*)/g,(c,d)=>d+"{X}")),h=h.replace(/\{X\}/g,l)}r=r.replace(s[0],h),a=a||h.indexOf("#include<")>=0||h.indexOf("#include <")>=0}else{let h=e.shadersRepository+"ShadersInclude/"+o+".fx";n._FileToolsLoadFile(h,l=>{e.includesShadersStore[o]=l,this._ProcessIncludes(r,e,i)});return}s=en.exec(t)}a?this._ProcessIncludes(r.toString(),e,i):i(r)}static _FileToolsLoadFile(t,e,i,s,r,a){throw H("FileTools")}},w=(()=>{class n{static GetShadersRepository(e=Fe.GLSL){return e===Fe.GLSL?n.ShadersRepository:n.ShadersRepositoryWGSL}static GetShadersStore(e=Fe.GLSL){return e===Fe.GLSL?n.ShadersStore:n.ShadersStoreWGSL}static GetIncludesShadersStore(e=Fe.GLSL){return e===Fe.GLSL?n.IncludesShadersStore:n.IncludesShadersStoreWGSL}}return n.ShadersRepository="src/Shaders/",n.ShadersStore={},n.IncludesShadersStore={},n.ShadersRepositoryWGSL="src/ShadersWGSL/",n.ShadersStoreWGSL={},n.IncludesShadersStoreWGSL={},n})(),Re=class n{constructor(t,e,i,s=null,r,a=null,o=null,h=null,l=null,c,d="",u=Fe.GLSL){var f,_,g;this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new D,this.onErrorObservable=new D,this._onBindObservable=null,this._wasPreviouslyReady=!1,this._forceRebindOnNextCall=!1,this._wasPreviouslyUsingInstances=null,this._isDisposed=!1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._vertexSourceCodeBeforeMigration="",this._fragmentSourceCodeBeforeMigration="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this.name=t,this._key=d;let p,E=null;if(e.attributes){let I=e;if(this._engine=i,this._attributesNames=I.attributes,this._uniformsNames=I.uniformsNames.concat(I.samplers),this._samplerList=I.samplers.slice(),this.defines=I.defines,this.onError=I.onError,this.onCompiled=I.onCompiled,this._fallbacks=I.fallbacks,this._indexParameters=I.indexParameters,this._transformFeedbackVaryings=I.transformFeedbackVaryings||null,this._multiTarget=!!I.multiTarget,this._shaderLanguage=(f=I.shaderLanguage)!==null&&f!==void 0?f:Fe.GLSL,I.uniformBuffersNames){this._uniformBuffersNamesList=I.uniformBuffersNames.slice();for(let N=0;N<I.uniformBuffersNames.length;N++)this._uniformBuffersNames[I.uniformBuffersNames[N]]=N}E=(_=I.processFinalCode)!==null&&_!==void 0?_:null,p=(g=I.processCodeAfterIncludes)!==null&&g!==void 0?g:void 0}else this._engine=r,this.defines=a??"",this._uniformsNames=i.concat(s),this._samplerList=s?s.slice():[],this._attributesNames=e,this._uniformBuffersNamesList=[],this._shaderLanguage=u,this.onError=l,this.onCompiled=h,this._indexParameters=c,this._fallbacks=o;this._attributeLocationByName={},this.uniqueId=n._UniqueIdSeed++;let T,R,y=Oe()?this._engine.getHostDocument():null;t.vertexSource?T="source:"+t.vertexSource:t.vertexElement?(T=y?y.getElementById(t.vertexElement):null,T||(T=t.vertexElement)):T=t.vertex||t,t.fragmentSource?R="source:"+t.fragmentSource:t.fragmentElement?(R=y?y.getElementById(t.fragmentElement):null,R||(R=t.fragmentElement)):R=t.fragment||t,this._processingContext=this._engine._getShaderProcessingContext(this._shaderLanguage);let M={defines:this.defines.split(`
`),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:w.GetShadersRepository(this._shaderLanguage),includesShadersStore:w.GetIncludesShadersStore(this._shaderLanguage),version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:p},b=[void 0,void 0],x=()=>{if(b[0]&&b[1]){M.isFragment=!0;let[I,N]=b;Yt.Process(N,M,(G,Y)=>{this._fragmentSourceCodeBeforeMigration=Y,E&&(G=E("fragment",G));let q=Yt.Finalize(I,G,M);this._useFinalCode(q.vertexCode,q.fragmentCode,t)},this._engine)}};this._loadShader(T,"Vertex","",I=>{Yt.Initialize(M),Yt.Process(I,M,(N,G)=>{this._rawVertexSourceCode=I,this._vertexSourceCodeBeforeMigration=G,E&&(N=E("vertex",N)),b[0]=N,x()},this._engine)}),this._loadShader(R,"Fragment","Pixel",I=>{this._rawFragmentSourceCode=I,b[1]=I,x()}),M=null;let F=function(I){return function(){return this._pipelineContext&&this._pipelineContext[I].apply(this._pipelineContext,arguments),this}};["Int?","UInt?","IntArray?","UIntArray?","Array?","Color?","Vector?","Float?","Matrices","Matrix","Matrix3x3","Matrix2x2","Quaternion","DirectColor4"].forEach(I=>{let N=`set${I}`;N.endsWith("?")?["",2,3,4].forEach(G=>{this[N.slice(0,-1)+G]=this[N.slice(0,-1)+G]||F(N.slice(0,-1)+G).bind(this)}):this[N]=this[N]||F(N).bind(this)})}static get ShadersRepository(){return w.ShadersRepository}static set ShadersRepository(t){w.ShadersRepository=t}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new D),this._onBindObservable}_useFinalCode(t,e,i){if(i){let s=i.vertexElement||i.vertex||i.spectorName||i,r=i.fragmentElement||i.fragment||i.spectorName||i;this._vertexSourceCode=(this._shaderLanguage===Fe.WGSL?"//":"")+"#define SHADER_NAME vertex:"+s+`
`+t,this._fragmentSourceCode=(this._shaderLanguage===Fe.WGSL?"//":"")+"#define SHADER_NAME fragment:"+r+`
`+e}else this._vertexSourceCode=t,this._fragmentSourceCode=e;this._prepareEffect()}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return this._isReady?!0:this._pipelineContext?this._pipelineContext.isReady:!1}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getAttributesNames(){return this._attributesNames}getAttributeLocation(t){return this._attributes[t]}getAttributeLocationByName(t){return this._attributeLocationByName[t]}getAttributesCount(){return this._attributes.length}getUniformIndex(t){return this._uniformsNames.indexOf(t)}getUniform(t){return this._uniforms[t]}getSamplers(){return this._samplerList}getUniformNames(){return this._uniformsNames}getUniformBuffersNames(){return this._uniformBuffersNamesList}getIndexParameters(){return this._indexParameters}getCompilationError(){return this._compilationError}allFallbacksProcessed(){return this._allFallbacksProcessed}executeWhenCompiled(t){if(this.isReady()){t(this);return}this.onCompileObservable.add(e=>{t(e)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&setTimeout(()=>{this._checkIsReady(null)},16)}_checkIsReady(t){try{if(this._isReadyInternal())return}catch(e){this._processCompilationErrors(e,t);return}this._isDisposed||setTimeout(()=>{this._checkIsReady(t)},16)}_loadShader(t,e,i,s){if(typeof HTMLElement<"u"&&t instanceof HTMLElement){let o=Xr(t);s(o);return}if(t.substr(0,7)==="source:"){s(t.substr(7));return}if(t.substr(0,7)==="base64:"){let o=window.atob(t.substr(7));s(o);return}let r=w.GetShadersStore(this._shaderLanguage);if(r[t+e+"Shader"]){s(r[t+e+"Shader"]);return}if(i&&r[t+i+"Shader"]){s(r[t+i+"Shader"]);return}let a;t[0]==="."||t[0]==="/"||t.indexOf("http")>-1?a=t:a=w.GetShadersRepository(this._shaderLanguage)+t,this._engine._loadFile(a+"."+e.toLowerCase()+".fx",s)}get vertexSourceCode(){var t,e;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:(e=(t=this._pipelineContext)===null||t===void 0?void 0:t._getVertexShaderCode())!==null&&e!==void 0?e:this._vertexSourceCode}get fragmentSourceCode(){var t,e;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:(e=(t=this._pipelineContext)===null||t===void 0?void 0:t._getFragmentShaderCode())!==null&&e!==void 0?e:this._fragmentSourceCode}get vertexSourceCodeBeforeMigration(){return this._vertexSourceCodeBeforeMigration}get fragmentSourceCodeBeforeMigration(){return this._fragmentSourceCodeBeforeMigration}get rawVertexSourceCode(){return this._rawVertexSourceCode}get rawFragmentSourceCode(){return this._rawFragmentSourceCode}_rebuildProgram(t,e,i,s){this._isReady=!1,this._vertexSourceCodeOverride=t,this._fragmentSourceCodeOverride=e,this.onError=(r,a)=>{s&&s(a)},this.onCompiled=()=>{let r=this.getEngine().scenes;if(r)for(let a=0;a<r.length;a++)r[a].markAllMaterialsAsDirty(63);this._pipelineContext._handlesSpectorRebuildCallback(i)},this._fallbacks=null,this._prepareEffect()}_prepareEffect(){let t=this._attributesNames,e=this.defines,i=this._pipelineContext;this._isReady=!1;try{let s=this._engine;this._pipelineContext=s.createPipelineContext(this._processingContext),this._pipelineContext._name=this._key;let r=this._rebuildProgram.bind(this);this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?s._preparePipelineContext(this._pipelineContext,this._vertexSourceCodeOverride,this._fragmentSourceCodeOverride,!0,this._rawVertexSourceCode,this._rawFragmentSourceCode,r,null,this._transformFeedbackVaryings,this._key):s._preparePipelineContext(this._pipelineContext,this._vertexSourceCode,this._fragmentSourceCode,!1,this._rawVertexSourceCode,this._rawFragmentSourceCode,r,e,this._transformFeedbackVaryings,this._key),s._executeWhenRenderingStateIsCompiled(this._pipelineContext,()=>{if(this._attributes=[],this._pipelineContext._fillEffectInformation(this,this._uniformBuffersNames,this._uniformsNames,this._uniforms,this._samplerList,this._samplers,t,this._attributes),t)for(let a=0;a<t.length;a++){let o=t[a];this._attributeLocationByName[o]=this._attributes[a]}s.bindSamplers(this),this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh(),i&&this.getEngine()._deletePipelineContext(i)}),this._pipelineContext.isAsync&&this._checkIsReady(i)}catch(s){this._processCompilationErrors(s,i)}}_getShaderCodeAndErrorLine(t,e,i){let s=i?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/,r=null;if(e&&t){let a=e.match(s);if(a&&a.length===2){let o=parseInt(a[1]),h=t.split(`
`,-1);h.length>=o&&(r=`Offending line [${o}] in ${i?"fragment":"vertex"} code: ${h[o-1]}`)}}return[t,r]}_processCompilationErrors(t,e=null){var i,s,r;this._compilationError=t.message;let a=this._attributesNames,o=this._fallbacks;if(O.Error("Unable to compile effect:"),O.Error("Uniforms: "+this._uniformsNames.map(function(l){return" "+l})),O.Error("Attributes: "+a.map(function(l){return" "+l})),O.Error(`Defines:\r
`+this.defines),n.LogShaderCodeOnCompilationError){let l=null,c=null,d=null;!((i=this._pipelineContext)===null||i===void 0)&&i._getVertexShaderCode()&&([d,l]=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),d&&(O.Error("Vertex code:"),O.Error(d))),!((s=this._pipelineContext)===null||s===void 0)&&s._getFragmentShaderCode()&&([d,c]=this._getShaderCodeAndErrorLine((r=this._pipelineContext)===null||r===void 0?void 0:r._getFragmentShaderCode(),this._compilationError,!0),d&&(O.Error("Fragment code:"),O.Error(d))),l&&O.Error(l),c&&O.Error(c)}O.Error("Error: "+this._compilationError);let h=()=>{this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)};e&&(this._pipelineContext=e,this._isReady=!0,h()),o?(this._pipelineContext=null,o.hasMoreFallbacks?(this._allFallbacksProcessed=!1,O.Error("Trying next fallback."),this.defines=o.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,h(),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):(this._allFallbacksProcessed=!0,e||h())}get isSupported(){return this._compilationError===""}_bindTexture(t,e){this._engine._bindTexture(this._samplers[t],e,t)}setTexture(t,e){this._engine.setTexture(this._samplers[t],this._uniforms[t],e,t)}setDepthStencilTexture(t,e){this._engine.setDepthStencilTexture(this._samplers[t],this._uniforms[t],e,t)}setTextureArray(t,e){let i=t+"Ex";if(this._samplerList.indexOf(i+"0")===-1){let s=this._samplerList.indexOf(t);for(let a=1;a<e.length;a++){let o=i+(a-1).toString();this._samplerList.splice(s+a,0,o)}let r=0;for(let a of this._samplerList)this._samplers[a]=r,r+=1}this._engine.setTextureArray(this._samplers[t],this._uniforms[t],e,t)}setTextureFromPostProcess(t,e){this._engine.setTextureFromPostProcess(this._samplers[t],e,t)}setTextureFromPostProcessOutput(t,e){this._engine.setTextureFromPostProcessOutput(this._samplers[t],e,t)}bindUniformBuffer(t,e){let i=this._uniformBuffersNames[e];i===void 0||n._BaseCache[i]===t&&this._engine._features.useUBOBindingCache||(n._BaseCache[i]=t,this._engine.bindUniformBufferBase(t,i,e))}bindUniformBlock(t,e){this._engine.bindUniformBlock(this._pipelineContext,t,e)}setFloatArray(t,e){return this._pipelineContext.setArray(t,e),this}setFloatArray2(t,e){return this._pipelineContext.setArray2(t,e),this}setFloatArray3(t,e){return this._pipelineContext.setArray3(t,e),this}setFloatArray4(t,e){return this._pipelineContext.setArray4(t,e),this}setBool(t,e){return this._pipelineContext.setInt(t,e?1:0),this}dispose(){var t;(t=this._pipelineContext)===null||t===void 0||t.dispose(),this._engine._releaseEffect(this),this._isDisposed=!0}static RegisterShader(t,e,i,s=Fe.GLSL){e&&(w.GetShadersStore(s)[`${t}PixelShader`]=e),i&&(w.GetShadersStore(s)[`${t}VertexShader`]=i)}static ResetCache(){n._BaseCache={}}};Re.LogShaderCodeOnCompilationError=!0;Re._UniqueIdSeed=0;Re._BaseCache={};Re.ShadersStore=w.ShadersStore;Re.IncludesShadersStore=w.IncludesShadersStore;var qs=class{constructor(t=!0){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,t&&this.reset()}get isDirty(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty}get zOffset(){return this._zOffset}set zOffset(t){this._zOffset!==t&&(this._zOffset=t,this._isZOffsetDirty=!0)}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(t){this._zOffsetUnits!==t&&(this._zOffsetUnits=t,this._isZOffsetDirty=!0)}get cullFace(){return this._cullFace}set cullFace(t){this._cullFace!==t&&(this._cullFace=t,this._isCullFaceDirty=!0)}get cull(){return this._cull}set cull(t){this._cull!==t&&(this._cull=t,this._isCullDirty=!0)}get depthFunc(){return this._depthFunc}set depthFunc(t){this._depthFunc!==t&&(this._depthFunc=t,this._isDepthFuncDirty=!0)}get depthMask(){return this._depthMask}set depthMask(t){this._depthMask!==t&&(this._depthMask=t,this._isDepthMaskDirty=!0)}get depthTest(){return this._depthTest}set depthTest(t){this._depthTest!==t&&(this._depthTest=t,this._isDepthTestDirty=!0)}get frontFace(){return this._frontFace}set frontFace(t){this._frontFace!==t&&(this._frontFace=t,this._isFrontFaceDirty=!0)}reset(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1}apply(t){this.isDirty&&(this._isCullDirty&&(this.cull?t.enable(t.CULL_FACE):t.disable(t.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(t.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(t.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(t.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(t.enable(t.POLYGON_OFFSET_FILL),t.polygonOffset(this.zOffset,this.zOffsetUnits)):t.disable(t.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(t.frontFace(this.frontFace),this._isFrontFaceDirty=!1))}},Yn=(()=>{class n{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=n.ALWAYS,this.funcRef=1,this.funcMask=255,this.opStencilFail=n.KEEP,this.opDepthFail=n.KEEP,this.opStencilDepthPass=n.REPLACE}get stencilFunc(){return this.func}set stencilFunc(e){this.func=e}get stencilFuncRef(){return this.funcRef}set stencilFuncRef(e){this.funcRef=e}get stencilFuncMask(){return this.funcMask}set stencilFuncMask(e){this.funcMask=e}get stencilOpStencilFail(){return this.opStencilFail}set stencilOpStencilFail(e){this.opStencilFail=e}get stencilOpDepthFail(){return this.opDepthFail}set stencilOpDepthFail(e){this.opDepthFail=e}get stencilOpStencilDepthPass(){return this.opStencilDepthPass}set stencilOpStencilDepthPass(e){this.opStencilDepthPass=e}get stencilMask(){return this.mask}set stencilMask(e){this.mask=e}get stencilTest(){return this.enabled}set stencilTest(e){this.enabled=e}}return n.ALWAYS=519,n.KEEP=7680,n.REPLACE=7681,n})(),Zs=class{constructor(){this._blendFunctionParameters=new Array(4),this._blendEquationParameters=new Array(2),this._blendConstants=new Array(4),this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}get isDirty(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty}get alphaBlend(){return this._alphaBlend}set alphaBlend(t){this._alphaBlend!==t&&(this._alphaBlend=t,this._isAlphaBlendDirty=!0)}setAlphaBlendConstants(t,e,i,s){this._blendConstants[0]===t&&this._blendConstants[1]===e&&this._blendConstants[2]===i&&this._blendConstants[3]===s||(this._blendConstants[0]=t,this._blendConstants[1]=e,this._blendConstants[2]=i,this._blendConstants[3]=s,this._isBlendConstantsDirty=!0)}setAlphaBlendFunctionParameters(t,e,i,s){this._blendFunctionParameters[0]===t&&this._blendFunctionParameters[1]===e&&this._blendFunctionParameters[2]===i&&this._blendFunctionParameters[3]===s||(this._blendFunctionParameters[0]=t,this._blendFunctionParameters[1]=e,this._blendFunctionParameters[2]=i,this._blendFunctionParameters[3]=s,this._isBlendFunctionParametersDirty=!0)}setAlphaEquationParameters(t,e){this._blendEquationParameters[0]===t&&this._blendEquationParameters[1]===e||(this._blendEquationParameters[0]=t,this._blendEquationParameters[1]=e,this._isBlendEquationParametersDirty=!0)}reset(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1}apply(t){this.isDirty&&(this._isAlphaBlendDirty&&(this._alphaBlend?t.enable(t.BLEND):t.disable(t.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(t.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(t.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(t.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))}},Qs=class{constructor(){this.shaderLanguage=Fe.GLSL}postProcessor(t,e,i,s,r){if(!r.getCaps().drawBuffersExtension){let a=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;t=t.replace(a,"")}return t}},$s=class{constructor(){this.shaderLanguage=Fe.GLSL}attributeProcessor(t){return t.replace("attribute","in")}varyingProcessor(t,e){return t.replace("varying",e?"in":"out")}postProcessor(t,e,i){let s=t.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,r=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(t=t.replace(r,""),t=t.replace(/texture2D\s*\(/g,"texture("),i)t=t.replace(/texture2DLodEXT\s*\(/g,"textureLod("),t=t.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),t=t.replace(/textureCube\s*\(/g,"texture("),t=t.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),t=t.replace(/gl_FragColor/g,"glFragColor"),t=t.replace(/gl_FragData/g,"glFragData"),t=t.replace(/void\s+?main\s*\(/g,(s?"":`layout(location = 0) out vec4 glFragColor;
`)+"void main(");else if(e.indexOf("#define MULTIVIEW")!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+t;return t}},Sn=(()=>{class n{constructor(){this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=n._Counter++}get underlyingResource(){return null}}return n._Counter=0,n})(),Qt=class extends Sn{constructor(t){super(),this._buffer=t}get underlyingResource(){return this._buffer}},jn=["Int","Int2","Int3","Int4","UInt","UInt2","UInt3","UInt4","Vector2","Vector3","Vector4","Float2","Float","Float3","Float4","Quaternion","Color3","Color4","DirectColor4"],Js=class{constructor(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null;let t=[],e=function(){t.length=0,Array.prototype.push.apply(t,arguments),t[0]=this._uniforms[t[0]]},i=s=>{let r=jn.includes(s.substring(3))&&"FloatN";if(r){let a=this[`_cache${r}`];return function(){let o=this.engine[s];e.apply(this,arguments),a.apply(this,arguments)&&(o.apply(this.engine,t)||(this._valueCache[arguments[0]]=null))}}else return function(){let a=this.engine[s];e.apply(this,arguments),arguments[1]!==void 0&&(this._valueCache[arguments[0]]=null,a.apply(this.engine,t))}};["Int?","UInt?","IntArray?","UIntArray?","Array?","Float?","Matrices","Matrix3x3","Matrix2x2"].forEach(s=>{let r=`set${s}`;this[r]||(r.endsWith("?")?["",2,3,4].forEach(a=>{this[r.slice(0,-1)+a]=this[r.slice(0,-1)+a]||i(r.slice(0,-1)+a).bind(this)}):this[r]=this[r]||i(r).bind(this))})}get isAsync(){return this.isParallelCompiled}get isReady(){return this.program?this.isParallelCompiled?this.engine._isRenderingStateCompiled(this):!0:!1}_handlesSpectorRebuildCallback(t){t&&this.program&&t(this.program)}_fillEffectInformation(t,e,i,s,r,a,o,h){let l=this.engine;if(l.supportsUniformBuffers)for(let d in e)t.bindUniformBlock(d,e[d]);this.engine.getUniforms(this,i).forEach((d,u)=>{s[i[u]]=d}),this._uniforms=s;let c;for(c=0;c<r.length;c++)t.getUniform(r[c])==null&&(r.splice(c,1),c--);r.forEach((d,u)=>{a[d]=u});for(let d of l.getAttributes(this,o))h.push(d)}dispose(){this._uniforms={}}_cacheMatrix(t,e){let i=this._valueCache[t],s=e.updateFlag;return i!==void 0&&i===s?!1:(this._valueCache[t]=s,!0)}_cacheFloatN(t,e,i,s,r){let a=this._valueCache[arguments[0]];if(!a||a.length!==arguments.length-1)return a=Array.prototype.slice.call(arguments,1),this._valueCache[arguments[0]]=a,!0;let o=!1;for(let h=0;h<a.length;++h)a[h]!==arguments[h+1]&&(a[h]=arguments[h+1],o=!0);return o}_cacheFloat2(t,e,i){return this._cacheFloatN(t,e,i)}_cacheFloat3(t,e,i,s){return this._cacheFloatN(t,e,i,s)}_cacheFloat4(t,e,i,s,r){return this._cacheFloatN(t,e,i,s,r)}setMatrix(t,e){this._cacheMatrix(t,e)&&(this.engine.setMatrices(this._uniforms[t],e.toArray())||(this._valueCache[t]=null))}setVector2(t,e){this.setFloat2(t,e.x,e.y)}setVector3(t,e){this.setFloat3(t,e.x,e.y,e.z)}setVector4(t,e){this.setFloat4(t,e.x,e.y,e.z,e.w)}setQuaternion(t,e){this.setFloat4(t,e.x,e.y,e.z,e.w)}setColor3(t,e){this.setFloat3(t,e.r,e.g,e.b)}setColor4(t,e,i){this.setFloat4(t,e.r,e.g,e.b,i)}setDirectColor4(t,e){this.setFloat4(t,e.r,e.g,e.b,e.a)}_getVertexShaderCode(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null}_getFragmentShaderCode(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null}},ss=class{constructor(t=null,e){if(this._MSAARenderBuffer=null,this._context=e,!t&&(t=e.createTexture(),!t))throw new Error("Unable to create webGL texture");this.set(t)}get underlyingResource(){return this._webGLTexture}setUsage(){}set(t){this._webGLTexture=t}reset(){this._webGLTexture=null,this._MSAARenderBuffer=null}release(){this._MSAARenderBuffer&&(this._context.deleteRenderbuffer(this._MSAARenderBuffer),this._MSAARenderBuffer=null),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}},Wt=class{constructor(t,e=!0){this.effect=null,this.defines=null,this.drawContext=t.createDrawContext(),e&&(this.materialContext=t.createMaterialContext())}static IsWrapper(t){return t.getPipelineContext===void 0}static GetEffect(t){return t.getPipelineContext===void 0?t.effect:t}setEffect(t,e,i=!0){var s;this.effect=t,e!==void 0&&(this.defines=e),i&&((s=this.drawContext)===null||s===void 0||s.reset())}dispose(){var t;(t=this.drawContext)===null||t===void 0||t.dispose()}},er=class{constructor(t=!0){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,t&&this.reset()}get isDirty(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty}get func(){return this._func}set func(t){this._func!==t&&(this._func=t,this._isStencilFuncDirty=!0)}get funcRef(){return this._funcRef}set funcRef(t){this._funcRef!==t&&(this._funcRef=t,this._isStencilFuncDirty=!0)}get funcMask(){return this._funcMask}set funcMask(t){this._funcMask!==t&&(this._funcMask=t,this._isStencilFuncDirty=!0)}get opStencilFail(){return this._opStencilFail}set opStencilFail(t){this._opStencilFail!==t&&(this._opStencilFail=t,this._isStencilOpDirty=!0)}get opDepthFail(){return this._opDepthFail}set opDepthFail(t){this._opDepthFail!==t&&(this._opDepthFail=t,this._isStencilOpDirty=!0)}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(t){this._opStencilDepthPass!==t&&(this._opStencilDepthPass=t,this._isStencilOpDirty=!0)}get mask(){return this._mask}set mask(t){this._mask!==t&&(this._mask=t,this._isStencilMaskDirty=!0)}get enabled(){return this._enabled}set enabled(t){this._enabled!==t&&(this._enabled=t,this._isStencilTestDirty=!0)}reset(){var t;this.stencilMaterial=void 0,(t=this.stencilGlobal)===null||t===void 0||t.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0}apply(t){var e;if(!t)return;let i=!this.useStencilGlobalOnly&&!!(!((e=this.stencilMaterial)===null||e===void 0)&&e.enabled);this.enabled=i?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=i?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=i?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=i?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=i?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=i?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=i?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=i?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(t.stencilMask(this.mask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(t.stencilFunc(this.func,this.funcRef,this.funcMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(t.stencilOp(this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),this._isStencilOpDirty=!1))}},Pt=class{static get Now(){return zs.IsWindowObjectExist()&&window.performance&&window.performance.now?window.performance.now():Date.now()}},tr=class{},le=(()=>{class n{constructor(e,i,s,r){this._name="WebGL",this.forcePOTTextures=!1,this.isFullscreen=!1,this.cullBackFaces=null,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this.validateShaderPrograms=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this.disableUniformBuffers=!1,this.onDisposeObservable=new D,this._frameId=0,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._webGLVersion=1,this._windowIsBackground=!1,this._highPrecisionShadersAllowed=!0,this._badOS=!1,this._badDesktopOS=!1,this._renderingQueueLaunched=!1,this._activeRenderLoops=new Array,this.onContextLostObservable=new D,this.onContextRestoredObservable=new D,this._contextWasLost=!1,this._doNotHandleContextLost=!1,this.disableVertexArrayObjects=!1,this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new qs,this._stencilStateComposer=new er,this._stencilState=new Yn,this._alphaState=new Zs,this._alphaMode=1,this._alphaEquation=0,this._internalTexturesCache=new Array,this._renderTargetWrapperCache=new Array,this._activeChannel=0,this._currentTextureChannel=-1,this._boundTexturesCache={},this._compiledEffects={},this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._activeRequests=new Array,this.adaptToDeviceRatio=!1,this._lastDevicePixelRatio=1,this._transformTextureUrl=null,this.hostInformation={isMobile:!1},this.premultipliedAlpha=!0,this.onBeforeTextureInitObservable=new D,this._isWebGPU=!1,this._snapshotRenderingMode=0,this._useExactSrgbConversions=!1,this._viewportCached={x:0,y:0,z:0,w:0},this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},this.startTime=Pt.Now;let a=null;if(s=s||{},this._creationOptions=s,this.adaptToDeviceRatio=r??!1,this._stencilStateComposer.stencilGlobal=this._stencilState,Je.SetMatrixPrecision(!!s.useHighPrecisionMatrix),!e)return;if(r=r||s.adaptToDeviceRatio||!1,e.getContext){if(a=e,this._renderingCanvas=a,i!==void 0&&(s.antialias=i),s.deterministicLockstep===void 0&&(s.deterministicLockstep=!1),s.lockstepMaxSteps===void 0&&(s.lockstepMaxSteps=4),s.timeStep===void 0&&(s.timeStep=1/60),s.preserveDrawingBuffer===void 0&&(s.preserveDrawingBuffer=!1),s.audioEngine===void 0&&(s.audioEngine=!0),s.audioEngineOptions!==void 0&&s.audioEngineOptions.audioContext!==void 0&&(this._audioContext=s.audioEngineOptions.audioContext),s.audioEngineOptions!==void 0&&s.audioEngineOptions.audioDestination!==void 0&&(this._audioDestination=s.audioEngineOptions.audioDestination),s.stencil===void 0&&(s.stencil=!0),s.premultipliedAlpha===!1&&(this.premultipliedAlpha=!1),s.xrCompatible===void 0&&(s.xrCompatible=!0),s.useExactSrgbConversions!==void 0&&(this._useExactSrgbConversions=s.useExactSrgbConversions),this._doNotHandleContextLost=!!s.doNotHandleContextLost,navigator&&navigator.userAgent){this._checkForMobile=()=>{let d=navigator.userAgent;this.hostInformation.isMobile=d.indexOf("Mobile")!==-1||d.indexOf("Mac")!==-1&&Di()&&"ontouchend"in document},this._checkForMobile(),Oe()&&window.addEventListener("resize",this._checkForMobile);let c=navigator.userAgent;for(let d of n.ExceptionList){let u=d.key,f=d.targets;if(new RegExp(u).test(c)){if(d.capture&&d.captureConstraint){let _=d.capture,g=d.captureConstraint,p=new RegExp(_).exec(c);if(p&&p.length>0&&parseInt(p[p.length-1])>=g)continue}for(let _ of f)switch(_){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":s.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1;break}}}}if(this._doNotHandleContextLost||(this._onContextLost=c=>{c.preventDefault(),this._contextWasLost=!0,O.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost(this._initGLContext.bind(this))},a.addEventListener("webglcontextlost",this._onContextLost,!1),a.addEventListener("webglcontextrestored",this._onContextRestored,!1),s.powerPreference="high-performance"),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this._badDesktopOS&&(s.xrCompatible=!1),!s.disableWebGL2Support)try{this._gl=a.getContext("webgl2",s)||a.getContext("experimental-webgl2",s),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch{}if(!this._gl){if(!a)throw new Error("The provided canvas is null or undefined.");try{this._gl=a.getContext("webgl",s)||a.getContext("experimental-webgl",s)}catch{throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=e,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";let c=this._gl.getContextAttributes();c&&(s.stencil=c.stencil)}this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),s.useHighPrecisionFloats!==void 0&&(this._highPrecisionShadersAllowed=s.useHighPrecisionFloats);let o=Oe()&&window.devicePixelRatio||1,h=s.limitDeviceRatio||o;this._hardwareScalingLevel=r?1/Math.min(h,o):1,this._lastDevicePixelRatio=o,this.resize(),this._isStencilEnable=!!s.stencil,this._initGLContext(),this._initFeatures();for(let c=0;c<this._caps.maxVertexAttribs;c++)this._currentBufferPointers[c]=new tr;this._shaderProcessor=this.webGLVersion>1?new $s:new Qs,this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent);let l=`Babylon.js v${n.Version}`;console.log(l+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",l)}static get NpmPackage(){return"babylonjs@5.43.0"}static get Version(){return"5.43.0"}get description(){let e=this.name+this.webGLVersion;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e}get name(){return this._name}set name(e){this._name=e}get version(){return this._webGLVersion}static get ShadersRepository(){return Re.ShadersRepository}static set ShadersRepository(e){Re.ShadersRepository=e}_getShaderProcessor(e){return this._shaderProcessor}get useReverseDepthBuffer(){return this._useReverseDepthBuffer}set useReverseDepthBuffer(e){e!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=e,e?this._depthCullingState.depthFunc=518:this._depthCullingState.depthFunc=515)}get frameId(){return this._frameId}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}getCreationOptions(){return this._creationOptions}get _shouldUseHighPrecisionShader(){return!!(this._caps.highPrecisionShaderSupported&&this._highPrecisionShadersAllowed)}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get activeRenderLoops(){return this._activeRenderLoops}get doNotHandleContextLost(){return this._doNotHandleContextLost}set doNotHandleContextLost(e){this._doNotHandleContextLost=e}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e}get currentViewport(){return this._cachedViewport}get emptyTexture(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture}get emptyTexture3D(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D}get emptyTexture2DArray(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray}get emptyCubeTexture(){if(!this._emptyCubeTexture){let e=new Uint8Array(4),i=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(i,1,5,0,!1,!1,1)}return this._emptyCubeTexture}get isWebGPU(){return this._isWebGPU}get shaderPlatformName(){return this._shaderPlatformName}get snapshotRendering(){return!1}set snapshotRendering(e){}get snapshotRenderingMode(){return this._snapshotRenderingMode}set snapshotRenderingMode(e){this._snapshotRenderingMode=e}get useExactSrgbConversions(){return this._useExactSrgbConversions}snapshotRenderingReset(){this.snapshotRendering=!1}static _CreateCanvas(e,i){if(typeof document>"u")return new OffscreenCanvas(e,i);let s=document.createElement("canvas");return s.width=e,s.height=i,s}createCanvas(e,i){return n._CreateCanvas(e,i)}createCanvasImage(){return document.createElement("img")}_restoreEngineAfterContextLost(e){setTimeout(()=>Ne(this,null,function*(){var i;this._dummyFramebuffer=null;let s=this._depthCullingState.depthTest,r=this._depthCullingState.depthFunc,a=this._depthCullingState.depthMask,o=this._stencilState.stencilTest;yield e(),this.wipeCaches(!0),this._rebuildEffects(),(i=this._rebuildComputeEffects)===null||i===void 0||i.call(this),this._rebuildBuffers(),this._rebuildInternalTextures(),this._rebuildRenderTargetWrappers(),this.wipeCaches(!0),this._depthCullingState.depthTest=s,this._depthCullingState.depthFunc=r,this._depthCullingState.depthMask=a,this._stencilState.stencilTest=o,O.Warn(this.name+" context successfully restored."),this.onContextRestoredObservable.notifyObservers(this),this._contextWasLost=!1}),0)}_sharedInit(e,i,s){this._renderingCanvas=e}_getShaderProcessingContext(e){return null}_rebuildInternalTextures(){let e=this._internalTexturesCache.slice();for(let i of e)i._rebuild()}_rebuildRenderTargetWrappers(){let e=this._renderTargetWrapperCache.slice();for(let i of e)i._rebuild()}_rebuildEffects(){for(let e in this._compiledEffects){let i=this._compiledEffects[e];i._pipelineContext=null,i._wasPreviouslyReady=!1,i._prepareEffect()}Re.ResetCache()}areAllEffectsReady(){for(let e in this._compiledEffects)if(!this._compiledEffects[e].isReady())return!1;return!0}_rebuildBuffers(){for(let e of this._uniformBuffers)e._rebuild();for(let e of this._storageBuffers)e._rebuild()}_initGLContext(){var e;this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||this._gl.getExtension("OES_standard_derivatives")!==null,maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||this._gl.getExtension("OES_element_index_uint")!==null,fragmentDepthSupported:this._webGLVersion>1||this._gl.getExtension("EXT_frag_depth")!==null,highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?256:128},this._glVersion=this._gl.getParameter(this._gl.VERSION);let i=this._gl.getExtension("WEBGL_debug_renderer_info");if(i!=null&&(this._glRenderer=this._gl.getParameter(i.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(i.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),this._gl.HALF_FLOAT_OES!==36193&&(this._gl.HALF_FLOAT_OES=36193),this._gl.RGBA16F!==34842&&(this._gl.RGBA16F=34842),this._gl.RGBA32F!==34836&&(this._gl.RGBA32F=34836),this._gl.DEPTH24_STENCIL8!==35056&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(this._webGLVersion===1&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=((e=this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT))!==null&&e!==void 0?e:0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!!(this._caps.textureFloat&&this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!!(this._caps.textureFloat&&this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&this._gl.HALF_FLOAT_OES!==5131&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=this._maxMSAASamplesOverride!==null?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES);else{let s=this._gl.getExtension("WEBGL_draw_buffers");if(s!==null){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=s.drawBuffersWEBGL.bind(s),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let r=0;r<16;r++)this._gl["COLOR_ATTACHMENT"+r+"_WEBGL"]=s["COLOR_ATTACHMENT"+r+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{let s=this._gl.getExtension("WEBGL_depth_texture");s!=null&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=s.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{let s=this._gl.getExtension("OES_vertex_array_object");s!=null&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=s.createVertexArrayOES.bind(s),this._gl.bindVertexArray=s.bindVertexArrayOES.bind(s),this._gl.deleteVertexArray=s.deleteVertexArrayOES.bind(s))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{let s=this._gl.getExtension("ANGLE_instanced_arrays");s!=null?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=s.drawArraysInstancedANGLE.bind(s),this._gl.drawElementsInstanced=s.drawElementsInstancedANGLE.bind(s),this._gl.vertexAttribDivisor=s.vertexAttribDivisorANGLE.bind(s)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){let s=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),r=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);s&&r&&(this._caps.highPrecisionShaderSupported=s.precision!==0&&r.precision!==0)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{let s=this._gl.getExtension("EXT_blend_minmax");s!=null&&(this._caps.blendMinMax=!0,this._gl.MAX=s.MAX_EXT,this._gl.MIN=s.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0;else{let s=this._gl.getExtension("EXT_sRGB");s!=null&&(this._caps.supportSRGBBuffers=!0,this._gl.SRGB=s.SRGB_EXT,this._gl.SRGB8=s.SRGB_ALPHA_EXT,this._gl.SRGB8_ALPHA8=s.SRGB_ALPHA_EXT)}this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&!!(this._creationOptions&&this._creationOptions.forceSRGBBufferSupportState)}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let s=0;s<this._maxSimultaneousTextures;s++)this._nextFreeTextureSlots.push(s)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:this._webGLVersion!==1,supportDepthStencilTexture:this._webGLVersion!==1,supportShadowSamplers:this._webGLVersion!==1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:this._webGLVersion!==1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:this._webGLVersion!==1,basisNeedsPOT:this._webGLVersion===1,support3DTextures:this._webGLVersion!==1,needTypeSuffixInShaderConstants:this._webGLVersion!==1,supportMSAA:this._webGLVersion!==1,supportSSAO2:this._webGLVersion!==1,supportExtendedTextureFormats:this._webGLVersion!==1,supportSwitchCaseInShader:this._webGLVersion!==1,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}get isStencilEnable(){return this._isStencilEnable}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);let e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}resetTextureCache(){for(let e in this._boundTexturesCache)Object.prototype.hasOwnProperty.call(this._boundTexturesCache,e)&&(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}setHardwareScalingLevel(e){this._hardwareScalingLevel=e,this.resize()}getHardwareScalingLevel(){return this._hardwareScalingLevel}getLoadedTexturesCache(){return this._internalTexturesCache}getCaps(){return this._caps}stopRenderLoop(e){if(!e){this._activeRenderLoops=[];return}let i=this._activeRenderLoops.indexOf(e);i>=0&&this._activeRenderLoops.splice(i,1)}_renderLoop(){if(!this._contextWasLost){let e=!0;if(!this.renderEvenInBackground&&this._windowIsBackground&&(e=!1),e){this.beginFrame();for(let i=0;i<this._activeRenderLoops.length;i++){let s=this._activeRenderLoops[i];s()}this.endFrame()}}this._activeRenderLoops.length>0?this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}getRenderingCanvas(){return this._renderingCanvas}getAudioContext(){return this._audioContext}getAudioDestination(){return this._audioDestination}getHostWindow(){return Oe()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}_queueNewFrame(e,i){return n.QueueNewFrame(e,i)}runRenderLoop(e){this._activeRenderLoops.indexOf(e)===-1&&(this._activeRenderLoops.push(e),this._renderingQueueLaunched||(this._renderingQueueLaunched=!0,this._boundRenderFunction=this._renderLoop.bind(this),this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))}clear(e,i,s,r=!1){let a=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=a;let o=0;i&&e&&(this._gl.clearColor(e.r,e.g,e.b,e.a!==void 0?e.a:1),o|=this._gl.COLOR_BUFFER_BIT),s&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),o|=this._gl.DEPTH_BUFFER_BIT),r&&(this._gl.clearStencil(0),o|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(o)}_viewport(e,i,s,r){(e!==this._viewportCached.x||i!==this._viewportCached.y||s!==this._viewportCached.z||r!==this._viewportCached.w)&&(this._viewportCached.x=e,this._viewportCached.y=i,this._viewportCached.z=s,this._viewportCached.w=r,this._gl.viewport(e,i,s,r))}setViewport(e,i,s){let r=i||this.getRenderWidth(),a=s||this.getRenderHeight(),o=e.x||0,h=e.y||0;this._cachedViewport=e,this._viewport(o*r,h*a,r*e.width,a*e.height)}beginFrame(){}endFrame(){this._badOS&&this.flushFramebuffer(),this._frameId++}resize(e=!1){let i,s;if(this.adaptToDeviceRatio){let r=Oe()&&window.devicePixelRatio||1,a=this._lastDevicePixelRatio/r;this._lastDevicePixelRatio=r,this._hardwareScalingLevel*=a}Oe()?(i=this._renderingCanvas?this._renderingCanvas.clientWidth||this._renderingCanvas.width:window.innerWidth,s=this._renderingCanvas?this._renderingCanvas.clientHeight||this._renderingCanvas.height:window.innerHeight):(i=this._renderingCanvas?this._renderingCanvas.width:100,s=this._renderingCanvas?this._renderingCanvas.height:100),this.setSize(i/this._hardwareScalingLevel,s/this._hardwareScalingLevel,e)}setSize(e,i,s=!1){return!this._renderingCanvas||(e=e|0,i=i|0,!s&&this._renderingCanvas.width===e&&this._renderingCanvas.height===i)?!1:(this._renderingCanvas.width=e,this._renderingCanvas.height=i,!0)}bindFramebuffer(e,i=0,s,r,a,o=0,h=0){var l,c,d,u,f;let _=e;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(_._MSAAFramebuffer?_._MSAAFramebuffer:_._framebuffer);let g=this._gl;e.is2DArray?g.framebufferTextureLayer(g.FRAMEBUFFER,g.COLOR_ATTACHMENT0,(l=e.texture._hardwareTexture)===null||l===void 0?void 0:l.underlyingResource,o,h):e.isCube&&g.framebufferTexture2D(g.FRAMEBUFFER,g.COLOR_ATTACHMENT0,g.TEXTURE_CUBE_MAP_POSITIVE_X+i,(c=e.texture._hardwareTexture)===null||c===void 0?void 0:c.underlyingResource,o);let p=e._depthStencilTexture;if(p){let E=e._depthStencilTextureWithStencil?g.DEPTH_STENCIL_ATTACHMENT:g.DEPTH_ATTACHMENT;e.is2DArray?g.framebufferTextureLayer(g.FRAMEBUFFER,E,(d=p._hardwareTexture)===null||d===void 0?void 0:d.underlyingResource,o,h):e.isCube?g.framebufferTexture2D(g.FRAMEBUFFER,E,g.TEXTURE_CUBE_MAP_POSITIVE_X+i,(u=p._hardwareTexture)===null||u===void 0?void 0:u.underlyingResource,o):g.framebufferTexture2D(g.FRAMEBUFFER,E,g.TEXTURE_2D,(f=p._hardwareTexture)===null||f===void 0?void 0:f.underlyingResource,o)}this._cachedViewport&&!a?this.setViewport(this._cachedViewport,s,r):(s||(s=e.width,o&&(s=s/Math.pow(2,o))),r||(r=e.height,o&&(r=r/Math.pow(2,o))),this._viewport(0,0,s,r)),this.wipeCaches()}setState(e,i=0,s,r=!1,a,o,h=0){var l,c;(this._depthCullingState.cull!==e||s)&&(this._depthCullingState.cull=e);let d=!((c=(l=this.cullBackFaces)!==null&&l!==void 0?l:a)!==null&&c!==void 0)||c?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==d||s)&&(this._depthCullingState.cullFace=d),this.setZOffset(i),this.setZOffsetUnits(h);let u=r?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==u||s)&&(this._depthCullingState.frontFace=u),this._stencilStateComposer.stencilMaterial=o}getDepthBuffer(){return this._depthCullingState.depthTest}setDepthBuffer(e){this._depthCullingState.depthTest=e}setZOffset(e){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-e:e}getZOffset(){let e=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-e:e}setZOffsetUnits(e){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-e:e}getZOffsetUnits(){let e=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-e:e}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentFramebuffer===null}generateMipmaps(e){this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)}unBindFramebuffer(e,i=!1,s){var r;let a=e;this._currentRenderTarget=null;let o=this._gl;if(a._MSAAFramebuffer){if(e.isMulti){this.unBindMultiColorAttachmentFramebuffer(e,i,s);return}o.bindFramebuffer(o.READ_FRAMEBUFFER,a._MSAAFramebuffer),o.bindFramebuffer(o.DRAW_FRAMEBUFFER,a._framebuffer),o.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,o.COLOR_BUFFER_BIT,o.NEAREST)}!((r=e.texture)===null||r===void 0)&&r.generateMipMaps&&!i&&!e.isCube&&this.generateMipmaps(e.texture),s&&(a._MSAAFramebuffer&&this._bindUnboundFramebuffer(a._framebuffer),s()),this._bindUnboundFramebuffer(null)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(e){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)}_createVertexBuffer(e,i){let s=this._gl.createBuffer();if(!s)throw new Error("Unable to create vertex buffer");let r=new Qt(s);return this.bindArrayBuffer(r),e instanceof Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),i):this._gl.bufferData(this._gl.ARRAY_BUFFER,e,i),this._resetVertexBufferBinding(),r.references=1,r}createDynamicVertexBuffer(e){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(e,i){let s=this._gl.createBuffer(),r=new Qt(s);if(!s)throw new Error("Unable to create index buffer");this.bindIndexBuffer(r);let a=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,a,i?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),r.references=1,r.is32Bits=a.BYTES_PER_ELEMENT===4,r}_normalizeIndexData(e){if(e.BYTES_PER_ELEMENT===2)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(let i=0;i<e.length;i++)if(e[i]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)}bindArrayBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)}bindUniformBlock(e,i,s){let r=e.program,a=this._gl.getUniformBlockIndex(r,i);this._gl.uniformBlockBinding(r,a,s)}bindIndexBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(e,i){(this._vaoRecordInProgress||this._currentBoundBuffer[i]!==e)&&(this._gl.bindBuffer(i,e?e.underlyingResource:null),this._currentBoundBuffer[i]=e)}updateArrayBuffer(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)}_vertexAttribPointer(e,i,s,r,a,o,h){let l=this._currentBufferPointers[i];if(!l)return;let c=!1;l.active?(l.buffer!==e&&(l.buffer=e,c=!0),l.size!==s&&(l.size=s,c=!0),l.type!==r&&(l.type=r,c=!0),l.normalized!==a&&(l.normalized=a,c=!0),l.stride!==o&&(l.stride=o,c=!0),l.offset!==h&&(l.offset=h,c=!0)):(c=!0,l.active=!0,l.index=i,l.size=s,l.type=r,l.normalized=a,l.stride=o,l.offset=h,l.buffer=e),(c||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),r===this._gl.UNSIGNED_INT||r===this._gl.INT?this._gl.vertexAttribIPointer(i,s,r,o,h):this._gl.vertexAttribPointer(i,s,r,a,o,h))}_bindIndexBufferWithCache(e){e!=null&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)}_bindVertexBuffersAttributes(e,i,s){let r=i.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let a=0;a<r.length;a++){let o=i.getAttributeLocation(a);if(o>=0){let h=r[a],l=null;if(s&&(l=s[h]),l||(l=e[h]),!l)continue;this._gl.enableVertexAttribArray(o),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[o]=!0);let c=l.getBuffer();c&&(this._vertexAttribPointer(c,o,l.getSize(),l.type,l.normalized,l.byteStride,l.byteOffset),l.getIsInstanced()&&(this._gl.vertexAttribDivisor(o,l.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(o),this._currentInstanceBuffers.push(c))))}}}recordVertexArrayObject(e,i,s,r){let a=this._gl.createVertexArray();if(!a)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(a),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,s,r),this.bindIndexBuffer(i),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),a}bindVertexArrayObject(e,i){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=i!=null&&i.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(e,i,s,r,a){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==a){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=a;let o=a.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let h=0;for(let l=0;l<o;l++)if(l<s.length){let c=a.getAttributeLocation(l);c>=0&&(this._gl.enableVertexAttribArray(c),this._vertexAttribArraysEnabled[c]=!0,this._vertexAttribPointer(e,c,s[l],this._gl.FLOAT,!1,r,h)),h+=s[l]*4}}this._bindIndexBufferWithCache(i)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(e,i,s,r){(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==s)&&(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=s,this._bindVertexBuffersAttributes(e,s,r)),this._bindIndexBufferWithCache(i)}unbindInstanceAttributes(){let e;for(let i=0,s=this._currentInstanceLocations.length;i<s;i++){let r=this._currentInstanceBuffers[i];e!=r&&r.references&&(e=r,this.bindArrayBuffer(r));let a=this._currentInstanceLocations[i];this._gl.vertexAttribDivisor(a,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(e){this._gl.deleteVertexArray(e)}_releaseBuffer(e){return e.references--,e.references===0?(this._deleteBuffer(e),!0):!1}_deleteBuffer(e){this._gl.deleteBuffer(e.underlyingResource)}updateAndBindInstancesBuffer(e,i,s){if(this.bindArrayBuffer(e),i&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,i),s[0].index!==void 0)this.bindInstancesBuffer(e,s,!0);else for(let r=0;r<4;r++){let a=s[r];this._vertexAttribArraysEnabled[a]||(this._gl.enableVertexAttribArray(a),this._vertexAttribArraysEnabled[a]=!0),this._vertexAttribPointer(e,a,4,this._gl.FLOAT,!1,64,r*16),this._gl.vertexAttribDivisor(a,1),this._currentInstanceLocations.push(a),this._currentInstanceBuffers.push(e)}}bindInstancesBuffer(e,i,s=!0){this.bindArrayBuffer(e);let r=0;if(s)for(let a=0;a<i.length;a++){let o=i[a];r+=o.attributeSize*4}for(let a=0;a<i.length;a++){let o=i[a];o.index===void 0&&(o.index=this._currentEffect.getAttributeLocationByName(o.attributeName)),!(o.index<0)&&(this._vertexAttribArraysEnabled[o.index]||(this._gl.enableVertexAttribArray(o.index),this._vertexAttribArraysEnabled[o.index]=!0),this._vertexAttribPointer(e,o.index,o.attributeSize,o.attributeType||this._gl.FLOAT,o.normalized||!1,r,o.offset),this._gl.vertexAttribDivisor(o.index,o.divisor===void 0?1:o.divisor),this._currentInstanceLocations.push(o.index),this._currentInstanceBuffers.push(e))}}disableInstanceAttributeByName(e){if(!this._currentEffect)return;let i=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(i)}disableInstanceAttribute(e){let i=!1,s;for(;(s=this._currentInstanceLocations.indexOf(e))!==-1;)this._currentInstanceLocations.splice(s,1),this._currentInstanceBuffers.splice(s,1),i=!0,s=this._currentInstanceLocations.indexOf(e);i&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))}disableAttributeByIndex(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1}draw(e,i,s,r){this.drawElementsType(e?0:1,i,s,r)}drawPointClouds(e,i,s){this.drawArraysType(2,e,i,s)}drawUnIndexed(e,i,s,r){this.drawArraysType(e?0:1,i,s,r)}drawElementsType(e,i,s,r){this.applyStates(),this._reportDrawCall();let a=this._drawMode(e),o=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,h=this._uintIndicesCurrentlySet?4:2;r?this._gl.drawElementsInstanced(a,s,o,i*h,r):this._gl.drawElements(a,s,o,i*h)}drawArraysType(e,i,s,r){this.applyStates(),this._reportDrawCall();let a=this._drawMode(e);r?this._gl.drawArraysInstanced(a,i,s,r):this._gl.drawArrays(a,i,s)}_drawMode(e){switch(e){case 0:return this._gl.TRIANGLES;case 2:return this._gl.POINTS;case 1:return this._gl.LINES;case 3:return this._gl.POINTS;case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN;default:return this._gl.TRIANGLES}}_reportDrawCall(){}_releaseEffect(e){this._compiledEffects[e._key]&&delete this._compiledEffects[e._key];let i=e.getPipelineContext();i&&this._deletePipelineContext(i)}_deletePipelineContext(e){let i=e;i&&i.program&&(i.program.__SPECTOR_rebuildProgram=null,this._gl.deleteProgram(i.program))}_getGlobalDefines(e){if(e){this.isNDCHalfZRange?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER,this.useExactSrgbConversions?e.USE_EXACT_SRGB_CONVERSIONS="":delete e.USE_EXACT_SRGB_CONVERSIONS;return}else{let i="";return this.isNDCHalfZRange&&(i+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(i&&(i+=`
`),i+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(i&&(i+=`
`),i+="#define USE_EXACT_SRGB_CONVERSIONS"),i}}createEffect(e,i,s,r,a,o,h,l,c,d=Fe.GLSL){var u;let f=e.vertexElement||e.vertex||e.vertexToken||e.vertexSource||e,_=e.fragmentElement||e.fragment||e.fragmentToken||e.fragmentSource||e,g=this._getGlobalDefines(),p=(u=a??i.defines)!==null&&u!==void 0?u:"";g&&(p+=g);let E=f+"+"+_+"@"+p;if(this._compiledEffects[E]){let R=this._compiledEffects[E];return h&&R.isReady()&&h(R),R}let T=new Re(e,i,s,r,this,a,o,h,l,c,E,d);return this._compiledEffects[E]=T,T}static _ConcatenateShader(e,i,s=""){return s+(i?i+`
`:"")+e}_compileShader(e,i,s,r){return this._compileRawShader(n._ConcatenateShader(e,s,r),i)}_compileRawShader(e,i){let s=this._gl,r=s.createShader(i==="vertex"?s.VERTEX_SHADER:s.FRAGMENT_SHADER);if(!r){let a=s.NO_ERROR,o=s.NO_ERROR;for(;(o=s.getError())!==s.NO_ERROR;)a=o;throw new Error(`Something went wrong while creating a gl ${i} shader object. gl error=${a}, gl isContextLost=${s.isContextLost()}, _contextWasLost=${this._contextWasLost}`)}return s.shaderSource(r,e),s.compileShader(r),r}_getShaderSource(e){return this._gl.getShaderSource(e)}createRawShaderProgram(e,i,s,r,a=null){r=r||this._gl;let o=this._compileRawShader(i,"vertex"),h=this._compileRawShader(s,"fragment");return this._createShaderProgram(e,o,h,r,a)}createShaderProgram(e,i,s,r,a,o=null){a=a||this._gl;let h=this._webGLVersion>1?`#version 300 es
#define WEBGL2 
`:"",l=this._compileShader(i,"vertex",r,h),c=this._compileShader(s,"fragment",r,h);return this._createShaderProgram(e,l,c,a,o)}inlineShaderCode(e){return e}createPipelineContext(e){let i=new Js;return i.engine=this,this._caps.parallelShaderCompile&&(i.isParallelCompiled=!0),i}createMaterialContext(){}createDrawContext(){}_createShaderProgram(e,i,s,r,a=null){let o=r.createProgram();if(e.program=o,!o)throw new Error("Unable to create program");return r.attachShader(o,i),r.attachShader(o,s),r.linkProgram(o),e.context=r,e.vertexShader=i,e.fragmentShader=s,e.isParallelCompiled||this._finalizePipelineContext(e),o}_finalizePipelineContext(e){let i=e.context,s=e.vertexShader,r=e.fragmentShader,a=e.program;if(!i.getProgramParameter(a,i.LINK_STATUS)){if(!this._gl.getShaderParameter(s,this._gl.COMPILE_STATUS)){let h=this._gl.getShaderInfoLog(s);if(h)throw e.vertexCompilationError=h,new Error("VERTEX SHADER "+h)}if(!this._gl.getShaderParameter(r,this._gl.COMPILE_STATUS)){let h=this._gl.getShaderInfoLog(r);if(h)throw e.fragmentCompilationError=h,new Error("FRAGMENT SHADER "+h)}let o=i.getProgramInfoLog(a);if(o)throw e.programLinkError=o,new Error(o)}if(this.validateShaderPrograms&&(i.validateProgram(a),!i.getProgramParameter(a,i.VALIDATE_STATUS))){let o=i.getProgramInfoLog(a);if(o)throw e.programValidationError=o,new Error(o)}i.deleteShader(s),i.deleteShader(r),e.vertexShader=void 0,e.fragmentShader=void 0,e.onCompiled&&(e.onCompiled(),e.onCompiled=void 0)}_preparePipelineContext(e,i,s,r,a,o,h,l,c,d){let u=e;r?u.program=this.createRawShaderProgram(u,i,s,void 0,c):u.program=this.createShaderProgram(u,i,s,l,void 0,c),u.program.__SPECTOR_rebuildProgram=h}_isRenderingStateCompiled(e){let i=e;return this._gl.getProgramParameter(i.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)?(this._finalizePipelineContext(i),!0):!1}_executeWhenRenderingStateIsCompiled(e,i){let s=e;if(!s.isParallelCompiled){i();return}let r=s.onCompiled;r?s.onCompiled=()=>{r(),i()}:s.onCompiled=i}getUniforms(e,i){let s=new Array,r=e;for(let a=0;a<i.length;a++)s.push(this._gl.getUniformLocation(r.program,i[a]));return s}getAttributes(e,i){let s=[],r=e;for(let a=0;a<i.length;a++)try{s.push(this._gl.getAttribLocation(r.program,i[a]))}catch{s.push(-1)}return s}enableEffect(e){e=e!==null&&Wt.IsWrapper(e)?e.effect:e,!(!e||e===this._currentEffect)&&(this._stencilStateComposer.stencilMaterial=void 0,e=e,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))}setInt(e,i){return e?(this._gl.uniform1i(e,i),!0):!1}setInt2(e,i,s){return e?(this._gl.uniform2i(e,i,s),!0):!1}setInt3(e,i,s,r){return e?(this._gl.uniform3i(e,i,s,r),!0):!1}setInt4(e,i,s,r,a){return e?(this._gl.uniform4i(e,i,s,r,a),!0):!1}setIntArray(e,i){return e?(this._gl.uniform1iv(e,i),!0):!1}setIntArray2(e,i){return!e||i.length%2!==0?!1:(this._gl.uniform2iv(e,i),!0)}setIntArray3(e,i){return!e||i.length%3!==0?!1:(this._gl.uniform3iv(e,i),!0)}setIntArray4(e,i){return!e||i.length%4!==0?!1:(this._gl.uniform4iv(e,i),!0)}setUInt(e,i){return e?(this._gl.uniform1ui(e,i),!0):!1}setUInt2(e,i,s){return e?(this._gl.uniform2ui(e,i,s),!0):!1}setUInt3(e,i,s,r){return e?(this._gl.uniform3ui(e,i,s,r),!0):!1}setUInt4(e,i,s,r,a){return e?(this._gl.uniform4ui(e,i,s,r,a),!0):!1}setUIntArray(e,i){return e?(this._gl.uniform1uiv(e,i),!0):!1}setUIntArray2(e,i){return!e||i.length%2!==0?!1:(this._gl.uniform2uiv(e,i),!0)}setUIntArray3(e,i){return!e||i.length%3!==0?!1:(this._gl.uniform3uiv(e,i),!0)}setUIntArray4(e,i){return!e||i.length%4!==0?!1:(this._gl.uniform4uiv(e,i),!0)}setArray(e,i){return!e||i.length<1?!1:(this._gl.uniform1fv(e,i),!0)}setArray2(e,i){return!e||i.length%2!==0?!1:(this._gl.uniform2fv(e,i),!0)}setArray3(e,i){return!e||i.length%3!==0?!1:(this._gl.uniform3fv(e,i),!0)}setArray4(e,i){return!e||i.length%4!==0?!1:(this._gl.uniform4fv(e,i),!0)}setMatrices(e,i){return e?(this._gl.uniformMatrix4fv(e,!1,i),!0):!1}setMatrix3x3(e,i){return e?(this._gl.uniformMatrix3fv(e,!1,i),!0):!1}setMatrix2x2(e,i){return e?(this._gl.uniformMatrix2fv(e,!1,i),!0):!1}setFloat(e,i){return e?(this._gl.uniform1f(e,i),!0):!1}setFloat2(e,i,s){return e?(this._gl.uniform2f(e,i,s),!0):!1}setFloat3(e,i,s,r){return e?(this._gl.uniform3f(e,i,s,r),!0):!1}setFloat4(e,i,s,r,a){return e?(this._gl.uniform4f(e,i,s,r,a),!0):!1}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;let e=this._colorWrite;this._gl.colorMask(e,e,e,e)}}setColorWrite(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)}getColorWrite(){return this._colorWrite}get depthCullingState(){return this._depthCullingState}get alphaState(){return this._alphaState}get stencilState(){return this._stencilState}get stencilStateComposer(){return this._stencilStateComposer}clearInternalTexturesCache(){this._internalTexturesCache.length=0}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(e,i){let s=this._gl,r=s.NEAREST,a=s.NEAREST;switch(e){case 11:r=s.LINEAR,i?a=s.LINEAR_MIPMAP_NEAREST:a=s.LINEAR;break;case 3:r=s.LINEAR,i?a=s.LINEAR_MIPMAP_LINEAR:a=s.LINEAR;break;case 8:r=s.NEAREST,i?a=s.NEAREST_MIPMAP_LINEAR:a=s.NEAREST;break;case 4:r=s.NEAREST,i?a=s.NEAREST_MIPMAP_NEAREST:a=s.NEAREST;break;case 5:r=s.NEAREST,i?a=s.LINEAR_MIPMAP_NEAREST:a=s.LINEAR;break;case 6:r=s.NEAREST,i?a=s.LINEAR_MIPMAP_LINEAR:a=s.LINEAR;break;case 7:r=s.NEAREST,a=s.LINEAR;break;case 1:r=s.NEAREST,a=s.NEAREST;break;case 9:r=s.LINEAR,i?a=s.NEAREST_MIPMAP_NEAREST:a=s.NEAREST;break;case 10:r=s.LINEAR,i?a=s.NEAREST_MIPMAP_LINEAR:a=s.NEAREST;break;case 2:r=s.LINEAR,a=s.LINEAR;break;case 12:r=s.LINEAR,a=s.NEAREST;break}return{min:a,mag:r}}_createTexture(){let e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e}_createHardwareTexture(){return new ss(this._createTexture(),this._gl)}_createInternalTexture(e,i,s=!0,r=xe.Unknown){var a;let o=!1,h=0,l=3,c=5,d=!1,u=1;i!==void 0&&typeof i=="object"?(o=!!i.generateMipMaps,h=i.type===void 0?0:i.type,l=i.samplingMode===void 0?3:i.samplingMode,c=i.format===void 0?5:i.format,d=i.useSRGBBuffer===void 0?!1:i.useSRGBBuffer,u=(a=i.samples)!==null&&a!==void 0?a:1):o=!!i,d&&(d=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(h===1&&!this._caps.textureFloatLinearFiltering||h===2&&!this._caps.textureHalfFloatLinearFiltering)&&(l=1),h===1&&!this._caps.textureFloat&&(h=0,O.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));let f=this._gl,_=new oi(this,r),g=e.width||e,p=e.height||e,E=e.layers||0,T=this._getSamplingParameters(l,o),R=E!==0?f.TEXTURE_2D_ARRAY:f.TEXTURE_2D,y=this._getRGBABufferInternalSizedFormat(h,c,d),M=this._getInternalFormat(c),b=this._getWebGLTextureType(h);return this._bindTextureDirectly(R,_),E!==0?(_.is2DArray=!0,f.texImage3D(R,0,y,g,p,E,0,M,b,null)):f.texImage2D(R,0,y,g,p,0,M,b,null),f.texParameteri(R,f.TEXTURE_MAG_FILTER,T.mag),f.texParameteri(R,f.TEXTURE_MIN_FILTER,T.min),f.texParameteri(R,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(R,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),o&&this._gl.generateMipmap(R),this._bindTextureDirectly(R,null),_._useSRGBBuffer=d,_.baseWidth=g,_.baseHeight=p,_.width=g,_.height=p,_.depth=E,_.isReady=!0,_.samples=u,_.generateMipMaps=o,_.samplingMode=l,_.type=h,_.format=c,this._internalTexturesCache.push(_),_}_getUseSRGBBuffer(e,i){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||i)}_createTextureBase(e,i,s,r,a=3,o=null,h=null,l,c,d=null,u=null,f=null,_=null,g,p,E){e=e||"";let T=e.substr(0,5)==="data:",R=e.substr(0,5)==="blob:",y=T&&e.indexOf(";base64,")!==-1,M=u||new oi(this,xe.Url),b=e;this._transformTextureUrl&&!y&&!u&&!d&&(e=this._transformTextureUrl(e)),b!==e&&(M._originalUrl=b);let x=e.lastIndexOf("."),F=_||(x>-1?e.substring(x).toLowerCase():""),I=null;F.indexOf("?")>-1&&(F=F.split("?")[0]);for(let Y of n._TextureLoaders)if(Y.canLoad(F,g)){I=Y;break}r&&r.addPendingData(M),M.url=e,M.generateMipMaps=!i,M.samplingMode=a,M.invertY=s,M._useSRGBBuffer=this._getUseSRGBBuffer(!!E,i),this._doNotHandleContextLost||(M._buffer=d);let N=null;o&&!u&&(N=M.onLoadedObservable.add(o)),u||this._internalTexturesCache.push(M);let G=(Y,q)=>{r&&r.removePendingData(M),e===b?(N&&M.onLoadedObservable.remove(N),Q.UseFallbackTexture&&this._createTextureBase(Q.FallbackTexture,i,M.invertY,r,a,null,h,l,c,d,M),Y=(Y||"Unknown error")+(Q.UseFallbackTexture?" - Fallback texture was used":""),M.onErrorObservable.notifyObservers({message:Y,exception:q}),h&&h(Y,q)):(O.Warn(`Failed to load ${e}, falling back to ${b}`),this._createTextureBase(b,i,M.invertY,r,a,o,h,l,c,d,M,f,_,g,p,E))};if(I){let Y=q=>{I.loadData(q,M,(j,$,Te,Se,ye,Ie)=>{Ie?G("TextureLoader failed to load data"):l(M,F,r,{width:j,height:$},M.invertY,!Te,Se,()=>(ye(),!1),a)},p)};d?d instanceof ArrayBuffer?Y(new Uint8Array(d)):ArrayBuffer.isView(d)?Y(d):h&&h("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(e,q=>Y(new Uint8Array(q)),void 0,r?r.offlineProvider:void 0,!0,(q,j)=>{G("Unable to load "+(q&&q.responseURL,j))})}else{let Y=q=>{R&&!this._doNotHandleContextLost&&(M._buffer=q),l(M,F,r,q,M.invertY,i,!1,c,a)};!T||y?d&&(typeof d.decoding=="string"||d.close)?Y(d):n._FileToolsLoadImage(e,Y,G,r?r.offlineProvider:null,g,M.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):typeof d=="string"||d instanceof ArrayBuffer||ArrayBuffer.isView(d)||d instanceof Blob?n._FileToolsLoadImage(d,Y,G,r?r.offlineProvider:null,g,M.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):d&&Y(d)}return M}createTexture(e,i,s,r,a=3,o=null,h=null,l=null,c=null,d=null,u=null,f,_,g,p){return this._createTextureBase(e,i,s,r,a,o,h,this._prepareWebGLTexture.bind(this),(E,T,R,y,M,b)=>{let x=this._gl,F=R.width===E&&R.height===T,I=d?this._getInternalFormat(d,M._useSRGBBuffer):y===".jpg"&&!M._useSRGBBuffer?x.RGB:M._useSRGBBuffer?x.SRGB8_ALPHA8:x.RGBA,N=d?this._getInternalFormat(d):y===".jpg"&&!M._useSRGBBuffer?x.RGB:x.RGBA;if(M._useSRGBBuffer&&this.webGLVersion===1&&(N=I),F)return x.texImage2D(x.TEXTURE_2D,0,I,N,x.UNSIGNED_BYTE,R),!1;let G=this._caps.maxTextureSize;if(R.width>G||R.height>G||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext||(this._workingCanvas.width=E,this._workingCanvas.height=T,this._workingContext.drawImage(R,0,0,R.width,R.height,0,0,E,T),x.texImage2D(x.TEXTURE_2D,0,I,N,x.UNSIGNED_BYTE,this._workingCanvas),M.width=E,M.height=T),!1;{let Y=new oi(this,xe.Temp);this._bindTextureDirectly(x.TEXTURE_2D,Y,!0),x.texImage2D(x.TEXTURE_2D,0,I,N,x.UNSIGNED_BYTE,R),this._rescaleTexture(Y,M,r,I,()=>{this._releaseTexture(Y),this._bindTextureDirectly(x.TEXTURE_2D,M,!0),b()})}return!0},l,c,d,u,f,_,p)}static _FileToolsLoadImage(e,i,s,r,a,o){throw H("FileTools")}_rescaleTexture(e,i,s,r,a){}createRawTexture(e,i,s,r,a,o,h,l=null,c=0,d=0,u=!1){throw H("Engine.RawTexture")}createRawCubeTexture(e,i,s,r,a,o,h,l=null){throw H("Engine.RawTexture")}createRawTexture3D(e,i,s,r,a,o,h,l,c=null,d=0){throw H("Engine.RawTexture")}createRawTexture2DArray(e,i,s,r,a,o,h,l,c=null,d=0){throw H("Engine.RawTexture")}_unpackFlipY(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(e,i,s=!1){let r=this._getTextureTarget(i),a=this._getSamplingParameters(e,i.generateMipMaps||s);this._setTextureParameterInteger(r,this._gl.TEXTURE_MAG_FILTER,a.mag,i),this._setTextureParameterInteger(r,this._gl.TEXTURE_MIN_FILTER,a.min),s&&(i.generateMipMaps=!0,this._gl.generateMipmap(r)),this._bindTextureDirectly(r,null),i.samplingMode=e}updateTextureDimensions(e,i,s,r=1){}updateTextureWrappingMode(e,i,s=null,r=null){let a=this._getTextureTarget(e);i!==null&&(this._setTextureParameterInteger(a,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(i),e),e._cachedWrapU=i),s!==null&&(this._setTextureParameterInteger(a,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(s),e),e._cachedWrapV=s),(e.is2DArray||e.is3D)&&r!==null&&(this._setTextureParameterInteger(a,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(r),e),e._cachedWrapR=r),this._bindTextureDirectly(a,null)}_setupDepthStencilTexture(e,i,s,r,a,o=1){let h=i.width||i,l=i.height||i,c=i.layers||0;e.baseWidth=h,e.baseHeight=l,e.width=h,e.height=l,e.is2DArray=c>0,e.depth=c,e.isReady=!0,e.samples=o,e.generateMipMaps=!1,e.samplingMode=r?2:1,e.type=0,e._comparisonFunction=a;let d=this._gl,u=this._getTextureTarget(e),f=this._getSamplingParameters(e.samplingMode,!1);d.texParameteri(u,d.TEXTURE_MAG_FILTER,f.mag),d.texParameteri(u,d.TEXTURE_MIN_FILTER,f.min),d.texParameteri(u,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(u,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),this.webGLVersion>1&&(a===0?(d.texParameteri(u,d.TEXTURE_COMPARE_FUNC,515),d.texParameteri(u,d.TEXTURE_COMPARE_MODE,d.NONE)):(d.texParameteri(u,d.TEXTURE_COMPARE_FUNC,a),d.texParameteri(u,d.TEXTURE_COMPARE_MODE,d.COMPARE_REF_TO_TEXTURE)))}_uploadCompressedDataToTextureDirectly(e,i,s,r,a,o=0,h=0){let l=this._gl,c=l.TEXTURE_2D;if(e.isCube&&(c=l.TEXTURE_CUBE_MAP_POSITIVE_X+o),e._useSRGBBuffer)switch(i){case 37492:case 36196:this._caps.etc2?i=l.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?i=l.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=!1;break;case 36492:i=l.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:i=l.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?i=l.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?i=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?i=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1;break}this._gl.compressedTexImage2D(c,h,i,s,r,0,a)}_uploadDataToTextureDirectly(e,i,s=0,r=0,a,o=!1){let h=this._gl,l=this._getWebGLTextureType(e.type),c=this._getInternalFormat(e.format),d=a===void 0?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(a,e._useSRGBBuffer);this._unpackFlipY(e.invertY);let u=h.TEXTURE_2D;e.isCube&&(u=h.TEXTURE_CUBE_MAP_POSITIVE_X+s);let f=Math.round(Math.log(e.width)*Math.LOG2E),_=Math.round(Math.log(e.height)*Math.LOG2E),g=o?e.width:Math.pow(2,Math.max(f-r,0)),p=o?e.height:Math.pow(2,Math.max(_-r,0));h.texImage2D(u,r,d,g,p,0,c,l,i)}updateTextureData(e,i,s,r,a,o,h=0,l=0,c=!1){let d=this._gl,u=this._getWebGLTextureType(e.type),f=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);let _=d.TEXTURE_2D,g=d.TEXTURE_2D;e.isCube&&(g=d.TEXTURE_CUBE_MAP_POSITIVE_X+h,_=d.TEXTURE_CUBE_MAP),this._bindTextureDirectly(_,e,!0),d.texSubImage2D(g,l,s,r,a,o,f,u,i),c&&this._gl.generateMipmap(g),this._bindTextureDirectly(_,null)}_uploadArrayBufferViewToTexture(e,i,s=0,r=0){let a=this._gl,o=e.isCube?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;this._bindTextureDirectly(o,e,!0),this._uploadDataToTextureDirectly(e,i,s,r),this._bindTextureDirectly(o,null,!0)}_prepareWebGLTextureContinuation(e,i,s,r,a){let o=this._gl;if(!o)return;let h=this._getSamplingParameters(a,!s);o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,h.mag),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,h.min),!s&&!r&&o.generateMipmap(o.TEXTURE_2D),this._bindTextureDirectly(o.TEXTURE_2D,null),i&&i.removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}_prepareWebGLTexture(e,i,s,r,a,o,h,l,c=3){let d=this.getCaps().maxTextureSize,u=Math.min(d,this.needPOTTextures?n.GetExponentOfTwo(r.width,d):r.width),f=Math.min(d,this.needPOTTextures?n.GetExponentOfTwo(r.height,d):r.height),_=this._gl;if(_){if(!e._hardwareTexture){s&&s.removePendingData(e);return}this._bindTextureDirectly(_.TEXTURE_2D,e,!0),this._unpackFlipY(a===void 0?!0:!!a),e.baseWidth=r.width,e.baseHeight=r.height,e.width=u,e.height=f,e.isReady=!0,!l(u,f,r,i,e,()=>{this._prepareWebGLTextureContinuation(e,s,o,h,c)})&&this._prepareWebGLTextureContinuation(e,s,o,h,c)}}_setupFramebufferDepthAttachments(e,i,s,r,a=1){let o=this._gl;if(e&&i)return this._createRenderBuffer(s,r,a,o.DEPTH_STENCIL,o.DEPTH24_STENCIL8,o.DEPTH_STENCIL_ATTACHMENT);if(i){let h=o.DEPTH_COMPONENT16;return this._webGLVersion>1&&(h=o.DEPTH_COMPONENT32F),this._createRenderBuffer(s,r,a,h,h,o.DEPTH_ATTACHMENT)}return e?this._createRenderBuffer(s,r,a,o.STENCIL_INDEX8,o.STENCIL_INDEX8,o.STENCIL_ATTACHMENT):null}_createRenderBuffer(e,i,s,r,a,o,h=!0){let l=this._gl.createRenderbuffer();return this._updateRenderBuffer(l,e,i,s,r,a,o,h)}_updateRenderBuffer(e,i,s,r,a,o,h,l=!0){let c=this._gl;return c.bindRenderbuffer(c.RENDERBUFFER,e),r>1&&c.renderbufferStorageMultisample?c.renderbufferStorageMultisample(c.RENDERBUFFER,r,o,i,s):c.renderbufferStorage(c.RENDERBUFFER,a,i,s),c.framebufferRenderbuffer(c.FRAMEBUFFER,h,c.RENDERBUFFER,e),l&&c.bindRenderbuffer(c.RENDERBUFFER,null),e}_releaseTexture(e){var i;this._deleteTexture((i=e._hardwareTexture)===null||i===void 0?void 0:i.underlyingResource),this.unbindAllTextures();let s=this._internalTexturesCache.indexOf(e);s!==-1&&this._internalTexturesCache.splice(s,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()}_releaseRenderTargetWrapper(e){let i=this._renderTargetWrapperCache.indexOf(e);i!==-1&&this._renderTargetWrapperCache.splice(i,1)}_deleteTexture(e){e&&this._gl.deleteTexture(e)}_setProgram(e){this._currentProgram!==e&&(this._gl.useProgram(e),this._currentProgram=e)}bindSamplers(e){let i=e.getPipelineContext();this._setProgram(i.program);let s=e.getSamplers();for(let r=0;r<s.length;r++){let a=e.getUniform(s[r]);a&&(this._boundUniforms[r]=a)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(e,i,s=!1,r=!1){var a,o;let h=!1,l=i&&i._associatedChannel>-1;if(s&&l&&(this._activeChannel=i._associatedChannel),this._boundTexturesCache[this._activeChannel]!==i||r){if(this._activateCurrentTexture(),i&&i.isMultiview)throw console.error(e,i),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(e,(o=(a=i?._hardwareTexture)===null||a===void 0?void 0:a.underlyingResource)!==null&&o!==void 0?o:null),this._boundTexturesCache[this._activeChannel]=i,i&&(i._associatedChannel=this._activeChannel)}else s&&(h=!0,this._activateCurrentTexture());return l&&!s&&this._bindSamplerUniformToChannel(i._associatedChannel,this._activeChannel),h}_bindTexture(e,i,s){if(e===void 0)return;i&&(i._associatedChannel=e),this._activeChannel=e;let r=i?this._getTextureTarget(i):this._gl.TEXTURE_2D;this._bindTextureDirectly(r,i)}unbindAllTextures(){for(let e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(e,i,s,r){e!==void 0&&(i&&(this._boundUniforms[e]=i),this._setTexture(e,s))}_bindSamplerUniformToChannel(e,i){let s=this._boundUniforms[e];!s||s._currentState===i||(this._gl.uniform1i(s,i),s._currentState=i)}_getTextureWrapMode(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(e,i,s=!1,r=!1,a=""){if(!i)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(i.video)this._activeChannel=e,i.update();else if(i.delayLoadState===4)return i.delayLoad(),!1;let o;r?o=i.depthStencilTexture:i.isReady()?o=i.getInternalTexture():i.isCube?o=this.emptyCubeTexture:i.is3D?o=this.emptyTexture3D:i.is2DArray?o=this.emptyTexture2DArray:o=this.emptyTexture,!s&&o&&(o._associatedChannel=e);let h=!0;this._boundTexturesCache[e]===o&&(s||this._bindSamplerUniformToChannel(o._associatedChannel,e),h=!1),this._activeChannel=e;let l=this._getTextureTarget(o);if(h&&this._bindTextureDirectly(l,o,s),o&&!o.isMultiview){if(o.isCube&&o._cachedCoordinatesMode!==i.coordinatesMode){o._cachedCoordinatesMode=i.coordinatesMode;let c=i.coordinatesMode!==3&&i.coordinatesMode!==5?1:0;i.wrapU=c,i.wrapV=c}o._cachedWrapU!==i.wrapU&&(o._cachedWrapU=i.wrapU,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(i.wrapU),o)),o._cachedWrapV!==i.wrapV&&(o._cachedWrapV=i.wrapV,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(i.wrapV),o)),o.is3D&&o._cachedWrapR!==i.wrapR&&(o._cachedWrapR=i.wrapR,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(i.wrapR),o)),this._setAnisotropicLevel(l,o,i.anisotropicFilteringLevel)}return!0}setTextureArray(e,i,s,r){if(!(e===void 0||!i)){(!this._textureUnits||this._textureUnits.length!==s.length)&&(this._textureUnits=new Int32Array(s.length));for(let a=0;a<s.length;a++){let o=s[a].getInternalTexture();o?(this._textureUnits[a]=e+a,o._associatedChannel=e+a):this._textureUnits[a]=-1}this._gl.uniform1iv(i,this._textureUnits);for(let a=0;a<s.length;a++)this._setTexture(this._textureUnits[a],s[a],!0)}}_setAnisotropicLevel(e,i,s){let r=this._caps.textureAnisotropicFilterExtension;i.samplingMode!==11&&i.samplingMode!==3&&i.samplingMode!==2&&(s=1),r&&i._cachedAnisotropicFilteringLevel!==s&&(this._setTextureParameterFloat(e,r.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(s,this._caps.maxAnisotropy),i),i._cachedAnisotropicFilteringLevel=s)}_setTextureParameterFloat(e,i,s,r){this._bindTextureDirectly(e,r,!0,!0),this._gl.texParameterf(e,i,s)}_setTextureParameterInteger(e,i,s,r){r&&this._bindTextureDirectly(e,r,!0,!0),this._gl.texParameteri(e,i,s)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e);return}for(let e=0,i=this._vertexAttribArraysEnabled.length;e<i;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)}releaseEffects(){for(let e in this._compiledEffects){let i=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(i)}this._compiledEffects={}}dispose(){var e;this.stopRenderLoop(),this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.releaseEffects(),(e=this.releaseComputeEffects)===null||e===void 0||e.call(this),this.unbindAllAttributes(),this._boundUniforms={},Oe()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),window.removeEventListener("resize",this._checkForMobile)),this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._renderingCanvas=null,this._currentProgram=null,this._boundRenderFunction=null,Re.ResetCache();for(let i of this._activeRequests)i.abort();this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}attachContextLostEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)}attachContextRestoredEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(e){let i=this._gl;for(;i.getError()!==i.NO_ERROR;);let s=!0,r=i.createTexture();i.bindTexture(i.TEXTURE_2D,r),i.texImage2D(i.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,i.RGBA,this._getWebGLTextureType(e),null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST);let a=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,a),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,r,0);let o=i.checkFramebufferStatus(i.FRAMEBUFFER);if(s=s&&o===i.FRAMEBUFFER_COMPLETE,s=s&&i.getError()===i.NO_ERROR,s&&(i.clear(i.COLOR_BUFFER_BIT),s=s&&i.getError()===i.NO_ERROR),s){i.bindFramebuffer(i.FRAMEBUFFER,null);let h=i.RGBA,l=i.UNSIGNED_BYTE,c=new Uint8Array(4);i.readPixels(0,0,1,1,h,l,c),s=s&&i.getError()===i.NO_ERROR}for(i.deleteTexture(r),i.deleteFramebuffer(a),i.bindFramebuffer(i.FRAMEBUFFER,null);!s&&i.getError()!==i.NO_ERROR;);return s}_getWebGLTextureType(e){if(this._webGLVersion===1){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(e,i=!1){let s=i?this._gl.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:s=this._gl.ALPHA;break;case 1:s=this._gl.LUMINANCE;break;case 2:s=this._gl.LUMINANCE_ALPHA;break;case 6:s=this._gl.RED;break;case 7:s=this._gl.RG;break;case 4:s=i?this._gl.SRGB:this._gl.RGB;break;case 5:s=i?this._gl.SRGB8_ALPHA8:this._gl.RGBA;break}if(this._webGLVersion>1)switch(e){case 8:s=this._gl.RED_INTEGER;break;case 9:s=this._gl.RG_INTEGER;break;case 10:s=this._gl.RGB_INTEGER;break;case 11:s=this._gl.RGBA_INTEGER;break}return s}_getRGBABufferInternalSizedFormat(e,i,s=!1){if(this._webGLVersion===1){if(i!==void 0)switch(i){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return s?this._gl.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(i){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(i){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return s?this._gl.SRGB8:this._gl.RGB8;case 5:return s?this._gl.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(i){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;case 11:return this._gl.RGBA16I;default:return this._gl.RGBA16I}case 5:switch(i){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;case 11:return this._gl.RGBA16UI;default:return this._gl.RGBA16UI}case 6:switch(i){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;case 11:return this._gl.RGBA32I;default:return this._gl.RGBA32I}case 7:switch(i){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;case 11:return this._gl.RGBA32UI;default:return this._gl.RGBA32UI}case 1:switch(i){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;case 5:return this._gl.RGBA32F;default:return this._gl.RGBA32F}case 2:switch(i){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;case 5:return this._gl.RGBA16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(i){case 5:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI;default:return this._gl.RGB10_A2}}return s?this._gl.SRGB8_ALPHA8:this._gl.RGBA8}_getRGBAMultiSampleBufferFormat(e){return e===1?this._gl.RGBA32F:e===2?this._gl.RGBA16F:this._gl.RGBA8}_loadFile(e,i,s,r,a,o){let h=n._FileToolsLoadFile(e,i,s,r,a,o);return this._activeRequests.push(h),h.onCompleteObservable.add(l=>{this._activeRequests.splice(this._activeRequests.indexOf(l),1)}),h}static _FileToolsLoadFile(e,i,s,r,a,o){throw H("FileTools")}readPixels(e,i,s,r,a=!0,o=!0){let h=a?4:3,l=a?this._gl.RGBA:this._gl.RGB,c=new Uint8Array(r*s*h);return o&&this.flushFramebuffer(),this._gl.readPixels(e,i,s,r,l,this._gl.UNSIGNED_BYTE,c),Promise.resolve(c)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(this._HasMajorPerformanceCaveat!==null)return!this._HasMajorPerformanceCaveat;if(this._IsSupported===null)try{let e=this._CreateCanvas(1,1),i=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=i!=null&&!!window.WebGLRenderingContext}catch{this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(this._HasMajorPerformanceCaveat===null)try{let e=this._CreateCanvas(1,1),i=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!i}catch{this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}static CeilingPOT(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e++,e}static FloorPOT(e){return e=e|e>>1,e=e|e>>2,e=e|e>>4,e=e|e>>8,e=e|e>>16,e-(e>>1)}static NearestPOT(e){let i=n.CeilingPOT(e),s=n.FloorPOT(e);return i-e>e-s?s:i}static GetExponentOfTwo(e,i,s=2){let r;switch(s){case 1:r=n.FloorPOT(e);break;case 2:r=n.NearestPOT(e);break;case 3:default:r=n.CeilingPOT(e);break}return Math.min(r,i)}static QueueNewFrame(e,i){if(Oe()){let{requestPostAnimationFrame:s,requestAnimationFrame:r}=i||window;if(typeof s=="function")return s(e);if(typeof r=="function")return r(e)}else if(typeof requestAnimationFrame=="function")return requestAnimationFrame(e);return setTimeout(e,16)}getHostDocument(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:Di()?document:null}}return n.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],n._TextureLoaders=[],n.CollisionsEpsilon=.001,n._IsSupported=null,n._HasMajorPerformanceCaveat=null,n})(),ir=class{constructor(t=30){this._enabled=!0,this._rollingFrameTime=new sr(t)}sampleFrame(t=Pt.Now){if(this._enabled){if(this._lastFrameTimeMs!=null){let e=t-this._lastFrameTimeMs;this._rollingFrameTime.add(e)}this._lastFrameTimeMs=t}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){let t=this._rollingFrameTime.history(0);return t===0?0:1e3/t}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}},sr=class{constructor(t){this._samples=new Array(t),this.reset()}add(t){let e;if(this.isSaturated()){let i=this._samples[this._pos];e=i-this.average,this.average-=e/(this._sampleCount-1),this._m2-=e*(i-this.average)}else this._sampleCount++;e=t-this.average,this.average+=e/this._sampleCount,this._m2+=e*(t-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=t,this._pos++,this._pos%=this._samples.length}history(t){if(t>=this._sampleCount||t>=this._samples.length)return 0;let e=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(e-t)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(t){let e=this._samples.length;return(t%e+e)%e}},bi=(()=>{class n{constructor(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}get min(){return this._min}get max(){return this._max}get average(){return this._average}get lastSecAverage(){return this._lastSecAverage}get current(){return this._current}get total(){return this._totalAccumulated}get count(){return this._totalValueCount}fetchNewFrame(){this._totalValueCount++,this._current=0,this._lastSecValueCount++}addCount(e,i){n.Enabled&&(this._current+=e,i&&this._fetchResult())}beginMonitoring(){n.Enabled&&(this._startMonitoringTime=Pt.Now)}endMonitoring(e=!0){if(!n.Enabled)return;e&&this.fetchNewFrame();let i=Pt.Now;this._current=i-this._startMonitoringTime,e&&this._fetchResult()}_fetchResult(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;let e=Pt.Now;e-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=e,this._lastSecAccumulated=0,this._lastSecValueCount=0)}}return n.Enabled=!0,n})();le.prototype.setAlphaConstants=function(n,t,e,i){this._alphaState.setAlphaBlendConstants(n,t,e,i)};le.prototype.setAlphaMode=function(n,t=!1){if(this._alphaMode!==n){switch(n){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break}t||(this.depthCullingState.depthMask=n===0),this._alphaMode=n}};le.prototype.getAlphaMode=function(){return this._alphaMode};le.prototype.setAlphaEquation=function(n){if(this._alphaEquation!==n){switch(n){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774);break}this._alphaEquation=n}};le.prototype.getAlphaEquation=function(){return this._alphaEquation};function qn(n,t,e=!1,i){switch(n){case 3:{let r=t instanceof ArrayBuffer?new Int8Array(t):new Int8Array(t);return i&&r.set(new Int8Array(i)),r}case 0:{let r=t instanceof ArrayBuffer?new Uint8Array(t):new Uint8Array(t);return i&&r.set(new Uint8Array(i)),r}case 4:{let r=t instanceof ArrayBuffer?new Int16Array(t):new Int16Array(e?t/2:t);return i&&r.set(new Int16Array(i)),r}case 5:case 8:case 9:case 10:case 2:{let r=t instanceof ArrayBuffer?new Uint16Array(t):new Uint16Array(e?t/2:t);return i&&r.set(new Uint16Array(i)),r}case 6:{let r=t instanceof ArrayBuffer?new Int32Array(t):new Int32Array(e?t/4:t);return i&&r.set(new Int32Array(i)),r}case 7:case 11:case 12:case 13:case 14:case 15:{let r=t instanceof ArrayBuffer?new Uint32Array(t):new Uint32Array(e?t/4:t);return i&&r.set(new Uint32Array(i)),r}case 1:{let r=t instanceof ArrayBuffer?new Float32Array(t):new Float32Array(e?t/4:t);return i&&r.set(new Float32Array(i)),r}}let s=t instanceof ArrayBuffer?new Uint8Array(t):new Uint8Array(t);return i&&s.set(new Uint8Array(i)),s}le.prototype._readTexturePixelsSync=function(n,t,e,i=-1,s=0,r=null,a=!0,o=!1,h=0,l=0){var c,d;let u=this._gl;if(!u)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){let _=u.createFramebuffer();if(!_)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=_}u.bindFramebuffer(u.FRAMEBUFFER,this._dummyFramebuffer),i>-1?u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_CUBE_MAP_POSITIVE_X+i,(c=n._hardwareTexture)===null||c===void 0?void 0:c.underlyingResource,s):u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_2D,(d=n._hardwareTexture)===null||d===void 0?void 0:d.underlyingResource,s);let f=n.type!==void 0?this._getWebGLTextureType(n.type):u.UNSIGNED_BYTE;if(o)r||(r=qn(n.type,4*t*e));else switch(f){case u.UNSIGNED_BYTE:r||(r=new Uint8Array(4*t*e)),f=u.UNSIGNED_BYTE;break;default:r||(r=new Float32Array(4*t*e)),f=u.FLOAT;break}return a&&this.flushFramebuffer(),u.readPixels(h,l,t,e,u.RGBA,f,r),u.bindFramebuffer(u.FRAMEBUFFER,this._currentFramebuffer),r};le.prototype._readTexturePixels=function(n,t,e,i=-1,s=0,r=null,a=!0,o=!1,h=0,l=0){return Promise.resolve(this._readTexturePixelsSync(n,t,e,i,s,r,a,o,h,l))};le.prototype.updateDynamicIndexBuffer=function(n,t,e=0){this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(n);let i;n.is32Bits?i=t instanceof Uint32Array?t:new Uint32Array(t):i=t instanceof Uint16Array?t:new Uint16Array(t),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,i,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()};le.prototype.updateDynamicVertexBuffer=function(n,t,e,i){this.bindArrayBuffer(n),e===void 0&&(e=0);let s=t.byteLength||t.length;i===void 0||i>=s&&e===0?t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,e,new Float32Array(t)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,e,t):t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(t).subarray(e,e+i)):(t instanceof ArrayBuffer?t=new Uint8Array(t,e,i):t=new Uint8Array(t.buffer,t.byteOffset+e,i),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t)),this._resetVertexBufferBinding()};var de=(()=>{class n extends le{constructor(e,i,s,r=!1){if(super(e,i,s,r),this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.disableContextMenu=!0,this.scenes=new Array,this._virtualScenes=new Array,this.onNewSceneAddedObservable=new D,this.postProcesses=new Array,this.isPointerLock=!1,this.onResizeObservable=new D,this.onCanvasBlurObservable=new D,this.onCanvasFocusObservable=new D,this.onCanvasPointerOutObservable=new D,this.onBeginFrameObservable=new D,this.customAnimationFrameRequester=null,this.onEndFrameObservable=new D,this.onBeforeShaderCompilationObservable=new D,this.onAfterShaderCompilationObservable=new D,this._deterministicLockstep=!1,this._lockstepMaxSteps=4,this._timeStep=1/60,this._fps=60,this._deltaTime=0,this._drawCalls=new bi,this.canvasTabIndex=1,this.disablePerformanceMonitorInBackground=!1,this._performanceMonitor=new ir,this._compatibilityMode=!0,this.currentRenderPassId=0,this._renderPassNames=["main"],n.Instances.push(this),!!e){if(this._features.supportRenderPasses=!0,s=this._creationOptions,e.getContext){let a=e;this._sharedInit(a,!!s.doNotHandleTouchAction,s.audioEngine),Di()&&(this._onFullscreenChange=()=>{this.isFullscreen=!!document.fullscreenElement,this.isFullscreen&&this._pointerLockRequested&&a&&n._RequestPointerlock(a)},document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",this._onFullscreenChange,!1),this._onPointerLockChange=()=>{this.isPointerLock=document.pointerLockElement===a},document.addEventListener("pointerlockchange",this._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",this._onPointerLockChange,!1),!n.audioEngine&&s.audioEngine&&n.AudioEngineFactory&&(n.audioEngine=n.AudioEngineFactory(this.getRenderingCanvas(),this.getAudioContext(),this.getAudioDestination()))),this._connectVREvents(),this.enableOfflineSupport=n.OfflineProviderFactory!==void 0,this._deterministicLockstep=!!s.deterministicLockstep,this._lockstepMaxSteps=s.lockstepMaxSteps||0,this._timeStep=s.timeStep||1/60}this._prepareVRComponent(),s.autoEnableWebVR&&this.initWebVR()}}static get NpmPackage(){return le.NpmPackage}static get Version(){return le.Version}static get Instances(){return Q.Instances}static get LastCreatedEngine(){return Q.LastCreatedEngine}static get LastCreatedScene(){return Q.LastCreatedScene}_createImageBitmapFromSource(e,i){return new Promise((s,r)=>{let a=new Image;a.onload=()=>{a.decode().then(()=>{this.createImageBitmap(a,i).then(o=>{s(o)})})},a.onerror=()=>{r(`Error loading image ${a.src}`)},a.src=e})}createImageBitmap(e,i){return createImageBitmap(e,i)}resizeImageBitmap(e,i,s){let r=this.createCanvas(i,s).getContext("2d");if(!r)throw new Error("Unable to get 2d context for resizeImageBitmap");return r.drawImage(e,0,0),r.getImageData(0,0,i,s).data}static MarkAllMaterialsAsDirty(e,i){for(let s=0;s<n.Instances.length;s++){let r=n.Instances[s];for(let a=0;a<r.scenes.length;a++)r.scenes[a].markAllMaterialsAsDirty(e,i)}}static DefaultLoadingScreenFactory(e){throw H("LoadingScreen")}get _supportsHardwareTextureRescaling(){return!!n._RescalePostProcessFactory}get performanceMonitor(){return this._performanceMonitor}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=!0}getInputElement(){return this._renderingCanvas}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(e,i,s){super._sharedInit(e,i,s),this._onCanvasFocus=()=>{this.onCanvasFocusObservable.notifyObservers(this)},this._onCanvasBlur=()=>{this.onCanvasBlurObservable.notifyObservers(this)},this._onCanvasContextMenu=a=>{this.disableContextMenu&&a.preventDefault()},e.addEventListener("focus",this._onCanvasFocus),e.addEventListener("blur",this._onCanvasBlur),e.addEventListener("contextmenu",this._onCanvasContextMenu),this._onBlur=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.disable(),this._windowIsBackground=!0},this._onFocus=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.enable(),this._windowIsBackground=!1},this._onCanvasPointerOut=a=>{document.elementFromPoint(a.clientX,a.clientY)!==e&&this.onCanvasPointerOutObservable.notifyObservers(a)};let r=this.getHostWindow();r&&typeof r.addEventListener=="function"&&(r.addEventListener("blur",this._onBlur),r.addEventListener("focus",this._onFocus)),e.addEventListener("pointerout",this._onCanvasPointerOut),i||this._disableTouchAction(),!n.audioEngine&&s&&n.AudioEngineFactory&&(n.audioEngine=n.AudioEngineFactory(this.getRenderingCanvas(),this.getAudioContext(),this.getAudioDestination()))}getAspectRatio(e,i=!1){let s=e.viewport;return this.getRenderWidth(i)*s.width/(this.getRenderHeight(i)*s.height)}getScreenAspectRatio(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)}getRenderingCanvasClientRect(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null}getInputElementClientRect(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null}isDeterministicLockStep(){return this._deterministicLockstep}getLockstepMaxSteps(){return this._lockstepMaxSteps}getTimeStep(){return this._timeStep*1e3}generateMipMapsForCubemap(e,i=!0){if(e.generateMipMaps){let s=this._gl;this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,e,!0),s.generateMipmap(s.TEXTURE_CUBE_MAP),i&&this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,null)}}getDepthWrite(){return this._depthCullingState.depthMask}setDepthWrite(e){this._depthCullingState.depthMask=e}getStencilBuffer(){return this._stencilState.stencilTest}setStencilBuffer(e){this._stencilState.stencilTest=e}getStencilMask(){return this._stencilState.stencilMask}setStencilMask(e){this._stencilState.stencilMask=e}getStencilFunction(){return this._stencilState.stencilFunc}getStencilFunctionReference(){return this._stencilState.stencilFuncRef}getStencilFunctionMask(){return this._stencilState.stencilFuncMask}setStencilFunction(e){this._stencilState.stencilFunc=e}setStencilFunctionReference(e){this._stencilState.stencilFuncRef=e}setStencilFunctionMask(e){this._stencilState.stencilFuncMask=e}getStencilOperationFail(){return this._stencilState.stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilState.stencilOpDepthFail}getStencilOperationPass(){return this._stencilState.stencilOpStencilDepthPass}setStencilOperationFail(e){this._stencilState.stencilOpStencilFail=e}setStencilOperationDepthFail(e){this._stencilState.stencilOpDepthFail=e}setStencilOperationPass(e){this._stencilState.stencilOpStencilDepthPass=e}setDitheringState(e){e?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(e){e?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}getDepthFunction(){return this._depthCullingState.depthFunc}setDepthFunction(e){this._depthCullingState.depthFunc=e}setDepthFunctionToGreater(){this.setDepthFunction(516)}setDepthFunctionToGreaterOrEqual(){this.setDepthFunction(518)}setDepthFunctionToLess(){this.setDepthFunction(513)}setDepthFunctionToLessOrEqual(){this.setDepthFunction(515)}cacheStencilState(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()}restoreStencilState(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)}setDirectViewport(e,i,s,r){let a=this._cachedViewport;return this._cachedViewport=null,this._viewport(e,i,s,r),a}scissorClear(e,i,s,r,a){this.enableScissor(e,i,s,r),this.clear(a,!0,!0,!0),this.disableScissor()}enableScissor(e,i,s,r){let a=this._gl;a.enable(a.SCISSOR_TEST),a.scissor(e,i,s,r)}disableScissor(){let e=this._gl;e.disable(e.SCISSOR_TEST)}_reportDrawCall(e=1){this._drawCalls.addCount(e,!1)}initWebVR(){throw H("WebVRCamera")}_prepareVRComponent(){}_connectVREvents(e,i){}_submitVRFrame(){}disableVR(){}isVRPresenting(){return!1}_requestVRFrame(){}_loadFileAsync(e,i,s){return new Promise((r,a)=>{this._loadFile(e,o=>{r(o)},void 0,i,s,(o,h)=>{a(h)})})}getVertexShaderSource(e){let i=this._gl.getAttachedShaders(e);return i?this._gl.getShaderSource(i[0]):null}getFragmentShaderSource(e){let i=this._gl.getAttachedShaders(e);return i?this._gl.getShaderSource(i[1]):null}setDepthStencilTexture(e,i,s,r){e!==void 0&&(i&&(this._boundUniforms[e]=i),!s||!s.depthStencilTexture?this._setTexture(e,null,void 0,void 0,r):this._setTexture(e,s,!1,!0,r))}setTextureFromPostProcess(e,i,s){var r;let a=null;i&&(i._textures.data[i._currentRenderTextureInd]?a=i._textures.data[i._currentRenderTextureInd]:i._forcedOutputTexture&&(a=i._forcedOutputTexture)),this._bindTexture(e,(r=a?.texture)!==null&&r!==void 0?r:null,s)}setTextureFromPostProcessOutput(e,i,s){var r,a;this._bindTexture(e,(a=(r=i?._outputTexture)===null||r===void 0?void 0:r.texture)!==null&&a!==void 0?a:null,s)}_rebuildBuffers(){for(let e of this.scenes)e.resetCachedMaterial(),e._rebuildGeometries(),e._rebuildTextures();for(let e of this._virtualScenes)e.resetCachedMaterial(),e._rebuildGeometries(),e._rebuildTextures();super._rebuildBuffers()}_renderFrame(){for(let e=0;e<this._activeRenderLoops.length;e++){let i=this._activeRenderLoops[e];i()}}_renderLoop(){if(!this._contextWasLost){let e=!0;!this.renderEvenInBackground&&this._windowIsBackground&&(e=!1),e&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0?this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this.isVRPresenting()?this._requestVRFrame():this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}_renderViews(){return!1}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&n._RequestFullscreen(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&n._ExitFullscreen()}enterPointerlock(){this._renderingCanvas&&n._RequestPointerlock(this._renderingCanvas)}exitPointerlock(){n._ExitPointerlock()}beginFrame(){this._measureFps(),this.onBeginFrameObservable.notifyObservers(this),super.beginFrame()}endFrame(){super.endFrame(),this._submitVRFrame(),this.onEndFrameObservable.notifyObservers(this)}resize(e=!1){this.isVRPresenting()||super.resize(e)}setSize(e,i,s=!1){if(!this._renderingCanvas||!super.setSize(e,i,s))return!1;if(this.scenes){for(let r=0;r<this.scenes.length;r++){let a=this.scenes[r];for(let o=0;o<a.cameras.length;o++){let h=a.cameras[o];h._currentRenderId=0}}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0}_deletePipelineContext(e){let i=e;i&&i.program&&i.transformFeedback&&(this.deleteTransformFeedback(i.transformFeedback),i.transformFeedback=null),super._deletePipelineContext(e)}createShaderProgram(e,i,s,r,a,o=null){a=a||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);let h=super.createShaderProgram(e,i,s,r,a,o);return this.onAfterShaderCompilationObservable.notifyObservers(this),h}_createShaderProgram(e,i,s,r,a=null){let o=r.createProgram();if(e.program=o,!o)throw new Error("Unable to create program");if(r.attachShader(o,i),r.attachShader(o,s),this.webGLVersion>1&&a){let h=this.createTransformFeedback();this.bindTransformFeedback(h),this.setTranformFeedbackVaryings(o,a),e.transformFeedback=h}return r.linkProgram(o),this.webGLVersion>1&&a&&this.bindTransformFeedback(null),e.context=r,e.vertexShader=i,e.fragmentShader=s,e.isParallelCompiled||this._finalizePipelineContext(e),o}_releaseTexture(e){super._releaseTexture(e)}_releaseRenderTargetWrapper(e){super._releaseRenderTargetWrapper(e),this.scenes.forEach(i=>{i.postProcesses.forEach(s=>{s._outputTexture===e&&(s._outputTexture=null)}),i.cameras.forEach(s=>{s._postProcesses.forEach(r=>{r&&r._outputTexture===e&&(r._outputTexture=null)})})})}getRenderPassNames(){return this._renderPassNames}getCurrentRenderPassName(){return this._renderPassNames[this.currentRenderPassId]}createRenderPassId(e){let i=++n._RenderPassIdCounter;return this._renderPassNames[i]=e??"NONAME",i}releaseRenderPassId(e){this._renderPassNames[e]=void 0;for(let i=0;i<this.scenes.length;++i){let s=this.scenes[i];for(let r=0;r<s.meshes.length;++r){let a=s.meshes[r];if(a.subMeshes)for(let o=0;o<a.subMeshes.length;++o)a.subMeshes[o]._removeDrawWrapper(e)}}}_rescaleTexture(e,i,s,r,a){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);let o=this.createRenderTargetTexture({width:i.width,height:i.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});!this._rescalePostProcess&&n._RescalePostProcessFactory&&(this._rescalePostProcess=n._RescalePostProcessFactory(this)),this._rescalePostProcess&&(this._rescalePostProcess.externalTextureSamplerBinding=!0,this._rescalePostProcess.getEffect().executeWhenCompiled(()=>{this._rescalePostProcess.onApply=function(l){l._bindTexture("textureSampler",e)};let h=s;h||(h=this.scenes[this.scenes.length-1]),h.postProcessManager.directRender([this._rescalePostProcess],o,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,i,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,r,0,0,i.width,i.height,0),this.unBindFramebuffer(o),o.dispose(),a&&a()}))}getFps(){return this._fps}getDeltaTime(){return this._deltaTime}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}wrapWebGLTexture(e){let i=new ss(e,this._gl),s=new oi(this,xe.Unknown,!0);return s._hardwareTexture=i,s.isReady=!0,s}_uploadImageToTexture(e,i,s=0,r=0){let a=this._gl,o=this._getWebGLTextureType(e.type),h=this._getInternalFormat(e.format),l=this._getRGBABufferInternalSizedFormat(e.type,h),c=e.isCube?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;this._bindTextureDirectly(c,e,!0),this._unpackFlipY(e.invertY);let d=a.TEXTURE_2D;e.isCube&&(d=a.TEXTURE_CUBE_MAP_POSITIVE_X+s),a.texImage2D(d,r,l,h,o,i),this._bindTextureDirectly(c,null,!0)}updateTextureComparisonFunction(e,i){if(this.webGLVersion===1){O.Error("WebGL 1 does not support texture comparison.");return}let s=this._gl;e.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,e,!0),i===0?(s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_COMPARE_FUNC,515),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_COMPARE_MODE,s.NONE)):(s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_COMPARE_FUNC,i),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_COMPARE_MODE,s.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),i===0?(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_COMPARE_FUNC,515),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_COMPARE_MODE,s.NONE)):(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_COMPARE_FUNC,i),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_COMPARE_MODE,s.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),e._comparisonFunction=i}createInstancesBuffer(e){let i=this._gl.createBuffer();if(!i)throw new Error("Unable to create instance buffer");let s=new Qt(i);return s.capacity=e,this.bindArrayBuffer(s),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),s.references=1,s}deleteInstancesBuffer(e){this._gl.deleteBuffer(e)}_clientWaitAsync(e,i=0,s=10){let r=this._gl;return new Promise((a,o)=>{let h=()=>{let l=r.clientWaitSync(e,i,0);if(l==r.WAIT_FAILED){o();return}if(l==r.TIMEOUT_EXPIRED){setTimeout(h,s);return}a()};h()})}_readPixelsAsync(e,i,s,r,a,o,h){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");let l=this._gl,c=l.createBuffer();l.bindBuffer(l.PIXEL_PACK_BUFFER,c),l.bufferData(l.PIXEL_PACK_BUFFER,h.byteLength,l.STREAM_READ),l.readPixels(e,i,s,r,a,o,0),l.bindBuffer(l.PIXEL_PACK_BUFFER,null);let d=l.fenceSync(l.SYNC_GPU_COMMANDS_COMPLETE,0);return d?(l.flush(),this._clientWaitAsync(d,0,10).then(()=>(l.deleteSync(d),l.bindBuffer(l.PIXEL_PACK_BUFFER,c),l.getBufferSubData(l.PIXEL_PACK_BUFFER,0,h),l.bindBuffer(l.PIXEL_PACK_BUFFER,null),l.deleteBuffer(c),h))):null}dispose(){for(this.hideLoadingUI(),this.onNewSceneAddedObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(this._rescalePostProcess&&this._rescalePostProcess.dispose();this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();n.Instances.length===1&&n.audioEngine&&(n.audioEngine.dispose(),n.audioEngine=null),this.disableVR();let e=this.getHostWindow();e&&typeof e.removeEventListener=="function"&&(e.removeEventListener("blur",this._onBlur),e.removeEventListener("focus",this._onFocus)),this._renderingCanvas&&(this._renderingCanvas.removeEventListener("focus",this._onCanvasFocus),this._renderingCanvas.removeEventListener("blur",this._onCanvasBlur),this._renderingCanvas.removeEventListener("pointerout",this._onCanvasPointerOut),this._renderingCanvas.removeEventListener("contextmenu",this._onCanvasContextMenu)),Di()&&(document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.removeEventListener("pointerlockchange",this._onPointerLockChange),document.removeEventListener("mspointerlockchange",this._onPointerLockChange),document.removeEventListener("mozpointerlockchange",this._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange)),super.dispose();let i=n.Instances.indexOf(this);i>=0&&n.Instances.splice(i,1),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()}_disableTouchAction(){!this._renderingCanvas||!this._renderingCanvas.setAttribute||(this._renderingCanvas.setAttribute("touch-action","none"),this._renderingCanvas.style.touchAction="none",this._renderingCanvas.style.webkitTapHighlightColor="transparent")}displayLoadingUI(){if(!Oe())return;let e=this.loadingScreen;e&&e.displayLoadingUI()}hideLoadingUI(){if(!Oe())return;let e=this._loadingScreen;e&&e.hideLoadingUI()}get loadingScreen(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=n.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen}set loadingScreen(e){this._loadingScreen=e}set loadingUIText(e){this.loadingScreen.loadingUIText=e}set loadingUIBackgroundColor(e){this.loadingScreen.loadingUIBackgroundColor=e}createVideoElement(e){return document.createElement("video")}static _RequestPointerlock(e){e.requestPointerLock&&(e.requestPointerLock(),e.focus())}static _ExitPointerlock(){document.exitPointerLock&&document.exitPointerLock()}static _RequestFullscreen(e){let i=e.requestFullscreen||e.webkitRequestFullscreen;i&&i.call(e)}static _ExitFullscreen(){let e=document;document.exitFullscreen?document.exitFullscreen():e.webkitCancelFullScreen&&e.webkitCancelFullScreen()}getFontOffset(e){let i=document.createElement("span");i.innerHTML="Hg",i.setAttribute("style",`font: ${e} !important`);let s=document.createElement("div");s.style.display="inline-block",s.style.width="1px",s.style.height="0px",s.style.verticalAlign="bottom";let r=document.createElement("div");r.style.whiteSpace="nowrap",r.appendChild(i),r.appendChild(s),document.body.appendChild(r);let a=0,o=0;try{o=s.getBoundingClientRect().top-i.getBoundingClientRect().top,s.style.verticalAlign="baseline",a=s.getBoundingClientRect().top-i.getBoundingClientRect().top}finally{document.body.removeChild(r)}return{ascent:a,height:o,descent:o-a}}}return n.ALPHA_DISABLE=0,n.ALPHA_ADD=1,n.ALPHA_COMBINE=2,n.ALPHA_SUBTRACT=3,n.ALPHA_MULTIPLY=4,n.ALPHA_MAXIMIZED=5,n.ALPHA_ONEONE=6,n.ALPHA_PREMULTIPLIED=7,n.ALPHA_PREMULTIPLIED_PORTERDUFF=8,n.ALPHA_INTERPOLATE=9,n.ALPHA_SCREENMODE=10,n.DELAYLOADSTATE_NONE=0,n.DELAYLOADSTATE_LOADED=1,n.DELAYLOADSTATE_LOADING=2,n.DELAYLOADSTATE_NOTLOADED=4,n.NEVER=512,n.ALWAYS=519,n.LESS=513,n.EQUAL=514,n.LEQUAL=515,n.GREATER=516,n.GEQUAL=518,n.NOTEQUAL=517,n.KEEP=7680,n.REPLACE=7681,n.INCR=7682,n.DECR=7683,n.INVERT=5386,n.INCR_WRAP=34055,n.DECR_WRAP=34056,n.TEXTURE_CLAMP_ADDRESSMODE=0,n.TEXTURE_WRAP_ADDRESSMODE=1,n.TEXTURE_MIRROR_ADDRESSMODE=2,n.TEXTUREFORMAT_ALPHA=0,n.TEXTUREFORMAT_LUMINANCE=1,n.TEXTUREFORMAT_LUMINANCE_ALPHA=2,n.TEXTUREFORMAT_RGB=4,n.TEXTUREFORMAT_RGBA=5,n.TEXTUREFORMAT_RED=6,n.TEXTUREFORMAT_R=6,n.TEXTUREFORMAT_RG=7,n.TEXTUREFORMAT_RED_INTEGER=8,n.TEXTUREFORMAT_R_INTEGER=8,n.TEXTUREFORMAT_RG_INTEGER=9,n.TEXTUREFORMAT_RGB_INTEGER=10,n.TEXTUREFORMAT_RGBA_INTEGER=11,n.TEXTURETYPE_UNSIGNED_BYTE=0,n.TEXTURETYPE_UNSIGNED_INT=0,n.TEXTURETYPE_FLOAT=1,n.TEXTURETYPE_HALF_FLOAT=2,n.TEXTURETYPE_BYTE=3,n.TEXTURETYPE_SHORT=4,n.TEXTURETYPE_UNSIGNED_SHORT=5,n.TEXTURETYPE_INT=6,n.TEXTURETYPE_UNSIGNED_INTEGER=7,n.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,n.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,n.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,n.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,n.TEXTURETYPE_UNSIGNED_INT_24_8=12,n.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,n.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,n.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,n.TEXTURE_NEAREST_SAMPLINGMODE=1,n.TEXTURE_BILINEAR_SAMPLINGMODE=2,n.TEXTURE_TRILINEAR_SAMPLINGMODE=3,n.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,n.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,n.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,n.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,n.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,n.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,n.TEXTURE_NEAREST_LINEAR=7,n.TEXTURE_NEAREST_NEAREST=1,n.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,n.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,n.TEXTURE_LINEAR_LINEAR=2,n.TEXTURE_LINEAR_NEAREST=12,n.TEXTURE_EXPLICIT_MODE=0,n.TEXTURE_SPHERICAL_MODE=1,n.TEXTURE_PLANAR_MODE=2,n.TEXTURE_CUBIC_MODE=3,n.TEXTURE_PROJECTION_MODE=4,n.TEXTURE_SKYBOX_MODE=5,n.TEXTURE_INVCUBIC_MODE=6,n.TEXTURE_EQUIRECTANGULAR_MODE=7,n.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,n.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,n.SCALEMODE_FLOOR=1,n.SCALEMODE_NEAREST=2,n.SCALEMODE_CEILING=3,n._RescalePostProcessFactory=null,n._RenderPassIdCounter=0,n})();le.prototype._debugPushGroup=function(n,t){};le.prototype._debugPopGroup=function(n){};le.prototype._debugInsertMarker=function(n,t){};le.prototype._debugFlushPendingCommands=function(){};function Zn(n){return new de(n,!0,{preserveDrawingBuffer:!0,stencil:!0})}var me=class n{constructor(t=0,e=0,i=0){this.r=t,this.g=e,this.b=i}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"}getClassName(){return"Color3"}getHashCode(){let t=this.r*255|0;return t=t*397^(this.g*255|0),t=t*397^(this.b*255|0),t}toArray(t,e=0){return t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,this}fromArray(t,e=0){return n.FromArrayToRef(t,e,this),this}toColor4(t=1){return new ie(this.r,this.g,this.b,t)}asArray(){return[this.r,this.g,this.b]}toLuminance(){return this.r*.3+this.g*.59+this.b*.11}multiply(t){return new n(this.r*t.r,this.g*t.g,this.b*t.b)}multiplyToRef(t,e){return e.r=this.r*t.r,e.g=this.g*t.g,e.b=this.b*t.b,this}equals(t){return t&&this.r===t.r&&this.g===t.g&&this.b===t.b}equalsFloats(t,e,i){return this.r===t&&this.g===e&&this.b===i}scale(t){return new n(this.r*t,this.g*t,this.b*t)}scaleInPlace(t){return this.r*=t,this.g*=t,this.b*=t,this}scaleToRef(t,e){return e.r=this.r*t,e.g=this.g*t,e.b=this.b*t,this}scaleAndAddToRef(t,e){return e.r+=this.r*t,e.g+=this.g*t,e.b+=this.b*t,this}clampToRef(t=0,e=1,i){return i.r=J.Clamp(this.r,t,e),i.g=J.Clamp(this.g,t,e),i.b=J.Clamp(this.b,t,e),this}add(t){return new n(this.r+t.r,this.g+t.g,this.b+t.b)}addToRef(t,e){return e.r=this.r+t.r,e.g=this.g+t.g,e.b=this.b+t.b,this}subtract(t){return new n(this.r-t.r,this.g-t.g,this.b-t.b)}subtractToRef(t,e){return e.r=this.r-t.r,e.g=this.g-t.g,e.b=this.b-t.b,this}clone(){return new n(this.r,this.g,this.b)}copyFrom(t){return this.r=t.r,this.g=t.g,this.b=t.b,this}copyFromFloats(t,e,i){return this.r=t,this.g=e,this.b=i,this}set(t,e,i){return this.copyFromFloats(t,e,i)}toHexString(){let t=Math.round(this.r*255),e=Math.round(this.g*255),i=Math.round(this.b*255);return"#"+J.ToHex(t)+J.ToHex(e)+J.ToHex(i)}toLinearSpace(){let t=new n;return this.toLinearSpaceToRef(t),t}toHSV(){let t=new n;return this.toHSVToRef(t),t}toHSVToRef(t){let e=this.r,i=this.g,s=this.b,r=Math.max(e,i,s),a=Math.min(e,i,s),o=0,h=0,l=r,c=r-a;r!==0&&(h=c/r),r!=a&&(r==e?(o=(i-s)/c,i<s&&(o+=6)):r==i?o=(s-e)/c+2:r==s&&(o=(e-i)/c+4),o*=60),t.r=o,t.g=h,t.b=l}toLinearSpaceToRef(t){return t.r=Math.pow(this.r,ai),t.g=Math.pow(this.g,ai),t.b=Math.pow(this.b,ai),this}toGammaSpace(){let t=new n;return this.toGammaSpaceToRef(t),t}toGammaSpaceToRef(t){return t.r=Math.pow(this.r,ni),t.g=Math.pow(this.g,ni),t.b=Math.pow(this.b,ni),this}static HSVtoRGBToRef(t,e,i,s){let r=i*e,a=t/60,o=r*(1-Math.abs(a%2-1)),h=0,l=0,c=0;a>=0&&a<=1?(h=r,l=o):a>=1&&a<=2?(h=o,l=r):a>=2&&a<=3?(l=r,c=o):a>=3&&a<=4?(l=o,c=r):a>=4&&a<=5?(h=o,c=r):a>=5&&a<=6&&(h=r,c=o);let d=i-r;s.set(h+d,l+d,c+d)}static FromHSV(t,e,i){let s=new n(0,0,0);return n.HSVtoRGBToRef(t,e,i,s),s}static FromHexString(t){if(t.substring(0,1)!=="#"||t.length!==7)return new n(0,0,0);let e=parseInt(t.substring(1,3),16),i=parseInt(t.substring(3,5),16),s=parseInt(t.substring(5,7),16);return n.FromInts(e,i,s)}static FromArray(t,e=0){return new n(t[e],t[e+1],t[e+2])}static FromArrayToRef(t,e=0,i){i.r=t[e],i.g=t[e+1],i.b=t[e+2]}static FromInts(t,e,i){return new n(t/255,e/255,i/255)}static Lerp(t,e,i){let s=new n(0,0,0);return n.LerpToRef(t,e,i,s),s}static LerpToRef(t,e,i,s){s.r=t.r+(e.r-t.r)*i,s.g=t.g+(e.g-t.g)*i,s.b=t.b+(e.b-t.b)*i}static Hermite(t,e,i,s,r){let a=r*r,o=r*a,h=2*o-3*a+1,l=-2*o+3*a,c=o-2*a+r,d=o-a,u=t.r*h+i.r*l+e.r*c+s.r*d,f=t.g*h+i.g*l+e.g*c+s.g*d,_=t.b*h+i.b*l+e.b*c+s.b*d;return new n(u,f,_)}static Hermite1stDerivative(t,e,i,s,r){let a=n.Black();return this.Hermite1stDerivativeToRef(t,e,i,s,r,a),a}static Hermite1stDerivativeToRef(t,e,i,s,r,a){let o=r*r;a.r=(o-r)*6*t.r+(3*o-4*r+1)*e.r+(-o+r)*6*i.r+(3*o-2*r)*s.r,a.g=(o-r)*6*t.g+(3*o-4*r+1)*e.g+(-o+r)*6*i.g+(3*o-2*r)*s.g,a.b=(o-r)*6*t.b+(3*o-4*r+1)*e.b+(-o+r)*6*i.b+(3*o-2*r)*s.b}static Red(){return new n(1,0,0)}static Green(){return new n(0,1,0)}static Blue(){return new n(0,0,1)}static Black(){return new n(0,0,0)}static get BlackReadOnly(){return n._BlackReadOnly}static White(){return new n(1,1,1)}static Purple(){return new n(.5,0,.5)}static Magenta(){return new n(1,0,1)}static Yellow(){return new n(1,1,0)}static Gray(){return new n(.5,.5,.5)}static Teal(){return new n(0,1,1)}static Random(){return new n(Math.random(),Math.random(),Math.random())}};me._BlackReadOnly=me.Black();var ie=class{constructor(n=0,t=0,e=0,i=1){this.r=n,this.g=t,this.b=e,this.a=i}addInPlace(n){return this.r+=n.r,this.g+=n.g,this.b+=n.b,this.a+=n.a,this}asArray(){return[this.r,this.g,this.b,this.a]}toArray(n,t=0){return n[t]=this.r,n[t+1]=this.g,n[t+2]=this.b,n[t+3]=this.a,this}fromArray(n,t=0){return ie.FromArrayToRef(n,t,this),this}equals(n){return n&&this.r===n.r&&this.g===n.g&&this.b===n.b&&this.a===n.a}add(n){return new ie(this.r+n.r,this.g+n.g,this.b+n.b,this.a+n.a)}subtract(n){return new ie(this.r-n.r,this.g-n.g,this.b-n.b,this.a-n.a)}subtractToRef(n,t){return t.r=this.r-n.r,t.g=this.g-n.g,t.b=this.b-n.b,t.a=this.a-n.a,this}scale(n){return new ie(this.r*n,this.g*n,this.b*n,this.a*n)}scaleInPlace(n){return this.r*=n,this.g*=n,this.b*=n,this.a*=n,this}scaleToRef(n,t){return t.r=this.r*n,t.g=this.g*n,t.b=this.b*n,t.a=this.a*n,this}scaleAndAddToRef(n,t){return t.r+=this.r*n,t.g+=this.g*n,t.b+=this.b*n,t.a+=this.a*n,this}clampToRef(n=0,t=1,e){return e.r=J.Clamp(this.r,n,t),e.g=J.Clamp(this.g,n,t),e.b=J.Clamp(this.b,n,t),e.a=J.Clamp(this.a,n,t),this}multiply(n){return new ie(this.r*n.r,this.g*n.g,this.b*n.b,this.a*n.a)}multiplyToRef(n,t){return t.r=this.r*n.r,t.g=this.g*n.g,t.b=this.b*n.b,t.a=this.a*n.a,t}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"}getClassName(){return"Color4"}getHashCode(){let n=this.r*255|0;return n=n*397^(this.g*255|0),n=n*397^(this.b*255|0),n=n*397^(this.a*255|0),n}clone(){return new ie(this.r,this.g,this.b,this.a)}copyFrom(n){return this.r=n.r,this.g=n.g,this.b=n.b,this.a=n.a,this}copyFromFloats(n,t,e,i){return this.r=n,this.g=t,this.b=e,this.a=i,this}set(n,t,e,i){return this.copyFromFloats(n,t,e,i)}toHexString(n=!1){let t=Math.round(this.r*255),e=Math.round(this.g*255),i=Math.round(this.b*255);if(n)return"#"+J.ToHex(t)+J.ToHex(e)+J.ToHex(i);let s=Math.round(this.a*255);return"#"+J.ToHex(t)+J.ToHex(e)+J.ToHex(i)+J.ToHex(s)}toLinearSpace(){let n=new ie;return this.toLinearSpaceToRef(n),n}toLinearSpaceToRef(n){return n.r=Math.pow(this.r,ai),n.g=Math.pow(this.g,ai),n.b=Math.pow(this.b,ai),n.a=this.a,this}toGammaSpace(){let n=new ie;return this.toGammaSpaceToRef(n),n}toGammaSpaceToRef(n){return n.r=Math.pow(this.r,ni),n.g=Math.pow(this.g,ni),n.b=Math.pow(this.b,ni),n.a=this.a,this}static FromHexString(n){if(n.substring(0,1)!=="#"||n.length!==9&&n.length!==7)return new ie(0,0,0,0);let t=parseInt(n.substring(1,3),16),e=parseInt(n.substring(3,5),16),i=parseInt(n.substring(5,7),16),s=n.length===9?parseInt(n.substring(7,9),16):255;return ie.FromInts(t,e,i,s)}static Lerp(n,t,e){let i=new ie(0,0,0,0);return ie.LerpToRef(n,t,e,i),i}static LerpToRef(n,t,e,i){i.r=n.r+(t.r-n.r)*e,i.g=n.g+(t.g-n.g)*e,i.b=n.b+(t.b-n.b)*e,i.a=n.a+(t.a-n.a)*e}static Hermite(n,t,e,i,s){let r=s*s,a=s*r,o=2*a-3*r+1,h=-2*a+3*r,l=a-2*r+s,c=a-r,d=n.r*o+e.r*h+t.r*l+i.r*c,u=n.g*o+e.g*h+t.g*l+i.g*c,f=n.b*o+e.b*h+t.b*l+i.b*c,_=n.a*o+e.a*h+t.a*l+i.a*c;return new ie(d,u,f,_)}static Hermite1stDerivative(n,t,e,i,s){let r=new ie;return this.Hermite1stDerivativeToRef(n,t,e,i,s,r),r}static Hermite1stDerivativeToRef(n,t,e,i,s,r){let a=s*s;r.r=(a-s)*6*n.r+(3*a-4*s+1)*t.r+(-a+s)*6*e.r+(3*a-2*s)*i.r,r.g=(a-s)*6*n.g+(3*a-4*s+1)*t.g+(-a+s)*6*e.g+(3*a-2*s)*i.g,r.b=(a-s)*6*n.b+(3*a-4*s+1)*t.b+(-a+s)*6*e.b+(3*a-2*s)*i.b,r.a=(a-s)*6*n.a+(3*a-4*s+1)*t.a+(-a+s)*6*e.a+(3*a-2*s)*i.a}static FromColor3(n,t=1){return new ie(n.r,n.g,n.b,t)}static FromArray(n,t=0){return new ie(n[t],n[t+1],n[t+2],n[t+3])}static FromArrayToRef(n,t=0,e){e.r=n[t],e.g=n[t+1],e.b=n[t+2],e.a=n[t+3]}static FromInts(n,t,e,i){return new ie(n/255,t/255,e/255,i/255)}static CheckColors4(n,t){if(n.length===t*3){let e=[];for(let i=0;i<n.length;i+=3){let s=i/3*4;e[s]=n[i],e[s+1]=n[i+1],e[s+2]=n[i+2],e[s+3]=1}return e}return n}},Vt=class{};Vt.Color3=we.BuildArray(3,me.Black);Vt.Color4=we.BuildArray(3,()=>new ie(0,0,0,0));Ye("BABYLON.Color3",me);Ye("BABYLON.Color4",ie);var tn=(n,t)=>!n||n.getClassName&&n.getClassName()==="Mesh"?null:n.getClassName&&n.getClassName()==="SubMesh"?n.clone(t):n.clone?n.clone():null;function Qn(n){let t=[];do Object.getOwnPropertyNames(n).forEach(function(e){t.indexOf(e)===-1&&t.push(e)});while(n=Object.getPrototypeOf(n));return t}var Fi=class{static DeepCopy(t,e,i,s){let r=Qn(t);for(let a of r){if(a[0]==="_"&&(!s||s.indexOf(a)===-1)||a.endsWith("Observable")||i&&i.indexOf(a)!==-1)continue;let o=t[a],h=typeof o;if(h!=="function")try{if(h==="object")if(o instanceof Array){if(e[a]=[],o.length>0)if(typeof o[0]=="object")for(let l=0;l<o.length;l++){let c=tn(o[l],e);e[a].indexOf(c)===-1&&e[a].push(c)}else e[a]=o.slice(0)}else e[a]=tn(o,e);else e[a]=o}catch(l){O.Warn(l.message)}}}};function $n(){return typeof _native<"u"&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest}var Ft=class n{constructor(){this._xhr=$n(),this._requestURL=""}_injectCustomRequestHeaders(){if(!this._shouldSkipRequestModifications(this._requestURL))for(let t in n.CustomRequestHeaders){let e=n.CustomRequestHeaders[t];e&&this._xhr.setRequestHeader(t,e)}}_shouldSkipRequestModifications(t){return n.SkipRequestModificationForBabylonCDN&&(t.includes("preview.babylonjs.com")||t.includes("cdn.babylonjs.com"))}get onprogress(){return this._xhr.onprogress}set onprogress(t){this._xhr.onprogress=t}get readyState(){return this._xhr.readyState}get status(){return this._xhr.status}get statusText(){return this._xhr.statusText}get response(){return this._xhr.response}get responseURL(){return this._xhr.responseURL}get responseText(){return this._xhr.responseText}get responseType(){return this._xhr.responseType}set responseType(t){this._xhr.responseType=t}get timeout(){return this._xhr.timeout}set timeout(t){this._xhr.timeout=t}addEventListener(t,e,i){this._xhr.addEventListener(t,e,i)}removeEventListener(t,e,i){this._xhr.removeEventListener(t,e,i)}abort(){this._xhr.abort()}send(t){n.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(t)}open(t,e){for(let i of n.CustomRequestModifiers){if(this._shouldSkipRequestModifications(e))return;i(this._xhr,e)}return e=e.replace("file:http:","http:"),e=e.replace("file:https:","https:"),this._requestURL=e,this._xhr.open(t,e,!0)}setRequestHeader(t,e){this._xhr.setRequestHeader(t,e)}getResponseHeader(t){return this._xhr.getResponseHeader(t)}};Ft.CustomRequestHeaders={};Ft.CustomRequestModifiers=new Array;Ft.SkipRequestModificationForBabylonCDN=!0;var Qi=(()=>{class n{}return n.FilesToLoad={},n})(),rr=class{static ExponentialBackoff(t=3,e=500){return(i,s,r)=>s.status!==0||r>=t||i.indexOf("file:")!==-1?-1:Math.pow(2,r)*e}},zt=class extends Error{};zt._setPrototypeOf=Object.setPrototypeOf||((n,t)=>(n.__proto__=t,n));var qt={MeshInvalidPositionsError:0,UnsupportedTextureError:1e3,GLTFLoaderUnexpectedMagicError:2e3,SceneLoaderError:3e3,LoadFileError:4e3,RequestFileError:4001,ReadFileError:4002},Dt=class n extends zt{constructor(t,e,i){super(t),this.errorCode=e,this.innerError=i,this.name="RuntimeError",zt._setPrototypeOf(this,n.prototype)}},bn=n=>{let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",e="",i,s,r,a,o,h,l,c=0,d=ArrayBuffer.isView(n)?new Uint8Array(n.buffer,n.byteOffset,n.byteLength):new Uint8Array(n);for(;c<d.length;)i=d[c++],s=c<d.length?d[c++]:Number.NaN,r=c<d.length?d[c++]:Number.NaN,a=i>>2,o=(i&3)<<4|s>>4,h=(s&15)<<2|r>>6,l=r&63,isNaN(s)?h=l=64:isNaN(r)&&(l=64),e+=t.charAt(a)+t.charAt(o)+t.charAt(h)+t.charAt(l);return e},xn=n=>atob(n),Jn=n=>{let t=xn(n),e=t.length,i=new Uint8Array(new ArrayBuffer(e));for(let s=0;s<e;s++)i[s]=t.charCodeAt(s);return i.buffer},ci=class{static SetImmediate(t){Oe()&&window.setImmediate?window.setImmediate(t):setTimeout(t,1)}},Mn=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i),rs=class n extends Dt{constructor(t,e){super(t,qt.LoadFileError),this.name="LoadFileError",zt._setPrototypeOf(this,n.prototype),e instanceof Ft?this.request=e:this.file=e}},ns=class n extends Dt{constructor(t,e){super(t,qt.RequestFileError),this.request=e,this.name="RequestFileError",zt._setPrototypeOf(this,n.prototype)}},nr=class n extends Dt{constructor(t,e){super(t,qt.ReadFileError),this.file=e,this.name="ReadFileError",zt._setPrototypeOf(this,n.prototype)}},De={DefaultRetryStrategy:rr.ExponentialBackoff(),BaseUrl:"",CorsBehavior:"anonymous",PreprocessUrl:n=>n},An=n=>(n=n.replace(/#/gm,"%23"),n),Hr=(n,t)=>{if(!(n&&n.indexOf("data:")===0)&&De.CorsBehavior)if(typeof De.CorsBehavior=="string"||De.CorsBehavior instanceof String)t.crossOrigin=De.CorsBehavior;else{let e=De.CorsBehavior(n);e&&(t.crossOrigin=e)}},Kr=(n,t,e,i,s="",r)=>{var a;let o,h=!1;n instanceof ArrayBuffer||ArrayBuffer.isView(n)?typeof Blob<"u"&&typeof URL<"u"?(o=URL.createObjectURL(new Blob([n],{type:s})),h=!0):o=`data:${s};base64,`+bn(n):n instanceof Blob?(o=URL.createObjectURL(n),h=!0):(o=An(n),o=De.PreprocessUrl(n));let l=Q.LastCreatedEngine,c=b=>{if(e){let x=o||n.toString();e(`Error while trying to load image: ${x.indexOf("http")===0||x.length<=128?x:x.slice(0,128)+"..."}`,b)}};if(typeof Image>"u"||(a=l?._features.forceBitmapOverHTMLImageElement)!==null&&a!==void 0&&a)return Xt(o,b=>{l.createImageBitmap(new Blob([b],{type:s}),Xe({premultiplyAlpha:"none"},r)).then(x=>{t(x),h&&URL.revokeObjectURL(o)}).catch(x=>{e&&e("Error while trying to load image: "+n,x)})},void 0,i||void 0,!0,(b,x)=>{c(x)}),null;let d=new Image;Hr(o,d);let u=[],f=()=>{u.forEach(b=>{b.target.addEventListener(b.name,b.handler)})},_=()=>{u.forEach(b=>{b.target.removeEventListener(b.name,b.handler)}),u.length=0},g=()=>{_(),t(d),h&&d.src&&URL.revokeObjectURL(d.src)},p=b=>{_(),c(b),h&&d.src&&URL.revokeObjectURL(d.src)},E=b=>{_();let x=new Error(`CSP violation of policy ${b.effectiveDirective} ${b.blockedURI}. Current policy is ${b.originalPolicy}`);Q.UseFallbackTexture=!1,c(x),h&&d.src&&URL.revokeObjectURL(d.src),d.src=""};u.push({target:d,name:"load",handler:g}),u.push({target:d,name:"error",handler:p}),u.push({target:document,name:"securitypolicyviolation",handler:E}),f();let T=o.substring(0,5)==="blob:",R=o.substring(0,5)==="data:",y=()=>{T||R?d.src=o:Xt(o,(b,x,F)=>{let I=!s&&F?F:s,N=new Blob([b],{type:I}),G=URL.createObjectURL(N);h=!0,d.src=G},void 0,i||void 0,!0,(b,x)=>{c(x)})},M=()=>{i&&i.loadImage(o,d)};if(!T&&!R&&i&&i.enableTexturesOffline)i.open(M,y);else{if(o.indexOf("file:")!==-1){let b=decodeURIComponent(o.substring(5).toLowerCase());if(Qi.FilesToLoad[b]&&typeof URL<"u"){try{let x;try{x=URL.createObjectURL(Qi.FilesToLoad[b])}catch{x=URL.createObjectURL(Qi.FilesToLoad[b])}d.src=x,h=!0}catch{d.src=""}return d}}y()}return d},wi=(n,t,e,i,s)=>{let r=new FileReader,a={onCompleteObservable:new D,abort:()=>r.abort()};return r.onloadend=()=>a.onCompleteObservable.notifyObservers(a),s&&(r.onerror=()=>{s(new nr(`Unable to read ${n.name}`,n))}),r.onload=o=>{t(o.target.result)},e&&(r.onprogress=e),i?r.readAsArrayBuffer(n):r.readAsText(n),a},Xt=(n,t,e,i,s,r,a)=>{if(n.name)return wi(n,t,e,s,r?c=>{r(void 0,c)}:void 0);let o=n;if(o.indexOf("file:")!==-1){let c=decodeURIComponent(o.substring(5).toLowerCase());c.indexOf("./")===0&&(c=c.substring(2));let d=Qi.FilesToLoad[c];if(d)return wi(d,t,e,s,r?u=>r(void 0,new rs(u.message,u.file)):void 0)}let{match:h,type:l}=ea(o);if(h){let c={onCompleteObservable:new D,abort:()=>()=>{}};try{let d=s?qr(o):yn(o);t(d,void 0,l)}catch(d){r?r(void 0,d):O.Error(d.message||"Failed to parse the Data URL")}return ci.SetImmediate(()=>{c.onCompleteObservable.notifyObservers(c)}),c}return Yr(o,(c,d)=>{t(c,d?.responseURL,d?.getResponseHeader("content-type"))},e,i,s,r?c=>{r(c.request,new rs(c.message,c.request))}:void 0,a)},Yr=(n,t,e,i,s,r,a)=>{n=An(n),n=De.PreprocessUrl(n);let o=De.BaseUrl+n,h=!1,l={onCompleteObservable:new D,abort:()=>h=!0},c=()=>{let d=new Ft,u=null,f,_=()=>{d&&(e&&d.removeEventListener("progress",e),f&&d.removeEventListener("readystatechange",f),d.removeEventListener("loadend",g))},g=()=>{_(),l.onCompleteObservable.notifyObservers(l),l.onCompleteObservable.clear(),e=void 0,f=null,g=null,r=void 0,a=void 0,t=void 0};l.abort=()=>{h=!0,g&&g(),d&&d.readyState!==(XMLHttpRequest.DONE||4)&&d.abort(),u!==null&&(clearTimeout(u),u=null),d=null};let p=T=>{let R=T.message||"Unknown error";r&&d?r(new ns(R,d)):O.Error(R)},E=T=>{if(d){if(d.open("GET",o),a)try{a(d)}catch(R){p(R);return}s&&(d.responseType="arraybuffer"),e&&d.addEventListener("progress",e),g&&d.addEventListener("loadend",g),f=()=>{if(!(h||!d)&&d.readyState===(XMLHttpRequest.DONE||4)){if(f&&d.removeEventListener("readystatechange",f),d.status>=200&&d.status<300||d.status===0&&(!Oe()||Rn())){try{t&&t(s?d.response:d.responseText,d)}catch(M){p(M)}return}let R=De.DefaultRetryStrategy;if(R){let M=R(o,d,T);if(M!==-1){_(),d=new Ft,u=setTimeout(()=>E(T+1),M);return}}let y=new ns("Error status: "+d.status+" "+d.statusText+" - Unable to load "+o,d);r&&r(y)}},d.addEventListener("readystatechange",f),d.send()}};E(0)};if(i&&i.enableSceneOffline){let d=f=>{f&&f.status>400?r&&r(f):c()},u=()=>{i&&i.loadFile(De.BaseUrl+n,f=>{!h&&t&&t(f),l.onCompleteObservable.notifyObservers(l)},e?f=>{!h&&e&&e(f)}:void 0,d,s)};i.open(u,d)}else c();return l},Rn=()=>typeof location<"u"&&location.protocol==="file:",jr=n=>Mn.test(n),ea=n=>{let t=Mn.exec(n);return t===null||t.length===0?{match:!1,type:""}:{match:!0,type:t[0].replace("data:","").replace("base64,","")}};function qr(n){return Jn(n.split(",")[1])}var yn=n=>xn(n.split(",")[1]),ta=()=>{le._FileToolsLoadImage=Kr,le._FileToolsLoadFile=Xt,Yt._FileToolsLoadFile=Xt};ta();var Ti,ia=(n,t,e,i,s,r,a,o,h,l)=>{Ti={DecodeBase64UrlToBinary:n,DecodeBase64UrlToString:t,DefaultRetryStrategy:e.DefaultRetryStrategy,BaseUrl:e.BaseUrl,CorsBehavior:e.CorsBehavior,PreprocessUrl:e.PreprocessUrl,IsBase64DataUrl:i,IsFileURL:s,LoadFile:r,LoadImage:a,ReadFile:o,RequestFile:h,SetCorsBehavior:l},Object.defineProperty(Ti,"DefaultRetryStrategy",{get:function(){return e.DefaultRetryStrategy},set:function(c){e.DefaultRetryStrategy=c}}),Object.defineProperty(Ti,"BaseUrl",{get:function(){return e.BaseUrl},set:function(c){e.BaseUrl=c}}),Object.defineProperty(Ti,"PreprocessUrl",{get:function(){return e.PreprocessUrl},set:function(c){e.PreprocessUrl=c}}),Object.defineProperty(Ti,"CorsBehavior",{get:function(){return e.CorsBehavior},set:function(c){e.CorsBehavior=c}})};ia(qr,yn,De,jr,Rn,Xt,Kr,wi,Yr,Hr);var $i=(()=>{class n{static Instantiate(e){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[e])return this.RegisteredExternalClasses[e];let i=Zt(e);if(i)return i;O.Warn(e+" not found, you may have missed an import.");let s=e.split("."),r=window||this;for(let a=0,o=s.length;a<o;a++)r=r[s[a]];return typeof r!="function"?null:r}}return n.RegisteredExternalClasses={},n})();function Cn(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{let t=Math.random()*16|0;return(n==="x"?t:t&3|8).toString(16)})}var Z=class n{static get BaseUrl(){return De.BaseUrl}static set BaseUrl(t){De.BaseUrl=t}static get DefaultRetryStrategy(){return De.DefaultRetryStrategy}static set DefaultRetryStrategy(t){De.DefaultRetryStrategy=t}static get CorsBehavior(){return De.CorsBehavior}static set CorsBehavior(t){De.CorsBehavior=t}static get UseFallbackTexture(){return Q.UseFallbackTexture}static set UseFallbackTexture(t){Q.UseFallbackTexture=t}static get RegisteredExternalClasses(){return $i.RegisteredExternalClasses}static set RegisteredExternalClasses(t){$i.RegisteredExternalClasses=t}static get fallbackTexture(){return Q.FallbackTexture}static set fallbackTexture(t){Q.FallbackTexture=t}static FetchToRef(t,e,i,s,r,a){let o=Math.abs(t)*i%i|0,h=Math.abs(e)*s%s|0,l=(o+h*i)*4;a.r=r[l]/255,a.g=r[l+1]/255,a.b=r[l+2]/255,a.a=r[l+3]/255}static Mix(t,e,i){return t*(1-i)+e*i}static Instantiate(t){return $i.Instantiate(t)}static SetImmediate(t){ci.SetImmediate(t)}static IsExponentOfTwo(t){let e=1;do e*=2;while(e<t);return e===t}static FloatRound(t){return Math.fround?Math.fround(t):(n._TmpFloatArray[0]=t,n._TmpFloatArray[0])}static GetFilename(t){let e=t.lastIndexOf("/");return e<0?t:t.substring(e+1)}static GetFolderPath(t,e=!1){let i=t.lastIndexOf("/");return i<0?e?t:"":t.substring(0,i+1)}static ToDegrees(t){return t*180/Math.PI}static ToRadians(t){return t*Math.PI/180}static SmoothAngleChange(t,e,i=.9){let s=this.ToRadians(t),r=this.ToRadians(e);return this.ToDegrees(Math.atan2((1-i)*Math.sin(r)+i*Math.sin(s),(1-i)*Math.cos(r)+i*Math.cos(s)))}static MakeArray(t,e){return e!==!0&&(t===void 0||t==null)?null:Array.isArray(t)?t:[t]}static GetPointerPrefix(t){let e="pointer";return Oe()&&!window.PointerEvent&&(e="mouse"),t._badDesktopOS&&!t._badOS&&!(document&&"ontouchend"in document)&&(e="mouse"),e}static SetCorsBehavior(t,e){Hr(t,e)}static SetReferrerPolicyBehavior(t,e){e.referrerPolicy=t}static CleanUrl(t){return t=t.replace(/#/gm,"%23"),t}static get PreprocessUrl(){return De.PreprocessUrl}static set PreprocessUrl(t){De.PreprocessUrl=t}static LoadImage(t,e,i,s,r,a){return Kr(t,e,i,s,r,a)}static LoadFile(t,e,i,s,r,a){return Xt(t,e,i,s,r,a)}static LoadFileAsync(t,e=!0){return new Promise((i,s)=>{Xt(t,r=>{i(r)},void 0,void 0,e,(r,a)=>{s(a)})})}static LoadScript(t,e,i,s){if(typeof importScripts=="function"){try{importScripts(t),e()}catch(o){i?.(`Unable to load script '${t}' in worker`,o)}return}else if(!Oe()){i?.(`Cannot load script '${t}' outside of a window or a worker`);return}let r=document.getElementsByTagName("head")[0],a=document.createElement("script");a.setAttribute("type","text/javascript"),a.setAttribute("src",t),s&&(a.id=s),a.onload=()=>{e&&e()},a.onerror=o=>{i&&i(`Unable to load script '${t}'`,o)},r.appendChild(a)}static LoadScriptAsync(t){return new Promise((e,i)=>{this.LoadScript(t,()=>{e()},(s,r)=>{i(r||new Error(s))})})}static ReadFileAsDataURL(t,e,i){let s=new FileReader,r={onCompleteObservable:new D,abort:()=>s.abort()};return s.onloadend=()=>{r.onCompleteObservable.notifyObservers(r)},s.onload=a=>{e(a.target.result)},s.onprogress=i,s.readAsDataURL(t),r}static ReadFile(t,e,i,s,r){return wi(t,e,i,s,r)}static FileAsURL(t){let e=new Blob([t]);return window.URL.createObjectURL(e)}static Format(t,e=2){return t.toFixed(e)}static DeepCopy(t,e,i,s){Fi.DeepCopy(t,e,i,s)}static IsEmpty(t){for(let e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}static RegisterTopRootEvents(t,e){for(let i=0;i<e.length;i++){let s=e[i];t.addEventListener(s.name,s.handler,!1);try{window.parent&&window.parent.addEventListener(s.name,s.handler,!1)}catch{}}}static UnregisterTopRootEvents(t,e){for(let i=0;i<e.length;i++){let s=e[i];t.removeEventListener(s.name,s.handler);try{t.parent&&t.parent.removeEventListener(s.name,s.handler)}catch{}}}static DumpFramebuffer(t,e,i,s,r="image/png",a){return Ne(this,null,function*(){throw H("DumpTools")})}static DumpData(t,e,i,s,r="image/png",a,o=!1,h=!1,l){throw H("DumpTools")}static DumpDataAsync(t,e,i,s="image/png",r,a=!1,o=!1,h){throw H("DumpTools")}static ToBlob(t,e,i="image/png",s){t.toBlob||(t.toBlob=function(r,a,o){setTimeout(()=>{let h=atob(this.toDataURL(a,o).split(",")[1]),l=h.length,c=new Uint8Array(l);for(let d=0;d<l;d++)c[d]=h.charCodeAt(d);r(new Blob([c]))})}),t.toBlob(function(r){e(r)},i,s)}static DownloadBlob(t,e){if("download"in document.createElement("a")){if(!e){let i=new Date;e="screenshot_"+((i.getFullYear()+"-"+(i.getMonth()+1)).slice(2)+"-"+i.getDate()+"_"+i.getHours()+"-"+("0"+i.getMinutes()).slice(-2))+".png"}n.Download(t,e)}else if(t&&typeof URL<"u"){let i=URL.createObjectURL(t),s=window.open("");if(!s)return;let r=s.document.createElement("img");r.onload=function(){URL.revokeObjectURL(i)},r.src=i,s.document.body.appendChild(r)}}static EncodeScreenshotCanvasData(t,e,i="image/png",s,r){if(e){let a=t.toDataURL(i,r);e(a)}else this.ToBlob(t,function(a){a&&n.DownloadBlob(a,s)},i,r)}static Download(t,e){if(typeof URL>"u")return;let i=window.URL.createObjectURL(t),s=document.createElement("a");document.body.appendChild(s),s.style.display="none",s.href=i,s.download=e,s.addEventListener("click",()=>{s.parentElement&&s.parentElement.removeChild(s)}),s.click(),window.URL.revokeObjectURL(i)}static BackCompatCameraNoPreventDefault(t){return typeof t[0]=="boolean"?t[0]:typeof t[1]=="boolean"?t[1]:!1}static CreateScreenshot(t,e,i,s,r="image/png"){throw H("ScreenshotTools")}static CreateScreenshotAsync(t,e,i,s="image/png"){throw H("ScreenshotTools")}static CreateScreenshotUsingRenderTarget(t,e,i,s,r="image/png",a=1,o=!1,h){throw H("ScreenshotTools")}static CreateScreenshotUsingRenderTargetAsync(t,e,i,s="image/png",r=1,a=!1,o){throw H("ScreenshotTools")}static RandomId(){return Cn()}static IsBase64(t){return jr(t)}static DecodeBase64(t){return qr(t)}static get errorsCount(){return O.errorsCount}static Log(t){O.Log(t)}static Warn(t){O.Warn(t)}static Error(t){O.Error(t)}static get LogCache(){return O.LogCache}static ClearLogCache(){O.ClearLogCache()}static set LogLevels(t){O.LogLevels=t}static set PerformanceLogLevel(t){if((t&n.PerformanceUserMarkLogLevel)===n.PerformanceUserMarkLogLevel){n.StartPerformanceCounter=n._StartUserMark,n.EndPerformanceCounter=n._EndUserMark;return}if((t&n.PerformanceConsoleLogLevel)===n.PerformanceConsoleLogLevel){n.StartPerformanceCounter=n._StartPerformanceConsole,n.EndPerformanceCounter=n._EndPerformanceConsole;return}n.StartPerformanceCounter=n._StartPerformanceCounterDisabled,n.EndPerformanceCounter=n._EndPerformanceCounterDisabled}static _StartPerformanceCounterDisabled(t,e){}static _EndPerformanceCounterDisabled(t,e){}static _StartUserMark(t,e=!0){if(!n._Performance){if(!Oe())return;n._Performance=window.performance}!e||!n._Performance.mark||n._Performance.mark(t+"-Begin")}static _EndUserMark(t,e=!0){!e||!n._Performance.mark||(n._Performance.mark(t+"-End"),n._Performance.measure(t,t+"-Begin",t+"-End"))}static _StartPerformanceConsole(t,e=!0){e&&(n._StartUserMark(t,e),console.time&&console.time(t))}static _EndPerformanceConsole(t,e=!0){e&&(n._EndUserMark(t,e),console.timeEnd(t))}static get Now(){return Pt.Now}static GetClassName(t,e=!1){let i=null;return!e&&t.getClassName?i=t.getClassName():(t instanceof Object&&(i=(e?t:Object.getPrototypeOf(t)).constructor.__bjsclassName__),i||(i=typeof t)),i}static First(t,e){for(let i of t)if(e(i))return i;return null}static getFullClassName(t,e=!1){let i=null,s=null;if(!e&&t.getClassName)i=t.getClassName();else{if(t instanceof Object){let r=e?t:Object.getPrototypeOf(t);i=r.constructor.__bjsclassName__,s=r.constructor.__bjsmoduleName__}i||(i=typeof t)}return i?(s!=null?s+".":"")+i:null}static DelayAsync(t){return new Promise(e=>{setTimeout(()=>{e()},t)})}static IsSafari(){return Tn()?/^((?!chrome|android).)*safari/i.test(navigator.userAgent):!1}};Z.UseCustomRequestHeaders=!1;Z.CustomRequestHeaders=Ft.CustomRequestHeaders;Z._TmpFloatArray=new Float32Array(1);Z.GetDOMTextContent=Xr;Z.GetAbsoluteUrl=typeof document=="object"?n=>{let t=document.createElement("a");return t.href=n,t.href}:typeof URL=="function"&&typeof location=="object"?n=>new URL(n,location.origin).href:()=>{throw new Error("Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.")};Z.NoneLogLevel=O.NoneLogLevel;Z.MessageLogLevel=O.MessageLogLevel;Z.WarningLogLevel=O.WarningLogLevel;Z.ErrorLogLevel=O.ErrorLogLevel;Z.AllLogLevel=O.AllLogLevel;Z.IsWindowObjectExist=Oe;Z.PerformanceNoneLogLevel=0;Z.PerformanceUserMarkLogLevel=1;Z.PerformanceConsoleLogLevel=2;Z.StartPerformanceCounter=Z._StartPerformanceCounterDisabled;Z.EndPerformanceCounter=Z._EndPerformanceCounterDisabled;var ar=class n{constructor(t,e,i,s=0){this.iterations=t,this.index=s-1,this._done=!1,this._fn=e,this._successCallback=i}executeNext(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())}breakLoop(){this._done=!0,this._successCallback()}static Run(t,e,i,s=0){let r=new n(t,e,i,s);return r.executeNext(),r}static SyncAsyncForLoop(t,e,i,s,r,a=0){return n.Run(Math.ceil(t/e),o=>{r&&r()?o.breakLoop():setTimeout(()=>{for(let h=0;h<e;++h){let l=o.index*e+h;if(l>=t)break;if(i(l),r&&r()){o.breakLoop();break}}o.executeNext()},a)},s)}};Q.FallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z";var Ze=(()=>{class n{constructor(e){this.length=0,this.data=new Array(e),this._id=n._GlobalId++}push(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)}forEach(e){for(let i=0;i<this.length;i++)e(this.data[i])}sort(e){this.data.sort(e)}reset(){this.length=0}dispose(){this.reset(),this.data&&(this.data.length=0)}concat(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let i=0;i<e.length;i++)this.data[this.length++]=(e.data||e)[i]}}indexOf(e){let i=this.data.indexOf(e);return i>=this.length?-1:i}contains(e){return this.indexOf(e)!==-1}}return n._GlobalId=0,n})(),Ct=class extends Ze{constructor(){super(...arguments),this._duplicateId=0}push(t){super.push(t),t.__smartArrayFlags||(t.__smartArrayFlags={}),t.__smartArrayFlags[this._id]=this._duplicateId}pushNoDuplicate(t){return t.__smartArrayFlags&&t.__smartArrayFlags[this._id]===this._duplicateId?!1:(this.push(t),!0)}reset(){super.reset(),this._duplicateId++}concatWithNoDuplicate(t){if(t.length!==0){this.length+t.length>this.data.length&&(this.data.length=(this.length+t.length)*2);for(let e=0;e<t.length;e++){let i=(t.data||t)[e];this.pushNoDuplicate(i)}}}},as=class{constructor(){this._count=0,this._data={}}copyFrom(t){this.clear(),t.forEach((e,i)=>this.add(e,i))}get(t){let e=this._data[t];if(e!==void 0)return e}getOrAddWithFactory(t,e){let i=this.get(t);return i!==void 0||(i=e(t),i&&this.add(t,i)),i}getOrAdd(t,e){let i=this.get(t);return i!==void 0?i:(this.add(t,e),e)}contains(t){return this._data[t]!==void 0}add(t,e){return this._data[t]!==void 0?!1:(this._data[t]=e,++this._count,!0)}set(t,e){return this._data[t]===void 0?!1:(this._data[t]=e,!0)}getAndRemove(t){let e=this.get(t);return e!==void 0?(delete this._data[t],--this._count,e):null}remove(t){return this.contains(t)?(delete this._data[t],--this._count,!0):!1}clear(){this._data={},this._count=0}get count(){return this._count}forEach(t){for(let e in this._data){let i=this._data[e];t(e,i)}}first(t){for(let e in this._data){let i=this._data[e],s=t(e,i);if(s)return s}return null}},or=class n{static Eval(t,e){return t.match(/\([^()]*\)/g)?t=t.replace(/\([^()]*\)/g,i=>(i=i.slice(1,i.length-1),n._HandleParenthesisContent(i,e))):t=n._HandleParenthesisContent(t,e),t==="true"?!0:t==="false"?!1:n.Eval(t,e)}static _HandleParenthesisContent(t,e){e=e||(r=>r==="true");let i,s=t.split("||");for(let r in s)if(Object.prototype.hasOwnProperty.call(s,r)){let a=n._SimplifyNegation(s[r].trim()),o=a.split("&&");if(o.length>1)for(let h=0;h<o.length;++h){let l=n._SimplifyNegation(o[h].trim());if(l!=="true"&&l!=="false"?l[0]==="!"?i=!e(l.substring(1)):i=e(l):i=l==="true",!i){a="false";break}}if(i||a==="true"){i=!0;break}a!=="true"&&a!=="false"?a[0]==="!"?i=!e(a.substring(1)):i=e(a):i=a==="true"}return i?"true":"false"}static _SimplifyNegation(t){return t=t.replace(/^[\s!]+/,e=>(e=e.replace(/[\s]/g,()=>""),e.length%2?"!":"")),t=t.trim(),t==="!true"?t="false":t==="!false"&&(t="true"),t}},he=class n{static EnableFor(t){t._tags=t._tags||{},t.hasTags=()=>n.HasTags(t),t.addTags=e=>n.AddTagsTo(t,e),t.removeTags=e=>n.RemoveTagsFrom(t,e),t.matchesTagsQuery=e=>n.MatchesQuery(t,e)}static DisableFor(t){delete t._tags,delete t.hasTags,delete t.addTags,delete t.removeTags,delete t.matchesTagsQuery}static HasTags(t){if(!t._tags)return!1;let e=t._tags;for(let i in e)if(Object.prototype.hasOwnProperty.call(e,i))return!0;return!1}static GetTags(t,e=!0){if(!t._tags)return null;if(e){let i=[];for(let s in t._tags)Object.prototype.hasOwnProperty.call(t._tags,s)&&t._tags[s]===!0&&i.push(s);return i.join(" ")}else return t._tags}static AddTagsTo(t,e){!e||typeof e!="string"||e.split(" ").forEach(function(i){n._AddTagTo(t,i)})}static _AddTagTo(t,e){e=e.trim(),!(e===""||e==="true"||e==="false")&&(e.match(/[\s]/)||e.match(/^([!]|([|]|[&]){2})/)||(n.EnableFor(t),t._tags[e]=!0))}static RemoveTagsFrom(t,e){if(!n.HasTags(t))return;let i=e.split(" ");for(let s in i)n._RemoveTagFrom(t,i[s])}static _RemoveTagFrom(t,e){delete t._tags[e]}static MatchesQuery(t,e){return e===void 0?!0:e===""?n.HasTags(t):or.Eval(e,i=>n.HasTags(t)&&t._tags[i])}},In=(()=>{class n{constructor(){this.rootNodes=new Array,this.cameras=new Array,this.lights=new Array,this.meshes=new Array,this.skeletons=new Array,this.particleSystems=new Array,this.animations=[],this.animationGroups=new Array,this.multiMaterials=new Array,this.materials=new Array,this.morphTargetManagers=new Array,this.geometries=new Array,this.transformNodes=new Array,this.actionManagers=new Array,this.textures=new Array,this._environmentTexture=null,this.postProcesses=new Array}static AddParser(e,i){this._BabylonFileParsers[e]=i}static GetParser(e){return this._BabylonFileParsers[e]?this._BabylonFileParsers[e]:null}static AddIndividualParser(e,i){this._IndividualBabylonFileParsers[e]=i}static GetIndividualParser(e){return this._IndividualBabylonFileParsers[e]?this._IndividualBabylonFileParsers[e]:null}static Parse(e,i,s,r){for(let a in this._BabylonFileParsers)Object.prototype.hasOwnProperty.call(this._BabylonFileParsers,a)&&this._BabylonFileParsers[a](e,i,s,r)}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e}getNodes(){let e=new Array;return e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes),this.skeletons.forEach(i=>e=e.concat(i.bones)),e}}return n._BabylonFileParsers={},n._IndividualBabylonFileParsers={},n})();function S(n,t,e,i){var s=arguments.length,r=s<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(n,t,e,i);else for(var o=n.length-1;o>=0;o--)(a=n[o])&&(r=(s<3?a(r):s>3?a(t,e,r):a(t,e))||r);return s>3&&r&&Object.defineProperty(t,e,r),r}var Ji={},ji={},sn=function(n,t,e){let i=n();he&&he.AddTagsTo(i,t.tags);let s=hr(i);for(let r in s){let a=s[r],o=t[r],h=a.type;if(o!=null&&(r!=="uniqueId"||ee.AllowLoadingUniqueId))switch(h){case 0:case 6:case 11:i[r]=o;break;case 1:i[r]=e||o.isRenderTarget?o:o.clone();break;case 2:case 3:case 4:case 5:case 7:case 10:case 12:i[r]=e?o:o.clone();break}}return i};function sa(n){let t=n.getClassName();return Ji[t]||(Ji[t]={}),Ji[t]}function hr(n){let t=n.getClassName();if(ji[t])return ji[t];ji[t]={};let e=ji[t],i=n,s=t;for(;s;){let r=Ji[s];for(let h in r)e[h]=r[h];let a,o=!1;do{if(a=Object.getPrototypeOf(i),!a.getClassName){o=!0;break}if(a.getClassName()!==s)break;i=a}while(a);if(o)break;s=a.getClassName(),i=a}return e}function Et(n,t){return(e,i)=>{let s=sa(e);s[i]||(s[i]={type:n,sourceName:t})}}function ra(n,t=null){return(e,i)=>{let s=t||"_"+i;Object.defineProperty(e,i,{get:function(){return this[s]},set:function(r){typeof this.equals=="function"&&this.equals(r)||this[s]!==r&&(this[s]=r,e[n].apply(this))},enumerable:!0,configurable:!0})}}function ae(n,t=null){return ra(n,t)}function A(n){return Et(0,n)}function rt(n){return Et(1,n)}function Jt(n){return Et(2,n)}function zi(n){return Et(3,n)}function na(n){return Et(4,n)}function Nt(n){return Et(5,n)}function aa(n){return Et(6,n)}function oa(n){return Et(7,n)}function Pn(n){return Et(8,n)}function ha(n){return Et(10,n)}var ee=(()=>{class n{static AppendSerializedAnimations(e,i){if(e.animations){i.animations=[];for(let s=0;s<e.animations.length;s++){let r=e.animations[s];i.animations.push(r.serialize())}}}static Serialize(e,i){i||(i={}),he&&(i.tags=he.GetTags(e));let s=hr(e);for(let r in s){let a=s[r],o=a.sourceName||r,h=a.type,l=e[r];if(l!=null&&(r!=="uniqueId"||n.AllowLoadingUniqueId))switch(h){case 0:i[o]=l;break;case 1:i[o]=l.serialize();break;case 2:i[o]=l.asArray();break;case 3:i[o]=l.serialize();break;case 4:i[o]=l.asArray();break;case 5:i[o]=l.asArray();break;case 6:i[o]=l.id;break;case 7:i[o]=l.serialize();break;case 8:i[o]=l.asArray();break;case 9:i[o]=l.serialize();break;case 10:i[o]=l.asArray();break;case 11:i[o]=l.id;break;case 12:i[o]=l.asArray();break}}return i}static Parse(e,i,s,r=null){let a=e();r||(r=""),he&&he.AddTagsTo(a,i.tags);let o=hr(a);for(let h in o){let l=o[h],c=i[l.sourceName||h],d=l.type;if(c!=null&&(h!=="uniqueId"||n.AllowLoadingUniqueId)){let u=a;switch(d){case 0:u[h]=c;break;case 1:s&&(u[h]=n._TextureParser(c,s,r));break;case 2:u[h]=me.FromArray(c);break;case 3:u[h]=n._FresnelParametersParser(c);break;case 4:u[h]=ve.FromArray(c);break;case 5:u[h]=v.FromArray(c);break;case 6:s&&(u[h]=s.getLastMeshById(c));break;case 7:u[h]=n._ColorCurvesParser(c);break;case 8:u[h]=ie.FromArray(c);break;case 9:u[h]=n._ImageProcessingConfigurationParser(c);break;case 10:u[h]=se.FromArray(c);break;case 11:s&&(u[h]=s.getCameraById(c));break;case 12:u[h]=P.FromArray(c);break}}}return a}static Clone(e,i){return sn(e,i,!1)}static Instanciate(e,i){return sn(e,i,!0)}}return n.AllowLoadingUniqueId=!1,n._ImageProcessingConfigurationParser=t=>{throw H("ImageProcessingConfiguration")},n._FresnelParametersParser=t=>{throw H("FresnelParameters")},n._ColorCurvesParser=t=>{throw H("ColorCurves")},n._TextureParser=(t,e,i)=>{throw H("Texture")},n})();function Ht(n,t,e,i){let s=e.value;e.value=(...r)=>{let a=s;if(typeof _native<"u"&&_native[t]){let o=_native[t];i?a=(...h)=>i(...h)?o(...h):s(...h):a=o}return n[t]=a,a(...r)}}Ht.filter=function(n){return(t,e,i)=>Ht(t,e,i,n)};var Oi=class{constructor(t){if(this._keys=[],this._isDirty=!0,this._areLightsDirty=!0,this._areLightsDisposed=!1,this._areAttributesDirty=!0,this._areTexturesDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!0,this._areImageProcessingDirty=!0,this._normals=!1,this._uvs=!1,this._needNormals=!1,this._needUVs=!1,this._externalProperties=t,t)for(let e in t)Object.prototype.hasOwnProperty.call(t,e)&&this._setDefaultValue(e)}get isDirty(){return this._isDirty}markAsProcessed(){this._isDirty=!1,this._areAttributesDirty=!1,this._areTexturesDirty=!1,this._areFresnelDirty=!1,this._areLightsDirty=!1,this._areLightsDisposed=!1,this._areMiscDirty=!1,this._arePrePassDirty=!1,this._areImageProcessingDirty=!1}markAsUnprocessed(){this._isDirty=!0}markAllAsDirty(){this._areTexturesDirty=!0,this._areAttributesDirty=!0,this._areLightsDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._areImageProcessingDirty=!0,this._isDirty=!0}markAsImageProcessingDirty(){this._areImageProcessingDirty=!0,this._isDirty=!0}markAsLightDirty(t=!1){this._areLightsDirty=!0,this._areLightsDisposed=this._areLightsDisposed||t,this._isDirty=!0}markAsAttributesDirty(){this._areAttributesDirty=!0,this._isDirty=!0}markAsTexturesDirty(){this._areTexturesDirty=!0,this._isDirty=!0}markAsFresnelDirty(){this._areFresnelDirty=!0,this._isDirty=!0}markAsMiscDirty(){this._areMiscDirty=!0,this._isDirty=!0}markAsPrePassDirty(){this._arePrePassDirty=!0,this._isDirty=!0}rebuild(){this._keys.length=0;for(let t of Object.keys(this))t[0]!=="_"&&this._keys.push(t);if(this._externalProperties)for(let t in this._externalProperties)this._keys.indexOf(t)===-1&&this._keys.push(t)}isEqual(t){if(this._keys.length!==t._keys.length)return!1;for(let e=0;e<this._keys.length;e++){let i=this._keys[e];if(this[i]!==t[i])return!1}return!0}cloneTo(t){this._keys.length!==t._keys.length&&(t._keys=this._keys.slice(0));for(let e=0;e<this._keys.length;e++){let i=this._keys[e];t[i]=this[i]}}reset(){this._keys.forEach(t=>this._setDefaultValue(t))}_setDefaultValue(t){var e,i,s,r,a;let o=(s=(i=(e=this._externalProperties)===null||e===void 0?void 0:e[t])===null||i===void 0?void 0:i.type)!==null&&s!==void 0?s:typeof this[t],h=(a=(r=this._externalProperties)===null||r===void 0?void 0:r[t])===null||a===void 0?void 0:a.default;switch(o){case"number":this[t]=h??0;break;case"string":this[t]=h??"";break;default:this[t]=h??!1;break}}toString(){let t="";for(let e=0;e<this._keys.length;e++){let i=this._keys[e],s=this[i];switch(typeof s){case"number":case"string":t+="#define "+i+" "+s+`
`;break;default:s&&(t+="#define "+i+`
`);break}}return t}},Le=class n{constructor(){this._dirty=!0,this._tempColor=new ie(0,0,0,0),this._globalCurve=new ie(0,0,0,0),this._highlightsCurve=new ie(0,0,0,0),this._midtonesCurve=new ie(0,0,0,0),this._shadowsCurve=new ie(0,0,0,0),this._positiveCurve=new ie(0,0,0,0),this._negativeCurve=new ie(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}get globalHue(){return this._globalHue}set globalHue(t){this._globalHue=t,this._dirty=!0}get globalDensity(){return this._globalDensity}set globalDensity(t){this._globalDensity=t,this._dirty=!0}get globalSaturation(){return this._globalSaturation}set globalSaturation(t){this._globalSaturation=t,this._dirty=!0}get globalExposure(){return this._globalExposure}set globalExposure(t){this._globalExposure=t,this._dirty=!0}get highlightsHue(){return this._highlightsHue}set highlightsHue(t){this._highlightsHue=t,this._dirty=!0}get highlightsDensity(){return this._highlightsDensity}set highlightsDensity(t){this._highlightsDensity=t,this._dirty=!0}get highlightsSaturation(){return this._highlightsSaturation}set highlightsSaturation(t){this._highlightsSaturation=t,this._dirty=!0}get highlightsExposure(){return this._highlightsExposure}set highlightsExposure(t){this._highlightsExposure=t,this._dirty=!0}get midtonesHue(){return this._midtonesHue}set midtonesHue(t){this._midtonesHue=t,this._dirty=!0}get midtonesDensity(){return this._midtonesDensity}set midtonesDensity(t){this._midtonesDensity=t,this._dirty=!0}get midtonesSaturation(){return this._midtonesSaturation}set midtonesSaturation(t){this._midtonesSaturation=t,this._dirty=!0}get midtonesExposure(){return this._midtonesExposure}set midtonesExposure(t){this._midtonesExposure=t,this._dirty=!0}get shadowsHue(){return this._shadowsHue}set shadowsHue(t){this._shadowsHue=t,this._dirty=!0}get shadowsDensity(){return this._shadowsDensity}set shadowsDensity(t){this._shadowsDensity=t,this._dirty=!0}get shadowsSaturation(){return this._shadowsSaturation}set shadowsSaturation(t){this._shadowsSaturation=t,this._dirty=!0}get shadowsExposure(){return this._shadowsExposure}set shadowsExposure(t){this._shadowsExposure=t,this._dirty=!0}getClassName(){return"ColorCurves"}static Bind(t,e,i="vCameraColorCurvePositive",s="vCameraColorCurveNeutral",r="vCameraColorCurveNegative"){t._dirty&&(t._dirty=!1,t._getColorGradingDataToRef(t._globalHue,t._globalDensity,t._globalSaturation,t._globalExposure,t._globalCurve),t._getColorGradingDataToRef(t._highlightsHue,t._highlightsDensity,t._highlightsSaturation,t._highlightsExposure,t._tempColor),t._tempColor.multiplyToRef(t._globalCurve,t._highlightsCurve),t._getColorGradingDataToRef(t._midtonesHue,t._midtonesDensity,t._midtonesSaturation,t._midtonesExposure,t._tempColor),t._tempColor.multiplyToRef(t._globalCurve,t._midtonesCurve),t._getColorGradingDataToRef(t._shadowsHue,t._shadowsDensity,t._shadowsSaturation,t._shadowsExposure,t._tempColor),t._tempColor.multiplyToRef(t._globalCurve,t._shadowsCurve),t._highlightsCurve.subtractToRef(t._midtonesCurve,t._positiveCurve),t._midtonesCurve.subtractToRef(t._shadowsCurve,t._negativeCurve)),e&&(e.setFloat4(i,t._positiveCurve.r,t._positiveCurve.g,t._positiveCurve.b,t._positiveCurve.a),e.setFloat4(s,t._midtonesCurve.r,t._midtonesCurve.g,t._midtonesCurve.b,t._midtonesCurve.a),e.setFloat4(r,t._negativeCurve.r,t._negativeCurve.g,t._negativeCurve.b,t._negativeCurve.a))}static PrepareUniforms(t){t.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")}_getColorGradingDataToRef(t,e,i,s,r){t!=null&&(t=n._Clamp(t,0,360),e=n._Clamp(e,-100,100),i=n._Clamp(i,-100,100),s=n._Clamp(s,-100,100),e=n._ApplyColorGradingSliderNonlinear(e),e*=.5,s=n._ApplyColorGradingSliderNonlinear(s),e<0&&(e*=-1,t=(t+180)%360),n._FromHSBToRef(t,e,50+.25*s,r),r.scaleToRef(2,r),r.a=1+.01*i)}static _ApplyColorGradingSliderNonlinear(t){t/=100;let e=Math.abs(t);return e=Math.pow(e,2),t<0&&(e*=-1),e*=100,e}static _FromHSBToRef(t,e,i,s){let r=n._Clamp(t,0,360),a=n._Clamp(e/100,0,1),o=n._Clamp(i/100,0,1);if(a===0)s.r=o,s.g=o,s.b=o;else{r/=60;let h=Math.floor(r),l=r-h,c=o*(1-a),d=o*(1-a*l),u=o*(1-a*(1-l));switch(h){case 0:s.r=o,s.g=u,s.b=c;break;case 1:s.r=d,s.g=o,s.b=c;break;case 2:s.r=c,s.g=o,s.b=u;break;case 3:s.r=c,s.g=d,s.b=o;break;case 4:s.r=u,s.g=c,s.b=o;break;default:s.r=o,s.g=c,s.b=d;break}}s.a=1}static _Clamp(t,e,i){return Math.min(Math.max(t,e),i)}clone(){return ee.Clone(()=>new n,this)}serialize(){return ee.Serialize(this)}static Parse(t){return ee.Parse(()=>new n,t,null,null)}};S([A()],Le.prototype,"_globalHue",void 0);S([A()],Le.prototype,"_globalDensity",void 0);S([A()],Le.prototype,"_globalSaturation",void 0);S([A()],Le.prototype,"_globalExposure",void 0);S([A()],Le.prototype,"_highlightsHue",void 0);S([A()],Le.prototype,"_highlightsDensity",void 0);S([A()],Le.prototype,"_highlightsSaturation",void 0);S([A()],Le.prototype,"_highlightsExposure",void 0);S([A()],Le.prototype,"_midtonesHue",void 0);S([A()],Le.prototype,"_midtonesDensity",void 0);S([A()],Le.prototype,"_midtonesSaturation",void 0);S([A()],Le.prototype,"_midtonesExposure",void 0);ee._ColorCurvesParser=Le.Parse;var ue=(()=>{class n{constructor(){this.colorCurves=new Le,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=n.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCenterX=0,this.vignetteCenterY=0,this.vignetteWeight=1.5,this.vignetteColor=new ie(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=n.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._ditheringEnabled=!1,this._ditheringIntensity=1/255,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.onUpdateParameters=new D}get colorCurvesEnabled(){return this._colorCurvesEnabled}set colorCurvesEnabled(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())}get colorGradingTexture(){return this._colorGradingTexture}set colorGradingTexture(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())}get colorGradingEnabled(){return this._colorGradingEnabled}set colorGradingEnabled(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())}get colorGradingWithGreenDepth(){return this._colorGradingWithGreenDepth}set colorGradingWithGreenDepth(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())}get colorGradingBGR(){return this._colorGradingBGR}set colorGradingBGR(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())}get exposure(){return this._exposure}set exposure(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())}get toneMappingEnabled(){return this._toneMappingEnabled}set toneMappingEnabled(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())}get toneMappingType(){return this._toneMappingType}set toneMappingType(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())}get contrast(){return this._contrast}set contrast(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())}get vignetteCentreY(){return this.vignetteCenterY}set vignetteCentreY(e){this.vignetteCenterY=e}get vignetteCentreX(){return this.vignetteCenterX}set vignetteCentreX(e){this.vignetteCenterX=e}get vignetteBlendMode(){return this._vignetteBlendMode}set vignetteBlendMode(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())}get vignetteEnabled(){return this._vignetteEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())}get ditheringEnabled(){return this._ditheringEnabled}set ditheringEnabled(e){this._ditheringEnabled!==e&&(this._ditheringEnabled=e,this._updateParameters())}get ditheringIntensity(){return this._ditheringIntensity}set ditheringIntensity(e){this._ditheringIntensity!==e&&(this._ditheringIntensity=e,this._updateParameters())}get skipFinalColorClamp(){return this._skipFinalColorClamp}set skipFinalColorClamp(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())}get applyByPostProcess(){return this._applyByPostProcess}set applyByPostProcess(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())}_updateParameters(){this.onUpdateParameters.notifyObservers(this)}getClassName(){return"ImageProcessingConfiguration"}static PrepareUniforms(e,i){i.EXPOSURE&&e.push("exposureLinear"),i.CONTRAST&&e.push("contrast"),i.COLORGRADING&&e.push("colorTransformSettings"),(i.VIGNETTE||i.DITHER)&&e.push("vInverseScreenSize"),i.VIGNETTE&&(e.push("vignetteSettings1"),e.push("vignetteSettings2")),i.COLORCURVES&&Le.PrepareUniforms(e),i.DITHER&&e.push("ditherIntensity")}static PrepareSamplers(e,i){i.COLORGRADING&&e.push("txColorTransform")}prepareDefines(e,i=!1){if(i!==this.applyByPostProcess||!this._isEnabled){e.VIGNETTE=!1,e.TONEMAPPING=!1,e.TONEMAPPING_ACES=!1,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.DITHER=!1,e.IMAGEPROCESSING=!1,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled;return}switch(e.VIGNETTE=this.vignetteEnabled,e.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===n._VIGNETTEMODE_MULTIPLY,e.VIGNETTEBLENDMODEOPAQUE=!e.VIGNETTEBLENDMODEMULTIPLY,e.TONEMAPPING=this.toneMappingEnabled,this._toneMappingType){case n.TONEMAPPING_ACES:e.TONEMAPPING_ACES=!0;break;default:e.TONEMAPPING_ACES=!1;break}e.CONTRAST=this.contrast!==1,e.EXPOSURE=this.exposure!==1,e.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,e.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,e.COLORGRADING?e.COLORGRADING3D=this.colorGradingTexture.is3D:e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,e.SAMPLER3DBGRMAP=this.colorGradingBGR,e.DITHER=this._ditheringEnabled,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSING=e.VIGNETTE||e.TONEMAPPING||e.CONTRAST||e.EXPOSURE||e.COLORCURVES||e.COLORGRADING||e.DITHER}isReady(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()}bind(e,i){if(this._colorCurvesEnabled&&this.colorCurves&&Le.Bind(this.colorCurves,e),this._vignetteEnabled||this._ditheringEnabled){let s=1/e.getEngine().getRenderWidth(),r=1/e.getEngine().getRenderHeight();if(e.setFloat2("vInverseScreenSize",s,r),this._ditheringEnabled&&e.setFloat("ditherIntensity",.5*this._ditheringIntensity),this._vignetteEnabled){let a=i??r/s,o=Math.tan(this.vignetteCameraFov*.5),h=o*a,l=Math.sqrt(h*o);h=Z.Mix(h,l,this.vignetteStretch),o=Z.Mix(o,l,this.vignetteStretch),e.setFloat4("vignetteSettings1",h,o,-h*this.vignetteCenterX,-o*this.vignetteCenterY);let c=-2*this.vignetteWeight;e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,c)}}if(e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture){e.setTexture("txColorTransform",this.colorGradingTexture);let s=this.colorGradingTexture.getSize().height;e.setFloat4("colorTransformSettings",(s-1)/s,.5/s,s,this.colorGradingTexture.level)}}clone(){return ee.Clone(()=>new n,this)}serialize(){return ee.Serialize(this)}static Parse(e){let i=ee.Parse(()=>new n,e,null,null);return e.vignetteCentreX!==void 0&&(i.vignetteCenterX=e.vignetteCentreX),e.vignetteCentreY!==void 0&&(i.vignetteCenterY=e.vignetteCentreY),i}static get VIGNETTEMODE_MULTIPLY(){return this._VIGNETTEMODE_MULTIPLY}static get VIGNETTEMODE_OPAQUE(){return this._VIGNETTEMODE_OPAQUE}}return n.TONEMAPPING_STANDARD=0,n.TONEMAPPING_ACES=1,n._VIGNETTEMODE_MULTIPLY=0,n._VIGNETTEMODE_OPAQUE=1,n})();S([oa()],ue.prototype,"colorCurves",void 0);S([A()],ue.prototype,"_colorCurvesEnabled",void 0);S([rt("colorGradingTexture")],ue.prototype,"_colorGradingTexture",void 0);S([A()],ue.prototype,"_colorGradingEnabled",void 0);S([A()],ue.prototype,"_colorGradingWithGreenDepth",void 0);S([A()],ue.prototype,"_colorGradingBGR",void 0);S([A()],ue.prototype,"_exposure",void 0);S([A()],ue.prototype,"_toneMappingEnabled",void 0);S([A()],ue.prototype,"_toneMappingType",void 0);S([A()],ue.prototype,"_contrast",void 0);S([A()],ue.prototype,"vignetteStretch",void 0);S([A()],ue.prototype,"vignetteCenterX",void 0);S([A()],ue.prototype,"vignetteCenterY",void 0);S([A()],ue.prototype,"vignetteWeight",void 0);S([Pn()],ue.prototype,"vignetteColor",void 0);S([A()],ue.prototype,"vignetteCameraFov",void 0);S([A()],ue.prototype,"_vignetteBlendMode",void 0);S([A()],ue.prototype,"_vignetteEnabled",void 0);S([A()],ue.prototype,"_ditheringEnabled",void 0);S([A()],ue.prototype,"_ditheringIntensity",void 0);S([A()],ue.prototype,"_skipFinalColorClamp",void 0);S([A()],ue.prototype,"_applyByPostProcess",void 0);S([A()],ue.prototype,"_isEnabled",void 0);ee._ImageProcessingConfigurationParser=ue.Parse;le.prototype.createUniformBuffer=function(n){let t=this._gl.createBuffer();if(!t)throw new Error("Unable to create uniform buffer");let e=new Qt(t);return this.bindUniformBuffer(e),n instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,n,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(n),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),e.references=1,e};le.prototype.createDynamicUniformBuffer=function(n){let t=this._gl.createBuffer();if(!t)throw new Error("Unable to create dynamic uniform buffer");let e=new Qt(t);return this.bindUniformBuffer(e),n instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,n,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(n),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),e.references=1,e};le.prototype.updateUniformBuffer=function(n,t,e,i){this.bindUniformBuffer(n),e===void 0&&(e=0),i===void 0?t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,e,t):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,e,new Float32Array(t)):t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,t.subarray(e,e+i)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(t).subarray(e,e+i)),this.bindUniformBuffer(null)};le.prototype.bindUniformBuffer=function(n){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,n?n.underlyingResource:null)};le.prototype.bindUniformBufferBase=function(n,t,e){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,t,n?n.underlyingResource:null)};le.prototype.bindUniformBlock=function(n,t,e){let i=n.program,s=this._gl.getUniformBlockIndex(i,t);s!==4294967295&&this._gl.uniformBlockBinding(i,s,e)};var Qe=class n{constructor(t,e,i,s,r=!1){this._valueCache={},this._engine=t,this._noUBO=!t.supportsUniformBuffers||r,this._dynamic=i,this._name=s??"no-name",this._data=e||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateUIntArray=this._updateUIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect,this.updateUInt=this._updateUIntForEffect,this.updateUInt2=this._updateUInt2ForEffect,this.updateUInt3=this._updateUInt3ForEffect,this.updateUInt4=this._updateUInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateUIntArray=this._updateUIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform,this.updateUInt=this._updateUIntForUniform,this.updateUInt2=this._updateUInt2ForUniform,this.updateUInt3=this._updateUInt3ForUniform,this.updateUInt4=this._updateUInt4ForUniform)}get useUbo(){return!this._noUBO}get isSync(){return!this._needSync}isDynamic(){return this._dynamic!==void 0}getData(){return this._bufferData}getBuffer(){return this._buffer}_fillAlignment(t){let e;if(t<=2?e=t:e=4,this._uniformLocationPointer%e!==0){let i=this._uniformLocationPointer;this._uniformLocationPointer+=e-this._uniformLocationPointer%e;let s=this._uniformLocationPointer-i;for(let r=0;r<s;r++)this._data.push(0)}}addUniform(t,e,i=0){if(this._noUBO||this._uniformLocations[t]!==void 0)return;let s;if(i>0){if(e instanceof Array)throw"addUniform should not be use with Array in UBO: "+t;if(this._fillAlignment(4),this._uniformArraySizes[t]={strideSize:e,arraySize:i},e==16)e=e*i;else{let r=(4-e)*i;e=e*i+r}s=[];for(let r=0;r<e;r++)s.push(0)}else{if(e instanceof Array)s=e,e=s.length;else{e=e,s=[];for(let r=0;r<e;r++)s.push(0)}this._fillAlignment(e)}this._uniformSizes[t]=e,this._uniformLocations[t]=this._uniformLocationPointer,this._uniformLocationPointer+=e;for(let r=0;r<e;r++)this._data.push(s[r]);this._needSync=!0}addMatrix(t,e){this.addUniform(t,Array.prototype.slice.call(e.toArray()))}addFloat2(t,e,i){let s=[e,i];this.addUniform(t,s)}addFloat3(t,e,i,s){let r=[e,i,s];this.addUniform(t,r)}addColor3(t,e){let i=[e.r,e.g,e.b];this.addUniform(t,i)}addColor4(t,e,i){let s=[e.r,e.g,e.b,i];this.addUniform(t,s)}addVector3(t,e){let i=[e.x,e.y,e.z];this.addUniform(t,i)}addMatrix3x3(t){this.addUniform(t,12)}addMatrix2x2(t){this.addUniform(t,8)}create(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)}_rebuild(){this._noUBO||!this._bufferData||(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData):this._buffer=this._engine.createUniformBuffer(this._bufferData),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))}get _numBuffers(){return this._buffers.length}get _indexBuffer(){return this._bufferIndex}get name(){return this._name}_buffersEqual(t,e){for(let i=0;i<t.length;++i)if(t[i]!==e[i])return!1;return!0}_copyBuffer(t,e){for(let i=0;i<t.length;++i)e[i]=t[i]}update(){if(!this._noUBO){if(this.bindUniformBuffer(),!this._buffer){this.create();return}if(!this._dynamic&&!this._needSync){this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1])if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1])){this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}else this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1]);this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(n._UpdatedUbosInFrame[this._name]||(n._UpdatedUbosInFrame[this._name]=0),n._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}}_createNewBuffer(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()}_checkNewFrame(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=this._bufferIndex!==0,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)}updateUniform(t,e,i){this._checkNewFrame();let s=this._uniformLocations[t];if(s===void 0){if(this._buffer){O.Error("Cannot add an uniform after UBO has been created.");return}this.addUniform(t,i),s=this._uniformLocations[t]}if(this._buffer||this.create(),this._dynamic)for(let r=0;r<i;r++)this._bufferData[s+r]=e[r];else{let r=!1;for(let a=0;a<i;a++)(i===16&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[s+a]!==Z.FloatRound(e[a]))&&(r=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[s+a]=e[a]);this._needSync=this._needSync||r}}updateUniformArray(t,e,i){this._checkNewFrame();let s=this._uniformLocations[t];if(s===void 0){O.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.");return}this._buffer||this.create();let r=this._uniformArraySizes[t];if(this._dynamic)for(let a=0;a<i;a++)this._bufferData[s+a]=e[a];else{let a=!1,o=0,h=0;for(let l=0;l<i;l++)if(this._bufferData[s+h*4+o]!==Z.FloatRound(e[l])&&(a=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[s+h*4+o]=e[l]),o++,o===r.strideSize){for(;o<4;o++)this._bufferData[s+h*4+o]=0;o=0,h++}this._needSync=this._needSync||a}}_cacheMatrix(t,e){this._checkNewFrame();let i=this._valueCache[t],s=e.updateFlag;return i!==void 0&&i===s?!1:(this._valueCache[t]=s,!0)}_updateMatrix3x3ForUniform(t,e){for(let i=0;i<3;i++)n._TempBuffer[i*4]=e[i*3],n._TempBuffer[i*4+1]=e[i*3+1],n._TempBuffer[i*4+2]=e[i*3+2],n._TempBuffer[i*4+3]=0;this.updateUniform(t,n._TempBuffer,12)}_updateMatrix3x3ForEffect(t,e){this._currentEffect.setMatrix3x3(t,e)}_updateMatrix2x2ForEffect(t,e){this._currentEffect.setMatrix2x2(t,e)}_updateMatrix2x2ForUniform(t,e){for(let i=0;i<2;i++)n._TempBuffer[i*4]=e[i*2],n._TempBuffer[i*4+1]=e[i*2+1],n._TempBuffer[i*4+2]=0,n._TempBuffer[i*4+3]=0;this.updateUniform(t,n._TempBuffer,8)}_updateFloatForEffect(t,e){this._currentEffect.setFloat(t,e)}_updateFloatForUniform(t,e){n._TempBuffer[0]=e,this.updateUniform(t,n._TempBuffer,1)}_updateFloat2ForEffect(t,e,i,s=""){this._currentEffect.setFloat2(t+s,e,i)}_updateFloat2ForUniform(t,e,i){n._TempBuffer[0]=e,n._TempBuffer[1]=i,this.updateUniform(t,n._TempBuffer,2)}_updateFloat3ForEffect(t,e,i,s,r=""){this._currentEffect.setFloat3(t+r,e,i,s)}_updateFloat3ForUniform(t,e,i,s){n._TempBuffer[0]=e,n._TempBuffer[1]=i,n._TempBuffer[2]=s,this.updateUniform(t,n._TempBuffer,3)}_updateFloat4ForEffect(t,e,i,s,r,a=""){this._currentEffect.setFloat4(t+a,e,i,s,r)}_updateFloat4ForUniform(t,e,i,s,r){n._TempBuffer[0]=e,n._TempBuffer[1]=i,n._TempBuffer[2]=s,n._TempBuffer[3]=r,this.updateUniform(t,n._TempBuffer,4)}_updateFloatArrayForEffect(t,e){this._currentEffect.setFloatArray(t,e)}_updateFloatArrayForUniform(t,e){this.updateUniformArray(t,e,e.length)}_updateArrayForEffect(t,e){this._currentEffect.setArray(t,e)}_updateArrayForUniform(t,e){this.updateUniformArray(t,e,e.length)}_updateIntArrayForEffect(t,e){this._currentEffect.setIntArray(t,e)}_updateIntArrayForUniform(t,e){n._TempBufferInt32View.set(e),this.updateUniformArray(t,n._TempBuffer,e.length)}_updateUIntArrayForEffect(t,e){this._currentEffect.setUIntArray(t,e)}_updateUIntArrayForUniform(t,e){n._TempBufferUInt32View.set(e),this.updateUniformArray(t,n._TempBuffer,e.length)}_updateMatrixForEffect(t,e){this._currentEffect.setMatrix(t,e)}_updateMatrixForUniform(t,e){this._cacheMatrix(t,e)&&this.updateUniform(t,e.toArray(),16)}_updateMatricesForEffect(t,e){this._currentEffect.setMatrices(t,e)}_updateMatricesForUniform(t,e){this.updateUniform(t,e,e.length)}_updateVector3ForEffect(t,e){this._currentEffect.setVector3(t,e)}_updateVector3ForUniform(t,e){n._TempBuffer[0]=e.x,n._TempBuffer[1]=e.y,n._TempBuffer[2]=e.z,this.updateUniform(t,n._TempBuffer,3)}_updateVector4ForEffect(t,e){this._currentEffect.setVector4(t,e)}_updateVector4ForUniform(t,e){n._TempBuffer[0]=e.x,n._TempBuffer[1]=e.y,n._TempBuffer[2]=e.z,n._TempBuffer[3]=e.w,this.updateUniform(t,n._TempBuffer,4)}_updateColor3ForEffect(t,e,i=""){this._currentEffect.setColor3(t+i,e)}_updateColor3ForUniform(t,e){n._TempBuffer[0]=e.r,n._TempBuffer[1]=e.g,n._TempBuffer[2]=e.b,this.updateUniform(t,n._TempBuffer,3)}_updateColor4ForEffect(t,e,i,s=""){this._currentEffect.setColor4(t+s,e,i)}_updateDirectColor4ForEffect(t,e,i=""){this._currentEffect.setDirectColor4(t+i,e)}_updateColor4ForUniform(t,e,i){n._TempBuffer[0]=e.r,n._TempBuffer[1]=e.g,n._TempBuffer[2]=e.b,n._TempBuffer[3]=i,this.updateUniform(t,n._TempBuffer,4)}_updateDirectColor4ForUniform(t,e){n._TempBuffer[0]=e.r,n._TempBuffer[1]=e.g,n._TempBuffer[2]=e.b,n._TempBuffer[3]=e.a,this.updateUniform(t,n._TempBuffer,4)}_updateIntForEffect(t,e,i=""){this._currentEffect.setInt(t+i,e)}_updateIntForUniform(t,e){n._TempBufferInt32View[0]=e,this.updateUniform(t,n._TempBuffer,1)}_updateInt2ForEffect(t,e,i,s=""){this._currentEffect.setInt2(t+s,e,i)}_updateInt2ForUniform(t,e,i){n._TempBufferInt32View[0]=e,n._TempBufferInt32View[1]=i,this.updateUniform(t,n._TempBuffer,2)}_updateInt3ForEffect(t,e,i,s,r=""){this._currentEffect.setInt3(t+r,e,i,s)}_updateInt3ForUniform(t,e,i,s){n._TempBufferInt32View[0]=e,n._TempBufferInt32View[1]=i,n._TempBufferInt32View[2]=s,this.updateUniform(t,n._TempBuffer,3)}_updateInt4ForEffect(t,e,i,s,r,a=""){this._currentEffect.setInt4(t+a,e,i,s,r)}_updateInt4ForUniform(t,e,i,s,r){n._TempBufferInt32View[0]=e,n._TempBufferInt32View[1]=i,n._TempBufferInt32View[2]=s,n._TempBufferInt32View[3]=r,this.updateUniform(t,n._TempBuffer,4)}_updateUIntForEffect(t,e,i=""){this._currentEffect.setUInt(t+i,e)}_updateUIntForUniform(t,e){n._TempBufferUInt32View[0]=e,this.updateUniform(t,n._TempBuffer,1)}_updateUInt2ForEffect(t,e,i,s=""){this._currentEffect.setUInt2(t+s,e,i)}_updateUInt2ForUniform(t,e,i){n._TempBufferUInt32View[0]=e,n._TempBufferUInt32View[1]=i,this.updateUniform(t,n._TempBuffer,2)}_updateUInt3ForEffect(t,e,i,s,r=""){this._currentEffect.setUInt3(t+r,e,i,s)}_updateUInt3ForUniform(t,e,i,s){n._TempBufferUInt32View[0]=e,n._TempBufferUInt32View[1]=i,n._TempBufferUInt32View[2]=s,this.updateUniform(t,n._TempBuffer,3)}_updateUInt4ForEffect(t,e,i,s,r,a=""){this._currentEffect.setUInt4(t+a,e,i,s,r)}_updateUInt4ForUniform(t,e,i,s,r){n._TempBufferUInt32View[0]=e,n._TempBufferUInt32View[1]=i,n._TempBufferUInt32View[2]=s,n._TempBufferUInt32View[3]=r,this.updateUniform(t,n._TempBuffer,4)}setTexture(t,e){this._currentEffect.setTexture(t,e)}updateUniformDirectly(t,e){this.updateUniform(t,e,e.length),this.update()}bindToEffect(t,e){this._currentEffect=t,this._currentEffectName=e}bindUniformBuffer(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)}unbindEffect(){this._currentEffect=void 0,this._currentEffectName=void 0}setDataBuffer(t){if(!this._buffers)return this._buffer===t;for(let e=0;e<this._buffers.length;++e)if(this._buffers[e][0]===t)return this._bufferIndex=e,this._buffer=t,this._createBufferOnWrite=!1,this._currentEffect=void 0,!0;return!1}dispose(){if(this._noUBO)return;let t=this._engine._uniformBuffers,e=t.indexOf(this);if(e!==-1&&(t[e]=t[t.length-1],t.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(let i=0;i<this._buffers.length;++i){let s=this._buffers[i][0];this._engine._releaseBuffer(s)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}};Qe._UpdatedUbosInFrame={};Qe._MAX_UNIFORM_SIZE=256;Qe._TempBuffer=new Float32Array(Qe._MAX_UNIFORM_SIZE);Qe._TempBufferInt32View=new Int32Array(Qe._TempBuffer.buffer);Qe._TempBufferUInt32View=new Uint32Array(Qe._TempBuffer.buffer);var di=class{constructor(t,e,i,s=0,r=!1,a=!1,o=!1,h){this._isAlreadyOwned=!1,t.getScene?this._engine=t.getScene().getEngine():this._engine=t,this._updatable=i,this._instanced=a,this._divisor=h||1,e instanceof Sn?(this._data=null,this._buffer=e):(this._data=e,this._buffer=null),this.byteStride=o?s:s*Float32Array.BYTES_PER_ELEMENT,r||this.create()}createVertexBuffer(t,e,i,s,r,a=!1,o){let h=a?e:e*Float32Array.BYTES_PER_ELEMENT,l=s?a?s:s*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new m(this._engine,this,t,this._updatable,!0,l,r===void 0?this._instanced:r,h,i,void 0,void 0,!0,this._divisor||o)}isUpdatable(){return this._updatable}getData(){return this._data}getBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(t=null){!t&&this._buffer||(t=t||this._data,t&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,t),this._data=t):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(t),this._data=t):this._buffer=this._engine.createVertexBuffer(t)))}_rebuild(){this._buffer=null,this.create(this._data)}update(t){this.create(t)}updateDirectly(t,e,i,s=!1){this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,t,s?e:e*Float32Array.BYTES_PER_ELEMENT,i?i*this.byteStride:void 0),e===0&&i===void 0?this._data=t:this._data=null)}_increaseReferences(){if(this._buffer){if(!this._isAlreadyOwned){this._isAlreadyOwned=!0;return}this._buffer.references++}}dispose(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null,this._data=null)}},m=(()=>{class n{constructor(e,i,s,r,a,o,h,l,c,d,u=!1,f=!1,_=1,g=!1){if(i instanceof di?(this._buffer=i,this._ownsBuffer=g):(this._buffer=new di(e,i,r,o,a,h,f),this._ownsBuffer=!0),this.uniqueId=n._Counter++,this._kind=s,d==null){let E=this.getData();this.type=n.FLOAT,E instanceof Int8Array?this.type=n.BYTE:E instanceof Uint8Array?this.type=n.UNSIGNED_BYTE:E instanceof Int16Array?this.type=n.SHORT:E instanceof Uint16Array?this.type=n.UNSIGNED_SHORT:E instanceof Int32Array?this.type=n.INT:E instanceof Uint32Array&&(this.type=n.UNSIGNED_INT)}else this.type=d;let p=n.GetTypeByteLength(this.type);f?(this._size=c||(o?o/p:n.DeduceStride(s)),this.byteStride=o||this._buffer.byteStride||this._size*p,this.byteOffset=l||0):(this._size=c||o||n.DeduceStride(s),this.byteStride=o?o*p:this._buffer.byteStride||this._size*p,this.byteOffset=(l||0)*p),this.normalized=u,this._instanced=h!==void 0?h:!1,this._instanceDivisor=h?_:0,this._computeHashCode()}get instanceDivisor(){return this._instanceDivisor}set instanceDivisor(e){let i=e!=0;this._instanceDivisor=e,i!==this._instanced&&(this._instanced=i,this._computeHashCode())}_computeHashCode(){this.hashCode=(this.type-5120<<0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)}_rebuild(){this._buffer&&this._buffer._rebuild()}getKind(){return this._kind}isUpdatable(){return this._buffer.isUpdatable()}getData(){return this._buffer.getData()}getFloatData(e,i){let s=this.getData();if(!s)return null;let r=this.getSize()*n.GetTypeByteLength(this.type),a=e*this.getSize();if(this.type!==n.FLOAT||this.byteStride!==r){let o=new Float32Array(a);return this.forEach(a,(h,l)=>o[l]=h),o}if(!(s instanceof Array||s instanceof Float32Array)||this.byteOffset!==0||s.length!==a)if(s instanceof Array){let o=this.byteOffset/4;return s.slice(o,o+a)}else{if(s instanceof ArrayBuffer)return new Float32Array(s,this.byteOffset,a);{let o=s.byteOffset+this.byteOffset;if(i){let l=new Float32Array(a),c=new Float32Array(s.buffer,o,a);return l.set(c),l}let h=o%4;return h&&(o=Math.max(0,o-h)),new Float32Array(s.buffer,o,a)}}return i?s.slice():s}getBuffer(){return this._buffer.getBuffer()}getStrideSize(){return this.byteStride/n.GetTypeByteLength(this.type)}getOffset(){return this.byteOffset/n.GetTypeByteLength(this.type)}getSize(e=!1){return e?this._size*n.GetTypeByteLength(this.type):this._size}getIsInstanced(){return this._instanced}getInstanceDivisor(){return this._instanceDivisor}create(e){this._buffer.create(e)}update(e){this._buffer.update(e)}updateDirectly(e,i,s=!1){this._buffer.updateDirectly(e,i,void 0,s)}dispose(){this._ownsBuffer&&this._buffer.dispose()}forEach(e,i){n.ForEach(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,i)}static DeduceStride(e){switch(e){case n.UVKind:case n.UV2Kind:case n.UV3Kind:case n.UV4Kind:case n.UV5Kind:case n.UV6Kind:return 2;case n.NormalKind:case n.PositionKind:return 3;case n.ColorKind:case n.MatricesIndicesKind:case n.MatricesIndicesExtraKind:case n.MatricesWeightsKind:case n.MatricesWeightsExtraKind:case n.TangentKind:return 4;default:throw new Error("Invalid kind '"+e+"'")}}static GetTypeByteLength(e){switch(e){case n.BYTE:case n.UNSIGNED_BYTE:return 1;case n.SHORT:case n.UNSIGNED_SHORT:return 2;case n.INT:case n.UNSIGNED_INT:case n.FLOAT:return 4;default:throw new Error(`Invalid type '${e}'`)}}static ForEach(e,i,s,r,a,o,h,l){if(e instanceof Array){let c=i/4,d=s/4;for(let u=0;u<o;u+=r){for(let f=0;f<r;f++)l(e[c+f],u+f);c+=d}}else{let c=e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),d=n.GetTypeByteLength(a);for(let u=0;u<o;u+=r){let f=i;for(let _=0;_<r;_++){let g=n._GetFloatValue(c,a,f,h);l(g,u+_),f+=d}i+=s}}}static _GetFloatValue(e,i,s,r){switch(i){case n.BYTE:{let a=e.getInt8(s);return r&&(a=Math.max(a/127,-1)),a}case n.UNSIGNED_BYTE:{let a=e.getUint8(s);return r&&(a=a/255),a}case n.SHORT:{let a=e.getInt16(s,!0);return r&&(a=Math.max(a/32767,-1)),a}case n.UNSIGNED_SHORT:{let a=e.getUint16(s,!0);return r&&(a=a/65535),a}case n.INT:return e.getInt32(s,!0);case n.UNSIGNED_INT:return e.getUint32(s,!0);case n.FLOAT:return e.getFloat32(s,!0);default:throw new Error(`Invalid component type ${i}`)}}}return n._Counter=0,n.BYTE=5120,n.UNSIGNED_BYTE=5121,n.SHORT=5122,n.UNSIGNED_SHORT=5123,n.INT=5124,n.UNSIGNED_INT=5125,n.FLOAT=5126,n.PositionKind="position",n.NormalKind="normal",n.TangentKind="tangent",n.UVKind="uv",n.UV2Kind="uv2",n.UV3Kind="uv3",n.UV4Kind="uv4",n.UV5Kind="uv5",n.UV6Kind="uv6",n.ColorKind="color",n.ColorInstanceKind="instanceColor",n.MatricesIndicesKind="matricesIndices",n.MatricesWeightsKind="matricesWeights",n.MatricesIndicesExtraKind="matricesIndicesExtra",n.MatricesWeightsExtraKind="matricesWeightsExtra",n})(),lt=class{constructor(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}getNormal(t=!1,e=!0){if(!this.pickedMesh||e&&!this.pickedMesh.isVerticesDataPresent(m.NormalKind))return null;let i=this.pickedMesh.getIndices();if(!i)return null;let s;if(e){let a=this.pickedMesh.getVerticesData(m.NormalKind),o=v.FromArray(a,i[this.faceId*3]*3),h=v.FromArray(a,i[this.faceId*3+1]*3),l=v.FromArray(a,i[this.faceId*3+2]*3);o=o.scale(this.bu),h=h.scale(this.bv),l=l.scale(1-this.bu-this.bv),s=new v(o.x+h.x+l.x,o.y+h.y+l.y,o.z+h.z+l.z)}else{let a=this.pickedMesh.getVerticesData(m.PositionKind),o=v.FromArray(a,i[this.faceId*3]*3),h=v.FromArray(a,i[this.faceId*3+1]*3),l=v.FromArray(a,i[this.faceId*3+2]*3),c=o.subtract(h),d=l.subtract(h);s=v.Cross(c,d)}let r=(a,o)=>{let h=a.getWorldMatrix();a.nonUniformScaling&&(C.Matrix[0].copyFrom(h),h=C.Matrix[0],h.setTranslationFromFloats(0,0,0),h.invert(),h.transposeToRef(C.Matrix[1]),h=C.Matrix[1]),v.TransformNormalToRef(o,h,o)};if(t&&r(this.pickedMesh,s),this.ray){let a=C.Vector3[0].copyFrom(s);t||r(this.pickedMesh,a),v.Dot(a,this.ray.direction)>0&&s.negateInPlace()}return s.normalize(),s}getTextureCoordinates(){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(m.UVKind))return null;let t=this.pickedMesh.getIndices();if(!t)return null;let e=this.pickedMesh.getVerticesData(m.UVKind);if(!e)return null;let i=ve.FromArray(e,t[this.faceId*3]*2),s=ve.FromArray(e,t[this.faceId*3+1]*2),r=ve.FromArray(e,t[this.faceId*3+2]*2);return i=i.scale(this.bu),s=s.scale(this.bv),r=r.scale(1-this.bu-this.bv),new ve(i.x+s.x+r.x,i.y+s.y+r.y)}},Be=class n{constructor(t,e,i,s,r,a){this.source=t,this.pointerX=e,this.pointerY=i,this.meshUnderPointer=s,this.sourceEvent=r,this.additionalData=a}static CreateNew(t,e,i){let s=t.getScene();return new n(t,s.pointerX,s.pointerY,s.meshUnderPointer||t,e,i)}static CreateNewFromSprite(t,e,i,s){return new n(t,e.pointerX,e.pointerY,e.meshUnderPointer,i,s)}static CreateNewFromScene(t,e){return new n(null,t.pointerX,t.pointerY,t.meshUnderPointer,e)}static CreateNewFromPrimitive(t,e,i,s){return new n(t,e.x,e.y,null,i,s)}},ui=class{constructor(t){this._vertexBuffers={},this._scene=t}_prepareBuffers(){if(this._vertexBuffers[m.PositionKind])return;let t=[];t.push(1,1),t.push(-1,1),t.push(-1,-1),t.push(1,-1),this._vertexBuffers[m.PositionKind]=new m(this._scene.getEngine(),t,m.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){let t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(t)}_rebuild(){let t=this._vertexBuffers[m.PositionKind];t&&(t._rebuild(),this._buildIndexBuffer())}_prepareFrame(t=null,e=null){let i=this._scene.activeCamera;return!i||(e=e||i._postProcesses.filter(s=>s!=null),!e||e.length===0||!this._scene.postProcessesEnabled)?!1:(e[0].activate(i,t,e!=null),!0)}directRender(t,e=null,i=!1,s=0,r=0,a=!1){var o;let h=this._scene.getEngine();for(let l=0;l<t.length;l++){l<t.length-1?t[l+1].activate(this._scene.activeCamera,e?.texture):(e?h.bindFramebuffer(e,s,void 0,void 0,i,r):a||h.restoreDefaultFramebuffer(),(o=h._debugInsertMarker)===null||o===void 0||o.call(h,`post process ${t[l].name} output`));let c=t[l],d=c.apply();d&&(c.onBeforeRenderObservable.notifyObservers(d),this._prepareBuffers(),h.bindBuffers(this._vertexBuffers,this._indexBuffer,d),h.drawElementsType(0,0,6),c.onAfterRenderObservable.notifyObservers(d))}h.setDepthBuffer(!0),h.setDepthWrite(!0)}_finalizeFrame(t,e,i,s,r=!1){var a;let o=this._scene.activeCamera;if(!o||(s=s||o._postProcesses.filter(l=>l!=null),s.length===0||!this._scene.postProcessesEnabled))return;let h=this._scene.getEngine();for(let l=0,c=s.length;l<c;l++){let d=s[l];if(l<c-1?d._outputTexture=s[l+1].activate(o,e?.texture):(e?(h.bindFramebuffer(e,i,void 0,void 0,r),d._outputTexture=e):(h.restoreDefaultFramebuffer(),d._outputTexture=null),(a=h._debugInsertMarker)===null||a===void 0||a.call(h,`post process ${s[l].name} output`)),t)break;let u=d.apply();u&&(d.onBeforeRenderObservable.notifyObservers(u),this._prepareBuffers(),h.bindBuffers(this._vertexBuffers,this._indexBuffer,u),h.drawElementsType(0,0,6),d.onAfterRenderObservable.notifyObservers(u))}h.setDepthBuffer(!0),h.setDepthWrite(!0),h.setAlphaMode(0)}dispose(){let t=this._vertexBuffers[m.PositionKind];t&&(t.dispose(),this._vertexBuffers[m.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}},os=class n{constructor(t,e,i=null,s=null,r=null){this.index=t,this._opaqueSubMeshes=new Ze(256),this._transparentSubMeshes=new Ze(256),this._alphaTestSubMeshes=new Ze(256),this._depthOnlySubMeshes=new Ze(256),this._particleSystems=new Ze(256),this._spriteManagers=new Ze(256),this._empty=!0,this._edgesRenderers=new Ct(16),this._scene=e,this.opaqueSortCompareFn=i,this.alphaTestSortCompareFn=s,this.transparentSortCompareFn=r}set opaqueSortCompareFn(t){t?this._opaqueSortCompareFn=t:this._opaqueSortCompareFn=n.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(t){t?this._alphaTestSortCompareFn=t:this._alphaTestSortCompareFn=n.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(t){t?this._transparentSortCompareFn=t:this._transparentSortCompareFn=n.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}render(t,e,i,s){if(t){t(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);return}let r=this._scene.getEngine();this._depthOnlySubMeshes.length!==0&&(r.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),r.setColorWrite(!0)),this._opaqueSubMeshes.length!==0&&this._renderOpaque(this._opaqueSubMeshes),this._alphaTestSubMeshes.length!==0&&this._renderAlphaTest(this._alphaTestSubMeshes);let a=r.getStencilBuffer();if(r.setStencilBuffer(!1),e&&this._renderSprites(),i&&this._renderParticles(s),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),this._transparentSubMeshes.length!==0||this._scene.useOrderIndependentTransparency){if(r.setStencilBuffer(a),this._scene.useOrderIndependentTransparency){let o=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);o.length&&this._renderTransparent(o)}else this._renderTransparent(this._transparentSubMeshes);r.setAlphaMode(0)}if(r.setStencilBuffer(!1),this._edgesRenderers.length){for(let o=0;o<this._edgesRenderers.length;o++)this._edgesRenderers.data[o].render();r.setAlphaMode(0)}r.setStencilBuffer(a)}_renderOpaqueSorted(t){return n._RenderSorted(t,this._opaqueSortCompareFn,this._scene.activeCamera,!1)}_renderAlphaTestSorted(t){return n._RenderSorted(t,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)}_renderTransparentSorted(t){return n._RenderSorted(t,this._transparentSortCompareFn,this._scene.activeCamera,!0)}static _RenderSorted(t,e,i,s){let r=0,a,o=i?i.globalPosition:n._ZeroVector;if(s)for(;r<t.length;r++)a=t.data[r],a._alphaIndex=a.getMesh().alphaIndex,a._distanceToCamera=v.Distance(a.getBoundingInfo().boundingSphere.centerWorld,o);let h=t.length===t.data.length?t.data:t.data.slice(0,t.length);e&&h.sort(e);let l=h[0].getMesh().getScene();for(r=0;r<h.length;r++)if(a=h[r],!(l._activeMeshesFrozenButKeepClipping&&!a.isInFrustum(l._frustumPlanes))){if(s){let c=a.getMaterial();if(c&&c.needDepthPrePass){let d=c.getScene().getEngine();d.setColorWrite(!1),d.setAlphaMode(0),a.render(!1),d.setColorWrite(!0)}}a.render(s)}}static defaultTransparentSortCompare(t,e){return t._alphaIndex>e._alphaIndex?1:t._alphaIndex<e._alphaIndex?-1:n.backToFrontSortCompare(t,e)}static backToFrontSortCompare(t,e){return t._distanceToCamera<e._distanceToCamera?1:t._distanceToCamera>e._distanceToCamera?-1:0}static frontToBackSortCompare(t,e){return t._distanceToCamera<e._distanceToCamera?-1:t._distanceToCamera>e._distanceToCamera?1:0}static PainterSortCompare(t,e){let i=t.getMesh(),s=e.getMesh();return i.material&&s.material?i.material.uniqueId-s.material.uniqueId:i.uniqueId-s.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(t,e,i){e===void 0&&(e=t.getMesh()),i===void 0&&(i=t.getMaterial()),i!=null&&(i.needAlphaBlendingForMesh(e)?this._transparentSubMeshes.push(t):i.needAlphaTesting()?(i.needDepthPrePass&&this._depthOnlySubMeshes.push(t),this._alphaTestSubMeshes.push(t)):(i.needDepthPrePass&&this._depthOnlySubMeshes.push(t),this._opaqueSubMeshes.push(t)),e._renderingGroup=this,e._edgesRenderer&&e._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(e._edgesRenderer),this._empty=!1)}dispatchSprites(t){this._spriteManagers.push(t),this._empty=!1}dispatchParticles(t){this._particleSystems.push(t),this._empty=!1}_renderParticles(t){if(this._particleSystems.length===0)return;let e=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let i=0;i<this._particleSystems.length;i++){let s=this._particleSystems.data[i];if((e&&e.layerMask&s.layerMask)===0)continue;let r=s.emitter;(!r.position||!t||t.indexOf(r)!==-1)&&this._scene._activeParticles.addCount(s.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||this._spriteManagers.length===0)return;let t=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let e=0;e<this._spriteManagers.length;e++){let i=this._spriteManagers.data[e];(t&&t.layerMask&i.layerMask)!==0&&i.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}};os._ZeroVector=v.Zero();var lr=class{},hs=(()=>{class n{constructor(e){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new lr,this._maintainStateBetweenFrames=!1,this._scene=e;for(let i=n.MIN_RENDERINGGROUPS;i<n.MAX_RENDERINGGROUPS;i++)this._autoClearDepthStencil[i]={autoClear:!0,depth:!0,stencil:!0}}get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(e){if(e!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=e,!this._maintainStateBetweenFrames)){for(let i of this._scene.meshes)if(i.subMeshes)for(let s of i.subMeshes)s._wasDispatched=!1;for(let i of this._scene.spriteManagers)i._wasDispatched=!1;for(let i of this._scene.particleSystems)i._wasDispatched=!1}}getRenderingGroup(e){let i=e||0;return this._prepareRenderingGroup(i),this._renderingGroups[i]}_clearDepthStencilBuffer(e=!0,i=!0){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,e,i),this._depthStencilBufferAlreadyCleaned=!0)}render(e,i,s,r){let a=this._renderingGroupInfo;if(a.scene=this._scene,a.camera=this._scene.activeCamera,this._scene.spriteManagers&&r)for(let o=0;o<this._scene.spriteManagers.length;o++){let h=this._scene.spriteManagers[o];this.dispatchSprites(h)}for(let o=n.MIN_RENDERINGGROUPS;o<n.MAX_RENDERINGGROUPS;o++){this._depthStencilBufferAlreadyCleaned=o===n.MIN_RENDERINGGROUPS;let h=this._renderingGroups[o];if(!h||h._empty)continue;let l=Math.pow(2,o);if(a.renderingGroupId=o,this._scene.onBeforeRenderingGroupObservable.notifyObservers(a,l),n.AUTOCLEAR){let c=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(o):this._autoClearDepthStencil[o];c&&c.autoClear&&this._clearDepthStencilBuffer(c.depth,c.stencil)}for(let c of this._scene._beforeRenderingGroupDrawStage)c.action(o);h.render(e,r,s,i);for(let c of this._scene._afterRenderingGroupDrawStage)c.action(o);this._scene.onAfterRenderingGroupObservable.notifyObservers(a,l)}}reset(){if(!this.maintainStateBetweenFrames)for(let e=n.MIN_RENDERINGGROUPS;e<n.MAX_RENDERINGGROUPS;e++){let i=this._renderingGroups[e];i&&i.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let e=n.MIN_RENDERINGGROUPS;e<n.MAX_RENDERINGGROUPS;e++){let i=this._renderingGroups[e];i&&i.prepareSprites()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let e=n.MIN_RENDERINGGROUPS;e<n.MAX_RENDERINGGROUPS;e++){let i=this._renderingGroups[e];i&&i.dispose()}}_prepareRenderingGroup(e){this._renderingGroups[e]===void 0&&(this._renderingGroups[e]=new os(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]))}dispatchSprites(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchSprites(e))}dispatchParticles(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchParticles(e))}dispatch(e,i,s){i===void 0&&(i=e.getMesh()),!(this.maintainStateBetweenFrames&&e._wasDispatched)&&(e._wasDispatched=!0,this.getRenderingGroup(i.renderingGroupId).dispatch(e,i,s))}setRenderingOrder(e,i=null,s=null,r=null){if(this._customOpaqueSortCompareFn[e]=i,this._customAlphaTestSortCompareFn[e]=s,this._customTransparentSortCompareFn[e]=r,this._renderingGroups[e]){let a=this._renderingGroups[e];a.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],a.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],a.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}}setRenderingAutoClearDepthStencil(e,i,s=!0,r=!0){this._autoClearDepthStencil[e]={autoClear:i,depth:s,stencil:r}}getAutoClearDepthStencilSetup(e){return this._autoClearDepthStencil[e]}}return n.MAX_RENDERINGGROUPS=4,n.MIN_RENDERINGGROUPS=0,n.AUTOCLEAR=!0,n})(),fi=(()=>{class n{}return n.NAME_EFFECTLAYER="EffectLayer",n.NAME_LAYER="Layer",n.NAME_LENSFLARESYSTEM="LensFlareSystem",n.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer",n.NAME_PARTICLESYSTEM="ParticleSystem",n.NAME_GAMEPAD="Gamepad",n.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue",n.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer",n.NAME_PREPASSRENDERER="PrePassRenderer",n.NAME_DEPTHRENDERER="DepthRenderer",n.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer",n.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager",n.NAME_SPRITE="Sprite",n.NAME_SUBSURFACE="SubSurface",n.NAME_OUTLINERENDERER="Outline",n.NAME_PROCEDURALTEXTURE="ProceduralTexture",n.NAME_SHADOWGENERATOR="ShadowGenerator",n.NAME_OCTREE="Octree",n.NAME_PHYSICSENGINE="PhysicsEngine",n.NAME_AUDIO="Audio",n.NAME_FLUIDRENDERER="FluidRenderer",n.STEP_ISREADYFORMESH_EFFECTLAYER=0,n.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0,n.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0,n.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0,n.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1,n.STEP_BEFORECAMERADRAW_PREPASS=0,n.STEP_BEFORECAMERADRAW_EFFECTLAYER=1,n.STEP_BEFORECAMERADRAW_LAYER=2,n.STEP_BEFORERENDERTARGETDRAW_PREPASS=0,n.STEP_BEFORERENDERTARGETDRAW_LAYER=1,n.STEP_BEFORERENDERINGMESH_PREPASS=0,n.STEP_BEFORERENDERINGMESH_OUTLINE=1,n.STEP_AFTERRENDERINGMESH_PREPASS=0,n.STEP_AFTERRENDERINGMESH_OUTLINE=1,n.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0,n.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1,n.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0,n.STEP_BEFORECAMERAUPDATE_GAMEPAD=1,n.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0,n.STEP_BEFORECLEAR_PREPASS=1,n.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0,n.STEP_AFTERRENDERTARGETDRAW_PREPASS=0,n.STEP_AFTERRENDERTARGETDRAW_LAYER=1,n.STEP_AFTERCAMERADRAW_PREPASS=0,n.STEP_AFTERCAMERADRAW_EFFECTLAYER=1,n.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2,n.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3,n.STEP_AFTERCAMERADRAW_LAYER=4,n.STEP_AFTERCAMERADRAW_FLUIDRENDERER=5,n.STEP_AFTERCAMERAPOSTPROCESS_LAYER=0,n.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER=0,n.STEP_AFTERRENDER_AUDIO=0,n.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0,n.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1,n.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2,n.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3,n.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0,n.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER=1,n.STEP_POINTERMOVE_SPRITE=0,n.STEP_POINTERDOWN_SPRITE=0,n.STEP_POINTERUP_SPRITE=0,n})(),ge=class n extends Array{constructor(t){super(...t)}static Create(){return Object.create(n.prototype)}registerStep(t,e,i){let s=0,r=Number.MAX_VALUE;for(;s<this.length&&(r=this[s].index,!(t<r));s++);this.splice(s,0,{index:t,component:e,action:i.bind(e)})}clear(){this.length=0}},ce=(()=>{class n{}return n.POINTERDOWN=1,n.POINTERUP=2,n.POINTERMOVE=4,n.POINTERWHEEL=8,n.POINTERPICK=16,n.POINTERTAP=32,n.POINTERDOUBLETAP=64,n})(),ls=class{constructor(t,e){this.type=t,this.event=e}},cr=class extends ls{constructor(t,e,i,s){super(t,e),this.ray=null,this.originalPickingInfo=null,this.skipOnPointerObservable=!1,this.localPosition=new ve(i,s)}},Rt=class extends ls{constructor(t,e,i,s=null){super(t,e),this._pickInfo=i,this._inputManager=s}get pickInfo(){return this._pickInfo||this._generatePickInfo(),this._pickInfo}_generatePickInfo(){this._inputManager&&(this._pickInfo=this._inputManager._pickMove(this.event.pointerId),this._inputManager._setRayOnPointerInfo(this._pickInfo,this.event),this._inputManager=null)}},Si=(()=>{class n{constructor(){this.hoverCursor="",this.actions=new Array,this.isRecursive=!1}static get HasTriggers(){for(let e in n.Triggers)if(Object.prototype.hasOwnProperty.call(n.Triggers,e))return!0;return!1}static get HasPickTriggers(){for(let e in n.Triggers)if(Object.prototype.hasOwnProperty.call(n.Triggers,e)){let i=parseInt(e);if(i>=1&&i<=7)return!0}return!1}static HasSpecificTrigger(e){for(let i in n.Triggers)if(Object.prototype.hasOwnProperty.call(n.Triggers,i)&&parseInt(i)===e)return!0;return!1}}return n.Triggers={},n})(),rn=(()=>{class n{}return n.KEYDOWN=1,n.KEYUP=2,n})(),Li=class{constructor(t,e){this.type=t,this.event=e}},cs=class extends Li{constructor(t,e){super(t,e),this.type=t,this.event=e,this.skipOnKeyboardObservable=!1}get skipOnPointerObservable(){return this.skipOnKeyboardObservable}set skipOnPointerObservable(t){this.skipOnKeyboardObservable=t}},U;(function(n){n[n.Generic=0]="Generic",n[n.Keyboard=1]="Keyboard",n[n.Mouse=2]="Mouse",n[n.Touch=3]="Touch",n[n.DualShock=4]="DualShock",n[n.Xbox=5]="Xbox",n[n.Switch=6]="Switch",n[n.DualSense=7]="DualSense"})(U||(U={}));var X;(function(n){n[n.Horizontal=0]="Horizontal",n[n.Vertical=1]="Vertical",n[n.LeftClick=2]="LeftClick",n[n.MiddleClick=3]="MiddleClick",n[n.RightClick=4]="RightClick",n[n.BrowserBack=5]="BrowserBack",n[n.BrowserForward=6]="BrowserForward",n[n.MouseWheelX=7]="MouseWheelX",n[n.MouseWheelY=8]="MouseWheelY",n[n.MouseWheelZ=9]="MouseWheelZ",n[n.Move=12]="Move"})(X||(X={}));var ds;(function(n){n[n.Horizontal=0]="Horizontal",n[n.Vertical=1]="Vertical",n[n.LeftClick=2]="LeftClick",n[n.MiddleClick=3]="MiddleClick",n[n.RightClick=4]="RightClick",n[n.BrowserBack=5]="BrowserBack",n[n.BrowserForward=6]="BrowserForward",n[n.MouseWheelX=7]="MouseWheelX",n[n.MouseWheelY=8]="MouseWheelY",n[n.MouseWheelZ=9]="MouseWheelZ",n[n.DeltaHorizontal=10]="DeltaHorizontal",n[n.DeltaVertical=11]="DeltaVertical"})(ds||(ds={}));var nn;(function(n){n[n.Cross=0]="Cross",n[n.Circle=1]="Circle",n[n.Square=2]="Square",n[n.Triangle=3]="Triangle",n[n.L1=4]="L1",n[n.R1=5]="R1",n[n.L2=6]="L2",n[n.R2=7]="R2",n[n.Share=8]="Share",n[n.Options=9]="Options",n[n.L3=10]="L3",n[n.R3=11]="R3",n[n.DPadUp=12]="DPadUp",n[n.DPadDown=13]="DPadDown",n[n.DPadLeft=14]="DPadLeft",n[n.DPadRight=15]="DPadRight",n[n.Home=16]="Home",n[n.TouchPad=17]="TouchPad",n[n.LStickXAxis=18]="LStickXAxis",n[n.LStickYAxis=19]="LStickYAxis",n[n.RStickXAxis=20]="RStickXAxis",n[n.RStickYAxis=21]="RStickYAxis"})(nn||(nn={}));var an;(function(n){n[n.Cross=0]="Cross",n[n.Circle=1]="Circle",n[n.Square=2]="Square",n[n.Triangle=3]="Triangle",n[n.L1=4]="L1",n[n.R1=5]="R1",n[n.L2=6]="L2",n[n.R2=7]="R2",n[n.Create=8]="Create",n[n.Options=9]="Options",n[n.L3=10]="L3",n[n.R3=11]="R3",n[n.DPadUp=12]="DPadUp",n[n.DPadDown=13]="DPadDown",n[n.DPadLeft=14]="DPadLeft",n[n.DPadRight=15]="DPadRight",n[n.Home=16]="Home",n[n.TouchPad=17]="TouchPad",n[n.LStickXAxis=18]="LStickXAxis",n[n.LStickYAxis=19]="LStickYAxis",n[n.RStickXAxis=20]="RStickXAxis",n[n.RStickYAxis=21]="RStickYAxis"})(an||(an={}));var on;(function(n){n[n.A=0]="A",n[n.B=1]="B",n[n.X=2]="X",n[n.Y=3]="Y",n[n.LB=4]="LB",n[n.RB=5]="RB",n[n.LT=6]="LT",n[n.RT=7]="RT",n[n.Back=8]="Back",n[n.Start=9]="Start",n[n.LS=10]="LS",n[n.RS=11]="RS",n[n.DPadUp=12]="DPadUp",n[n.DPadDown=13]="DPadDown",n[n.DPadLeft=14]="DPadLeft",n[n.DPadRight=15]="DPadRight",n[n.Home=16]="Home",n[n.LStickXAxis=17]="LStickXAxis",n[n.LStickYAxis=18]="LStickYAxis",n[n.RStickXAxis=19]="RStickXAxis",n[n.RStickYAxis=20]="RStickYAxis"})(on||(on={}));var hn;(function(n){n[n.B=0]="B",n[n.A=1]="A",n[n.Y=2]="Y",n[n.X=3]="X",n[n.L=4]="L",n[n.R=5]="R",n[n.ZL=6]="ZL",n[n.ZR=7]="ZR",n[n.Minus=8]="Minus",n[n.Plus=9]="Plus",n[n.LS=10]="LS",n[n.RS=11]="RS",n[n.DPadUp=12]="DPadUp",n[n.DPadDown=13]="DPadDown",n[n.DPadLeft=14]="DPadLeft",n[n.DPadRight=15]="DPadRight",n[n.Home=16]="Home",n[n.Capture=17]="Capture",n[n.LStickXAxis=18]="LStickXAxis",n[n.LStickYAxis=19]="LStickYAxis",n[n.RStickXAxis=20]="RStickXAxis",n[n.RStickYAxis=21]="RStickYAxis"})(hn||(hn={}));var ln;(function(n){n[n.PointerMove=0]="PointerMove",n[n.PointerDown=1]="PointerDown",n[n.PointerUp=2]="PointerUp"})(ln||(ln={}));var la=(()=>{class n{}return n.DOM_DELTA_PIXEL=0,n.DOM_DELTA_LINE=1,n.DOM_DELTA_PAGE=2,n})(),It=class{static CreateDeviceEvent(t,e,i,s,r,a){switch(t){case U.Keyboard:return this._CreateKeyboardEvent(i,s,r,a);case U.Mouse:if(i===X.MouseWheelX||i===X.MouseWheelY||i===X.MouseWheelZ)return this._CreateWheelEvent(t,e,i,s,r,a);case U.Touch:return this._CreatePointerEvent(t,e,i,s,r,a);default:throw`Unable to generate event for device ${U[t]}`}}static _CreatePointerEvent(t,e,i,s,r,a){let o=this._CreateMouseEvent(t,e,i,s,r,a);return t===U.Mouse?(o.deviceType=U.Mouse,o.pointerId=1,o.pointerType="mouse"):(o.deviceType=U.Touch,o.pointerId=e,o.pointerType="touch"),i===X.Move?o.type="pointermove":i>=X.LeftClick&&i<=X.RightClick&&(o.type=s===1?"pointerdown":"pointerup",o.button=i-2),o}static _CreateWheelEvent(t,e,i,s,r,a){let o=this._CreateMouseEvent(t,e,i,s,r,a);switch(o.type="wheel",o.deltaMode=la.DOM_DELTA_PIXEL,o.deltaX=0,o.deltaY=0,o.deltaZ=0,i){case X.MouseWheelX:o.deltaX=s;break;case X.MouseWheelY:o.deltaY=s;break;case X.MouseWheelZ:o.deltaZ=s;break}return o}static _CreateMouseEvent(t,e,i,s,r,a){let o=this._CreateEvent(a),h=r.pollInput(t,e,X.Horizontal),l=r.pollInput(t,e,X.Vertical);return a?(o.movementX=0,o.movementY=0,o.offsetX=o.movementX-a.getBoundingClientRect().x,o.offsetY=o.movementY-a.getBoundingClientRect().y):(o.movementX=r.pollInput(t,e,ds.DeltaHorizontal),o.movementY=r.pollInput(t,e,ds.DeltaVertical),o.offsetX=0,o.offsetY=0),this._CheckNonCharacterKeys(o,r),o.clientX=h,o.clientY=l,o.x=h,o.y=l,o.deviceType=t,o.deviceSlot=e,o.inputIndex=i,o}static _CreateKeyboardEvent(t,e,i,s){let r=this._CreateEvent(s);return this._CheckNonCharacterKeys(r,i),r.deviceType=U.Keyboard,r.deviceSlot=0,r.inputIndex=t,r.type=e===1?"keydown":"keyup",r.key=String.fromCharCode(t),r.keyCode=t,r}static _CheckNonCharacterKeys(t,e){let i=e.isDeviceAvailable(U.Keyboard),s=i&&e.pollInput(U.Keyboard,0,18)===1,r=i&&e.pollInput(U.Keyboard,0,17)===1,a=i&&(e.pollInput(U.Keyboard,0,91)===1||e.pollInput(U.Keyboard,0,92)===1||e.pollInput(U.Keyboard,0,93)===1),o=i&&e.pollInput(U.Keyboard,0,16)===1;t.altKey=s,t.ctrlKey=r,t.metaKey=a,t.shiftKey=o}static _CreateEvent(t){let e={};return e.preventDefault=()=>{},e.target=t,e}},dr=class{constructor(t,e,i){this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(t,e,(s,r,a,o)=>{let h=It.CreateDeviceEvent(s,r,a,o,this);i(s,r,h)}):this._createDummyNativeInput()}pollInput(t,e,i){return this._nativeInput.pollInput(t,e,i)}isDeviceAvailable(t){return t===U.Mouse||t===U.Touch}dispose(){this._nativeInput.dispose()}_createDummyNativeInput(){return{pollInput:()=>0,isDeviceAvailable:()=>!1,dispose:()=>{}}}},cn=255,dn=Object.keys(X).length/2,ur=class{constructor(t,e,i,s){this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=Z.IsSafari(),this._usingMacOS=/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=r=>{},this._keyboardUpEvent=r=>{},this._keyboardBlurEvent=r=>{},this._pointerMoveEvent=r=>{},this._pointerDownEvent=r=>{},this._pointerUpEvent=r=>{},this._pointerCancelEvent=r=>{},this._pointerWheelEvent=r=>{},this._pointerBlurEvent=r=>{},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=zs.IsNavigatorAvailable()&&navigator.userAgent&&navigator.userAgent.indexOf("Firefox")!==-1,this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=r=>{},this._gamepadDisconnectedEvent=r=>{},this._eventPrefix=Z.GetPointerPrefix(t),this._engine=t,this._onDeviceConnected=e,this._onDeviceDisconnected=i,this._onInputChanged=s,this._enableEvents(),this._usingMacOS&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=()=>{this._enableEvents()})}pollInput(t,e,i){let s=this._inputs[t][e];if(!s)throw`Unable to find device ${U[t]}`;t>=U.DualShock&&t<=U.DualSense&&this._updateDevice(t,e,i);let r=s[i];if(r===void 0)throw`Unable to find input ${i} for device ${U[t]} in slot ${e}`;return i===X.Move&&Z.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),r}isDeviceAvailable(t){return this._inputs[t]!==void 0}dispose(){this._onDeviceConnected=()=>{},this._onDeviceDisconnected=()=>{},this._onInputChanged=()=>{},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()}_enableEvents(){let t=this===null||this===void 0?void 0:this._engine.getInputElement();if(t&&(!this._eventsAttached||this._elementToAttachTo!==t)){if(this._disableEvents(),this._inputs){for(let e of this._inputs)if(e)for(let i in e){let s=+i,r=e[s];if(r)for(let a=0;a<r.length;a++)r[a]=0}}this._elementToAttachTo=t,this._elementToAttachTo.tabIndex=this._elementToAttachTo.tabIndex!==-1?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}}_disableEvents(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1}_checkForConnectedDevices(){if(navigator.getGamepads){let t=navigator.getGamepads();for(let e of t)e&&this._addGamePad(e)}typeof matchMedia=="function"&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(U.Mouse,0,0,0)}_addGamePad(t){let e=this._getGamepadDeviceType(t.id),i=t.index;this._gamepads=this._gamepads||new Array(t.index+1),this._registerDevice(e,i,t.buttons.length+t.axes.length),this._gamepads[i]=e}_addPointerDevice(t,e,i,s){this._pointerActive||(this._pointerActive=!0),this._registerDevice(t,e,dn);let r=this._inputs[t][e];r[0]=i,r[1]=s}_registerDevice(t,e,i){if(e===void 0)throw`Unable to register device ${U[t]} to undefined slot.`;if(this._inputs[t]||(this._inputs[t]={}),!this._inputs[t][e]){let s=new Array(i);s.fill(0),this._inputs[t][e]=s,this._onDeviceConnected(t,e)}}_unregisterDevice(t,e){this._inputs[t][e]&&(delete this._inputs[t][e],this._onDeviceDisconnected(t,e))}_handleKeyActions(){this._keyboardDownEvent=t=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(U.Keyboard,0,cn));let e=this._inputs[U.Keyboard][0];if(e){e[t.keyCode]=1;let i=t;i.inputIndex=t.keyCode,this._usingMacOS&&t.metaKey&&t.key!=="Meta"&&(this._metaKeys.includes(t.keyCode)||this._metaKeys.push(t.keyCode)),this._onInputChanged(U.Keyboard,0,i)}},this._keyboardUpEvent=t=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(U.Keyboard,0,cn));let e=this._inputs[U.Keyboard][0];if(e){e[t.keyCode]=0;let i=t;if(i.inputIndex=t.keyCode,this._usingMacOS&&t.key==="Meta"&&this._metaKeys.length>0){for(let s of this._metaKeys){let r=It.CreateDeviceEvent(U.Keyboard,0,s,0,this,this._elementToAttachTo);e[s]=0,this._onInputChanged(U.Keyboard,0,r)}this._metaKeys.splice(0,this._metaKeys.length)}this._onInputChanged(U.Keyboard,0,i)}},this._keyboardBlurEvent=()=>{if(this._keyboardActive){let t=this._inputs[U.Keyboard][0];for(let e=0;e<t.length;e++)if(t[e]!==0){t[e]=0;let i=It.CreateDeviceEvent(U.Keyboard,0,e,0,this,this._elementToAttachTo);this._onInputChanged(U.Keyboard,0,i)}this._usingMacOS&&this._metaKeys.splice(0,this._metaKeys.length)}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)}_handlePointerActions(){this._maxTouchPoints=zs.IsNavigatorAvailable()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(let i=0;i<this._maxTouchPoints;i++)this._activeTouchIds[i]=-1;this._pointerMoveEvent=i=>{let s=this._getPointerType(i),r=s===U.Mouse?0:this._activeTouchIds.indexOf(i.pointerId);this._inputs[s]||(this._inputs[s]={}),this._inputs[s][r]||this._addPointerDevice(s,r,i.clientX,i.clientY);let a=this._inputs[s][r];if(a){let o=i;o.inputIndex=X.Move,a[X.Horizontal]=i.clientX,a[X.Vertical]=i.clientY,this._onInputChanged(s,r,o),!this._usingSafari&&i.button!==-1&&(o.inputIndex=i.button+2,a[i.button+2]=a[i.button+2]?0:1,this._onInputChanged(s,r,o))}},this._pointerDownEvent=i=>{let s=this._getPointerType(i),r=s===U.Mouse?0:i.pointerId;if(s===U.Touch){let o=this._activeTouchIds.indexOf(-1);if(o>=0)r=o,this._activeTouchIds[o]=i.pointerId;else{Z.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);return}}this._inputs[s]||(this._inputs[s]={}),this._inputs[s][r]?s===U.Touch&&this._onDeviceConnected(s,r):this._addPointerDevice(s,r,i.clientX,i.clientY);let a=this._inputs[s][r];if(a){let o=a[X.Horizontal],h=a[X.Vertical];if(s===U.Mouse){if(this._mouseId===-1&&(i.pointerId===void 0?this._mouseId=this._isUsingFirefox?0:1:this._mouseId=i.pointerId),!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(this._mouseId)}catch{}}else if(i.pointerId&&!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(i.pointerId)}catch{}a[X.Horizontal]=i.clientX,a[X.Vertical]=i.clientY,a[i.button+2]=1;let l=i;l.inputIndex=i.button+2,this._onInputChanged(s,r,l),(o!==i.clientX||h!==i.clientY)&&(l.inputIndex=X.Move,this._onInputChanged(s,r,l))}},this._pointerUpEvent=i=>{var s,r,a,o,h;let l=this._getPointerType(i),c=l===U.Mouse?0:this._activeTouchIds.indexOf(i.pointerId);if(l===U.Touch){if(c===-1)return;this._activeTouchIds[c]=-1}let d=(s=this._inputs[l])===null||s===void 0?void 0:s[c];if(d&&d[i.button+2]!==0){let u=d[X.Horizontal],f=d[X.Vertical];d[X.Horizontal]=i.clientX,d[X.Vertical]=i.clientY,d[i.button+2]=0;let _=i;(u!==i.clientX||f!==i.clientY)&&(_.inputIndex=X.Move,this._onInputChanged(l,c,_)),_.inputIndex=i.button+2,l===U.Mouse&&this._mouseId>=0&&!((a=(r=this._elementToAttachTo).hasPointerCapture)===null||a===void 0)&&a.call(r,this._mouseId)?this._elementToAttachTo.releasePointerCapture(this._mouseId):i.pointerId&&!((h=(o=this._elementToAttachTo).hasPointerCapture)===null||h===void 0)&&h.call(o,i.pointerId)&&this._elementToAttachTo.releasePointerCapture(i.pointerId),this._onInputChanged(l,c,_),l===U.Touch&&this._onDeviceDisconnected(l,c)}},this._pointerCancelEvent=i=>{var s,r,a,o;if(i.pointerType==="mouse"){let h=this._inputs[U.Mouse][0];this._mouseId>=0&&!((r=(s=this._elementToAttachTo).hasPointerCapture)===null||r===void 0)&&r.call(s,this._mouseId)&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let l=X.LeftClick;l<=X.BrowserForward;l++)if(h[l]===1){h[l]=0;let c=It.CreateDeviceEvent(U.Mouse,0,l,0,this,this._elementToAttachTo);this._onInputChanged(U.Mouse,0,c)}}else{let h=this._activeTouchIds.indexOf(i.pointerId);!((o=(a=this._elementToAttachTo).hasPointerCapture)===null||o===void 0)&&o.call(a,i.pointerId)&&this._elementToAttachTo.releasePointerCapture(i.pointerId),this._inputs[U.Touch][h][X.LeftClick]=0;let l=It.CreateDeviceEvent(U.Touch,h,X.LeftClick,0,this,this._elementToAttachTo);this._onInputChanged(U.Touch,h,l),this._activeTouchIds[h]=-1,this._onDeviceDisconnected(U.Touch,h)}},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==void 0?"mousewheel":"DOMMouseScroll";let t=!1,e=function(){};try{let i=Object.defineProperty({},"passive",{get:function(){t=!0}});this._elementToAttachTo.addEventListener("test",e,i),this._elementToAttachTo.removeEventListener("test",e,i)}catch{}this._pointerBlurEvent=()=>{var i,s,r,a,o;if(this.isDeviceAvailable(U.Mouse)){let h=this._inputs[U.Mouse][0];this._mouseId>=0&&!((s=(i=this._elementToAttachTo).hasPointerCapture)===null||s===void 0)&&s.call(i,this._mouseId)&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let l=X.LeftClick;l<=X.BrowserForward;l++)if(h[l]===1){h[l]=0;let c=It.CreateDeviceEvent(U.Mouse,0,l,0,this,this._elementToAttachTo);this._onInputChanged(U.Mouse,0,c)}}if(this.isDeviceAvailable(U.Touch)){let h=this._inputs[U.Touch];for(let l=0;l<this._activeTouchIds.length;l++){let c=this._activeTouchIds[l];if(!((a=(r=this._elementToAttachTo).hasPointerCapture)===null||a===void 0)&&a.call(r,c)&&this._elementToAttachTo.releasePointerCapture(c),c!==-1&&((o=h[l])===null||o===void 0?void 0:o[X.LeftClick])===1){h[l][X.LeftClick]=0;let d=It.CreateDeviceEvent(U.Touch,l,X.LeftClick,0,this,this._elementToAttachTo);this._onInputChanged(U.Touch,l,d),this._activeTouchIds[l]=-1,this._onDeviceDisconnected(U.Touch,l)}}}},this._pointerWheelEvent=i=>{let s=U.Mouse,r=0;this._inputs[s]||(this._inputs[s]=[]),this._inputs[s][r]||(this._pointerActive=!0,this._registerDevice(s,r,dn));let a=this._inputs[s][r];if(a){a[X.MouseWheelX]=i.deltaX||0,a[X.MouseWheelY]=i.deltaY||i.wheelDelta||0,a[X.MouseWheelZ]=i.deltaZ||0;let o=i;a[X.MouseWheelX]!==0&&(o.inputIndex=X.MouseWheelX,this._onInputChanged(s,r,o)),a[X.MouseWheelY]!==0&&(o.inputIndex=X.MouseWheelY,this._onInputChanged(s,r,o)),a[X.MouseWheelZ]!==0&&(o.inputIndex=X.MouseWheelZ,this._onInputChanged(s,r,o))}},this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,t?{passive:!1}:!1),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add(()=>{if(this.isDeviceAvailable(U.Mouse)){let i=this._inputs[U.Mouse][0];i[X.MouseWheelX]=0,i[X.MouseWheelY]=0,i[X.MouseWheelZ]=0}})}_handleGamepadActions(){this._gamepadConnectedEvent=t=>{this._addGamePad(t.gamepad)},this._gamepadDisconnectedEvent=t=>{if(this._gamepads){let e=this._getGamepadDeviceType(t.gamepad.id),i=t.gamepad.index;this._unregisterDevice(e,i),delete this._gamepads[i]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)}_updateDevice(t,e,i){let s=navigator.getGamepads()[e];if(s&&t===this._gamepads[e]){let r=this._inputs[t][e];i>=s.buttons.length?r[i]=s.axes[i-s.buttons.length].valueOf():r[i]=s.buttons[i].value}}_getGamepadDeviceType(t){return t.indexOf("054c")!==-1?t.indexOf("0ce6")!==-1?U.DualSense:U.DualShock:t.indexOf("Xbox One")!==-1||t.search("Xbox 360")!==-1||t.search("xinput")!==-1?U.Xbox:t.indexOf("057e")!==-1?U.Switch:U.Generic}_getPointerType(t){let e=U.Mouse;return(t.pointerType==="touch"||t.pointerType==="pen"||t.touches)&&(e=U.Touch),e}},us=class{constructor(t,e,i=0){this.deviceType=e,this.deviceSlot=i,this.onInputChangedObservable=new D,this._deviceInputSystem=t}getInput(t){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,t)}},fr=class{constructor(t){this._registeredManagers=new Array,this._refCount=0,this.registerManager=a=>{for(let o=0;o<this._devices.length;o++){let h=this._devices[o];for(let l in h){let c=+l;a._addDevice(new us(this._deviceInputSystem,o,c))}}this._registeredManagers.push(a)},this.unregisterManager=a=>{let o=this._registeredManagers.indexOf(a);o>-1&&this._registeredManagers.splice(o,1)};let e=Object.keys(U).length/2;this._devices=new Array(e);let i=(a,o)=>{this._devices[a]||(this._devices[a]=new Array),this._devices[a][o]||(this._devices[a][o]=o);for(let h of this._registeredManagers){let l=new us(this._deviceInputSystem,a,o);h._addDevice(l)}},s=(a,o)=>{var h;!((h=this._devices[a])===null||h===void 0)&&h[o]&&delete this._devices[a][o];for(let l of this._registeredManagers)l._removeDevice(a,o)},r=(a,o,h)=>{if(h)for(let l of this._registeredManagers)l._onInputChanged(a,o,h)};typeof _native<"u"?this._deviceInputSystem=new dr(i,s,r):this._deviceInputSystem=new ur(t,i,s,r)}dispose(){this._deviceInputSystem.dispose()}},_r=class{constructor(t){let e=Object.keys(U).length/2;this._devices=new Array(e),this._firstDevice=new Array(e),this._engine=t,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new fr(t)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new D(i=>{for(let s of this._devices)if(s)for(let r of s)r&&this.onDeviceConnectedObservable.notifyObserver(i,r)}),this.onDeviceDisconnectedObservable=new D,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=t.onDisposeObservable.add(()=>{this.dispose()})}getDeviceSource(t,e){if(e===void 0){if(this._firstDevice[t]===void 0)return null;e=this._firstDevice[t]}return!this._devices[t]||this._devices[t][e]===void 0?null:this._devices[t][e]}getDeviceSources(t){return this._devices[t]?this._devices[t].filter(e=>!!e):[]}dispose(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)}_addDevice(t){this._devices[t.deviceType]||(this._devices[t.deviceType]=new Array),this._devices[t.deviceType][t.deviceSlot]||(this._devices[t.deviceType][t.deviceSlot]=t,this._updateFirstDevices(t.deviceType)),this.onDeviceConnectedObservable.notifyObservers(t)}_removeDevice(t,e){var i,s;let r=(i=this._devices[t])===null||i===void 0?void 0:i[e];this.onDeviceDisconnectedObservable.notifyObservers(r),!((s=this._devices[t])===null||s===void 0)&&s[e]&&delete this._devices[t][e],this._updateFirstDevices(t)}_onInputChanged(t,e,i){var s,r;(r=(s=this._devices[t])===null||s===void 0?void 0:s[e])===null||r===void 0||r.onInputChangedObservable.notifyObservers(i)}_updateFirstDevices(t){switch(t){case U.Keyboard:case U.Mouse:this._firstDevice[t]=0;break;case U.Touch:case U.DualSense:case U.DualShock:case U.Xbox:case U.Switch:case U.Generic:{delete this._firstDevice[t];let e=this._devices[t];if(e){for(let i=0;i<e.length;i++)if(e[i]){this._firstDevice[t]=i;break}}break}}}},fs=class{constructor(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}get singleClick(){return this._singleClick}get doubleClick(){return this._doubleClick}get hasSwiped(){return this._hasSwiped}get ignore(){return this._ignore}set singleClick(t){this._singleClick=t}set doubleClick(t){this._doubleClick=t}set hasSwiped(t){this._hasSwiped=t}set ignore(t){this._ignore=t}},Mt=(()=>{class n{constructor(e){this._alreadyAttached=!1,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._totalPointersPressed=0,this._doubleClickOccured=!1,this._isSwiping=!1,this._swipeButtonPressed=-1,this._skipPointerTap=!1,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new ve(0,0),this._previousStartingPointerPosition=new ve(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._movePointerInfo=null,this._cameraObserverCount=0,this._deviceSourceManager=null,this._scene=e||Q.LastCreatedScene,this._scene}get meshUnderPointer(){return this._movePointerInfo&&(this._movePointerInfo._generatePickInfo(),this._movePointerInfo=null),this._pointerOverMesh}getMeshUnderPointerByPointerId(e){return this._meshUnderPointerId[e]||null}get unTranslatedPointer(){return new ve(this._unTranslatedPointerX,this._unTranslatedPointerY)}get pointerX(){return this._pointerX}set pointerX(e){this._pointerX=e}get pointerY(){return this._pointerY}set pointerY(e){this._pointerY=e}_updatePointerPosition(e){let i=this._scene.getEngine().getInputElementClientRect();i&&(this._pointerX=e.clientX-i.left,this._pointerY=e.clientY-i.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)}_processPointerMove(e,i){let s=this._scene,r=s.getEngine(),a=r.getInputElement();a&&(a.tabIndex=r.canvasTabIndex,s.doNotHandleCursors||(a.style.cursor=s.defaultCursor)),this._setCursorAndPointerOverMesh(e,i.pointerId,s);for(let l of s._pointerMoveStage){let c=!!(e!=null&&e.pickedMesh);e=l.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,c,a)}let o=i.inputIndex>=X.MouseWheelX&&i.inputIndex<=X.MouseWheelZ?ce.POINTERWHEEL:ce.POINTERMOVE;s.onPointerMove&&(e=e||this._pickMove(i.pointerId),s.onPointerMove(i,e,o));let h;e?(h=new Rt(o,i,e),this._setRayOnPointerInfo(e,i)):(h=new Rt(o,i,null,this),this._movePointerInfo=h),s.onPointerObservable.hasObservers()&&s.onPointerObservable.notifyObservers(h,o)}_setRayOnPointerInfo(e,i){let s=this._scene;e&&s._pickingAvailable&&(e.ray||(e.ray=s.createPickingRay(i.offsetX,i.offsetY,P.Identity(),s.activeCamera)))}_addCameraPointerObserver(e,i){return this._cameraObserverCount++,this._scene.onPointerObservable.add(e,i)}_removeCameraPointerObserver(e){return this._cameraObserverCount--,this._scene.onPointerObservable.remove(e)}_checkForPicking(){return!!(this._scene.onPointerObservable.observers.length>this._cameraObserverCount||this._scene.onPointerPick)}_checkPrePointerObservable(e,i,s){let r=this._scene,a=new cr(s,i,this._unTranslatedPointerX,this._unTranslatedPointerY);return e&&(a.originalPickingInfo=e,a.ray=e.ray,e.originMesh&&(a.nearInteractionPickingInfo=e)),r.onPrePointerObservable.notifyObservers(a,s),!!a.skipOnPointerObservable}_pickMove(e){let i=this._scene,s=i.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,i.pointerMovePredicate,!1,i.cameraToUseForPointers,i.pointerMoveTrianglePredicate);return this._setCursorAndPointerOverMesh(s,e,i),s}_setCursorAndPointerOverMesh(e,i,s){let r=s.getEngine().getInputElement();if(e!=null&&e.pickedMesh){if(this.setPointerOverMesh(e.pickedMesh,i,e),!s.doNotHandleCursors&&r&&this._pointerOverMesh){let a=this._pointerOverMesh._getActionManagerForTrigger();a&&a.hasPointerTriggers&&(r.style.cursor=a.hoverCursor||s.hoverCursor)}}else this.setPointerOverMesh(null,i,e)}simulatePointerMove(e,i){let s=new PointerEvent("pointermove",i);s.inputIndex=X.Move,!this._checkPrePointerObservable(e,s,ce.POINTERMOVE)&&this._processPointerMove(e,s)}simulatePointerDown(e,i){let s=new PointerEvent("pointerdown",i);s.inputIndex=s.button+2,!this._checkPrePointerObservable(e,s,ce.POINTERDOWN)&&this._processPointerDown(e,s)}_processPointerDown(e,i){let s=this._scene;if(e!=null&&e.pickedMesh){this._pickedDownMesh=e.pickedMesh;let o=e.pickedMesh._getActionManagerForTrigger();if(o){if(o.hasPickTriggers)switch(o.processTrigger(5,Be.CreateNew(e.pickedMesh,i)),i.button){case 0:o.processTrigger(2,Be.CreateNew(e.pickedMesh,i));break;case 1:o.processTrigger(4,Be.CreateNew(e.pickedMesh,i));break;case 2:o.processTrigger(3,Be.CreateNew(e.pickedMesh,i));break}o.hasSpecificTrigger(8)&&window.setTimeout(()=>{let h=s.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,l=>l.isPickable&&l.isVisible&&l.isReady()&&l.actionManager&&l.actionManager.hasSpecificTrigger(8)&&l===this._pickedDownMesh,!1,s.cameraToUseForPointers);h!=null&&h.pickedMesh&&o&&this._totalPointersPressed!==0&&Date.now()-this._startingPointerTime>n.LongPressDelay&&!this._isPointerSwiping()&&(this._startingPointerTime=0,o.processTrigger(8,Be.CreateNew(h.pickedMesh,i)))},n.LongPressDelay)}}else for(let o of s._pointerDownStage)e=o.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,i,!1);let r,a=ce.POINTERDOWN;e?(s.onPointerDown&&s.onPointerDown(i,e,a),r=new Rt(a,i,e),this._setRayOnPointerInfo(e,i)):r=new Rt(a,i,null,this),s.onPointerObservable.hasObservers()&&s.onPointerObservable.notifyObservers(r,a)}_isPointerSwiping(){return this._isSwiping}simulatePointerUp(e,i,s){let r=new PointerEvent("pointerup",i);r.inputIndex=X.Move;let a=new fs;s?a.doubleClick=!0:a.singleClick=!0,!this._checkPrePointerObservable(e,r,ce.POINTERUP)&&this._processPointerUp(e,r,a)}_processPointerUp(e,i,s){let r=this._scene;if(e!=null&&e.pickedMesh){if(this._pickedUpMesh=e.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(r.onPointerPick&&r.onPointerPick(i,e),s.singleClick&&!s.ignore&&r.onPointerObservable.observers.length>this._cameraObserverCount)){let o=ce.POINTERPICK,h=new Rt(o,i,e);this._setRayOnPointerInfo(e,i),r.onPointerObservable.notifyObservers(h,o)}let a=e.pickedMesh._getActionManagerForTrigger();if(a&&!s.ignore){a.processTrigger(7,Be.CreateNew(e.pickedMesh,i,e)),!s.hasSwiped&&s.singleClick&&a.processTrigger(1,Be.CreateNew(e.pickedMesh,i,e));let o=e.pickedMesh._getActionManagerForTrigger(6);s.doubleClick&&o&&o.processTrigger(6,Be.CreateNew(e.pickedMesh,i,e))}}else if(!s.ignore)for(let a of r._pointerUpStage)e=a.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,i,s.doubleClick);if(this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh){let a=this._pickedDownMesh._getActionManagerForTrigger(16);a&&a.processTrigger(16,Be.CreateNew(this._pickedDownMesh,i))}if(!s.ignore){let a=new Rt(ce.POINTERUP,i,e);if(this._setRayOnPointerInfo(e,i),r.onPointerObservable.notifyObservers(a,ce.POINTERUP),r.onPointerUp&&r.onPointerUp(i,e,ce.POINTERUP),!s.hasSwiped&&!this._skipPointerTap){let o=0;if(s.singleClick?o=ce.POINTERTAP:s.doubleClick&&(o=ce.POINTERDOUBLETAP),o){let h=new Rt(o,i,e);r.onPointerObservable.hasObservers()&&r.onPointerObservable.hasSpecificMask(o)&&r.onPointerObservable.notifyObservers(h,o)}}}}isPointerCaptured(e=0){return this._pointerCaptures[e]}attachControl(e=!0,i=!0,s=!0,r=null){let a=this._scene,o=a.getEngine();r||(r=o.getInputElement()),this._alreadyAttached&&this.detachControl(),r&&(this._alreadyAttachedTo=r),this._deviceSourceManager=new _r(o),this._initActionManager=h=>{if(!this._meshPickProceed){let l=a.skipPointerUpPicking||a._registeredActions===0&&!this._checkForPicking()&&!a.onPointerUp?null:a.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,a.pointerUpPredicate,!1,a.cameraToUseForPointers);this._currentPickResult=l,l&&(h=l.hit&&l.pickedMesh?l.pickedMesh._getActionManagerForTrigger():null),this._meshPickProceed=!0}return h},this._delayedSimpleClick=(h,l,c)=>{(Date.now()-this._previousStartingPointerTime>n.DoubleClickDelay&&!this._doubleClickOccured||h!==this._previousButtonPressed)&&(this._doubleClickOccured=!1,l.singleClick=!0,l.ignore=!1,c(l,this._currentPickResult))},this._initClickEvent=(h,l,c,d)=>{let u=new fs;this._currentPickResult=null;let f=null,_=h.hasSpecificMask(ce.POINTERPICK)||l.hasSpecificMask(ce.POINTERPICK)||h.hasSpecificMask(ce.POINTERTAP)||l.hasSpecificMask(ce.POINTERTAP)||h.hasSpecificMask(ce.POINTERDOUBLETAP)||l.hasSpecificMask(ce.POINTERDOUBLETAP);!_&&Si&&(f=this._initActionManager(f,u),f&&(_=f.hasPickTriggers));let g=!1;if(_){let p=c.button;if(u.hasSwiped=this._isPointerSwiping(),!u.hasSwiped){let E=!n.ExclusiveDoubleClickMode;E||(E=!h.hasSpecificMask(ce.POINTERDOUBLETAP)&&!l.hasSpecificMask(ce.POINTERDOUBLETAP),E&&!Si.HasSpecificTrigger(6)&&(f=this._initActionManager(f,u),f&&(E=!f.hasSpecificTrigger(6)))),E?(Date.now()-this._previousStartingPointerTime>n.DoubleClickDelay||p!==this._previousButtonPressed)&&(u.singleClick=!0,d(u,this._currentPickResult),g=!0):(this._previousDelayedSimpleClickTimeout=this._delayedSimpleClickTimeout,this._delayedSimpleClickTimeout=window.setTimeout(this._delayedSimpleClick.bind(this,p,u,d),n.DoubleClickDelay));let T=h.hasSpecificMask(ce.POINTERDOUBLETAP)||l.hasSpecificMask(ce.POINTERDOUBLETAP);!T&&Si.HasSpecificTrigger(6)&&(f=this._initActionManager(f,u),f&&(T=f.hasSpecificTrigger(6))),T&&(p===this._previousButtonPressed&&Date.now()-this._previousStartingPointerTime<n.DoubleClickDelay&&!this._doubleClickOccured?(!u.hasSwiped&&!this._isPointerSwiping()?(this._previousStartingPointerTime=0,this._doubleClickOccured=!0,u.doubleClick=!0,u.ignore=!1,n.ExclusiveDoubleClickMode&&this._previousDelayedSimpleClickTimeout&&clearTimeout(this._previousDelayedSimpleClickTimeout),this._previousDelayedSimpleClickTimeout=this._delayedSimpleClickTimeout,d(u,this._currentPickResult)):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=p,n.ExclusiveDoubleClickMode?(this._previousDelayedSimpleClickTimeout&&clearTimeout(this._previousDelayedSimpleClickTimeout),this._previousDelayedSimpleClickTimeout=this._delayedSimpleClickTimeout,d(u,this._previousPickResult)):d(u,this._currentPickResult)),g=!0):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=p))}}g||d(u,this._currentPickResult)},this._onPointerMove=h=>{if(h.pointerId===void 0&&(h.pointerId=0),this._updatePointerPosition(h),!this._isSwiping&&this._swipeButtonPressed!==-1&&(this._isSwiping=Math.abs(this._startingPointerPosition.x-this._pointerX)>n.DragMovementThreshold||Math.abs(this._startingPointerPosition.y-this._pointerY)>n.DragMovementThreshold),this._checkPrePointerObservable(null,h,h.inputIndex>=X.MouseWheelX&&h.inputIndex<=X.MouseWheelZ?ce.POINTERWHEEL:ce.POINTERMOVE)||!a.cameraToUseForPointers&&!a.activeCamera)return;if(a.skipPointerMovePicking){this._processPointerMove(new lt,h);return}a.pointerMovePredicate||(a.pointerMovePredicate=c=>c.isPickable&&c.isVisible&&c.isReady()&&c.isEnabled()&&(c.enablePointerMoveEvents||a.constantlyUpdateMeshUnderPointer||c._getActionManagerForTrigger()!==null)&&(!a.cameraToUseForPointers||(a.cameraToUseForPointers.layerMask&c.layerMask)!==0));let l=a._registeredActions>0?this._pickMove(h.pointerId):null;this._processPointerMove(l,h)},this._onPointerDown=h=>{if(this._totalPointersPressed++,this._pickedDownMesh=null,this._meshPickProceed=!1,h.pointerId===void 0&&(h.pointerId=0),this._updatePointerPosition(h),this._swipeButtonPressed===-1&&(this._swipeButtonPressed=h.button),a.preventDefaultOnPointerDown&&r&&(h.preventDefault(),r.focus()),this._startingPointerPosition.x=this._pointerX,this._startingPointerPosition.y=this._pointerY,this._startingPointerTime=Date.now(),this._checkPrePointerObservable(null,h,ce.POINTERDOWN)||!a.cameraToUseForPointers&&!a.activeCamera)return;this._pointerCaptures[h.pointerId]=!0,a.pointerDownPredicate||(a.pointerDownPredicate=c=>c.isPickable&&c.isVisible&&c.isReady()&&c.isEnabled()&&(!a.cameraToUseForPointers||(a.cameraToUseForPointers.layerMask&c.layerMask)!==0)),this._pickedDownMesh=null;let l;a.skipPointerDownPicking||a._registeredActions===0&&!this._checkForPicking()&&!a.onPointerDown?l=new lt:l=a.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,a.pointerDownPredicate,!1,a.cameraToUseForPointers),this._processPointerDown(l,h)},this._onPointerUp=h=>{this._totalPointersPressed!==0&&(this._totalPointersPressed--,this._pickedUpMesh=null,this._meshPickProceed=!1,h.pointerId===void 0&&(h.pointerId=0),this._updatePointerPosition(h),a.preventDefaultOnPointerUp&&r&&(h.preventDefault(),r.focus()),this._initClickEvent(a.onPrePointerObservable,a.onPointerObservable,h,(l,c)=>{if(a.onPrePointerObservable.hasObservers()&&(this._skipPointerTap=!1,!l.ignore)){if(this._checkPrePointerObservable(null,h,ce.POINTERUP)){this._swipeButtonPressed===h.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1);return}l.hasSwiped||(l.singleClick&&a.onPrePointerObservable.hasSpecificMask(ce.POINTERTAP)&&this._checkPrePointerObservable(null,h,ce.POINTERTAP)&&(this._skipPointerTap=!0),l.doubleClick&&a.onPrePointerObservable.hasSpecificMask(ce.POINTERDOUBLETAP)&&this._checkPrePointerObservable(null,h,ce.POINTERDOUBLETAP)&&(this._skipPointerTap=!0))}this._pointerCaptures[h.pointerId]=!1,!(!a.cameraToUseForPointers&&!a.activeCamera)&&(a.pointerUpPredicate||(a.pointerUpPredicate=d=>d.isPickable&&d.isVisible&&d.isReady()&&d.isEnabled()&&(!a.cameraToUseForPointers||(a.cameraToUseForPointers.layerMask&d.layerMask)!==0)),!this._meshPickProceed&&(Si&&Si.HasTriggers||this._checkForPicking()||a.onPointerUp)&&this._initActionManager(null,l),c||(c=this._currentPickResult),this._processPointerUp(c,h,l),this._previousPickResult=this._currentPickResult,this._swipeButtonPressed===h.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1))}))},this._onKeyDown=h=>{let l=rn.KEYDOWN;if(a.onPreKeyboardObservable.hasObservers()){let c=new cs(l,h);if(a.onPreKeyboardObservable.notifyObservers(c,l),c.skipOnKeyboardObservable)return}if(a.onKeyboardObservable.hasObservers()){let c=new Li(l,h);a.onKeyboardObservable.notifyObservers(c,l)}a.actionManager&&a.actionManager.processTrigger(14,Be.CreateNewFromScene(a,h))},this._onKeyUp=h=>{let l=rn.KEYUP;if(a.onPreKeyboardObservable.hasObservers()){let c=new cs(l,h);if(a.onPreKeyboardObservable.notifyObservers(c,l),c.skipOnKeyboardObservable)return}if(a.onKeyboardObservable.hasObservers()){let c=new Li(l,h);a.onKeyboardObservable.notifyObservers(c,l)}a.actionManager&&a.actionManager.processTrigger(15,Be.CreateNewFromScene(a,h))},this._deviceSourceManager.onDeviceConnectedObservable.add(h=>{h.deviceType===U.Mouse?h.onInputChangedObservable.add(l=>{l.inputIndex===X.LeftClick||l.inputIndex===X.MiddleClick||l.inputIndex===X.RightClick||l.inputIndex===X.BrowserBack||l.inputIndex===X.BrowserForward?i&&h.getInput(l.inputIndex)===1?this._onPointerDown(l):e&&h.getInput(l.inputIndex)===0&&this._onPointerUp(l):s&&(l.inputIndex===X.Move?this._onPointerMove(l):(l.inputIndex===X.MouseWheelX||l.inputIndex===X.MouseWheelY||l.inputIndex===X.MouseWheelZ)&&this._onPointerMove(l))}):h.deviceType===U.Touch?h.onInputChangedObservable.add(l=>{l.inputIndex===X.LeftClick&&(i&&h.getInput(l.inputIndex)===1?this._onPointerDown(l):e&&h.getInput(l.inputIndex)===0&&this._onPointerUp(l)),s&&l.inputIndex===X.Move&&this._onPointerMove(l)}):h.deviceType===U.Keyboard&&h.onInputChangedObservable.add(l=>{l.type==="keydown"?this._onKeyDown(l):l.type==="keyup"&&this._onKeyUp(l)})}),this._alreadyAttached=!0}detachControl(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=!1,this._alreadyAttachedTo=null)}setPointerOverMesh(e,i=0,s){if(this._meshUnderPointerId[i]===e&&(!e||!e._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting))return;let r=this._meshUnderPointerId[i],a;r&&(a=r._getActionManagerForTrigger(10),a&&a.processTrigger(10,Be.CreateNew(r,void 0,{pointerId:i}))),e?(this._meshUnderPointerId[i]=e,this._pointerOverMesh=e,a=e._getActionManagerForTrigger(9),a&&a.processTrigger(9,Be.CreateNew(e,void 0,{pointerId:i,pickResult:s}))):(delete this._meshUnderPointerId[i],this._pointerOverMesh=null)}getPointerOverMesh(){return this.meshUnderPointer}_invalidateMesh(e){this._pointerOverMesh===e&&(this._pointerOverMesh=null),this._pickedDownMesh===e&&(this._pickedDownMesh=null),this._pickedUpMesh===e&&(this._pickedUpMesh=null);for(let i in this._meshUnderPointerId)this._meshUnderPointerId[i]===e&&delete this._meshUnderPointerId[i]}}return n.DragMovementThreshold=10,n.LongPressDelay=500,n.DoubleClickDelay=300,n.ExclusiveDoubleClickMode=!1,n})(),_i=class n{constructor(t,e,i,s){this.normal=new v(t,e,i),this.d=s}asArray(){return[this.normal.x,this.normal.y,this.normal.z,this.d]}clone(){return new n(this.normal.x,this.normal.y,this.normal.z,this.d)}getClassName(){return"Plane"}getHashCode(){let t=this.normal.getHashCode();return t=t*397^(this.d|0),t}normalize(){let t=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z),e=0;return t!==0&&(e=1/t),this.normal.x*=e,this.normal.y*=e,this.normal.z*=e,this.d*=e,this}transform(t){let e=n._TmpMatrix;t.invertToRef(e);let i=e.m,s=this.normal.x,r=this.normal.y,a=this.normal.z,o=this.d,h=s*i[0]+r*i[1]+a*i[2]+o*i[3],l=s*i[4]+r*i[5]+a*i[6]+o*i[7],c=s*i[8]+r*i[9]+a*i[10]+o*i[11],d=s*i[12]+r*i[13]+a*i[14]+o*i[15];return new n(h,l,c,d)}dotCoordinate(t){return this.normal.x*t.x+this.normal.y*t.y+this.normal.z*t.z+this.d}copyFromPoints(t,e,i){let s=e.x-t.x,r=e.y-t.y,a=e.z-t.z,o=i.x-t.x,h=i.y-t.y,l=i.z-t.z,c=r*l-a*h,d=a*o-s*l,u=s*h-r*o,f=Math.sqrt(c*c+d*d+u*u),_;return f!==0?_=1/f:_=0,this.normal.x=c*_,this.normal.y=d*_,this.normal.z=u*_,this.d=-(this.normal.x*t.x+this.normal.y*t.y+this.normal.z*t.z),this}isFrontFacingTo(t,e){return v.Dot(this.normal,t)<=e}signedDistanceTo(t){return v.Dot(t,this.normal)+this.d}static FromArray(t){return new n(t[0],t[1],t[2],t[3])}static FromPoints(t,e,i){let s=new n(0,0,0,0);return s.copyFromPoints(t,e,i),s}static FromPositionAndNormal(t,e){let i=new n(0,0,0,0);return e.normalize(),i.normal=e,i.d=-(e.x*t.x+e.y*t.y+e.z*t.z),i}static SignedDistanceToPlaneFromPositionAndNormal(t,e,i){let s=-(e.x*t.x+e.y*t.y+e.z*t.z);return v.Dot(i,e)+s}};_i._TmpMatrix=P.Identity();var pi=class n{static GetPlanes(t){let e=[];for(let i=0;i<6;i++)e.push(new _i(0,0,0,0));return n.GetPlanesToRef(t,e),e}static GetNearPlaneToRef(t,e){let i=t.m;e.normal.x=i[3]+i[2],e.normal.y=i[7]+i[6],e.normal.z=i[11]+i[10],e.d=i[15]+i[14],e.normalize()}static GetFarPlaneToRef(t,e){let i=t.m;e.normal.x=i[3]-i[2],e.normal.y=i[7]-i[6],e.normal.z=i[11]-i[10],e.d=i[15]-i[14],e.normalize()}static GetLeftPlaneToRef(t,e){let i=t.m;e.normal.x=i[3]+i[0],e.normal.y=i[7]+i[4],e.normal.z=i[11]+i[8],e.d=i[15]+i[12],e.normalize()}static GetRightPlaneToRef(t,e){let i=t.m;e.normal.x=i[3]-i[0],e.normal.y=i[7]-i[4],e.normal.z=i[11]-i[8],e.d=i[15]-i[12],e.normalize()}static GetTopPlaneToRef(t,e){let i=t.m;e.normal.x=i[3]-i[1],e.normal.y=i[7]-i[5],e.normal.z=i[11]-i[9],e.d=i[15]-i[13],e.normalize()}static GetBottomPlaneToRef(t,e){let i=t.m;e.normal.x=i[3]+i[1],e.normal.y=i[7]+i[5],e.normal.z=i[11]+i[9],e.d=i[15]+i[13],e.normalize()}static GetPlanesToRef(t,e){n.GetNearPlaneToRef(t,e[0]),n.GetFarPlaneToRef(t,e[1]),n.GetLeftPlaneToRef(t,e[2]),n.GetRightPlaneToRef(t,e[3]),n.GetTopPlaneToRef(t,e[4]),n.GetBottomPlaneToRef(t,e[5])}},ca=(()=>{class n{static get UniqueId(){let e=this._UniqueIdCounter;return this._UniqueIdCounter++,e}}return n._UniqueIdCounter=1,n})(),Me=(()=>{class n{static CompareLightsPriority(e,i){return e.shadowEnabled!==i.shadowEnabled?(i.shadowEnabled?1:0)-(e.shadowEnabled?1:0):i.renderPriority-e.renderPriority}}return n.FALLOFF_DEFAULT=0,n.FALLOFF_PHYSICAL=1,n.FALLOFF_GLTF=2,n.FALLOFF_STANDARD=3,n.LIGHTMAP_DEFAULT=0,n.LIGHTMAP_SPECULAR=1,n.LIGHTMAP_SHADOWSONLY=2,n.INTENSITYMODE_AUTOMATIC=0,n.INTENSITYMODE_LUMINOUSPOWER=1,n.INTENSITYMODE_LUMINOUSINTENSITY=2,n.INTENSITYMODE_ILLUMINANCE=3,n.INTENSITYMODE_LUMINANCE=4,n.LIGHTTYPEID_POINTLIGHT=0,n.LIGHTTYPEID_DIRECTIONALLIGHT=1,n.LIGHTTYPEID_SPOTLIGHT=2,n.LIGHTTYPEID_HEMISPHERICLIGHT=3,n})(),mt;(function(n){n[n.BackwardCompatible=0]="BackwardCompatible",n[n.Intermediate=1]="Intermediate",n[n.Aggressive=2]="Aggressive"})(mt||(mt={}));var te=(()=>{class n extends In{constructor(e,i){super(),this._inputManager=new Mt(this),this.cameraToUseForPointers=null,this._isScene=!0,this._blockEntityCollection=!1,this.autoClear=!0,this.autoClearDepthAndStencil=!0,this.clearColor=new ie(.2,.2,.3,1),this.ambientColor=new me(0,0,0),this.environmentIntensity=1,this._performancePriority=mt.BackwardCompatible,this._forceWireframe=!1,this._skipFrustumClipping=!1,this._forcePointsCloud=!1,this.animationsEnabled=!0,this._animationPropertiesOverride=null,this.useConstantAnimationDeltaTime=!1,this.constantlyUpdateMeshUnderPointer=!1,this.hoverCursor="pointer",this.defaultCursor="",this.doNotHandleCursors=!1,this.preventDefaultOnPointerDown=!0,this.preventDefaultOnPointerUp=!0,this.metadata=null,this.reservedDataStore=null,this.disableOfflineSupportExceptionRules=new Array,this.onDisposeObservable=new D,this._onDisposeObserver=null,this.onBeforeRenderObservable=new D,this._onBeforeRenderObserver=null,this.onAfterRenderObservable=new D,this.onAfterRenderCameraObservable=new D,this._onAfterRenderObserver=null,this.onBeforeAnimationsObservable=new D,this.onAfterAnimationsObservable=new D,this.onBeforeDrawPhaseObservable=new D,this.onAfterDrawPhaseObservable=new D,this.onReadyObservable=new D,this.onBeforeCameraRenderObservable=new D,this._onBeforeCameraRenderObserver=null,this.onAfterCameraRenderObservable=new D,this._onAfterCameraRenderObserver=null,this.onBeforeActiveMeshesEvaluationObservable=new D,this.onAfterActiveMeshesEvaluationObservable=new D,this.onBeforeParticlesRenderingObservable=new D,this.onAfterParticlesRenderingObservable=new D,this.onDataLoadedObservable=new D,this.onNewCameraAddedObservable=new D,this.onCameraRemovedObservable=new D,this.onNewLightAddedObservable=new D,this.onLightRemovedObservable=new D,this.onNewGeometryAddedObservable=new D,this.onGeometryRemovedObservable=new D,this.onNewTransformNodeAddedObservable=new D,this.onTransformNodeRemovedObservable=new D,this.onNewMeshAddedObservable=new D,this.onMeshRemovedObservable=new D,this.onNewSkeletonAddedObservable=new D,this.onSkeletonRemovedObservable=new D,this.onNewMaterialAddedObservable=new D,this.onNewMultiMaterialAddedObservable=new D,this.onMaterialRemovedObservable=new D,this.onMultiMaterialRemovedObservable=new D,this.onNewTextureAddedObservable=new D,this.onTextureRemovedObservable=new D,this.onBeforeRenderTargetsRenderObservable=new D,this.onAfterRenderTargetsRenderObservable=new D,this.onBeforeStepObservable=new D,this.onAfterStepObservable=new D,this.onActiveCameraChanged=new D,this.onActiveCamerasChanged=new D,this.onBeforeRenderingGroupObservable=new D,this.onAfterRenderingGroupObservable=new D,this.onMeshImportedObservable=new D,this.onAnimationFileImportedObservable=new D,this._registeredForLateAnimationBindings=new Ct(256),this.skipPointerMovePicking=!1,this.skipPointerDownPicking=!1,this.skipPointerUpPicking=!1,this.onPrePointerObservable=new D,this.onPointerObservable=new D,this.onPreKeyboardObservable=new D,this.onKeyboardObservable=new D,this._useRightHandedSystem=!1,this._timeAccumulator=0,this._currentStepId=0,this._currentInternalStep=0,this._fogEnabled=!0,this._fogMode=n.FOGMODE_NONE,this.fogColor=new me(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.needsPreviousWorldMatrices=!1,this._shadowsEnabled=!0,this._lightsEnabled=!0,this._unObserveActiveCameras=null,this._texturesEnabled=!0,this.physicsEnabled=!0,this.particlesEnabled=!0,this.spritesEnabled=!0,this._skeletonsEnabled=!0,this.lensFlaresEnabled=!0,this.collisionsEnabled=!0,this.gravity=new v(0,-9.807,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=new Array,this.importedMeshesFiles=new Array,this.probesEnabled=!0,this._meshesForIntersections=new Ct(256),this.proceduralTexturesEnabled=!0,this._totalVertices=new bi,this._activeIndices=new bi,this._activeParticles=new bi,this._activeBones=new bi,this._animationTime=0,this.animationTimeScale=1,this._renderId=0,this._frameId=0,this._executeWhenReadyTimeoutId=null,this._intermediateRendering=!1,this._defaultFrameBufferCleared=!1,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1,this._toBeDisposed=new Array(256),this._activeRequests=new Array,this._pendingData=new Array,this._isDisposed=!1,this.dispatchAllSubMeshesOfActiveMeshes=!1,this._activeMeshes=new Ze(256),this._processedMaterials=new Ze(256),this._renderTargets=new Ct(256),this._materialsRenderTargets=new Ct(256),this._activeParticleSystems=new Ze(256),this._activeSkeletons=new Ct(32),this._softwareSkinnedMeshes=new Ct(32),this._activeAnimatables=new Array,this._transformMatrix=P.Zero(),this.requireLightSorting=!1,this._components=[],this._serializableComponents=[],this._transientComponents=[],this._beforeCameraUpdateStage=ge.Create(),this._beforeClearStage=ge.Create(),this._beforeRenderTargetClearStage=ge.Create(),this._gatherRenderTargetsStage=ge.Create(),this._gatherActiveCameraRenderTargetsStage=ge.Create(),this._isReadyForMeshStage=ge.Create(),this._beforeEvaluateActiveMeshStage=ge.Create(),this._evaluateSubMeshStage=ge.Create(),this._preActiveMeshStage=ge.Create(),this._cameraDrawRenderTargetStage=ge.Create(),this._beforeCameraDrawStage=ge.Create(),this._beforeRenderTargetDrawStage=ge.Create(),this._beforeRenderingGroupDrawStage=ge.Create(),this._beforeRenderingMeshStage=ge.Create(),this._afterRenderingMeshStage=ge.Create(),this._afterRenderingGroupDrawStage=ge.Create(),this._afterCameraDrawStage=ge.Create(),this._afterCameraPostProcessStage=ge.Create(),this._afterRenderTargetDrawStage=ge.Create(),this._afterRenderTargetPostProcessStage=ge.Create(),this._afterRenderStage=ge.Create(),this._pointerMoveStage=ge.Create(),this._pointerDownStage=ge.Create(),this._pointerUpStage=ge.Create(),this._geometriesByUniqueId=null,this._defaultMeshCandidates={data:[],length:0},this._defaultSubMeshCandidates={data:[],length:0},this._preventFreeActiveMeshesAndRenderingGroups=!1,this._activeMeshesFrozen=!1,this._activeMeshesFrozenButKeepClipping=!1,this._skipEvaluateActiveMeshesCompletely=!1,this._allowPostProcessClearColor=!0,this.getDeterministicFrameTime=()=>this._engine.getTimeStep(),this._registeredActions=0,this._blockMaterialDirtyMechanism=!1,this._perfCollector=null,this.activeCameras=new Array;let s=Xe({useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1},i);this._engine=e||Q.LastCreatedEngine,s.virtual?this._engine._virtualScenes.push(this):(Q._LastCreatedScene=this,this._engine.scenes.push(this)),this._uid=null,this._renderingManager=new hs(this),ui&&(this.postProcessManager=new ui(this)),Oe()&&this.attachControl(),this._createUbo(),ue&&(this._imageProcessingConfiguration=new ue),this.setDefaultCandidateProviders(),s.useGeometryUniqueIdsMap&&(this._geometriesByUniqueId={}),this.useMaterialMeshMap=s.useMaterialMeshMap,this.useClonedMeshMap=s.useClonedMeshMap,(!i||!i.virtual)&&this._engine.onNewSceneAddedObservable.notifyObservers(this)}static DefaultMaterialFactory(e){throw H("StandardMaterial")}static CollisionCoordinatorFactory(){throw H("DefaultCollisionCoordinator")}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture!==e&&(this._environmentTexture=e,this.markAllMaterialsAsDirty(1))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}get performancePriority(){return this._performancePriority}set performancePriority(e){if(e!==this._performancePriority)switch(this._performancePriority=e,e){case mt.BackwardCompatible:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!1,this.autoClear=!0;break;case mt.Intermediate:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!0,this.autoClear=!1;break;case mt.Aggressive:this.skipFrustumClipping=!0,this._renderingManager.maintainStateBetweenFrames=!0,this.skipPointerMovePicking=!0,this.autoClear=!1;break}}set forceWireframe(e){this._forceWireframe!==e&&(this._forceWireframe=e,this.markAllMaterialsAsDirty(16))}get forceWireframe(){return this._forceWireframe}set skipFrustumClipping(e){this._skipFrustumClipping!==e&&(this._skipFrustumClipping=e)}get skipFrustumClipping(){return this._skipFrustumClipping}set forcePointsCloud(e){this._forcePointsCloud!==e&&(this._forcePointsCloud=e,this.markAllMaterialsAsDirty(16))}get forcePointsCloud(){return this._forcePointsCloud}get animationPropertiesOverride(){return this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set beforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),e&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e))}set afterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),e&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(e))}set beforeCameraRender(e){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(e)}set afterCameraRender(e){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(e)}get unTranslatedPointer(){return this._inputManager.unTranslatedPointer}static get DragMovementThreshold(){return Mt.DragMovementThreshold}static set DragMovementThreshold(e){Mt.DragMovementThreshold=e}static get LongPressDelay(){return Mt.LongPressDelay}static set LongPressDelay(e){Mt.LongPressDelay=e}static get DoubleClickDelay(){return Mt.DoubleClickDelay}static set DoubleClickDelay(e){Mt.DoubleClickDelay=e}static get ExclusiveDoubleClickMode(){return Mt.ExclusiveDoubleClickMode}static set ExclusiveDoubleClickMode(e){Mt.ExclusiveDoubleClickMode=e}bindEyePosition(e,i="vEyePosition",s=!1){var r;let a=this._forcedViewPosition?this._forcedViewPosition:this._mirroredCameraPosition?this._mirroredCameraPosition:(r=this.activeCamera.globalPosition)!==null&&r!==void 0?r:this.activeCamera.devicePosition,o=this.useRightHandedSystem===(this._mirroredCameraPosition!=null);return C.Vector4[0].set(a.x,a.y,a.z,o?-1:1),e&&(s?e.setFloat3(i,C.Vector4[0].x,C.Vector4[0].y,C.Vector4[0].z):e.setVector4(i,C.Vector4[0])),C.Vector4[0]}finalizeSceneUbo(){let e=this.getSceneUniformBuffer(),i=this.bindEyePosition(null);return e.updateFloat4("vEyePosition",i.x,i.y,i.z,i.w),e.update(),e}set useRightHandedSystem(e){this._useRightHandedSystem!==e&&(this._useRightHandedSystem=e,this.markAllMaterialsAsDirty(16))}get useRightHandedSystem(){return this._useRightHandedSystem}setStepId(e){this._currentStepId=e}getStepId(){return this._currentStepId}getInternalStep(){return this._currentInternalStep}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAllMaterialsAsDirty(16))}get fogEnabled(){return this._fogEnabled}set fogMode(e){this._fogMode!==e&&(this._fogMode=e,this.markAllMaterialsAsDirty(16))}get fogMode(){return this._fogMode}get prePass(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this.markAllMaterialsAsDirty(2))}get shadowsEnabled(){return this._shadowsEnabled}set lightsEnabled(e){this._lightsEnabled!==e&&(this._lightsEnabled=e,this.markAllMaterialsAsDirty(2))}get lightsEnabled(){return this._lightsEnabled}get activeCameras(){return this._activeCameras}set activeCameras(e){this._unObserveActiveCameras&&(this._unObserveActiveCameras(),this._unObserveActiveCameras=null),e&&(this._unObserveActiveCameras=vn(e,()=>{this.onActiveCamerasChanged.notifyObservers(this)})),this._activeCameras=e}get activeCamera(){return this._activeCamera}set activeCamera(e){e!==this._activeCamera&&(this._activeCamera=e,this.onActiveCameraChanged.notifyObservers(this))}get defaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=n.DefaultMaterialFactory(this)),this._defaultMaterial}set defaultMaterial(e){this._defaultMaterial=e}set texturesEnabled(e){this._texturesEnabled!==e&&(this._texturesEnabled=e,this.markAllMaterialsAsDirty(1))}get texturesEnabled(){return this._texturesEnabled}set skeletonsEnabled(e){this._skeletonsEnabled!==e&&(this._skeletonsEnabled=e,this.markAllMaterialsAsDirty(8))}get skeletonsEnabled(){return this._skeletonsEnabled}get collisionCoordinator(){return this._collisionCoordinator||(this._collisionCoordinator=n.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator}get renderingManager(){return this._renderingManager}get frustumPlanes(){return this._frustumPlanes}_registerTransientComponents(){if(this._transientComponents.length>0){for(let e of this._transientComponents)e.register();this._transientComponents.length=0}}_addComponent(e){this._components.push(e),this._transientComponents.push(e);let i=e;i.addFromContainer&&i.serialize&&this._serializableComponents.push(i)}_getComponent(e){for(let i of this._components)if(i.name===e)return i;return null}getClassName(){return"Scene"}_getDefaultMeshCandidates(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates}_getDefaultSubMeshCandidates(e){return this._defaultSubMeshCandidates.data=e.subMeshes,this._defaultSubMeshCandidates.length=e.subMeshes.length,this._defaultSubMeshCandidates}setDefaultCandidateProviders(){this.getActiveMeshCandidates=this._getDefaultMeshCandidates.bind(this),this.getActiveSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getIntersectingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getCollidingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this)}get meshUnderPointer(){return this._inputManager.meshUnderPointer}get pointerX(){return this._inputManager.pointerX}set pointerX(e){this._inputManager.pointerX=e}get pointerY(){return this._inputManager.pointerY}set pointerY(e){this._inputManager.pointerY=e}getCachedMaterial(){return this._cachedMaterial}getCachedEffect(){return this._cachedEffect}getCachedVisibility(){return this._cachedVisibility}isCachedMaterialInvalid(e,i,s=1){return this._cachedEffect!==i||this._cachedMaterial!==e||this._cachedVisibility!==s}getEngine(){return this._engine}getTotalVertices(){return this._totalVertices.current}get totalVerticesPerfCounter(){return this._totalVertices}getActiveIndices(){return this._activeIndices.current}get totalActiveIndicesPerfCounter(){return this._activeIndices}getActiveParticles(){return this._activeParticles.current}get activeParticlesPerfCounter(){return this._activeParticles}getActiveBones(){return this._activeBones.current}get activeBonesPerfCounter(){return this._activeBones}getActiveMeshes(){return this._activeMeshes}getAnimationRatio(){return this._animationRatio!==void 0?this._animationRatio:1}getRenderId(){return this._renderId}getFrameId(){return this._frameId}incrementRenderId(){this._renderId++}_createUbo(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())}simulatePointerMove(e,i){return this._inputManager.simulatePointerMove(e,i),this}simulatePointerDown(e,i){return this._inputManager.simulatePointerDown(e,i),this}simulatePointerUp(e,i,s){return this._inputManager.simulatePointerUp(e,i,s),this}isPointerCaptured(e=0){return this._inputManager.isPointerCaptured(e)}attachControl(e=!0,i=!0,s=!0){this._inputManager.attachControl(e,i,s)}detachControl(){this._inputManager.detachControl()}isReady(e=!0){if(this._isDisposed)return!1;let i,s=this.getEngine(),r=!0;for(this._pendingData.length>0&&(r=!1),e&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),i=0;i<this.meshes.length;i++){let a=this.meshes[i];if(!a.subMeshes||a.subMeshes.length===0)continue;if(!a.isReady(!0)){r=!1;continue}let o=a.hasThinInstances||a.getClassName()==="InstancedMesh"||a.getClassName()==="InstancedLinesMesh"||s.getCaps().instancedArrays&&a.instances.length>0;for(let l of this._isReadyForMeshStage)l.action(a,o)||(r=!1);if(!e)continue;let h=a.material||this.defaultMaterial;if(h)if(h._storeEffectOnSubMeshes)for(let l of a.subMeshes){let c=l.getMaterial();c&&c.hasRenderTargetTextures&&c.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(c)===-1&&(this._processedMaterials.push(c),this._materialsRenderTargets.concatWithNoDuplicate(c.getRenderTargetTextures()))}else h.hasRenderTargetTextures&&h.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(h)===-1&&(this._processedMaterials.push(h),this._materialsRenderTargets.concatWithNoDuplicate(h.getRenderTargetTextures()))}if(!r||!s.areAllEffectsReady())return!1;if(e){for(i=0;i<this._materialsRenderTargets.length;++i)if(!this._materialsRenderTargets.data[i].isReadyForRendering())return!1}for(i=0;i<this.geometries.length;i++)if(this.geometries[i].delayLoadState===2)return!1;if(this.activeCameras&&this.activeCameras.length>0){for(let a of this.activeCameras)if(!a.isReady(!0))return!1}else if(this.activeCamera&&!this.activeCamera.isReady(!0))return!1;for(let a of this.particleSystems)if(!a.isReady())return!1;return!0}resetCachedMaterial(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null}registerBeforeRender(e){this.onBeforeRenderObservable.add(e)}unregisterBeforeRender(e){this.onBeforeRenderObservable.removeCallback(e)}registerAfterRender(e){this.onAfterRenderObservable.add(e)}unregisterAfterRender(e){this.onAfterRenderObservable.removeCallback(e)}_executeOnceBeforeRender(e){let i=()=>{e(),setTimeout(()=>{this.unregisterBeforeRender(i)})};this.registerBeforeRender(i)}executeOnceBeforeRender(e,i){i!==void 0?setTimeout(()=>{this._executeOnceBeforeRender(e)},i):this._executeOnceBeforeRender(e)}addPendingData(e){this._pendingData.push(e)}removePendingData(e){let i=this.isLoading,s=this._pendingData.indexOf(e);s!==-1&&this._pendingData.splice(s,1),i&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)}getWaitingItemsCount(){return this._pendingData.length}get isLoading(){return this._pendingData.length>0}executeWhenReady(e,i=!1){this.onReadyObservable.addOnce(e),this._executeWhenReadyTimeoutId===null&&this._checkIsReady(i)}whenReadyAsync(e=!1){return new Promise(i=>{this.executeWhenReady(()=>{i()},e)})}_checkIsReady(e=!1){if(this._registerTransientComponents(),this.isReady(e)){this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}if(this._isDisposed){this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}this._executeWhenReadyTimeoutId=setTimeout(()=>{this.incrementRenderId(),this._checkIsReady(e)},100)}get animatables(){return this._activeAnimatables}resetLastAnimationTimeFrame(){this._animationTimeLast=Pt.Now}getViewMatrix(){return this._viewMatrix}getProjectionMatrix(){return this._projectionMatrix}getTransformMatrix(){return this._transformMatrix}setTransformMatrix(e,i,s,r){!s&&!r&&this._multiviewSceneUbo&&(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),!(this._viewUpdateFlag===e.updateFlag&&this._projectionUpdateFlag===i.updateFlag)&&(this._viewUpdateFlag=e.updateFlag,this._projectionUpdateFlag=i.updateFlag,this._viewMatrix=e,this._projectionMatrix=i,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?pi.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=pi.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(s,r):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)))}getSceneUniformBuffer(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo}createSceneUniformBuffer(e){let i=new Qe(this._engine,void 0,!1,e??"scene");return i.addUniform("viewProjection",16),i.addUniform("view",16),i.addUniform("projection",16),i.addUniform("vEyePosition",4),i}setSceneUniformBuffer(e){this._sceneUbo=e,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1}getUniqueId(){return ca.UniqueId}addMesh(e,i=!1){this._blockEntityCollection||(this.meshes.push(e),e._resyncLightSources(),e.parent||e._addToSceneRootNodes(),this.onNewMeshAddedObservable.notifyObservers(e),i&&e.getChildMeshes().forEach(s=>{this.addMesh(s)}))}removeMesh(e,i=!1){let s=this.meshes.indexOf(e);return s!==-1&&(this.meshes[s]=this.meshes[this.meshes.length-1],this.meshes.pop(),e.parent||e._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(e),this.onMeshRemovedObservable.notifyObservers(e),i&&e.getChildMeshes().forEach(r=>{this.removeMesh(r)}),s}addTransformNode(e){this._blockEntityCollection||e.getScene()===this&&e._indexInSceneTransformNodesArray!==-1||(e._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(e),e.parent||e._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(e))}removeTransformNode(e){let i=e._indexInSceneTransformNodesArray;if(i!==-1){if(i!==this.transformNodes.length-1){let s=this.transformNodes[this.transformNodes.length-1];this.transformNodes[i]=s,s._indexInSceneTransformNodesArray=i}e._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),e.parent||e._removeFromSceneRootNodes()}return this.onTransformNodeRemovedObservable.notifyObservers(e),i}removeSkeleton(e){let i=this.skeletons.indexOf(e);return i!==-1&&(this.skeletons.splice(i,1),this.onSkeletonRemovedObservable.notifyObservers(e),this._executeActiveContainerCleanup(this._activeSkeletons)),i}removeMorphTargetManager(e){let i=this.morphTargetManagers.indexOf(e);return i!==-1&&this.morphTargetManagers.splice(i,1),i}removeLight(e){let i=this.lights.indexOf(e);if(i!==-1){for(let s of this.meshes)s._removeLightSource(e,!1);this.lights.splice(i,1),this.sortLightsByPriority(),e.parent||e._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(e),i}removeCamera(e){let i=this.cameras.indexOf(e);if(i!==-1&&(this.cameras.splice(i,1),e.parent||e._removeFromSceneRootNodes()),this.activeCameras){let s=this.activeCameras.indexOf(e);s!==-1&&this.activeCameras.splice(s,1)}return this.activeCamera===e&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(e),i}removeParticleSystem(e){let i=this.particleSystems.indexOf(e);return i!==-1&&(this.particleSystems.splice(i,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),i}removeAnimation(e){let i=this.animations.indexOf(e);return i!==-1&&this.animations.splice(i,1),i}stopAnimation(e,i,s){}removeAnimationGroup(e){let i=this.animationGroups.indexOf(e);return i!==-1&&this.animationGroups.splice(i,1),i}removeMultiMaterial(e){let i=this.multiMaterials.indexOf(e);return i!==-1&&this.multiMaterials.splice(i,1),this.onMultiMaterialRemovedObservable.notifyObservers(e),i}removeMaterial(e){let i=e._indexInSceneMaterialArray;if(i!==-1&&i<this.materials.length){if(i!==this.materials.length-1){let s=this.materials[this.materials.length-1];this.materials[i]=s,s._indexInSceneMaterialArray=i}e._indexInSceneMaterialArray=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(e),i}removeActionManager(e){let i=this.actionManagers.indexOf(e);return i!==-1&&this.actionManagers.splice(i,1),i}removeTexture(e){let i=this.textures.indexOf(e);return i!==-1&&this.textures.splice(i,1),this.onTextureRemovedObservable.notifyObservers(e),i}addLight(e){if(!this._blockEntityCollection){this.lights.push(e),this.sortLightsByPriority(),e.parent||e._addToSceneRootNodes();for(let i of this.meshes)i.lightSources.indexOf(e)===-1&&(i.lightSources.push(e),i._resyncLightSources());this.onNewLightAddedObservable.notifyObservers(e)}}sortLightsByPriority(){this.requireLightSorting&&this.lights.sort(Me.CompareLightsPriority)}addCamera(e){this._blockEntityCollection||(this.cameras.push(e),this.onNewCameraAddedObservable.notifyObservers(e),e.parent||e._addToSceneRootNodes())}addSkeleton(e){this._blockEntityCollection||(this.skeletons.push(e),this.onNewSkeletonAddedObservable.notifyObservers(e))}addParticleSystem(e){this._blockEntityCollection||this.particleSystems.push(e)}addAnimation(e){this._blockEntityCollection||this.animations.push(e)}addAnimationGroup(e){this._blockEntityCollection||this.animationGroups.push(e)}addMultiMaterial(e){this._blockEntityCollection||(this.multiMaterials.push(e),this.onNewMultiMaterialAddedObservable.notifyObservers(e))}addMaterial(e){this._blockEntityCollection||e.getScene()===this&&e._indexInSceneMaterialArray!==-1||(e._indexInSceneMaterialArray=this.materials.length,this.materials.push(e),this.onNewMaterialAddedObservable.notifyObservers(e))}addMorphTargetManager(e){this._blockEntityCollection||this.morphTargetManagers.push(e)}addGeometry(e){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=this.geometries.length),this.geometries.push(e))}addActionManager(e){this.actionManagers.push(e)}addTexture(e){this._blockEntityCollection||(this.textures.push(e),this.onNewTextureAddedObservable.notifyObservers(e))}switchActiveCamera(e,i=!0){this._engine.getInputElement()&&(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=e,i&&e.attachControl())}setActiveCameraById(e){let i=this.getCameraById(e);return i?(this.activeCamera=i,i):null}setActiveCameraByName(e){let i=this.getCameraByName(e);return i?(this.activeCamera=i,i):null}getAnimationGroupByName(e){for(let i=0;i<this.animationGroups.length;i++)if(this.animationGroups[i].name===e)return this.animationGroups[i];return null}_getMaterial(e,i){for(let s=0;s<this.materials.length;s++){let r=this.materials[s];if(i(r))return r}if(e)for(let s=0;s<this.multiMaterials.length;s++){let r=this.multiMaterials[s];if(i(r))return r}return null}getMaterialByUniqueID(e,i=!1){return this._getMaterial(i,s=>s.uniqueId===e)}getMaterialById(e,i=!1){return this._getMaterial(i,s=>s.id===e)}getMaterialByName(e,i=!1){return this._getMaterial(i,s=>s.name===e)}getLastMaterialById(e,i=!1){for(let s=this.materials.length-1;s>=0;s--)if(this.materials[s].id===e)return this.materials[s];if(i){for(let s=this.multiMaterials.length-1;s>=0;s--)if(this.multiMaterials[s].id===e)return this.multiMaterials[s]}return null}getTextureByUniqueId(e){for(let i=0;i<this.textures.length;i++)if(this.textures[i].uniqueId===e)return this.textures[i];return null}getTextureByName(e){for(let i=0;i<this.textures.length;i++)if(this.textures[i].name===e)return this.textures[i];return null}getCameraById(e){for(let i=0;i<this.cameras.length;i++)if(this.cameras[i].id===e)return this.cameras[i];return null}getCameraByUniqueId(e){for(let i=0;i<this.cameras.length;i++)if(this.cameras[i].uniqueId===e)return this.cameras[i];return null}getCameraByName(e){for(let i=0;i<this.cameras.length;i++)if(this.cameras[i].name===e)return this.cameras[i];return null}getBoneById(e){for(let i=0;i<this.skeletons.length;i++){let s=this.skeletons[i];for(let r=0;r<s.bones.length;r++)if(s.bones[r].id===e)return s.bones[r]}return null}getBoneByName(e){for(let i=0;i<this.skeletons.length;i++){let s=this.skeletons[i];for(let r=0;r<s.bones.length;r++)if(s.bones[r].name===e)return s.bones[r]}return null}getLightByName(e){for(let i=0;i<this.lights.length;i++)if(this.lights[i].name===e)return this.lights[i];return null}getLightById(e){for(let i=0;i<this.lights.length;i++)if(this.lights[i].id===e)return this.lights[i];return null}getLightByUniqueId(e){for(let i=0;i<this.lights.length;i++)if(this.lights[i].uniqueId===e)return this.lights[i];return null}getParticleSystemById(e){for(let i=0;i<this.particleSystems.length;i++)if(this.particleSystems[i].id===e)return this.particleSystems[i];return null}getGeometryById(e){for(let i=0;i<this.geometries.length;i++)if(this.geometries[i].id===e)return this.geometries[i];return null}_getGeometryByUniqueId(e){if(this._geometriesByUniqueId){let i=this._geometriesByUniqueId[e];if(i!==void 0)return this.geometries[i]}else for(let i=0;i<this.geometries.length;i++)if(this.geometries[i].uniqueId===e)return this.geometries[i];return null}pushGeometry(e,i){return!i&&this._getGeometryByUniqueId(e.uniqueId)?!1:(this.addGeometry(e),this.onNewGeometryAddedObservable.notifyObservers(e),!0)}removeGeometry(e){let i;if(this._geometriesByUniqueId){if(i=this._geometriesByUniqueId[e.uniqueId],i===void 0)return!1}else if(i=this.geometries.indexOf(e),i<0)return!1;if(i!==this.geometries.length-1){let s=this.geometries[this.geometries.length-1];s&&(this.geometries[i]=s,this._geometriesByUniqueId&&(this._geometriesByUniqueId[s.uniqueId]=i))}return this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(e),!0}getGeometries(){return this.geometries}getMeshById(e){for(let i=0;i<this.meshes.length;i++)if(this.meshes[i].id===e)return this.meshes[i];return null}getMeshesById(e){return this.meshes.filter(function(i){return i.id===e})}getTransformNodeById(e){for(let i=0;i<this.transformNodes.length;i++)if(this.transformNodes[i].id===e)return this.transformNodes[i];return null}getTransformNodeByUniqueId(e){for(let i=0;i<this.transformNodes.length;i++)if(this.transformNodes[i].uniqueId===e)return this.transformNodes[i];return null}getTransformNodesById(e){return this.transformNodes.filter(function(i){return i.id===e})}getMeshByUniqueId(e){for(let i=0;i<this.meshes.length;i++)if(this.meshes[i].uniqueId===e)return this.meshes[i];return null}getLastMeshById(e){for(let i=this.meshes.length-1;i>=0;i--)if(this.meshes[i].id===e)return this.meshes[i];return null}getLastEntryById(e){let i;for(i=this.meshes.length-1;i>=0;i--)if(this.meshes[i].id===e)return this.meshes[i];for(i=this.transformNodes.length-1;i>=0;i--)if(this.transformNodes[i].id===e)return this.transformNodes[i];for(i=this.cameras.length-1;i>=0;i--)if(this.cameras[i].id===e)return this.cameras[i];for(i=this.lights.length-1;i>=0;i--)if(this.lights[i].id===e)return this.lights[i];return null}getNodeById(e){let i=this.getMeshById(e);if(i)return i;let s=this.getTransformNodeById(e);if(s)return s;let r=this.getLightById(e);if(r)return r;let a=this.getCameraById(e);return a||this.getBoneById(e)||null}getNodeByName(e){let i=this.getMeshByName(e);if(i)return i;let s=this.getTransformNodeByName(e);if(s)return s;let r=this.getLightByName(e);if(r)return r;let a=this.getCameraByName(e);return a||this.getBoneByName(e)||null}getMeshByName(e){for(let i=0;i<this.meshes.length;i++)if(this.meshes[i].name===e)return this.meshes[i];return null}getTransformNodeByName(e){for(let i=0;i<this.transformNodes.length;i++)if(this.transformNodes[i].name===e)return this.transformNodes[i];return null}getLastSkeletonById(e){for(let i=this.skeletons.length-1;i>=0;i--)if(this.skeletons[i].id===e)return this.skeletons[i];return null}getSkeletonByUniqueId(e){for(let i=0;i<this.skeletons.length;i++)if(this.skeletons[i].uniqueId===e)return this.skeletons[i];return null}getSkeletonById(e){for(let i=0;i<this.skeletons.length;i++)if(this.skeletons[i].id===e)return this.skeletons[i];return null}getSkeletonByName(e){for(let i=0;i<this.skeletons.length;i++)if(this.skeletons[i].name===e)return this.skeletons[i];return null}getMorphTargetManagerById(e){for(let i=0;i<this.morphTargetManagers.length;i++)if(this.morphTargetManagers[i].uniqueId===e)return this.morphTargetManagers[i];return null}getMorphTargetById(e){for(let i=0;i<this.morphTargetManagers.length;++i){let s=this.morphTargetManagers[i];for(let r=0;r<s.numTargets;++r){let a=s.getTarget(r);if(a.id===e)return a}}return null}getMorphTargetByName(e){for(let i=0;i<this.morphTargetManagers.length;++i){let s=this.morphTargetManagers[i];for(let r=0;r<s.numTargets;++r){let a=s.getTarget(r);if(a.name===e)return a}}return null}getPostProcessByName(e){for(let i=0;i<this.postProcesses.length;++i){let s=this.postProcesses[i];if(s.name===e)return s}return null}isActiveMesh(e){return this._activeMeshes.indexOf(e)!==-1}get uid(){return this._uid||(this._uid=Z.RandomId()),this._uid}addExternalData(e,i){return this._externalData||(this._externalData=new as),this._externalData.add(e,i)}getExternalData(e){return this._externalData?this._externalData.get(e):null}getOrAddExternalDataWithFactory(e,i){return this._externalData||(this._externalData=new as),this._externalData.getOrAddWithFactory(e,i)}removeExternalData(e){return this._externalData.remove(e)}_evaluateSubMesh(e,i,s,r){if(r||e.isInFrustum(this._frustumPlanes)){for(let o of this._evaluateSubMeshStage)o.action(i,e);let a=e.getMaterial();a!=null&&(a.hasRenderTargetTextures&&a.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(a)===-1&&(this._processedMaterials.push(a),this._materialsRenderTargets.concatWithNoDuplicate(a.getRenderTargetTextures())),this._renderingManager.dispatch(e,i,a))}}freeProcessedMaterials(){this._processedMaterials.dispose()}get blockfreeActiveMeshesAndRenderingGroups(){return this._preventFreeActiveMeshesAndRenderingGroups}set blockfreeActiveMeshesAndRenderingGroups(e){this._preventFreeActiveMeshesAndRenderingGroups!==e&&(e&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=e)}freeActiveMeshes(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(let e=0;e<this.activeCameras.length;e++){let i=this.activeCameras[e];i&&i._activeMeshes&&i._activeMeshes.dispose()}}freeRenderingGroups(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(let e=0;e<this.textures.length;e++){let i=this.textures[e];i&&i.renderList&&i.freeRenderingGroups()}}_isInIntermediateRendering(){return this._intermediateRendering}freezeActiveMeshes(e=!1,i,s,r=!0,a=!1){return this.executeWhenReady(()=>{if(!this.activeCamera){s&&s("No active camera found");return}if(this._frustumPlanes||this.updateTransformMatrix(),this._evaluateActiveMeshes(),this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=a,this._skipEvaluateActiveMeshesCompletely=e,r)for(let o=0;o<this._activeMeshes.length;o++)this._activeMeshes.data[o]._freeze();i&&i()}),this}unfreezeActiveMeshes(){for(let e=0;e<this.meshes.length;e++){let i=this.meshes[e];i._internalAbstractMeshDataInfo&&(i._internalAbstractMeshDataInfo._isActive=!1)}for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._unFreeze();return this._activeMeshesFrozen=!1,this}_executeActiveContainerCleanup(e){!(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1)&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce(()=>e.dispose())}_evaluateActiveMeshes(){var e;if(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1){this._activeMeshes.length>0&&((e=this.activeCamera)===null||e===void 0||e._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset());return}if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely){let r=this._activeMeshes.length;for(let a=0;a<r;a++)this._activeMeshes.data[a].computeWorldMatrix()}if(this._activeParticleSystems){let r=this._activeParticleSystems.length;for(let a=0;a<r;a++)this._activeParticleSystems.data[a].animate()}this._renderingManager.resetSprites();return}if(!this.activeCamera)return;this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset();for(let r of this._beforeEvaluateActiveMeshStage)r.action();let i=this.getActiveMeshCandidates(),s=i.length;for(let r=0;r<s;r++){let a=i.data[r];if(a._internalAbstractMeshDataInfo._currentLODIsUpToDate=!1,a.isBlocked||(this._totalVertices.addCount(a.getTotalVertices(),!1),!a.isReady()||!a.isEnabled()||a.scaling.hasAZeroComponent))continue;a.computeWorldMatrix(),a.actionManager&&a.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(a);let o=this.customLODSelector?this.customLODSelector(a,this.activeCamera):a.getLOD(this.activeCamera);if(a._internalAbstractMeshDataInfo._currentLOD=o,a._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0,o!=null&&(o!==a&&o.billboardMode!==0&&o.computeWorldMatrix(),a._preActivate(),a.isVisible&&a.visibility>0&&a.layerMask&this.activeCamera.layerMask&&(this._skipFrustumClipping||a.alwaysSelectAsActiveMesh||a.isInFrustum(this._frustumPlanes)))){this._activeMeshes.push(a),this.activeCamera._activeMeshes.push(a),o!==a&&o._activate(this._renderId,!1);for(let h of this._preActiveMeshStage)h.action(a);a._activate(this._renderId,!1)&&(a.isAnInstance?a._internalAbstractMeshDataInfo._actAsRegularMesh&&(o=a):o._internalAbstractMeshDataInfo._onlyForInstances=!1,o._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(a,o)),a._postActivate()}}if(this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(let r=0;r<this.particleSystems.length;r++){let a=this.particleSystems[r];if(!a.isStarted()||!a.emitter)continue;let o=a.emitter;(!o.position||o.isEnabled())&&(this._activeParticleSystems.push(a),a.animate(),this._renderingManager.dispatchParticles(a))}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}_activeMesh(e,i){this._skeletonsEnabled&&i.skeleton!==null&&i.skeleton!==void 0&&(this._activeSkeletons.pushNoDuplicate(i.skeleton)&&(i.skeleton.prepare(),this._activeBones.addCount(i.skeleton.bones.length,!1)),i.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(i));let s=e.hasInstances||e.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||i.alwaysSelectAsActiveMesh;if(i&&i.subMeshes&&i.subMeshes.length>0){let r=this.getActiveSubMeshCandidates(i),a=r.length;s=s||a===1;for(let o=0;o<a;o++){let h=r.data[o];this._evaluateSubMesh(h,i,e,s)}}}updateTransformMatrix(e){if(this.activeCamera)if(this.activeCamera._renderingMultiview){let i=this.activeCamera._rigCameras[0],s=this.activeCamera._rigCameras[1];this.setTransformMatrix(i.getViewMatrix(),i.getProjectionMatrix(e),s.getViewMatrix(),s.getProjectionMatrix(e))}else this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(e))}_bindFrameBuffer(e,i=!0){e&&e._multiviewTexture?e._multiviewTexture._bindFrameBuffer():e&&e.outputRenderTarget?e.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer(),i&&this._clearFrameBuffer(e)}_clearFrameBuffer(e){if(!(e&&e._multiviewTexture))if(e&&e.outputRenderTarget&&!e._renderingMultiview){let i=e.outputRenderTarget;i.onClearObservable.hasObservers()?i.onClearObservable.notifyObservers(this._engine):i.skipInitialClear||(this.autoClear&&this._engine.clear(i.clearColor||this.clearColor,!i._cleared,!0,!0),i._cleared=!0)}else this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear())}_renderForCamera(e,i,s=!0){var r,a,o;if(e&&e._skipRendering)return;let h=this._engine;if(this._activeCamera=e,!this.activeCamera)throw new Error("Active camera not set");if(h.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&s){let c=!0;e._renderingMultiview&&e.outputRenderTarget&&(c=e.outputRenderTarget.skipInitialClear,this.autoClear&&(e.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),e._renderingMultiview&&e.outputRenderTarget&&(e.outputRenderTarget.skipInitialClear=c)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(let c=0;c<this._softwareSkinnedMeshes.length;c++){let d=this._softwareSkinnedMeshes.data[c];d.applySkeleton(d.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),e.customRenderTargets&&e.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(e.customRenderTargets),i&&i.customRenderTargets&&i.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(i.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture);for(let c of this._gatherActiveCameraRenderTargetsStage)c.action(this._renderTargets);let l=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,this._renderTargets.length>0){Z.StartPerformanceCounter("Render targets",this._renderTargets.length>0);for(let c=0;c<this._renderTargets.length;c++){let d=this._renderTargets.data[c];if(d._shouldRender()){this._renderId++;let u=d.activeCamera&&d.activeCamera!==this.activeCamera;d.render(u,this.dumpNextRenderTargets),l=!0}}Z.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._renderId++}for(let c of this._cameraDrawRenderTargetStage)l=c.action(this.activeCamera)||l;this._intermediateRendering=!1}this._engine.currentRenderPassId=(o=(a=(r=e.outputRenderTarget)===null||r===void 0?void 0:r.renderPassId)!==null&&a!==void 0?a:e.renderPassId)!==null&&o!==void 0?o:0,l&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),this.postProcessManager&&!e._multiviewTexture&&!this.prePass&&this.postProcessManager._prepareFrame();for(let c of this._beforeCameraDrawStage)c.action(this.activeCamera);this.onBeforeDrawPhaseObservable.notifyObservers(this),h.snapshotRendering&&h.snapshotRenderingMode===1&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this);for(let c of this._afterCameraDrawStage)c.action(this.activeCamera);if(this.postProcessManager&&!e._multiviewTexture){let c=e.outputRenderTarget?e.outputRenderTarget.renderTarget:void 0;this.postProcessManager._finalizeFrame(e.isIntermediate,c)}for(let c of this._afterCameraPostProcessStage)c.action(this.activeCamera);this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}_processSubCameras(e,i=!0){if(e.cameraRigMode===0||e._renderingMultiview){e._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(e,void 0,i),this.onAfterRenderCameraObservable.notifyObservers(e);return}if(e._useMultiviewToSingleView)this._renderMultiviewToSingleView(e);else{this.onBeforeCameraRenderObservable.notifyObservers(e);for(let s=0;s<e._rigCameras.length;s++)this._renderForCamera(e._rigCameras[s],e)}this._activeCamera=e,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(e)}_checkIntersections(){for(let e=0;e<this._meshesForIntersections.length;e++){let i=this._meshesForIntersections.data[e];if(i.actionManager)for(let s=0;i.actionManager&&s<i.actionManager.actions.length;s++){let r=i.actionManager.actions[s];if(r.trigger===12||r.trigger===13){let a=r.getTriggerParameter(),o=a.mesh?a.mesh:a,h=o.intersectsMesh(i,a.usePreciseIntersection),l=i._intersectionsInProgress.indexOf(o);h&&l===-1?r.trigger===12?(r._executeCurrent(Be.CreateNew(i,void 0,o)),i._intersectionsInProgress.push(o)):r.trigger===13&&i._intersectionsInProgress.push(o):!h&&l>-1&&(r.trigger===13&&r._executeCurrent(Be.CreateNew(i,void 0,o)),(!i.actionManager.hasSpecificTrigger(13,c=>{let d=c.mesh?c.mesh:c;return o===d})||r.trigger===13)&&i._intersectionsInProgress.splice(l,1))}}}}_advancePhysicsEngineStep(e){}_animate(){}animate(){if(this._engine.isDeterministicLockStep()){let e=Math.max(n.MinDeltaTime,Math.min(this._engine.getDeltaTime(),n.MaxDeltaTime))+this._timeAccumulator,i=this._engine.getTimeStep(),s=1e3/i/1e3,r=0,a=this._engine.getLockstepMaxSteps(),o=Math.floor(e/i);for(o=Math.min(o,a);e>0&&r<o;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=i*s,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(i),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,r++,e-=i;this._timeAccumulator=e<0?0:e}else{let e=this.useConstantAnimationDeltaTime?16:Math.max(n.MinDeltaTime,Math.min(this._engine.getDeltaTime(),n.MaxDeltaTime));this._animationRatio=e*(60/1e3),this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(e)}}_clear(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}_checkCameraRenderTarget(e){var i;if(e!=null&&e.outputRenderTarget&&!(e!=null&&e.isRigCamera)&&(e.outputRenderTarget._cleared=!1),!((i=e?.rigCameras)===null||i===void 0)&&i.length)for(let s=0;s<e.rigCameras.length;++s){let r=e.rigCameras[s].outputRenderTarget;r&&(r._cleared=!1)}}resetDrawCache(e){if(this.meshes)for(let i of this.meshes)i.resetDrawCache(e)}render(e=!0,i=!1){var s,r,a;if(this.isDisposed)return;this.onReadyObservable.hasObservers()&&this._executeWhenReadyTimeoutId===null&&this._checkIsReady(),this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),!((s=this.activeCameras)===null||s===void 0)&&s.length&&this.activeCameras.forEach(this._checkCameraRenderTarget),this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),i||this.animate();for(let l of this._beforeCameraUpdateStage)l.action();if(e){if(this.activeCameras&&this.activeCameras.length>0)for(let l=0;l<this.activeCameras.length;l++){let c=this.activeCameras[l];if(c.update(),c.cameraRigMode!==0)for(let d=0;d<c._rigCameras.length;d++)c._rigCameras[d].update()}else if(this.activeCamera&&(this.activeCamera.update(),this.activeCamera.cameraRigMode!==0))for(let l=0;l<this.activeCamera._rigCameras.length;l++)this.activeCamera._rigCameras[l].update()}this.onBeforeRenderObservable.notifyObservers(this);let o=this.getEngine();this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);let h=!((r=this.activeCameras)===null||r===void 0)&&r.length?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){Z.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!0;for(let l=0;l<this.customRenderTargets.length;l++){let c=this.customRenderTargets[l];if(c._shouldRender()){if(this._renderId++,this.activeCamera=c.activeCamera||this.activeCamera,!this.activeCamera)throw new Error("Active camera not set");o.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),c.render(h!==this.activeCamera,this.dumpNextRenderTargets)}}Z.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!1,this._renderId++}this._engine.currentRenderPassId=(a=h?.renderPassId)!==null&&a!==void 0?a:0,this.activeCamera=h,this._activeCamera&&this._activeCamera.cameraRigMode!==22&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);for(let l of this._beforeClearStage)l.action();this._clearFrameBuffer(this.activeCamera);for(let l of this._gatherRenderTargetsStage)l.action(this._renderTargets);if(this.activeCameras&&this.activeCameras.length>0)for(let l=0;l<this.activeCameras.length;l++)this._processSubCameras(this.activeCameras[l],l>0);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}this._checkIntersections();for(let l of this._afterRenderStage)l.action();if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(let l=0;l<this._toBeDisposed.length;l++){let c=this._toBeDisposed[l];c&&c.dispose()}this._toBeDisposed.length=0}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}freezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].freeze()}unfreezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].unfreeze()}dispose(){if(this.isDisposed)return;this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this._transientComponents.length=0,this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=new Array,this.stopAllAnimations&&this.stopAllAnimations(),this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this.activeCameras=null,this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.length=0;let e=this._activeRequests.slice();for(let r of e)r.abort();this._activeRequests.length=0;try{this.onDisposeObservable.notifyObservers(this)}catch(r){console.error("An error occurred while calling onDisposeObservable!",r)}if(this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.detachControl(),this._engine.getInputElement())for(let r=0;r<this.cameras.length;r++)this.cameras[r].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._disposeList(this.meshes,r=>r.dispose(!0)),this._disposeList(this.transformNodes,r=>r.dispose(!0));let i=this.cameras;this._disposeList(i),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);let s=this._engine.scenes.indexOf(this);s>-1&&this._engine.scenes.splice(s,1),Q._LastCreatedScene===this&&(this._engine.scenes.length>0?Q._LastCreatedScene=this._engine.scenes[this._engine.scenes.length-1]:Q._LastCreatedScene=null),s=this._engine._virtualScenes.indexOf(this),s>-1&&this._engine._virtualScenes.splice(s,1),this._engine.wipeCaches(!0),this._isDisposed=!0}_disposeList(e,i){let s=e.slice(0);i=i??(r=>r.dispose());for(let r of s)i(r);e.length=0}get isDisposed(){return this._isDisposed}clearCachedVertexData(){for(let e=0;e<this.meshes.length;e++){let i=this.meshes[e].geometry;i&&i.clearCachedData()}}cleanCachedTextureBuffer(){for(let e of this.textures)e._buffer&&(e._buffer=null)}getWorldExtends(e){let i=new v(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s=new v(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return e=e||(()=>!0),this.meshes.filter(e).forEach(r=>{if(r.computeWorldMatrix(!0),!r.subMeshes||r.subMeshes.length===0||r.infiniteDistance)return;let a=r.getBoundingInfo(),o=a.boundingBox.minimumWorld,h=a.boundingBox.maximumWorld;v.CheckExtends(o,i,s),v.CheckExtends(h,i,s)}),{min:i,max:s}}createPickingRay(e,i,s,r,a=!1){throw H("Ray")}createPickingRayToRef(e,i,s,r,a,o=!1,h=!1){throw H("Ray")}createPickingRayInCameraSpace(e,i,s){throw H("Ray")}createPickingRayInCameraSpaceToRef(e,i,s,r){throw H("Ray")}get _pickingAvailable(){return!1}pick(e,i,s,r,a,o){return new lt}pickWithBoundingInfo(e,i,s,r,a){return new lt}pickWithRay(e,i,s,r){throw H("Ray")}multiPick(e,i,s,r,a){throw H("Ray")}multiPickWithRay(e,i,s){throw H("Ray")}setPointerOverMesh(e,i,s){this._inputManager.setPointerOverMesh(e,i,s)}getPointerOverMesh(){return this._inputManager.getPointerOverMesh()}_rebuildGeometries(){for(let e of this.geometries)e._rebuild();for(let e of this.meshes)e._rebuild();this.postProcessManager&&this.postProcessManager._rebuild();for(let e of this._components)e.rebuild();for(let e of this.particleSystems)e.rebuild();if(this.spriteManagers)for(let e of this.spriteManagers)e.rebuild()}_rebuildTextures(){for(let e of this.textures)e._rebuild();this.markAllMaterialsAsDirty(1)}_getByTags(e,i,s){if(i===void 0)return e;let r=[];s=s||(a=>{});for(let a in e){let o=e[a];he&&he.MatchesQuery(o,i)&&(r.push(o),s(o))}return r}getMeshesByTags(e,i){return this._getByTags(this.meshes,e,i)}getCamerasByTags(e,i){return this._getByTags(this.cameras,e,i)}getLightsByTags(e,i){return this._getByTags(this.lights,e,i)}getMaterialByTags(e,i){return this._getByTags(this.materials,e,i).concat(this._getByTags(this.multiMaterials,e,i))}getTransformNodesByTags(e,i){return this._getByTags(this.transformNodes,e,i)}setRenderingOrder(e,i=null,s=null,r=null){this._renderingManager.setRenderingOrder(e,i,s,r)}setRenderingAutoClearDepthStencil(e,i,s=!0,r=!0){this._renderingManager.setRenderingAutoClearDepthStencil(e,i,s,r)}getAutoClearDepthStencilSetup(e){return this._renderingManager.getAutoClearDepthStencilSetup(e)}get blockMaterialDirtyMechanism(){return this._blockMaterialDirtyMechanism}set blockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism!==e&&(this._blockMaterialDirtyMechanism=e,e||this.markAllMaterialsAsDirty(63))}markAllMaterialsAsDirty(e,i){if(!this._blockMaterialDirtyMechanism)for(let s of this.materials)i&&!i(s)||s.markAsDirty(e)}_loadFile(e,i,s,r,a,o,h){let l=Xt(e,i,s,r?this.offlineProvider:void 0,a,o,h);return this._activeRequests.push(l),l.onCompleteObservable.add(c=>{this._activeRequests.splice(this._activeRequests.indexOf(c),1)}),l}_loadFileAsync(e,i,s,r,a){return new Promise((o,h)=>{this._loadFile(e,l=>{o(l)},i,s,r,(l,c)=>{h(c)},a)})}_requestFile(e,i,s,r,a,o,h){let l=Yr(e,i,s,r?this.offlineProvider:void 0,a,o,h);return this._activeRequests.push(l),l.onCompleteObservable.add(c=>{this._activeRequests.splice(this._activeRequests.indexOf(c),1)}),l}_requestFileAsync(e,i,s,r,a){return new Promise((o,h)=>{this._requestFile(e,l=>{o(l)},i,s,r,l=>{h(l)},a)})}_readFile(e,i,s,r,a){let o=wi(e,i,s,r,a);return this._activeRequests.push(o),o.onCompleteObservable.add(h=>{this._activeRequests.splice(this._activeRequests.indexOf(h),1)}),o}_readFileAsync(e,i,s){return new Promise((r,a)=>{this._readFile(e,o=>{r(o)},i,s,o=>{a(o)})})}getPerfCollector(){throw H("performanceViewerSceneExtension")}}return n.FOGMODE_NONE=0,n.FOGMODE_EXP=1,n.FOGMODE_EXP2=2,n.FOGMODE_LINEAR=3,n.MinDeltaTime=1,n.MaxDeltaTime=1e3,n})();te.prototype.setActiveCameraByID=function(n){return this.setActiveCameraById(n)};te.prototype.getLastMaterialByID=function(n){return this.getLastMaterialById(n)};te.prototype.getMaterialByID=function(n){return this.getMaterialById(n)};te.prototype.getTextureByUniqueID=function(n){return this.getTextureByUniqueId(n)};te.prototype.getCameraByID=function(n){return this.getCameraById(n)};te.prototype.getCameraByUniqueID=function(n){return this.getCameraByUniqueId(n)};te.prototype.getBoneByID=function(n){return this.getBoneById(n)};te.prototype.getLightByID=function(n){return this.getLightById(n)};te.prototype.getLightByUniqueID=function(n){return this.getLightByUniqueId(n)};te.prototype.getParticleSystemByID=function(n){return this.getParticleSystemById(n)};te.prototype.getGeometryByID=function(n){return this.getGeometryById(n)};te.prototype.getMeshByID=function(n){return this.getMeshById(n)};te.prototype.getMeshesByID=function(n){return this.getMeshesById(n)};te.prototype.getTransformNodeByID=function(n){return this.getTransformNodeById(n)};te.prototype.getTransformNodeByUniqueID=function(n){return this.getTransformNodeByUniqueId(n)};te.prototype.getTransformNodesByID=function(n){return this.getTransformNodesById(n)};te.prototype.getMeshByUniqueID=function(n){return this.getMeshByUniqueId(n)};te.prototype.getLastMeshByID=function(n){return this.getLastMeshById(n)};te.prototype.getLastEntryByID=function(n){return this.getLastEntryById(n)};te.prototype.getNodeByID=function(n){return this.getNodeById(n)};te.prototype.getLastSkeletonByID=function(n){return this.getLastSkeletonById(n)};function pr(n,t,e){try{let i=n.next();i.done?t(i):i.value?i.value.then(()=>{i.value=void 0,t(i)},e):t(i)}catch(i){e(i)}}function da(n=25){let t;return(e,i,s)=>{let r=performance.now();t===void 0||r-t>n?(t=r,setTimeout(()=>{pr(e,i,s)},0)):pr(e,i,s)}}function Dn(n,t,e,i,s){let r=()=>{let a,o=h=>{h.done?e(h.value):a===void 0?a=!0:r()};do a=void 0,!s||!s.aborted?t(n,o,i):i(new Error("Aborted")),a===void 0&&(a=!1);while(a)};r()}function Zr(n,t){let e;return Dn(n,pr,i=>e=i,i=>{throw i},t),e}function ua(n,t,e){return new Promise((i,s)=>{Dn(n,t,i,s,e)})}function fa(n,t){return(...e)=>Zr(n(...e),t)}var gr=class{constructor(){this._doNotSerialize=!1,this._isDisposed=!1,this._sceneRootNodesIndex=-1,this._isEnabled=!0,this._isParentEnabled=!0,this._isReady=!0,this._onEnabledStateChangedObservable=new D,this._onClonedObservable=new D}},Ge=(()=>{class n{constructor(e,i=null){this._isDirty=!1,this._nodeDataStorage=new gr,this.state="",this.metadata=null,this.reservedDataStore=null,this._accessibilityTag=null,this.onAccessibilityTagChangedObservable=new D,this._parentContainer=null,this.animations=new Array,this._ranges={},this.onReady=null,this._currentRenderId=-1,this._parentUpdateId=-1,this._childUpdateId=-1,this._waitingParentId=null,this._waitingParentInstanceIndex=null,this._waitingParsedUniqueId=null,this._cache={},this._parentNode=null,this._children=null,this._worldMatrix=P.Identity(),this._worldMatrixDeterminant=0,this._worldMatrixDeterminantIsDirty=!0,this._animationPropertiesOverride=null,this._isNode=!0,this.onDisposeObservable=new D,this._onDisposeObserver=null,this._behaviors=new Array,this.name=e,this.id=e,this._scene=i||Q.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache()}static AddNodeConstructor(e,i){this._NodeConstructors[e]=i}static Construct(e,i,s,r){let a=this._NodeConstructors[e];return a?a(i,s,r):null}set accessibilityTag(e){this._accessibilityTag=e,this.onAccessibilityTagChangedObservable.notifyObservers(e)}get accessibilityTag(){return this._accessibilityTag}get doNotSerialize(){return this._nodeDataStorage._doNotSerialize?!0:this._parentNode?this._parentNode.doNotSerialize:!1}set doNotSerialize(e){this._nodeDataStorage._doNotSerialize=e}isDisposed(){return this._nodeDataStorage._isDisposed}set parent(e){if(this._parentNode===e)return;let i=this._parentNode;if(this._parentNode&&this._parentNode._children!==void 0&&this._parentNode._children!==null){let s=this._parentNode._children.indexOf(this);s!==-1&&this._parentNode._children.splice(s,1),!e&&!this._nodeDataStorage._isDisposed&&this._addToSceneRootNodes()}this._parentNode=e,this._parentNode&&((this._parentNode._children===void 0||this._parentNode._children===null)&&(this._parentNode._children=new Array),this._parentNode._children.push(this),i||this._removeFromSceneRootNodes()),this._syncParentEnabledState()}get parent(){return this._parentNode}_serializeAsParent(e){e.parentId=this.uniqueId}_addToSceneRootNodes(){this._nodeDataStorage._sceneRootNodesIndex===-1&&(this._nodeDataStorage._sceneRootNodesIndex=this._scene.rootNodes.length,this._scene.rootNodes.push(this))}_removeFromSceneRootNodes(){if(this._nodeDataStorage._sceneRootNodesIndex!==-1){let e=this._scene.rootNodes,i=e.length-1;e[this._nodeDataStorage._sceneRootNodesIndex]=e[i],e[this._nodeDataStorage._sceneRootNodesIndex]._nodeDataStorage._sceneRootNodesIndex=this._nodeDataStorage._sceneRootNodesIndex,this._scene.rootNodes.pop(),this._nodeDataStorage._sceneRootNodesIndex=-1}}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}getClassName(){return"Node"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onEnabledStateChangedObservable(){return this._nodeDataStorage._onEnabledStateChangedObservable}get onClonedObservable(){return this._nodeDataStorage._onClonedObservable}getScene(){return this._scene}getEngine(){return this._scene.getEngine()}addBehavior(e,i=!1){return this._behaviors.indexOf(e)!==-1?this:(e.init(),this._scene.isLoading&&!i?this._scene.onDataLoadedObservable.addOnce(()=>{e.attach(this)}):e.attach(this),this._behaviors.push(e),this)}removeBehavior(e){let i=this._behaviors.indexOf(e);return i===-1?this:(this._behaviors[i].detach(),this._behaviors.splice(i,1),this)}get behaviors(){return this._behaviors}getBehaviorByName(e){for(let i of this._behaviors)if(i.name===e)return i;return null}getWorldMatrix(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix}_getWorldMatrixDeterminant(){return this._worldMatrixDeterminantIsDirty&&(this._worldMatrixDeterminantIsDirty=!1,this._worldMatrixDeterminant=this._worldMatrix.determinant()),this._worldMatrixDeterminant}get worldMatrixFromCache(){return this._worldMatrix}_initCache(){this._cache={},this._cache.parent=void 0}updateCache(e){!e&&this.isSynchronized()||(this._cache.parent=this.parent,this._updateCache())}_getActionManagerForTrigger(e,i=!0){return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_updateCache(e){}_isSynchronized(){return!0}_markSyncedWithParent(){this._parentNode&&(this._parentUpdateId=this._parentNode._childUpdateId)}isSynchronizedWithParent(){return this._parentNode?this._parentNode._isDirty||this._parentUpdateId!==this._parentNode._childUpdateId?!1:this._parentNode.isSynchronized():!0}isSynchronized(){return this._cache.parent!==this._parentNode?(this._cache.parent=this._parentNode,!1):this._parentNode&&!this.isSynchronizedWithParent()?!1:this._isSynchronized()}isReady(e=!1){return this._nodeDataStorage._isReady}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}isEnabled(e=!0){return e===!1?this._nodeDataStorage._isEnabled:this._nodeDataStorage._isEnabled?this._nodeDataStorage._isParentEnabled:!1}_syncParentEnabledState(){this._nodeDataStorage._isParentEnabled=this._parentNode?this._parentNode.isEnabled():!0,this._children&&this._children.forEach(e=>{e._syncParentEnabledState()})}setEnabled(e){this._nodeDataStorage._isEnabled!==e&&(this._nodeDataStorage._isEnabled=e,this._syncParentEnabledState(),this._nodeDataStorage._onEnabledStateChangedObservable.notifyObservers(e))}isDescendantOf(e){return this.parent?this.parent===e?!0:this.parent.isDescendantOf(e):!1}_getDescendants(e,i=!1,s){if(this._children)for(let r=0;r<this._children.length;r++){let a=this._children[r];(!s||s(a))&&e.push(a),i||a._getDescendants(e,!1,s)}}getDescendants(e,i){let s=new Array;return this._getDescendants(s,e,i),s}getChildMeshes(e,i){let s=[];return this._getDescendants(s,e,r=>(!i||i(r))&&r.cullingStrategy!==void 0),s}getChildren(e,i=!0){return this.getDescendants(i,e)}_setReady(e){if(e!==this._nodeDataStorage._isReady){if(!e){this._nodeDataStorage._isReady=!1;return}this.onReady&&this.onReady(this),this._nodeDataStorage._isReady=!0}}getAnimationByName(e){for(let i=0;i<this.animations.length;i++){let s=this.animations[i];if(s.name===e)return s}return null}createAnimationRange(e,i,s){if(!this._ranges[e]){this._ranges[e]=n._AnimationRangeFactory(e,i,s);for(let r=0,a=this.animations.length;r<a;r++)this.animations[r]&&this.animations[r].createRange(e,i,s)}}deleteAnimationRange(e,i=!0){for(let s=0,r=this.animations.length;s<r;s++)this.animations[s]&&this.animations[s].deleteRange(e,i);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){let e=[],i;for(i in this._ranges)e.push(this._ranges[i]);return e}beginAnimation(e,i,s,r){let a=this.getAnimationRange(e);return a?this._scene.beginAnimation(this,a.from,a.to,i,s,r):null}serializeAnimationRanges(){let e=[];for(let i in this._ranges){let s=this._ranges[i];if(!s)continue;let r={};r.name=i,r.from=s.from,r.to=s.to,e.push(r)}return e}computeWorldMatrix(e){return this._worldMatrix||(this._worldMatrix=P.Identity()),this._worldMatrix}dispose(e,i=!1){if(this._nodeDataStorage._isDisposed=!0,!e){let s=this.getDescendants(!0);for(let r of s)r.dispose(e,i)}this.parent?this.parent=null:this._removeFromSceneRootNodes(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear();for(let s of this._behaviors)s.detach();this._behaviors.length=0,this.metadata=null}static ParseAnimationRanges(e,i,s){if(i.ranges)for(let r=0;r<i.ranges.length;r++){let a=i.ranges[r];e.createAnimationRange(a.name,a.from,a.to)}}getHierarchyBoundingVectors(e=!0,i=null){this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);let s,r,a=this;if(a.getBoundingInfo&&a.subMeshes){let o=a.getBoundingInfo();s=o.boundingBox.minimumWorld.clone(),r=o.boundingBox.maximumWorld.clone()}else s=new v(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r=new v(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(e){let o=this.getDescendants(!1);for(let h of o){let l=h;if(l.computeWorldMatrix(!0),i&&!i(l)||!l.getBoundingInfo||l.getTotalVertices()===0)continue;let c=l.getBoundingInfo().boundingBox,d=c.minimumWorld,u=c.maximumWorld;v.CheckExtends(d,s,r),v.CheckExtends(u,s,r)}}return{min:s,max:r}}}return n._AnimationRangeFactory=(t,e,i)=>{throw H("AnimationRange")},n._NodeConstructors={},n})();S([A()],Ge.prototype,"name",void 0);S([A()],Ge.prototype,"id",void 0);S([A()],Ge.prototype,"uniqueId",void 0);S([A()],Ge.prototype,"state",void 0);S([A()],Ge.prototype,"metadata",void 0);var _s=class n{constructor(t,e,i,s){this.x=t,this.y=e,this.width=i,this.height=s}toGlobal(t,e){return new n(this.x*t,this.y*e,this.width*t,this.height*e)}toGlobalToRef(t,e,i){return i.x=this.x*t,i.y=this.y*e,i.width=this.width*t,i.height=this.height*e,this}clone(){return new n(this.x,this.y,this.width,this.height)}},ne=(()=>{class n extends Ge{constructor(e,i,s,r=!0){super(e,s),this._position=v.Zero(),this._upVector=v.Up(),this._orthoLeft=null,this._orthoRight=null,this._orthoBottom=null,this._orthoTop=null,this.fov=.8,this.projectionPlaneTilt=0,this.minZ=1,this.maxZ=1e4,this.inertia=.9,this._mode=n.PERSPECTIVE_CAMERA,this.isIntermediate=!1,this.viewport=new _s(0,0,1,1),this.layerMask=268435455,this.fovMode=n.FOVMODE_VERTICAL_FIXED,this.cameraRigMode=n.RIG_MODE_NONE,this.customRenderTargets=new Array,this.outputRenderTarget=null,this.onViewMatrixChangedObservable=new D,this.onProjectionMatrixChangedObservable=new D,this.onAfterCheckInputsObservable=new D,this.onRestoreStateObservable=new D,this.isRigCamera=!1,this._rigCameras=new Array,this._webvrViewMatrix=P.Identity(),this._skipRendering=!1,this._projectionMatrix=new P,this._postProcesses=new Array,this._activeMeshes=new Ze(256),this._globalPosition=v.Zero(),this._computedViewMatrix=P.Identity(),this._doNotComputeProjectionMatrix=!1,this._transformMatrix=P.Zero(),this._refreshFrustumPlanes=!0,this._absoluteRotation=se.Identity(),this._isCamera=!0,this._isLeftCamera=!1,this._isRightCamera=!1,this.getScene().addCamera(this),r&&!this.getScene().activeCamera&&(this.getScene().activeCamera=this),this.position=i,this.renderPassId=this.getScene().getEngine().createRenderPassId(`Camera ${e}`)}get position(){return this._position}set position(e){this._position=e}set upVector(e){this._upVector=e}get upVector(){return this._upVector}get screenArea(){var e,i,s,r;let a=0,o=0;if(this.mode===n.PERSPECTIVE_CAMERA)this.fovMode===n.FOVMODE_VERTICAL_FIXED?(o=this.minZ*2*Math.tan(this.fov/2),a=this.getEngine().getAspectRatio(this)*o):(a=this.minZ*2*Math.tan(this.fov/2),o=a/this.getEngine().getAspectRatio(this));else{let h=this.getEngine().getRenderWidth()/2,l=this.getEngine().getRenderHeight()/2;a=((e=this.orthoRight)!==null&&e!==void 0?e:h)-((i=this.orthoLeft)!==null&&i!==void 0?i:-h),o=((s=this.orthoTop)!==null&&s!==void 0?s:l)-((r=this.orthoBottom)!==null&&r!==void 0?r:-l)}return a*o}set orthoLeft(e){this._orthoLeft=e;for(let i of this._rigCameras)i.orthoLeft=e}get orthoLeft(){return this._orthoLeft}set orthoRight(e){this._orthoRight=e;for(let i of this._rigCameras)i.orthoRight=e}get orthoRight(){return this._orthoRight}set orthoBottom(e){this._orthoBottom=e;for(let i of this._rigCameras)i.orthoBottom=e}get orthoBottom(){return this._orthoBottom}set orthoTop(e){this._orthoTop=e;for(let i of this._rigCameras)i.orthoTop=e}get orthoTop(){return this._orthoTop}set mode(e){this._mode=e;for(let i of this._rigCameras)i.mode=e}get mode(){return this._mode}storeState(){return this._stateStored=!0,this._storedFov=this.fov,this}_restoreStateValues(){return this._stateStored?(this.fov=this._storedFov,!0):!1}restoreState(){return this._restoreStateValues()?(this.onRestoreStateObservable.notifyObservers(this),!0):!1}getClassName(){return"Camera"}toString(e){let i="Name: "+this.name;if(i+=", type: "+this.getClassName(),this.animations)for(let s=0;s<this.animations.length;s++)i+=", animation[0]: "+this.animations[s].toString(e);return i}applyVerticalCorrection(){let e=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-e.x:e.x}get globalPosition(){return this._globalPosition}getActiveMeshes(){return this._activeMeshes}isActiveMesh(e){return this._activeMeshes.indexOf(e)!==-1}isReady(e=!1){if(e){for(let i of this._postProcesses)if(i&&!i.isReady())return!1}return super.isReady(e)}_initCache(){super._initCache(),this._cache.position=new v(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new v(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0}_updateCache(e){e||super._updateCache(),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)}_isSynchronized(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()}_isSynchronizedViewMatrix(){return super._isSynchronized()?this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent():!1}_isSynchronizedProjectionMatrix(){let e=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!e)return!1;let i=this.getEngine();return this.mode===n.PERSPECTIVE_CAMERA?e=this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===i.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:e=this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===i.getRenderWidth()&&this._cache.renderHeight===i.getRenderHeight(),e}attachControl(e,i){}detachControl(e){}update(){this._checkInputs(),this.cameraRigMode!==n.RIG_MODE_NONE&&this._updateRigCameras()}_checkInputs(){this.onAfterCheckInputsObservable.notifyObservers(this)}get rigCameras(){return this._rigCameras}get rigPostProcess(){return this._rigPostProcess}_getFirstPostProcess(){for(let e=0;e<this._postProcesses.length;e++)if(this._postProcesses[e]!==null)return this._postProcesses[e];return null}_cascadePostProcessesToRigCams(){let e=this._getFirstPostProcess();e&&e.markTextureDirty();for(let i=0,s=this._rigCameras.length;i<s;i++){let r=this._rigCameras[i],a=r._rigPostProcess;a?(a.getEffectName()==="pass"&&(r.isIntermediate=this._postProcesses.length===0),r._postProcesses=this._postProcesses.slice(0).concat(a),a.markTextureDirty()):r._postProcesses=this._postProcesses.slice(0)}}attachPostProcess(e,i=null){return!e.isReusable()&&this._postProcesses.indexOf(e)>-1?(O.Error("You're trying to reuse a post process not defined as reusable."),0):(i==null||i<0?this._postProcesses.push(e):this._postProcesses[i]===null?this._postProcesses[i]=e:this._postProcesses.splice(i,0,e),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(e))}detachPostProcess(e){let i=this._postProcesses.indexOf(e);i!==-1&&(this._postProcesses[i]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams()}getWorldMatrix(){return this._isSynchronizedViewMatrix()?this._worldMatrix:(this.getViewMatrix(),this._worldMatrix)}_getViewMatrix(){return P.Identity()}getViewMatrix(e){return!e&&this._isSynchronizedViewMatrix()?this._computedViewMatrix:(this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix),this._computedViewMatrix)}freezeProjectionMatrix(e){this._doNotComputeProjectionMatrix=!0,e!==void 0&&(this._projectionMatrix=e)}unfreezeProjectionMatrix(){this._doNotComputeProjectionMatrix=!1}getProjectionMatrix(e){var i,s,r,a,o,h,l,c;if(this._doNotComputeProjectionMatrix||!e&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;let d=this.getEngine(),u=this.getScene(),f=d.useReverseDepthBuffer;if(this.mode===n.PERSPECTIVE_CAMERA){this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=d.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1);let _;u.useRightHandedSystem?_=P.PerspectiveFovRHToRef:_=P.PerspectiveFovLHToRef,_(this.fov,d.getAspectRatio(this),f?this.maxZ:this.minZ,f?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===n.FOVMODE_VERTICAL_FIXED,d.isNDCHalfZRange,this.projectionPlaneTilt,f)}else{let _=d.getRenderWidth()/2,g=d.getRenderHeight()/2;u.useRightHandedSystem?P.OrthoOffCenterRHToRef((i=this.orthoLeft)!==null&&i!==void 0?i:-_,(s=this.orthoRight)!==null&&s!==void 0?s:_,(r=this.orthoBottom)!==null&&r!==void 0?r:-g,(a=this.orthoTop)!==null&&a!==void 0?a:g,f?this.maxZ:this.minZ,f?this.minZ:this.maxZ,this._projectionMatrix,d.isNDCHalfZRange):P.OrthoOffCenterLHToRef((o=this.orthoLeft)!==null&&o!==void 0?o:-_,(h=this.orthoRight)!==null&&h!==void 0?h:_,(l=this.orthoBottom)!==null&&l!==void 0?l:-g,(c=this.orthoTop)!==null&&c!==void 0?c:g,f?this.maxZ:this.minZ,f?this.minZ:this.maxZ,this._projectionMatrix,d.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.renderWidth=d.getRenderWidth(),this._cache.renderHeight=d.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix}getTransformationMatrix(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix}_updateFrustumPlanes(){this._refreshFrustumPlanes&&(this.getTransformationMatrix(),this._frustumPlanes?pi.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=pi.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)}isInFrustum(e,i=!1){if(this._updateFrustumPlanes(),i&&this.rigCameras.length>0){let s=!1;return this.rigCameras.forEach(r=>{r._updateFrustumPlanes(),s=s||e.isInFrustum(r._frustumPlanes)}),s}else return e.isInFrustum(this._frustumPlanes)}isCompletelyInFrustum(e){return this._updateFrustumPlanes(),e.isCompletelyInFrustum(this._frustumPlanes)}getForwardRay(e=100,i,s){throw H("Ray")}getForwardRayToRef(e,i=100,s,r){throw H("Ray")}dispose(e,i=!1){for(this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){let r=this._rigCameras.pop();r&&r.dispose()}if(this._parentContainer){let r=this._parentContainer.cameras.indexOf(this);r>-1&&this._parentContainer.cameras.splice(r,1),this._parentContainer=null}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses.length=0;else if(this.cameraRigMode!==n.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses.length=0;else{let r=this._postProcesses.length;for(;--r>=0;){let a=this._postProcesses[r];a&&a.dispose(this)}}let s=this.customRenderTargets.length;for(;--s>=0;)this.customRenderTargets[s].dispose();this.customRenderTargets.length=0,this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),super.dispose(e,i)}get isLeftCamera(){return this._isLeftCamera}get isRightCamera(){return this._isRightCamera}get leftCamera(){return this._rigCameras.length<1?null:this._rigCameras[0]}get rightCamera(){return this._rigCameras.length<2?null:this._rigCameras[1]}getLeftTarget(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()}getRightTarget(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()}setCameraRigMode(e,i){if(this.cameraRigMode!==e){for(;this._rigCameras.length>0;){let s=this._rigCameras.pop();s&&s.dispose()}if(this.cameraRigMode=e,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=i.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=Z.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==n.RIG_MODE_NONE){let s=this.createRigCamera(this.name+"_L",0);s&&(s._isLeftCamera=!0);let r=this.createRigCamera(this.name+"_R",1);r&&(r._isRightCamera=!0),s&&r&&(this._rigCameras.push(s),this._rigCameras.push(r))}this._setRigMode(i),this._cascadePostProcessesToRigCams(),this.update()}}_setRigMode(e){}_getVRProjectionMatrix(){return P.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix}_updateCameraRotationMatrix(){}_updateWebVRCameraRotationMatrix(){}_getWebVRProjectionMatrix(){return P.Identity()}_getWebVRViewMatrix(){return P.Identity()}setCameraRigParameter(e,i){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[e]=i,e==="interaxialDistance"&&(this._cameraRigParams.stereoHalfAngle=Z.ToRadians(i/.0637))}createRigCamera(e,i){return null}_updateRigCameras(){for(let e=0;e<this._rigCameras.length;e++)this._rigCameras[e].minZ=this.minZ,this._rigCameras[e].maxZ=this.maxZ,this._rigCameras[e].fov=this.fov,this._rigCameras[e].upVector.copyFrom(this.upVector);this.cameraRigMode===n.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)}_setupInputs(){}serialize(){let e=ee.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getClassName(),this.parent&&this.parent._serializeAsParent(e),this.inputs&&this.inputs.serialize(e),ee.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}clone(e,i=null){let s=ee.Clone(n.GetConstructorFromName(this.getClassName(),e,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return s.name=e,s.parent=i,this.onClonedObservable.notifyObservers(s),s}getDirection(e){let i=v.Zero();return this.getDirectionToRef(e,i),i}get absoluteRotation(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation}getDirectionToRef(e,i){v.TransformNormalToRef(e,this.getWorldMatrix(),i)}static GetConstructorFromName(e,i,s,r=0,a=!0){return Ge.Construct(e,i,s,{interaxial_distance:r,isStereoscopicSideBySide:a})||(()=>n._CreateDefaultParsedCamera(i,s))}computeWorldMatrix(){return this.getWorldMatrix()}static Parse(e,i){let s=e.type,r=n.GetConstructorFromName(s,e.name,i,e.interaxial_distance,e.isStereoscopicSideBySide),a=ee.Parse(r,e,i);if(e.parentId!==void 0&&(a._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(a._waitingParentInstanceIndex=e.parentInstanceIndex),a.inputs&&(a.inputs.parse(e),a._setupInputs()),e.upVector&&(a.upVector=v.FromArray(e.upVector)),a.setPosition&&(a.position.copyFromFloats(0,0,0),a.setPosition(v.FromArray(e.position))),e.target&&a.setTarget&&a.setTarget(v.FromArray(e.target)),e.cameraRigMode){let o=e.interaxial_distance?{interaxialDistance:e.interaxial_distance}:{};a.setCameraRigMode(e.cameraRigMode,o)}if(e.animations){for(let o=0;o<e.animations.length;o++){let h=e.animations[o],l=Zt("BABYLON.Animation");l&&a.animations.push(l.Parse(h))}Ge.ParseAnimationRanges(a,e,i)}return e.autoAnimate&&i.beginAnimation(a,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&a.setEnabled(e.isEnabled),a}}return n._CreateDefaultParsedCamera=(t,e)=>{throw H("UniversalCamera")},n.PERSPECTIVE_CAMERA=0,n.ORTHOGRAPHIC_CAMERA=1,n.FOVMODE_VERTICAL_FIXED=0,n.FOVMODE_HORIZONTAL_FIXED=1,n.RIG_MODE_NONE=0,n.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,n.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,n.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,n.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,n.RIG_MODE_STEREOSCOPIC_INTERLACED=14,n.RIG_MODE_VR=20,n.RIG_MODE_WEBVR=21,n.RIG_MODE_CUSTOM=22,n.ForceAttachControlToAlwaysPreventDefault=!1,n})();S([Nt("position")],ne.prototype,"_position",void 0);S([Nt("upVector")],ne.prototype,"_upVector",void 0);S([A()],ne.prototype,"orthoLeft",null);S([A()],ne.prototype,"orthoRight",null);S([A()],ne.prototype,"orthoBottom",null);S([A()],ne.prototype,"orthoTop",null);S([A()],ne.prototype,"fov",void 0);S([A()],ne.prototype,"projectionPlaneTilt",void 0);S([A()],ne.prototype,"minZ",void 0);S([A()],ne.prototype,"maxZ",void 0);S([A()],ne.prototype,"inertia",void 0);S([A()],ne.prototype,"mode",null);S([A()],ne.prototype,"layerMask",void 0);S([A()],ne.prototype,"fovMode",void 0);S([A()],ne.prototype,"cameraRigMode",void 0);S([A()],ne.prototype,"interaxialDistance",void 0);S([A()],ne.prototype,"isStereoscopicSideBySide",void 0);var pe=(()=>{class n{constructor(){this._applyTo=fa(this._applyToCoroutine.bind(this))}set(e,i){switch(e.length||O.Warn(`Setting vertex data kind '${i}' with an empty array`),i){case m.PositionKind:this.positions=e;break;case m.NormalKind:this.normals=e;break;case m.TangentKind:this.tangents=e;break;case m.UVKind:this.uvs=e;break;case m.UV2Kind:this.uvs2=e;break;case m.UV3Kind:this.uvs3=e;break;case m.UV4Kind:this.uvs4=e;break;case m.UV5Kind:this.uvs5=e;break;case m.UV6Kind:this.uvs6=e;break;case m.ColorKind:this.colors=e;break;case m.MatricesIndicesKind:this.matricesIndices=e;break;case m.MatricesWeightsKind:this.matricesWeights=e;break;case m.MatricesIndicesExtraKind:this.matricesIndicesExtra=e;break;case m.MatricesWeightsExtraKind:this.matricesWeightsExtra=e;break}}applyToMesh(e,i){return this._applyTo(e,i,!1),this}applyToGeometry(e,i){return this._applyTo(e,i,!1),this}updateMesh(e){return this._update(e),this}updateGeometry(e){return this._update(e),this}*_applyToCoroutine(e,i=!1,s){return this.positions&&(e.setVerticesData(m.PositionKind,this.positions,i),s&&(yield)),this.normals&&(e.setVerticesData(m.NormalKind,this.normals,i),s&&(yield)),this.tangents&&(e.setVerticesData(m.TangentKind,this.tangents,i),s&&(yield)),this.uvs&&(e.setVerticesData(m.UVKind,this.uvs,i),s&&(yield)),this.uvs2&&(e.setVerticesData(m.UV2Kind,this.uvs2,i),s&&(yield)),this.uvs3&&(e.setVerticesData(m.UV3Kind,this.uvs3,i),s&&(yield)),this.uvs4&&(e.setVerticesData(m.UV4Kind,this.uvs4,i),s&&(yield)),this.uvs5&&(e.setVerticesData(m.UV5Kind,this.uvs5,i),s&&(yield)),this.uvs6&&(e.setVerticesData(m.UV6Kind,this.uvs6,i),s&&(yield)),this.colors&&(e.setVerticesData(m.ColorKind,this.colors,i),s&&(yield)),this.matricesIndices&&(e.setVerticesData(m.MatricesIndicesKind,this.matricesIndices,i),s&&(yield)),this.matricesWeights&&(e.setVerticesData(m.MatricesWeightsKind,this.matricesWeights,i),s&&(yield)),this.matricesIndicesExtra&&(e.setVerticesData(m.MatricesIndicesExtraKind,this.matricesIndicesExtra,i),s&&(yield)),this.matricesWeightsExtra&&(e.setVerticesData(m.MatricesWeightsExtraKind,this.matricesWeightsExtra,i),s&&(yield)),this.indices?(e.setIndices(this.indices,null,i),s&&(yield)):e.setIndices([],null),this}_update(e,i,s){return this.positions&&e.updateVerticesData(m.PositionKind,this.positions,i,s),this.normals&&e.updateVerticesData(m.NormalKind,this.normals,i,s),this.tangents&&e.updateVerticesData(m.TangentKind,this.tangents,i,s),this.uvs&&e.updateVerticesData(m.UVKind,this.uvs,i,s),this.uvs2&&e.updateVerticesData(m.UV2Kind,this.uvs2,i,s),this.uvs3&&e.updateVerticesData(m.UV3Kind,this.uvs3,i,s),this.uvs4&&e.updateVerticesData(m.UV4Kind,this.uvs4,i,s),this.uvs5&&e.updateVerticesData(m.UV5Kind,this.uvs5,i,s),this.uvs6&&e.updateVerticesData(m.UV6Kind,this.uvs6,i,s),this.colors&&e.updateVerticesData(m.ColorKind,this.colors,i,s),this.matricesIndices&&e.updateVerticesData(m.MatricesIndicesKind,this.matricesIndices,i,s),this.matricesWeights&&e.updateVerticesData(m.MatricesWeightsKind,this.matricesWeights,i,s),this.matricesIndicesExtra&&e.updateVerticesData(m.MatricesIndicesExtraKind,this.matricesIndicesExtra,i,s),this.matricesWeightsExtra&&e.updateVerticesData(m.MatricesWeightsExtraKind,this.matricesWeightsExtra,i,s),this.indices&&e.setIndices(this.indices,null),this}static _TransformVector3Coordinates(e,i,s=0,r=e.length){let a=C.Vector3[0],o=C.Vector3[1];for(let h=s;h<s+r;h+=3)v.FromArrayToRef(e,h,a),v.TransformCoordinatesToRef(a,i,o),e[h]=o.x,e[h+1]=o.y,e[h+2]=o.z}static _TransformVector3Normals(e,i,s=0,r=e.length){let a=C.Vector3[0],o=C.Vector3[1];for(let h=s;h<s+r;h+=3)v.FromArrayToRef(e,h,a),v.TransformNormalToRef(a,i,o),e[h]=o.x,e[h+1]=o.y,e[h+2]=o.z}static _TransformVector4Normals(e,i,s=0,r=e.length){let a=C.Vector4[0],o=C.Vector4[1];for(let h=s;h<s+r;h+=4)it.FromArrayToRef(e,h,a),it.TransformNormalToRef(a,i,o),e[h]=o.x,e[h+1]=o.y,e[h+2]=o.z,e[h+3]=o.w}static _FlipFaces(e,i=0,s=e.length){for(let r=i;r<i+s;r+=3){let a=e[r+1];e[r+1]=e[r+2],e[r+2]=a}}transform(e){let i=e.determinant()<0;return this.positions&&n._TransformVector3Coordinates(this.positions,e),this.normals&&n._TransformVector3Normals(this.normals,e),this.tangents&&n._TransformVector4Normals(this.tangents,e),i&&this.indices&&n._FlipFaces(this.indices),this}merge(e,i=!1,s=!1){let r=Array.isArray(e)?e.map(a=>[a,void 0]):[[e,void 0]];return Zr(this._mergeCoroutine(void 0,r,i,!1,s))}*_mergeCoroutine(e,i,s=!1,r,a){var o,h,l,c;this._validate();let d=i.map(_=>_[0]);for(let _ of d)if(_._validate(),!this.normals!=!_.normals||!this.tangents!=!_.tangents||!this.uvs!=!_.uvs||!this.uvs2!=!_.uvs2||!this.uvs3!=!_.uvs3||!this.uvs4!=!_.uvs4||!this.uvs5!=!_.uvs5||!this.uvs6!=!_.uvs6||!this.colors!=!_.colors||!this.matricesIndices!=!_.matricesIndices||!this.matricesWeights!=!_.matricesWeights||!this.matricesIndicesExtra!=!_.matricesIndicesExtra||!this.matricesWeightsExtra!=!_.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes");let u=d.reduce((_,g)=>{var p,E;return _+((E=(p=g.indices)===null||p===void 0?void 0:p.length)!==null&&E!==void 0?E:0)},(h=(o=this.indices)===null||o===void 0?void 0:o.length)!==null&&h!==void 0?h:0),f=a||d.some(_=>_.indices===this.indices)?(l=this.indices)===null||l===void 0?void 0:l.slice():this.indices;if(u>0){let _=(c=f?.length)!==null&&c!==void 0?c:0;if(f||(f=new Array(u)),f.length!==u){if(Array.isArray(f))f.length=u;else{let p=s||f instanceof Uint32Array?new Uint32Array(u):new Uint16Array(u);p.set(f),f=p}e&&e.determinant()<0&&n._FlipFaces(f,0,_)}let g=this.positions?this.positions.length/3:0;for(let[p,E]of i)if(p.indices){for(let T=0;T<p.indices.length;T++)f[_+T]=p.indices[T]+g;E&&E.determinant()<0&&n._FlipFaces(f,_,p.indices.length),g+=p.positions.length/3,_+=p.indices.length,r&&(yield)}}return this.indices=f,this.positions=n._MergeElement(m.PositionKind,this.positions,e,i.map(_=>[_[0].positions,_[1]])),r&&(yield),this.normals=n._MergeElement(m.NormalKind,this.normals,e,i.map(_=>[_[0].normals,_[1]])),r&&(yield),this.tangents=n._MergeElement(m.TangentKind,this.tangents,e,i.map(_=>[_[0].tangents,_[1]])),r&&(yield),this.uvs=n._MergeElement(m.UVKind,this.uvs,e,i.map(_=>[_[0].uvs,_[1]])),r&&(yield),this.uvs2=n._MergeElement(m.UV2Kind,this.uvs2,e,i.map(_=>[_[0].uvs2,_[1]])),r&&(yield),this.uvs3=n._MergeElement(m.UV3Kind,this.uvs3,e,i.map(_=>[_[0].uvs3,_[1]])),r&&(yield),this.uvs4=n._MergeElement(m.UV4Kind,this.uvs4,e,i.map(_=>[_[0].uvs4,_[1]])),r&&(yield),this.uvs5=n._MergeElement(m.UV5Kind,this.uvs5,e,i.map(_=>[_[0].uvs5,_[1]])),r&&(yield),this.uvs6=n._MergeElement(m.UV6Kind,this.uvs6,e,i.map(_=>[_[0].uvs6,_[1]])),r&&(yield),this.colors=n._MergeElement(m.ColorKind,this.colors,e,i.map(_=>[_[0].colors,_[1]])),r&&(yield),this.matricesIndices=n._MergeElement(m.MatricesIndicesKind,this.matricesIndices,e,i.map(_=>[_[0].matricesIndices,_[1]])),r&&(yield),this.matricesWeights=n._MergeElement(m.MatricesWeightsKind,this.matricesWeights,e,i.map(_=>[_[0].matricesWeights,_[1]])),r&&(yield),this.matricesIndicesExtra=n._MergeElement(m.MatricesIndicesExtraKind,this.matricesIndicesExtra,e,i.map(_=>[_[0].matricesIndicesExtra,_[1]])),r&&(yield),this.matricesWeightsExtra=n._MergeElement(m.MatricesWeightsExtraKind,this.matricesWeightsExtra,e,i.map(_=>[_[0].matricesWeightsExtra,_[1]])),this}static _MergeElement(e,i,s,r){let a=r.filter(l=>l[0]!==null&&l[0]!==void 0);if(!i&&a.length==0)return i;if(!i)return this._MergeElement(e,a[0][0],a[0][1],a.slice(1));let o=a.reduce((l,c)=>l+c[0].length,i.length),h=e===m.PositionKind?n._TransformVector3Coordinates:e===m.NormalKind?n._TransformVector3Normals:e===m.TangentKind?n._TransformVector4Normals:()=>{};if(i instanceof Float32Array){let l=new Float32Array(o);l.set(i),s&&h(l,s,0,i.length);let c=i.length;for(let[d,u]of a)l.set(d,c),u&&h(l,u,c,d.length),c+=d.length;return l}else{let l=new Array(o);for(let d=0;d<i.length;d++)l[d]=i[d];s&&h(l,s,0,i.length);let c=i.length;for(let[d,u]of a){for(let f=0;f<d.length;f++)l[c+f]=d[f];u&&h(l,u,c,d.length),c+=d.length}return l}}_validate(){if(!this.positions)throw new Dt("Positions are required",qt.MeshInvalidPositionsError);let e=(r,a)=>{let o=m.DeduceStride(r);if(a.length%o!==0)throw new Error("The "+r+"s array count must be a multiple of "+o);return a.length/o},i=e(m.PositionKind,this.positions),s=(r,a)=>{let o=e(r,a);if(o!==i)throw new Error("The "+r+"s element count ("+o+") does not match the positions count ("+i+")")};this.normals&&s(m.NormalKind,this.normals),this.tangents&&s(m.TangentKind,this.tangents),this.uvs&&s(m.UVKind,this.uvs),this.uvs2&&s(m.UV2Kind,this.uvs2),this.uvs3&&s(m.UV3Kind,this.uvs3),this.uvs4&&s(m.UV4Kind,this.uvs4),this.uvs5&&s(m.UV5Kind,this.uvs5),this.uvs6&&s(m.UV6Kind,this.uvs6),this.colors&&s(m.ColorKind,this.colors),this.matricesIndices&&s(m.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&s(m.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&s(m.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&s(m.MatricesWeightsExtraKind,this.matricesWeightsExtra)}serialize(){let e={};return this.positions&&(e.positions=this.positions),this.normals&&(e.normals=this.normals),this.tangents&&(e.tangents=this.tangents),this.uvs&&(e.uvs=this.uvs),this.uvs2&&(e.uvs2=this.uvs2),this.uvs3&&(e.uvs3=this.uvs3),this.uvs4&&(e.uvs4=this.uvs4),this.uvs5&&(e.uvs5=this.uvs5),this.uvs6&&(e.uvs6=this.uvs6),this.colors&&(e.colors=this.colors),this.matricesIndices&&(e.matricesIndices=this.matricesIndices,e.matricesIndices._isExpanded=!0),this.matricesWeights&&(e.matricesWeights=this.matricesWeights),this.matricesIndicesExtra&&(e.matricesIndicesExtra=this.matricesIndicesExtra,e.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(e.matricesWeightsExtra=this.matricesWeightsExtra),e.indices=this.indices,e}static ExtractFromMesh(e,i,s){return n._ExtractFrom(e,i,s)}static ExtractFromGeometry(e,i,s){return n._ExtractFrom(e,i,s)}static _ExtractFrom(e,i,s){let r=new n;return e.isVerticesDataPresent(m.PositionKind)&&(r.positions=e.getVerticesData(m.PositionKind,i,s)),e.isVerticesDataPresent(m.NormalKind)&&(r.normals=e.getVerticesData(m.NormalKind,i,s)),e.isVerticesDataPresent(m.TangentKind)&&(r.tangents=e.getVerticesData(m.TangentKind,i,s)),e.isVerticesDataPresent(m.UVKind)&&(r.uvs=e.getVerticesData(m.UVKind,i,s)),e.isVerticesDataPresent(m.UV2Kind)&&(r.uvs2=e.getVerticesData(m.UV2Kind,i,s)),e.isVerticesDataPresent(m.UV3Kind)&&(r.uvs3=e.getVerticesData(m.UV3Kind,i,s)),e.isVerticesDataPresent(m.UV4Kind)&&(r.uvs4=e.getVerticesData(m.UV4Kind,i,s)),e.isVerticesDataPresent(m.UV5Kind)&&(r.uvs5=e.getVerticesData(m.UV5Kind,i,s)),e.isVerticesDataPresent(m.UV6Kind)&&(r.uvs6=e.getVerticesData(m.UV6Kind,i,s)),e.isVerticesDataPresent(m.ColorKind)&&(r.colors=e.getVerticesData(m.ColorKind,i,s)),e.isVerticesDataPresent(m.MatricesIndicesKind)&&(r.matricesIndices=e.getVerticesData(m.MatricesIndicesKind,i,s)),e.isVerticesDataPresent(m.MatricesWeightsKind)&&(r.matricesWeights=e.getVerticesData(m.MatricesWeightsKind,i,s)),e.isVerticesDataPresent(m.MatricesIndicesExtraKind)&&(r.matricesIndicesExtra=e.getVerticesData(m.MatricesIndicesExtraKind,i,s)),e.isVerticesDataPresent(m.MatricesWeightsExtraKind)&&(r.matricesWeightsExtra=e.getVerticesData(m.MatricesWeightsExtraKind,i,s)),r.indices=e.getIndices(i,s),r}static CreateRibbon(e){throw H("ribbonBuilder")}static CreateBox(e){throw H("boxBuilder")}static CreateTiledBox(e){throw H("tiledBoxBuilder")}static CreateTiledPlane(e){throw H("tiledPlaneBuilder")}static CreateSphere(e){throw H("sphereBuilder")}static CreateCylinder(e){throw H("cylinderBuilder")}static CreateTorus(e){throw H("torusBuilder")}static CreateLineSystem(e){throw H("linesBuilder")}static CreateDashedLines(e){throw H("linesBuilder")}static CreateGround(e){throw H("groundBuilder")}static CreateTiledGround(e){throw H("groundBuilder")}static CreateGroundFromHeightMap(e){throw H("groundBuilder")}static CreatePlane(e){throw H("planeBuilder")}static CreateDisc(e){throw H("discBuilder")}static CreatePolygon(e,i,s,r,a,o,h){throw H("polygonBuilder")}static CreateIcoSphere(e){throw H("icoSphereBuilder")}static CreatePolyhedron(e){throw H("polyhedronBuilder")}static CreateCapsule(e={orientation:v.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){throw H("capsuleBuilder")}static CreateTorusKnot(e){throw H("torusKnotBuilder")}static ComputeNormals(e,i,s,r){let a=0,o=0,h=0,l=0,c=0,d=0,u=0,f=0,_=0,g=0,p=0,E=0,T=0,R=0,y=0,M=0,b=0,x=0,F=0,I=0,N=!1,G=!1,Y=!1,q=!1,j=1,$=0,Te=null;r&&(N=!!r.facetNormals,G=!!r.facetPositions,Y=!!r.facetPartitioning,j=r.useRightHandedSystem===!0?-1:1,$=r.ratio||0,q=!!r.depthSort,Te=r.distanceTo,q&&Te===void 0&&(Te=v.Zero()));let Se=0,ye=0,Ie=0,We=0;for(Y&&r&&r.bbSize&&(Se=r.subDiv.X*$/r.bbSize.x,ye=r.subDiv.Y*$/r.bbSize.y,Ie=r.subDiv.Z*$/r.bbSize.z,We=r.subDiv.max*r.subDiv.max,r.facetPartitioning.length=0),a=0;a<e.length;a++)s[a]=0;let ze=i.length/3|0;for(a=0;a<ze;a++){if(E=i[a*3]*3,T=E+1,R=E+2,y=i[a*3+1]*3,M=y+1,b=y+2,x=i[a*3+2]*3,F=x+1,I=x+2,o=e[E]-e[y],h=e[T]-e[M],l=e[R]-e[b],c=e[x]-e[y],d=e[F]-e[M],u=e[I]-e[b],f=j*(h*u-l*d),_=j*(l*c-o*u),g=j*(o*d-h*c),p=Math.sqrt(f*f+_*_+g*g),p=p===0?1:p,f/=p,_/=p,g/=p,N&&r&&(r.facetNormals[a].x=f,r.facetNormals[a].y=_,r.facetNormals[a].z=g),G&&r&&(r.facetPositions[a].x=(e[E]+e[y]+e[x])/3,r.facetPositions[a].y=(e[T]+e[M]+e[F])/3,r.facetPositions[a].z=(e[R]+e[b]+e[I])/3),Y&&r){let nt=Math.floor((r.facetPositions[a].x-r.bInfo.minimum.x*$)*Se),Xi=Math.floor((r.facetPositions[a].y-r.bInfo.minimum.y*$)*ye),Hi=Math.floor((r.facetPositions[a].z-r.bInfo.minimum.z*$)*Ie),Ki=Math.floor((e[E]-r.bInfo.minimum.x*$)*Se),Yi=Math.floor((e[T]-r.bInfo.minimum.y*$)*ye),As=Math.floor((e[R]-r.bInfo.minimum.z*$)*Ie),Rs=Math.floor((e[y]-r.bInfo.minimum.x*$)*Se),ys=Math.floor((e[M]-r.bInfo.minimum.y*$)*ye),Cs=Math.floor((e[b]-r.bInfo.minimum.z*$)*Ie),Is=Math.floor((e[x]-r.bInfo.minimum.x*$)*Se),Ps=Math.floor((e[F]-r.bInfo.minimum.y*$)*ye),Ds=Math.floor((e[I]-r.bInfo.minimum.z*$)*Ie),Tt=Ki+r.subDiv.max*Yi+We*As,St=Rs+r.subDiv.max*ys+We*Cs,bt=Is+r.subDiv.max*Ps+We*Ds,xt=nt+r.subDiv.max*Xi+We*Hi;r.facetPartitioning[xt]=r.facetPartitioning[xt]?r.facetPartitioning[xt]:new Array,r.facetPartitioning[Tt]=r.facetPartitioning[Tt]?r.facetPartitioning[Tt]:new Array,r.facetPartitioning[St]=r.facetPartitioning[St]?r.facetPartitioning[St]:new Array,r.facetPartitioning[bt]=r.facetPartitioning[bt]?r.facetPartitioning[bt]:new Array,r.facetPartitioning[Tt].push(a),St!=Tt&&r.facetPartitioning[St].push(a),bt==St||bt==Tt||r.facetPartitioning[bt].push(a),xt==Tt||xt==St||xt==bt||r.facetPartitioning[xt].push(a)}if(q&&r&&r.facetPositions){let nt=r.depthSortedFacets[a];nt.ind=a*3,nt.sqDistance=v.DistanceSquared(r.facetPositions[a],Te)}s[E]+=f,s[T]+=_,s[R]+=g,s[y]+=f,s[M]+=_,s[b]+=g,s[x]+=f,s[F]+=_,s[I]+=g}for(a=0;a<s.length/3;a++)f=s[a*3],_=s[a*3+1],g=s[a*3+2],p=Math.sqrt(f*f+_*_+g*g),p=p===0?1:p,f/=p,_/=p,g/=p,s[a*3]=f,s[a*3+1]=_,s[a*3+2]=g}static _ComputeSides(e,i,s,r,a,o,h){let l=s.length,c=r.length,d,u;switch(e=e||n.DEFAULTSIDE,e){case n.FRONTSIDE:break;case n.BACKSIDE:for(d=0;d<l;d+=3){let f=s[d];s[d]=s[d+2],s[d+2]=f}for(u=0;u<c;u++)r[u]=-r[u];break;case n.DOUBLESIDE:{let f=i.length,_=f/3;for(let E=0;E<f;E++)i[f+E]=i[E];for(d=0;d<l;d+=3)s[d+l]=s[d+2]+_,s[d+1+l]=s[d+1]+_,s[d+2+l]=s[d]+_;for(u=0;u<c;u++)r[c+u]=-r[u];let g=a.length,p=0;for(p=0;p<g;p++)a[p+g]=a[p];for(o=o||new it(0,0,1,1),h=h||new it(0,0,1,1),p=0,d=0;d<g/2;d++)a[p]=o.x+(o.z-o.x)*a[p],a[p+1]=o.y+(o.w-o.y)*a[p+1],a[p+g]=h.x+(h.z-h.x)*a[p+g],a[p+g+1]=h.y+(h.w-h.y)*a[p+g+1],p+=2;break}}}static ImportVertexData(e,i){let s=new n,r=e.positions;r&&s.set(r,m.PositionKind);let a=e.normals;a&&s.set(a,m.NormalKind);let o=e.tangents;o&&s.set(o,m.TangentKind);let h=e.uvs;h&&s.set(h,m.UVKind);let l=e.uv2s;l&&s.set(l,m.UV2Kind);let c=e.uv3s;c&&s.set(c,m.UV3Kind);let d=e.uv4s;d&&s.set(d,m.UV4Kind);let u=e.uv5s;u&&s.set(u,m.UV5Kind);let f=e.uv6s;f&&s.set(f,m.UV6Kind);let _=e.colors;_&&s.set(ie.CheckColors4(_,r.length/3),m.ColorKind);let g=e.matricesIndices;g&&s.set(g,m.MatricesIndicesKind);let p=e.matricesWeights;p&&s.set(p,m.MatricesWeightsKind);let E=e.indices;E&&(s.indices=E),i.setAllVerticesData(s,e.updatable)}}return n.FRONTSIDE=0,n.BACKSIDE=1,n.DOUBLESIDE=2,n.DEFAULTSIDE=0,n})();S([Ht.filter((...[n])=>!Array.isArray(n))],pe,"_TransformVector3Coordinates",null);S([Ht.filter((...[n])=>!Array.isArray(n))],pe,"_TransformVector3Normals",null);S([Ht.filter((...[n])=>!Array.isArray(n))],pe,"_TransformVector4Normals",null);S([Ht.filter((...[n])=>!Array.isArray(n))],pe,"_FlipFaces",null);var Ni=class{constructor(t,e,i){this.bu=t,this.bv=e,this.distance=i,this.faceId=0,this.subMeshId=0}},Bi=class n{constructor(t,e,i){this.vectors=we.BuildArray(8,v.Zero),this.center=v.Zero(),this.centerWorld=v.Zero(),this.extendSize=v.Zero(),this.extendSizeWorld=v.Zero(),this.directions=we.BuildArray(3,v.Zero),this.vectorsWorld=we.BuildArray(8,v.Zero),this.minimumWorld=v.Zero(),this.maximumWorld=v.Zero(),this.minimum=v.Zero(),this.maximum=v.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(t,e,i)}reConstruct(t,e,i){let s=t.x,r=t.y,a=t.z,o=e.x,h=e.y,l=e.z,c=this.vectors;this.minimum.copyFromFloats(s,r,a),this.maximum.copyFromFloats(o,h,l),c[0].copyFromFloats(s,r,a),c[1].copyFromFloats(o,h,l),c[2].copyFromFloats(o,r,a),c[3].copyFromFloats(s,h,a),c[4].copyFromFloats(s,r,l),c[5].copyFromFloats(o,h,a),c[6].copyFromFloats(s,h,l),c[7].copyFromFloats(o,r,l),e.addToRef(t,this.center).scaleInPlace(.5),e.subtractToRef(t,this.extendSize).scaleInPlace(.5),this._worldMatrix=i||P.IdentityReadOnly,this._update(this._worldMatrix)}scale(t){let e=n._TmpVector3,i=this.maximum.subtractToRef(this.minimum,e[0]),s=i.length();i.normalizeFromLength(s);let r=s*t,a=i.scaleInPlace(r*.5),o=this.center.subtractToRef(a,e[1]),h=this.center.addToRef(a,e[2]);return this.reConstruct(o,h,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(t){let e=this.minimumWorld,i=this.maximumWorld,s=this.directions,r=this.vectorsWorld,a=this.vectors;if(t.isIdentity()){e.copyFrom(this.minimum),i.copyFrom(this.maximum);for(let o=0;o<8;++o)r[o].copyFrom(a[o]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{e.setAll(Number.MAX_VALUE),i.setAll(-Number.MAX_VALUE);for(let o=0;o<8;++o){let h=r[o];v.TransformCoordinatesToRef(a[o],t,h),e.minimizeInPlace(h),i.maximizeInPlace(h)}i.subtractToRef(e,this.extendSizeWorld).scaleInPlace(.5),i.addToRef(e,this.centerWorld).scaleInPlace(.5)}v.FromArrayToRef(t.m,0,s[0]),v.FromArrayToRef(t.m,4,s[1]),v.FromArrayToRef(t.m,8,s[2]),this._worldMatrix=t}isInFrustum(t){return n.IsInFrustum(this.vectorsWorld,t)}isCompletelyInFrustum(t){return n.IsCompletelyInFrustum(this.vectorsWorld,t)}intersectsPoint(t){let e=this.minimumWorld,i=this.maximumWorld,s=e.x,r=e.y,a=e.z,o=i.x,h=i.y,l=i.z,c=t.x,d=t.y,u=t.z,f=-_e;return!(o-c<f||f>c-s||h-d<f||f>d-r||l-u<f||f>u-a)}intersectsSphere(t){return n.IntersectsSphere(this.minimumWorld,this.maximumWorld,t.centerWorld,t.radiusWorld)}intersectsMinMax(t,e){let i=this.minimumWorld,s=this.maximumWorld,r=i.x,a=i.y,o=i.z,h=s.x,l=s.y,c=s.z,d=t.x,u=t.y,f=t.z,_=e.x,g=e.y,p=e.z;return!(h<d||r>_||l<u||a>g||c<f||o>p)}dispose(){var t,e;(t=this._drawWrapperFront)===null||t===void 0||t.dispose(),(e=this._drawWrapperBack)===null||e===void 0||e.dispose()}static Intersects(t,e){return t.intersectsMinMax(e.minimumWorld,e.maximumWorld)}static IntersectsSphere(t,e,i,s){let r=n._TmpVector3[0];return v.ClampToRef(i,t,e,r),v.DistanceSquared(i,r)<=s*s}static IsCompletelyInFrustum(t,e){for(let i=0;i<6;++i){let s=e[i];for(let r=0;r<8;++r)if(s.dotCoordinate(t[r])<0)return!1}return!0}static IsInFrustum(t,e){for(let i=0;i<6;++i){let s=!0,r=e[i];for(let a=0;a<8;++a)if(r.dotCoordinate(t[a])>=0){s=!1;break}if(s)return!1}return!0}};Bi._TmpVector3=we.BuildArray(3,v.Zero);var Ui=class n{constructor(t,e,i){this.center=v.Zero(),this.centerWorld=v.Zero(),this.minimum=v.Zero(),this.maximum=v.Zero(),this.reConstruct(t,e,i)}reConstruct(t,e,i){this.minimum.copyFrom(t),this.maximum.copyFrom(e);let s=v.Distance(t,e);e.addToRef(t,this.center).scaleInPlace(.5),this.radius=s*.5,this._update(i||P.IdentityReadOnly)}scale(t){let e=this.radius*t,i=n._TmpVector3,s=i[0].setAll(e),r=this.center.subtractToRef(s,i[1]),a=this.center.addToRef(s,i[2]);return this.reConstruct(r,a,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(t){if(t.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{v.TransformCoordinatesToRef(this.center,t,this.centerWorld);let e=n._TmpVector3[0];v.TransformNormalFromFloatsToRef(1,1,1,t,e),this.radiusWorld=Math.max(Math.abs(e.x),Math.abs(e.y),Math.abs(e.z))*this.radius}}isInFrustum(t){let e=this.centerWorld,i=this.radiusWorld;for(let s=0;s<6;s++)if(t[s].dotCoordinate(e)<=-i)return!1;return!0}isCenterInFrustum(t){let e=this.centerWorld;for(let i=0;i<6;i++)if(t[i].dotCoordinate(e)<0)return!1;return!0}intersectsPoint(t){let e=v.DistanceSquared(this.centerWorld,t);return!(this.radiusWorld*this.radiusWorld<e)}static Intersects(t,e){let i=v.DistanceSquared(t.centerWorld,e.centerWorld),s=t.radiusWorld+e.radiusWorld;return!(s*s<i)}static CreateFromCenterAndRadius(t,e,i){this._TmpVector3[0].copyFrom(t),this._TmpVector3[1].copyFromFloats(0,0,e),this._TmpVector3[2].copyFrom(t),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);let s=new n(this._TmpVector3[0],this._TmpVector3[2]);return i?s._worldMatrix=i:s._worldMatrix=P.Identity(),s}};Ui._TmpVector3=we.BuildArray(3,v.Zero);var Ls={min:0,max:0},Ns={min:0,max:0},un=(n,t,e)=>{let i=v.Dot(t.centerWorld,n),s=Math.abs(v.Dot(t.directions[0],n))*t.extendSize.x,r=Math.abs(v.Dot(t.directions[1],n))*t.extendSize.y,a=Math.abs(v.Dot(t.directions[2],n))*t.extendSize.z,o=s+r+a;e.min=i-o,e.max=i+o},He=(n,t,e)=>(un(n,t,Ls),un(n,e,Ns),!(Ls.min>Ns.max||Ns.min>Ls.max)),ht=class n{constructor(t,e,i){this._isLocked=!1,this.boundingBox=new Bi(t,e,i),this.boundingSphere=new Ui(t,e,i)}reConstruct(t,e,i){this.boundingBox.reConstruct(t,e,i),this.boundingSphere.reConstruct(t,e,i)}get minimum(){return this.boundingBox.minimum}get maximum(){return this.boundingBox.maximum}get isLocked(){return this._isLocked}set isLocked(t){this._isLocked=t}update(t){this._isLocked||(this.boundingBox._update(t),this.boundingSphere._update(t))}centerOn(t,e){let i=n._TmpVector3[0].copyFrom(t).subtractInPlace(e),s=n._TmpVector3[1].copyFrom(t).addInPlace(e);return this.boundingBox.reConstruct(i,s,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(i,s,this.boundingBox.getWorldMatrix()),this}encapsulate(t){let e=v.Minimize(this.minimum,t),i=v.Maximize(this.maximum,t);return this.reConstruct(e,i,this.boundingBox.getWorldMatrix()),this}encapsulateBoundingInfo(t){return this.encapsulate(t.boundingBox.centerWorld.subtract(t.boundingBox.extendSizeWorld)),this.encapsulate(t.boundingBox.centerWorld.add(t.boundingBox.extendSizeWorld)),this}scale(t){return this.boundingBox.scale(t),this.boundingSphere.scale(t),this}isInFrustum(t,e=0){return(e===2||e===3)&&this.boundingSphere.isCenterInFrustum(t)?!0:this.boundingSphere.isInFrustum(t)?e===1||e===3?!0:this.boundingBox.isInFrustum(t):!1}get diagonalLength(){let t=this.boundingBox;return t.maximumWorld.subtractToRef(t.minimumWorld,n._TmpVector3[0]).length()}isCompletelyInFrustum(t){return this.boundingBox.isCompletelyInFrustum(t)}_checkCollision(t){return t._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)}intersectsPoint(t){return!(!this.boundingSphere.centerWorld||!this.boundingSphere.intersectsPoint(t)||!this.boundingBox.intersectsPoint(t))}intersects(t,e){if(!Ui.Intersects(this.boundingSphere,t.boundingSphere)||!Bi.Intersects(this.boundingBox,t.boundingBox))return!1;if(!e)return!0;let i=this.boundingBox,s=t.boundingBox;return!(!He(i.directions[0],i,s)||!He(i.directions[1],i,s)||!He(i.directions[2],i,s)||!He(s.directions[0],i,s)||!He(s.directions[1],i,s)||!He(s.directions[2],i,s)||!He(v.Cross(i.directions[0],s.directions[0]),i,s)||!He(v.Cross(i.directions[0],s.directions[1]),i,s)||!He(v.Cross(i.directions[0],s.directions[2]),i,s)||!He(v.Cross(i.directions[1],s.directions[0]),i,s)||!He(v.Cross(i.directions[1],s.directions[1]),i,s)||!He(v.Cross(i.directions[1],s.directions[2]),i,s)||!He(v.Cross(i.directions[2],s.directions[0]),i,s)||!He(v.Cross(i.directions[2],s.directions[1]),i,s)||!He(v.Cross(i.directions[2],s.directions[2]),i,s))}};ht._TmpVector3=we.BuildArray(2,v.Zero);var gi=class{static extractMinAndMaxIndexed(t,e,i,s,r,a){for(let o=i;o<i+s;o++){let h=e[o]*3,l=t[h],c=t[h+1],d=t[h+2];r.minimizeInPlaceFromFloats(l,c,d),a.maximizeInPlaceFromFloats(l,c,d)}}static extractMinAndMax(t,e,i,s,r,a){for(let o=e,h=e*s;o<e+i;o++,h+=s){let l=t[h],c=t[h+1],d=t[h+2];r.minimizeInPlaceFromFloats(l,c,d),a.maximizeInPlaceFromFloats(l,c,d)}}};S([Ht.filter((...[n,t])=>!Array.isArray(n)&&!Array.isArray(t))],gi,"extractMinAndMaxIndexed",null);S([Ht.filter((...[n])=>!Array.isArray(n))],gi,"extractMinAndMax",null);function _a(n,t,e,i,s=null){let r=new v(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a=new v(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return gi.extractMinAndMaxIndexed(n,t,e,i,r,a),s&&(r.x-=r.x*s.x+s.y,r.y-=r.y*s.x+s.y,r.z-=r.z*s.x+s.y,a.x+=a.x*s.x+s.y,a.y+=a.y*s.x+s.y,a.z+=a.z*s.x+s.y),{minimum:r,maximum:a}}function Fn(n,t,e,i=null,s){let r=new v(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a=new v(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return s||(s=3),gi.extractMinAndMax(n,t,e,s,r,a),i&&(r.x-=r.x*i.x+i.y,r.y-=r.y*i.x+i.y,r.z-=r.z*i.x+i.y,a.x+=a.x*i.x+i.y,a.y+=a.y*i.x+i.y,a.z+=a.z*i.x+i.y),{minimum:r,maximum:a}}var gt=class n{constructor(t,e,i,s,r,a,o,h=!0,l=!0){this.materialIndex=t,this.verticesStart=e,this.verticesCount=i,this.indexStart=s,this.indexCount=r,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._wasDispatched=!1,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=a,this._renderingMesh=o||a,l&&a.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=a.subMeshes.length-1,h&&(this.refreshBoundingInfo(),a.computeWorldMatrix(!0))}get materialDefines(){var t;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:(t=this._getDrawWrapper())===null||t===void 0?void 0:t.defines}set materialDefines(t){var e;let i=(e=this._mainDrawWrapperOverride)!==null&&e!==void 0?e:this._getDrawWrapper(void 0,!0);i.defines=t}_getDrawWrapper(t,e=!1){t=t??this._engine.currentRenderPassId;let i=this._drawWrappers[t];return!i&&e&&(this._drawWrappers[t]=i=new Wt(this._mesh.getScene().getEngine())),i}_removeDrawWrapper(t,e=!0){var i;e&&((i=this._drawWrappers[t])===null||i===void 0||i.dispose()),this._drawWrappers[t]=void 0}get effect(){var t,e;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:(e=(t=this._getDrawWrapper())===null||t===void 0?void 0:t.effect)!==null&&e!==void 0?e:null}get _drawWrapper(){var t;return(t=this._mainDrawWrapperOverride)!==null&&t!==void 0?t:this._getDrawWrapper(void 0,!0)}get _drawWrapperOverride(){return this._mainDrawWrapperOverride}_setMainDrawWrapperOverride(t){this._mainDrawWrapperOverride=t}setEffect(t,e=null,i,s=!0){let r=this._drawWrapper;r.setEffect(t,e,s),i!==void 0&&(r.materialContext=i),t||(r.defines=null,r.materialContext=void 0)}resetDrawCache(t){if(this._drawWrappers)if(t!==void 0){this._removeDrawWrapper(t);return}else for(let e of this._drawWrappers)e?.dispose();this._drawWrappers=[]}static AddToMesh(t,e,i,s,r,a,o,h=!0){return new n(t,e,i,s,r,a,o,h)}get IsGlobal(){return this.verticesStart===0&&this.verticesCount===this._mesh.getTotalVertices()&&this.indexStart===0&&this.indexCount===this._mesh.getTotalIndices()}getBoundingInfo(){return this.IsGlobal?this._mesh.getBoundingInfo():this._boundingInfo}setBoundingInfo(t){return this._boundingInfo=t,this}getMesh(){return this._mesh}getRenderingMesh(){return this._renderingMesh}getReplacementMesh(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null}getEffectiveMesh(){return(this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null)||this._renderingMesh}getMaterial(t=!0){var e;let i=(e=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId))!==null&&e!==void 0?e:this._renderingMesh.material;if(i){if(this._isMultiMaterial(i)){let s=i.getSubMaterial(this.materialIndex);return this._currentMaterial!==s&&(this._currentMaterial=s,this.resetDrawCache()),s}}else return t?this._mesh.getScene().defaultMaterial:null;return i}_isMultiMaterial(t){return t.getSubMaterial!==void 0}refreshBoundingInfo(t=null){if(this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(t||(t=this._renderingMesh.getVerticesData(m.PositionKind)),!t)return this._boundingInfo=this._mesh.getBoundingInfo(),this;let e=this._renderingMesh.getIndices(),i;if(this.indexStart===0&&this.indexCount===e.length){let s=this._renderingMesh.getBoundingInfo();i={minimum:s.minimum.clone(),maximum:s.maximum.clone()}}else i=_a(t,e,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new ht(i.minimum,i.maximum),this}_checkCollision(t){return this.getBoundingInfo()._checkCollision(t)}updateBoundingInfo(t){let e=this.getBoundingInfo();return e||(this.refreshBoundingInfo(),e=this.getBoundingInfo()),e&&e.update(t),this}isInFrustum(t){let e=this.getBoundingInfo();return e?e.isInFrustum(t,this._mesh.cullingStrategy):!1}isCompletelyInFrustum(t){let e=this.getBoundingInfo();return e?e.isCompletelyInFrustum(t):!1}render(t){return this._renderingMesh.render(this,t,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this}_getLinesIndexBuffer(t,e){if(!this._linesIndexBuffer){let i=[];for(let s=this.indexStart;s<this.indexStart+this.indexCount;s+=3)i.push(t[s],t[s+1],t[s+1],t[s+2],t[s+2],t[s]);this._linesIndexBuffer=e.createIndexBuffer(i),this._linesIndexCount=i.length}return this._linesIndexBuffer}canIntersects(t){let e=this.getBoundingInfo();return e?t.intersectsBox(e.boundingBox):!1}intersects(t,e,i,s,r){let a=this.getMaterial();if(!a)return null;let o=3,h=!1;switch(a.fillMode){case 3:case 5:case 6:case 8:return null;case 7:o=1,h=!0;break}return a.fillMode===4?i.length?this._intersectLines(t,e,i,this._mesh.intersectionThreshold,s):this._intersectUnIndexedLines(t,e,i,this._mesh.intersectionThreshold,s):!i.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(t,e,i,s,r):this._intersectTriangles(t,e,i,o,h,s,r)}_intersectLines(t,e,i,s,r){let a=null;for(let o=this.indexStart;o<this.indexStart+this.indexCount;o+=2){let h=e[i[o]],l=e[i[o+1]],c=t.intersectionSegment(h,l,s);if(!(c<0)&&(r||!a||c<a.distance)&&(a=new Ni(null,null,c),a.faceId=o/2,r))break}return a}_intersectUnIndexedLines(t,e,i,s,r){let a=null;for(let o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=2){let h=e[o],l=e[o+1],c=t.intersectionSegment(h,l,s);if(!(c<0)&&(r||!a||c<a.distance)&&(a=new Ni(null,null,c),a.faceId=o/2,r))break}return a}_intersectTriangles(t,e,i,s,r,a,o){let h=null,l=-1;for(let c=this.indexStart;c<this.indexStart+this.indexCount-(3-s);c+=s){l++;let d=i[c],u=i[c+1],f=i[c+2];if(r&&f===4294967295){c+=2;continue}let _=e[d],g=e[u],p=e[f];if(!_||!g||!p||o&&!o(_,g,p,t,d,u,f))continue;let E=t.intersectsTriangle(_,g,p);if(E){if(E.distance<0)continue;if((a||!h||E.distance<h.distance)&&(h=E,h.faceId=l,a))break}}return h}_intersectUnIndexedTriangles(t,e,i,s,r){let a=null;for(let o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=3){let h=e[o],l=e[o+1],c=e[o+2];if(r&&!r(h,l,c,t,-1,-1,-1))continue;let d=t.intersectsTriangle(h,l,c);if(d){if(d.distance<0)continue;if((s||!a||d.distance<a.distance)&&(a=d,a.faceId=o/3,s))break}}return a}_rebuild(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)}clone(t,e){let i=new n(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,t,e,!1);if(!this.IsGlobal){let s=this.getBoundingInfo();if(!s)return i;i._boundingInfo=new ht(s.minimum,s.maximum)}return i}dispose(){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);let t=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(t,1),this.resetDrawCache()}getClassName(){return"SubMesh"}static CreateFromIndices(t,e,i,s,r,a=!0){let o=Number.MAX_VALUE,h=-Number.MAX_VALUE,l=(r||s).getIndices();for(let c=e;c<e+i;c++){let d=l[c];d<o&&(o=d),d>h&&(h=d)}return new n(t,o,h-o+1,e,i,s,r,a)}},ft=(()=>{class n{static get ForceFullSceneLoadingForIncremental(){return n._ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){n._ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return n._ShowLoadingScreen}static set ShowLoadingScreen(e){n._ShowLoadingScreen=e}static get loggingLevel(){return n._LoggingLevel}static set loggingLevel(e){n._LoggingLevel=e}static get CleanBoneMatrixWeights(){return n._CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){n._CleanBoneMatrixWeights=e}}return n._ForceFullSceneLoadingForIncremental=!1,n._ShowLoadingScreen=!0,n._CleanBoneMatrixWeights=!1,n._LoggingLevel=0,n})(),tt=(()=>{class n{}return n.UseOpenGLOrientationForUV=!1,n})(),_t=class n{constructor(t,e,i,s=!1,r=null){this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=e||Q.LastCreatedScene,this._scene&&(this.id=t,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=s,i?this.setAllVerticesData(i,s):this._totalVertices=0,this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),r&&(this.applyToMesh(r),r.computeWorldMatrix(!0)))}get boundingBias(){return this._boundingBias}set boundingBias(t){this._boundingBias?this._boundingBias.copyFrom(t):this._boundingBias=t.clone(),this._updateBoundingInfo(!0,null)}static CreateGeometryForMesh(t){let e=new n(n.RandomId(),t.getScene());return e.applyToMesh(t),e}get meshes(){return this._meshes}get extend(){return this._extend}getScene(){return this._scene}getEngine(){return this._engine}isReady(){return this.delayLoadState===1||this.delayLoadState===0}get doNotSerialize(){for(let t=0;t<this._meshes.length;t++)if(!this._meshes[t].doNotSerialize)return!1;return!0}_rebuild(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable));for(let t in this._vertexBuffers)this._vertexBuffers[t]._rebuild()}setAllVerticesData(t,e){t.applyToGeometry(this,e),this._notifyUpdate()}setVerticesData(t,e,i=!1,s){i&&Array.isArray(e)&&(e=new Float32Array(e));let r=new m(this._engine,e,t,i,this._meshes.length===0,s);this.setVerticesBuffer(r)}removeVerticesData(t){this._vertexBuffers[t]&&(this._vertexBuffers[t].dispose(),delete this._vertexBuffers[t]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()}setVerticesBuffer(t,e=null,i=!0){let s=t.getKind();this._vertexBuffers[s]&&i&&this._vertexBuffers[s].dispose(),t._buffer&&t._buffer._increaseReferences(),this._vertexBuffers[s]=t;let r=this._meshes,a=r.length;if(s===m.PositionKind){let o=t.getData();e!=null?this._totalVertices=e:o!=null&&(this._totalVertices=o.length/(t.type===m.BYTE?t.byteStride:t.byteStride/4)),this._updateExtend(o),this._resetPointsArrayCache();for(let h=0;h<a;h++){let l=r[h];l.buildBoundingInfo(this._extend.minimum,this._extend.maximum),l._createGlobalSubMesh(l.isUnIndexed),l.computeWorldMatrix(!0),l.synchronizeInstances()}}this._notifyUpdate(s)}updateVerticesDataDirectly(t,e,i,s=!1){let r=this.getVertexBuffer(t);r&&(r.updateDirectly(e,i,s),this._notifyUpdate(t))}updateVerticesData(t,e,i=!1){let s=this.getVertexBuffer(t);s&&(s.update(e),t===m.PositionKind&&this._updateBoundingInfo(i,e),this._notifyUpdate(t))}_updateBoundingInfo(t,e){if(t&&this._updateExtend(e),this._resetPointsArrayCache(),t){let i=this._meshes;for(let s of i){s.hasBoundingInfo?s.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):s.buildBoundingInfo(this._extend.minimum,this._extend.maximum);let r=s.subMeshes;for(let a of r)a.refreshBoundingInfo()}}}_bind(t,e,i,s){if(!t)return;e===void 0&&(e=this._indexBuffer);let r=this.getVertexBuffers();if(!r)return;if(e!=this._indexBuffer||!this._vertexArrayObjects&&!s){this._engine.bindBuffers(r,e,t,i);return}let a=s||this._vertexArrayObjects;a[t.key]||(a[t.key]=this._engine.recordVertexArrayObject(r,e,t,i)),this._engine.bindVertexArrayObject(a[t.key],e)}getTotalVertices(){return this.isReady()?this._totalVertices:0}getVerticesData(t,e,i){let s=this.getVertexBuffer(t);return s?s.getFloatData(this._totalVertices,i||e&&this._meshes.length!==1):null}isVertexBufferUpdatable(t){let e=this._vertexBuffers[t];return e?e.isUpdatable():!1}getVertexBuffer(t){return this.isReady()?this._vertexBuffers[t]:null}getVertexBuffers(){return this.isReady()?this._vertexBuffers:null}isVerticesDataPresent(t){return this._vertexBuffers?this._vertexBuffers[t]!==void 0:this._delayInfo?this._delayInfo.indexOf(t)!==-1:!1}getVerticesDataKinds(){let t=[],e;if(!this._vertexBuffers&&this._delayInfo)for(e in this._delayInfo)t.push(e);else for(e in this._vertexBuffers)t.push(e);return t}updateIndices(t,e,i=!1){if(this._indexBuffer)if(!this._indexBufferIsUpdatable)this.setIndices(t,null,!0);else{let s=t.length!==this._indices.length;if(i||(this._indices=t.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,t,e),s)for(let r of this._meshes)r._createGlobalSubMesh(!0)}}setIndices(t,e=null,i=!1){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=t,this._indexBufferIsUpdatable=i,this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,i)),e!=null&&(this._totalVertices=e);for(let s of this._meshes)s._createGlobalSubMesh(!0),s.synchronizeInstances();this._notifyUpdate()}getTotalIndices(){return this.isReady()?this._indices.length:0}getIndices(t,e){if(!this.isReady())return null;let i=this._indices;return!e&&(!t||this._meshes.length===1)?i:i.slice()}getIndexBuffer(){return this.isReady()?this._indexBuffer:null}_releaseVertexArrayObject(t=null){!t||!this._vertexArrayObjects||this._vertexArrayObjects[t.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[t.key]),delete this._vertexArrayObjects[t.key])}releaseForMesh(t,e){let i=this._meshes,s=i.indexOf(t);s!==-1&&(i.splice(s,1),this._vertexArrayObjects&&t._invalidateInstanceVertexArrayObject(),t._geometry=null,i.length===0&&e&&this.dispose())}applyToMesh(t){if(t._geometry===this)return;let e=t._geometry;e&&e.releaseForMesh(t),this._vertexArrayObjects&&t._invalidateInstanceVertexArrayObject();let i=this._meshes;t._geometry=this,t._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),i.push(t),this.isReady()?this._applyToMesh(t):this._boundingInfo&&t.setBoundingInfo(this._boundingInfo)}_updateExtend(t=null){if(this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!t&&(t=this.getVerticesData(m.PositionKind),!t))return;this._extend=Fn(t,0,this._totalVertices,this.boundingBias,3)}}_applyToMesh(t){let e=this._meshes.length;for(let i in this._vertexBuffers)e===1&&this._vertexBuffers[i].create(),i===m.PositionKind&&(this._extend||this._updateExtend(),t.buildBoundingInfo(this._extend.minimum,this._extend.maximum),t._createGlobalSubMesh(t.isUnIndexed),t._updateBoundingInfo());e===1&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable)),t._syncGeometryWithMorphTargetManager(),t.synchronizeInstances()}_notifyUpdate(t){this.onGeometryUpdated&&this.onGeometryUpdated(this,t),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(let e of this._meshes)e._markSubMeshesAsAttributesDirty()}load(t,e){if(this.delayLoadState!==2){if(this.isReady()){e&&e();return}this.delayLoadState=2,this._queueLoad(t,e)}}_queueLoad(t,e){this.delayLoadingFile&&(t.addPendingData(this),t._loadFile(this.delayLoadingFile,i=>{if(!this._delayLoadingFunction)return;this._delayLoadingFunction(JSON.parse(i),this),this.delayLoadState=1,this._delayInfo=[],t.removePendingData(this);let s=this._meshes,r=s.length;for(let a=0;a<r;a++)this._applyToMesh(s[a]);e&&e()},void 0,!0))}toLeftHanded(){let t=this.getIndices(!1);if(t!=null&&t.length>0){for(let s=0;s<t.length;s+=3){let r=t[s+0];t[s+0]=t[s+2],t[s+2]=r}this.setIndices(t)}let e=this.getVerticesData(m.PositionKind,!1);if(e!=null&&e.length>0){for(let s=0;s<e.length;s+=3)e[s+2]=-e[s+2];this.setVerticesData(m.PositionKind,e,!1)}let i=this.getVerticesData(m.NormalKind,!1);if(i!=null&&i.length>0){for(let s=0;s<i.length;s+=3)i[s+2]=-i[s+2];this.setVerticesData(m.NormalKind,i,!1)}}_resetPointsArrayCache(){this._positions=null}_generatePointsArray(){if(this._positions)return!0;let t=this.getVerticesData(m.PositionKind);if(!t||t.length===0)return!1;for(let e=this._positionsCache.length*3,i=this._positionsCache.length;e<t.length;e+=3,++i)this._positionsCache[i]=v.FromArray(t,e);for(let e=0,i=0;e<t.length;e+=3,++i)this._positionsCache[i].set(t[0+e],t[1+e],t[2+e]);return this._positionsCache.length=t.length/3,this._positions=this._positionsCache,!0}isDisposed(){return this._isDisposed}_disposeVertexArrayObjects(){if(this._vertexArrayObjects){for(let i in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[i]);this._vertexArrayObjects={};let t=this._meshes,e=t.length;for(let i=0;i<e;i++)t[i]._invalidateInstanceVertexArrayObject()}}dispose(){let t=this._meshes,e=t.length,i;for(i=0;i<e;i++)this.releaseForMesh(t[i]);this._meshes.length=0,this._disposeVertexArrayObjects();for(let s in this._vertexBuffers)this._vertexBuffers[s].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){let s=this._parentContainer.geometries.indexOf(this);s>-1&&this._parentContainer.geometries.splice(s,1),this._parentContainer=null}this._isDisposed=!0}copy(t){let e=new pe;e.indices=[];let i=this.getIndices();if(i)for(let h=0;h<i.length;h++)e.indices.push(i[h]);let s=!1,r=!1,a;for(a in this._vertexBuffers){let h=this.getVerticesData(a);if(h&&(h instanceof Float32Array?e.set(new Float32Array(h),a):e.set(h.slice(0),a),!r)){let l=this.getVertexBuffer(a);l&&(s=l.isUpdatable(),r=!s)}}let o=new n(t,this._scene,e,s);o.delayLoadState=this.delayLoadState,o.delayLoadingFile=this.delayLoadingFile,o._delayLoadingFunction=this._delayLoadingFunction;for(a in this._delayInfo)o._delayInfo=o._delayInfo||[],o._delayInfo.push(a);return o._boundingInfo=new ht(this._extend.minimum,this._extend.maximum),o}serialize(){let t={};return t.id=this.id,t.uniqueId=this.uniqueId,t.updatable=this._updatable,he&&he.HasTags(this)&&(t.tags=he.GetTags(this)),t}_toNumberArray(t){return Array.isArray(t)?t:Array.prototype.slice.call(t)}clearCachedData(){this._indices=[],this._resetPointsArrayCache();for(let t in this._vertexBuffers)Object.prototype.hasOwnProperty.call(this._vertexBuffers,t)&&(this._vertexBuffers[t]._buffer._data=null)}serializeVerticeData(){let t=this.serialize();return this.isVerticesDataPresent(m.PositionKind)&&(t.positions=this._toNumberArray(this.getVerticesData(m.PositionKind)),this.isVertexBufferUpdatable(m.PositionKind)&&(t.positions._updatable=!0)),this.isVerticesDataPresent(m.NormalKind)&&(t.normals=this._toNumberArray(this.getVerticesData(m.NormalKind)),this.isVertexBufferUpdatable(m.NormalKind)&&(t.normals._updatable=!0)),this.isVerticesDataPresent(m.TangentKind)&&(t.tangents=this._toNumberArray(this.getVerticesData(m.TangentKind)),this.isVertexBufferUpdatable(m.TangentKind)&&(t.tangents._updatable=!0)),this.isVerticesDataPresent(m.UVKind)&&(t.uvs=this._toNumberArray(this.getVerticesData(m.UVKind)),this.isVertexBufferUpdatable(m.UVKind)&&(t.uvs._updatable=!0)),this.isVerticesDataPresent(m.UV2Kind)&&(t.uv2s=this._toNumberArray(this.getVerticesData(m.UV2Kind)),this.isVertexBufferUpdatable(m.UV2Kind)&&(t.uv2s._updatable=!0)),this.isVerticesDataPresent(m.UV3Kind)&&(t.uv3s=this._toNumberArray(this.getVerticesData(m.UV3Kind)),this.isVertexBufferUpdatable(m.UV3Kind)&&(t.uv3s._updatable=!0)),this.isVerticesDataPresent(m.UV4Kind)&&(t.uv4s=this._toNumberArray(this.getVerticesData(m.UV4Kind)),this.isVertexBufferUpdatable(m.UV4Kind)&&(t.uv4s._updatable=!0)),this.isVerticesDataPresent(m.UV5Kind)&&(t.uv5s=this._toNumberArray(this.getVerticesData(m.UV5Kind)),this.isVertexBufferUpdatable(m.UV5Kind)&&(t.uv5s._updatable=!0)),this.isVerticesDataPresent(m.UV6Kind)&&(t.uv6s=this._toNumberArray(this.getVerticesData(m.UV6Kind)),this.isVertexBufferUpdatable(m.UV6Kind)&&(t.uv6s._updatable=!0)),this.isVerticesDataPresent(m.ColorKind)&&(t.colors=this._toNumberArray(this.getVerticesData(m.ColorKind)),this.isVertexBufferUpdatable(m.ColorKind)&&(t.colors._updatable=!0)),this.isVerticesDataPresent(m.MatricesIndicesKind)&&(t.matricesIndices=this._toNumberArray(this.getVerticesData(m.MatricesIndicesKind)),t.matricesIndices._isExpanded=!0,this.isVertexBufferUpdatable(m.MatricesIndicesKind)&&(t.matricesIndices._updatable=!0)),this.isVerticesDataPresent(m.MatricesWeightsKind)&&(t.matricesWeights=this._toNumberArray(this.getVerticesData(m.MatricesWeightsKind)),this.isVertexBufferUpdatable(m.MatricesWeightsKind)&&(t.matricesWeights._updatable=!0)),t.indices=this._toNumberArray(this.getIndices()),t}static ExtractFromMesh(t,e){let i=t._geometry;return i?i.copy(e):null}static RandomId(){return Z.RandomId()}static _GetGeometryByLoadedUniqueId(t,e){for(let i=0;i<e.geometries.length;i++)if(e.geometries[i]._loadedUniqueId===t)return e.geometries[i];return null}static _ImportGeometry(t,e){let i=e.getScene(),s=t.geometryUniqueId,r=t.geometryId;if(s||r){let a=s?this._GetGeometryByLoadedUniqueId(s,i):i.getGeometryById(r);a&&a.applyToMesh(e)}else if(t instanceof ArrayBuffer){let a=e._binaryInfo;if(a.positionsAttrDesc&&a.positionsAttrDesc.count>0){let o=new Float32Array(t,a.positionsAttrDesc.offset,a.positionsAttrDesc.count);e.setVerticesData(m.PositionKind,o,!1)}if(a.normalsAttrDesc&&a.normalsAttrDesc.count>0){let o=new Float32Array(t,a.normalsAttrDesc.offset,a.normalsAttrDesc.count);e.setVerticesData(m.NormalKind,o,!1)}if(a.tangetsAttrDesc&&a.tangetsAttrDesc.count>0){let o=new Float32Array(t,a.tangetsAttrDesc.offset,a.tangetsAttrDesc.count);e.setVerticesData(m.TangentKind,o,!1)}if(a.uvsAttrDesc&&a.uvsAttrDesc.count>0){let o=new Float32Array(t,a.uvsAttrDesc.offset,a.uvsAttrDesc.count);if(tt.UseOpenGLOrientationForUV)for(let h=1;h<o.length;h+=2)o[h]=1-o[h];e.setVerticesData(m.UVKind,o,!1)}if(a.uvs2AttrDesc&&a.uvs2AttrDesc.count>0){let o=new Float32Array(t,a.uvs2AttrDesc.offset,a.uvs2AttrDesc.count);if(tt.UseOpenGLOrientationForUV)for(let h=1;h<o.length;h+=2)o[h]=1-o[h];e.setVerticesData(m.UV2Kind,o,!1)}if(a.uvs3AttrDesc&&a.uvs3AttrDesc.count>0){let o=new Float32Array(t,a.uvs3AttrDesc.offset,a.uvs3AttrDesc.count);if(tt.UseOpenGLOrientationForUV)for(let h=1;h<o.length;h+=2)o[h]=1-o[h];e.setVerticesData(m.UV3Kind,o,!1)}if(a.uvs4AttrDesc&&a.uvs4AttrDesc.count>0){let o=new Float32Array(t,a.uvs4AttrDesc.offset,a.uvs4AttrDesc.count);if(tt.UseOpenGLOrientationForUV)for(let h=1;h<o.length;h+=2)o[h]=1-o[h];e.setVerticesData(m.UV4Kind,o,!1)}if(a.uvs5AttrDesc&&a.uvs5AttrDesc.count>0){let o=new Float32Array(t,a.uvs5AttrDesc.offset,a.uvs5AttrDesc.count);if(tt.UseOpenGLOrientationForUV)for(let h=1;h<o.length;h+=2)o[h]=1-o[h];e.setVerticesData(m.UV5Kind,o,!1)}if(a.uvs6AttrDesc&&a.uvs6AttrDesc.count>0){let o=new Float32Array(t,a.uvs6AttrDesc.offset,a.uvs6AttrDesc.count);if(tt.UseOpenGLOrientationForUV)for(let h=1;h<o.length;h+=2)o[h]=1-o[h];e.setVerticesData(m.UV6Kind,o,!1)}if(a.colorsAttrDesc&&a.colorsAttrDesc.count>0){let o=new Float32Array(t,a.colorsAttrDesc.offset,a.colorsAttrDesc.count);e.setVerticesData(m.ColorKind,o,!1,a.colorsAttrDesc.stride)}if(a.matricesIndicesAttrDesc&&a.matricesIndicesAttrDesc.count>0){let o=new Int32Array(t,a.matricesIndicesAttrDesc.offset,a.matricesIndicesAttrDesc.count),h=[];for(let l=0;l<o.length;l++){let c=o[l];h.push(c&255),h.push((c&65280)>>8),h.push((c&16711680)>>16),h.push(c>>24&255)}e.setVerticesData(m.MatricesIndicesKind,h,!1)}if(a.matricesIndicesExtraAttrDesc&&a.matricesIndicesExtraAttrDesc.count>0){let o=new Int32Array(t,a.matricesIndicesExtraAttrDesc.offset,a.matricesIndicesExtraAttrDesc.count),h=[];for(let l=0;l<o.length;l++){let c=o[l];h.push(c&255),h.push((c&65280)>>8),h.push((c&16711680)>>16),h.push(c>>24&255)}e.setVerticesData(m.MatricesIndicesExtraKind,h,!1)}if(a.matricesWeightsAttrDesc&&a.matricesWeightsAttrDesc.count>0){let o=new Float32Array(t,a.matricesWeightsAttrDesc.offset,a.matricesWeightsAttrDesc.count);e.setVerticesData(m.MatricesWeightsKind,o,!1)}if(a.indicesAttrDesc&&a.indicesAttrDesc.count>0){let o=new Int32Array(t,a.indicesAttrDesc.offset,a.indicesAttrDesc.count);e.setIndices(o,null)}if(a.subMeshesAttrDesc&&a.subMeshesAttrDesc.count>0){let o=new Int32Array(t,a.subMeshesAttrDesc.offset,a.subMeshesAttrDesc.count*5);e.subMeshes=[];for(let h=0;h<a.subMeshesAttrDesc.count;h++){let l=o[h*5+0],c=o[h*5+1],d=o[h*5+2],u=o[h*5+3],f=o[h*5+4];gt.AddToMesh(l,c,d,u,f,e)}}}else if(t.positions&&t.normals&&t.indices){if(e.setVerticesData(m.PositionKind,t.positions,t.positions._updatable),e.setVerticesData(m.NormalKind,t.normals,t.normals._updatable),t.tangents&&e.setVerticesData(m.TangentKind,t.tangents,t.tangents._updatable),t.uvs&&e.setVerticesData(m.UVKind,t.uvs,t.uvs._updatable),t.uvs2&&e.setVerticesData(m.UV2Kind,t.uvs2,t.uvs2._updatable),t.uvs3&&e.setVerticesData(m.UV3Kind,t.uvs3,t.uvs3._updatable),t.uvs4&&e.setVerticesData(m.UV4Kind,t.uvs4,t.uvs4._updatable),t.uvs5&&e.setVerticesData(m.UV5Kind,t.uvs5,t.uvs5._updatable),t.uvs6&&e.setVerticesData(m.UV6Kind,t.uvs6,t.uvs6._updatable),t.colors&&e.setVerticesData(m.ColorKind,ie.CheckColors4(t.colors,t.positions.length/3),t.colors._updatable),t.matricesIndices)if(t.matricesIndices._isExpanded)delete t.matricesIndices._isExpanded,e.setVerticesData(m.MatricesIndicesKind,t.matricesIndices,t.matricesIndices._updatable);else{let a=[];for(let o=0;o<t.matricesIndices.length;o++){let h=t.matricesIndices[o];a.push(h&255),a.push((h&65280)>>8),a.push((h&16711680)>>16),a.push(h>>24&255)}e.setVerticesData(m.MatricesIndicesKind,a,t.matricesIndices._updatable)}if(t.matricesIndicesExtra)if(t.matricesIndicesExtra._isExpanded)delete t.matricesIndices._isExpanded,e.setVerticesData(m.MatricesIndicesExtraKind,t.matricesIndicesExtra,t.matricesIndicesExtra._updatable);else{let a=[];for(let o=0;o<t.matricesIndicesExtra.length;o++){let h=t.matricesIndicesExtra[o];a.push(h&255),a.push((h&65280)>>8),a.push((h&16711680)>>16),a.push(h>>24&255)}e.setVerticesData(m.MatricesIndicesExtraKind,a,t.matricesIndicesExtra._updatable)}t.matricesWeights&&(n._CleanMatricesWeights(t,e),e.setVerticesData(m.MatricesWeightsKind,t.matricesWeights,t.matricesWeights._updatable)),t.matricesWeightsExtra&&e.setVerticesData(m.MatricesWeightsExtraKind,t.matricesWeightsExtra,t.matricesWeights._updatable),e.setIndices(t.indices,null)}if(t.subMeshes){e.subMeshes=[];for(let a=0;a<t.subMeshes.length;a++){let o=t.subMeshes[a];gt.AddToMesh(o.materialIndex,o.verticesStart,o.verticesCount,o.indexStart,o.indexCount,e)}}e._shouldGenerateFlatShading&&(e.convertToFlatShadedMesh(),e._shouldGenerateFlatShading=!1),e.computeWorldMatrix(!0),i.onMeshImportedObservable.notifyObservers(e)}static _CleanMatricesWeights(t,e){if(!ft.CleanBoneMatrixWeights)return;let i=0;if(t.skeletonId>-1){let c=e.getScene().getLastSkeletonById(t.skeletonId);if(!c)return;i=c.bones.length}else return;let s=e.getVerticesData(m.MatricesIndicesKind),r=e.getVerticesData(m.MatricesIndicesExtraKind),a=t.matricesWeights,o=t.matricesWeightsExtra,h=t.numBoneInfluencer,l=a.length;for(let c=0;c<l;c+=4){let d=0,u=-1;for(let f=0;f<4;f++){let _=a[c+f];d+=_,_<.001&&u<0&&(u=f)}if(o)for(let f=0;f<4;f++){let _=o[c+f];d+=_,_<.001&&u<0&&(u=f+4)}if((u<0||u>h-1)&&(u=h-1),d>.001){let f=1/d;for(let _=0;_<4;_++)a[c+_]*=f;if(o)for(let _=0;_<4;_++)o[c+_]*=f}else u>=4?(o[c+u-4]=1-d,r[c+u-4]=i):(a[c+u]=1-d,s[c+u]=i)}e.setVerticesData(m.MatricesIndicesKind,s),t.matricesWeightsExtra&&e.setVerticesData(m.MatricesIndicesExtraKind,r)}static Parse(t,e,i){let s=new n(t.id,e,void 0,t.updatable);return s._loadedUniqueId=t.uniqueId,he&&he.AddTagsTo(s,t.tags),t.delayLoadingFile?(s.delayLoadState=4,s.delayLoadingFile=i+t.delayLoadingFile,s._boundingInfo=new ht(v.FromArray(t.boundingBoxMinimum),v.FromArray(t.boundingBoxMaximum)),s._delayInfo=[],t.hasUVs&&s._delayInfo.push(m.UVKind),t.hasUVs2&&s._delayInfo.push(m.UV2Kind),t.hasUVs3&&s._delayInfo.push(m.UV3Kind),t.hasUVs4&&s._delayInfo.push(m.UV4Kind),t.hasUVs5&&s._delayInfo.push(m.UV5Kind),t.hasUVs6&&s._delayInfo.push(m.UV6Kind),t.hasColors&&s._delayInfo.push(m.ColorKind),t.hasMatricesIndices&&s._delayInfo.push(m.MatricesIndicesKind),t.hasMatricesWeights&&s._delayInfo.push(m.MatricesWeightsKind),s._delayLoadingFunction=pe.ImportVertexData):pe.ImportVertexData(t,s),e.pushGeometry(s,!0),s}},yt;(function(n){n[n.LOCAL=0]="LOCAL",n[n.WORLD=1]="WORLD",n[n.BONE=2]="BONE"})(yt||(yt={}));var wt=class{};wt.X=new v(1,0,0);wt.Y=new v(0,1,0);wt.Z=new v(0,0,1);var fn;(function(n){n[n.X=0]="X",n[n.Y=1]="Y",n[n.Z=2]="Z"})(fn||(fn={}));var oe=class n extends Ge{constructor(t,e=null,i=!0){super(t,e),this._forward=new v(0,0,1),this._up=new v(0,1,0),this._right=new v(1,0,0),this._position=v.Zero(),this._rotation=v.Zero(),this._rotationQuaternion=null,this._scaling=v.One(),this._transformToBoneReferal=null,this._isAbsoluteSynced=!1,this._billboardMode=n.BILLBOARDMODE_NONE,this._preserveParentRotationForBillboard=!1,this.scalingDeterminant=1,this._infiniteDistance=!1,this.ignoreNonUniformScaling=!1,this.reIntegrateRotationIntoRotationQuaternion=!1,this._poseMatrix=null,this._localMatrix=P.Zero(),this._usePivotMatrix=!1,this._absolutePosition=v.Zero(),this._absoluteScaling=v.Zero(),this._absoluteRotationQuaternion=se.Identity(),this._pivotMatrix=P.Identity(),this._postMultiplyPivotMatrix=!1,this._isWorldMatrixFrozen=!1,this._indexInSceneTransformNodesArray=-1,this.onAfterWorldMatrixUpdateObservable=new D,this._nonUniformScaling=!1,i&&this.getScene().addTransformNode(this)}get billboardMode(){return this._billboardMode}set billboardMode(t){this._billboardMode!==t&&(this._billboardMode=t)}get preserveParentRotationForBillboard(){return this._preserveParentRotationForBillboard}set preserveParentRotationForBillboard(t){t!==this._preserveParentRotationForBillboard&&(this._preserveParentRotationForBillboard=t)}get infiniteDistance(){return this._infiniteDistance}set infiniteDistance(t){this._infiniteDistance!==t&&(this._infiniteDistance=t)}getClassName(){return"TransformNode"}get position(){return this._position}set position(t){this._position=t,this._isDirty=!0}isUsingPivotMatrix(){return this._usePivotMatrix}get rotation(){return this._rotation}set rotation(t){this._rotation=t,this._rotationQuaternion=null,this._isDirty=!0}get scaling(){return this._scaling}set scaling(t){this._scaling=t,this._isDirty=!0}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(t){this._rotationQuaternion=t,t&&this._rotation.setAll(0),this._isDirty=!0}get forward(){return v.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()}get up(){return v.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()}get right(){return v.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()}updatePoseMatrix(t){return this._poseMatrix?(this._poseMatrix.copyFrom(t),this):(this._poseMatrix=t.clone(),this)}getPoseMatrix(){return this._poseMatrix||(this._poseMatrix=P.Identity()),this._poseMatrix}_isSynchronized(){let t=this._cache;return!(this._billboardMode!==t.billboardMode||this._billboardMode!==n.BILLBOARDMODE_NONE||t.pivotMatrixUpdated||this._infiniteDistance||this._position._isDirty||this._scaling._isDirty||this._rotationQuaternion&&this._rotationQuaternion._isDirty||this._rotation._isDirty)}_initCache(){super._initCache();let t=this._cache;t.localMatrixUpdated=!1,t.billboardMode=-1,t.infiniteDistance=!1}get absolutePosition(){return this.getAbsolutePosition()}get absoluteScaling(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling}get absoluteRotationQuaternion(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion}setPreTransformMatrix(t){return this.setPivotMatrix(t,!1)}setPivotMatrix(t,e=!0){return this._pivotMatrix.copyFrom(t),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=e,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=P.Invert(this._pivotMatrix)),this}getPivotMatrix(){return this._pivotMatrix}instantiateHierarchy(t=null,e,i){let s=this.clone("Clone of "+(this.name||this.id),t||this.parent,!0);s&&i&&i(this,s);for(let r of this.getChildTransformNodes(!0))r.instantiateHierarchy(s,e,i);return s}freezeWorldMatrix(t=null,e=!1){return t?e?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||se.Identity(),t.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=t,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this}unfreezeWorldMatrix(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this}get isWorldMatrixFrozen(){return this._isWorldMatrixFrozen}getAbsolutePosition(){return this.computeWorldMatrix(),this._absolutePosition}setAbsolutePosition(t){if(!t)return this;let e,i,s;if(t.x===void 0){if(arguments.length<3)return this;e=arguments[0],i=arguments[1],s=arguments[2]}else e=t.x,i=t.y,s=t.z;if(this.parent){let r=C.Matrix[0];this.parent.getWorldMatrix().invertToRef(r),v.TransformCoordinatesFromFloatsToRef(e,i,s,r,this.position)}else this.position.x=e,this.position.y=i,this.position.z=s;return this._absolutePosition.copyFrom(t),this}setPositionWithLocalVector(t){return this.computeWorldMatrix(),this.position=v.TransformNormal(t,this._localMatrix),this}getPositionExpressedInLocalSpace(){this.computeWorldMatrix();let t=C.Matrix[0];return this._localMatrix.invertToRef(t),v.TransformNormal(this.position,t)}locallyTranslate(t){return this.computeWorldMatrix(!0),this.position=v.TransformCoordinates(t,this._localMatrix),this}lookAt(t,e=0,i=0,s=0,r=yt.LOCAL){let a=n._LookAtVectorCache,o=r===yt.LOCAL?this.position:this.getAbsolutePosition();if(t.subtractToRef(o,a),this.setDirection(a,e,i,s),r===yt.WORLD&&this.parent)if(this.rotationQuaternion){let h=C.Matrix[0];this.rotationQuaternion.toRotationMatrix(h);let l=C.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(l),l.invert(),h.multiplyToRef(l,h),this.rotationQuaternion.fromRotationMatrix(h)}else{let h=C.Quaternion[0];se.FromEulerVectorToRef(this.rotation,h);let l=C.Matrix[0];h.toRotationMatrix(l);let c=C.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(c),c.invert(),l.multiplyToRef(c,l),h.fromRotationMatrix(l),h.toEulerAnglesToRef(this.rotation)}return this}getDirection(t){let e=v.Zero();return this.getDirectionToRef(t,e),e}getDirectionToRef(t,e){return v.TransformNormalToRef(t,this.getWorldMatrix(),e),this}setDirection(t,e=0,i=0,s=0){let r=-Math.atan2(t.z,t.x)+Math.PI/2,a=Math.sqrt(t.x*t.x+t.z*t.z),o=-Math.atan2(t.y,a);return this.rotationQuaternion?se.RotationYawPitchRollToRef(r+e,o+i,s,this.rotationQuaternion):(this.rotation.x=o+i,this.rotation.y=r+e,this.rotation.z=s),this}setPivotPoint(t,e=yt.LOCAL){this.getScene().getRenderId()==0&&this.computeWorldMatrix(!0);let i=this.getWorldMatrix();if(e==yt.WORLD){let s=C.Matrix[0];i.invertToRef(s),t=v.TransformCoordinates(t,s)}return this.setPivotMatrix(P.Translation(-t.x,-t.y,-t.z),!0)}getPivotPoint(){let t=v.Zero();return this.getPivotPointToRef(t),t}getPivotPointToRef(t){return t.x=-this._pivotMatrix.m[12],t.y=-this._pivotMatrix.m[13],t.z=-this._pivotMatrix.m[14],this}getAbsolutePivotPoint(){let t=v.Zero();return this.getAbsolutePivotPointToRef(t),t}getAbsolutePivotPointToRef(t){return this.getPivotPointToRef(t),v.TransformCoordinatesToRef(t,this.getWorldMatrix(),t),this}markAsDirty(t){if(this._isDirty)return this;if(this._children)for(let e of this._children)e.markAsDirty(t);return super.markAsDirty(t)}setParent(t,e=!1,i=!1){if(!t&&!this.parent)return this;let s=C.Quaternion[0],r=C.Vector3[0],a=C.Vector3[1],o=C.Matrix[1];P.IdentityToRef(o);let h=C.Matrix[0];this.computeWorldMatrix(!0);let l=this.rotationQuaternion;return l||(l=n._TmpRotation,se.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,l)),P.ComposeToRef(this.scaling,l,this.position,h),this.parent&&h.multiplyToRef(this.parent.computeWorldMatrix(!0),h),t&&(t.computeWorldMatrix(!0).invertToRef(o),h.multiplyToRef(o,h)),h.decompose(a,s,r,e?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(s):s.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(a),this.position.copyFrom(r),this.parent=t,i&&this.setPivotMatrix(P.Identity()),this}get nonUniformScaling(){return this._nonUniformScaling}_updateNonUniformScalingState(t){return this._nonUniformScaling===t?!1:(this._nonUniformScaling=t,!0)}attachToBone(t,e){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=e,this.parent=t,t.getSkeleton().prepare(),t.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this}detachFromBone(t=!1){return this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,t?this.parent=this._currentParentWhenAttachingToBone:this.parent=null,this):(t&&(this.parent=this._currentParentWhenAttachingToBone),this)}rotate(t,e,i){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0));let s;if(!i||i===yt.LOCAL)s=se.RotationAxisToRef(t,e,n._RotationAxisCache),this.rotationQuaternion.multiplyToRef(s,this.rotationQuaternion);else{if(this.parent){let r=C.Matrix[0];this.parent.getWorldMatrix().invertToRef(r),t=v.TransformNormal(t,r)}s=se.RotationAxisToRef(t,e,n._RotationAxisCache),s.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}return this}rotateAround(t,e,i){e.normalize(),this.rotationQuaternion||(this.rotationQuaternion=se.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));let s=C.Vector3[0],r=C.Vector3[1],a=C.Vector3[2],o=C.Quaternion[0],h=C.Matrix[0],l=C.Matrix[1],c=C.Matrix[2],d=C.Matrix[3];return t.subtractToRef(this.position,s),P.TranslationToRef(s.x,s.y,s.z,h),P.TranslationToRef(-s.x,-s.y,-s.z,l),P.RotationAxisToRef(e,i,c),l.multiplyToRef(c,d),d.multiplyToRef(h,d),d.decompose(r,o,a),this.position.addInPlace(a),o.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this}translate(t,e,i){let s=t.scale(e);if(!i||i===yt.LOCAL){let r=this.getPositionExpressedInLocalSpace().add(s);this.setPositionWithLocalVector(r)}else this.setAbsolutePosition(this.getAbsolutePosition().add(s));return this}addRotation(t,e,i){let s;this.rotationQuaternion?s=this.rotationQuaternion:(s=C.Quaternion[1],se.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,s));let r=C.Quaternion[0];return se.RotationYawPitchRollToRef(e,t,i,r),s.multiplyInPlace(r),this.rotationQuaternion||s.toEulerAnglesToRef(this.rotation),this}_getEffectiveParent(){return this.parent}computeWorldMatrix(t){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;let e=this.getScene().getRenderId();if(!this._isDirty&&!t&&(this._currentRenderId===e||this.isSynchronized()))return this._currentRenderId=e,this._worldMatrix;let i=this.getScene().activeCamera,s=(this._billboardMode&n.BILLBOARDMODE_USE_POSITION)!==0,r=this._billboardMode!==n.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard;this._updateCache();let a=this._cache;a.pivotMatrixUpdated=!1,a.billboardMode=this.billboardMode,a.infiniteDistance=this.infiniteDistance,a.parent=this._parentNode,this._currentRenderId=e,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;let o=this._getEffectiveParent(),h=n._TmpScaling,l=this._position;if(this._infiniteDistance&&!this.parent&&i){let d=i.getWorldMatrix(),u=new v(d.m[12],d.m[13],d.m[14]);l=n._TmpTranslation,l.copyFromFloats(this._position.x+u.x,this._position.y+u.y,this._position.z+u.z)}h.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant);let c;if(this._rotationQuaternion?(this._rotationQuaternion._isDirty=!1,c=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion&&this.rotation.lengthSquared()&&(this._rotationQuaternion.multiplyInPlace(se.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))):(c=n._TmpRotation,se.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,c)),this._usePivotMatrix){let d=C.Matrix[1];P.ScalingToRef(h.x,h.y,h.z,d);let u=C.Matrix[0];c.toRotationMatrix(u),this._pivotMatrix.multiplyToRef(d,C.Matrix[4]),C.Matrix[4].multiplyToRef(u,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(l.x,l.y,l.z)}else P.ComposeToRef(h,c,l,this._localMatrix);if(o&&o.getWorldMatrix){if(t&&o.computeWorldMatrix(t),r){this._transformToBoneReferal?o.getWorldMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),C.Matrix[7]):C.Matrix[7].copyFrom(o.getWorldMatrix());let d=C.Vector3[5],u=C.Vector3[6],f=C.Quaternion[0];C.Matrix[7].decompose(u,f,d),P.ScalingToRef(u.x,u.y,u.z,C.Matrix[7]),C.Matrix[7].setTranslation(d),n.BillboardUseParentOrientation&&(this._position.applyRotationQuaternionToRef(f,d),this._localMatrix.setTranslation(d)),this._localMatrix.multiplyToRef(C.Matrix[7],this._worldMatrix)}else this._transformToBoneReferal?(this._localMatrix.multiplyToRef(o.getWorldMatrix(),C.Matrix[6]),C.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)):this._localMatrix.multiplyToRef(o.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(r&&i&&this.billboardMode&&!s){let d=C.Vector3[0];if(this._worldMatrix.getTranslationToRef(d),C.Matrix[1].copyFrom(i.getViewMatrix()),C.Matrix[1].setTranslationFromFloats(0,0,0),C.Matrix[1].invertToRef(C.Matrix[0]),(this.billboardMode&n.BILLBOARDMODE_ALL)!==n.BILLBOARDMODE_ALL){C.Matrix[0].decompose(void 0,C.Quaternion[0],void 0);let u=C.Vector3[1];C.Quaternion[0].toEulerAnglesToRef(u),(this.billboardMode&n.BILLBOARDMODE_X)!==n.BILLBOARDMODE_X&&(u.x=0),(this.billboardMode&n.BILLBOARDMODE_Y)!==n.BILLBOARDMODE_Y&&(u.y=0),(this.billboardMode&n.BILLBOARDMODE_Z)!==n.BILLBOARDMODE_Z&&(u.z=0),P.RotationYawPitchRollToRef(u.y,u.x,u.z,C.Matrix[0])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(C.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(C.Vector3[0])}else if(r&&i&&this.billboardMode&&s){let d=C.Vector3[0];this._worldMatrix.getTranslationToRef(d);let u=i.globalPosition;this._worldMatrix.invertToRef(C.Matrix[1]);let f=C.Vector3[1];v.TransformCoordinatesToRef(u,C.Matrix[1],f),f.normalize();let _=-Math.atan2(f.z,f.x)+Math.PI/2,g=Math.sqrt(f.x*f.x+f.z*f.z),p=-Math.atan2(f.y,g);if(se.RotationYawPitchRollToRef(_,p,0,C.Quaternion[0]),(this.billboardMode&n.BILLBOARDMODE_ALL)!==n.BILLBOARDMODE_ALL){let E=C.Vector3[1];C.Quaternion[0].toEulerAnglesToRef(E),(this.billboardMode&n.BILLBOARDMODE_X)!==n.BILLBOARDMODE_X&&(E.x=0),(this.billboardMode&n.BILLBOARDMODE_Y)!==n.BILLBOARDMODE_Y&&(E.y=0),(this.billboardMode&n.BILLBOARDMODE_Z)!==n.BILLBOARDMODE_Z&&(E.z=0),P.RotationYawPitchRollToRef(E.y,E.x,E.z,C.Matrix[0])}else P.FromQuaternionToRef(C.Quaternion[0],C.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(C.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(C.Vector3[0])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):o&&o._nonUniformScaling?this._updateNonUniformScalingState(o._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=P.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix}resetLocalMatrix(t=!0){if(this.computeWorldMatrix(),t){let e=this.getChildren();for(let i=0;i<e.length;++i){let s=e[i];if(s){s.computeWorldMatrix();let r=C.Matrix[0];s._localMatrix.multiplyToRef(this._localMatrix,r);let a=C.Quaternion[0];r.decompose(s.scaling,a,s.position),s.rotationQuaternion?s.rotationQuaternion.copyFrom(a):a.toEulerAnglesToRef(s.rotation)}}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=se.Identity()),this._worldMatrix=P.Identity()}_afterComputeWorldMatrix(){}registerAfterWorldMatrixUpdate(t){return this.onAfterWorldMatrixUpdateObservable.add(t),this}unregisterAfterWorldMatrixUpdate(t){return this.onAfterWorldMatrixUpdateObservable.removeCallback(t),this}getPositionInCameraSpace(t=null){return t||(t=this.getScene().activeCamera),v.TransformCoordinates(this.getAbsolutePosition(),t.getViewMatrix())}getDistanceToCamera(t=null){return t||(t=this.getScene().activeCamera),this.getAbsolutePosition().subtract(t.globalPosition).length()}clone(t,e,i){let s=ee.Clone(()=>new n(t,this.getScene()),this);if(s.name=t,s.id=t,e&&(s.parent=e),!i){let r=this.getDescendants(!0);for(let a=0;a<r.length;a++){let o=r[a];o.clone&&o.clone(t+"."+o.name,s)}}return s}serialize(t){let e=ee.Serialize(this,t);return e.type=this.getClassName(),e.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(e),e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(),e}static Parse(t,e,i){let s=ee.Parse(()=>new n(t.name,e),t,e,i);return t.localMatrix?s.setPreTransformMatrix(P.FromArray(t.localMatrix)):t.pivotMatrix&&s.setPivotMatrix(P.FromArray(t.pivotMatrix)),s.setEnabled(t.isEnabled),s._waitingParsedUniqueId=t.uniqueId,t.parentId!==void 0&&(s._waitingParentId=t.parentId),t.parentInstanceIndex!==void 0&&(s._waitingParentInstanceIndex=t.parentInstanceIndex),s}getChildTransformNodes(t,e){let i=[];return this._getDescendants(i,t,s=>(!e||e(s))&&s instanceof n),i}dispose(t,e=!1){if(this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){let i=this._parentContainer.transformNodes.indexOf(this);i>-1&&this._parentContainer.transformNodes.splice(i,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),t){let i=this.getChildTransformNodes(!0);for(let s of i)s.parent=null,s.computeWorldMatrix(!0)}super.dispose(t,e)}normalizeToUnitCube(t=!0,e=!1,i){let s=null,r=null;e&&(this.rotationQuaternion?(r=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(s=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));let a=this.getHierarchyBoundingVectors(t,i),o=a.max.subtract(a.min),h=Math.max(o.x,o.y,o.z);if(h===0)return this;let l=1/h;return this.scaling.scaleInPlace(l),e&&(this.rotationQuaternion&&r?this.rotationQuaternion.copyFrom(r):this.rotation&&s&&this.rotation.copyFrom(s)),this}_syncAbsoluteScalingAndRotation(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=!0)}};oe.BILLBOARDMODE_NONE=0;oe.BILLBOARDMODE_X=1;oe.BILLBOARDMODE_Y=2;oe.BILLBOARDMODE_Z=4;oe.BILLBOARDMODE_ALL=7;oe.BILLBOARDMODE_USE_POSITION=128;oe.BillboardUseParentOrientation=!1;oe._TmpRotation=se.Zero();oe._TmpScaling=v.Zero();oe._TmpTranslation=v.Zero();oe._LookAtVectorCache=new v(0,0,0);oe._RotationAxisCache=new se;S([Nt("position")],oe.prototype,"_position",void 0);S([Nt("rotation")],oe.prototype,"_rotation",void 0);S([ha("rotationQuaternion")],oe.prototype,"_rotationQuaternion",void 0);S([Nt("scaling")],oe.prototype,"_scaling",void 0);S([A("billboardMode")],oe.prototype,"_billboardMode",void 0);S([A()],oe.prototype,"scalingDeterminant",void 0);S([A("infiniteDistance")],oe.prototype,"_infiniteDistance",void 0);S([A()],oe.prototype,"ignoreNonUniformScaling",void 0);S([A()],oe.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0);var mr=class{constructor(){this._checkCollisions=!1,this._collisionMask=-1,this._collisionGroup=-1,this._surroundingMeshes=null,this._collider=null,this._oldPositionForCollisions=new v(0,0,0),this._diffPositionForCollisions=new v(0,0,0),this._collisionResponse=!0}},vr=class{constructor(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=v.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1}},Er=class{constructor(){this._hasVertexAlpha=!1,this._useVertexColors=!0,this._numBoneInfluencers=4,this._applyFog=!0,this._receiveShadows=!1,this._facetData=new vr,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=!0,this._isActive=!1,this._onlyForInstances=!1,this._isActiveIntermediate=!1,this._onlyForInstancesIntermediate=!1,this._actAsRegularMesh=!1,this._currentLOD=null,this._currentLODIsUpToDate=!1,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._pointerOverDisableMeshTesting=!1,this._meshCollisionData=new mr,this._enableDistantPicking=!1}},Qr=(()=>{class n extends oe{constructor(e,i=null){switch(super(e,i,!1),this._internalAbstractMeshDataInfo=new Er,this._waitingMaterialId=null,this.cullingStrategy=n.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this.onCollideObservable=new D,this.onCollisionPositionChangeObservable=new D,this.onMaterialChangedObservable=new D,this.definedFacingForward=!0,this._occlusionQuery=null,this._renderingGroup=null,this.alphaIndex=Number.MAX_VALUE,this.isVisible=!0,this.isPickable=!0,this.isNearPickable=!1,this.isNearGrabbable=!1,this.showSubMeshesBoundingBox=!1,this.isBlocker=!1,this.enablePointerMoveEvents=!1,this.outlineColor=me.Red(),this.outlineWidth=.02,this.overlayColor=me.Red(),this.overlayAlpha=.5,this.useOctreeForRenderingSelection=!0,this.useOctreeForPicking=!0,this.useOctreeForCollisions=!0,this.alwaysSelectAsActiveMesh=!1,this.doNotSyncBoundingInfo=!1,this.actionManager=null,this.ellipsoid=new v(.5,1,.5),this.ellipsoidOffset=new v(0,0,0),this.edgesWidth=1,this.edgesColor=new ie(1,0,0,1),this._edgesRenderer=null,this._masterMesh=null,this._boundingInfo=null,this._boundingInfoIsDirty=!0,this._renderId=0,this._intersectionsInProgress=new Array,this._unIndexed=!1,this._lightSources=new Array,this._waitingData={lods:null,actions:null,freezeWorldMatrix:null},this._bonesTransformMatrices=null,this._transformMatrixTexture=null,this.onRebuildObservable=new D,this._onCollisionPositionChange=(s,r,a=null)=>{r.subtractToRef(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>de.CollisionsEpsilon&&this.position.addInPlace(this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),a&&this.onCollideObservable.notifyObservers(a),this.onCollisionPositionChangeObservable.notifyObservers(this.position)},i=this.getScene(),i.addMesh(this),this._resyncLightSources(),this._uniformBuffer=new Qe(this.getScene().getEngine(),void 0,void 0,e,!this.getScene().getEngine().isWebGPU),this._buildUniformLayout(),i.performancePriority){case mt.Aggressive:this.doNotSyncBoundingInfo=!0;case mt.Intermediate:this.alwaysSelectAsActiveMesh=!0,this.isPickable=!1;break}}static get BILLBOARDMODE_NONE(){return oe.BILLBOARDMODE_NONE}static get BILLBOARDMODE_X(){return oe.BILLBOARDMODE_X}static get BILLBOARDMODE_Y(){return oe.BILLBOARDMODE_Y}static get BILLBOARDMODE_Z(){return oe.BILLBOARDMODE_Z}static get BILLBOARDMODE_ALL(){return oe.BILLBOARDMODE_ALL}static get BILLBOARDMODE_USE_POSITION(){return oe.BILLBOARDMODE_USE_POSITION}get facetNb(){return this._internalAbstractMeshDataInfo._facetData.facetNb}get partitioningSubdivisions(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions}set partitioningSubdivisions(e){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=e}get partitioningBBoxRatio(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio}set partitioningBBoxRatio(e){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=e}get mustDepthSortFacets(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort}set mustDepthSortFacets(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=e}get facetDepthSortFrom(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom}set facetDepthSortFrom(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=e}get collisionRetryCount(){return this._internalAbstractMeshDataInfo._collisionRetryCount}set collisionRetryCount(e){this._internalAbstractMeshDataInfo._collisionRetryCount=e}get isFacetDataEnabled(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled}get morphTargetManager(){return this._internalAbstractMeshDataInfo._morphTargetManager}set morphTargetManager(e){this._internalAbstractMeshDataInfo._morphTargetManager!==e&&(this._internalAbstractMeshDataInfo._morphTargetManager=e,this._syncGeometryWithMorphTargetManager())}get bakedVertexAnimationManager(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager}set bakedVertexAnimationManager(e){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==e&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=e,this._markSubMeshesAsAttributesDirty())}_syncGeometryWithMorphTargetManager(){}_updateNonUniformScalingState(e){return super._updateNonUniformScalingState(e)?(this._markSubMeshesAsMiscDirty(),!0):!1}set onCollide(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(e)}set onCollisionPositionChange(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(e)}get visibility(){return this._internalAbstractMeshDataInfo._visibility}set visibility(e){if(this._internalAbstractMeshDataInfo._visibility===e)return;let i=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=e,(i===1&&e!==1||i!==1&&e===1)&&this._markSubMeshesAsMiscDirty()}get pointerOverDisableMeshTesting(){return this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting}set pointerOverDisableMeshTesting(e){this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting=e}get renderingGroupId(){return this._internalAbstractMeshDataInfo._renderingGroupId}set renderingGroupId(e){this._internalAbstractMeshDataInfo._renderingGroupId=e}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){this._internalAbstractMeshDataInfo._material!==e&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=e,e&&e.meshMap&&(e.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(),this._unBindEffect()))}getMaterialForRenderPass(e){var i;return(i=this._internalAbstractMeshDataInfo._materialForRenderPass)===null||i===void 0?void 0:i[e]}setMaterialForRenderPass(e,i){this.resetDrawCache(e),this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]),this._internalAbstractMeshDataInfo._materialForRenderPass[e]=i}get receiveShadows(){return this._internalAbstractMeshDataInfo._receiveShadows}set receiveShadows(e){this._internalAbstractMeshDataInfo._receiveShadows!==e&&(this._internalAbstractMeshDataInfo._receiveShadows=e,this._markSubMeshesAsLightDirty())}get hasVertexAlpha(){return this._internalAbstractMeshDataInfo._hasVertexAlpha}set hasVertexAlpha(e){this._internalAbstractMeshDataInfo._hasVertexAlpha!==e&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=e,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())}get useVertexColors(){return this._internalAbstractMeshDataInfo._useVertexColors}set useVertexColors(e){this._internalAbstractMeshDataInfo._useVertexColors!==e&&(this._internalAbstractMeshDataInfo._useVertexColors=e,this._markSubMeshesAsAttributesDirty())}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get numBoneInfluencers(){return this._internalAbstractMeshDataInfo._numBoneInfluencers}set numBoneInfluencers(e){this._internalAbstractMeshDataInfo._numBoneInfluencers!==e&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=e,this._markSubMeshesAsAttributesDirty())}get applyFog(){return this._internalAbstractMeshDataInfo._applyFog}set applyFog(e){this._internalAbstractMeshDataInfo._applyFog!==e&&(this._internalAbstractMeshDataInfo._applyFog=e,this._markSubMeshesAsMiscDirty())}get enableDistantPicking(){return this._internalAbstractMeshDataInfo._enableDistantPicking}set enableDistantPicking(e){this._internalAbstractMeshDataInfo._enableDistantPicking=e}get layerMask(){return this._internalAbstractMeshDataInfo._layerMask}set layerMask(e){e!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=e,this._resyncLightSources())}get collisionMask(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask}set collisionMask(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(e)?-1:e}get collisionResponse(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse}set collisionResponse(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=e}get collisionGroup(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup}set collisionGroup(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(e)?-1:e}get surroundingMeshes(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes}set surroundingMeshes(e){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=e}get lightSources(){return this._lightSources}get _positions(){return null}set skeleton(e){let i=this._internalAbstractMeshDataInfo._skeleton;i&&i.needInitialSkinMatrix&&i._unregisterMeshWithPoseMatrix(this),e&&e.needInitialSkinMatrix&&e._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=e,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()}get skeleton(){return this._internalAbstractMeshDataInfo._skeleton}_buildUniformLayout(){this._uniformBuffer.addUniform("world",16),this._uniformBuffer.addUniform("visibility",1),this._uniformBuffer.create()}transferToEffect(e){let i=this._uniformBuffer;i.updateMatrix("world",e),i.updateFloat("visibility",this._internalAbstractMeshDataInfo._visibility),i.update()}getMeshUniformBuffer(){return this._uniformBuffer}getClassName(){return"AbstractMesh"}toString(e){let i="Name: "+this.name+", isInstance: "+(this.getClassName()!=="InstancedMesh"?"YES":"NO");i+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);let s=this._internalAbstractMeshDataInfo._skeleton;return s&&(i+=", skeleton: "+s.name),e&&(i+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],i+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?"YES":"NO")),i}_getEffectiveParent(){return this._masterMesh&&this.billboardMode!==oe.BILLBOARDMODE_NONE?this._masterMesh:super._getEffectiveParent()}_getActionManagerForTrigger(e,i=!0){if(this.actionManager&&(i||this.actionManager.isRecursive))if(e){if(this.actionManager.hasSpecificTrigger(e))return this.actionManager}else return this.actionManager;return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_rebuild(e=!1){if(this.onRebuildObservable.notifyObservers(this),this._occlusionQuery!==null&&(this._occlusionQuery=null),!!this.subMeshes)for(let i of this.subMeshes)i._rebuild()}_resyncLightSources(){this._lightSources.length=0;for(let e of this.getScene().lights)e.isEnabled()&&e.canAffectMesh(this)&&this._lightSources.push(e);this._markSubMeshesAsLightDirty()}_resyncLightSource(e){let i=e.isEnabled()&&e.canAffectMesh(this),s=this._lightSources.indexOf(e),r=!1;if(s===-1){if(!i)return;this._lightSources.push(e)}else{if(i)return;r=!0,this._lightSources.splice(s,1)}this._markSubMeshesAsLightDirty(r)}_unBindEffect(){for(let e of this.subMeshes)e.setEffect(null)}_removeLightSource(e,i){let s=this._lightSources.indexOf(e);s!==-1&&(this._lightSources.splice(s,1),this._markSubMeshesAsLightDirty(i))}_markSubMeshesAsDirty(e){if(this.subMeshes)for(let i of this.subMeshes)for(let s=0;s<i._drawWrappers.length;++s){let r=i._drawWrappers[s];!r||!r.defines||!r.defines.markAllAsDirty||e(r.defines)}}_markSubMeshesAsLightDirty(e=!1){this._markSubMeshesAsDirty(i=>i.markAsLightDirty(e))}_markSubMeshesAsAttributesDirty(){this._markSubMeshesAsDirty(e=>e.markAsAttributesDirty())}_markSubMeshesAsMiscDirty(){this._markSubMeshesAsDirty(e=>e.markAsMiscDirty())}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}resetDrawCache(e){if(this.subMeshes)for(let i of this.subMeshes)i.resetDrawCache(e)}get isBlocked(){return!1}getLOD(e){return this}getTotalVertices(){return 0}getTotalIndices(){return 0}getIndices(){return null}getVerticesData(e){return null}setVerticesData(e,i,s,r){return this}updateVerticesData(e,i,s,r){return this}setIndices(e,i){return this}isVerticesDataPresent(e){return!1}getBoundingInfo(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=!1,this._updateBoundingInfo()),this._boundingInfo)}setBoundingInfo(e){return this._boundingInfo=e,this}get hasBoundingInfo(){return this._boundingInfo!==null}buildBoundingInfo(e,i,s){return this._boundingInfo=new ht(e,i,s),this._boundingInfo}normalizeToUnitCube(e=!0,i=!1,s){return super.normalizeToUnitCube(e,i,s)}get useBones(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(m.MatricesIndicesKind)&&this.isVerticesDataPresent(m.MatricesWeightsKind)}_preActivate(){}_preActivateForIntermediateRendering(e){}_activate(e,i){return this._renderId=e,!0}_postActivate(){}_freeze(){}_unFreeze(){}getWorldMatrix(){return this._masterMesh&&this.billboardMode===oe.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():super.getWorldMatrix()}_getWorldMatrixDeterminant(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():super._getWorldMatrixDeterminant()}get isAnInstance(){return!1}get hasInstances(){return!1}get hasThinInstances(){return!1}movePOV(e,i,s){return this.position.addInPlace(this.calcMovePOV(e,i,s)),this}calcMovePOV(e,i,s){let r=new P;(this.rotationQuaternion?this.rotationQuaternion:se.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(r);let a=v.Zero(),o=this.definedFacingForward?-1:1;return v.TransformCoordinatesFromFloatsToRef(e*o,i,s*o,r,a),a}rotatePOV(e,i,s){return this.rotation.addInPlace(this.calcRotatePOV(e,i,s)),this}calcRotatePOV(e,i,s){let r=this.definedFacingForward?1:-1;return new v(e*r,i,s*r)}refreshBoundingInfo(e=!1,i=!1){return this._boundingInfo&&this._boundingInfo.isLocked?this:(this._refreshBoundingInfo(this._getPositionData(e,i),null),this)}_refreshBoundingInfo(e,i){if(e){let s=Fn(e,0,this.getTotalVertices(),i);this._boundingInfo?this._boundingInfo.reConstruct(s.minimum,s.maximum):this._boundingInfo=new ht(s.minimum,s.maximum)}if(this.subMeshes)for(let s=0;s<this.subMeshes.length;s++)this.subMeshes[s].refreshBoundingInfo(e);this._updateBoundingInfo()}_getData(e=!1,i=!1,s,r=m.PositionKind){if(s=s??this.getVerticesData(r).slice(),s&&i&&this.morphTargetManager){let a=0,o=0;for(let h=0;h<s.length;h++){for(let l=0;l<this.morphTargetManager.numTargets;l++){let c=this.morphTargetManager.getTarget(l),d=c.influence;if(d>0){let u=c.getPositions();u&&(s[h]+=(u[h]-s[h])*d)}}if(a++,r===m.PositionKind&&this._positions&&a===3){a=0;let l=o*3;this._positions[o++].copyFromFloats(s[l],s[l+1],s[l+2])}}}if(s&&e&&this.skeleton){let a=this.getVerticesData(m.MatricesIndicesKind),o=this.getVerticesData(m.MatricesWeightsKind);if(o&&a){let h=this.numBoneInfluencers>4,l=h?this.getVerticesData(m.MatricesIndicesExtraKind):null,c=h?this.getVerticesData(m.MatricesWeightsExtraKind):null,d=this.skeleton.getTransformMatrices(this),u=C.Vector3[0],f=C.Matrix[0],_=C.Matrix[1],g=0;for(let p=0;p<s.length;p+=3,g+=4){f.reset();let E,T;for(E=0;E<4;E++)T=o[g+E],T>0&&(P.FromFloat32ArrayToRefScaled(d,Math.floor(a[g+E]*16),T,_),f.addToSelf(_));if(h)for(E=0;E<4;E++)T=c[g+E],T>0&&(P.FromFloat32ArrayToRefScaled(d,Math.floor(l[g+E]*16),T,_),f.addToSelf(_));r===m.NormalKind?v.TransformNormalFromFloatsToRef(s[p],s[p+1],s[p+2],f,u):v.TransformCoordinatesFromFloatsToRef(s[p],s[p+1],s[p+2],f,u),u.toArray(s,p),r===m.PositionKind&&this._positions&&this._positions[p/3].copyFrom(u)}}}return s}getNormalsData(e=!1,i=!1){return this._getData(e,i,null,m.NormalKind)}getPositionData(e=!1,i=!1,s){return this._getData(e,i,s,m.PositionKind)}_getPositionData(e,i){var s;let r=this.getVerticesData(m.PositionKind);if(this._internalAbstractMeshDataInfo._positions&&(this._internalAbstractMeshDataInfo._positions=null),r&&(e&&this.skeleton||i&&this.morphTargetManager)){if(r=r.slice(),this._generatePointsArray(),this._positions){let a=this._positions;this._internalAbstractMeshDataInfo._positions=new Array(a.length);for(let o=0;o<a.length;o++)this._internalAbstractMeshDataInfo._positions[o]=((s=a[o])===null||s===void 0?void 0:s.clone())||new v}return this.getPositionData(e,i,r)}return r}_updateBoundingInfo(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new ht(v.Zero(),v.Zero(),this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}_updateSubMeshesBoundingInfo(e){if(!this.subMeshes)return this;let i=this.subMeshes.length;for(let s=0;s<i;s++){let r=this.subMeshes[s];(i>1||!r.IsGlobal)&&r.updateBoundingInfo(e)}return this}_afterComputeWorldMatrix(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=!0)}isInFrustum(e){return this.getBoundingInfo().isInFrustum(e,this.cullingStrategy)}isCompletelyInFrustum(e){return this.getBoundingInfo().isCompletelyInFrustum(e)}intersectsMesh(e,i=!1,s){let r=this.getBoundingInfo(),a=e.getBoundingInfo();if(r.intersects(a,i))return!0;if(s){for(let o of this.getChildMeshes())if(o.intersectsMesh(e,i,!0))return!0}return!1}intersectsPoint(e){return this.getBoundingInfo().intersectsPoint(e)}get checkCollisions(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions}set checkCollisions(e){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=e}get collider(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider}moveWithCollisions(e){this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);let i=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=i.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,i.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,e,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId),this}_collideForSubMesh(e,i,s){var r;if(this._generatePointsArray(),!this._positions)return this;if(!e._lastColliderWorldVertices||!e._lastColliderTransformMatrix.equals(i)){e._lastColliderTransformMatrix=i.clone(),e._lastColliderWorldVertices=[],e._trianglePlanes=[];let a=e.verticesStart,o=e.verticesStart+e.verticesCount;for(let h=a;h<o;h++)e._lastColliderWorldVertices.push(v.TransformCoordinates(this._positions[h],i))}return s._collide(e._trianglePlanes,e._lastColliderWorldVertices,this.getIndices(),e.indexStart,e.indexStart+e.indexCount,e.verticesStart,!!e.getMaterial(),this,this._shouldConvertRHS(),((r=e.getMaterial())===null||r===void 0?void 0:r.fillMode)===7),this}_processCollisionsForSubMeshes(e,i){let s=this._scene.getCollidingSubMeshCandidates(this,e),r=s.length;for(let a=0;a<r;a++){let o=s.data[a];r>1&&!o._checkCollision(e)||this._collideForSubMesh(o,i,e)}return this}_shouldConvertRHS(){return!1}_checkCollision(e){if(!this.getBoundingInfo()._checkCollision(e))return this;let i=C.Matrix[0],s=C.Matrix[1];return P.ScalingToRef(1/e._radius.x,1/e._radius.y,1/e._radius.z,i),this.worldMatrixFromCache.multiplyToRef(i,s),this._processCollisionsForSubMeshes(e,s),this}_generatePointsArray(){return!1}intersects(e,i,s,r=!1,a,o=!1){let h=new lt,l=this.getClassName()==="InstancedLinesMesh"||this.getClassName()==="LinesMesh"?this.intersectionThreshold:0,c=this.getBoundingInfo();if(!this.subMeshes||!o&&(!e.intersectsSphere(c.boundingSphere,l)||!e.intersectsBox(c.boundingBox,l)))return h;if(r)return h.hit=!o,h.pickedMesh=o?null:this,h.distance=o?0:v.Distance(e.origin,c.boundingSphere.center),h.subMeshId=0,h;if(!this._generatePointsArray())return h;let d=null,u=this._scene.getIntersectingSubMeshCandidates(this,e),f=u.length,_=!1;for(let g=0;g<f;g++){let p=u.data[g].getMaterial();if(p&&(p.fillMode==7||p.fillMode==0||p.fillMode==1||p.fillMode==2||p.fillMode==4)){_=!0;break}}if(!_)return h.hit=!0,h.pickedMesh=this,h.distance=v.Distance(e.origin,c.boundingSphere.center),h.subMeshId=-1,h;for(let g=0;g<f;g++){let p=u.data[g];if(f>1&&!p.canIntersects(e))continue;let E=p.intersects(e,this._positions,this.getIndices(),i,s);if(E&&(i||!d||E.distance<d.distance)&&(d=E,d.subMeshId=g,i))break}if(d){let g=a??this.getWorldMatrix(),p=C.Vector3[0],E=C.Vector3[1];v.TransformCoordinatesToRef(e.origin,g,p),e.direction.scaleToRef(d.distance,E);let T=v.TransformNormal(E,g).addInPlace(p);return h.hit=!0,h.distance=v.Distance(p,T),h.pickedPoint=T,h.pickedMesh=this,h.bu=d.bu||0,h.bv=d.bv||0,h.subMeshFaceId=d.faceId,h.faceId=d.faceId+u.data[d.subMeshId].indexStart/(this.getClassName().indexOf("LinesMesh")!==-1?2:3),h.subMeshId=d.subMeshId,h}return h}clone(e,i,s){return null}releaseSubMeshes(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=new Array;return this}dispose(e,i=!1){let s;for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this.getScene().freeActiveMeshes(),this.getScene().freeRenderingGroups(),this.actionManager!==void 0&&this.actionManager!==null&&(this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null),s=0;s<this._intersectionsInProgress.length;s++){let a=this._intersectionsInProgress[s],o=a._intersectionsInProgress.indexOf(this);a._intersectionsInProgress.splice(o,1)}this._intersectionsInProgress.length=0,this.getScene().lights.forEach(a=>{let o=a.includedOnlyMeshes.indexOf(this);o!==-1&&a.includedOnlyMeshes.splice(o,1),o=a.excludedMeshes.indexOf(this),o!==-1&&a.excludedMeshes.splice(o,1);let h=a.getShadowGenerators();if(h){let l=h.values();for(let c=l.next();c.done!==!0;c=l.next()){let d=c.value.getShadowMap();d&&d.renderList&&(o=d.renderList.indexOf(this),o!==-1&&d.renderList.splice(o,1))}}}),(this.getClassName()!=="InstancedMesh"||this.getClassName()!=="InstancedLinesMesh")&&this.releaseSubMeshes();let r=this.getScene().getEngine();if(this._occlusionQuery!==null&&(this.isOcclusionQueryInProgress=!1,r.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),r.wipeCaches(),this.getScene().removeMesh(this),this._parentContainer){let a=this._parentContainer.meshes.indexOf(this);a>-1&&this._parentContainer.meshes.splice(a,1),this._parentContainer=null}if(i&&this.material&&(this.material.getClassName()==="MultiMaterial"?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!e)for(s=0;s<this.getScene().particleSystems.length;s++)this.getScene().particleSystems[s].emitter===this&&(this.getScene().particleSystems[s].dispose(),s--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),super.dispose(e,i)}addChild(e,i=!1){return e.setParent(this,i),this}removeChild(e,i=!1){return e.setParent(null,i),this}_initFacetData(){let e=this._internalAbstractMeshDataInfo._facetData;e.facetNormals||(e.facetNormals=new Array),e.facetPositions||(e.facetPositions=new Array),e.facetPartitioning||(e.facetPartitioning=new Array),e.facetNb=this.getIndices().length/3|0,e.partitioningSubdivisions=e.partitioningSubdivisions?e.partitioningSubdivisions:10,e.partitioningBBoxRatio=e.partitioningBBoxRatio?e.partitioningBBoxRatio:1.01;for(let i=0;i<e.facetNb;i++)e.facetNormals[i]=v.Zero(),e.facetPositions[i]=v.Zero();return e.facetDataEnabled=!0,this}updateFacetData(){let e=this._internalAbstractMeshDataInfo._facetData;e.facetDataEnabled||this._initFacetData();let i=this.getVerticesData(m.PositionKind),s=this.getIndices(),r=this.getVerticesData(m.NormalKind),a=this.getBoundingInfo();if(e.facetDepthSort&&!e.facetDepthSortEnabled){if(e.facetDepthSortEnabled=!0,s instanceof Uint16Array)e.depthSortedIndices=new Uint16Array(s);else if(s instanceof Uint32Array)e.depthSortedIndices=new Uint32Array(s);else{let h=!1;for(let l=0;l<s.length;l++)if(s[l]>65535){h=!0;break}h?e.depthSortedIndices=new Uint32Array(s):e.depthSortedIndices=new Uint16Array(s)}if(e.facetDepthSortFunction=function(h,l){return l.sqDistance-h.sqDistance},!e.facetDepthSortFrom){let h=this.getScene().activeCamera;e.facetDepthSortFrom=h?h.position:v.Zero()}e.depthSortedFacets=[];for(let h=0;h<e.facetNb;h++){let l={ind:h*3,sqDistance:0};e.depthSortedFacets.push(l)}e.invertedMatrix=P.Identity(),e.facetDepthSortOrigin=v.Zero()}e.bbSize.x=a.maximum.x-a.minimum.x>_e?a.maximum.x-a.minimum.x:_e,e.bbSize.y=a.maximum.y-a.minimum.y>_e?a.maximum.y-a.minimum.y:_e,e.bbSize.z=a.maximum.z-a.minimum.z>_e?a.maximum.z-a.minimum.z:_e;let o=e.bbSize.x>e.bbSize.y?e.bbSize.x:e.bbSize.y;if(o=o>e.bbSize.z?o:e.bbSize.z,e.subDiv.max=e.partitioningSubdivisions,e.subDiv.X=Math.floor(e.subDiv.max*e.bbSize.x/o),e.subDiv.Y=Math.floor(e.subDiv.max*e.bbSize.y/o),e.subDiv.Z=Math.floor(e.subDiv.max*e.bbSize.z/o),e.subDiv.X=e.subDiv.X<1?1:e.subDiv.X,e.subDiv.Y=e.subDiv.Y<1?1:e.subDiv.Y,e.subDiv.Z=e.subDiv.Z<1?1:e.subDiv.Z,e.facetParameters.facetNormals=this.getFacetLocalNormals(),e.facetParameters.facetPositions=this.getFacetLocalPositions(),e.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),e.facetParameters.bInfo=a,e.facetParameters.bbSize=e.bbSize,e.facetParameters.subDiv=e.subDiv,e.facetParameters.ratio=this.partitioningBBoxRatio,e.facetParameters.depthSort=e.facetDepthSort,e.facetDepthSort&&e.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(e.invertedMatrix),v.TransformCoordinatesToRef(e.facetDepthSortFrom,e.invertedMatrix,e.facetDepthSortOrigin),e.facetParameters.distanceTo=e.facetDepthSortOrigin),e.facetParameters.depthSortedFacets=e.depthSortedFacets,r&&pe.ComputeNormals(i,s,r,e.facetParameters),e.facetDepthSort&&e.facetDepthSortEnabled){e.depthSortedFacets.sort(e.facetDepthSortFunction);let h=e.depthSortedIndices.length/3|0;for(let l=0;l<h;l++){let c=e.depthSortedFacets[l].ind;e.depthSortedIndices[l*3]=s[c],e.depthSortedIndices[l*3+1]=s[c+1],e.depthSortedIndices[l*3+2]=s[c+2]}this.updateIndices(e.depthSortedIndices,void 0,!0)}return this}getFacetLocalNormals(){let e=this._internalAbstractMeshDataInfo._facetData;return e.facetNormals||this.updateFacetData(),e.facetNormals}getFacetLocalPositions(){let e=this._internalAbstractMeshDataInfo._facetData;return e.facetPositions||this.updateFacetData(),e.facetPositions}getFacetLocalPartitioning(){let e=this._internalAbstractMeshDataInfo._facetData;return e.facetPartitioning||this.updateFacetData(),e.facetPartitioning}getFacetPosition(e){let i=v.Zero();return this.getFacetPositionToRef(e,i),i}getFacetPositionToRef(e,i){let s=this.getFacetLocalPositions()[e],r=this.getWorldMatrix();return v.TransformCoordinatesToRef(s,r,i),this}getFacetNormal(e){let i=v.Zero();return this.getFacetNormalToRef(e,i),i}getFacetNormalToRef(e,i){let s=this.getFacetLocalNormals()[e];return v.TransformNormalToRef(s,this.getWorldMatrix(),i),this}getFacetsAtLocalCoordinates(e,i,s){let r=this.getBoundingInfo(),a=this._internalAbstractMeshDataInfo._facetData,o=Math.floor((e-r.minimum.x*a.partitioningBBoxRatio)*a.subDiv.X*a.partitioningBBoxRatio/a.bbSize.x),h=Math.floor((i-r.minimum.y*a.partitioningBBoxRatio)*a.subDiv.Y*a.partitioningBBoxRatio/a.bbSize.y),l=Math.floor((s-r.minimum.z*a.partitioningBBoxRatio)*a.subDiv.Z*a.partitioningBBoxRatio/a.bbSize.z);return o<0||o>a.subDiv.max||h<0||h>a.subDiv.max||l<0||l>a.subDiv.max?null:a.facetPartitioning[o+a.subDiv.max*h+a.subDiv.max*a.subDiv.max*l]}getClosestFacetAtCoordinates(e,i,s,r,a=!1,o=!0){let h=this.getWorldMatrix(),l=C.Matrix[5];h.invertToRef(l);let c=C.Vector3[8];v.TransformCoordinatesFromFloatsToRef(e,i,s,l,c);let d=this.getClosestFacetAtLocalCoordinates(c.x,c.y,c.z,r,a,o);return r&&v.TransformCoordinatesFromFloatsToRef(r.x,r.y,r.z,h,r),d}getClosestFacetAtLocalCoordinates(e,i,s,r,a=!1,o=!0){let h=null,l=0,c=0,d=0,u=0,f=0,_=0,g=0,p=0,E=this.getFacetLocalPositions(),T=this.getFacetLocalNormals(),R=this.getFacetsAtLocalCoordinates(e,i,s);if(!R)return null;let y=Number.MAX_VALUE,M=y,b,x,F;for(let I=0;I<R.length;I++)b=R[I],x=T[b],F=E[b],u=(e-F.x)*x.x+(i-F.y)*x.y+(s-F.z)*x.z,(!a||a&&o&&u>=0||a&&!o&&u<=0)&&(u=x.x*F.x+x.y*F.y+x.z*F.z,f=-(x.x*e+x.y*i+x.z*s-u)/(x.x*x.x+x.y*x.y+x.z*x.z),_=e+x.x*f,g=i+x.y*f,p=s+x.z*f,l=_-e,c=g-i,d=p-s,M=l*l+c*c+d*d,M<y&&(y=M,h=b,r&&(r.x=_,r.y=g,r.z=p)));return h}getFacetDataParameters(){return this._internalAbstractMeshDataInfo._facetData.facetParameters}disableFacetData(){let e=this._internalAbstractMeshDataInfo._facetData;return e.facetDataEnabled&&(e.facetDataEnabled=!1,e.facetPositions=new Array,e.facetNormals=new Array,e.facetPartitioning=new Array,e.facetParameters=null,e.depthSortedIndices=new Uint32Array(0)),this}updateIndices(e,i,s=!1){return this}createNormals(e){let i=this.getVerticesData(m.PositionKind),s=this.getIndices(),r;return this.isVerticesDataPresent(m.NormalKind)?r=this.getVerticesData(m.NormalKind):r=[],pe.ComputeNormals(i,s,r,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(m.NormalKind,r,e),this}alignWithNormal(e,i){i||(i=wt.Y);let s=C.Vector3[0],r=C.Vector3[1];return v.CrossToRef(i,e,r),v.CrossToRef(e,r,s),this.rotationQuaternion?se.RotationQuaternionFromAxisToRef(s,e,r,this.rotationQuaternion):v.RotationFromAxisToRef(s,e,r,this.rotation),this}_checkOcclusionQuery(){return!1}disableEdgesRendering(){throw H("EdgesRenderer")}enableEdgesRendering(e,i,s){throw H("EdgesRenderer")}getConnectedParticleSystems(){return this._scene.particleSystems.filter(e=>e.emitter===this)}}return n.OCCLUSION_TYPE_NONE=0,n.OCCLUSION_TYPE_OPTIMISTIC=1,n.OCCLUSION_TYPE_STRICT=2,n.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0,n.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1,n.CULLINGSTRATEGY_STANDARD=0,n.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,n.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,n.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,n})();Ye("BABYLON.AbstractMesh",Qr);function xs(n){n.indexOf("vClipPlane")===-1&&n.push("vClipPlane"),n.indexOf("vClipPlane2")===-1&&n.push("vClipPlane2"),n.indexOf("vClipPlane3")===-1&&n.push("vClipPlane3"),n.indexOf("vClipPlane4")===-1&&n.push("vClipPlane4"),n.indexOf("vClipPlane5")===-1&&n.push("vClipPlane5"),n.indexOf("vClipPlane6")===-1&&n.push("vClipPlane6")}function $r(n,t,e){var i,s,r,a,o,h;let l=!1,c=(i=n.clipPlane)!==null&&i!==void 0?i:t.clipPlane;return l=ti(c,e,"CLIPPLANE")||l,c=(s=n.clipPlane2)!==null&&s!==void 0?s:t.clipPlane2,l=ti(c,e,"CLIPPLANE2")||l,c=(r=n.clipPlane3)!==null&&r!==void 0?r:t.clipPlane3,l=ti(c,e,"CLIPPLANE3")||l,c=(a=n.clipPlane4)!==null&&a!==void 0?a:t.clipPlane4,l=ti(c,e,"CLIPPLANE4")||l,c=(o=n.clipPlane5)!==null&&o!==void 0?o:t.clipPlane5,l=ti(c,e,"CLIPPLANE5")||l,c=(h=n.clipPlane6)!==null&&h!==void 0?h:t.clipPlane6,l=ti(c,e,"CLIPPLANE6")||l,l}function Ms(n,t,e){var i,s,r,a,o,h;let l=(i=t.clipPlane)!==null&&i!==void 0?i:e.clipPlane;ei(n,"vClipPlane",l),l=(s=t.clipPlane2)!==null&&s!==void 0?s:e.clipPlane2,ei(n,"vClipPlane2",l),l=(r=t.clipPlane3)!==null&&r!==void 0?r:e.clipPlane3,ei(n,"vClipPlane3",l),l=(a=t.clipPlane4)!==null&&a!==void 0?a:e.clipPlane4,ei(n,"vClipPlane4",l),l=(o=t.clipPlane5)!==null&&o!==void 0?o:e.clipPlane5,ei(n,"vClipPlane5",l),l=(h=t.clipPlane6)!==null&&h!==void 0?h:e.clipPlane6,ei(n,"vClipPlane6",l)}function ei(n,t,e){e&&n.setFloat4(t,e.normal.x,e.normal.y,e.normal.z,e.d)}function ti(n,t,e){let i=!0;if(n)if(Array.isArray(t)){let s="#define "+e;i=t.indexOf(s)!==-1,i||t.push(s)}else i=t[e],t[e]=!0;return!i}var K=class n{static BindSceneUniformBuffer(t,e){e.bindToEffect(t,"Scene")}static PrepareDefinesForMergedUV(t,e,i){e._needUVs=!0,e[i]=!0,t.optimizeUVAllocation&&t.getTextureMatrix().isIdentityAs3x2()?(e[i+"DIRECTUV"]=t.coordinatesIndex+1,e["MAINUV"+(t.coordinatesIndex+1)]=!0):e[i+"DIRECTUV"]=0}static BindTextureMatrix(t,e,i){let s=t.getTextureMatrix();e.updateMatrix(i+"Matrix",s)}static GetFogState(t,e){return e.fogEnabled&&t.applyFog&&e.fogMode!==te.FOGMODE_NONE}static PrepareDefinesForMisc(t,e,i,s,r,a,o){o._areMiscDirty&&(o.LOGARITHMICDEPTH=i,o.POINTSIZE=s,o.FOG=r&&this.GetFogState(t,e),o.NONUNIFORMSCALING=t.nonUniformScaling,o.ALPHATEST=a)}static PrepareDefinesForCamera(t,e){let i=!1;if(t.activeCamera){let s=e.CAMERA_ORTHOGRAPHIC?1:0,r=e.CAMERA_PERSPECTIVE?1:0,a=t.activeCamera.mode===ne.ORTHOGRAPHIC_CAMERA?1:0,o=t.activeCamera.mode===ne.PERSPECTIVE_CAMERA?1:0;(s^a||r^o)&&(e.CAMERA_ORTHOGRAPHIC=a===1,e.CAMERA_PERSPECTIVE=o===1,i=!0)}return i}static PrepareDefinesForFrameBoundValues(t,e,i,s,r,a=null,o=!1){let h=n.PrepareDefinesForCamera(t,s);a!==!1&&(h=$r(i,t,s)),s.DEPTHPREPASS!==!e.getColorWrite()&&(s.DEPTHPREPASS=!s.DEPTHPREPASS,h=!0),s.INSTANCES!==r&&(s.INSTANCES=r,h=!0),s.THIN_INSTANCES!==o&&(s.THIN_INSTANCES=o,h=!0),h&&s.markAsUnprocessed()}static PrepareDefinesForBones(t,e){if(t.useBones&&t.computeBonesUsingShaders&&t.skeleton){e.NUM_BONE_INFLUENCERS=t.numBoneInfluencers;let i=e.BONETEXTURE!==void 0;if(t.skeleton.isUsingTextureForMatrices&&i)e.BONETEXTURE=!0;else{e.BonesPerMesh=t.skeleton.bones.length+1,e.BONETEXTURE=i?!1:void 0;let s=t.getScene().prePassRenderer;if(s&&s.enabled){let r=s.excludedSkinnedMesh.indexOf(t)===-1;e.BONES_VELOCITY_ENABLED=r}}}else e.NUM_BONE_INFLUENCERS=0,e.BonesPerMesh=0,e.BONETEXTURE!==void 0&&(e.BONETEXTURE=!1)}static PrepareDefinesForMorphTargets(t,e){let i=t.morphTargetManager;i?(e.MORPHTARGETS_UV=i.supportsUVs&&e.UV1,e.MORPHTARGETS_TANGENT=i.supportsTangents&&e.TANGENT,e.MORPHTARGETS_NORMAL=i.supportsNormals&&e.NORMAL,e.MORPHTARGETS=i.numInfluencers>0,e.NUM_MORPH_INFLUENCERS=i.numInfluencers,e.MORPHTARGETS_TEXTURE=i.isUsingTextureForTargets):(e.MORPHTARGETS_UV=!1,e.MORPHTARGETS_TANGENT=!1,e.MORPHTARGETS_NORMAL=!1,e.MORPHTARGETS=!1,e.NUM_MORPH_INFLUENCERS=0)}static PrepareDefinesForBakedVertexAnimation(t,e){let i=t.bakedVertexAnimationManager;e.BAKED_VERTEX_ANIMATION_TEXTURE=!!(i&&i.isEnabled)}static PrepareDefinesForAttributes(t,e,i,s,r=!1,a=!0,o=!0){if(!e._areAttributesDirty&&e._needNormals===e._normals&&e._needUVs===e._uvs)return!1;e._normals=e._needNormals,e._uvs=e._needUVs,e.NORMAL=e._needNormals&&t.isVerticesDataPresent(m.NormalKind),e._needNormals&&t.isVerticesDataPresent(m.TangentKind)&&(e.TANGENT=!0);for(let h=1;h<=6;++h)e["UV"+h]=e._needUVs?t.isVerticesDataPresent(`uv${h===1?"":h}`):!1;if(i){let h=t.useVertexColors&&t.isVerticesDataPresent(m.ColorKind);e.VERTEXCOLOR=h,e.VERTEXALPHA=t.hasVertexAlpha&&h&&a}return t.isVerticesDataPresent(m.ColorInstanceKind)&&(t.hasInstances||t.hasThinInstances)&&(e.INSTANCESCOLOR=!0),s&&this.PrepareDefinesForBones(t,e),r&&this.PrepareDefinesForMorphTargets(t,e),o&&this.PrepareDefinesForBakedVertexAnimation(t,e),!0}static PrepareDefinesForMultiview(t,e){if(t.activeCamera){let i=e.MULTIVIEW;e.MULTIVIEW=t.activeCamera.outputRenderTarget!==null&&t.activeCamera.outputRenderTarget.getViewCount()>1,e.MULTIVIEW!=i&&e.markAsUnprocessed()}}static PrepareDefinesForOIT(t,e,i){let s=e.ORDER_INDEPENDENT_TRANSPARENCY,r=e.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;e.ORDER_INDEPENDENT_TRANSPARENCY=t.useOrderIndependentTransparency&&i,e.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!t.getEngine().getCaps().textureFloatLinearFiltering,(s!==e.ORDER_INDEPENDENT_TRANSPARENCY||r!==e.ORDER_INDEPENDENT_TRANSPARENCY_16BITS)&&e.markAsUnprocessed()}static PrepareDefinesForPrePass(t,e,i){let s=e.PREPASS;if(!e._arePrePassDirty)return;let r=[{type:1,define:"PREPASS_POSITION",index:"PREPASS_POSITION_INDEX"},{type:2,define:"PREPASS_VELOCITY",index:"PREPASS_VELOCITY_INDEX"},{type:3,define:"PREPASS_REFLECTIVITY",index:"PREPASS_REFLECTIVITY_INDEX"},{type:0,define:"PREPASS_IRRADIANCE",index:"PREPASS_IRRADIANCE_INDEX"},{type:7,define:"PREPASS_ALBEDO_SQRT",index:"PREPASS_ALBEDO_SQRT_INDEX"},{type:5,define:"PREPASS_DEPTH",index:"PREPASS_DEPTH_INDEX"},{type:6,define:"PREPASS_NORMAL",index:"PREPASS_NORMAL_INDEX"}];if(t.prePassRenderer&&t.prePassRenderer.enabled&&i){e.PREPASS=!0,e.SCENE_MRT_COUNT=t.prePassRenderer.mrtCount;for(let a=0;a<r.length;a++){let o=t.prePassRenderer.getIndex(r[a].type);o!==-1?(e[r[a].define]=!0,e[r[a].index]=o):e[r[a].define]=!1}}else{e.PREPASS=!1;for(let a=0;a<r.length;a++)e[r[a].define]=!1}e.PREPASS!=s&&(e.markAsUnprocessed(),e.markAsImageProcessingDirty())}static PrepareDefinesForLight(t,e,i,s,r,a,o){var h;switch(o.needNormals=!0,r["LIGHT"+s]===void 0&&(o.needRebuild=!0),r["LIGHT"+s]=!0,r["SPOTLIGHT"+s]=!1,r["HEMILIGHT"+s]=!1,r["POINTLIGHT"+s]=!1,r["DIRLIGHT"+s]=!1,i.prepareLightSpecificDefines(r,s),r["LIGHT_FALLOFF_PHYSICAL"+s]=!1,r["LIGHT_FALLOFF_GLTF"+s]=!1,r["LIGHT_FALLOFF_STANDARD"+s]=!1,i.falloffType){case Me.FALLOFF_GLTF:r["LIGHT_FALLOFF_GLTF"+s]=!0;break;case Me.FALLOFF_PHYSICAL:r["LIGHT_FALLOFF_PHYSICAL"+s]=!0;break;case Me.FALLOFF_STANDARD:r["LIGHT_FALLOFF_STANDARD"+s]=!0;break}if(a&&!i.specular.equalsFloats(0,0,0)&&(o.specularEnabled=!0),r["SHADOW"+s]=!1,r["SHADOWCSM"+s]=!1,r["SHADOWCSMDEBUG"+s]=!1,r["SHADOWCSMNUM_CASCADES"+s]=!1,r["SHADOWCSMUSESHADOWMAXZ"+s]=!1,r["SHADOWCSMNOBLEND"+s]=!1,r["SHADOWCSM_RIGHTHANDED"+s]=!1,r["SHADOWPCF"+s]=!1,r["SHADOWPCSS"+s]=!1,r["SHADOWPOISSON"+s]=!1,r["SHADOWESM"+s]=!1,r["SHADOWCLOSEESM"+s]=!1,r["SHADOWCUBE"+s]=!1,r["SHADOWLOWQUALITY"+s]=!1,r["SHADOWMEDIUMQUALITY"+s]=!1,e&&e.receiveShadows&&t.shadowsEnabled&&i.shadowEnabled){let l=(h=i.getShadowGenerator(t.activeCamera))!==null&&h!==void 0?h:i.getShadowGenerator();if(l){let c=l.getShadowMap();c&&c.renderList&&c.renderList.length>0&&(o.shadowEnabled=!0,l.prepareDefines(r,s))}}i.lightmapMode!=Me.LIGHTMAP_DEFAULT?(o.lightmapMode=!0,r["LIGHTMAPEXCLUDED"+s]=!0,r["LIGHTMAPNOSPECULAR"+s]=i.lightmapMode==Me.LIGHTMAP_SHADOWSONLY):(r["LIGHTMAPEXCLUDED"+s]=!1,r["LIGHTMAPNOSPECULAR"+s]=!1)}static PrepareDefinesForLights(t,e,i,s,r=4,a=!1){if(!i._areLightsDirty)return i._needNormals;let o=0,h={needNormals:i._needNormals,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};if(t.lightsEnabled&&!a){for(let c of e.lightSources)if(this.PrepareDefinesForLight(t,e,c,o,i,s,h),o++,o===r)break}i.SPECULARTERM=h.specularEnabled,i.SHADOWS=h.shadowEnabled;for(let c=o;c<r;c++)i["LIGHT"+c]!==void 0&&(i["LIGHT"+c]=!1,i["HEMILIGHT"+c]=!1,i["POINTLIGHT"+c]=!1,i["DIRLIGHT"+c]=!1,i["SPOTLIGHT"+c]=!1,i["SHADOW"+c]=!1,i["SHADOWCSM"+c]=!1,i["SHADOWCSMDEBUG"+c]=!1,i["SHADOWCSMNUM_CASCADES"+c]=!1,i["SHADOWCSMUSESHADOWMAXZ"+c]=!1,i["SHADOWCSMNOBLEND"+c]=!1,i["SHADOWCSM_RIGHTHANDED"+c]=!1,i["SHADOWPCF"+c]=!1,i["SHADOWPCSS"+c]=!1,i["SHADOWPOISSON"+c]=!1,i["SHADOWESM"+c]=!1,i["SHADOWCLOSEESM"+c]=!1,i["SHADOWCUBE"+c]=!1,i["SHADOWLOWQUALITY"+c]=!1,i["SHADOWMEDIUMQUALITY"+c]=!1);let l=t.getEngine().getCaps();return i.SHADOWFLOAT===void 0&&(h.needRebuild=!0),i.SHADOWFLOAT=h.shadowEnabled&&(l.textureFloatRender&&l.textureFloatLinearFiltering||l.textureHalfFloatRender&&l.textureHalfFloatLinearFiltering),i.LIGHTMAPEXCLUDED=h.lightmapMode,h.needRebuild&&i.rebuild(),h.needNormals}static PrepareUniformsAndSamplersForLight(t,e,i,s,r=null,a=!1){r&&r.push("Light"+t),!a&&(e.push("vLightData"+t,"vLightDiffuse"+t,"vLightSpecular"+t,"vLightDirection"+t,"vLightFalloff"+t,"vLightGround"+t,"lightMatrix"+t,"shadowsInfo"+t,"depthValues"+t),i.push("shadowSampler"+t),i.push("depthSampler"+t),e.push("viewFrustumZ"+t,"cascadeBlendFactor"+t,"lightSizeUVCorrection"+t,"depthCorrection"+t,"penumbraDarkness"+t,"frustumLengths"+t),s&&(i.push("projectionLightSampler"+t),e.push("textureProjectionMatrix"+t)))}static PrepareUniformsAndSamplersList(t,e,i,s=4){let r,a=null;if(t.uniformsNames){let o=t;r=o.uniformsNames,a=o.uniformBuffersNames,e=o.samplers,i=o.defines,s=o.maxSimultaneousLights||0}else r=t,e||(e=[]);for(let o=0;o<s&&i["LIGHT"+o];o++)this.PrepareUniformsAndSamplersForLight(o,r,e,i["PROJECTEDLIGHTTEXTURE"+o],a);i.NUM_MORPH_INFLUENCERS&&r.push("morphTargetInfluences"),i.BAKED_VERTEX_ANIMATION_TEXTURE&&(r.push("bakedVertexAnimationSettings"),r.push("bakedVertexAnimationTextureSizeInverted"),r.push("bakedVertexAnimationTime"),e.push("bakedVertexAnimationTexture"))}static HandleFallbacksForShadows(t,e,i=4,s=0){let r=0;for(let a=0;a<i&&t["LIGHT"+a];a++)a>0&&(r=s+a,e.addFallback(r,"LIGHT"+a)),t.SHADOWS||(t["SHADOW"+a]&&e.addFallback(s,"SHADOW"+a),t["SHADOWPCF"+a]&&e.addFallback(s,"SHADOWPCF"+a),t["SHADOWPCSS"+a]&&e.addFallback(s,"SHADOWPCSS"+a),t["SHADOWPOISSON"+a]&&e.addFallback(s,"SHADOWPOISSON"+a),t["SHADOWESM"+a]&&e.addFallback(s,"SHADOWESM"+a),t["SHADOWCLOSEESM"+a]&&e.addFallback(s,"SHADOWCLOSEESM"+a));return r++}static PrepareAttributesForMorphTargetsInfluencers(t,e,i){this._TmpMorphInfluencers.NUM_MORPH_INFLUENCERS=i,this.PrepareAttributesForMorphTargets(t,e,this._TmpMorphInfluencers)}static PrepareAttributesForMorphTargets(t,e,i){let s=i.NUM_MORPH_INFLUENCERS;if(s>0&&Q.LastCreatedEngine){let r=Q.LastCreatedEngine.getCaps().maxVertexAttribs,a=e.morphTargetManager;if(a!=null&&a.isUsingTextureForTargets)return;let o=a&&a.supportsNormals&&i.NORMAL,h=a&&a.supportsTangents&&i.TANGENT,l=a&&a.supportsUVs&&i.UV1;for(let c=0;c<s;c++)t.push(m.PositionKind+c),o&&t.push(m.NormalKind+c),h&&t.push(m.TangentKind+c),l&&t.push(m.UVKind+"_"+c),t.length>r&&O.Error("Cannot add more vertex attributes for mesh "+e.name)}}static PrepareAttributesForBakedVertexAnimation(t,e,i){i.BAKED_VERTEX_ANIMATION_TEXTURE&&i.INSTANCES&&t.push("bakedVertexAnimationSettingsInstanced")}static PrepareAttributesForBones(t,e,i,s){i.NUM_BONE_INFLUENCERS>0&&(s.addCPUSkinningFallback(0,e),t.push(m.MatricesIndicesKind),t.push(m.MatricesWeightsKind),i.NUM_BONE_INFLUENCERS>4&&(t.push(m.MatricesIndicesExtraKind),t.push(m.MatricesWeightsExtraKind)))}static PrepareAttributesForInstances(t,e){(e.INSTANCES||e.THIN_INSTANCES)&&this.PushAttributesForInstances(t,!!e.PREPASS_VELOCITY),e.INSTANCESCOLOR&&t.push(m.ColorInstanceKind)}static PushAttributesForInstances(t,e=!1){t.push("world0"),t.push("world1"),t.push("world2"),t.push("world3"),e&&(t.push("previousWorld0"),t.push("previousWorld1"),t.push("previousWorld2"),t.push("previousWorld3"))}static BindLightProperties(t,e,i){t.transferToEffect(e,i+"")}static BindLight(t,e,i,s,r,a=!0){t._bindLight(e,i,s,r,a)}static BindLights(t,e,i,s,r=4){let a=Math.min(e.lightSources.length,r);for(let o=0;o<a;o++){let h=e.lightSources[o];this.BindLight(h,o,t,i,typeof s=="boolean"?s:s.SPECULARTERM,e.receiveShadows)}}static BindFogParameters(t,e,i,s=!1){t.fogEnabled&&e.applyFog&&t.fogMode!==te.FOGMODE_NONE&&(i.setFloat4("vFogInfos",t.fogMode,t.fogStart,t.fogEnd,t.fogDensity),s?(t.fogColor.toLinearSpaceToRef(this._TempFogColor),i.setColor3("vFogColor",this._TempFogColor)):i.setColor3("vFogColor",t.fogColor))}static BindBonesParameters(t,e,i){if(!(!e||!t)&&(t.computeBonesUsingShaders&&e._bonesComputationForcedToCPU&&(t.computeBonesUsingShaders=!1),t.useBones&&t.computeBonesUsingShaders&&t.skeleton)){let s=t.skeleton;if(s.isUsingTextureForMatrices&&e.getUniformIndex("boneTextureWidth")>-1){let r=s.getTransformMatrixTexture(t);e.setTexture("boneSampler",r),e.setFloat("boneTextureWidth",4*(s.bones.length+1))}else{let r=s.getTransformMatrices(t);r&&(e.setMatrices("mBones",r),i&&t.getScene().prePassRenderer&&t.getScene().prePassRenderer.getIndex(2)&&(i.previousBones[t.uniqueId]||(i.previousBones[t.uniqueId]=r.slice()),e.setMatrices("mPreviousBones",i.previousBones[t.uniqueId]),n._CopyBonesTransformationMatrices(r,i.previousBones[t.uniqueId])))}}}static _CopyBonesTransformationMatrices(t,e){return e.set(t),e}static BindMorphTargetParameters(t,e){let i=t.morphTargetManager;!t||!i||e.setFloatArray("morphTargetInfluences",i.influences)}static BindLogDepth(t,e,i){if(!t||t.LOGARITHMICDEPTH||t.indexOf&&t.indexOf("LOGARITHMICDEPTH")>=0){let s=i.activeCamera;s.mode===ne.ORTHOGRAPHIC_CAMERA&&O.Error("Logarithmic depth is not compatible with orthographic cameras!",20),e.setFloat("logarithmicDepthConstant",2/(Math.log(s.maxZ+1)/Math.LN2))}}};K._TmpMorphInfluencers={NUM_MORPH_INFLUENCERS:0};K._TempFogColor=me.Black();var ct=class{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=519,this.funcRef=1,this.funcMask=255,this.opStencilFail=7680,this.opDepthFail=7680,this.opStencilDepthPass=7681}get func(){return this._func}set func(t){this._func=t}get funcRef(){return this._funcRef}set funcRef(t){this._funcRef=t}get funcMask(){return this._funcMask}set funcMask(t){this._funcMask=t}get opStencilFail(){return this._opStencilFail}set opStencilFail(t){this._opStencilFail=t}get opDepthFail(){return this._opDepthFail}set opDepthFail(t){this._opDepthFail=t}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(t){this._opStencilDepthPass=t}get mask(){return this._mask}set mask(t){this._mask=t}get enabled(){return this._enabled}set enabled(t){this._enabled=t}getClassName(){return"MaterialStencilState"}copyTo(t){ee.Clone(()=>t,this)}serialize(){return ee.Serialize(this)}parse(t,e,i){ee.Parse(()=>this,t,e,i)}};S([A()],ct.prototype,"func",null);S([A()],ct.prototype,"funcRef",null);S([A()],ct.prototype,"funcMask",null);S([A()],ct.prototype,"opStencilFail",null);S([A()],ct.prototype,"opDepthFail",null);S([A()],ct.prototype,"opStencilDepthPass",null);S([A()],ct.prototype,"mask",null);S([A()],ct.prototype,"enabled",null);var Ue;(function(n){n[n.Created=1]="Created",n[n.Disposed=2]="Disposed",n[n.GetDefineNames=4]="GetDefineNames",n[n.PrepareUniformBuffer=8]="PrepareUniformBuffer",n[n.IsReadyForSubMesh=16]="IsReadyForSubMesh",n[n.PrepareDefines=32]="PrepareDefines",n[n.BindForSubMesh=64]="BindForSubMesh",n[n.PrepareEffect=128]="PrepareEffect",n[n.GetAnimatables=256]="GetAnimatables",n[n.GetActiveTextures=512]="GetActiveTextures",n[n.HasTexture=1024]="HasTexture",n[n.FillRenderTargetTextures=2048]="FillRenderTargetTextures",n[n.HasRenderTargetTextures=4096]="HasRenderTargetTextures",n[n.HardBindForSubMesh=8192]="HardBindForSubMesh"})(Ue||(Ue={}));var B=class n{constructor(t,e,i){this.shadowDepthWrapper=null,this.allowShaderHotSwapping=!0,this.metadata=null,this.reservedDataStore=null,this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state="",this._alpha=1,this._backFaceCulling=!0,this._cullBackFaces=!0,this._blockDirtyMechanism=!1,this.onCompiled=null,this.onError=null,this.getRenderTargetTextures=null,this.doNotSerialize=!1,this._storeEffectOnSubMeshes=!1,this.animations=null,this.onDisposeObservable=new D,this._onDisposeObserver=null,this._onUnBindObservable=null,this._onBindObserver=null,this._alphaMode=2,this._needDepthPrePass=!1,this.disableDepthWrite=!1,this.disableColorWrite=!1,this.forceDepthWrite=!1,this.depthFunction=0,this.separateCullingPass=!1,this._fogEnabled=!0,this.pointSize=1,this.zOffset=0,this.zOffsetUnits=0,this.stencil=new ct,this._useUBO=!1,this._fillMode=n.TriangleFillMode,this._cachedDepthWriteState=!1,this._cachedColorWriteState=!1,this._cachedDepthFunctionState=0,this._indexInSceneMaterialArray=-1,this.meshMap=null,this._parentContainer=null,this._uniformBufferLayoutBuilt=!1,this._eventInfo={},this._callbackPluginEventGeneric=()=>{},this._callbackPluginEventIsReadyForSubMesh=()=>{},this._callbackPluginEventPrepareDefines=()=>{},this._callbackPluginEventPrepareDefinesBeforeAttributes=()=>{},this._callbackPluginEventHardBindForSubMesh=()=>{},this._callbackPluginEventBindForSubMesh=()=>{},this._callbackPluginEventHasRenderTargetTextures=()=>{},this._callbackPluginEventFillRenderTargetTextures=()=>{},this._forceAlphaTest=!1,this._transparencyMode=null,this.name=t;let s=e||Q.LastCreatedScene;s&&(this._scene=s,this._dirtyCallbacks={},this._dirtyCallbacks[1]=this._markAllSubMeshesAsTexturesDirty.bind(this),this._dirtyCallbacks[2]=this._markAllSubMeshesAsLightsDirty.bind(this),this._dirtyCallbacks[4]=this._markAllSubMeshesAsFresnelDirty.bind(this),this._dirtyCallbacks[8]=this._markAllSubMeshesAsAttributesDirty.bind(this),this._dirtyCallbacks[16]=this._markAllSubMeshesAsMiscDirty.bind(this),this._dirtyCallbacks[32]=this._markAllSubMeshesAsPrePassDirty.bind(this),this._dirtyCallbacks[63]=this._markAllSubMeshesAsAllDirty.bind(this),this.id=t||Z.RandomId(),this.uniqueId=this._scene.getUniqueId(),this._materialContext=this._scene.getEngine().createMaterialContext(),this._drawWrapper=new Wt(this._scene.getEngine(),!1),this._drawWrapper.materialContext=this._materialContext,this._scene.useRightHandedSystem?this.sideOrientation=n.ClockWiseSideOrientation:this.sideOrientation=n.CounterClockWiseSideOrientation,this._uniformBuffer=new Qe(this._scene.getEngine(),void 0,void 0,t),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,i||this._scene.addMaterial(this),this._scene.useMaterialMeshMap&&(this.meshMap={}),n.OnEventObservable.notifyObservers(this,Ue.Created))}get canRenderToMRT(){return!1}set alpha(t){if(this._alpha===t)return;let e=this._alpha;this._alpha=t,(e===1||t===1)&&this.markAsDirty(n.MiscDirtyFlag)}get alpha(){return this._alpha}set backFaceCulling(t){this._backFaceCulling!==t&&(this._backFaceCulling=t,this.markAsDirty(n.TextureDirtyFlag))}get backFaceCulling(){return this._backFaceCulling}set cullBackFaces(t){this._cullBackFaces!==t&&(this._cullBackFaces=t,this.markAsDirty(n.TextureDirtyFlag))}get cullBackFaces(){return this._cullBackFaces}get blockDirtyMechanism(){return this._blockDirtyMechanism}set blockDirtyMechanism(t){this._blockDirtyMechanism!==t&&(this._blockDirtyMechanism=t,t||this.markDirty())}atomicMaterialsUpdate(t){this.blockDirtyMechanism=!0;try{t(this)}finally{this.blockDirtyMechanism=!1}}get hasRenderTargetTextures(){return this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._eventInfo.hasRenderTargetTextures}set onDispose(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new D),this._onBindObservable}set onBind(t){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(t)}get onUnBindObservable(){return this._onUnBindObservable||(this._onUnBindObservable=new D),this._onUnBindObservable}get onEffectCreatedObservable(){return this._onEffectCreatedObservable||(this._onEffectCreatedObservable=new D),this._onEffectCreatedObservable}set alphaMode(t){this._alphaMode!==t&&(this._alphaMode=t,this.markAsDirty(n.TextureDirtyFlag))}get alphaMode(){return this._alphaMode}set needDepthPrePass(t){this._needDepthPrePass!==t&&(this._needDepthPrePass=t,this._needDepthPrePass&&(this.checkReadyOnEveryCall=!0))}get needDepthPrePass(){return this._needDepthPrePass}get isPrePassCapable(){return!1}set fogEnabled(t){this._fogEnabled!==t&&(this._fogEnabled=t,this.markAsDirty(n.MiscDirtyFlag))}get fogEnabled(){return this._fogEnabled}get wireframe(){switch(this._fillMode){case n.WireFrameFillMode:case n.LineListDrawMode:case n.LineLoopDrawMode:case n.LineStripDrawMode:return!0}return this._scene.forceWireframe}set wireframe(t){this.fillMode=t?n.WireFrameFillMode:n.TriangleFillMode}get pointsCloud(){switch(this._fillMode){case n.PointFillMode:case n.PointListDrawMode:return!0}return this._scene.forcePointsCloud}set pointsCloud(t){this.fillMode=t?n.PointFillMode:n.TriangleFillMode}get fillMode(){return this._fillMode}set fillMode(t){this._fillMode!==t&&(this._fillMode=t,this.markAsDirty(n.MiscDirtyFlag))}_getDrawWrapper(){return this._drawWrapper}_setDrawWrapper(t){this._drawWrapper=t}toString(t){return"Name: "+this.name}getClassName(){return"Material"}get _isMaterial(){return!0}get isFrozen(){return this.checkReadyOnlyOnce}freeze(){this.markDirty(),this.checkReadyOnlyOnce=!0}unfreeze(){this.markDirty(),this.checkReadyOnlyOnce=!1}isReady(t,e){return!0}isReadyForSubMesh(t,e,i){let s=e.materialDefines;return s?(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=s,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),this._eventInfo.isReadyForSubMesh):!1}getEffect(){return this._drawWrapper.effect}getScene(){return this._scene}get transparencyMode(){return this._transparencyMode}set transparencyMode(t){this._transparencyMode!==t&&(this._transparencyMode=t,this._forceAlphaTest=t===n.MATERIAL_ALPHATESTANDBLEND,this._markAllSubMeshesAsTexturesAndMiscDirty())}get _disableAlphaBlending(){return this._transparencyMode===n.MATERIAL_OPAQUE||this._transparencyMode===n.MATERIAL_ALPHATEST}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1}needAlphaBlendingForMesh(t){return t.visibility<1?!0:this._disableAlphaBlending?!1:t.hasVertexAlpha||this.needAlphaBlending()}needAlphaTesting(){return!!this._forceAlphaTest}_shouldTurnAlphaTestOn(t){return!this.needAlphaBlendingForMesh(t)&&this.needAlphaTesting()}getAlphaTestTexture(){return null}markDirty(t=!1){let e=this.getScene().meshes;for(let i of e)if(i.subMeshes)for(let s of i.subMeshes)s.getMaterial()===this&&s.effect&&(s.effect._wasPreviouslyReady=!1,s.effect._wasPreviouslyUsingInstances=null,s.effect._forceRebindOnNextCall=t);t&&this.markAsDirty(n.AllDirtyFlag)}_preBind(t,e=null){let i=this._scene.getEngine(),s=(e??this.sideOrientation)===n.ClockWiseSideOrientation;return i.enableEffect(t||this._getDrawWrapper()),i.setState(this.backFaceCulling,this.zOffset,!1,s,this._scene._mirroredCameraPosition?!this.cullBackFaces:this.cullBackFaces,this.stencil,this.zOffsetUnits),s}bind(t,e){}buildUniformLayout(){let t=this._uniformBuffer;this._eventInfo.ubo=t,this._callbackPluginEventGeneric(Ue.PrepareUniformBuffer,this._eventInfo),t.create(),this._uniformBufferLayoutBuilt=!0}bindForSubMesh(t,e,i){let s=i.effect;s&&(this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),s._forceRebindOnNextCall=!1)}bindOnlyWorldMatrix(t){}bindView(t){this._useUBO?this._needToBindSceneUbo=!0:t.setMatrix("view",this.getScene().getViewMatrix())}bindViewProjection(t){this._useUBO?this._needToBindSceneUbo=!0:(t.setMatrix("viewProjection",this.getScene().getTransformMatrix()),t.setMatrix("projection",this.getScene().getProjectionMatrix()))}bindEyePosition(t,e){this._useUBO?this._needToBindSceneUbo=!0:this._scene.bindEyePosition(t,e)}_afterBind(t,e=null){if(this._scene._cachedMaterial=this,this._needToBindSceneUbo&&e&&(this._needToBindSceneUbo=!1,K.BindSceneUniformBuffer(e,this.getScene().getSceneUniformBuffer()),this._scene.finalizeSceneUbo()),t?this._scene._cachedVisibility=t.visibility:this._scene._cachedVisibility=1,this._onBindObservable&&t&&this._onBindObservable.notifyObservers(t),this.disableDepthWrite){let i=this._scene.getEngine();this._cachedDepthWriteState=i.getDepthWrite(),i.setDepthWrite(!1)}if(this.disableColorWrite){let i=this._scene.getEngine();this._cachedColorWriteState=i.getColorWrite(),i.setColorWrite(!1)}if(this.depthFunction!==0){let i=this._scene.getEngine();this._cachedDepthFunctionState=i.getDepthFunction()||0,i.setDepthFunction(this.depthFunction)}}unbind(){this._onUnBindObservable&&this._onUnBindObservable.notifyObservers(this),this.depthFunction!==0&&this._scene.getEngine().setDepthFunction(this._cachedDepthFunctionState),this.disableDepthWrite&&this._scene.getEngine().setDepthWrite(this._cachedDepthWriteState),this.disableColorWrite&&this._scene.getEngine().setColorWrite(this._cachedColorWriteState)}getAnimatables(){return this._eventInfo.animatables=[],this._callbackPluginEventGeneric(Ue.GetAnimatables,this._eventInfo),this._eventInfo.animatables}getActiveTextures(){return this._eventInfo.activeTextures=[],this._callbackPluginEventGeneric(Ue.GetActiveTextures,this._eventInfo),this._eventInfo.activeTextures}hasTexture(t){return this._eventInfo.hasTexture=!1,this._eventInfo.texture=t,this._callbackPluginEventGeneric(Ue.HasTexture,this._eventInfo),this._eventInfo.hasTexture}clone(t){return null}getBindedMeshes(){if(this.meshMap){let t=new Array;for(let e in this.meshMap){let i=this.meshMap[e];i&&t.push(i)}return t}else return this._scene.meshes.filter(t=>t.material===this)}forceCompilation(t,e,i,s){let r=Xe({clipPlane:!1,useInstances:!1},i),a=this.getScene(),o=this.allowShaderHotSwapping;this.allowShaderHotSwapping=!1;let h=()=>{if(!this._scene||!this._scene.getEngine())return;let l=a.clipPlane;if(r.clipPlane&&(a.clipPlane=new _i(0,0,0,1)),this._storeEffectOnSubMeshes){let c=!0,d=null;if(t.subMeshes){let u=new gt(0,0,0,0,0,t,void 0,!1,!1);u.materialDefines&&(u.materialDefines._renderId=-1),this.isReadyForSubMesh(t,u,r.useInstances)||(u.effect&&u.effect.getCompilationError()&&u.effect.allFallbacksProcessed()?d=u.effect.getCompilationError():(c=!1,setTimeout(h,16)))}c&&(this.allowShaderHotSwapping=o,d&&s&&s(d),e&&e(this))}else this.isReady()?(this.allowShaderHotSwapping=o,e&&e(this)):setTimeout(h,16);r.clipPlane&&(a.clipPlane=l)};h()}forceCompilationAsync(t,e){return new Promise((i,s)=>{this.forceCompilation(t,()=>{i()},e,r=>{s(r)})})}markAsDirty(t){this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism||(n._DirtyCallbackArray.length=0,t&n.TextureDirtyFlag&&n._DirtyCallbackArray.push(n._TextureDirtyCallBack),t&n.LightDirtyFlag&&n._DirtyCallbackArray.push(n._LightsDirtyCallBack),t&n.FresnelDirtyFlag&&n._DirtyCallbackArray.push(n._FresnelDirtyCallBack),t&n.AttributesDirtyFlag&&n._DirtyCallbackArray.push(n._AttributeDirtyCallBack),t&n.MiscDirtyFlag&&n._DirtyCallbackArray.push(n._MiscDirtyCallBack),t&n.PrePassDirtyFlag&&n._DirtyCallbackArray.push(n._PrePassDirtyCallBack),n._DirtyCallbackArray.length&&this._markAllSubMeshesAsDirty(n._RunDirtyCallBacks),this.getScene().resetCachedMaterial())}resetDrawCache(){let t=this.getScene().meshes;for(let e of t)if(e.subMeshes)for(let i of e.subMeshes)i.getMaterial()===this&&i.resetDrawCache()}_markAllSubMeshesAsDirty(t){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;let e=this.getScene().meshes;for(let i of e)if(i.subMeshes){for(let s of i.subMeshes)if(s.getMaterial(!1)===this)for(let r of s._drawWrappers)!r||!r.defines||!r.defines.markAllAsDirty||this._materialContext===r.materialContext&&t(r.defines)}}_markScenePrePassDirty(){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;let t=this.getScene().enablePrePassRenderer();t&&t.markAsDirty()}_markAllSubMeshesAsAllDirty(){this._markAllSubMeshesAsDirty(n._AllDirtyCallBack)}_markAllSubMeshesAsImageProcessingDirty(){this._markAllSubMeshesAsDirty(n._ImageProcessingDirtyCallBack)}_markAllSubMeshesAsTexturesDirty(){this._markAllSubMeshesAsDirty(n._TextureDirtyCallBack)}_markAllSubMeshesAsFresnelDirty(){this._markAllSubMeshesAsDirty(n._FresnelDirtyCallBack)}_markAllSubMeshesAsFresnelAndMiscDirty(){this._markAllSubMeshesAsDirty(n._FresnelAndMiscDirtyCallBack)}_markAllSubMeshesAsLightsDirty(){this._markAllSubMeshesAsDirty(n._LightsDirtyCallBack)}_markAllSubMeshesAsAttributesDirty(){this._markAllSubMeshesAsDirty(n._AttributeDirtyCallBack)}_markAllSubMeshesAsMiscDirty(){this._markAllSubMeshesAsDirty(n._MiscDirtyCallBack)}_markAllSubMeshesAsPrePassDirty(){this._markAllSubMeshesAsDirty(n._MiscDirtyCallBack)}_markAllSubMeshesAsTexturesAndMiscDirty(){this._markAllSubMeshesAsDirty(n._TextureAndMiscDirtyCallBack)}setPrePassRenderer(t){return!1}dispose(t,e,i){let s=this.getScene();if(s.stopAnimation(this),s.freeProcessedMaterials(),s.removeMaterial(this),this._eventInfo.forceDisposeTextures=e,this._callbackPluginEventGeneric(Ue.Disposed,this._eventInfo),this._parentContainer){let r=this._parentContainer.materials.indexOf(this);r>-1&&this._parentContainer.materials.splice(r,1),this._parentContainer=null}if(i!==!0)if(this.meshMap)for(let r in this.meshMap){let a=this.meshMap[r];a&&(a.material=null,this.releaseVertexArrayObject(a,t))}else{let r=s.meshes;for(let a of r)a.material===this&&!a.sourceMesh&&(a.material=null,this.releaseVertexArrayObject(a,t))}this._uniformBuffer.dispose(),t&&this._drawWrapper.effect&&(this._storeEffectOnSubMeshes||this._drawWrapper.effect.dispose(),this._drawWrapper.effect=null),this.metadata=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._onBindObservable&&this._onBindObservable.clear(),this._onUnBindObservable&&this._onUnBindObservable.clear(),this._onEffectCreatedObservable&&this._onEffectCreatedObservable.clear(),this._eventInfo&&(this._eventInfo={})}releaseVertexArrayObject(t,e){if(t.geometry){let i=t.geometry;if(this._storeEffectOnSubMeshes)for(let s of t.subMeshes)i._releaseVertexArrayObject(s.effect),e&&s.effect&&s.effect.dispose();else i._releaseVertexArrayObject(this._drawWrapper.effect)}}serialize(){let t=ee.Serialize(this);return t.stencil=this.stencil.serialize(),t.uniqueId=this.uniqueId,t}static Parse(t,e,i){if(!t.customType)t.customType="BABYLON.StandardMaterial";else if(t.customType==="BABYLON.PBRMaterial"&&t.overloadedAlbedo&&(t.customType="BABYLON.LegacyPBRMaterial",!BABYLON.LegacyPBRMaterial))return O.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library."),null;let s=Z.Instantiate(t.customType).Parse(t,e,i);return s._loadedUniqueId=t.uniqueId,s}};B.TriangleFillMode=0;B.WireFrameFillMode=1;B.PointFillMode=2;B.PointListDrawMode=3;B.LineListDrawMode=4;B.LineLoopDrawMode=5;B.LineStripDrawMode=6;B.TriangleStripDrawMode=7;B.TriangleFanDrawMode=8;B.ClockWiseSideOrientation=0;B.CounterClockWiseSideOrientation=1;B.TextureDirtyFlag=1;B.LightDirtyFlag=2;B.FresnelDirtyFlag=4;B.AttributesDirtyFlag=8;B.MiscDirtyFlag=16;B.PrePassDirtyFlag=32;B.AllDirtyFlag=63;B.MATERIAL_OPAQUE=0;B.MATERIAL_ALPHATEST=1;B.MATERIAL_ALPHABLEND=2;B.MATERIAL_ALPHATESTANDBLEND=3;B.MATERIAL_NORMALBLENDMETHOD_WHITEOUT=0;B.MATERIAL_NORMALBLENDMETHOD_RNM=1;B.OnEventObservable=new D;B._AllDirtyCallBack=n=>n.markAllAsDirty();B._ImageProcessingDirtyCallBack=n=>n.markAsImageProcessingDirty();B._TextureDirtyCallBack=n=>n.markAsTexturesDirty();B._FresnelDirtyCallBack=n=>n.markAsFresnelDirty();B._MiscDirtyCallBack=n=>n.markAsMiscDirty();B._PrePassDirtyCallBack=n=>n.markAsPrePassDirty();B._LightsDirtyCallBack=n=>n.markAsLightDirty();B._AttributeDirtyCallBack=n=>n.markAsAttributesDirty();B._FresnelAndMiscDirtyCallBack=n=>{B._FresnelDirtyCallBack(n),B._MiscDirtyCallBack(n)};B._TextureAndMiscDirtyCallBack=n=>{B._TextureDirtyCallBack(n),B._MiscDirtyCallBack(n)};B._DirtyCallbackArray=[];B._RunDirtyCallBacks=n=>{for(let t of B._DirtyCallbackArray)t(n)};S([A()],B.prototype,"id",void 0);S([A()],B.prototype,"uniqueId",void 0);S([A()],B.prototype,"name",void 0);S([A()],B.prototype,"metadata",void 0);S([A()],B.prototype,"checkReadyOnEveryCall",void 0);S([A()],B.prototype,"checkReadyOnlyOnce",void 0);S([A()],B.prototype,"state",void 0);S([A("alpha")],B.prototype,"_alpha",void 0);S([A("backFaceCulling")],B.prototype,"_backFaceCulling",void 0);S([A("cullBackFaces")],B.prototype,"_cullBackFaces",void 0);S([A()],B.prototype,"sideOrientation",void 0);S([A("alphaMode")],B.prototype,"_alphaMode",void 0);S([A()],B.prototype,"_needDepthPrePass",void 0);S([A()],B.prototype,"disableDepthWrite",void 0);S([A()],B.prototype,"disableColorWrite",void 0);S([A()],B.prototype,"forceDepthWrite",void 0);S([A()],B.prototype,"depthFunction",void 0);S([A()],B.prototype,"separateCullingPass",void 0);S([A("fogEnabled")],B.prototype,"_fogEnabled",void 0);S([A()],B.prototype,"pointSize",void 0);S([A()],B.prototype,"zOffset",void 0);S([A()],B.prototype,"zOffsetUnits",void 0);S([A()],B.prototype,"pointsCloud",null);S([A()],B.prototype,"fillMode",null);S([A()],B.prototype,"transparencyMode",null);var ki=class n extends B{constructor(t,e){super(t,e,!0),this._waitingSubMaterialsUniqueIds=[],this.getScene().multiMaterials.push(this),this.subMaterials=new Array,this._storeEffectOnSubMeshes=!0}get subMaterials(){return this._subMaterials}set subMaterials(t){this._subMaterials=t,this._hookArray(t)}getChildren(){return this.subMaterials}_hookArray(t){let e=t.push;t.push=(...s)=>{let r=e.apply(t,s);return this._markAllSubMeshesAsTexturesDirty(),r};let i=t.splice;t.splice=(s,r)=>{let a=i.apply(t,[s,r]);return this._markAllSubMeshesAsTexturesDirty(),a}}getSubMaterial(t){return t<0||t>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[t]}getActiveTextures(){return super.getActiveTextures().concat(...this.subMaterials.map(t=>t?t.getActiveTextures():[]))}hasTexture(t){var e;if(super.hasTexture(t))return!0;for(let i=0;i<this.subMaterials.length;i++)if(!((e=this.subMaterials[i])===null||e===void 0)&&e.hasTexture(t))return!0;return!1}getClassName(){return"MultiMaterial"}isReadyForSubMesh(t,e,i){for(let s=0;s<this.subMaterials.length;s++){let r=this.subMaterials[s];if(r){if(r._storeEffectOnSubMeshes){if(!r.isReadyForSubMesh(t,e,i))return!1;continue}if(!r.isReady(t))return!1}}return!0}clone(t,e){let i=new n(t,this.getScene());for(let s=0;s<this.subMaterials.length;s++){let r=null,a=this.subMaterials[s];e&&a?r=a.clone(t+"-"+a.name):r=this.subMaterials[s],i.subMaterials.push(r)}return i}serialize(){let t={};t.name=this.name,t.id=this.id,t.uniqueId=this.uniqueId,he&&(t.tags=he.GetTags(this)),t.materialsUniqueIds=[],t.materials=[];for(let e=0;e<this.subMaterials.length;e++){let i=this.subMaterials[e];i?(t.materialsUniqueIds.push(i.uniqueId),t.materials.push(i.id)):(t.materialsUniqueIds.push(null),t.materials.push(null))}return t}dispose(t,e,i){let s=this.getScene();if(!s)return;if(i)for(let a=0;a<this.subMaterials.length;a++){let o=this.subMaterials[a];o&&o.dispose(t,e)}let r=s.multiMaterials.indexOf(this);r>=0&&s.multiMaterials.splice(r,1),super.dispose(t,e)}static ParseMultiMaterial(t,e){let i=new n(t.name,e);return i.id=t.id,i._loadedUniqueId=t.uniqueId,he&&he.AddTagsTo(i,t.tags),t.materialsUniqueIds?i._waitingSubMaterialsUniqueIds=t.materialsUniqueIds:t.materials.forEach(s=>i.subMaterials.push(e.getLastMaterialById(s))),i}};Ye("BABYLON.MultiMaterial",ki);var Tr=class{constructor(t,e){this.distanceOrScreenCoverage=t,this.mesh=e}},Sr=class{constructor(){this.visibleInstances={},this.batchCache=new ps,this.batchCacheReplacementModeInFrozenMode=new ps,this.instancesBufferSize=32*16*4}},ps=class{constructor(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=new Array,this.hardwareInstancedRendering=new Array}},br=class{constructor(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=32*16,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}},xr=class{constructor(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0}},W=class n extends Qr{constructor(t,e=null,i=null,s=null,r,a=!0){if(super(t,e),this._internalMeshDataInfo=new xr,this.delayLoadState=0,this.instances=new Array,this._creationDataStorage=null,this._geometry=null,this._instanceDataStorage=new Sr,this._thinInstanceDataStorage=new br,this._shouldGenerateFlatShading=!1,this._originalBuilderSideOrientation=n.DEFAULTSIDE,this.overrideMaterialSideOrientation=null,this.ignoreCameraMaxZ=!1,e=this.getScene(),this._onBeforeDraw=(o,h,l)=>{o&&l&&(this._uniformBuffer?this.transferToEffect(h):l.bindOnlyWorldMatrix(h))},s){if(s._geometry&&s._geometry.applyToMesh(this),Fi.DeepCopy(s,this,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo"],["_poseMatrix"]),this._internalMeshDataInfo._source=s,e.useClonedMeshMap&&(s._internalMeshDataInfo.meshMap||(s._internalMeshDataInfo.meshMap={}),s._internalMeshDataInfo.meshMap[this.uniqueId]=this),this._originalBuilderSideOrientation=s._originalBuilderSideOrientation,this._creationDataStorage=s._creationDataStorage,s._ranges){let o=s._ranges;for(let h in o)Object.prototype.hasOwnProperty.call(o,h)&&o[h]&&this.createAnimationRange(h,o[h].from,o[h].to)}if(s.metadata&&s.metadata.clone?this.metadata=s.metadata.clone():this.metadata=s.metadata,he&&he.HasTags(s)&&he.AddTagsTo(this,he.GetTags(s,!0)),this.setEnabled(s.isEnabled(!1)),this.parent=s.parent,this.setPivotMatrix(s.getPivotMatrix()),this.id=t+"."+s.id,this.material=s.material,!r){let o=s.getDescendants(!0);for(let h=0;h<o.length;h++){let l=o[h];l.clone&&l.clone(t+"."+l.name,this)}}if(s.morphTargetManager&&(this.morphTargetManager=s.morphTargetManager),e.getPhysicsEngine){let o=e.getPhysicsEngine();if(a&&o&&o.getPluginVersion()===1){let h=o.getImpostorForPhysicsObject(s);h&&(this.physicsImpostor=h.clone(this))}}for(let o=0;o<e.particleSystems.length;o++){let h=e.particleSystems[o];h.emitter===s&&h.clone(h.name,this)}this.skeleton=s.skeleton,this.refreshBoundingInfo(!0,!0),this.computeWorldMatrix(!0)}i!==null&&(this.parent=i),this._instanceDataStorage.hardwareInstancedRendering=this.getEngine().getCaps().instancedArrays,this._internalMeshDataInfo._onMeshReadyObserverAdded=o=>{o.unregisterOnNextCall=!0,this.isReady(!0)?this.onMeshReadyObservable.notifyObservers(this):this._internalMeshDataInfo._checkReadinessObserver||(this._internalMeshDataInfo._checkReadinessObserver=this._scene.onBeforeRenderObservable.add(()=>{this.isReady(!0)&&(this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),this._internalMeshDataInfo._checkReadinessObserver=null,this.onMeshReadyObservable.notifyObservers(this))}))},this.onMeshReadyObservable=new D(this._internalMeshDataInfo._onMeshReadyObserverAdded),s&&s.onClonedObservable.notifyObservers(this)}static _GetDefaultSideOrientation(t){return t||n.FRONTSIDE}get useLODScreenCoverage(){return this._internalMeshDataInfo._useLODScreenCoverage}set useLODScreenCoverage(t){this._internalMeshDataInfo._useLODScreenCoverage=t,this._sortLODLevels()}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(t){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==t&&(t&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(m.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(m.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=t,this._markSubMeshesAsAttributesDirty())}get onBeforeRenderObservable(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new D),this._internalMeshDataInfo._onBeforeRenderObservable}get onBeforeBindObservable(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new D),this._internalMeshDataInfo._onBeforeBindObservable}get onAfterRenderObservable(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new D),this._internalMeshDataInfo._onAfterRenderObservable}get onBetweenPassObservable(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new D),this._internalMeshDataInfo._onBetweenPassObservable}get onBeforeDrawObservable(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new D),this._internalMeshDataInfo._onBeforeDrawObservable}set onBeforeDraw(t){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(t)}get hasInstances(){return this.instances.length>0}get hasThinInstances(){var t;return((t=this._thinInstanceDataStorage.instancesCount)!==null&&t!==void 0?t:0)>0}get forcedInstanceCount(){return this._internalMeshDataInfo._forcedInstanceCount}set forcedInstanceCount(t){this._internalMeshDataInfo._forcedInstanceCount=t}get source(){return this._internalMeshDataInfo._source}get cloneMeshMap(){return this._internalMeshDataInfo.meshMap}get isUnIndexed(){return this._unIndexed}set isUnIndexed(t){this._unIndexed!==t&&(this._unIndexed=t,this._markSubMeshesAsAttributesDirty())}get worldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesData}get previousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesPreviousData}get manualUpdateOfWorldMatrixInstancedBuffer(){return this._instanceDataStorage.manualUpdate}set manualUpdateOfWorldMatrixInstancedBuffer(t){this._instanceDataStorage.manualUpdate=t}get manualUpdateOfPreviousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.previousManualUpdate}set manualUpdateOfPreviousWorldMatrixInstancedBuffer(t){this._instanceDataStorage.previousManualUpdate=t}get forceWorldMatrixInstancedBufferUpdate(){return this._instanceDataStorage.forceMatrixUpdates}set forceWorldMatrixInstancedBufferUpdate(t){this._instanceDataStorage.forceMatrixUpdates=t}instantiateHierarchy(t=null,e,i){let s=this.getTotalVertices()===0||e&&e.doNotInstantiate&&(e.doNotInstantiate===!0||e.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),t||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));s.parent=t||this.parent,s.position=this.position.clone(),s.scaling=this.scaling.clone(),this.rotationQuaternion?s.rotationQuaternion=this.rotationQuaternion.clone():s.rotation=this.rotation.clone(),i&&i(this,s);for(let r of this.getChildTransformNodes(!0))r.getClassName()==="InstancedMesh"&&s.getClassName()==="Mesh"?r.instantiateHierarchy(s,{doNotInstantiate:e&&e.doNotInstantiate||!1,newSourcedMesh:s},i):r.instantiateHierarchy(s,e,i);return s}getClassName(){return"Mesh"}get _isMesh(){return!0}toString(t){let e=super.toString(t);if(e+=", n vertices: "+this.getTotalVertices(),e+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(let i=0;i<this.animations.length;i++)e+=", animation[0]: "+this.animations[i].toString(t);if(t)if(this._geometry){let i=this.getIndices(),s=this.getVerticesData(m.PositionKind);s&&i&&(e+=", flat shading: "+(s.length/3===i.length?"YES":"NO"))}else e+=", flat shading: UNKNOWN";return e}_unBindEffect(){super._unBindEffect();for(let t of this.instances)t._unBindEffect()}get hasLODLevels(){return this._internalMeshDataInfo._LODLevels.length>0}getLODLevels(){return this._internalMeshDataInfo._LODLevels}_sortLODLevels(){let t=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort((e,i)=>e.distanceOrScreenCoverage<i.distanceOrScreenCoverage?t:e.distanceOrScreenCoverage>i.distanceOrScreenCoverage?-t:0)}addLODLevel(t,e){if(e&&e._masterMesh)return O.Warn("You cannot use a mesh as LOD level twice"),this;let i=new Tr(t,e);return this._internalMeshDataInfo._LODLevels.push(i),e&&(e._masterMesh=this),this._sortLODLevels(),this}getLODLevelAtDistance(t){let e=this._internalMeshDataInfo;for(let i=0;i<e._LODLevels.length;i++){let s=e._LODLevels[i];if(s.distanceOrScreenCoverage===t)return s.mesh}return null}removeLODLevel(t){let e=this._internalMeshDataInfo;for(let i=0;i<e._LODLevels.length;i++)e._LODLevels[i].mesh===t&&(e._LODLevels.splice(i,1),t&&(t._masterMesh=null));return this._sortLODLevels(),this}getLOD(t,e){let i=this._internalMeshDataInfo;if(!i._LODLevels||i._LODLevels.length===0)return this;let s=e||this.getBoundingInfo().boundingSphere,r=t.mode===ne.ORTHOGRAPHIC_CAMERA?t.minZ:s.centerWorld.subtract(t.globalPosition).length(),a=r,o=1;if(i._useLODScreenCoverage){let h=t.screenArea,l=s.radiusWorld*t.minZ/r;l=l*l*Math.PI,a=l/h,o=-1}if(o*i._LODLevels[i._LODLevels.length-1].distanceOrScreenCoverage>o*a)return this.onLODLevelSelection&&this.onLODLevelSelection(a,this,this),this;for(let h=0;h<i._LODLevels.length;h++){let l=i._LODLevels[h];if(o*l.distanceOrScreenCoverage<o*a){if(l.mesh){if(l.mesh.delayLoadState===4)return l.mesh._checkDelayState(),this;if(l.mesh.delayLoadState===2)return this;l.mesh._preActivate(),l.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(a,this,l.mesh),l.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(a,this,this),this}get geometry(){return this._geometry}getTotalVertices(){return this._geometry===null||this._geometry===void 0?0:this._geometry.getTotalVertices()}getVerticesData(t,e,i){var s,r;if(!this._geometry)return null;let a=(r=(s=this._userInstancedBuffersStorage)===null||s===void 0?void 0:s.vertexBuffers[t])===null||r===void 0?void 0:r.getFloatData(this._geometry.getTotalVertices(),i||e&&this._geometry.meshes.length!==1);return a||(a=this._geometry.getVerticesData(t,e,i)),a}getVertexBuffer(t){var e,i;return this._geometry?(i=(e=this._userInstancedBuffersStorage)===null||e===void 0?void 0:e.vertexBuffers[t])!==null&&i!==void 0?i:this._geometry.getVertexBuffer(t):null}isVerticesDataPresent(t){var e;return this._geometry?((e=this._userInstancedBuffersStorage)===null||e===void 0?void 0:e.vertexBuffers[t])!==void 0||this._geometry.isVerticesDataPresent(t):this._delayInfo?this._delayInfo.indexOf(t)!==-1:!1}isVertexBufferUpdatable(t){var e,i;return this._geometry?((i=(e=this._userInstancedBuffersStorage)===null||e===void 0?void 0:e.vertexBuffers[t])===null||i===void 0?void 0:i.isUpdatable())||this._geometry.isVertexBufferUpdatable(t):this._delayInfo?this._delayInfo.indexOf(t)!==-1:!1}getVerticesDataKinds(){if(!this._geometry){let e=new Array;return this._delayInfo&&this._delayInfo.forEach(function(i){e.push(i)}),e}let t=this._geometry.getVerticesDataKinds();if(this._userInstancedBuffersStorage)for(let e in this._userInstancedBuffersStorage.vertexBuffers)t.push(e);return t}getTotalIndices(){return this._geometry?this._geometry.getTotalIndices():0}getIndices(t,e){return this._geometry?this._geometry.getIndices(t,e):[]}get isBlocked(){return this._masterMesh!==null&&this._masterMesh!==void 0}isReady(t=!1,e=!1){var i,s,r,a,o,h;if(this.delayLoadState===2||!super.isReady(t))return!1;if(!this.subMeshes||this.subMeshes.length===0||!t)return!0;let l=this.getEngine(),c=this.getScene(),d=e||l.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();let u=this.material||c.defaultMaterial;if(u){if(u._storeEffectOnSubMeshes)for(let _ of this.subMeshes){let g=_.getMaterial();if(g){if(g._storeEffectOnSubMeshes){if(!g.isReadyForSubMesh(this,_,d))return!1}else if(!g.isReady(this,d))return!1}}else if(!u.isReady(this,d))return!1}let f=l.currentRenderPassId;for(let _ of this.lightSources){let g=_.getShadowGenerators();if(!g)continue;let p=g.values();for(let E=p.next();E.done!==!0;E=p.next()){let T=E.value;if(T&&(!(!((i=T.getShadowMap())===null||i===void 0)&&i.renderList)||!((s=T.getShadowMap())===null||s===void 0)&&s.renderList&&((a=(r=T.getShadowMap())===null||r===void 0?void 0:r.renderList)===null||a===void 0?void 0:a.indexOf(this))!==-1)){T.getShadowMap()&&(l.currentRenderPassId=T.getShadowMap().renderPassId);for(let R of this.subMeshes)if(!T.isReady(R,d,(h=(o=R.getMaterial())===null||o===void 0?void 0:o.needAlphaBlendingForMesh(this))!==null&&h!==void 0?h:!1))return l.currentRenderPassId=f,!1;l.currentRenderPassId=f}}}for(let _ of this._internalMeshDataInfo._LODLevels)if(_.mesh&&!_.mesh.isReady(d))return!1;return!0}get areNormalsFrozen(){return this._internalMeshDataInfo._areNormalsFrozen}freezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this}unfreezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this}set overridenInstanceCount(t){this._instanceDataStorage.overridenInstanceCount=t}_preActivate(){let t=this._internalMeshDataInfo,e=this.getScene().getRenderId();return t._preActivateId===e?this:(t._preActivateId=e,this._instanceDataStorage.visibleInstances=null,this)}_preActivateForIntermediateRendering(t){return this._instanceDataStorage.visibleInstances&&(this._instanceDataStorage.visibleInstances.intermediateDefaultRenderId=t),this}_registerInstanceForRenderId(t,e){return this._instanceDataStorage.visibleInstances||(this._instanceDataStorage.visibleInstances={defaultRenderId:e,selfDefaultRenderId:this._renderId}),this._instanceDataStorage.visibleInstances[e]||(this._instanceDataStorage.previousRenderId!==void 0&&this._instanceDataStorage.isFrozen&&(this._instanceDataStorage.visibleInstances[this._instanceDataStorage.previousRenderId]=null),this._instanceDataStorage.previousRenderId=e,this._instanceDataStorage.visibleInstances[e]=new Array),this._instanceDataStorage.visibleInstances[e].push(t),this}_afterComputeWorldMatrix(){super._afterComputeWorldMatrix(),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))}_postActivate(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))}refreshBoundingInfo(t=!1,e=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;let i=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getPositionData(t,e),i),this}_createGlobalSubMesh(t){let e=this.getTotalVertices();if(!e||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){let i=this.getIndices();if(!i)return null;let s=i.length,r=!1;if(t)r=!0;else for(let a of this.subMeshes){if(a.indexStart+a.indexCount>s){r=!0;break}if(a.verticesStart+a.verticesCount>e){r=!0;break}}if(!r)return this.subMeshes[0]}return this.releaseSubMeshes(),new gt(0,0,e,0,this.getTotalIndices(),this)}subdivide(t){if(t<1)return;let e=this.getTotalIndices(),i=e/t|0,s=0;for(;i%3!==0;)i++;this.releaseSubMeshes();for(let r=0;r<t&&!(s>=e);r++)gt.CreateFromIndices(0,s,r===t-1?e-s:i,this),s+=i;this.synchronizeInstances()}setVerticesData(t,e,i=!1,s){if(this._geometry)this._geometry.setVerticesData(t,e,i,s);else{let r=new pe;r.set(e,t);let a=this.getScene();new _t(_t.RandomId(),a,r,i,this)}return this}removeVerticesData(t){this._geometry&&this._geometry.removeVerticesData(t)}markVerticesDataAsUpdatable(t,e=!0){let i=this.getVertexBuffer(t);!i||i.isUpdatable()===e||this.setVerticesData(t,this.getVerticesData(t),e)}setVerticesBuffer(t,e=!0){return this._geometry||(this._geometry=_t.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(t,null,e),this}updateVerticesData(t,e,i,s){return this._geometry?(s?(this.makeGeometryUnique(),this.updateVerticesData(t,e,i,!1)):this._geometry.updateVerticesData(t,e,i),this):this}updateMeshPositions(t,e=!0){let i=this.getVerticesData(m.PositionKind);if(!i)return this;if(t(i),this.updateVerticesData(m.PositionKind,i,!1,!1),e){let s=this.getIndices(),r=this.getVerticesData(m.NormalKind);if(!r)return this;pe.ComputeNormals(i,s,r),this.updateVerticesData(m.NormalKind,r,!1,!1)}return this}makeGeometryUnique(){if(!this._geometry)return this;if(this._geometry.meshes.length===1)return this;let t=this._geometry,e=this._geometry.copy(_t.RandomId());return t.releaseForMesh(this,!0),e.applyToMesh(this),this}setIndices(t,e=null,i=!1){if(this._geometry)this._geometry.setIndices(t,e,i);else{let s=new pe;s.indices=t;let r=this.getScene();new _t(_t.RandomId(),r,s,i,this)}return this}updateIndices(t,e,i=!1){return this._geometry?(this._geometry.updateIndices(t,e,i),this):this}toLeftHanded(){return this._geometry?(this._geometry.toLeftHanded(),this):this}_bind(t,e,i){if(!this._geometry)return this;let s=this.getScene().getEngine();this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(e);let r;if(this._unIndexed)r=null;else switch(i){case B.PointFillMode:r=null;break;case B.WireFrameFillMode:r=t._getLinesIndexBuffer(this.getIndices(),s);break;default:case B.TriangleFillMode:r=this._geometry.getIndexBuffer();break}return!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(e,r):this._geometry._bind(e,r,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),this}_draw(t,e,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);let s=this.getScene().getEngine();return this._unIndexed||e==B.PointFillMode?s.drawArraysType(e,t.verticesStart,t.verticesCount,this.forcedInstanceCount||i):e==B.WireFrameFillMode?s.drawElementsType(e,0,t._linesIndexCount,this.forcedInstanceCount||i):s.drawElementsType(e,t.indexStart,t.indexCount,this.forcedInstanceCount||i),this}registerBeforeRender(t){return this.onBeforeRenderObservable.add(t),this}unregisterBeforeRender(t){return this.onBeforeRenderObservable.removeCallback(t),this}registerAfterRender(t){return this.onAfterRenderObservable.add(t),this}unregisterAfterRender(t){return this.onAfterRenderObservable.removeCallback(t),this}_getInstancesRenderList(t,e=!1){if(this._instanceDataStorage.isFrozen){if(e)return this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[t]=!1,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.renderSelf[t]=!0,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode;if(this._instanceDataStorage.previousBatch)return this._instanceDataStorage.previousBatch}let i=this.getScene(),s=i._isInIntermediateRendering(),r=s?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,a=this._instanceDataStorage.batchCache;if(a.mustReturn=!1,a.renderSelf[t]=e||!r&&this.isEnabled()&&this.isVisible,a.visibleInstances[t]=null,this._instanceDataStorage.visibleInstances&&!e){let o=this._instanceDataStorage.visibleInstances,h=i.getRenderId(),l=s?o.intermediateDefaultRenderId:o.defaultRenderId;a.visibleInstances[t]=o[h],!a.visibleInstances[t]&&l&&(a.visibleInstances[t]=o[l])}return a.hardwareInstancedRendering[t]=!e&&this._instanceDataStorage.hardwareInstancedRendering&&a.visibleInstances[t]!==null&&a.visibleInstances[t]!==void 0,this._instanceDataStorage.previousBatch=a,a}_renderWithInstances(t,e,i,s,r){var a;let o=i.visibleInstances[t._id],h=o?o.length:0,l=this._instanceDataStorage,c=l.instancesBufferSize,d=l.instancesBuffer,u=l.instancesPreviousBuffer,f=(h+1)*16*4;for(;l.instancesBufferSize<f;)l.instancesBufferSize*=2;(!l.instancesData||c!=l.instancesBufferSize)&&(l.instancesData=new Float32Array(l.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!l.instancesPreviousData||c!=l.instancesBufferSize)&&(l.instancesPreviousData=new Float32Array(l.instancesBufferSize/4));let _=0,g=0,p=i.renderSelf[t._id],E=!d||c!==l.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!l.instancesPreviousBuffer;if(!this._instanceDataStorage.manualUpdate&&(!l.isFrozen||E)){let T=this.getWorldMatrix();if(p&&(this._scene.needsPreviousWorldMatrices&&(l.masterMeshPreviousWorldMatrix?(l.masterMeshPreviousWorldMatrix.copyToArray(l.instancesPreviousData,_),l.masterMeshPreviousWorldMatrix.copyFrom(T)):(l.masterMeshPreviousWorldMatrix=T.clone(),l.masterMeshPreviousWorldMatrix.copyToArray(l.instancesPreviousData,_))),T.copyToArray(l.instancesData,_),_+=16,g++),o){if(n.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&!((a=t.getMaterial())===null||a===void 0)&&a.needAlphaBlendingForMesh(t.getRenderingMesh())){let R=this._scene.activeCamera.globalPosition;for(let y=0;y<o.length;y++){let M=o[y];M._distanceToCamera=v.Distance(M.getBoundingInfo().boundingSphere.centerWorld,R)}o.sort((y,M)=>y._distanceToCamera>M._distanceToCamera?-1:y._distanceToCamera<M._distanceToCamera?1:0)}for(let R=0;R<o.length;R++){let y=o[R],M=y.getWorldMatrix();M.copyToArray(l.instancesData,_),this._scene.needsPreviousWorldMatrices&&(y._previousWorldMatrix?(y._previousWorldMatrix.copyToArray(l.instancesPreviousData,_),y._previousWorldMatrix.copyFrom(M)):(y._previousWorldMatrix=M.clone(),y._previousWorldMatrix.copyToArray(l.instancesPreviousData,_))),_+=16,g++}}}else g=(p?1:0)+h;return E?(d&&d.dispose(),u&&u.dispose(),d=new di(r,l.instancesData,!0,16,!1,!0),l.instancesBuffer=d,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this._userInstancedBuffersStorage.vertexBuffers.world0=d.createVertexBuffer("world0",0,4),this._userInstancedBuffersStorage.vertexBuffers.world1=d.createVertexBuffer("world1",4,4),this._userInstancedBuffersStorage.vertexBuffers.world2=d.createVertexBuffer("world2",8,4),this._userInstancedBuffersStorage.vertexBuffers.world3=d.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(u=new di(r,l.instancesPreviousData,!0,16,!1,!0),l.instancesPreviousBuffer=u,this._userInstancedBuffersStorage.vertexBuffers.previousWorld0=u.createVertexBuffer("previousWorld0",0,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld1=u.createVertexBuffer("previousWorld1",4,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld2=u.createVertexBuffer("previousWorld2",8,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld3=u.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()):(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&(d.updateDirectly(l.instancesData,0,g),this._scene.needsPreviousWorldMatrices&&(!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.previousManualUpdate)&&u.updateDirectly(l.instancesPreviousData,0,g)),this._processInstancedBuffers(o,p),this.getScene()._activeIndices.addCount(t.indexCount*g,!1),r._currentDrawContext&&(r._currentDrawContext.useInstancing=!0),this._bind(t,s,e),this._draw(t,e,g),this._scene.needsPreviousWorldMatrices&&!E&&this._instanceDataStorage.manualUpdate&&(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&!this._instanceDataStorage.previousManualUpdate&&u.updateDirectly(l.instancesData,0,g),r.unbindInstanceAttributes(),this}_renderWithThinInstances(t,e,i,s){var r,a;let o=(a=(r=this._thinInstanceDataStorage)===null||r===void 0?void 0:r.instancesCount)!==null&&a!==void 0?a:0;this.getScene()._activeIndices.addCount(t.indexCount*o,!1),s._currentDrawContext&&(s._currentDrawContext.useInstancing=!0),this._bind(t,i,e),this._draw(t,e,o),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,o):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),s.unbindInstanceAttributes()}_processInstancedBuffers(t,e){}_processRendering(t,e,i,s,r,a,o,h){let l=this.getScene(),c=l.getEngine();if(a&&e.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(e,s,i,c),this;if(a)this._renderWithInstances(e,s,r,i,c);else{c._currentDrawContext&&(c._currentDrawContext.useInstancing=!1);let d=0;r.renderSelf[e._id]&&(o&&o(!1,t.getWorldMatrix(),h),d++,this._draw(e,s,this._instanceDataStorage.overridenInstanceCount));let u=r.visibleInstances[e._id];if(u){let f=u.length;d+=f;for(let _=0;_<f;_++){let g=u[_].getWorldMatrix();o&&o(!0,g,h),this._draw(e,s)}}l._activeIndices.addCount(e.indexCount*d,!1)}return this}_rebuild(t=!1){if(this._instanceDataStorage.instancesBuffer&&(t&&this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null),this._userInstancedBuffersStorage){for(let e in this._userInstancedBuffersStorage.vertexBuffers){let i=this._userInstancedBuffersStorage.vertexBuffers[e];i&&(t&&i.dispose(),this._userInstancedBuffersStorage.vertexBuffers[e]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,super._rebuild(t)}_freeze(){if(this.subMeshes){for(let t=0;t<this.subMeshes.length;t++)this._getInstancesRenderList(t);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}}_unFreeze(){this._instanceDataStorage.isFrozen=!1,this._instanceDataStorage.previousBatch=null}render(t,e,i){var s,r,a;let o=this.getScene();if(this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1,this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;let h=this._getInstancesRenderList(t._id,!!i);if(h.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;let l=o.getEngine(),c=0,d=null;this.ignoreCameraMaxZ&&o.activeCamera&&!o._isInIntermediateRendering()&&(c=o.activeCamera.maxZ,d=o.activeCamera,o.activeCamera.maxZ=0,o.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);let u=t.getRenderingMesh(),f=h.hardwareInstancedRendering[t._id]||u.hasThinInstances||!!this._userInstancedBuffersStorage&&!t.getMesh()._internalAbstractMeshDataInfo._actAsRegularMesh,_=this._instanceDataStorage,g=t.getMaterial();if(!g)return d&&(d.maxZ=c,o.updateTransformMatrix(!0)),this;if(!_.isFrozen||!this._internalMeshDataInfo._effectiveMaterial||this._internalMeshDataInfo._effectiveMaterial!==g){if(g._storeEffectOnSubMeshes){if(!g.isReadyForSubMesh(this,t,f))return d&&(d.maxZ=c,o.updateTransformMatrix(!0)),this}else if(!g.isReady(this,f))return d&&(d.maxZ=c,o.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=g}else if(g._storeEffectOnSubMeshes&&!(!((s=t.effect)===null||s===void 0)&&s._wasPreviouslyReady)||!g._storeEffectOnSubMeshes&&!(!((r=g.getEffect())===null||r===void 0)&&r._wasPreviouslyReady))return d&&(d.maxZ=c,o.updateTransformMatrix(!0)),this;e&&l.setAlphaMode(this._internalMeshDataInfo._effectiveMaterial.alphaMode);let p;this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?p=t._drawWrapper:p=this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();let E=(a=p?.effect)!==null&&a!==void 0?a:null;for(let F of o._beforeRenderingMeshStage)F.action(this,t,h,E);if(!p||!E)return d&&(d.maxZ=c,o.updateTransformMatrix(!0)),this;let T=i||this,R;if(!_.isFrozen&&(this._internalMeshDataInfo._effectiveMaterial.backFaceCulling||this.overrideMaterialSideOrientation!==null)){let F=T._getWorldMatrixDeterminant();R=this.overrideMaterialSideOrientation,R==null&&(R=this._internalMeshDataInfo._effectiveMaterial.sideOrientation),F<0&&(R=R===B.ClockWiseSideOrientation?B.CounterClockWiseSideOrientation:B.ClockWiseSideOrientation),_.sideOrientation=R}else R=_.sideOrientation;let y=this._internalMeshDataInfo._effectiveMaterial._preBind(p,R);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&l.setDepthWrite(!0);let M=o.forcePointsCloud?B.PointFillMode:o.forceWireframe?B.WireFrameFillMode:this._internalMeshDataInfo._effectiveMaterial.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),f||this._bind(t,E,M);let b=this._internalMeshDataInfo._effectiveMaterial,x=T.getWorldMatrix();b._storeEffectOnSubMeshes?b.bindForSubMesh(x,this,t):b.bind(x,this),!b.backFaceCulling&&b.separateCullingPass&&(l.setState(!0,b.zOffset,!1,!y,b.cullBackFaces,b.stencil,b.zOffsetUnits),this._processRendering(this,t,E,M,h,f,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),l.setState(!0,b.zOffset,!1,y,b.cullBackFaces,b.stencil,b.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(t)),this._processRendering(this,t,E,M,h,f,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(let F of o._afterRenderingMeshStage)F.action(this,t,h,E);return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),d&&(d.maxZ=c,o.updateTransformMatrix(!0)),o.performancePriority===mt.Aggressive&&!_.isFrozen&&this._freeze(),this}cleanMatrixWeights(){this.isVerticesDataPresent(m.MatricesWeightsKind)&&(this.isVerticesDataPresent(m.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())}_normalizeSkinFourWeights(){let t=this.getVerticesData(m.MatricesWeightsKind),e=t.length;for(let i=0;i<e;i+=4){let s=t[i]+t[i+1]+t[i+2]+t[i+3];if(s===0)t[i]=1;else{let r=1/s;t[i]*=r,t[i+1]*=r,t[i+2]*=r,t[i+3]*=r}}this.setVerticesData(m.MatricesWeightsKind,t)}_normalizeSkinWeightsAndExtra(){let t=this.getVerticesData(m.MatricesWeightsExtraKind),e=this.getVerticesData(m.MatricesWeightsKind),i=e.length;for(let s=0;s<i;s+=4){let r=e[s]+e[s+1]+e[s+2]+e[s+3];if(r+=t[s]+t[s+1]+t[s+2]+t[s+3],r===0)e[s]=1;else{let a=1/r;e[s]*=a,e[s+1]*=a,e[s+2]*=a,e[s+3]*=a,t[s]*=a,t[s+1]*=a,t[s+2]*=a,t[s+3]*=a}}this.setVerticesData(m.MatricesWeightsKind,e),this.setVerticesData(m.MatricesWeightsKind,t)}validateSkinning(){let t=this.getVerticesData(m.MatricesWeightsExtraKind),e=this.getVerticesData(m.MatricesWeightsKind);if(e===null||this.skeleton==null)return{skinned:!1,valid:!0,report:"not skinned"};let i=e.length,s=0,r=0,a=0,o=0,h=t===null?4:8,l=new Array;for(let p=0;p<=h;p++)l[p]=0;let c=.001;for(let p=0;p<i;p+=4){let E=e[p],T=E,R=T===0?0:1;for(let y=1;y<h;y++){let M=y<4?e[p+y]:t[p+y-4];M>E&&s++,M!==0&&R++,T+=M,E=M}if(l[R]++,R>a&&(a=R),T===0)r++;else{let y=1/T,M=0;for(let b=0;b<h;b++)b<4?M+=Math.abs(e[p+b]-e[p+b]*y):M+=Math.abs(t[p+b-4]-t[p+b-4]*y);M>c&&o++}}let d=this.skeleton.bones.length,u=this.getVerticesData(m.MatricesIndicesKind),f=this.getVerticesData(m.MatricesIndicesExtraKind),_=0;for(let p=0;p<i;p+=4)for(let E=0;E<h;E++){let T=E<4?u[p+E]:f[p+E-4];(T>=d||T<0)&&_++}let g="Number of Weights = "+i/4+`
Maximum influences = `+a+`
Missing Weights = `+r+`
Not Sorted = `+s+`
Not Normalized = `+o+`
WeightCounts = [`+l+`]
Number of bones = `+d+`
Bad Bone Indices = `+_;return{skinned:!0,valid:r===0&&o===0&&_===0,report:g}}_checkDelayState(){let t=this.getScene();return this._geometry?this._geometry.load(t):this.delayLoadState===4&&(this.delayLoadState=2,this._queueLoad(t)),this}_queueLoad(t){t.addPendingData(this);let e=this.delayLoadingFile.indexOf(".babylonbinarymeshdata")!==-1;return Z.LoadFile(this.delayLoadingFile,i=>{i instanceof ArrayBuffer?this._delayLoadingFunction(i,this):this._delayLoadingFunction(JSON.parse(i),this),this.instances.forEach(s=>{s.refreshBoundingInfo(),s._syncSubMeshes()}),this.delayLoadState=1,t.removePendingData(this)},()=>{},t.offlineProvider,e),this}isInFrustum(t){return this.delayLoadState===2||!super.isInFrustum(t)?!1:(this._checkDelayState(),!0)}setMaterialById(t){let e=this.getScene().materials,i;for(i=e.length-1;i>-1;i--)if(e[i].id===t)return this.material=e[i],this;let s=this.getScene().multiMaterials;for(i=s.length-1;i>-1;i--)if(s[i].id===t)return this.material=s[i],this;return this}getAnimatables(){let t=new Array;return this.material&&t.push(this.material),this.skeleton&&t.push(this.skeleton),t}bakeTransformIntoVertices(t){if(!this.isVerticesDataPresent(m.PositionKind))return this;let e=this.subMeshes.splice(0);this._resetPointsArrayCache();let i=this.getVerticesData(m.PositionKind),s=v.Zero(),r;for(r=0;r<i.length;r+=3)v.TransformCoordinatesFromFloatsToRef(i[r],i[r+1],i[r+2],t,s).toArray(i,r);if(this.setVerticesData(m.PositionKind,i,this.getVertexBuffer(m.PositionKind).isUpdatable()),this.isVerticesDataPresent(m.NormalKind)){for(i=this.getVerticesData(m.NormalKind),r=0;r<i.length;r+=3)v.TransformNormalFromFloatsToRef(i[r],i[r+1],i[r+2],t,s).normalize().toArray(i,r);this.setVerticesData(m.NormalKind,i,this.getVertexBuffer(m.NormalKind).isUpdatable())}return t.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=e,this}bakeCurrentTransformIntoVertices(t=!0){return this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(t),this}get _positions(){return this._internalAbstractMeshDataInfo._positions?this._internalAbstractMeshDataInfo._positions:this._geometry?this._geometry._positions:null}_resetPointsArrayCache(){return this._geometry&&this._geometry._resetPointsArrayCache(),this}_generatePointsArray(){return this._geometry?this._geometry._generatePointsArray():!1}clone(t="",e=null,i,s=!0){return new n(t,this.getScene(),e,this,i,s)}dispose(t,e=!1){this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);let i=this._internalMeshDataInfo;if(i._onBeforeDrawObservable&&i._onBeforeDrawObservable.clear(),i._onBeforeBindObservable&&i._onBeforeBindObservable.clear(),i._onBeforeRenderObservable&&i._onBeforeRenderObservable.clear(),i._onAfterRenderObservable&&i._onAfterRenderObservable.clear(),i._onBetweenPassObservable&&i._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(i.meshMap)for(let s in i.meshMap){let r=i.meshMap[s];r&&(r._internalMeshDataInfo._source=null,i.meshMap[s]=void 0)}i._source&&i._source._internalMeshDataInfo.meshMap&&(i._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else{let s=this.getScene().meshes;for(let r of s){let a=r;a._internalMeshDataInfo&&a._internalMeshDataInfo._source&&a._internalMeshDataInfo._source===this&&(a._internalMeshDataInfo._source=null)}}i._source=null,this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),super.dispose(t,e)}_disposeInstanceSpecificData(){}_disposeThinInstanceSpecificData(){}_invalidateInstanceVertexArrayObject(){}applyDisplacementMap(t,e,i,s,r,a,o=!1){let h=this.getScene(),l=c=>{let d=c.width,u=c.height,f=this.getEngine().createCanvas(d,u).getContext("2d");f.drawImage(c,0,0);let _=f.getImageData(0,0,d,u).data;this.applyDisplacementMapFromBuffer(_,d,u,e,i,r,a,o),s&&s(this)};return Z.LoadImage(t,l,()=>{},h.offlineProvider),this}applyDisplacementMapFromBuffer(t,e,i,s,r,a,o,h=!1){if(!this.isVerticesDataPresent(m.PositionKind)||!this.isVerticesDataPresent(m.NormalKind)||!this.isVerticesDataPresent(m.UVKind))return O.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;let l=this.getVerticesData(m.PositionKind,!0,!0),c=this.getVerticesData(m.NormalKind),d=this.getVerticesData(m.UVKind),u=v.Zero(),f=v.Zero(),_=ve.Zero();a=a||ve.Zero(),o=o||new ve(1,1);for(let g=0;g<l.length;g+=3){v.FromArrayToRef(l,g,u),v.FromArrayToRef(c,g,f),ve.FromArrayToRef(d,g/3*2,_);let p=Math.abs(_.x*o.x+a.x%1)*(e-1)%e|0,E=Math.abs(_.y*o.y+a.y%1)*(i-1)%i|0,T=(p+E*e)*4,R=t[T]/255,y=t[T+1]/255,M=t[T+2]/255,b=R*.3+y*.59+M*.11;f.normalize(),f.scaleInPlace(s+(r-s)*b),u=u.add(f),u.toArray(l,g)}return pe.ComputeNormals(l,this.getIndices(),c),h?(this.setVerticesData(m.PositionKind,l),this.setVerticesData(m.NormalKind,c),this.setVerticesData(m.UVKind,d)):(this.updateVerticesData(m.PositionKind,l),this.updateVerticesData(m.NormalKind,c)),this}convertToFlatShadedMesh(){let t=this.getVerticesDataKinds(),e={},i={},s={},r=!1,a,o;for(a=0;a<t.length;a++){o=t[a];let p=this.getVertexBuffer(o),E=p.getData();if(!((E instanceof Array||E instanceof Float32Array)&&E.length===0)){if(o===m.NormalKind){r=p.isUpdatable(),t.splice(a,1),a--;continue}e[o]=p,i[o]=this.getVerticesData(o),s[o]=[]}}let h=this.subMeshes.slice(0),l=this.getIndices(),c=this.getTotalIndices(),d;for(d=0;d<c;d++){let p=l[d];for(a=0;a<t.length;a++){if(o=t[a],!e[o])continue;let E=e[o].getStrideSize();for(let T=0;T<E;T++)s[o].push(i[o][p*E+T])}}let u=[],f=s[m.PositionKind],_=this.getScene().useRightHandedSystem,g;for(_?g=this.overrideMaterialSideOrientation===1:g=this.overrideMaterialSideOrientation===0,d=0;d<c;d+=3){l[d]=d,l[d+1]=d+1,l[d+2]=d+2;let p=v.FromArray(f,d*3),E=v.FromArray(f,(d+1)*3),T=v.FromArray(f,(d+2)*3),R=p.subtract(E),y=T.subtract(E),M=v.Normalize(v.Cross(R,y));g&&M.scaleInPlace(-1);for(let b=0;b<3;b++)u.push(M.x),u.push(M.y),u.push(M.z)}for(this.setIndices(l),this.setVerticesData(m.NormalKind,u,r),a=0;a<t.length;a++)o=t[a],s[o]&&this.setVerticesData(o,s[o],e[o].isUpdatable());this.releaseSubMeshes();for(let p=0;p<h.length;p++){let E=h[p];gt.AddToMesh(E.materialIndex,E.indexStart,E.indexCount,E.indexStart,E.indexCount,this)}return this.synchronizeInstances(),this}convertToUnIndexedMesh(){let t=this.getVerticesDataKinds(),e={},i={},s={},r,a;for(r=0;r<t.length;r++){a=t[r];let d=this.getVertexBuffer(a);e[a]=d,i[a]=e[a].getData(),s[a]=[]}let o=this.subMeshes.slice(0),h=this.getIndices(),l=this.getTotalIndices(),c;for(c=0;c<l;c++){let d=h[c];for(r=0;r<t.length;r++){a=t[r];let u=e[a].getStrideSize();for(let f=0;f<u;f++)s[a].push(i[a][d*u+f])}}for(c=0;c<l;c+=3)h[c]=c,h[c+1]=c+1,h[c+2]=c+2;for(this.setIndices(h),r=0;r<t.length;r++)a=t[r],this.setVerticesData(a,s[a],e[a].isUpdatable(),e[a].getStrideSize());this.releaseSubMeshes();for(let d=0;d<o.length;d++){let u=o[d];gt.AddToMesh(u.materialIndex,u.indexStart,u.indexCount,u.indexStart,u.indexCount,this)}return this._unIndexed=!0,this.synchronizeInstances(),this}flipFaces(t=!1){let e=pe.ExtractFromMesh(this),i;if(t&&this.isVerticesDataPresent(m.NormalKind)&&e.normals)for(i=0;i<e.normals.length;i++)e.normals[i]*=-1;if(e.indices){let s;for(i=0;i<e.indices.length;i+=3)s=e.indices[i+1],e.indices[i+1]=e.indices[i+2],e.indices[i+2]=s}return e.applyToMesh(this,this.isVertexBufferUpdatable(m.PositionKind)),this}increaseVertices(t=1){let e=pe.ExtractFromMesh(this),i=e.indices&&!Array.isArray(e.indices)&&Array.from?Array.from(e.indices):e.indices,s=e.positions&&!Array.isArray(e.positions)&&Array.from?Array.from(e.positions):e.positions,r=e.uvs&&!Array.isArray(e.uvs)&&Array.from?Array.from(e.uvs):e.uvs,a=e.normals&&!Array.isArray(e.normals)&&Array.from?Array.from(e.normals):e.normals;if(!i||!s)O.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions");else{e.indices=i,e.positions=s,r&&(e.uvs=r),a&&(e.normals=a);let o=t+1,h=new Array;for(let M=0;M<o+1;M++)h[M]=new Array;let l,c,d=new v(0,0,0),u=new v(0,0,0),f=new ve(0,0),_=new Array,g=new Array,p=new Array,E,T=s.length,R;r&&(R=r.length);let y;a&&(y=a.length);for(let M=0;M<i.length;M+=3){g[0]=i[M],g[1]=i[M+1],g[2]=i[M+2];for(let b=0;b<3;b++)if(l=g[b],c=g[(b+1)%3],p[l]===void 0&&p[c]===void 0?(p[l]=new Array,p[c]=new Array):(p[l]===void 0&&(p[l]=new Array),p[c]===void 0&&(p[c]=new Array)),p[l][c]===void 0&&p[c][l]===void 0){p[l][c]=[],d.x=(s[3*c]-s[3*l])/o,d.y=(s[3*c+1]-s[3*l+1])/o,d.z=(s[3*c+2]-s[3*l+2])/o,a&&(u.x=(a[3*c]-a[3*l])/o,u.y=(a[3*c+1]-a[3*l+1])/o,u.z=(a[3*c+2]-a[3*l+2])/o),r&&(f.x=(r[2*c]-r[2*l])/o,f.y=(r[2*c+1]-r[2*l+1])/o),p[l][c].push(l);for(let x=1;x<o;x++)p[l][c].push(s.length/3),s[T++]=s[3*l]+x*d.x,s[T++]=s[3*l+1]+x*d.y,s[T++]=s[3*l+2]+x*d.z,a&&(a[y++]=a[3*l]+x*u.x,a[y++]=a[3*l+1]+x*u.y,a[y++]=a[3*l+2]+x*u.z),r&&(r[R++]=r[2*l]+x*f.x,r[R++]=r[2*l+1]+x*f.y);p[l][c].push(c),p[c][l]=new Array,E=p[l][c].length;for(let x=0;x<E;x++)p[c][l][x]=p[l][c][E-1-x]}h[0][0]=i[M],h[1][0]=p[i[M]][i[M+1]][1],h[1][1]=p[i[M]][i[M+2]][1];for(let b=2;b<o;b++){h[b][0]=p[i[M]][i[M+1]][b],h[b][b]=p[i[M]][i[M+2]][b],d.x=(s[3*h[b][b]]-s[3*h[b][0]])/b,d.y=(s[3*h[b][b]+1]-s[3*h[b][0]+1])/b,d.z=(s[3*h[b][b]+2]-s[3*h[b][0]+2])/b,a&&(u.x=(a[3*h[b][b]]-a[3*h[b][0]])/b,u.y=(a[3*h[b][b]+1]-a[3*h[b][0]+1])/b,u.z=(a[3*h[b][b]+2]-a[3*h[b][0]+2])/b),r&&(f.x=(r[2*h[b][b]]-r[2*h[b][0]])/b,f.y=(r[2*h[b][b]+1]-r[2*h[b][0]+1])/b);for(let x=1;x<b;x++)h[b][x]=s.length/3,s[T++]=s[3*h[b][0]]+x*d.x,s[T++]=s[3*h[b][0]+1]+x*d.y,s[T++]=s[3*h[b][0]+2]+x*d.z,a&&(a[y++]=a[3*h[b][0]]+x*u.x,a[y++]=a[3*h[b][0]+1]+x*u.y,a[y++]=a[3*h[b][0]+2]+x*u.z),r&&(r[R++]=r[2*h[b][0]]+x*f.x,r[R++]=r[2*h[b][0]+1]+x*f.y)}h[o]=p[i[M+1]][i[M+2]],_.push(h[0][0],h[1][0],h[1][1]);for(let b=1;b<o;b++){let x;for(x=0;x<b;x++)_.push(h[b][x],h[b+1][x],h[b+1][x+1]),_.push(h[b][x],h[b+1][x+1],h[b][x+1]);_.push(h[b][x],h[b+1][x],h[b+1][x+1])}}e.indices=_,e.applyToMesh(this,this.isVertexBufferUpdatable(m.PositionKind))}}forceSharedVertices(){let t=pe.ExtractFromMesh(this),e=t.uvs,i=t.indices,s=t.positions,r=t.colors,a=t.matricesIndices,o=t.matricesWeights,h=t.matricesIndicesExtra,l=t.matricesWeightsExtra;if(i===void 0||s===void 0||i===null||s===null)O.Warn("VertexData contains empty entries");else{let c=new Array,d=new Array,u=new Array,f=new Array,_=new Array,g=new Array,p=new Array,E=new Array,T=new Array,R=0,y={},M,b;for(let F=0;F<i.length;F+=3){b=[i[F],i[F+1],i[F+2]],T=new Array;for(let I=0;I<3;I++){T[I]="";for(let N=0;N<3;N++)Math.abs(s[3*b[I]+N])<1e-8&&(s[3*b[I]+N]=0),T[I]+=s[3*b[I]+N]+"|"}if(!(T[0]==T[1]||T[0]==T[2]||T[1]==T[2]))for(let I=0;I<3;I++){if(M=y[T[I]],M===void 0){y[T[I]]=R,M=R++;for(let N=0;N<3;N++)c.push(s[3*b[I]+N]);if(r!=null)for(let N=0;N<4;N++)f.push(r[4*b[I]+N]);if(e!=null)for(let N=0;N<2;N++)u.push(e[2*b[I]+N]);if(a!=null)for(let N=0;N<4;N++)_.push(a[4*b[I]+N]);if(o!=null)for(let N=0;N<4;N++)g.push(o[4*b[I]+N]);if(h!=null)for(let N=0;N<4;N++)p.push(h[4*b[I]+N]);if(l!=null)for(let N=0;N<4;N++)E.push(l[4*b[I]+N])}d.push(M)}}let x=new Array;pe.ComputeNormals(c,d,x),t.positions=c,t.indices=d,t.normals=x,e!=null&&(t.uvs=u),r!=null&&(t.colors=f),a!=null&&(t.matricesIndices=_),o!=null&&(t.matricesWeights=g),h!=null&&(t.matricesIndicesExtra=p),o!=null&&(t.matricesWeightsExtra=E),t.applyToMesh(this,this.isVertexBufferUpdatable(m.PositionKind))}}static _instancedMeshFactory(t,e){throw H("InstancedMesh")}static _PhysicsImpostorParser(t,e,i){throw H("PhysicsImpostor")}createInstance(t){return n._instancedMeshFactory(t,this)}synchronizeInstances(){for(let t=0;t<this.instances.length;t++)this.instances[t]._syncSubMeshes();return this}optimizeIndices(t){let e=this.getIndices(),i=this.getVerticesData(m.PositionKind);if(!i||!e)return this;let s=new Array;for(let a=0;a<i.length;a=a+3)s.push(v.FromArray(i,a));let r=new Array;return ar.SyncAsyncForLoop(s.length,40,a=>{let o=s.length-1-a,h=s[o];for(let l=0;l<o;++l){let c=s[l];if(h.equals(c)){r[o]=l;break}}},()=>{for(let o=0;o<e.length;++o)e[o]=r[e[o]]||e[o];let a=this.subMeshes.slice(0);this.setIndices(e),this.subMeshes=a,t&&t(this)}),this}serialize(t={}){t.name=this.name,t.id=this.id,t.uniqueId=this.uniqueId,t.type=this.getClassName(),he&&he.HasTags(this)&&(t.tags=he.GetTags(this)),t.position=this.position.asArray(),this.rotationQuaternion?t.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(t.rotation=this.rotation.asArray()),t.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?t.pivotMatrix=this.getPivotMatrix().asArray():t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(!1),t.isVisible=this.isVisible,t.infiniteDistance=this.infiniteDistance,t.pickable=this.isPickable,t.receiveShadows=this.receiveShadows,t.billboardMode=this.billboardMode,t.visibility=this.visibility,t.checkCollisions=this.checkCollisions,t.isBlocker=this.isBlocker,t.overrideMaterialSideOrientation=this.overrideMaterialSideOrientation,this.parent&&this.parent._serializeAsParent(t),t.isUnIndexed=this.isUnIndexed;let e=this._geometry;if(e&&this.subMeshes){t.geometryUniqueId=e.uniqueId,t.geometryId=e.id,t.subMeshes=[];for(let i=0;i<this.subMeshes.length;i++){let s=this.subMeshes[i];t.subMeshes.push({materialIndex:s.materialIndex,verticesStart:s.verticesStart,verticesCount:s.verticesCount,indexStart:s.indexStart,indexCount:s.indexCount})}}if(this.material?this.material.doNotSerialize||(t.materialUniqueId=this.material.uniqueId,t.materialId=this.material.id):(this.material=null,t.materialUniqueId=this._scene.defaultMaterial.uniqueId,t.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(t.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(t.skeletonId=this.skeleton.id,t.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(fi.NAME_PHYSICSENGINE)){let i=this.getPhysicsImpostor();i&&(t.physicsMass=i.getParam("mass"),t.physicsFriction=i.getParam("friction"),t.physicsRestitution=i.getParam("mass"),t.physicsImpostor=i.type)}this.metadata&&(t.metadata=this.metadata),t.instances=[];for(let i=0;i<this.instances.length;i++){let s=this.instances[i];if(s.doNotSerialize)continue;let r={name:s.name,id:s.id,isEnabled:s.isEnabled(!1),isVisible:s.isVisible,isPickable:s.isPickable,checkCollisions:s.checkCollisions,position:s.position.asArray(),scaling:s.scaling.asArray()};if(s.parent&&s.parent._serializeAsParent(r),s.rotationQuaternion?r.rotationQuaternion=s.rotationQuaternion.asArray():s.rotation&&(r.rotation=s.rotation.asArray()),this.getScene()._getComponent(fi.NAME_PHYSICSENGINE)){let a=s.getPhysicsImpostor();a&&(r.physicsMass=a.getParam("mass"),r.physicsFriction=a.getParam("friction"),r.physicsRestitution=a.getParam("mass"),r.physicsImpostor=a.type)}s.metadata&&(r.metadata=s.metadata),t.instances.push(r),ee.AppendSerializedAnimations(s,r),r.ranges=s.serializeAnimationRanges()}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(t.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){let i={data:{},sizes:{},strides:{}};for(let s in this._userThinInstanceBuffersStorage.data)i.data[s]=Array.from(this._userThinInstanceBuffersStorage.data[s]),i.sizes[s]=this._userThinInstanceBuffersStorage.sizes[s],i.strides[s]=this._userThinInstanceBuffersStorage.strides[s];t.thinInstances.userThinInstance=i}return ee.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t.layerMask=this.layerMask,t.alphaIndex=this.alphaIndex,t.hasVertexAlpha=this.hasVertexAlpha,t.overlayAlpha=this.overlayAlpha,t.overlayColor=this.overlayColor.asArray(),t.renderOverlay=this.renderOverlay,t.applyFog=this.applyFog,this.actionManager&&(t.actions=this.actionManager.serialize(this.name)),t}_syncGeometryWithMorphTargetManager(){if(!this.geometry)return;this._markSubMeshesAsAttributesDirty();let t=this._internalAbstractMeshDataInfo._morphTargetManager;if(t&&t.vertexCount){if(t.vertexCount!==this.getTotalVertices()){O.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),this.morphTargetManager=null;return}if(t.isUsingTextureForTargets)return;for(let e=0;e<t.numInfluencers;e++){let i=t.getActiveTarget(e),s=i.getPositions();if(!s){O.Error("Invalid morph target. Target must have positions.");return}this.geometry.setVerticesData(m.PositionKind+e,s,!1,3);let r=i.getNormals();r&&this.geometry.setVerticesData(m.NormalKind+e,r,!1,3);let a=i.getTangents();a&&this.geometry.setVerticesData(m.TangentKind+e,a,!1,3);let o=i.getUVs();o&&this.geometry.setVerticesData(m.UVKind+"_"+e,o,!1,2)}}else{let e=0;for(;this.geometry.isVerticesDataPresent(m.PositionKind+e);)this.geometry.removeVerticesData(m.PositionKind+e),this.geometry.isVerticesDataPresent(m.NormalKind+e)&&this.geometry.removeVerticesData(m.NormalKind+e),this.geometry.isVerticesDataPresent(m.TangentKind+e)&&this.geometry.removeVerticesData(m.TangentKind+e),this.geometry.isVerticesDataPresent(m.UVKind+e)&&this.geometry.removeVerticesData(m.UVKind+"_"+e),e++}}static Parse(t,e,i){let s;if(t.type&&t.type==="LinesMesh"?s=n._LinesMeshParser(t,e):t.type&&t.type==="GroundMesh"?s=n._GroundMeshParser(t,e):t.type&&t.type==="GoldbergMesh"?s=n._GoldbergMeshParser(t,e):s=new n(t.name,e),s.id=t.id,s._waitingParsedUniqueId=t.uniqueId,he&&he.AddTagsTo(s,t.tags),s.position=v.FromArray(t.position),t.metadata!==void 0&&(s.metadata=t.metadata),t.rotationQuaternion?s.rotationQuaternion=se.FromArray(t.rotationQuaternion):t.rotation&&(s.rotation=v.FromArray(t.rotation)),s.scaling=v.FromArray(t.scaling),t.localMatrix?s.setPreTransformMatrix(P.FromArray(t.localMatrix)):t.pivotMatrix&&s.setPivotMatrix(P.FromArray(t.pivotMatrix)),s.setEnabled(t.isEnabled),s.isVisible=t.isVisible,s.infiniteDistance=t.infiniteDistance,s.showBoundingBox=t.showBoundingBox,s.showSubMeshesBoundingBox=t.showSubMeshesBoundingBox,t.applyFog!==void 0&&(s.applyFog=t.applyFog),t.pickable!==void 0&&(s.isPickable=t.pickable),t.alphaIndex!==void 0&&(s.alphaIndex=t.alphaIndex),s.receiveShadows=t.receiveShadows,t.billboardMode!==void 0&&(s.billboardMode=t.billboardMode),t.visibility!==void 0&&(s.visibility=t.visibility),s.checkCollisions=t.checkCollisions,s.overrideMaterialSideOrientation=t.overrideMaterialSideOrientation,t.isBlocker!==void 0&&(s.isBlocker=t.isBlocker),s._shouldGenerateFlatShading=t.useFlatShading,t.freezeWorldMatrix&&(s._waitingData.freezeWorldMatrix=t.freezeWorldMatrix),t.parentId!==void 0&&(s._waitingParentId=t.parentId),t.parentInstanceIndex!==void 0&&(s._waitingParentInstanceIndex=t.parentInstanceIndex),t.actions!==void 0&&(s._waitingData.actions=t.actions),t.overlayAlpha!==void 0&&(s.overlayAlpha=t.overlayAlpha),t.overlayColor!==void 0&&(s.overlayColor=me.FromArray(t.overlayColor)),t.renderOverlay!==void 0&&(s.renderOverlay=t.renderOverlay),s.isUnIndexed=!!t.isUnIndexed,s.hasVertexAlpha=t.hasVertexAlpha,t.delayLoadingFile?(s.delayLoadState=4,s.delayLoadingFile=i+t.delayLoadingFile,s.buildBoundingInfo(v.FromArray(t.boundingBoxMinimum),v.FromArray(t.boundingBoxMaximum)),t._binaryInfo&&(s._binaryInfo=t._binaryInfo),s._delayInfo=[],t.hasUVs&&s._delayInfo.push(m.UVKind),t.hasUVs2&&s._delayInfo.push(m.UV2Kind),t.hasUVs3&&s._delayInfo.push(m.UV3Kind),t.hasUVs4&&s._delayInfo.push(m.UV4Kind),t.hasUVs5&&s._delayInfo.push(m.UV5Kind),t.hasUVs6&&s._delayInfo.push(m.UV6Kind),t.hasColors&&s._delayInfo.push(m.ColorKind),t.hasMatricesIndices&&s._delayInfo.push(m.MatricesIndicesKind),t.hasMatricesWeights&&s._delayInfo.push(m.MatricesWeightsKind),s._delayLoadingFunction=_t._ImportGeometry,ft.ForceFullSceneLoadingForIncremental&&s._checkDelayState()):_t._ImportGeometry(t,s),t.materialUniqueId?s._waitingMaterialId=t.materialUniqueId:t.materialId&&(s._waitingMaterialId=t.materialId),t.morphTargetManagerId>-1&&(s.morphTargetManager=e.getMorphTargetManagerById(t.morphTargetManagerId)),t.skeletonId!==void 0&&t.skeletonId!==null&&(s.skeleton=e.getLastSkeletonById(t.skeletonId),t.numBoneInfluencers&&(s.numBoneInfluencers=t.numBoneInfluencers)),t.animations){for(let r=0;r<t.animations.length;r++){let a=t.animations[r],o=Zt("BABYLON.Animation");o&&s.animations.push(o.Parse(a))}Ge.ParseAnimationRanges(s,t,e)}if(t.autoAnimate&&e.beginAnimation(s,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),t.layerMask&&!isNaN(t.layerMask)?s.layerMask=Math.abs(parseInt(t.layerMask)):s.layerMask=268435455,t.physicsImpostor&&n._PhysicsImpostorParser(e,s,t),t.lodMeshIds&&(s._waitingData.lods={ids:t.lodMeshIds,distances:t.lodDistances?t.lodDistances:null,coverages:t.lodCoverages?t.lodCoverages:null}),t.instances)for(let r=0;r<t.instances.length;r++){let a=t.instances[r],o=s.createInstance(a.name);if(a.id&&(o.id=a.id),he&&(a.tags?he.AddTagsTo(o,a.tags):he.AddTagsTo(o,t.tags)),o.position=v.FromArray(a.position),a.metadata!==void 0&&(o.metadata=a.metadata),a.parentId!==void 0&&(o._waitingParentId=a.parentId),a.parentInstanceIndex!==void 0&&(o._waitingParentInstanceIndex=a.parentInstanceIndex),a.isEnabled!==void 0&&a.isEnabled!==null&&o.setEnabled(a.isEnabled),a.isVisible!==void 0&&a.isVisible!==null&&(o.isVisible=a.isVisible),a.isPickable!==void 0&&a.isPickable!==null&&(o.isPickable=a.isPickable),a.rotationQuaternion?o.rotationQuaternion=se.FromArray(a.rotationQuaternion):a.rotation&&(o.rotation=v.FromArray(a.rotation)),o.scaling=v.FromArray(a.scaling),a.checkCollisions!=null&&a.checkCollisions!=null&&(o.checkCollisions=a.checkCollisions),a.pickable!=null&&a.pickable!=null&&(o.isPickable=a.pickable),a.showBoundingBox!=null&&a.showBoundingBox!=null&&(o.showBoundingBox=a.showBoundingBox),a.showSubMeshesBoundingBox!=null&&a.showSubMeshesBoundingBox!=null&&(o.showSubMeshesBoundingBox=a.showSubMeshesBoundingBox),a.alphaIndex!=null&&a.showSubMeshesBoundingBox!=null&&(o.alphaIndex=a.alphaIndex),a.physicsImpostor&&n._PhysicsImpostorParser(e,o,a),a.animations){for(let h=0;h<a.animations.length;h++){let l=a.animations[h],c=Zt("BABYLON.Animation");c&&o.animations.push(c.Parse(l))}Ge.ParseAnimationRanges(o,a,e),a.autoAnimate&&e.beginAnimation(o,a.autoAnimateFrom,a.autoAnimateTo,a.autoAnimateLoop,a.autoAnimateSpeed||1)}}if(t.thinInstances){let r=t.thinInstances;if(s.thinInstanceEnablePicking=!!r.enablePicking,r.matrixData?(s.thinInstanceSetBuffer("matrix",new Float32Array(r.matrixData),16,!1),s._thinInstanceDataStorage.matrixBufferSize=r.matrixBufferSize,s._thinInstanceDataStorage.instancesCount=r.instancesCount):s._thinInstanceDataStorage.matrixBufferSize=r.matrixBufferSize,t.thinInstances.userThinInstance){let a=t.thinInstances.userThinInstance;for(let o in a.data)s.thinInstanceSetBuffer(o,new Float32Array(a.data[o]),a.strides[o],!1),s._userThinInstanceBuffersStorage.sizes[o]=a.sizes[o]}}return s}setPositionsForCPUSkinning(){let t=this._internalMeshDataInfo;if(!t._sourcePositions){let e=this.getVerticesData(m.PositionKind);if(!e)return t._sourcePositions;t._sourcePositions=new Float32Array(e),this.isVertexBufferUpdatable(m.PositionKind)||this.setVerticesData(m.PositionKind,e,!0)}return t._sourcePositions}setNormalsForCPUSkinning(){let t=this._internalMeshDataInfo;if(!t._sourceNormals){let e=this.getVerticesData(m.NormalKind);if(!e)return t._sourceNormals;t._sourceNormals=new Float32Array(e),this.isVertexBufferUpdatable(m.NormalKind)||this.setVerticesData(m.NormalKind,e,!0)}return t._sourceNormals}applySkeleton(t){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(m.PositionKind))return this;if(!this.isVerticesDataPresent(m.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(m.MatricesWeightsKind))return this;let e=this.isVerticesDataPresent(m.NormalKind),i=this._internalMeshDataInfo;if(!i._sourcePositions){let E=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=E}e&&!i._sourceNormals&&this.setNormalsForCPUSkinning();let s=this.getVerticesData(m.PositionKind);if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s));let r=this.getVerticesData(m.NormalKind);if(e){if(!r)return this;r instanceof Float32Array||(r=new Float32Array(r))}let a=this.getVerticesData(m.MatricesIndicesKind),o=this.getVerticesData(m.MatricesWeightsKind);if(!o||!a)return this;let h=this.numBoneInfluencers>4,l=h?this.getVerticesData(m.MatricesIndicesExtraKind):null,c=h?this.getVerticesData(m.MatricesWeightsExtraKind):null,d=t.getTransformMatrices(this),u=v.Zero(),f=new P,_=new P,g=0,p;for(let E=0;E<s.length;E+=3,g+=4){let T;for(p=0;p<4;p++)T=o[g+p],T>0&&(P.FromFloat32ArrayToRefScaled(d,Math.floor(a[g+p]*16),T,_),f.addToSelf(_));if(h)for(p=0;p<4;p++)T=c[g+p],T>0&&(P.FromFloat32ArrayToRefScaled(d,Math.floor(l[g+p]*16),T,_),f.addToSelf(_));v.TransformCoordinatesFromFloatsToRef(i._sourcePositions[E],i._sourcePositions[E+1],i._sourcePositions[E+2],f,u),u.toArray(s,E),e&&(v.TransformNormalFromFloatsToRef(i._sourceNormals[E],i._sourceNormals[E+1],i._sourceNormals[E+2],f,u),u.toArray(r,E)),f.reset()}return this.updateVerticesData(m.PositionKind,s),e&&this.updateVerticesData(m.NormalKind,r),this}static MinMax(t){let e=null,i=null;return t.forEach(function(s){let r=s.getBoundingInfo().boundingBox;!e||!i?(e=r.minimumWorld,i=r.maximumWorld):(e.minimizeInPlace(r.minimumWorld),i.maximizeInPlace(r.maximumWorld))}),!e||!i?{min:v.Zero(),max:v.Zero()}:{min:e,max:i}}static Center(t){let e=t instanceof Array?n.MinMax(t):t;return v.Center(e.min,e.max)}static MergeMeshes(t,e=!0,i,s,r,a){return Zr(n._MergeMeshesCoroutine(t,e,i,s,r,a,!1))}static MergeMeshesAsync(t,e=!0,i,s,r,a){return ua(n._MergeMeshesCoroutine(t,e,i,s,r,a,!0),da())}static*_MergeMeshesCoroutine(t,e=!0,i,s,r,a,o){if(t=t.filter(Boolean),t.length===0)return null;let h;if(!i){let x=0;for(h=0;h<t.length;h++)if(x+=t[h].getTotalVertices(),x>=65536)return O.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null}a&&(r=!1);let l=new Array,c=new Array,d=new Array,u=t[0].overrideMaterialSideOrientation;for(h=0;h<t.length;h++){let x=t[h];if(x.isAnInstance)return O.Warn("Cannot merge instance meshes."),null;if(u!==x.overrideMaterialSideOrientation)return O.Warn("Cannot merge meshes with different overrideMaterialSideOrientation values."),null;if(r&&d.push(x.getTotalIndices()),a)if(x.material){let F=x.material;if(F instanceof ki){for(let I=0;I<F.subMaterials.length;I++)l.indexOf(F.subMaterials[I])<0&&l.push(F.subMaterials[I]);for(let I=0;I<x.subMeshes.length;I++)c.push(l.indexOf(F.subMaterials[x.subMeshes[I].materialIndex])),d.push(x.subMeshes[I].indexCount)}else{l.indexOf(F)<0&&l.push(F);for(let I=0;I<x.subMeshes.length;I++)c.push(l.indexOf(F)),d.push(x.subMeshes[I].indexCount)}}else for(let F=0;F<x.subMeshes.length;F++)c.push(0),d.push(x.subMeshes[F].indexCount)}let f=t[0],_=x=>{let F=x.computeWorldMatrix(!0);return[pe.ExtractFromMesh(x,!1,!1),F]},[g,p]=_(f);o&&(yield);let E=new Array(t.length-1);for(let x=1;x<t.length;x++)E[x-1]=_(t[x]),o&&(yield);let T=g._mergeCoroutine(p,E,i,o,!e),R=T.next();for(;!R.done;)o&&(yield),R=T.next();let y=R.value;s||(s=new n(f.name+"_merged",f.getScene()));let M=y._applyToCoroutine(s,void 0,o),b=M.next();for(;!b.done;)o&&(yield),b=M.next();if(s.checkCollisions=f.checkCollisions,s.overrideMaterialSideOrientation=f.overrideMaterialSideOrientation,e)for(h=0;h<t.length;h++)t[h].dispose();if(r||a){s.releaseSubMeshes(),h=0;let x=0;for(;h<d.length;)gt.CreateFromIndices(0,x,d[h],s,void 0,!1),x+=d[h],h++;for(let F of s.subMeshes)F.refreshBoundingInfo();s.computeWorldMatrix(!0)}if(a){let x=new ki(f.name+"_merged",f.getScene());x.subMaterials=l;for(let F=0;F<s.subMeshes.length;F++)s.subMeshes[F].materialIndex=c[F];s.material=x}else s.material=f.material;return s}addInstance(t){t._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(t)}removeInstance(t){let e=t._indexInSourceMeshInstanceArray;if(e!=-1){if(e!==this.instances.length-1){let i=this.instances[this.instances.length-1];this.instances[e]=i,i._indexInSourceMeshInstanceArray=e}t._indexInSourceMeshInstanceArray=-1,this.instances.pop()}}_shouldConvertRHS(){return this.overrideMaterialSideOrientation===B.CounterClockWiseSideOrientation}};W.FRONTSIDE=pe.FRONTSIDE;W.BACKSIDE=pe.BACKSIDE;W.DOUBLESIDE=pe.DOUBLESIDE;W.DEFAULTSIDE=pe.DEFAULTSIDE;W.NO_CAP=0;W.CAP_START=1;W.CAP_END=2;W.CAP_ALL=3;W.NO_FLIP=0;W.FLIP_TILE=1;W.ROTATE_TILE=2;W.FLIP_ROW=3;W.ROTATE_ROW=4;W.FLIP_N_ROTATE_TILE=5;W.FLIP_N_ROTATE_ROW=6;W.CENTER=0;W.LEFT=1;W.RIGHT=2;W.TOP=3;W.BOTTOM=4;W.INSTANCEDMESH_SORT_TRANSPARENT=!1;W._GroundMeshParser=(n,t)=>{throw H("GroundMesh")};W._GoldbergMeshParser=(n,t)=>{throw H("GoldbergMesh")};W._LinesMeshParser=(n,t)=>{throw H("LinesMesh")};Ye("BABYLON.Mesh",W);W.prototype.setMaterialByID=function(n){return this.setMaterialById(n)};W.CreateDisc=W.CreateDisc||(()=>{throw new Error("Import MeshBuilder to populate this function")});W.CreateBox=W.CreateBox||(()=>{throw new Error("Import MeshBuilder to populate this function")});W.CreateSphere=W.CreateSphere||(()=>{throw new Error("Import MeshBuilder to populate this function")});W.CreateCylinder=W.CreateCylinder||(()=>{throw new Error("Import MeshBuilder to populate this function")});W.CreateTorusKnot=W.CreateTorusKnot||(()=>{throw new Error("Import MeshBuilder to populate this function")});W.CreateTorus=W.CreateTorus||(()=>{throw new Error("Import MeshBuilder to populate this function")});W.CreatePlane=W.CreatePlane||(()=>{throw new Error("Import MeshBuilder to populate this function")});W.CreateGround=W.CreateGround||(()=>{throw new Error("Import MeshBuilder to populate this function")});W.CreateTiledGround=W.CreateTiledGround||(()=>{throw new Error("Import MeshBuilder to populate this function")});W.CreateGroundFromHeightMap=W.CreateGroundFromHeightMap||(()=>{throw new Error("Import MeshBuilder to populate this function")});W.CreateTube=W.CreateTube||(()=>{throw new Error("Import MeshBuilder to populate this function")});W.CreatePolyhedron=W.CreatePolyhedron||(()=>{throw new Error("Import MeshBuilder to populate this function")});W.CreateIcoSphere=W.CreateIcoSphere||(()=>{throw new Error("Import MeshBuilder to populate this function")});W.CreateDecal=W.CreateDecal||(()=>{throw new Error("Import MeshBuilder to populate this function")});W.CreateCapsule=W.CreateCapsule||(()=>{throw new Error("Import MeshBuilder to populate this function")});W.ExtendToGoldberg=W.ExtendToGoldberg||(()=>{throw new Error("Import MeshBuilder to populate this function")});var dt=class{constructor(t=0){this.priority=t}getDescription(){return""}apply(t,e){return!0}},Ri=class extends dt{constructor(t=0,e=1024,i=.5){super(t),this.priority=t,this.maximumSize=e,this.step=i}getDescription(){return"Reducing render target texture size to "+this.maximumSize}apply(t,e){let i=!0;for(let s=0;s<t.textures.length;s++){let r=t.textures[s];if(!r.canRescale||r.getContext)continue;let a=r.getSize();Math.max(a.width,a.height)>this.maximumSize&&(r.scale(this.step),i=!1)}return i}},gs=class extends dt{constructor(t=0,e=2,i=.25){super(t),this.priority=t,this.maximumScale=e,this.step=i,this._currentScale=-1,this._directionOffset=1}getDescription(){return"Setting hardware scaling level to "+this._currentScale}apply(t,e){return this._currentScale===-1&&(this._currentScale=t.getEngine().getHardwareScalingLevel(),this._currentScale>this.maximumScale&&(this._directionOffset=-1)),this._currentScale+=this._directionOffset*this.step,t.getEngine().setHardwareScalingLevel(this._currentScale),this._directionOffset===1?this._currentScale>=this.maximumScale:this._currentScale<=this.maximumScale}},yi=class extends dt{getDescription(){return"Turning shadows on/off"}apply(t,e){return t.shadowsEnabled=e.isInImprovementMode,!0}},Ci=class extends dt{getDescription(){return"Turning post-processes on/off"}apply(t,e){return t.postProcessesEnabled=e.isInImprovementMode,!0}},Ii=class extends dt{getDescription(){return"Turning lens flares on/off"}apply(t,e){return t.lensFlaresEnabled=e.isInImprovementMode,!0}},Mr=class extends dt{getDescription(){return this.onGetDescription?this.onGetDescription():"Running user defined callback"}apply(t,e){return this.onApply?this.onApply(t,e):!0}},Pi=class extends dt{getDescription(){return"Turning particles on/off"}apply(t,e){return t.particlesEnabled=e.isInImprovementMode,!0}},ms=class extends dt{getDescription(){return"Turning render targets off"}apply(t,e){return t.renderTargetsEnabled=e.isInImprovementMode,!0}},Bs=(()=>{class n extends dt{constructor(){super(...arguments),this._canBeMerged=e=>{if(!(e instanceof W))return!1;let i=e;return!(i.isDisposed()||!i.isVisible||!i.isEnabled()||i.instances.length>0||i.skeleton||i.hasLODLevels)}}static get UpdateSelectionTree(){return n._UpdateSelectionTree}static set UpdateSelectionTree(e){n._UpdateSelectionTree=e}getDescription(){return"Merging similar meshes together"}apply(e,i,s){let r=e.meshes.slice(0),a=r.length;for(let h=0;h<a;h++){let l=new Array,c=r[h];if(this._canBeMerged(c)){l.push(c);for(let d=h+1;d<a;d++){let u=r[d];this._canBeMerged(u)&&u.material===c.material&&u.checkCollisions===c.checkCollisions&&(l.push(u),a--,r.splice(d,1),d--)}l.length<2||W.MergeMeshes(l,void 0,!0)}}let o=e;return o.createOrUpdateSelectionOctree&&(s!=null?s&&o.createOrUpdateSelectionOctree():n.UpdateSelectionTree&&o.createOrUpdateSelectionOctree()),!0}}return n._UpdateSelectionTree=!1,n})(),Vi=class n{constructor(t=60,e=2e3){this.targetFrameRate=t,this.trackerDuration=e,this.optimizations=new Array}addOptimization(t){return this.optimizations.push(t),this}addCustomOptimization(t,e,i=0){let s=new Mr(i);return s.onApply=t,s.onGetDescription=e,this.optimizations.push(s),this}static LowDegradationAllowed(t){let e=new n(t),i=0;return e.addOptimization(new Bs(i)),e.addOptimization(new yi(i)),e.addOptimization(new Ii(i)),i++,e.addOptimization(new Ci(i)),e.addOptimization(new Pi(i)),i++,e.addOptimization(new Ri(i,1024)),e}static ModerateDegradationAllowed(t){let e=new n(t),i=0;return e.addOptimization(new Bs(i)),e.addOptimization(new yi(i)),e.addOptimization(new Ii(i)),i++,e.addOptimization(new Ci(i)),e.addOptimization(new Pi(i)),i++,e.addOptimization(new Ri(i,512)),i++,e.addOptimization(new ms(i)),i++,e.addOptimization(new gs(i,2)),e}static HighDegradationAllowed(t){let e=new n(t),i=0;return e.addOptimization(new Bs(i)),e.addOptimization(new yi(i)),e.addOptimization(new Ii(i)),i++,e.addOptimization(new Ci(i)),e.addOptimization(new Pi(i)),i++,e.addOptimization(new Ri(i,256)),i++,e.addOptimization(new ms(i)),i++,e.addOptimization(new gs(i,4)),e}},Ar=class n{constructor(t,e,i=!0,s=!1){if(this._isRunning=!1,this._currentPriorityLevel=0,this._targetFrameRate=60,this._trackerDuration=2e3,this._currentFrameRate=0,this._improvementMode=!1,this.onSuccessObservable=new D,this.onNewOptimizationAppliedObservable=new D,this.onFailureObservable=new D,e?this._options=e:this._options=new Vi,this._options.targetFrameRate&&(this._targetFrameRate=this._options.targetFrameRate),this._options.trackerDuration&&(this._trackerDuration=this._options.trackerDuration),i){let r=0;for(let a of this._options.optimizations)a.priority=r++}this._improvementMode=s,this._scene=t||Q.LastCreatedScene,this._sceneDisposeObserver=this._scene.onDisposeObservable.add(()=>{this._sceneDisposeObserver=null,this.dispose()})}get isInImprovementMode(){return this._improvementMode}set isInImprovementMode(t){this._improvementMode=t}get currentPriorityLevel(){return this._currentPriorityLevel}get currentFrameRate(){return this._currentFrameRate}get targetFrameRate(){return this._targetFrameRate}set targetFrameRate(t){this._targetFrameRate=t}get trackerDuration(){return this._trackerDuration}set trackerDuration(t){this._trackerDuration=t}get optimizations(){return this._options.optimizations}stop(){this._isRunning=!1}reset(){this._currentPriorityLevel=0}start(){this._isRunning||(this._isRunning=!0,this._scene.executeWhenReady(()=>{setTimeout(()=>{this._checkCurrentState()},this._trackerDuration)}))}_checkCurrentState(){if(!this._isRunning)return;let t=this._scene,e=this._options;if(this._currentFrameRate=Math.round(t.getEngine().getFps()),this._improvementMode&&this._currentFrameRate<=this._targetFrameRate||!this._improvementMode&&this._currentFrameRate>=this._targetFrameRate){this._isRunning=!1,this.onSuccessObservable.notifyObservers(this);return}let i=!0,s=!0;for(let r=0;r<e.optimizations.length;r++){let a=e.optimizations[r];a.priority===this._currentPriorityLevel&&(s=!1,i=i&&a.apply(t,this),this.onNewOptimizationAppliedObservable.notifyObservers(a))}if(s){this._isRunning=!1,this.onFailureObservable.notifyObservers(this);return}i&&this._currentPriorityLevel++,t.executeWhenReady(()=>{setTimeout(()=>{this._checkCurrentState()},this._trackerDuration)})}dispose(){this.stop(),this.onSuccessObservable.clear(),this.onFailureObservable.clear(),this.onNewOptimizationAppliedObservable.clear(),this._sceneDisposeObserver&&this._scene.onDisposeObservable.remove(this._sceneDisposeObserver)}static OptimizeAsync(t,e,i,s){let r=new n(t,e||Vi.ModerateDegradationAllowed(),!1);return i&&r.onSuccessObservable.add(()=>{i()}),s&&r.onFailureObservable.add(()=>{s()}),r.start(),r}};function pa(n){let{engine:t}=n,e=new te(t);e.clearColor=new ie(0,0,0,0),e.pointerMovePredicate=()=>!1,e.pointerDownPredicate=()=>!1,e.pointerUpPredicate=()=>!1,e.clearCachedVertexData(),e.themeData={};let i=Vi.LowDegradationAllowed();return i.optimizations=i.optimizations.splice(1),i.targetFrameRate=60,Ar.OptimizeAsync(e,i),e}var Ot=class n extends ne{constructor(t,e,i,s=!0){super(t,e,i,s),this._tmpUpVector=v.Zero(),this._tmpTargetVector=v.Zero(),this.cameraDirection=new v(0,0,0),this.cameraRotation=new ve(0,0),this.ignoreParentScaling=!1,this.updateUpVectorFromRotation=!1,this._tmpQuaternion=new se,this.rotation=new v(0,0,0),this.speed=2,this.noRotationConstraint=!1,this.invertRotation=!1,this.inverseRotationSpeed=.2,this.lockedTarget=null,this._currentTarget=v.Zero(),this._initialFocalDistance=1,this._viewMatrix=P.Zero(),this._camMatrix=P.Zero(),this._cameraTransformMatrix=P.Zero(),this._cameraRotationMatrix=P.Zero(),this._referencePoint=new v(0,0,1),this._transformedReferencePoint=v.Zero(),this._defaultUp=v.Up(),this._cachedRotationZ=0,this._cachedQuaternionRotationZ=0}getFrontPosition(t){this.getWorldMatrix();let e=this.getTarget().subtract(this.position);return e.normalize(),e.scaleInPlace(t),this.globalPosition.add(e)}_getLockedTargetPosition(){return this.lockedTarget?(this.lockedTarget.absolutePosition&&this.lockedTarget.computeWorldMatrix(),this.lockedTarget.absolutePosition||this.lockedTarget):null}storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),super.storeState()}_restoreStateValues(){return super._restoreStateValues()?(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0):!1}_initCache(){super._initCache(),this._cache.lockedTarget=new v(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new v(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new se(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)}_updateCache(t){t||super._updateCache();let e=this._getLockedTargetPosition();e?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(e):this._cache.lockedTarget=e.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)}_isSynchronizedViewMatrix(){if(!super._isSynchronizedViewMatrix())return!1;let t=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(t):!t)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))}_computeLocalCameraSpeed(){let t=this.getEngine();return this.speed*Math.sqrt(t.getDeltaTime()/(t.getFps()*100))}setTarget(t){this.upVector.normalize(),this._initialFocalDistance=t.subtract(this.position).length(),this.position.z===t.z&&(this.position.z+=_e),this._referencePoint.normalize().scaleInPlace(this._initialFocalDistance),P.LookAtLHToRef(this.position,t,this._defaultUp,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);let e=t.subtract(this.position);e.x>=0?this.rotation.y=-Math.atan(e.z/e.x)+Math.PI/2:this.rotation.y=-Math.atan(e.z/e.x)-Math.PI/2,this.rotation.z=0,isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0),this.rotationQuaternion&&se.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}get target(){return this.getTarget()}set target(t){this.setTarget(t)}getTarget(){return this._currentTarget}_decideIfNeedsToMove(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){if(this.parent){this.parent.getWorldMatrix().invertToRef(C.Matrix[0]),v.TransformNormalToRef(this.cameraDirection,C.Matrix[0],C.Vector3[0]),this.position.addInPlace(C.Vector3[0]);return}this.position.addInPlace(this.cameraDirection)}_checkInputs(){let t=this.invertRotation?-this.inverseRotationSpeed:1,e=this._decideIfNeedsToMove(),i=Math.abs(this.cameraRotation.x)>0||Math.abs(this.cameraRotation.y)>0;e&&this._updatePosition(),i&&(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this.rotation),this.rotation.x+=this.cameraRotation.x*t,this.rotation.y+=this.cameraRotation.y*t,this.noRotationConstraint||(this.rotation.x>1.570796&&(this.rotation.x=1.570796),this.rotation.x<-1.570796&&(this.rotation.x=-1.570796)),this.rotationQuaternion&&this.rotation.lengthSquared()&&se.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)),e&&(Math.abs(this.cameraDirection.x)<this.speed*_e&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<this.speed*_e&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<this.speed*_e&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),i&&(Math.abs(this.cameraRotation.x)<this.speed*_e&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<this.speed*_e&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),super._checkInputs()}_updateCameraRotationMatrix(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):P.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}_rotateUpVectorWithCameraRotationMatrix(){return v.TransformNormalToRef(this._defaultUp,this._cameraRotationMatrix,this.upVector),this}_getViewMatrix(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),this.rotationQuaternion&&this._cachedQuaternionRotationZ!=this.rotationQuaternion.z?(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedQuaternionRotationZ=this.rotationQuaternion.z):this._cachedRotationZ!==this.rotation.z&&(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedRotationZ=this.rotation.z),v.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this.updateUpVectorFromRotation&&(this.rotationQuaternion?wt.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(se.FromEulerVectorToRef(this.rotation,this._tmpQuaternion),wt.Y.rotateByQuaternionToRef(this._tmpQuaternion,this.upVector))),this._computeViewMatrix(this.position,this._currentTarget,this.upVector),this._viewMatrix}_computeViewMatrix(t,e,i){if(this.ignoreParentScaling){if(this.parent){let s=this.parent.getWorldMatrix();v.TransformCoordinatesToRef(t,s,this._globalPosition),v.TransformCoordinatesToRef(e,s,this._tmpTargetVector),v.TransformNormalToRef(i,s,this._tmpUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(t),this._tmpTargetVector.copyFrom(e),this._tmpUpVector.copyFrom(i);this.getScene().useRightHandedSystem?P.LookAtRHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix):P.LookAtLHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix);return}if(this.getScene().useRightHandedSystem?P.LookAtRHToRef(t,e,i,this._viewMatrix):P.LookAtLHToRef(t,e,i,this._viewMatrix),this.parent){let s=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(s,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(t)}createRigCamera(t,e){if(this.cameraRigMode!==ne.RIG_MODE_NONE){let i=new n(t,this.position.clone(),this.getScene());return i.isRigCamera=!0,i.rigParent=this,(this.cameraRigMode===ne.RIG_MODE_VR||this.cameraRigMode===ne.RIG_MODE_WEBVR)&&(this.rotationQuaternion||(this.rotationQuaternion=new se),i._cameraRigParams={},i.rotationQuaternion=new se),i.mode=this.mode,i.orthoLeft=this.orthoLeft,i.orthoRight=this.orthoRight,i.orthoTop=this.orthoTop,i.orthoBottom=this.orthoBottom,i}return null}_updateRigCameras(){let t=this._rigCameras[0],e=this._rigCameras[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case ne.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case ne.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case ne.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case ne.RIG_MODE_STEREOSCOPIC_OVERUNDER:case ne.RIG_MODE_STEREOSCOPIC_INTERLACED:{let i=this.cameraRigMode===ne.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,s=this.cameraRigMode===ne.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*i,t),this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*s,e);break}case ne.RIG_MODE_VR:t.rotationQuaternion?(t.rotationQuaternion.copyFrom(this.rotationQuaternion),e.rotationQuaternion.copyFrom(this.rotationQuaternion)):(t.rotation.copyFrom(this.rotation),e.rotation.copyFrom(this.rotation)),t.position.copyFrom(this.position),e.position.copyFrom(this.position);break}super._updateRigCameras()}_getRigCamPositionAndTarget(t,e){this.getTarget().subtractToRef(this.position,n._TargetFocalPoint),n._TargetFocalPoint.normalize().scaleInPlace(this._initialFocalDistance);let i=n._TargetFocalPoint.addInPlace(this.position);P.TranslationToRef(-i.x,-i.y,-i.z,n._TargetTransformMatrix),n._TargetTransformMatrix.multiplyToRef(P.RotationAxis(e.upVector,t),n._RigCamTransformMatrix),P.TranslationToRef(i.x,i.y,i.z,n._TargetTransformMatrix),n._RigCamTransformMatrix.multiplyToRef(n._TargetTransformMatrix,n._RigCamTransformMatrix),v.TransformCoordinatesToRef(this.position,n._RigCamTransformMatrix,e.position),e.setTarget(i)}getClassName(){return"TargetCamera"}};Ot._RigCamTransformMatrix=new P;Ot._TargetTransformMatrix=new P;Ot._TargetFocalPoint=new v;S([Nt()],Ot.prototype,"rotation",void 0);S([A()],Ot.prototype,"speed",void 0);S([aa("lockedTargetId")],Ot.prototype,"lockedTarget",void 0);function ga(n){let{scene:t}=n,e,i=36.5;return e=new Ot("TargetCamera1",new v(0,i,0),t),e.fov=.25,e.minZ=5,e.maxZ=i+1,e.setTarget(v.Zero()),e}var re=class n extends Ge{constructor(t,e){super(t,e),this.diffuse=new me(1,1,1),this.specular=new me(1,1,1),this.falloffType=n.FALLOFF_DEFAULT,this.intensity=1,this._range=Number.MAX_VALUE,this._inverseSquaredRange=0,this._photometricScale=1,this._intensityMode=n.INTENSITYMODE_AUTOMATIC,this._radius=1e-5,this.renderPriority=0,this._shadowEnabled=!0,this._excludeWithLayerMask=0,this._includeOnlyWithLayerMask=0,this._lightmapMode=0,this._shadowGenerators=null,this._excludedMeshesIds=new Array,this._includedOnlyMeshesIds=new Array,this._isLight=!0,this.getScene().addLight(this),this._uniformBuffer=new Qe(this.getScene().getEngine(),void 0,void 0,t),this._buildUniformLayout(),this.includedOnlyMeshes=new Array,this.excludedMeshes=new Array,this._resyncMeshes()}get range(){return this._range}set range(t){this._range=t,this._inverseSquaredRange=1/(this.range*this.range)}get intensityMode(){return this._intensityMode}set intensityMode(t){this._intensityMode=t,this._computePhotometricScale()}get radius(){return this._radius}set radius(t){this._radius=t,this._computePhotometricScale()}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(t){this._shadowEnabled!==t&&(this._shadowEnabled=t,this._markMeshesAsLightDirty())}get includedOnlyMeshes(){return this._includedOnlyMeshes}set includedOnlyMeshes(t){this._includedOnlyMeshes=t,this._hookArrayForIncludedOnly(t)}get excludedMeshes(){return this._excludedMeshes}set excludedMeshes(t){this._excludedMeshes=t,this._hookArrayForExcluded(t)}get excludeWithLayerMask(){return this._excludeWithLayerMask}set excludeWithLayerMask(t){this._excludeWithLayerMask=t,this._resyncMeshes()}get includeOnlyWithLayerMask(){return this._includeOnlyWithLayerMask}set includeOnlyWithLayerMask(t){this._includeOnlyWithLayerMask=t,this._resyncMeshes()}get lightmapMode(){return this._lightmapMode}set lightmapMode(t){this._lightmapMode!==t&&(this._lightmapMode=t,this._markMeshesAsLightDirty())}transferTexturesToEffect(t,e){return this}_bindLight(t,e,i,s,r=!0){var a;let o=t.toString(),h=!1;if(this._uniformBuffer.bindToEffect(i,"Light"+o),this._renderId!==e.getRenderId()||this._lastUseSpecular!==s||!this._uniformBuffer.useUbo){this._renderId=e.getRenderId(),this._lastUseSpecular=s;let l=this.getScaledIntensity();this.transferToEffect(i,o),this.diffuse.scaleToRef(l,Vt.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",Vt.Color3[0],this.range,o),s&&(this.specular.scaleToRef(l,Vt.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",Vt.Color3[1],this.radius,o)),h=!0}if(this.transferTexturesToEffect(i,o),e.shadowsEnabled&&this.shadowEnabled&&r){let l=(a=this.getShadowGenerator(e.activeCamera))!==null&&a!==void 0?a:this.getShadowGenerator();l&&(l.bindShadowLight(o,i),h=!0)}h?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()}getClassName(){return"Light"}toString(t){let e="Name: "+this.name;if(e+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(let i=0;i<this.animations.length;i++)e+=", animation[0]: "+this.animations[i].toString(t);return e}_syncParentEnabledState(){super._syncParentEnabledState(),this.isDisposed()||this._resyncMeshes()}setEnabled(t){super.setEnabled(t),this._resyncMeshes()}getShadowGenerator(t=null){var e;return this._shadowGenerators===null?null:(e=this._shadowGenerators.get(t))!==null&&e!==void 0?e:null}getShadowGenerators(){return this._shadowGenerators}getAbsolutePosition(){return v.Zero()}canAffectMesh(t){return t?!(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&this.includedOnlyMeshes.indexOf(t)===-1||this.excludedMeshes&&this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(t)!==-1||this.includeOnlyWithLayerMask!==0&&!(this.includeOnlyWithLayerMask&t.layerMask)||this.excludeWithLayerMask!==0&&this.excludeWithLayerMask&t.layerMask):!0}dispose(t,e=!1){if(this._shadowGenerators){let i=this._shadowGenerators.values();for(let s=i.next();s.done!==!0;s=i.next())s.value.dispose();this._shadowGenerators=null}if(this.getScene().stopAnimation(this),this._parentContainer){let i=this._parentContainer.lights.indexOf(this);i>-1&&this._parentContainer.lights.splice(i,1),this._parentContainer=null}for(let i of this.getScene().meshes)i._removeLightSource(this,!0);this._uniformBuffer.dispose(),this.getScene().removeLight(this),super.dispose(t,e)}getTypeID(){return 0}getScaledIntensity(){return this._photometricScale*this.intensity}clone(t,e=null){let i=n.GetConstructorFromName(this.getTypeID(),t,this.getScene());if(!i)return null;let s=ee.Clone(i,this);return t&&(s.name=t),e&&(s.parent=e),s.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(s),s}serialize(){let t=ee.Serialize(this);return t.uniqueId=this.uniqueId,t.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(t),this.excludedMeshes.length>0&&(t.excludedMeshesIds=[],this.excludedMeshes.forEach(e=>{t.excludedMeshesIds.push(e.id)})),this.includedOnlyMeshes.length>0&&(t.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach(e=>{t.includedOnlyMeshesIds.push(e.id)})),ee.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t.isEnabled=this.isEnabled(),t}static GetConstructorFromName(t,e,i){return Ge.Construct("Light_Type_"+t,e,i)||null}static Parse(t,e){let i=n.GetConstructorFromName(t.type,t.name,e);if(!i)return null;let s=ee.Parse(i,t,e);if(t.excludedMeshesIds&&(s._excludedMeshesIds=t.excludedMeshesIds),t.includedOnlyMeshesIds&&(s._includedOnlyMeshesIds=t.includedOnlyMeshesIds),t.parentId!==void 0&&(s._waitingParentId=t.parentId),t.parentInstanceIndex!==void 0&&(s._waitingParentInstanceIndex=t.parentInstanceIndex),t.falloffType!==void 0&&(s.falloffType=t.falloffType),t.lightmapMode!==void 0&&(s.lightmapMode=t.lightmapMode),t.animations){for(let r=0;r<t.animations.length;r++){let a=t.animations[r],o=Zt("BABYLON.Animation");o&&s.animations.push(o.Parse(a))}Ge.ParseAnimationRanges(s,t,e)}return t.autoAnimate&&e.beginAnimation(s,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),t.isEnabled!==void 0&&s.setEnabled(t.isEnabled),s}_hookArrayForExcluded(t){let e=t.push;t.push=(...s)=>{let r=e.apply(t,s);for(let a of s)a._resyncLightSource(this);return r};let i=t.splice;t.splice=(s,r)=>{let a=i.apply(t,[s,r]);for(let o of a)o._resyncLightSource(this);return a};for(let s of t)s._resyncLightSource(this)}_hookArrayForIncludedOnly(t){let e=t.push;t.push=(...s)=>{let r=e.apply(t,s);return this._resyncMeshes(),r};let i=t.splice;t.splice=(s,r)=>{let a=i.apply(t,[s,r]);return this._resyncMeshes(),a},this._resyncMeshes()}_resyncMeshes(){for(let t of this.getScene().meshes)t._resyncLightSource(this)}_markMeshesAsLightDirty(){for(let t of this.getScene().meshes)t.lightSources.indexOf(this)!==-1&&t._markSubMeshesAsLightDirty()}_computePhotometricScale(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()}_getPhotometricScale(){let t=0,e=this.getTypeID(),i=this.intensityMode;switch(i===n.INTENSITYMODE_AUTOMATIC&&(e===n.LIGHTTYPEID_DIRECTIONALLIGHT?i=n.INTENSITYMODE_ILLUMINANCE:i=n.INTENSITYMODE_LUMINOUSINTENSITY),e){case n.LIGHTTYPEID_POINTLIGHT:case n.LIGHTTYPEID_SPOTLIGHT:switch(i){case n.INTENSITYMODE_LUMINOUSPOWER:t=1/(4*Math.PI);break;case n.INTENSITYMODE_LUMINOUSINTENSITY:t=1;break;case n.INTENSITYMODE_LUMINANCE:t=this.radius*this.radius;break}break;case n.LIGHTTYPEID_DIRECTIONALLIGHT:switch(i){case n.INTENSITYMODE_ILLUMINANCE:t=1;break;case n.INTENSITYMODE_LUMINANCE:{let s=this.radius;s=Math.max(s,.001),t=2*Math.PI*(1-Math.cos(s));break}}break;case n.LIGHTTYPEID_HEMISPHERICLIGHT:t=1;break}return t}_reorderLightsInScene(){let t=this.getScene();this._renderPriority!=0&&(t.requireLightSorting=!0),this.getScene().sortLightsByPriority()}};re.FALLOFF_DEFAULT=Me.FALLOFF_DEFAULT;re.FALLOFF_PHYSICAL=Me.FALLOFF_PHYSICAL;re.FALLOFF_GLTF=Me.FALLOFF_GLTF;re.FALLOFF_STANDARD=Me.FALLOFF_STANDARD;re.LIGHTMAP_DEFAULT=Me.LIGHTMAP_DEFAULT;re.LIGHTMAP_SPECULAR=Me.LIGHTMAP_SPECULAR;re.LIGHTMAP_SHADOWSONLY=Me.LIGHTMAP_SHADOWSONLY;re.INTENSITYMODE_AUTOMATIC=Me.INTENSITYMODE_AUTOMATIC;re.INTENSITYMODE_LUMINOUSPOWER=Me.INTENSITYMODE_LUMINOUSPOWER;re.INTENSITYMODE_LUMINOUSINTENSITY=Me.INTENSITYMODE_LUMINOUSINTENSITY;re.INTENSITYMODE_ILLUMINANCE=Me.INTENSITYMODE_ILLUMINANCE;re.INTENSITYMODE_LUMINANCE=Me.INTENSITYMODE_LUMINANCE;re.LIGHTTYPEID_POINTLIGHT=Me.LIGHTTYPEID_POINTLIGHT;re.LIGHTTYPEID_DIRECTIONALLIGHT=Me.LIGHTTYPEID_DIRECTIONALLIGHT;re.LIGHTTYPEID_SPOTLIGHT=Me.LIGHTTYPEID_SPOTLIGHT;re.LIGHTTYPEID_HEMISPHERICLIGHT=Me.LIGHTTYPEID_HEMISPHERICLIGHT;S([Jt()],re.prototype,"diffuse",void 0);S([Jt()],re.prototype,"specular",void 0);S([A()],re.prototype,"falloffType",void 0);S([A()],re.prototype,"intensity",void 0);S([A()],re.prototype,"range",null);S([A()],re.prototype,"intensityMode",null);S([A()],re.prototype,"radius",null);S([A()],re.prototype,"_renderPriority",void 0);S([ae("_reorderLightsInScene")],re.prototype,"renderPriority",void 0);S([A("shadowEnabled")],re.prototype,"_shadowEnabled",void 0);S([A("excludeWithLayerMask")],re.prototype,"_excludeWithLayerMask",void 0);S([A("includeOnlyWithLayerMask")],re.prototype,"_includeOnlyWithLayerMask",void 0);S([A("lightmapMode")],re.prototype,"_lightmapMode",void 0);var $t=class extends re{constructor(){super(...arguments),this._needProjectionMatrixCompute=!0}_setPosition(t){this._position=t}get position(){return this._position}set position(t){this._setPosition(t)}_setDirection(t){this._direction=t}get direction(){return this._direction}set direction(t){this._setDirection(t)}get shadowMinZ(){return this._shadowMinZ}set shadowMinZ(t){this._shadowMinZ=t,this.forceProjectionMatrixCompute()}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(t){this._shadowMaxZ=t,this.forceProjectionMatrixCompute()}computeTransformedInformation(){return this.parent&&this.parent.getWorldMatrix?(this.transformedPosition||(this.transformedPosition=v.Zero()),v.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=v.Zero()),v.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),!0):!1}getDepthScale(){return 50}getShadowDirection(t){return this.transformedDirection?this.transformedDirection:this.direction}getAbsolutePosition(){return this.transformedPosition?this.transformedPosition:this.position}setDirectionToTarget(t){return this.direction=v.Normalize(t.subtract(this.position)),this.direction}getRotation(){this.direction.normalize();let t=v.Cross(this.direction,wt.Y),e=v.Cross(t,this.direction);return v.RotationFromAxis(t,e,this.direction)}needCube(){return!1}needProjectionMatrixCompute(){return this._needProjectionMatrixCompute}forceProjectionMatrixCompute(){this._needProjectionMatrixCompute=!0}_initCache(){super._initCache(),this._cache.position=v.Zero()}_isSynchronized(){return!!this._cache.position.equals(this.position)}computeWorldMatrix(t){return!t&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=P.Identity()),P.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix)}getDepthMinZ(t){return this.shadowMinZ!==void 0?this.shadowMinZ:t.minZ}getDepthMaxZ(t){return this.shadowMaxZ!==void 0?this.shadowMaxZ:t.maxZ}setShadowProjectionMatrix(t,e,i){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(e,i,t):this._setDefaultShadowProjectionMatrix(t,e,i),this}_syncParentEnabledState(){super._syncParentEnabledState(),(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition=null,this.transformedDirection=null)}};S([Nt()],$t.prototype,"position",null);S([Nt()],$t.prototype,"direction",null);S([A()],$t.prototype,"shadowMinZ",null);S([A()],$t.prototype,"shadowMaxZ",null);Ge.AddNodeConstructor("Light_Type_1",(n,t)=>()=>new st(n,v.Zero(),t));var st=class extends $t{constructor(t,e,i){super(t,i),this._shadowFrustumSize=0,this._shadowOrthoScale=.1,this.autoUpdateExtends=!0,this.autoCalcShadowZBounds=!1,this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE,this.position=e.scale(-1),this.direction=e}get shadowFrustumSize(){return this._shadowFrustumSize}set shadowFrustumSize(t){this._shadowFrustumSize=t,this.forceProjectionMatrixCompute()}get shadowOrthoScale(){return this._shadowOrthoScale}set shadowOrthoScale(t){this._shadowOrthoScale=t,this.forceProjectionMatrixCompute()}get orthoLeft(){return this._orthoLeft}set orthoLeft(t){this._orthoLeft=t}get orthoRight(){return this._orthoRight}set orthoRight(t){this._orthoRight=t}get orthoTop(){return this._orthoTop}set orthoTop(t){this._orthoTop=t}get orthoBottom(){return this._orthoBottom}set orthoBottom(t){this._orthoBottom=t}getClassName(){return"DirectionalLight"}getTypeID(){return re.LIGHTTYPEID_DIRECTIONALLIGHT}_setDefaultShadowProjectionMatrix(t,e,i){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(t):this._setDefaultAutoExtendShadowProjectionMatrix(t,e,i)}_setDefaultFixedFrustumShadowProjectionMatrix(t){let e=this.getScene().activeCamera;e&&P.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,this.shadowMinZ!==void 0?this.shadowMinZ:e.minZ,this.shadowMaxZ!==void 0?this.shadowMaxZ:e.maxZ,t,this.getScene().getEngine().isNDCHalfZRange)}_setDefaultAutoExtendShadowProjectionMatrix(t,e,i){let s=this.getScene().activeCamera;if(!s)return;if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){let c=v.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE;let d=Number.MAX_VALUE,u=Number.MIN_VALUE;for(let f=0;f<i.length;f++){let _=i[f];if(!_)continue;let g=_.getBoundingInfo().boundingBox;for(let p=0;p<g.vectorsWorld.length;p++)v.TransformCoordinatesToRef(g.vectorsWorld[p],e,c),c.x<this._orthoLeft&&(this._orthoLeft=c.x),c.y<this._orthoBottom&&(this._orthoBottom=c.y),c.x>this._orthoRight&&(this._orthoRight=c.x),c.y>this._orthoTop&&(this._orthoTop=c.y),this.autoCalcShadowZBounds&&(c.z<d&&(d=c.z),c.z>u&&(u=c.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=d,this._shadowMaxZ=u)}let r=this._orthoRight-this._orthoLeft,a=this._orthoTop-this._orthoBottom,o=this.shadowMinZ!==void 0?this.shadowMinZ:s.minZ,h=this.shadowMaxZ!==void 0?this.shadowMaxZ:s.maxZ,l=this.getScene().getEngine().useReverseDepthBuffer;P.OrthoOffCenterLHToRef(this._orthoLeft-r*this.shadowOrthoScale,this._orthoRight+r*this.shadowOrthoScale,this._orthoBottom-a*this.shadowOrthoScale,this._orthoTop+a*this.shadowOrthoScale,l?h:o,l?o:h,t,this.getScene().getEngine().isNDCHalfZRange)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(t,e){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,e),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,e),this)}transferToNodeMaterialEffect(t,e){return this.computeTransformedInformation()?(t.setFloat3(e,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(t.setFloat3(e,this.direction.x,this.direction.y,this.direction.z),this)}getDepthMinZ(t){let e=this._scene.getEngine();return!e.useReverseDepthBuffer&&e.isNDCHalfZRange?0:1}getDepthMaxZ(t){let e=this._scene.getEngine();return e.useReverseDepthBuffer&&e.isNDCHalfZRange?0:1}prepareLightSpecificDefines(t,e){t["DIRLIGHT"+e]=!0}};S([A()],st.prototype,"shadowFrustumSize",null);S([A()],st.prototype,"shadowOrthoScale",null);S([A()],st.prototype,"autoUpdateExtends",void 0);S([A()],st.prototype,"autoCalcShadowZBounds",void 0);S([A("orthoLeft")],st.prototype,"_orthoLeft",void 0);S([A("orthoRight")],st.prototype,"_orthoRight",void 0);S([A("orthoTop")],st.prototype,"_orthoTop",void 0);S([A("orthoBottom")],st.prototype,"_orthoBottom",void 0);Ge.AddNodeConstructor("Light_Type_3",(n,t)=>()=>new mi(n,v.Zero(),t));var mi=class extends re{constructor(t,e,i){super(t,i),this.groundColor=new me(0,0,0),this.direction=e||v.Up()}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}getClassName(){return"HemisphericLight"}setDirectionToTarget(t){return this.direction=v.Normalize(t.subtract(v.Zero())),this.direction}getShadowGenerator(){return null}transferToEffect(t,e){let i=v.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",i.x,i.y,i.z,0,e),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),e),this}transferToNodeMaterialEffect(t,e){let i=v.Normalize(this.direction);return t.setFloat3(e,i.x,i.y,i.z),this}computeWorldMatrix(){return this._worldMatrix||(this._worldMatrix=P.Identity()),this._worldMatrix}getTypeID(){return re.LIGHTTYPEID_HEMISPHERICLIGHT}prepareLightSpecificDefines(t,e){t["HEMILIGHT"+e]=!0}};S([Jt()],mi.prototype,"groundColor",void 0);S([Nt()],mi.prototype,"direction",void 0);var vs=class n{constructor(t,e){this.width=t,this.height=e}toString(){return`{W: ${this.width}, H: ${this.height}}`}getClassName(){return"Size"}getHashCode(){let t=this.width|0;return t=t*397^(this.height|0),t}copyFrom(t){this.width=t.width,this.height=t.height}copyFromFloats(t,e){return this.width=t,this.height=e,this}set(t,e){return this.copyFromFloats(t,e)}multiplyByFloats(t,e){return new n(this.width*t,this.height*e)}clone(){return new n(this.width,this.height)}equals(t){return t?this.width===t.width&&this.height===t.height:!1}get surface(){return this.width*this.height}static Zero(){return new n(0,0)}add(t){return new n(this.width+t.width,this.height+t.height)}subtract(t){return new n(this.width-t.width,this.height-t.height)}static Lerp(t,e,i){let s=t.width+(e.width-t.width)*i,r=t.height+(e.height-t.height)*i;return new n(s,r)}},Rr=class{constructor(t){this._wrapU=1,this._wrapV=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this._texture=null,this._engine=null,this._cachedSize=vs.Zero(),this._cachedBaseSize=vs.Zero(),this._initialSamplingMode=2,this._texture=t,this._texture&&(this._engine=this._texture.getEngine())}get wrapU(){return this._wrapU}set wrapU(t){this._wrapU=t}get wrapV(){return this._wrapV}set wrapV(t){this._wrapV=t}get coordinatesMode(){return 0}get isCube(){return this._texture?this._texture.isCube:!1}set isCube(t){this._texture&&(this._texture.isCube=t)}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(t){this._texture&&(this._texture.is3D=t)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(t){this._texture&&(this._texture.is2DArray=t)}getClassName(){return"ThinTexture"}isReady(){return this.delayLoadState===4?(this.delayLoad(),!1):this._texture?this._texture.isReady:!1}delayLoad(){}getInternalTexture(){return this._texture}getSize(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize}getBaseSize(){return!this.isReady()||!this._texture?(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize):this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize)}get samplingMode(){return this._texture?this._texture.samplingMode:this._initialSamplingMode}updateSamplingMode(t){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(t,this._texture)}releaseInternalTexture(){this._texture&&(this._texture.dispose(),this._texture=null)}dispose(){this._texture&&(this.releaseInternalTexture(),this._engine=null)}},Ee=(()=>{class n extends Rr{constructor(e,i=null){super(null),this.metadata=null,this.reservedDataStore=null,this._hasAlpha=!1,this._getAlphaFromRGB=!1,this.level=1,this._coordinatesIndex=0,this.optimizeUVAllocation=!0,this._coordinatesMode=0,this.wrapR=1,this.anisotropicFilteringLevel=n.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,this._isCube=!1,this._gammaSpace=!0,this.invertZ=!1,this.lodLevelInAlpha=!1,this.isRenderTarget=!1,this._prefiltered=!1,this._forceSerialize=!1,this.animations=new Array,this.onDisposeObservable=new D,this._onDisposeObserver=null,this._scene=null,this._uid=null,this._parentContainer=null,this._loadingError=!1,e?n._IsScene(e)?this._scene=e:this._engine=e:this._scene=Q.LastCreatedScene,this._scene&&(this.uniqueId=this._scene.getUniqueId(),this._scene.addTexture(this),this._engine=this._scene.getEngine()),this._texture=i,this._uid=null}set hasAlpha(e){this._hasAlpha!==e&&(this._hasAlpha=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)))}get hasAlpha(){return this._hasAlpha}set getAlphaFromRGB(e){this._getAlphaFromRGB!==e&&(this._getAlphaFromRGB=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)))}get getAlphaFromRGB(){return this._getAlphaFromRGB}set coordinatesIndex(e){this._coordinatesIndex!==e&&(this._coordinatesIndex=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)))}get coordinatesIndex(){return this._coordinatesIndex}set coordinatesMode(e){this._coordinatesMode!==e&&(this._coordinatesMode=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)))}get coordinatesMode(){return this._coordinatesMode}get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get isCube(){return this._texture?this._texture.isCube:this._isCube}set isCube(e){this._texture?this._texture.isCube=e:this._isCube=e}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}get gammaSpace(){if(this._texture)this._texture._gammaSpace===null&&(this._texture._gammaSpace=this._gammaSpace);else return this._gammaSpace;return this._texture._gammaSpace&&!this._texture._useSRGBBuffer}set gammaSpace(e){if(this._texture){if(this._texture._gammaSpace===e)return;this._texture._gammaSpace=e}else{if(this._gammaSpace===e)return;this._gammaSpace=e}this._markAllSubMeshesAsTexturesDirty()}get isRGBD(){return this._texture!=null&&this._texture._isRGBD}set isRGBD(e){this._texture&&(this._texture._isRGBD=e)}get noMipmap(){return!1}get lodGenerationOffset(){return this._texture?this._texture._lodGenerationOffset:0}set lodGenerationOffset(e){this._texture&&(this._texture._lodGenerationOffset=e)}get lodGenerationScale(){return this._texture?this._texture._lodGenerationScale:0}set lodGenerationScale(e){this._texture&&(this._texture._lodGenerationScale=e)}get linearSpecularLOD(){return this._texture?this._texture._linearSpecularLOD:!1}set linearSpecularLOD(e){this._texture&&(this._texture._linearSpecularLOD=e)}get irradianceTexture(){return this._texture?this._texture._irradianceTexture:null}set irradianceTexture(e){this._texture&&(this._texture._irradianceTexture=e)}get uid(){return this._uid||(this._uid=Cn()),this._uid}toString(){return this.name}getClassName(){return"BaseTexture"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get isBlocking(){return!0}get loadingError(){return this._loadingError}get errorObject(){return this._errorObject}getScene(){return this._scene}_getEngine(){return this._engine}checkTransformsAreIdentical(e){return e!==null}getTextureMatrix(){return P.IdentityReadOnly}getReflectionTextureMatrix(){return P.IdentityReadOnly}isReadyOrNotBlocking(){return!this.isBlocking||this.isReady()||this.loadingError}scale(e){}get canRescale(){return!1}_getFromCache(e,i,s,r,a,o){let h=this._getEngine();if(!h)return null;let l=h._getUseSRGBBuffer(!!a,i),c=h.getLoadedTexturesCache();for(let d=0;d<c.length;d++){let u=c[d];if((a===void 0||l===u._useSRGBBuffer)&&(r===void 0||r===u.invertY)&&u.url===e&&u.generateMipMaps===!i&&(!s||s===u.samplingMode)&&(o===void 0||o===u.isCube))return u.incrementReferences(),u}return null}_rebuild(){}clone(){return null}get textureType(){return this._texture&&this._texture.type!==void 0?this._texture.type:0}get textureFormat(){return this._texture&&this._texture.format!==void 0?this._texture.format:5}_markAllSubMeshesAsTexturesDirty(){let e=this.getScene();e&&e.markAllMaterialsAsDirty(1)}readPixels(e=0,i=0,s=null,r=!0,a=!1,o=0,h=0,l=Number.MAX_VALUE,c=Number.MAX_VALUE){if(!this._texture)return null;let d=this._getEngine();if(!d)return null;let u=this.getSize(),f=u.width,_=u.height;i!==0&&(f=f/Math.pow(2,i),_=_/Math.pow(2,i),f=Math.round(f),_=Math.round(_)),l=Math.min(f,l),c=Math.min(_,c);try{return this._texture.isCube?d._readTexturePixels(this._texture,l,c,e,i,s,r,a,o,h):d._readTexturePixels(this._texture,l,c,-1,i,s,r,a,o,h)}catch{return null}}_readPixelsSync(e=0,i=0,s=null,r=!0,a=!1){if(!this._texture)return null;let o=this.getSize(),h=o.width,l=o.height,c=this._getEngine();if(!c)return null;i!=0&&(h=h/Math.pow(2,i),l=l/Math.pow(2,i),h=Math.round(h),l=Math.round(l));try{return this._texture.isCube?c._readTexturePixelsSync(this._texture,h,l,e,i,s,r,a):c._readTexturePixelsSync(this._texture,h,l,-1,i,s,r,a)}catch{return null}}get _lodTextureHigh(){return this._texture?this._texture._lodTextureHigh:null}get _lodTextureMid(){return this._texture?this._texture._lodTextureMid:null}get _lodTextureLow(){return this._texture?this._texture._lodTextureLow:null}dispose(){if(this._scene){this._scene.stopAnimation&&this._scene.stopAnimation(this),this._scene.removePendingData(this);let e=this._scene.textures.indexOf(this);if(e>=0&&this._scene.textures.splice(e,1),this._scene.onTextureRemovedObservable.notifyObservers(this),this._scene=null,this._parentContainer){let i=this._parentContainer.textures.indexOf(this);i>-1&&this._parentContainer.textures.splice(i,1),this._parentContainer=null}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,super.dispose()}serialize(e=!1){if(!this.name&&!e)return null;let i=ee.Serialize(this);return ee.AppendSerializedAnimations(this,i),i}static WhenAllReady(e,i){let s=e.length;if(s===0){i();return}for(let r=0;r<e.length;r++){let a=e[r];if(a.isReady())--s===0&&i();else{let o=a.onLoadObservable;o?o.addOnce(()=>{--s===0&&i()}):--s===0&&i()}}}static _IsScene(e){return e.getClassName()==="Scene"}}return n.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4,n})();S([A()],Ee.prototype,"uniqueId",void 0);S([A()],Ee.prototype,"name",void 0);S([A()],Ee.prototype,"metadata",void 0);S([A("hasAlpha")],Ee.prototype,"_hasAlpha",void 0);S([A("getAlphaFromRGB")],Ee.prototype,"_getAlphaFromRGB",void 0);S([A()],Ee.prototype,"level",void 0);S([A("coordinatesIndex")],Ee.prototype,"_coordinatesIndex",void 0);S([A()],Ee.prototype,"optimizeUVAllocation",void 0);S([A("coordinatesMode")],Ee.prototype,"_coordinatesMode",void 0);S([A()],Ee.prototype,"wrapU",null);S([A()],Ee.prototype,"wrapV",null);S([A()],Ee.prototype,"wrapR",void 0);S([A()],Ee.prototype,"anisotropicFilteringLevel",void 0);S([A()],Ee.prototype,"isCube",null);S([A()],Ee.prototype,"is3D",null);S([A()],Ee.prototype,"is2DArray",null);S([A()],Ee.prototype,"gammaSpace",null);S([A()],Ee.prototype,"invertZ",void 0);S([A()],Ee.prototype,"lodLevelInAlpha",void 0);S([A()],Ee.prototype,"lodGenerationOffset",null);S([A()],Ee.prototype,"lodGenerationScale",null);S([A()],Ee.prototype,"linearSpecularLOD",null);S([rt()],Ee.prototype,"irradianceTexture",null);S([A()],Ee.prototype,"isRenderTarget",void 0);function wn(n,t,e=!1){let i=t.width,s=t.height;if(n instanceof Float32Array){let h=n.byteLength/n.BYTES_PER_ELEMENT,l=new Uint8Array(h);for(;--h>=0;){let c=n[h];c<0?c=0:c>1&&(c=1),l[h]=c*255}n=l}let r=document.createElement("canvas");r.width=i,r.height=s;let a=r.getContext("2d");if(!a)return null;let o=a.createImageData(i,s);if(o.data.set(n),a.putImageData(o,0,0),e){let h=document.createElement("canvas");h.width=i,h.height=s;let l=h.getContext("2d");return l?(l.translate(0,s),l.scale(1,-1),l.drawImage(r,0,0),h.toDataURL("image/png")):null}return r.toDataURL("image/png")}function ma(n,t=0,e=0){let i=n.getInternalTexture();if(!i)return null;let s=n._readPixelsSync(t,e);return s?wn(s,n.getSize(),i.invertY):null}function va(n,t=0,e=0){return Ne(this,null,function*(){let i=n.getInternalTexture();if(!i)return null;let s=yield n.readPixels(t,e);return s?wn(s,n.getSize(),i.invertY):null})}var L=class n extends Ee{constructor(t,e,i,s,r=n.TRILINEAR_SAMPLINGMODE,a=null,o=null,h=null,l=!1,c,d,u,f,_){var g,p,E,T,R,y,M,b,x;super(e),this.url=null,this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.uRotationCenter=.5,this.vRotationCenter=.5,this.wRotationCenter=.5,this.homogeneousRotationInUVTransform=!1,this.inspectableCustomProperties=null,this._noMipmap=!1,this._invertY=!1,this._rowGenerationMatrix=null,this._cachedTextureMatrix=null,this._projectionModeMatrix=null,this._t0=null,this._t1=null,this._t2=null,this._cachedUOffset=-1,this._cachedVOffset=-1,this._cachedUScale=0,this._cachedVScale=0,this._cachedUAng=-1,this._cachedVAng=-1,this._cachedWAng=-1,this._cachedReflectionProjectionMatrixId=-1,this._cachedURotationCenter=-1,this._cachedVRotationCenter=-1,this._cachedWRotationCenter=-1,this._cachedHomogeneousRotationInUVTransform=!1,this._cachedReflectionTextureMatrix=null,this._cachedReflectionUOffset=-1,this._cachedReflectionVOffset=-1,this._cachedReflectionUScale=0,this._cachedReflectionVScale=0,this._cachedReflectionCoordinatesMode=-1,this._buffer=null,this._deleteBuffer=!1,this._format=null,this._delayedOnLoad=null,this._delayedOnError=null,this.onLoadObservable=new D,this._isBlocking=!0,this.name=t||"",this.url=t;let F,I=!1,N=null;typeof i=="object"&&i!==null?(F=(g=i.noMipmap)!==null&&g!==void 0?g:!1,s=(p=i.invertY)!==null&&p!==void 0?p:!tt.UseOpenGLOrientationForUV,r=(E=i.samplingMode)!==null&&E!==void 0?E:n.TRILINEAR_SAMPLINGMODE,a=(T=i.onLoad)!==null&&T!==void 0?T:null,o=(R=i.onError)!==null&&R!==void 0?R:null,h=(y=i.buffer)!==null&&y!==void 0?y:null,l=(M=i.deleteBuffer)!==null&&M!==void 0?M:!1,c=i.format,d=i.mimeType,u=i.loaderOptions,f=i.creationFlags,I=(b=i.useSRGBBuffer)!==null&&b!==void 0?b:!1,N=(x=i.internalTexture)!==null&&x!==void 0?x:null):F=!!i,this._noMipmap=F,this._invertY=s===void 0?!tt.UseOpenGLOrientationForUV:s,this._initialSamplingMode=r,this._buffer=h,this._deleteBuffer=l,this._mimeType=d,this._loaderOptions=u,this._creationFlags=f,this._useSRGBBuffer=I,this._forcedExtension=_,c&&(this._format=c);let G=this.getScene(),Y=this._getEngine();if(!Y)return;Y.onBeforeTextureInitObservable.notifyObservers(this);let q=()=>{this._texture&&(this._texture._invertVScale&&(this.vScale*=-1,this.vOffset+=1),this._texture._cachedWrapU!==null&&(this.wrapU=this._texture._cachedWrapU,this._texture._cachedWrapU=null),this._texture._cachedWrapV!==null&&(this.wrapV=this._texture._cachedWrapV,this._texture._cachedWrapV=null),this._texture._cachedWrapR!==null&&(this.wrapR=this._texture._cachedWrapR,this._texture._cachedWrapR=null)),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this),a&&a(),!this.isBlocking&&G&&G.resetCachedMaterial()},j=($,Te)=>{this._loadingError=!0,this._errorObject={message:$,exception:Te},o&&o($,Te),n.OnTextureLoadErrorObservable.notifyObservers(this)};if(!this.url&&!N){this._delayedOnLoad=q,this._delayedOnError=j;return}if(this._texture=N??this._getFromCache(this.url,F,r,this._invertY,I),this._texture)if(this._texture.isReady)ci.SetImmediate(()=>q());else{let $=this._texture.onLoadedObservable.add(q);this._texture.onErrorObservable.add(Te=>{var Se;j(Te.message,Te.exception),(Se=this._texture)===null||Se===void 0||Se.onLoadedObservable.remove($)})}else if(!G||!G.useDelayedTextureLoading){try{this._texture=Y.createTexture(this.url,F,this._invertY,G,r,q,j,this._buffer,void 0,this._format,this._forcedExtension,d,u,f,I)}catch($){throw j("error loading",$),$}l&&(this._buffer=null)}else this.delayLoadState=4,this._delayedOnLoad=q,this._delayedOnError=j}get noMipmap(){return this._noMipmap}get mimeType(){return this._mimeType}set isBlocking(t){this._isBlocking=t}get isBlocking(){return this._isBlocking}get invertY(){return this._invertY}updateURL(t,e=null,i,s){this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(1)),(!this.name||this.name.startsWith("data:"))&&(this.name=t),this.url=t,this._buffer=e,this._forcedExtension=s,this.delayLoadState=4,i&&(this._delayedOnLoad=i),this.delayLoad()}delayLoad(){if(this.delayLoadState!==4)return;let t=this.getScene();t&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap,this.samplingMode,this._invertY,this._useSRGBBuffer),this._texture?this._delayedOnLoad&&(this._texture.isReady?ci.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=t.getEngine().createTexture(this.url,this._noMipmap,this._invertY,t,this.samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format,this._forcedExtension,this._mimeType,this._loaderOptions,this._creationFlags,this._useSRGBBuffer),this._deleteBuffer&&(this._buffer=null)),this._delayedOnLoad=null,this._delayedOnError=null)}_prepareRowForTextureGeneration(t,e,i,s){t*=this._cachedUScale,e*=this._cachedVScale,t-=this.uRotationCenter*this._cachedUScale,e-=this.vRotationCenter*this._cachedVScale,i-=this.wRotationCenter,v.TransformCoordinatesFromFloatsToRef(t,e,i,this._rowGenerationMatrix,s),s.x+=this.uRotationCenter*this._cachedUScale+this._cachedUOffset,s.y+=this.vRotationCenter*this._cachedVScale+this._cachedVOffset,s.z+=this.wRotationCenter}checkTransformsAreIdentical(t){return t!==null&&this.uOffset===t.uOffset&&this.vOffset===t.vOffset&&this.uScale===t.uScale&&this.vScale===t.vScale&&this.uAng===t.uAng&&this.vAng===t.vAng&&this.wAng===t.wAng}getTextureMatrix(t=1){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale*t===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng&&this.uRotationCenter===this._cachedURotationCenter&&this.vRotationCenter===this._cachedVRotationCenter&&this.wRotationCenter===this._cachedWRotationCenter&&this.homogeneousRotationInUVTransform===this._cachedHomogeneousRotationInUVTransform)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale*t,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedURotationCenter=this.uRotationCenter,this._cachedVRotationCenter=this.vRotationCenter,this._cachedWRotationCenter=this.wRotationCenter,this._cachedHomogeneousRotationInUVTransform=this.homogeneousRotationInUVTransform,(!this._cachedTextureMatrix||!this._rowGenerationMatrix)&&(this._cachedTextureMatrix=P.Zero(),this._rowGenerationMatrix=new P,this._t0=v.Zero(),this._t1=v.Zero(),this._t2=v.Zero()),P.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this.homogeneousRotationInUVTransform?(P.TranslationToRef(-this._cachedURotationCenter,-this._cachedVRotationCenter,-this._cachedWRotationCenter,C.Matrix[0]),P.TranslationToRef(this._cachedURotationCenter,this._cachedVRotationCenter,this._cachedWRotationCenter,C.Matrix[1]),P.ScalingToRef(this._cachedUScale,this._cachedVScale,0,C.Matrix[2]),P.TranslationToRef(this._cachedUOffset,this._cachedVOffset,0,C.Matrix[3]),C.Matrix[0].multiplyToRef(this._rowGenerationMatrix,this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(C.Matrix[1],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(C.Matrix[2],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(C.Matrix[3],this._cachedTextureMatrix),this._cachedTextureMatrix.setRowFromFloats(2,this._cachedTextureMatrix.m[12],this._cachedTextureMatrix.m[13],this._cachedTextureMatrix.m[14],1)):(this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),P.FromValuesToRef(this._t1.x,this._t1.y,this._t1.z,0,this._t2.x,this._t2.y,this._t2.z,0,this._t0.x,this._t0.y,this._t0.z,0,0,0,0,1,this._cachedTextureMatrix));let e=this.getScene();return e?(this.optimizeUVAllocation&&e.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)),this._cachedTextureMatrix):this._cachedTextureMatrix}getReflectionTextureMatrix(){let t=this.getScene();if(!t)return this._cachedReflectionTextureMatrix;if(this.uOffset===this._cachedReflectionUOffset&&this.vOffset===this._cachedReflectionVOffset&&this.uScale===this._cachedReflectionUScale&&this.vScale===this._cachedReflectionVScale&&this.coordinatesMode===this._cachedReflectionCoordinatesMode)if(this.coordinatesMode===n.PROJECTION_MODE){if(this._cachedReflectionProjectionMatrixId===t.getProjectionMatrix().updateFlag)return this._cachedReflectionTextureMatrix}else return this._cachedReflectionTextureMatrix;this._cachedReflectionTextureMatrix||(this._cachedReflectionTextureMatrix=P.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=P.Zero());let e=this._cachedReflectionCoordinatesMode!==this.coordinatesMode;switch(this._cachedReflectionUOffset=this.uOffset,this._cachedReflectionVOffset=this.vOffset,this._cachedReflectionUScale=this.uScale,this._cachedReflectionVScale=this.vScale,this._cachedReflectionCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case n.PLANAR_MODE:{P.IdentityToRef(this._cachedReflectionTextureMatrix),this._cachedReflectionTextureMatrix[0]=this.uScale,this._cachedReflectionTextureMatrix[5]=this.vScale,this._cachedReflectionTextureMatrix[12]=this.uOffset,this._cachedReflectionTextureMatrix[13]=this.vOffset;break}case n.PROJECTION_MODE:{P.FromValuesToRef(.5,0,0,0,0,-.5,0,0,0,0,0,0,.5,.5,1,1,this._projectionModeMatrix);let i=t.getProjectionMatrix();this._cachedReflectionProjectionMatrixId=i.updateFlag,i.multiplyToRef(this._projectionModeMatrix,this._cachedReflectionTextureMatrix);break}default:P.IdentityToRef(this._cachedReflectionTextureMatrix);break}return e&&t.markAllMaterialsAsDirty(1,i=>i.getActiveTextures().indexOf(this)!==-1),this._cachedReflectionTextureMatrix}clone(){let t={noMipmap:this._noMipmap,invertY:this._invertY,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this._texture?this._texture._buffer:void 0,deleteBuffer:this._deleteBuffer,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this._loaderOptions,creationFlags:this._creationFlags,useSRGBBuffer:this._useSRGBBuffer};return ee.Clone(()=>new n(this._texture?this._texture.url:null,this.getScene(),t),this)}serialize(){var t,e;let i=this.name;n.SerializeBuffers||this.name.startsWith("data:")&&(this.name=""),this.name.startsWith("data:")&&this.url===this.name&&(this.url="");let s=super.serialize(n._SerializeInternalTextureUniqueId);return s?((n.SerializeBuffers||n.ForceSerializeBuffers)&&(typeof this._buffer=="string"&&this._buffer.substr(0,5)==="data:"?(s.base64String=this._buffer,s.name=s.name.replace("data:","")):this.url&&this.url.startsWith("data:")&&this._buffer instanceof Uint8Array?s.base64String="data:image/png;base64,"+bn(this._buffer):(n.ForceSerializeBuffers||this.url&&this.url.startsWith("blob:")||this._forceSerialize)&&(s.base64String=!this._engine||this._engine._features.supportSyncTextureRead?ma(this):va(this))),s.invertY=this._invertY,s.samplingMode=this.samplingMode,s._creationFlags=this._creationFlags,s._useSRGBBuffer=this._useSRGBBuffer,n._SerializeInternalTextureUniqueId&&(s.internalTextureUniqueId=(e=(t=this._texture)===null||t===void 0?void 0:t.uniqueId)!==null&&e!==void 0?e:void 0),this.name=i,s):null}getClassName(){return"Texture"}dispose(){super.dispose(),this.onLoadObservable.clear(),this._delayedOnLoad=null,this._delayedOnError=null,this._buffer=null}static Parse(t,e,i){if(t.customType){let o=$i.Instantiate(t.customType).Parse(t,e,i);return t.samplingMode&&o.updateSamplingMode&&o._samplingMode&&o._samplingMode!==t.samplingMode&&o.updateSamplingMode(t.samplingMode),o}if(t.isCube&&!t.isRenderTarget)return n._CubeTextureParser(t,e,i);let s=t.internalTextureUniqueId!==void 0;if(!t.name&&!t.isRenderTarget&&!s)return null;let r;if(s){let o=e.getEngine().getLoadedTexturesCache();for(let h of o)if(h.uniqueId===t.internalTextureUniqueId){r=h;break}}let a=o=>{var h;if(o&&o._texture&&(o._texture._cachedWrapU=null,o._texture._cachedWrapV=null,o._texture._cachedWrapR=null),t.samplingMode){let l=t.samplingMode;o&&o.samplingMode!==l&&o.updateSamplingMode(l)}if(o&&t.animations)for(let l=0;l<t.animations.length;l++){let c=t.animations[l],d=Zt("BABYLON.Animation");d&&o.animations.push(d.Parse(c))}s&&!r&&((h=o?._texture)===null||h===void 0||h._setUniqueId(t.internalTextureUniqueId))};return ee.Parse(()=>{var o,h,l;let c=!0;if(t.noMipmap&&(c=!1),t.mirrorPlane){let d=n._CreateMirror(t.name,t.renderTargetSize,e,c);return d._waitingRenderList=t.renderList,d.mirrorPlane=_i.FromArray(t.mirrorPlane),a(d),d}else if(t.isRenderTarget){let d=null;if(t.isCube){if(e.reflectionProbes)for(let u=0;u<e.reflectionProbes.length;u++){let f=e.reflectionProbes[u];if(f.name===t.name)return f.cubeTexture}}else d=n._CreateRenderTargetTexture(t.name,t.renderTargetSize,e,c,(o=t._creationFlags)!==null&&o!==void 0?o:0),d._waitingRenderList=t.renderList;return a(d),d}else{let d;if(t.base64String&&!r)d=n.CreateFromBase64String(t.base64String,t.base64String,e,!c,t.invertY,t.samplingMode,()=>{a(d)},(h=t._creationFlags)!==null&&h!==void 0?h:0,(l=t._useSRGBBuffer)!==null&&l!==void 0?l:!1),d.name=t.name;else{let u;t.name&&t.name.indexOf("://")>0?u=t.name:u=i+t.name,t.url&&(t.url.startsWith("data:")||n.UseSerializedUrlIfAny)&&(u=t.url);let f={noMipmap:!c,invertY:t.invertY,samplingMode:t.samplingMode,onLoad:()=>{a(d)},internalTexture:r};d=new n(u,e,f)}return d}},t,e)}static CreateFromBase64String(t,e,i,s,r,a=n.TRILINEAR_SAMPLINGMODE,o=null,h=null,l=5,c){return new n("data:"+e,i,s,r,a,o,h,t,!1,l,void 0,void 0,c)}static LoadFromDataString(t,e,i,s=!1,r,a=!0,o=n.TRILINEAR_SAMPLINGMODE,h=null,l=null,c=5,d){return t.substr(0,5)!=="data:"&&(t="data:"+t),new n(t,i,r,a,o,h,l,e,s,c,void 0,void 0,d)}};L.SerializeBuffers=!0;L.ForceSerializeBuffers=!1;L.OnTextureLoadErrorObservable=new D;L._SerializeInternalTextureUniqueId=!1;L._CubeTextureParser=(n,t,e)=>{throw H("CubeTexture")};L._CreateMirror=(n,t,e,i)=>{throw H("MirrorTexture")};L._CreateRenderTargetTexture=(n,t,e,i,s)=>{throw H("RenderTargetTexture")};L.NEAREST_SAMPLINGMODE=1;L.NEAREST_NEAREST_MIPLINEAR=8;L.BILINEAR_SAMPLINGMODE=2;L.LINEAR_LINEAR_MIPNEAREST=11;L.TRILINEAR_SAMPLINGMODE=3;L.LINEAR_LINEAR_MIPLINEAR=3;L.NEAREST_NEAREST_MIPNEAREST=4;L.NEAREST_LINEAR_MIPNEAREST=5;L.NEAREST_LINEAR_MIPLINEAR=6;L.NEAREST_LINEAR=7;L.NEAREST_NEAREST=1;L.LINEAR_NEAREST_MIPNEAREST=9;L.LINEAR_NEAREST_MIPLINEAR=10;L.LINEAR_LINEAR=2;L.LINEAR_NEAREST=12;L.EXPLICIT_MODE=0;L.SPHERICAL_MODE=1;L.PLANAR_MODE=2;L.CUBIC_MODE=3;L.PROJECTION_MODE=4;L.SKYBOX_MODE=5;L.INVCUBIC_MODE=6;L.EQUIRECTANGULAR_MODE=7;L.FIXED_EQUIRECTANGULAR_MODE=8;L.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;L.CLAMP_ADDRESSMODE=0;L.WRAP_ADDRESSMODE=1;L.MIRROR_ADDRESSMODE=2;L.UseSerializedUrlIfAny=!1;S([A()],L.prototype,"url",void 0);S([A()],L.prototype,"uOffset",void 0);S([A()],L.prototype,"vOffset",void 0);S([A()],L.prototype,"uScale",void 0);S([A()],L.prototype,"vScale",void 0);S([A()],L.prototype,"uAng",void 0);S([A()],L.prototype,"vAng",void 0);S([A()],L.prototype,"wAng",void 0);S([A()],L.prototype,"uRotationCenter",void 0);S([A()],L.prototype,"vRotationCenter",void 0);S([A()],L.prototype,"wRotationCenter",void 0);S([A()],L.prototype,"homogeneousRotationInUVTransform",void 0);S([A()],L.prototype,"isBlocking",null);Ye("BABYLON.Texture",L);ee._TextureParser=L.Parse;var yr=class{constructor(t,e,i,s){this._textures=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this._isMulti=t,this._isCube=e,this._size=i,this._engine=s,this._depthStencilTexture=null}get depthStencilTexture(){return this._depthStencilTexture}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get size(){return this.width}get width(){return this._size.width||this._size}get height(){return this._size.height||this._size}get layers(){return this._size.layers||0}get texture(){var t,e;return(e=(t=this._textures)===null||t===void 0?void 0:t[0])!==null&&e!==void 0?e:null}get textures(){return this._textures}get samples(){return this._samples}setSamples(t,e=!0,i=!1){if(this.samples===t&&!i)return t;let s=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,t,e):this._engine.updateRenderTargetTextureSampleCount(this,t);return this._samples=t,s}setTextures(t){Array.isArray(t)?this._textures=t:t?this._textures=[t]:this._textures=null}setTexture(t,e=0,i=!0){this._textures||(this._textures=[]),this._textures[e]&&i&&this._textures[e].dispose(),this._textures[e]=t}createDepthStencilTexture(t=0,e=!0,i=!1,s=1,r=14){var a;return(a=this._depthStencilTexture)===null||a===void 0||a.dispose(),this._depthStencilTextureWithStencil=i,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:e,comparisonFunction:t,generateStencil:i,isCube:this._isCube,samples:s,depthTextureFormat:r},this),this._depthStencilTexture}_shareDepth(t){this._depthStencilTexture&&(t._depthStencilTexture&&t._depthStencilTexture.dispose(),t._depthStencilTexture=this._depthStencilTexture,this._depthStencilTexture.incrementReferences())}_swapAndDie(t){this.texture&&this.texture._swapAndDie(t),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){var t,e,i,s,r,a;let o=null;if(this._isMulti){let h=this.textures;if(h&&h.length>0){let l=!1,c=h.length,d=h[h.length-1]._source;(d===xe.Depth||d===xe.DepthStencil)&&(l=!0,c--);let u=[],f=[];for(let p=0;p<c;++p){let E=h[p];u.push(E.samplingMode),f.push(E.type)}let _={samplingModes:u,generateMipMaps:h[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:l,types:f,textureCount:c},g={width:this.width,height:this.height};o=this._engine.createMultipleRenderTarget(g,_)}}else{let h={};if(h.generateDepthBuffer=this._generateDepthBuffer,h.generateMipMaps=(e=(t=this.texture)===null||t===void 0?void 0:t.generateMipMaps)!==null&&e!==void 0?e:!1,h.generateStencilBuffer=this._generateStencilBuffer,h.samplingMode=(i=this.texture)===null||i===void 0?void 0:i.samplingMode,h.type=(s=this.texture)===null||s===void 0?void 0:s.type,h.format=(r=this.texture)===null||r===void 0?void 0:r.format,this.isCube)o=this._engine.createRenderTargetCubeTexture(this.width,h);else{let l={width:this.width,height:this.height,layers:this.is2DArray?(a=this.texture)===null||a===void 0?void 0:a.depth:void 0};o=this._engine.createRenderTargetTexture(l,h)}o.texture.isReady=!0}return o}_swapRenderTargetWrapper(t){if(this._textures&&t._textures)for(let e=0;e<this._textures.length;++e)this._textures[e]._swapAndDie(t._textures[e],!1),t._textures[e].isReady=!0;this._depthStencilTexture&&t._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(t._depthStencilTexture),t._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){let t=this._cloneRenderTargetWrapper();if(t){if(this._depthStencilTexture){let e=this._depthStencilTexture.samplingMode,i=e===2||e===3||e===11;t.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,i,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples)}this.samples>1&&t.setSamples(this.samples),t._swapRenderTargetWrapper(this),t.dispose()}}releaseTextures(){var t,e;if(this._textures)for(let i=0;(e=i<((t=this._textures)===null||t===void 0?void 0:t.length))!==null&&e!==void 0&&e;++i)this._textures[i].dispose();this._textures=null}dispose(t=!1){var e;t||((e=this._depthStencilTexture)===null||e===void 0||e.dispose(),this._depthStencilTexture=null,this.releaseTextures()),this._engine._releaseRenderTargetWrapper(this)}},Cr=class extends yr{constructor(t,e,i,s,r){super(t,e,i,s),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._context=r}_cloneRenderTargetWrapper(){let t=null;return this._colorTextureArray&&this._depthStencilTextureArray?(t=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),t.texture.isReady=!0):t=super._cloneRenderTargetWrapper(),t}_swapRenderTargetWrapper(t){super._swapRenderTargetWrapper(t),t._framebuffer=this._framebuffer,t._depthStencilBuffer=this._depthStencilBuffer,t._MSAAFramebuffer=this._MSAAFramebuffer,t._colorTextureArray=this._colorTextureArray,t._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}_shareDepth(t){super._shareDepth(t);let e=this._context,i=this._depthStencilBuffer,s=t._MSAAFramebuffer||t._framebuffer;t._depthStencilBuffer&&e.deleteRenderbuffer(t._depthStencilBuffer),t._depthStencilBuffer=this._depthStencilBuffer,this._engine._bindUnboundFramebuffer(s),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,i),this._engine._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(t,e=0,i=-1,s=0){if(!t._hardwareTexture)return;let r=this._context,a=this._framebuffer,o=this._engine._currentFramebuffer;this._engine._bindUnboundFramebuffer(a);let h=r[this._engine.webGLVersion>1?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"],l=i!==-1?r.TEXTURE_CUBE_MAP_POSITIVE_X+i:r.TEXTURE_2D;r.framebufferTexture2D(r.FRAMEBUFFER,h,l,t._hardwareTexture.underlyingResource,s),this._engine._bindUnboundFramebuffer(o)}setTexture(t,e=0,i=!0){super.setTexture(t,e,i),this._bindTextureRenderTarget(t,e)}dispose(t=!1){let e=this._context;t||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(e.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(e.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(e.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(t)}};le.prototype._createHardwareRenderTargetWrapper=function(n,t,e){let i=new Cr(n,t,e,this,this._gl);return this._renderTargetWrapperCache.push(i),i};le.prototype.createRenderTargetTexture=function(n,t){var e,i;let s=this._createHardwareRenderTargetWrapper(!1,!1,n),r=!0,a=!1,o=!1,h,l=1;t!==void 0&&typeof t=="object"&&(r=(e=t.generateDepthBuffer)!==null&&e!==void 0?e:!0,a=!!t.generateStencilBuffer,o=!!t.noColorAttachment,h=t.colorAttachment,l=(i=t.samples)!==null&&i!==void 0?i:1);let c=h||(o?null:this._createInternalTexture(n,t,!0,xe.RenderTarget)),d=n.width||n,u=n.height||n,f=this._currentFramebuffer,_=this._gl,g=_.createFramebuffer();return this._bindUnboundFramebuffer(g),s._depthStencilBuffer=this._setupFramebufferDepthAttachments(a,r,d,u),c&&!c.is2DArray&&_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_2D,c._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(f),s._framebuffer=g,s._generateDepthBuffer=r,s._generateStencilBuffer=a,s.setTextures(c),this.updateRenderTargetTextureSampleCount(s,l),s};le.prototype.createDepthStencilTexture=function(n,t,e){if(t.isCube){let i=n.width||n;return this._createDepthStencilCubeTexture(i,t,e)}else return this._createDepthStencilTexture(n,t,e)};le.prototype._createDepthStencilTexture=function(n,t,e){let i=this._gl,s=n.layers||0,r=s!==0?i.TEXTURE_2D_ARRAY:i.TEXTURE_2D,a=new oi(this,xe.DepthStencil);if(!this._caps.depthTextureExtension)return O.Error("Depth texture is not supported by your browser or hardware."),a;let o=Xe({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},t);if(this._bindTextureDirectly(r,a,!0),this._setupDepthStencilTexture(a,n,o.generateStencil,o.comparisonFunction===0?!1:o.bilinearFiltering,o.comparisonFunction,o.samples),o.depthTextureFormat!==void 0){if(o.depthTextureFormat!==15&&o.depthTextureFormat!==16&&o.depthTextureFormat!==17&&o.depthTextureFormat!==13&&o.depthTextureFormat!==14&&o.depthTextureFormat!==18)return O.Error("Depth texture format is not supported."),a;a.format=o.depthTextureFormat}else a.format=o.generateStencil?13:16;let h=a.format===17||a.format===13||a.format===18;e._depthStencilTexture=a,e._depthStencilTextureWithStencil=h;let l=i.UNSIGNED_INT;a.format===15?l=i.UNSIGNED_SHORT:a.format===17||a.format===13?l=i.UNSIGNED_INT_24_8:a.format===14?l=i.FLOAT:a.format===18&&(l=i.FLOAT_32_UNSIGNED_INT_24_8_REV);let c=h?i.DEPTH_STENCIL:i.DEPTH_COMPONENT,d=c;this.webGLVersion>1&&(a.format===15?d=i.DEPTH_COMPONENT16:a.format===16?d=i.DEPTH_COMPONENT24:a.format===17||a.format===13?d=i.DEPTH24_STENCIL8:a.format===14?d=i.DEPTH_COMPONENT32F:a.format===18&&(d=i.DEPTH32F_STENCIL8)),a.is2DArray?i.texImage3D(r,0,d,a.width,a.height,s,0,c,l,null):i.texImage2D(r,0,d,a.width,a.height,0,c,l,null),this._bindTextureDirectly(r,null),this._internalTexturesCache.push(a);let u=e;if(u._depthStencilBuffer){let f=this._currentFramebuffer;this._bindUnboundFramebuffer(u._framebuffer),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,null),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,null),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.STENCIL_ATTACHMENT,i.RENDERBUFFER,null),this._bindUnboundFramebuffer(f),i.deleteRenderbuffer(u._depthStencilBuffer),u._depthStencilBuffer=null}return a};le.prototype.updateRenderTargetTextureSampleCount=function(n,t){if(this.webGLVersion<2||!n||!n.texture)return 1;if(n.samples===t)return t;let e=this._gl;t=Math.min(t,this.getCaps().maxMSAASamples),n._depthStencilBuffer&&(e.deleteRenderbuffer(n._depthStencilBuffer),n._depthStencilBuffer=null),n._MSAAFramebuffer&&(e.deleteFramebuffer(n._MSAAFramebuffer),n._MSAAFramebuffer=null);let i=n.texture._hardwareTexture;if(i._MSAARenderBuffer&&(e.deleteRenderbuffer(i._MSAARenderBuffer),i._MSAARenderBuffer=null),t>1&&e.renderbufferStorageMultisample){let s=e.createFramebuffer();if(!s)throw new Error("Unable to create multi sampled framebuffer");n._MSAAFramebuffer=s,this._bindUnboundFramebuffer(n._MSAAFramebuffer);let r=this._createRenderBuffer(n.texture.width,n.texture.height,t,-1,this._getRGBAMultiSampleBufferFormat(n.texture.type),e.COLOR_ATTACHMENT0,!1);if(!r)throw new Error("Unable to create multi sampled framebuffer");i._MSAARenderBuffer=r}else this._bindUnboundFramebuffer(n._framebuffer);return n.texture.samples=t,n._samples=t,n._depthStencilBuffer=this._setupFramebufferDepthAttachments(n._generateStencilBuffer,n._generateDepthBuffer,n.texture.width,n.texture.height,t),this._bindUnboundFramebuffer(null),t};le.prototype.createRenderTargetCubeTexture=function(n,t){let e=this._createHardwareRenderTargetWrapper(!1,!0,n),i=Xe({generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5},t);i.generateStencilBuffer=i.generateDepthBuffer&&i.generateStencilBuffer,(i.type===1&&!this._caps.textureFloatLinearFiltering||i.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(i.samplingMode=1);let s=this._gl,r=new oi(this,xe.RenderTarget);this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,r,!0);let a=this._getSamplingParameters(i.samplingMode,i.generateMipMaps);i.type===1&&!this._caps.textureFloat&&(i.type=0,O.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,a.mag),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,a.min),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);for(let h=0;h<6;h++)s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+h,0,this._getRGBABufferInternalSizedFormat(i.type,i.format),n,n,0,this._getInternalFormat(i.format),this._getWebGLTextureType(i.type),null);let o=s.createFramebuffer();return this._bindUnboundFramebuffer(o),e._depthStencilBuffer=this._setupFramebufferDepthAttachments(i.generateStencilBuffer,i.generateDepthBuffer,n,n),i.generateMipMaps&&s.generateMipmap(s.TEXTURE_CUBE_MAP),this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),e._framebuffer=o,e._generateDepthBuffer=i.generateDepthBuffer,e._generateStencilBuffer=i.generateStencilBuffer,r.width=n,r.height=n,r.isReady=!0,r.isCube=!0,r.samples=1,r.generateMipMaps=i.generateMipMaps,r.samplingMode=i.samplingMode,r.type=i.type,r.format=i.format,this._internalTexturesCache.push(r),e.setTextures(r),e};var Ea="postprocessVertexShader",Ta=`attribute vec2 position;
uniform vec2 scale;
varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=(position*madd+madd)*scale;
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;w.ShadersStore[Ea]=Ta;var Us={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]},Ir=class{constructor(t,e=Us){var i,s;this._fullscreenViewport=new _s(0,0,1,1);let r=(i=e.positions)!==null&&i!==void 0?i:Us.positions,a=(s=e.indices)!==null&&s!==void 0?s:Us.indices;this.engine=t,this._vertexBuffers={[m.PositionKind]:new m(t,r,m.PositionKind,!1,!1,2)},this._indexBuffer=t.createIndexBuffer(a),this._onContextRestoredObserver=t.onContextRestoredObservable.add(()=>{this._indexBuffer=t.createIndexBuffer(a);for(let o in this._vertexBuffers)this._vertexBuffers[o]._rebuild()})}setViewport(t=this._fullscreenViewport){this.engine.setViewport(t)}bindBuffers(t){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,t)}applyEffectWrapper(t){this.engine.setState(!0),this.engine.depthCullingState.depthTest=!1,this.engine.stencilState.stencilTest=!1,this.engine.enableEffect(t._drawWrapper),this.bindBuffers(t.effect),t.onApplyObservable.notifyObservers({})}restoreStates(){this.engine.depthCullingState.depthTest=!0,this.engine.stencilState.stencilTest=!0}draw(){this.engine.drawElementsType(0,0,6)}_isRenderTargetTexture(t){return t.renderTarget!==void 0}render(t,e=null){if(!t.effect.isReady())return;this.setViewport();let i=e===null?null:this._isRenderTargetTexture(e)?e.renderTarget:e;i&&this.engine.bindFramebuffer(i),this.applyEffectWrapper(t),this.draw(),i&&this.engine.unBindFramebuffer(i),this.restoreStates()}dispose(){let t=this._vertexBuffers[m.PositionKind];t&&(t.dispose(),delete this._vertexBuffers[m.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}},Pr=class{constructor(t){this.onApplyObservable=new D;let e,i=t.uniformNames||[];t.vertexShader?e={fragmentSource:t.fragmentShader,vertexSource:t.vertexShader,spectorName:t.name||"effectWrapper"}:(i.push("scale"),e={fragmentSource:t.fragmentShader,vertex:"postprocess",spectorName:t.name||"effectWrapper"},this.onApplyObservable.add(()=>{this.effect.setFloat2("scale",1,1)}));let s=t.defines?t.defines.join(`
`):"";this._drawWrapper=new Wt(t.engine),t.useShaderStore?(e.fragment=e.fragmentSource,e.vertex||(e.vertex=e.vertexSource),delete e.fragmentSource,delete e.vertexSource,this.effect=t.engine.createEffect(e,t.attributeNames||["position"],i,t.samplerNames,s,void 0,t.onCompiled,void 0,void 0,t.shaderLanguage)):(this.effect=new Re(e,t.attributeNames||["position"],i,t.samplerNames,t.engine,s,void 0,t.onCompiled,void 0,void 0,void 0,t.shaderLanguage),this._onContextRestoredObserver=t.engine.onContextRestoredObservable.add(()=>{this.effect._pipelineContext=null,this.effect._wasPreviouslyReady=!1,this.effect._prepareEffect()}))}get effect(){return this._drawWrapper.effect}set effect(t){this._drawWrapper.effect=t}dispose(){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.effect.dispose()}},On="passPixelShader",Ln=`varying vec2 vUV;
uniform sampler2D textureSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
gl_FragColor=texture2D(textureSampler,vUV);
}`;w.ShadersStore[On]=Ln;var _n={name:On,shader:Ln},hi=class n{static _CreateDumpRenderer(){if(!n._DumpToolsEngine){let t=document.createElement("canvas"),e=new le(t,!1,{preserveDrawingBuffer:!0,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,antialias:!1,failIfMajorPerformanceCaveat:!1});e.getCaps().parallelShaderCompile=void 0;let i=new Ir(e),s=new Pr({engine:e,name:_n.name,fragmentShader:_n.shader,samplerNames:["textureSampler"]});n._DumpToolsEngine={canvas:t,engine:e,renderer:i,wrapper:s}}return n._DumpToolsEngine}static DumpFramebuffer(t,e,i,s,r="image/png",a){return Ne(this,null,function*(){let o=yield i.readPixels(0,0,t,e),h=new Uint8Array(o.buffer);n.DumpData(t,e,h,s,r,a,!0)})}static DumpDataAsync(t,e,i,s="image/png",r,a=!1,o=!1,h){return new Promise(l=>{n.DumpData(t,e,i,c=>l(c),s,r,a,o,h)})}static DumpData(t,e,i,s,r="image/png",a,o=!1,h=!1,l){let c=n._CreateDumpRenderer();if(c.engine.setSize(t,e,!0),i instanceof Float32Array){let u=new Uint8Array(i.length),f=i.length;for(;f--;){let _=i[f];u[f]=_<0?0:_>1?1:Math.round(_*255)}i=u}let d=c.engine.createRawTexture(i,t,e,5,!1,!o,1);c.renderer.setViewport(),c.renderer.applyEffectWrapper(c.wrapper),c.wrapper.effect._bindTexture("textureSampler",d),c.renderer.draw(),h?Z.ToBlob(c.canvas,u=>{let f=new FileReader;f.onload=_=>{let g=_.target.result;s&&s(g)},f.readAsArrayBuffer(u)},r,l):Z.EncodeScreenshotCanvasData(c.canvas,s,r,a,l),d.dispose()}static Dispose(){n._DumpToolsEngine&&(n._DumpToolsEngine.wrapper.dispose(),n._DumpToolsEngine.renderer.dispose(),n._DumpToolsEngine.engine.dispose()),n._DumpToolsEngine=null}},Sa=()=>{Z.DumpData=hi.DumpData,Z.DumpDataAsync=hi.DumpDataAsync,Z.DumpFramebuffer=hi.DumpFramebuffer};Sa();var li=(()=>{class n extends L{constructor(e,i,s,r=!1,a=!0,o=0,h=!1,l=L.TRILINEAR_SAMPLINGMODE,c=!0,d=!1,u=!1,f=5,_=!1,g,p,E=!1,T=!1){var R,y,M,b,x,F;let I;if(typeof r=="object"){let G=r;r=!!G.generateMipMaps,a=(R=G.doNotChangeAspectRatio)!==null&&R!==void 0?R:!0,o=(y=G.type)!==null&&y!==void 0?y:0,h=!!G.isCube,l=(M=G.samplingMode)!==null&&M!==void 0?M:L.TRILINEAR_SAMPLINGMODE,c=(b=G.generateDepthBuffer)!==null&&b!==void 0?b:!0,d=!!G.generateStencilBuffer,u=!!G.isMulti,f=(x=G.format)!==null&&x!==void 0?x:5,_=!!G.delayAllocation,g=G.samples,p=G.creationFlags,E=!!G.noColorAttachment,T=!!G.useSRGBBuffer,I=G.colorAttachment}if(super(null,s,!r,void 0,l,void 0,void 0,void 0,void 0,f),this._unObserveRenderList=null,this._renderListHasChanged=(G,Y)=>{var q;let j=this._renderList?this._renderList.length:0;(Y===0&&j>0||j===0)&&((q=this.getScene())===null||q===void 0||q.meshes.forEach($=>{$._markSubMeshesAsLightDirty()}))},this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new D,this.onAfterUnbindObservable=new D,this.onBeforeRenderObservable=new D,this.onAfterRenderObservable=new D,this.onClearObservable=new D,this.onResizeObservable=new D,this._cleared=!1,this.skipInitialClear=!1,this._currentRefreshId=-1,this._refreshRate=1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this.boundingBoxPosition=v.Zero(),s=this.getScene(),!s)return;let N=this.getScene().getEngine();this._coordinatesMode=L.PROJECTION_MODE,this.renderList=new Array,this.name=e,this.isRenderTarget=!0,this._initialSizeParameter=i,this._renderPassIds=[],this._isCubeData=h,this._processSizeParameter(i),this.renderPassId=this._renderPassIds[0],this._resizeObserver=N.onResizeObservable.add(()=>{}),this._generateMipMaps=!!r,this._doNotChangeAspectRatio=a,this._renderingManager=new hs(s),this._renderingManager._useSceneAutoClearSetup=!0,!u&&(this._renderTargetOptions={generateMipMaps:r,type:o,format:(F=this._format)!==null&&F!==void 0?F:void 0,samplingMode:this.samplingMode,generateDepthBuffer:c,generateStencilBuffer:d,samples:g,creationFlags:p,noColorAttachment:E,useSRGBBuffer:T,colorAttachment:I},this.samplingMode===L.NEAREST_SAMPLINGMODE&&(this.wrapU=L.CLAMP_ADDRESSMODE,this.wrapV=L.CLAMP_ADDRESSMODE),_||(h?(this._renderTarget=s.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=L.INVCUBIC_MODE,this._textureMatrix=P.Identity()):this._renderTarget=s.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,g!==void 0&&(this.samples=g)))}get renderList(){return this._renderList}set renderList(e){this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),e&&(this._unObserveRenderList=vn(e,this._renderListHasChanged)),this._renderList=e}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(e){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}set onClear(e){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(e)}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(e,i){let s;Array.isArray(e)?s=e:s=[e];for(let r=0;r<s.length;++r)for(let a=0;a<this._renderPassIds.length;++a)s[r].setMaterialForRenderPass(this._renderPassIds[a],i!==void 0?Array.isArray(i)?i[a]:i:void 0)}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;let i=this.getScene();i&&i.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){var e,i;return(i=(e=this._renderTarget)===null||e===void 0?void 0:e._depthStencilTexture)!==null&&i!==void 0?i:null}createDepthStencilTexture(e=0,i=!0,s=!1,r=1,a=14){var o;(o=this._renderTarget)===null||o===void 0||o.createDepthStencilTexture(e,i,s,r,a)}_releaseRenderPassId(){if(this._scene){let e=this._scene.getEngine();for(let i=0;i<this._renderPassIds.length;++i)e.releaseRenderPassId(this._renderPassIds[i])}this._renderPassIds=[]}_createRenderPassId(){this._releaseRenderPassId();let e=this._scene.getEngine(),i=this._isCubeData?6:this.getRenderLayers()||1;for(let s=0;s<i;++s)this._renderPassIds[s]=e.createRenderPassId(`RenderTargetTexture - ${this.name}#${s}`)}_processSizeParameter(e){if(e.ratio){this._sizeRatio=e.ratio;let i=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(i.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(i.getRenderHeight(),this._sizeRatio)}}else this._size=e;this._createRenderPassId()}get samples(){var e,i;return(i=(e=this._renderTarget)===null||e===void 0?void 0:e.samples)!==null&&i!==void 0?i:this._samples}set samples(e){this._renderTarget&&(this._samples=this._renderTarget.setSamples(e))}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}addPostProcess(e){if(!this._postProcessManager){let i=this.getScene();if(!i)return;this._postProcessManager=new ui(i),this._postProcesses=new Array}this._postProcesses.push(e),this._postProcesses[0].autoClear=!1}clearPostProcesses(e=!1){if(this._postProcesses){if(e)for(let i of this._postProcesses)i.dispose();this._postProcesses=[]}}removePostProcess(e){if(!this._postProcesses)return;let i=this._postProcesses.indexOf(e);i!==-1&&(this._postProcesses.splice(i,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}_shouldRender(){return this._currentRefreshId===-1?(this._currentRefreshId=1,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){return this._size.layers||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(e){let i=Math.max(1,this.getRenderSize()*e);this.resize(i)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(e){var i;let s=this.isCube;(i=this._renderTarget)===null||i===void 0||i.dispose(),this._renderTarget=null;let r=this.getScene();r&&(this._processSizeParameter(e),s?this._renderTarget=r.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):this._renderTarget=r.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,this._renderTargetOptions.samples!==void 0&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(e=!1,i=!1){this._render(e,i)}isReadyForRendering(){return this._render(!1,!1,!0)}_render(e=!1,i=!1,s=!1){var r;let a=this.getScene();if(!a)return s;let o=a.getEngine();if(this.useCameraPostProcesses!==void 0&&(e=this.useCameraPostProcesses),this._waitingRenderList){this.renderList=[];for(let u=0;u<this._waitingRenderList.length;u++){let f=this._waitingRenderList[u],_=a.getMeshById(f);_&&this.renderList.push(_)}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];let u=this.getScene();if(!u)return s;let f=u.meshes;for(let _=0;_<f.length;_++){let g=f[_];this.renderListPredicate(g)&&this.renderList.push(g)}}let h=o.currentRenderPassId;this.onBeforeBindObservable.notifyObservers(this);let l=(r=this.activeCamera)!==null&&r!==void 0?r:a.activeCamera,c=a.activeCamera;l&&(l!==a.activeCamera&&(a.setTransformMatrix(l.getViewMatrix(),l.getProjectionMatrix(!0)),a.activeCamera=l),o.setViewport(l.viewport,this.getRenderWidth(),this.getRenderHeight())),this._defaultRenderListPrepared=!1;let d=s;if(s){a.getViewMatrix()||a.updateTransformMatrix();let u=this.is2DArray?this.getRenderLayers():this.isCube?6:1;for(let f=0;f<u&&d;f++){let _=null,g=this.renderList?this.renderList:a.getActiveMeshes().data,p=this.renderList?this.renderList.length:a.getActiveMeshes().length;o.currentRenderPassId=this._renderPassIds[f],this.onBeforeRenderObservable.notifyObservers(f),this.getCustomRenderList&&(_=this.getCustomRenderList(f,g,p)),_||(_=g),this._doNotChangeAspectRatio||a.updateTransformMatrix(!0);for(let E=0;E<_.length&&d;++E){let T=_[E];if(!(!T.isEnabled()||T.isBlocked||!T.isVisible||!T.subMeshes)){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(T,this.refreshRate,s)){d=!1;continue}}else if(!T.isReady(!0)){d=!1;continue}}}this.onAfterRenderObservable.notifyObservers(f),(this.is2DArray||this.isCube)&&(a.incrementRenderId(),a.resetCachedMaterial())}}else if(this.is2DArray)for(let u=0;u<this.getRenderLayers();u++)this._renderToTarget(0,e,i,u,l),a.incrementRenderId(),a.resetCachedMaterial();else if(this.isCube)for(let u=0;u<6;u++)this._renderToTarget(u,e,i,void 0,l),a.incrementRenderId(),a.resetCachedMaterial();else this._renderToTarget(0,e,i,void 0,l);return this.onAfterUnbindObservable.notifyObservers(this),o.currentRenderPassId=h,c&&(a.activeCamera=c,(a.getEngine().scenes.length>1||this.activeCamera&&this.activeCamera!==a.activeCamera)&&a.setTransformMatrix(a.activeCamera.getViewMatrix(),a.activeCamera.getProjectionMatrix(!0)),o.setViewport(a.activeCamera.viewport)),a.resetCachedMaterial(),d}_bestReflectionRenderTargetDimension(e,i){let s=e*i,r=de.NearestPOT(s+128*128/(128+s));return Math.min(de.FloorPOT(e),r)}_prepareRenderingManager(e,i,s,r){let a=this.getScene();if(!a)return;this._renderingManager.reset();let o=a.getRenderId();for(let h=0;h<i;h++){let l=e[h];if(l&&!l.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(l,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!l.isReady(this.refreshRate===0)){this.resetRefreshCounter();continue}if(!l._internalAbstractMeshDataInfo._currentLODIsUpToDate&&a.activeCamera&&(l._internalAbstractMeshDataInfo._currentLOD=a.customLODSelector?a.customLODSelector(l,this.activeCamera||a.activeCamera):l.getLOD(this.activeCamera||a.activeCamera),l._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0),!l._internalAbstractMeshDataInfo._currentLOD)continue;let c=l._internalAbstractMeshDataInfo._currentLOD;c._preActivateForIntermediateRendering(o);let d;if(r&&s?d=(l.layerMask&s.layerMask)===0:d=!1,l.isEnabled()&&l.isVisible&&l.subMeshes&&!d&&(c!==l&&c._activate(o,!0),l._activate(o,!0)&&l.subMeshes.length)){l.isAnInstance?l._internalAbstractMeshDataInfo._actAsRegularMesh&&(c=l):c._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,c._internalAbstractMeshDataInfo._isActiveIntermediate=!0;for(let u=0;u<c.subMeshes.length;u++){let f=c.subMeshes[u];this._renderingManager.dispatch(f,c)}}}}for(let h=0;h<a.particleSystems.length;h++){let l=a.particleSystems[h],c=l.emitter;!l.isStarted()||!c||!c.position||!c.isEnabled()||e.indexOf(c)>=0&&this._renderingManager.dispatchParticles(l)}}_bindFrameBuffer(e=0,i=0){let s=this.getScene();if(!s)return;let r=s.getEngine();this._renderTarget&&r.bindFramebuffer(this._renderTarget,this.isCube?e:void 0,void 0,void 0,this.ignoreCameraViewport,0,i)}_unbindFrameBuffer(e,i){this._renderTarget&&e.unBindFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(i)})}_prepareFrame(e,i,s,r){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):(!r||!e.postProcessManager._prepareFrame(this._texture))&&this._bindFrameBuffer(i,s)}_renderToTarget(e,i,s,r=0,a=null){var o,h,l,c,d,u;let f=this.getScene();if(!f)return;let _=f.getEngine();if((o=_._debugPushGroup)===null||o===void 0||o.call(_,`render to face #${e} layer #${r}`,1),this._prepareFrame(f,e,r,i),this.is2DArray?(_.currentRenderPassId=this._renderPassIds[r],this.onBeforeRenderObservable.notifyObservers(r)):(_.currentRenderPassId=this._renderPassIds[e],this.onBeforeRenderObservable.notifyObservers(e)),_.snapshotRendering&&_.snapshotRenderingMode===1)this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(_):this.skipInitialClear||_.clear(this.clearColor||f.clearColor,!0,!0,!0);else{let g=null,p=this.renderList?this.renderList:f.getActiveMeshes().data,E=this.renderList?this.renderList.length:f.getActiveMeshes().length;this.getCustomRenderList&&(g=this.getCustomRenderList(this.is2DArray?r:e,p,E)),g?this._prepareRenderingManager(g,g.length,a,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(p,E,a,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),g=p);for(let R of f._beforeRenderTargetClearStage)R.action(this,e,r);this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(_):this.skipInitialClear||_.clear(this.clearColor||f.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||f.updateTransformMatrix(!0);for(let R of f._beforeRenderTargetDrawStage)R.action(this,e,r);this._renderingManager.render(this.customRenderFunction,g,this.renderParticles,this.renderSprites);for(let R of f._afterRenderTargetDrawStage)R.action(this,e,r);let T=(l=(h=this._texture)===null||h===void 0?void 0:h.generateMipMaps)!==null&&l!==void 0?l:!1;this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,(c=this._renderTarget)!==null&&c!==void 0?c:void 0,e,this._postProcesses,this.ignoreCameraViewport):i&&f.postProcessManager._finalizeFrame(!1,(d=this._renderTarget)!==null&&d!==void 0?d:void 0,e);for(let R of f._afterRenderTargetPostProcessStage)R.action(this,e,r);this._texture&&(this._texture.generateMipMaps=T),this._doNotChangeAspectRatio||f.updateTransformMatrix(!0),s&&hi.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),_)}this._unbindFrameBuffer(_,e),this._texture&&this.isCube&&e===5&&_.generateMipMapsForCubemap(this._texture),(u=_._debugPopGroup)===null||u===void 0||u.call(_,1)}setRenderingOrder(e,i=null,s=null,r=null){this._renderingManager.setRenderingOrder(e,i,s,r)}setRenderingAutoClearDepthStencil(e,i){this._renderingManager.setRenderingAutoClearDepthStencil(e,i),this._renderingManager._useSceneAutoClearSetup=!1}clone(){let e=this.getSize(),i=new n(this.name,e,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.coordinatesMode=this.coordinatesMode,this.renderList&&(i.renderList=this.renderList.slice(0)),i}serialize(){if(!this.name)return null;let e=super.serialize();if(e.renderTargetSize=this.getRenderSize(),e.renderList=[],this.renderList)for(let i=0;i<this.renderList.length;i++)e.renderList.push(this.renderList[i].id);return e}disposeFramebufferObjects(){var e;(e=this._renderTarget)===null||e===void 0||e.dispose(!0)}releaseInternalTexture(){var e;(e=this._renderTarget)===null||e===void 0||e.releaseTextures(),this._texture=null}dispose(){var e;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterRenderObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this.onBeforeRenderObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._releaseRenderPassId(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.renderList=null;let i=this.getScene();if(!i)return;let s=i.customRenderTargets.indexOf(this);s>=0&&i.customRenderTargets.splice(s,1);for(let r of i.cameras)s=r.customRenderTargets.indexOf(this),s>=0&&r.customRenderTargets.splice(s,1);(e=this._renderTarget)===null||e===void 0||e.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this.refreshRate===n.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=n.REFRESHRATE_RENDER_ONCE),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}getViewCount(){return 1}}return n.REFRESHRATE_RENDER_ONCE=0,n.REFRESHRATE_RENDER_ONEVERYFRAME=1,n.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,n})();L._CreateRenderTargetTexture=(n,t,e,i,s)=>new li(n,t,e,i);var Ce=(()=>{class n{constructor(e,i,s,r,a,o,h=1,l,c,d=null,u=0,f="postprocess",_,g=!1,p=5,E=Fe.GLSL){this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.alphaMode=0,this.animations=new Array,this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new Ze(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new ve(1,1),this._texelSize=ve.Zero(),this.onActivateObservable=new D,this.onSizeChangedObservable=new D,this.onApplyObservable=new D,this.onBeforeRenderObservable=new D,this.onAfterRenderObservable=new D,this.name=e,o!=null?(this._camera=o,this._scene=o.getScene(),o.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):l&&(this._engine=l,this._engine.postProcesses.push(this)),this._options=a,this.renderTargetSamplingMode=h||1,this._reusable=c||!1,this._textureType=u,this._textureFormat=p,this._shaderLanguage=E,this._samplers=r||[],this._samplers.push("textureSampler"),this._fragmentUrl=i,this._vertexUrl=f,this._parameters=s||[],this._parameters.push("scale"),this._indexParameters=_,this._drawWrapper=new Wt(this._engine),g||this.updateEffect(d)}static RegisterShaderCodeProcessing(e,i){if(!i){delete n._CustomShaderCodeProcessing[e??""];return}n._CustomShaderCodeProcessing[e??""]=i}static _GetShaderCodeProcessing(e){var i;return(i=n._CustomShaderCodeProcessing[e])!==null&&i!==void 0?i:n._CustomShaderCodeProcessing[""]}get samples(){return this._samples}set samples(e){this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach(i=>{i.setSamples(this._samples)})}getEffectName(){return this._fragmentUrl}set onActivate(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))}set onSizeChanged(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)}set onApply(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(e){this._forcedOutputTexture=e}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._drawWrapper.effect}shareOutputWith(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this}useOwnOutput(){this._textures.length==0&&(this._textures=new Ze(2)),this._shareOutputWithPostProcess=null}updateEffect(e=null,i=null,s=null,r,a,o,h,l){var c,d;let u=n._GetShaderCodeProcessing(this.name);if(u!=null&&u.defineCustomBindings){let f=(c=i?.slice())!==null&&c!==void 0?c:[];f.push(...this._parameters);let _=(d=s?.slice())!==null&&d!==void 0?d:[];_.push(...this._samplers),e=u.defineCustomBindings(this.name,e,f,_),i=f,s=_}this._postProcessDefines=e,this._drawWrapper.effect=this._engine.createEffect({vertex:h??this._vertexUrl,fragment:l??this._fragmentUrl},{attributes:["position"],uniformsNames:i||this._parameters,uniformBuffersNames:[],samplers:s||this._samplers,defines:e!==null?e:"",fallbacks:null,onCompiled:a??null,onError:o??null,indexParameters:r||this._indexParameters,processCodeAfterIncludes:u!=null&&u.processCodeAfterIncludes?(f,_)=>u.processCodeAfterIncludes(this.name,f,_):null,processFinalCode:u!=null&&u.processFinalCode?(f,_)=>u.processFinalCode(this.name,f,_):null,shaderLanguage:this._shaderLanguage},this._engine)}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(e,i,s=0){for(let a=0;a<this._textureCache.length;a++)if(this._textureCache[a].texture.width===e.width&&this._textureCache[a].texture.height===e.height&&this._textureCache[a].postProcessChannel===s&&this._textureCache[a].texture._generateDepthBuffer===i.generateDepthBuffer&&this._textureCache[a].texture.samples===i.samples)return this._textureCache[a].texture;let r=this._engine.createRenderTargetTexture(e,i);return this._textureCache.push({texture:r,postProcessChannel:s,lastUsedRenderId:-1}),r}_flushTextureCache(){let e=this._renderId;for(let i=this._textureCache.length-1;i>=0;i--)if(e-this._textureCache[i].lastUsedRenderId>100){let s=!1;for(let r=0;r<this._textures.length;r++)if(this._textures.data[r]===this._textureCache[i].texture){s=!0;break}s||(this._textureCache[i].texture.dispose(),this._textureCache.splice(i,1))}}_resize(e,i,s,r,a){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=i;let o=null;for(let c=0;c<s._postProcesses.length;c++)if(s._postProcesses[c]!==null){o=s._postProcesses[c];break}let h={width:this.width,height:this.height},l={generateMipMaps:r,generateDepthBuffer:a||o===this,generateStencilBuffer:(a||o===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples};this._textures.push(this._createRenderTargetTexture(h,l,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(h,l,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}activate(e,i=null,s){var r,a;e=e||this._camera;let o=e.getScene(),h=o.getEngine(),l=h.getCaps().maxTextureSize,c=(i?i.width:this._engine.getRenderWidth(!0))*this._options|0,d=(i?i.height:this._engine.getRenderHeight(!0))*this._options|0,u=e.parent;u&&(u.leftCamera==e||u.rightCamera==e)&&(c/=2);let f=this._options.width||c,_=this._options.height||d,g=this.renderTargetSamplingMode!==7&&this.renderTargetSamplingMode!==1&&this.renderTargetSamplingMode!==2;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){let E=h.currentViewport;E&&(f*=E.width,_*=E.height)}(g||this.alwaysForcePOT)&&(this._options.width||(f=h.needPOTTextures?de.GetExponentOfTwo(f,l,this.scaleMode):f),this._options.height||(_=h.needPOTTextures?de.GetExponentOfTwo(_,l,this.scaleMode):_)),(this.width!==f||this.height!==_)&&this._resize(f,_,e,g,s),this._textures.forEach(E=>{E.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(E,this.samples)}),this._flushTextureCache(),this._renderId++}let p;if(this._shareOutputWithPostProcess)p=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)p=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{p=this.inputTexture;let E;for(let T=0;T<this._textureCache.length;T++)if(this._textureCache[T].texture===p){E=this._textureCache[T];break}E&&(E.lastUsedRenderId=this._renderId)}return this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(c/f,d/_),this._engine.bindFramebuffer(p,0,c,d,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(p,0,void 0,void 0,this.forceFullscreenViewport)),(a=(r=this._engine)._debugInsertMarker)===null||a===void 0||a.call(r,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(e),this.autoClear&&this.alphaMode===0&&this._engine.clear(this.clearColor?this.clearColor:o.clearColor,o._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),p}get isSupported(){return this._drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){var e,i;return(i=(e=this._drawWrapper.effect)===null||e===void 0?void 0:e.isReady())!==null&&i!==void 0?i:!1}apply(){var e,i,s;if(!(!((e=this._drawWrapper.effect)===null||e===void 0)&&e.isReady()))return null;this._engine.enableEffect(this._drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._engine.setAlphaMode(this.alphaMode),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a);let r;return this._shareOutputWithPostProcess?r=this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?r=this._forcedOutputTexture:r=this.inputTexture,this.externalTextureSamplerBinding||this._drawWrapper.effect._bindTexture("textureSampler",r?.texture),this._drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._drawWrapper.effect),(s=(i=n._GetShaderCodeProcessing(this.name))===null||i===void 0?void 0:i.bindCustomBindings)===null||s===void 0||s.call(i,this.name,this._drawWrapper.effect),this._drawWrapper.effect}_disposeTextures(){if(this._shareOutputWithPostProcess||this._forcedOutputTexture){this._disposeTextureCache();return}this._disposeTextureCache(),this._textures.dispose()}_disposeTextureCache(){for(let e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0}setPrePassRenderer(e){return this._prePassEffectConfiguration?(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0):!1}dispose(e){e=e||this._camera,this._disposeTextures();let i;if(this._scene&&(i=this._scene.postProcesses.indexOf(this),i!==-1&&this._scene.postProcesses.splice(i,1)),this._parentContainer){let s=this._parentContainer.postProcesses.indexOf(this);s>-1&&this._parentContainer.postProcesses.splice(s,1),this._parentContainer=null}if(i=this._engine.postProcesses.indexOf(this),i!==-1&&this._engine.postProcesses.splice(i,1),!!e){if(e.detachPostProcess(this),i=e._postProcesses.indexOf(this),i===0&&e._postProcesses.length>0){let s=this._camera._getFirstPostProcess();s&&s.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear()}}serialize(){let e=ee.Serialize(this),i=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=i?i.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e}clone(){let e=this.serialize();e._engine=this._engine,e.cameraId=null;let i=n.Parse(e,this._scene,"");return i?(i.onActivateObservable=this.onActivateObservable.clone(),i.onSizeChangedObservable=this.onSizeChangedObservable.clone(),i.onApplyObservable=this.onApplyObservable.clone(),i.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),i.onAfterRenderObservable=this.onAfterRenderObservable.clone(),i._prePassEffectConfiguration=this._prePassEffectConfiguration,i):null}static Parse(e,i,s){let r=Zt(e.customType);if(!r||!r._Parse)return null;let a=i?i.getCameraById(e.cameraId):null;return r._Parse(e,a,i,s)}static _Parse(e,i,s,r){return ee.Parse(()=>new n(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,i,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,!1,e.textureFormat),e,s,r)}}return n._CustomShaderCodeProcessing={},n})();S([A()],Ce.prototype,"uniqueId",void 0);S([A()],Ce.prototype,"name",void 0);S([A()],Ce.prototype,"width",void 0);S([A()],Ce.prototype,"height",void 0);S([A()],Ce.prototype,"renderTargetSamplingMode",void 0);S([Pn()],Ce.prototype,"clearColor",void 0);S([A()],Ce.prototype,"autoClear",void 0);S([A()],Ce.prototype,"alphaMode",void 0);S([A()],Ce.prototype,"alphaConstants",void 0);S([A()],Ce.prototype,"enablePixelPerfectMode",void 0);S([A()],Ce.prototype,"forceFullscreenViewport",void 0);S([A()],Ce.prototype,"scaleMode",void 0);S([A()],Ce.prototype,"alwaysForcePOT",void 0);S([A("samples")],Ce.prototype,"_samples",void 0);S([A()],Ce.prototype,"adaptScaleToCurrentViewport",void 0);Ye("BABYLON.PostProcess",Ce);var ba="kernelBlurVaryingDeclaration",xa="varying vec2 sampleCoord{X};";w.IncludesShadersStore[ba]=xa;var Ma="packingFunctions",Aa=`vec4 pack(float depth)
{
const vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);
const vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);
vec4 res=fract(depth*bit_shift);
res-=res.xxyz*bit_mask;
return res;
}
float unpack(vec4 color)
{
const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);
return dot(color,bit_shift);
}`;w.IncludesShadersStore[Ma]=Aa;var Ra="kernelBlurFragment",ya=`#ifdef DOF
factor=sampleCoC(sampleCoord{X}); 
computedWeight=KERNEL_WEIGHT{X}*factor;
sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;
#endif
`;w.IncludesShadersStore[Ra]=ya;var Ca="kernelBlurFragment2",Ia=`#ifdef DOF
factor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});
computedWeight=KERNEL_DEP_WEIGHT{X}*factor;
sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_DEP_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;
#endif
`;w.IncludesShadersStore[Ca]=Ia;var Pa="kernelBlurPixelShader",Da=`uniform sampler2D textureSampler;
uniform vec2 delta;
varying vec2 sampleCenter;
#ifdef DOF
uniform sampler2D circleOfConfusionSampler;
float sampleCoC(in vec2 offset) {
float coc=texture2D(circleOfConfusionSampler,offset).r;
return coc; 
}
#endif
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
#ifdef PACKEDFLOAT
#include<packingFunctions>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
float computedWeight=0.0;
#ifdef PACKEDFLOAT
float blend=0.;
#else
vec4 blend=vec4(0.);
#endif
#ifdef DOF
float sumOfWeights=CENTER_WEIGHT; 
float factor=0.0;
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;
#else
blend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;
#endif
#endif
#include<kernelBlurFragment>[0..varyingCount]
#include<kernelBlurFragment2>[0..depCount]
#ifdef PACKEDFLOAT
gl_FragColor=pack(blend);
#else
gl_FragColor=blend;
#endif
#ifdef DOF
gl_FragColor/=sumOfWeights;
#endif
}`;w.ShadersStore[Pa]=Da;var Fa="kernelBlurVertex",wa="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};";w.IncludesShadersStore[Fa]=wa;var Oa="kernelBlurVertexShader",La=`attribute vec2 position;
uniform vec2 delta;
varying vec2 sampleCenter;
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
sampleCenter=(position*madd+madd);
#include<kernelBlurVertex>[0..varyingCount]
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;w.ShadersStore[Oa]=La;var Kt=class n extends Ce{constructor(t,e,i,s,r,a=L.BILINEAR_SAMPLINGMODE,o,h,l=0,c="",d=!1,u=5){super(t,"kernelBlur",["delta","direction"],["circleOfConfusionSampler"],s,r,a,o,h,null,l,"kernelBlur",{varyingCount:0,depCount:0},!0,u),this._blockCompilation=d,this._packedFloat=!1,this._staticDefines="",this._staticDefines=c,this.direction=e,this.onApplyObservable.add(f=>{this._outputTexture?f.setFloat2("delta",1/this._outputTexture.width*this.direction.x,1/this._outputTexture.height*this.direction.y):f.setFloat2("delta",1/this.width*this.direction.x,1/this.height*this.direction.y)}),this.kernel=i}set kernel(t){this._idealKernel!==t&&(t=Math.max(t,1),this._idealKernel=t,this._kernel=this._nearestBestKernel(t),this._blockCompilation||this._updateParameters())}get kernel(){return this._idealKernel}set packedFloat(t){this._packedFloat!==t&&(this._packedFloat=t,this._blockCompilation||this._updateParameters())}get packedFloat(){return this._packedFloat}getClassName(){return"BlurPostProcess"}updateEffect(t=null,e=null,i=null,s,r,a){this._updateParameters(r,a)}_updateParameters(t,e){let i=this._kernel,s=(i-1)/2,r=[],a=[],o=0;for(let p=0;p<i;p++){let E=p/(i-1),T=this._gaussianWeight(E*2-1);r[p]=p-s,a[p]=T,o+=T}for(let p=0;p<a.length;p++)a[p]/=o;let h=[],l=[],c=[];for(let p=0;p<=s;p+=2){let E=Math.min(p+1,Math.floor(s));if(p===E)c.push({o:r[p],w:a[p]});else{let T=E===s,R=a[p]+a[E]*(T?.5:1),y=r[p]+1/(1+a[p]/a[E]);y===0?(c.push({o:r[p],w:a[p]}),c.push({o:r[p+1],w:a[p+1]})):(c.push({o:y,w:R}),c.push({o:-y,w:R}))}}for(let p=0;p<c.length;p++)l[p]=c[p].o,h[p]=c[p].w;r=l,a=h;let d=this.getEngine().getCaps().maxVaryingVectors,u=Math.max(d,0)-1,f=Math.min(r.length,u),_="";_+=this._staticDefines,this._staticDefines.indexOf("DOF")!=-1&&(_+=`#define CENTER_WEIGHT ${this._glslFloat(a[f-1])}\r
`,f--);for(let p=0;p<f;p++)_+=`#define KERNEL_OFFSET${p} ${this._glslFloat(r[p])}\r
`,_+=`#define KERNEL_WEIGHT${p} ${this._glslFloat(a[p])}\r
`;let g=0;for(let p=u;p<r.length;p++)_+=`#define KERNEL_DEP_OFFSET${g} ${this._glslFloat(r[p])}\r
`,_+=`#define KERNEL_DEP_WEIGHT${g} ${this._glslFloat(a[p])}\r
`,g++;this.packedFloat&&(_+="#define PACKEDFLOAT 1"),this._blockCompilation=!1,super.updateEffect(_,null,null,{varyingCount:f,depCount:g},t,e)}_nearestBestKernel(t){let e=Math.round(t);for(let i of[e,e-1,e+1,e-2,e+2])if(i%2!==0&&Math.floor(i/2)%2===0&&i>0)return Math.max(i,3);return Math.max(e,3)}_gaussianWeight(t){let e=.3333333333333333,i=Math.sqrt(2*Math.PI)*e,s=-(t*t/(2*e*e));return 1/i*Math.exp(s)}_glslFloat(t,e=8){return t.toFixed(e).replace(/0+$/,"")}static _Parse(t,e,i,s){return ee.Parse(()=>new n(t.name,t.direction,t.kernel,t.options,e,t.renderTargetSamplingMode,i.getEngine(),t.reusable,t.textureType,void 0,!1),t,i,s)}};S([A("kernel")],Kt.prototype,"_kernel",void 0);S([A("packedFloat")],Kt.prototype,"_packedFloat",void 0);S([na()],Kt.prototype,"direction",void 0);Ye("BABYLON.BlurPostProcess",Kt);var Gi=class{constructor(){this._defines={},this._currentRank=32,this._maxRank=-1,this._mesh=null}unBindMesh(){this._mesh=null}addFallback(t,e){this._defines[t]||(t<this._currentRank&&(this._currentRank=t),t>this._maxRank&&(this._maxRank=t),this._defines[t]=new Array),this._defines[t].push(e)}addCPUSkinningFallback(t,e){this._mesh=e,t<this._currentRank&&(this._currentRank=t),t>this._maxRank&&(this._maxRank=t)}get hasMoreFallbacks(){return this._currentRank<=this._maxRank}reduce(t,e){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0){this._mesh.computeBonesUsingShaders=!1,t=t.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),e._bonesComputationForcedToCPU=!0;let i=this._mesh.getScene();for(let s=0;s<i.meshes.length;s++){let r=i.meshes[s];if(!r.material){!this._mesh.material&&r.computeBonesUsingShaders&&r.numBoneInfluencers>0&&(r.computeBonesUsingShaders=!1);continue}if(!(!r.computeBonesUsingShaders||r.numBoneInfluencers===0)){if(r.material.getEffect()===e)r.computeBonesUsingShaders=!1;else if(r.subMeshes){for(let a of r.subMeshes)if(a.effect===e){r.computeBonesUsingShaders=!1;break}}}}}else{let i=this._defines[this._currentRank];if(i)for(let s=0;s<i.length;s++)t=t.replace("#define "+i[s],"");this._currentRank++}return t}},Na="bayerDitherFunctions",Ba=`float bayerDither2(vec2 _P) {
return mod(2.0*_P.y+_P.x+1.0,4.0);
}
float bayerDither4(vec2 _P) {
vec2 P1=mod(_P,2.0); 
vec2 P2=floor(0.5*mod(_P,4.0)); 
return 4.0*bayerDither2(P1)+bayerDither2(P2);
}
float bayerDither8(vec2 _P) {
vec2 P1=mod(_P,2.0); 
vec2 P2=floor(0.5 *mod(_P,4.0)); 
vec2 P4=floor(0.25*mod(_P,8.0)); 
return 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);
}
`;w.IncludesShadersStore[Na]=Ba;var Ua="shadowMapFragmentExtraDeclaration",ka=`#if SM_FLOAT==0
#include<packingFunctions>
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#include<bayerDitherFunctions>
uniform float softTransparentShadowSM;
#endif
varying float vDepthMetricSM;
#if SM_USEDISTANCE==1
uniform vec3 lightDataSM;
varying vec3 vPositionWSM;
#endif
uniform vec3 biasAndScaleSM;
uniform vec2 depthValuesSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying float zSM;
#endif
`;w.IncludesShadersStore[Ua]=ka;var Va="clipPlaneFragmentDeclaration",Ga=`#ifdef CLIPPLANE
varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
varying float fClipDistance6;
#endif
`;w.IncludesShadersStore[Va]=Ga;var Wa="clipPlaneFragment",za=`#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
if (false) {}
#endif
#ifdef CLIPPLANE
else if (fClipDistance>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE2
else if (fClipDistance2>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE3
else if (fClipDistance3>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE4
else if (fClipDistance4>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE5
else if (fClipDistance5>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE6
else if (fClipDistance6>0.0)
{
discard;
}
#endif
`;w.IncludesShadersStore[Wa]=za;var Xa="shadowMapFragment",Ha=`float depthSM=vDepthMetricSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
#if SM_USEDISTANCE==1
depthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
#ifdef USE_REVERSE_DEPTHBUFFER
depthSM=(-zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
depthSM=(zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
gl_FragDepth=clamp(1.0-depthSM,0.0,1.0);
#else
gl_FragDepth=clamp(depthSM,0.0,1.0); 
#endif
#elif SM_USEDISTANCE==1
depthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#if SM_ESM==1
depthSM=clamp(exp(-min(87.,biasAndScaleSM.z*depthSM)),0.,1.);
#endif
#if SM_FLOAT==1
gl_FragColor=vec4(depthSM,1.0,1.0,1.0);
#else
gl_FragColor=pack(depthSM);
#endif
return;`;w.IncludesShadersStore[Xa]=Ha;var Ka="shadowMapPixelShader",Ya=`#include<shadowMapFragmentExtraDeclaration>
#ifdef ALPHATEXTURE
varying vec2 vUV;
uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
#ifdef ALPHATEXTURE
float alphaFromAlphaTexture=texture2D(diffuseSampler,vUV).a;
#ifdef ALPHATESTVALUE
if (alphaFromAlphaTexture<ALPHATESTVALUE)
discard;
#endif
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#ifdef ALPHATEXTURE
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alphaFromAlphaTexture) discard;
#else
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM) discard;
#endif
#endif
#include<shadowMapFragment>
}`;w.ShadersStore[Ka]=Ya;var ja="bonesDeclaration",qa=`#if NUM_BONE_INFLUENCERS>0
attribute vec4 matricesIndices;
attribute vec4 matricesWeights;
#if NUM_BONE_INFLUENCERS>4
attribute vec4 matricesIndicesExtra;
attribute vec4 matricesWeightsExtra;
#endif
#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#ifdef BONETEXTURE
uniform sampler2D boneSampler;
uniform float boneTextureWidth;
#else
uniform mat4 mBones[BonesPerMesh];
#ifdef BONES_VELOCITY_ENABLED
uniform mat4 mPreviousBones[BonesPerMesh];
#endif
#endif
#ifdef BONETEXTURE
#define inline
mat4 readMatrixFromRawSampler(sampler2D smp,float index)
{
float offset=index *4.0;
float dx=1.0/boneTextureWidth;
vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),0.));
vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),0.));
vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),0.));
vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),0.));
return mat4(m0,m1,m2,m3);
}
#endif
#endif
#endif
`;w.IncludesShadersStore[ja]=qa;var Za="bakedVertexAnimationDeclaration",Qa=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
uniform float bakedVertexAnimationTime;
uniform vec2 bakedVertexAnimationTextureSizeInverted;
uniform vec4 bakedVertexAnimationSettings;
uniform sampler2D bakedVertexAnimationTexture;
#ifdef INSTANCES
attribute vec4 bakedVertexAnimationSettingsInstanced;
#endif
#define inline
mat4 readMatrixFromRawSamplerVAT(sampler2D smp,float index,float frame)
{
float offset=index*4.0;
float frameUV=(frame+0.5)*bakedVertexAnimationTextureSizeInverted.y;
float dx=bakedVertexAnimationTextureSizeInverted.x;
vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),frameUV));
vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),frameUV));
vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),frameUV));
vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),frameUV));
return mat4(m0,m1,m2,m3);
}
#endif
`;w.IncludesShadersStore[Za]=Qa;var $a="morphTargetsVertexGlobalDeclaration",Ja=`#ifdef MORPHTARGETS
uniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];
#ifdef MORPHTARGETS_TEXTURE 
precision mediump sampler2DArray; 
uniform float morphTargetTextureIndices[NUM_MORPH_INFLUENCERS];
uniform vec3 morphTargetTextureInfo;
uniform sampler2DArray morphTargets;
vec3 readVector3FromRawSampler(int targetIndex,float vertexIndex)
{ 
float y=floor(vertexIndex/morphTargetTextureInfo.y);
float x=vertexIndex-y*morphTargetTextureInfo.y;
vec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);
return texture(morphTargets,textureUV).xyz;
}
#endif
#endif
`;w.IncludesShadersStore[$a]=Ja;var eo="morphTargetsVertexDeclaration",to=`#ifdef MORPHTARGETS
#ifndef MORPHTARGETS_TEXTURE
attribute vec3 position{X};
#ifdef MORPHTARGETS_NORMAL
attribute vec3 normal{X};
#endif
#ifdef MORPHTARGETS_TANGENT
attribute vec3 tangent{X};
#endif
#ifdef MORPHTARGETS_UV
attribute vec2 uv_{X};
#endif
#endif
#endif
`;w.IncludesShadersStore[eo]=to;var io="helperFunctions",so=`const float PI=3.1415926535897932384626433832795;
const float HALF_MIN=5.96046448e-08; 
const float LinearEncodePowerApprox=2.2;
const float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;
const vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);
const float Epsilon=0.0000001;
#define saturate(x) clamp(x,0.0,1.0)
#define absEps(x) abs(x)+Epsilon
#define maxEps(x) max(x,Epsilon)
#define saturateEps(x) clamp(x,Epsilon,1.0)
mat3 transposeMat3(mat3 inMatrix) {
vec3 i0=inMatrix[0];
vec3 i1=inMatrix[1];
vec3 i2=inMatrix[2];
mat3 outMatrix=mat3(
vec3(i0.x,i1.x,i2.x),
vec3(i0.y,i1.y,i2.y),
vec3(i0.z,i1.z,i2.z)
);
return outMatrix;
}
mat3 inverseMat3(mat3 inMatrix) {
float a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];
float a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];
float a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];
float b01=a22*a11-a12*a21;
float b11=-a22*a10+a12*a20;
float b21=a21*a10-a11*a20;
float det=a00*b01+a01*b11+a02*b21;
return mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),
b11,(a22*a00-a02*a20),(-a12*a00+a02*a10),
b21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;
}
#if USE_EXACT_SRGB_CONVERSIONS
vec3 toLinearSpaceExact(vec3 color)
{
vec3 nearZeroSection=0.0773993808*color;
vec3 remainingSection=pow(0.947867299*(color+vec3(0.055)),vec3(2.4));
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.04045)));
#else
return
vec3(
color.r<=0.04045 ? nearZeroSection.r : remainingSection.r,
color.g<=0.04045 ? nearZeroSection.g : remainingSection.g,
color.b<=0.04045 ? nearZeroSection.b : remainingSection.b);
#endif
}
vec3 toGammaSpaceExact(vec3 color)
{
vec3 nearZeroSection=12.92*color;
vec3 remainingSection=1.055*pow(color,vec3(0.41666))-vec3(0.055);
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.0031308)));
#else
return
vec3(
color.r<=0.0031308 ? nearZeroSection.r : remainingSection.r,
color.g<=0.0031308 ? nearZeroSection.g : remainingSection.g,
color.b<=0.0031308 ? nearZeroSection.b : remainingSection.b);
#endif
}
#endif
float toLinearSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=0.0773993808*color;
float remainingSection=pow(0.947867299*(color+0.055),2.4);
return color<=0.04045 ? nearZeroSection : remainingSection;
#else
return pow(color,LinearEncodePowerApprox);
#endif
}
vec3 toLinearSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toLinearSpaceExact(color);
#else
return pow(color,vec3(LinearEncodePowerApprox));
#endif
}
vec4 toLinearSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toLinearSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(LinearEncodePowerApprox)),color.a);
#endif
}
float toGammaSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=12.92*color;
float remainingSection=1.055*pow(color,0.41666)-0.055;
return color<=0.0031308 ? nearZeroSection : remainingSection;
#else
return pow(color,GammaEncodePowerApprox);
#endif
}
vec3 toGammaSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toGammaSpaceExact(color);
#else
return pow(color,vec3(GammaEncodePowerApprox));
#endif
}
vec4 toGammaSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toGammaSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(GammaEncodePowerApprox)),color.a);
#endif
}
float square(float value)
{
return value*value;
}
vec3 square(vec3 value)
{
return value*value;
}
float pow5(float value) {
float sq=value*value;
return sq*sq*value;
}
float getLuminance(vec3 color)
{
return clamp(dot(color,LuminanceEncodeApprox),0.,1.);
}
float getRand(vec2 seed) {
return fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);
}
float dither(vec2 seed,float varianceAmount) {
float rand=getRand(seed);
float normVariance=varianceAmount/255.0;
float dither=mix(-normVariance,normVariance,rand);
return dither;
}
const float rgbdMaxRange=255.0;
vec4 toRGBD(vec3 color) {
float maxRGB=maxEps(max(color.r,max(color.g,color.b)));
float D =max(rgbdMaxRange/maxRGB,1.);
D =clamp(floor(D)/255.0,0.,1.);
vec3 rgb=color.rgb*D;
rgb=toGammaSpace(rgb);
return vec4(clamp(rgb,0.,1.),D); 
}
vec3 fromRGBD(vec4 rgbd) {
rgbd.rgb=toLinearSpace(rgbd.rgb);
return rgbd.rgb/rgbd.a;
}
vec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {
vec3 invOrigVec=vec3(1.0,1.0,1.0)/origVec;
vec3 halfSize=cubeSize*0.5;
vec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;
vec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;
vec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);
float distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);
vec3 intersectPositionWS=vertexPos+origVec*distance;
return intersectPositionWS-cubePos;
}
`;w.IncludesShadersStore[io]=so;var ro="sceneVertexDeclaration",no=`uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
uniform mat4 view;
uniform mat4 projection;
uniform vec4 vEyePosition;
`;w.IncludesShadersStore[ro]=no;var ao="meshVertexDeclaration",oo=`uniform mat4 world;
uniform float visibility;
`;w.IncludesShadersStore[ao]=oo;var ho="shadowMapVertexDeclaration",lo=`#include<sceneVertexDeclaration>
#include<meshVertexDeclaration>
`;w.IncludesShadersStore[ho]=lo;var co="sceneUboDeclaration",uo=`layout(std140,column_major) uniform;
uniform Scene {
mat4 viewProjection;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif 
mat4 view;
mat4 projection;
vec4 vEyePosition;
};
`;w.IncludesShadersStore[co]=uo;var fo="meshUboDeclaration",_o=`#ifdef WEBGL2
uniform mat4 world;
uniform float visibility;
#else
layout(std140,column_major) uniform;
uniform Mesh
{
mat4 world;
float visibility;
};
#endif
#define WORLD_UBO
`;w.IncludesShadersStore[fo]=_o;var po="shadowMapUboDeclaration",go=`layout(std140,column_major) uniform;
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;w.IncludesShadersStore[po]=go;var mo="shadowMapVertexExtraDeclaration",vo=`#if SM_NORMALBIAS==1
uniform vec3 lightDataSM;
#endif
uniform vec3 biasAndScaleSM;
uniform vec2 depthValuesSM;
varying float vDepthMetricSM;
#if SM_USEDISTANCE==1
varying vec3 vPositionWSM;
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying float zSM;
#endif
`;w.IncludesShadersStore[mo]=vo;var Eo="clipPlaneVertexDeclaration",To=`#ifdef CLIPPLANE
uniform vec4 vClipPlane;
varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
uniform vec4 vClipPlane2;
varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
uniform vec4 vClipPlane3;
varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
uniform vec4 vClipPlane4;
varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
uniform vec4 vClipPlane5;
varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
uniform vec4 vClipPlane6;
varying float fClipDistance6;
#endif
`;w.IncludesShadersStore[Eo]=To;var So="morphTargetsVertexGlobal",bo=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
float vertexID;
#endif
#endif
`;w.IncludesShadersStore[So]=bo;var xo="morphTargetsVertex",Mo=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE 
vertexID=float(gl_VertexID)*morphTargetTextureInfo.x;
positionUpdated+=(readVector3FromRawSampler({X},vertexID)-position)*morphTargetInfluences[{X}];
vertexID+=1.0;
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(readVector3FromRawSampler({X},vertexID) -normal)*morphTargetInfluences[{X}];
vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_UV
uvUpdated+=(readVector3FromRawSampler({X},vertexID).xy-uv)*morphTargetInfluences[{X}];
vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz+=(readVector3FromRawSampler({X},vertexID) -tangent.xyz)*morphTargetInfluences[{X}];
#endif
#else
positionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_UV
uvUpdated+=(uv_{X}-uv)*morphTargetInfluences[{X}];
#endif
#endif
#endif
`;w.IncludesShadersStore[xo]=Mo;var Ao="instancesVertex",Ro=`#ifdef INSTANCES
mat4 finalWorld=mat4(world0,world1,world2,world3);
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
mat4 finalPreviousWorld=mat4(previousWorld0,previousWorld1,previousWorld2,previousWorld3);
#endif
#ifdef THIN_INSTANCES
finalWorld=world*finalWorld;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
finalPreviousWorld=previousWorld*finalPreviousWorld;
#endif
#endif
#else
mat4 finalWorld=world;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
mat4 finalPreviousWorld=previousWorld;
#endif
#endif
`;w.IncludesShadersStore[Ao]=Ro;var yo="bonesVertex",Co=`#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#if NUM_BONE_INFLUENCERS>0
mat4 influence;
#ifdef BONETEXTURE
influence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];
#endif
#else
influence=mBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence+=mBones[int(matricesIndices[1])]*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
influence+=mBones[int(matricesIndices[2])]*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
influence+=mBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
influence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
influence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
influence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
influence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
#endif
finalWorld=finalWorld*influence;
#endif
#endif
`;w.IncludesShadersStore[yo]=Co;var Io="bakedVertexAnimation",Po=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
{
#ifdef INSTANCES
#define BVASNAME bakedVertexAnimationSettingsInstanced
#else
#define BVASNAME bakedVertexAnimationSettings
#endif
float VATStartFrame=BVASNAME.x;
float VATEndFrame=BVASNAME.y;
float VATOffsetFrame=BVASNAME.z;
float VATSpeed=BVASNAME.w;
float totalFrames=VATEndFrame-VATStartFrame+1.0;
float time=bakedVertexAnimationTime*VATSpeed/totalFrames;
float frameCorrection=time<1.0 ? 0.0 : 1.0;
float numOfFrames=totalFrames-frameCorrection;
float VATFrameNum=fract(time)*numOfFrames;
VATFrameNum=mod(VATFrameNum+VATOffsetFrame,numOfFrames);
VATFrameNum=floor(VATFrameNum);
VATFrameNum+=VATStartFrame+frameCorrection;
mat4 VATInfluence;
VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];
#endif
finalWorld=finalWorld*VATInfluence;
}
#endif
`;w.IncludesShadersStore[Io]=Po;var Do="shadowMapVertexNormalBias",Fo=`#if SM_NORMALBIAS==1
#if SM_DIRECTIONINLIGHTDATA==1
vec3 worldLightDirSM=normalize(-lightDataSM.xyz);
#else
vec3 directionToLightSM=lightDataSM.xyz-worldPos.xyz;
vec3 worldLightDirSM=normalize(directionToLightSM);
#endif
float ndlSM=dot(vNormalW,worldLightDirSM);
float sinNLSM=sqrt(1.0-ndlSM*ndlSM);
float normalBiasSM=biasAndScaleSM.y*sinNLSM;
worldPos.xyz-=vNormalW*normalBiasSM;
#endif
`;w.IncludesShadersStore[Do]=Fo;var wo="shadowMapVertexMetric",Oo=`#if SM_USEDISTANCE==1
vPositionWSM=worldPos.xyz;
#endif
#if SM_DEPTHTEXTURE==1
#ifdef IS_NDC_HALF_ZRANGE
#define BIASFACTOR 0.5
#else
#define BIASFACTOR 1.0
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
gl_Position.z-=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;
#else
gl_Position.z+=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;
#endif
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
zSM=gl_Position.z;
gl_Position.z=0.0;
#elif SM_USEDISTANCE==0
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetricSM=(-gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
vDepthMetricSM=(gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#endif
`;w.IncludesShadersStore[wo]=Oo;var Lo="clipPlaneVertex",No=`#ifdef CLIPPLANE
fClipDistance=dot(worldPos,vClipPlane);
#endif
#ifdef CLIPPLANE2
fClipDistance2=dot(worldPos,vClipPlane2);
#endif
#ifdef CLIPPLANE3
fClipDistance3=dot(worldPos,vClipPlane3);
#endif
#ifdef CLIPPLANE4
fClipDistance4=dot(worldPos,vClipPlane4);
#endif
#ifdef CLIPPLANE5
fClipDistance5=dot(worldPos,vClipPlane5);
#endif
#ifdef CLIPPLANE6
fClipDistance6=dot(worldPos,vClipPlane6);
#endif
`;w.IncludesShadersStore[Lo]=No;var Bo="shadowMapVertexShader",Uo=`attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef INSTANCES
attribute vec4 world0;
attribute vec4 world1;
attribute vec4 world2;
attribute vec4 world3;
#endif
#include<helperFunctions>
#include<__decl__shadowMapVertex>
#ifdef ALPHATEXTURE
varying vec2 vUV;
uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#include<shadowMapVertexExtraDeclaration>
#include<clipPlaneVertexDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{
vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normWorldSM=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vec3 vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));
vNormalW=normalize(normWorldSM*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normWorldSM=transposeMat3(inverseMat3(normWorldSM));
#endif
vec3 vNormalW=normalize(normWorldSM*normalUpdated);
#endif
#endif
#include<shadowMapVertexNormalBias>
gl_Position=viewProjection*worldPos;
#include<shadowMapVertexMetric>
#ifdef ALPHATEXTURE
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#include<clipPlaneVertex>
}`;w.ShadersStore[Bo]=Uo;var ko="depthBoxBlurPixelShader",Vo=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec2 screenSize;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec4 colorDepth=vec4(0.0);
for (int x=-OFFSET; x<=OFFSET; x++)
for (int y=-OFFSET; y<=OFFSET; y++)
colorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);
gl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));
}`;w.ShadersStore[ko]=Vo;var Go="shadowMapFragmentSoftTransparentShadow",Wo=`#if SM_SOFTTRANSPARENTSHADOW==1
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alpha) discard;
#endif
`;w.IncludesShadersStore[Go]=Wo;var qe=(()=>{class n{constructor(e,i,s,r){this.onBeforeShadowMapRenderObservable=new D,this.onAfterShadowMapRenderObservable=new D,this.onBeforeShadowMapRenderMeshObservable=new D,this.onAfterShadowMapRenderMeshObservable=new D,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=n.FILTER_NONE,this._filteringQuality=n.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this.forceBackFacesOnly=!1,this._lightDirection=v.Zero(),this._viewMatrix=P.Zero(),this._projectionMatrix=P.Zero(),this._transformMatrix=P.Zero(),this._cachedPosition=new v(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new v(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=P.Identity(),this._mapSize=e,this._light=i,this._scene=i.getScene(),this._camera=r??null;let a=i._shadowGenerators;a||(a=i._shadowGenerators=new Map),a.set(this._camera,this),this.id=i.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for Shadow Generator (light "${this._light.name}")`))),n._SceneComponentInitialization(this._scene);let o=this._scene.getEngine().getCaps();s?o.textureFloatRender&&o.textureFloatLinearFiltering?this._textureType=1:o.textureHalfFloatRender&&o.textureHalfFloatLinearFiltering?this._textureType=2:this._textureType=0:o.textureHalfFloatRender&&o.textureHalfFloatLinearFiltering?this._textureType=2:o.textureFloatRender&&o.textureFloatLinearFiltering?this._textureType=1:this._textureType=0,this._initializeGenerator(),this._applyFilterValues()}get bias(){return this._bias}set bias(e){this._bias=e}get normalBias(){return this._normalBias}set normalBias(e){this._normalBias=e}get blurBoxOffset(){return this._blurBoxOffset}set blurBoxOffset(e){this._blurBoxOffset!==e&&(this._blurBoxOffset=e,this._disposeBlurPostProcesses())}get blurScale(){return this._blurScale}set blurScale(e){this._blurScale!==e&&(this._blurScale=e,this._disposeBlurPostProcesses())}get blurKernel(){return this._blurKernel}set blurKernel(e){this._blurKernel!==e&&(this._blurKernel=e,this._disposeBlurPostProcesses())}get useKernelBlur(){return this._useKernelBlur}set useKernelBlur(e){this._useKernelBlur!==e&&(this._useKernelBlur=e,this._disposeBlurPostProcesses())}get depthScale(){return this._depthScale!==void 0?this._depthScale:this._light.getDepthScale()}set depthScale(e){this._depthScale=e}_validateFilter(e){return e}get filter(){return this._filter}set filter(e){if(e=this._validateFilter(e),this._light.needCube()){if(e===n.FILTER_BLUREXPONENTIALSHADOWMAP){this.useExponentialShadowMap=!0;return}else if(e===n.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP){this.useCloseExponentialShadowMap=!0;return}else if(e===n.FILTER_PCF||e===n.FILTER_PCSS){this.usePoissonSampling=!0;return}}if((e===n.FILTER_PCF||e===n.FILTER_PCSS)&&!this._scene.getEngine()._features.supportShadowSamplers){this.usePoissonSampling=!0;return}this._filter!==e&&(this._filter=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get usePoissonSampling(){return this.filter===n.FILTER_POISSONSAMPLING}set usePoissonSampling(e){let i=this._validateFilter(n.FILTER_POISSONSAMPLING);!e&&this.filter!==n.FILTER_POISSONSAMPLING||(this.filter=e?i:n.FILTER_NONE)}get useExponentialShadowMap(){return this.filter===n.FILTER_EXPONENTIALSHADOWMAP}set useExponentialShadowMap(e){let i=this._validateFilter(n.FILTER_EXPONENTIALSHADOWMAP);!e&&this.filter!==n.FILTER_EXPONENTIALSHADOWMAP||(this.filter=e?i:n.FILTER_NONE)}get useBlurExponentialShadowMap(){return this.filter===n.FILTER_BLUREXPONENTIALSHADOWMAP}set useBlurExponentialShadowMap(e){let i=this._validateFilter(n.FILTER_BLUREXPONENTIALSHADOWMAP);!e&&this.filter!==n.FILTER_BLUREXPONENTIALSHADOWMAP||(this.filter=e?i:n.FILTER_NONE)}get useCloseExponentialShadowMap(){return this.filter===n.FILTER_CLOSEEXPONENTIALSHADOWMAP}set useCloseExponentialShadowMap(e){let i=this._validateFilter(n.FILTER_CLOSEEXPONENTIALSHADOWMAP);!e&&this.filter!==n.FILTER_CLOSEEXPONENTIALSHADOWMAP||(this.filter=e?i:n.FILTER_NONE)}get useBlurCloseExponentialShadowMap(){return this.filter===n.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP}set useBlurCloseExponentialShadowMap(e){let i=this._validateFilter(n.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);!e&&this.filter!==n.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP||(this.filter=e?i:n.FILTER_NONE)}get usePercentageCloserFiltering(){return this.filter===n.FILTER_PCF}set usePercentageCloserFiltering(e){let i=this._validateFilter(n.FILTER_PCF);!e&&this.filter!==n.FILTER_PCF||(this.filter=e?i:n.FILTER_NONE)}get filteringQuality(){return this._filteringQuality}set filteringQuality(e){this._filteringQuality!==e&&(this._filteringQuality=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get useContactHardeningShadow(){return this.filter===n.FILTER_PCSS}set useContactHardeningShadow(e){let i=this._validateFilter(n.FILTER_PCSS);!e&&this.filter!==n.FILTER_PCSS||(this.filter=e?i:n.FILTER_NONE)}get contactHardeningLightSizeUVRatio(){return this._contactHardeningLightSizeUVRatio}set contactHardeningLightSizeUVRatio(e){this._contactHardeningLightSizeUVRatio=e}get darkness(){return this._darkness}set darkness(e){this.setDarkness(e)}getDarkness(){return this._darkness}setDarkness(e){return e>=1?this._darkness=1:e<=0?this._darkness=0:this._darkness=e,this}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(e){this.setTransparencyShadow(e)}setTransparencyShadow(e){return this._transparencyShadow=e,this}getShadowMap(){return this._shadowMap}getShadowMapForRendering(){return this._shadowMap2?this._shadowMap2:this._shadowMap}getClassName(){return n.CLASSNAME}addShadowCaster(e,i=!0){if(!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),this._shadowMap.renderList.indexOf(e)===-1&&this._shadowMap.renderList.push(e),i)for(let s of e.getChildMeshes())this._shadowMap.renderList.indexOf(s)===-1&&this._shadowMap.renderList.push(s);return this}removeShadowCaster(e,i=!0){if(!this._shadowMap||!this._shadowMap.renderList)return this;let s=this._shadowMap.renderList.indexOf(e);if(s!==-1&&this._shadowMap.renderList.splice(s,1),i)for(let r of e.getChildren())this.removeShadowCaster(r);return this}getLight(){return this._light}_getCamera(){var e;return(e=this._camera)!==null&&e!==void 0?e:this._scene.activeCamera}get mapSize(){return this._mapSize}set mapSize(e){this._mapSize=e,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}_initializeGenerator(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()}_createTargetRenderTexture(){let e=this._scene.getEngine();e._features.supportDepthStencilTexture?(this._shadowMap=new li(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0)):this._shadowMap=new li(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube())}_initializeShadowMap(){if(this._createTargetRenderTexture(),this._shadowMap===null)return;this._shadowMap.wrapU=L.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=L.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(L.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=this._renderForShadowMap.bind(this),this._shadowMap.customIsReadyFunction=()=>!0;let e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add(()=>{var r;this._currentSceneUBO=this._scene.getSceneUniformBuffer(),(r=e._debugPushGroup)===null||r===void 0||r.call(e,`shadow map generation for pass id ${e.currentRenderPassId}`,1)}),this._shadowMap.onBeforeRenderObservable.add(r=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[0]),this._currentFaceIndex=r,this._filter===n.FILTER_PCF&&e.setColorWrite(!1),this.getTransformMatrix(),this._scene.setTransformMatrix(this._viewMatrix,this._projectionMatrix),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onAfterUnbindObservable.add(()=>{var r,a;if(this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),this._scene.updateTransformMatrix(),this._filter===n.FILTER_PCF&&e.setColorWrite(!0),!this.useBlurExponentialShadowMap&&!this.useBlurCloseExponentialShadowMap){(r=e._debugPopGroup)===null||r===void 0||r.call(e,1);return}let o=this.getShadowMapForRendering();o&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,o.renderTarget,!0),e.unBindFramebuffer(o.renderTarget,!0),(a=e._debugPopGroup)===null||a===void 0||a.call(e,1))});let i=new ie(0,0,0,0),s=new ie(1,1,1,1);this._shadowMap.onClearObservable.add(r=>{this._filter===n.FILTER_PCF?r.clear(s,!1,!0,!1):this.useExponentialShadowMap||this.useBlurExponentialShadowMap?r.clear(i,!0,!0,!1):r.clear(s,!0,!0,!1)}),this._shadowMap.onResizeObservable.add(r=>{this._storedUniqueId=this._shadowMap.uniqueId,this._mapSize=r.getRenderSize(),this._light._markMeshesAsLightDirty(),this.recreateShadowMap()});for(let r=hs.MIN_RENDERINGGROUPS;r<hs.MAX_RENDERINGGROUPS;r++)this._shadowMap.setRenderingAutoClearDepthStencil(r,!1)}_initializeBlurRTTAndPostProcesses(){let e=this._scene.getEngine(),i=this._mapSize/this.blurScale;(!this.useKernelBlur||this.blurScale!==1)&&(this._shadowMap2=new li(this._light.name+"_shadowMap2",i,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=L.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=L.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(L.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new Kt(this._light.name+"KernelBlurX",new ve(1,0),this.blurKernel,1,null,L.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.width=i,this._kernelBlurXPostprocess.height=i,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add(s=>{s.setTexture("textureSampler",this._shadowMap)}),this._kernelBlurYPostprocess=new Kt(this._light.name+"KernelBlurY",new ve(0,1),this.blurKernel,1,null,L.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,this._textureType===0&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new Ce(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,L.BILINEAR_SAMPLINGMODE,e,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add(s=>{s.setFloat2("screenSize",i,i),s.setTexture("textureSampler",this._shadowMap)}),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])}_renderForShadowMap(e,i,s,r){let a;if(r.length)for(a=0;a<r.length;a++)this._renderSubMeshForShadowMap(r.data[a]);for(a=0;a<e.length;a++)this._renderSubMeshForShadowMap(e.data[a]);for(a=0;a<i.length;a++)this._renderSubMeshForShadowMap(i.data[a]);if(this._transparencyShadow)for(a=0;a<s.length;a++)this._renderSubMeshForShadowMap(s.data[a],!0);else for(a=0;a<s.length;a++)s.data[a].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}_bindCustomEffectForRenderSubMeshForShadowMap(e,i,s){i.setMatrix("viewProjection",this.getTransformMatrix())}_renderSubMeshForShadowMap(e,i=!1){var s,r;let a=e.getRenderingMesh(),o=e.getEffectiveMesh(),h=this._scene,l=h.getEngine(),c=e.getMaterial();if(o._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!c||e.verticesCount===0||e._renderId===h.getRenderId())return;let d=o._getWorldMatrixDeterminant()<0,u=(s=a.overrideMaterialSideOrientation)!==null&&s!==void 0?s:c.sideOrientation;d&&(u=u===0?1:0);let f=u===0;l.setState(c.backFaceCulling,void 0,void 0,f,c.cullBackFaces);let _=a._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(_.mustReturn)return;let g=l.getCaps().instancedArrays&&(_.visibleInstances[e._id]!==null&&_.visibleInstances[e._id]!==void 0||a.hasThinInstances);if(!(this.customAllowRendering&&!this.customAllowRendering(e)))if(this.isReady(e,g,i)){e._renderId=h.getRenderId();let p=c.shadowDepthWrapper,E=(r=p?.getEffect(e,this,l.currentRenderPassId))!==null&&r!==void 0?r:e._getDrawWrapper(),T=Wt.GetEffect(E);l.enableEffect(E),g||a._bind(e,T,c.fillMode),this.getTransformMatrix(),T.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===re.LIGHTTYPEID_DIRECTIONALLIGHT?T.setVector3("lightDataSM",this._cachedDirection):T.setVector3("lightDataSM",this._cachedPosition);let R=this._getCamera();if(R&&T.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(R),this.getLight().getDepthMinZ(R)+this.getLight().getDepthMaxZ(R)),i&&this.enableSoftTransparentShadow&&T.setFloat("softTransparentShadowSM",o.visibility*c.alpha),p)e._setMainDrawWrapperOverride(E),p.standalone?p.baseMaterial.bindForSubMesh(o.getWorldMatrix(),a,e):c.bindForSubMesh(o.getWorldMatrix(),a,e),e._setMainDrawWrapperOverride(null);else{if(this.useOpacityTextureForTransparentShadow){let M=c.opacityTexture;M&&(T.setTexture("diffuseSampler",M),T.setMatrix("diffuseMatrix",M.getTextureMatrix()||this._defaultTextureMatrix))}else if(c.needAlphaTesting()||c.needAlphaBlending()){let M=c.getAlphaTestTexture();M&&(T.setTexture("diffuseSampler",M),T.setMatrix("diffuseMatrix",M.getTextureMatrix()||this._defaultTextureMatrix))}if(a.useBones&&a.computeBonesUsingShaders&&a.skeleton){let M=a.skeleton;if(M.isUsingTextureForMatrices){let b=M.getTransformMatrixTexture(a);if(!b)return;T.setTexture("boneSampler",b),T.setFloat("boneTextureWidth",4*(M.bones.length+1))}else T.setMatrices("mBones",M.getTransformMatrices(a))}K.BindMorphTargetParameters(a,T),a.morphTargetManager&&a.morphTargetManager.isUsingTextureForTargets&&a.morphTargetManager._bind(T),Ms(T,c,h)}!this._useUBO&&!p&&this._bindCustomEffectForRenderSubMeshForShadowMap(e,T,o),K.BindSceneUniformBuffer(T,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();let y=o.getWorldMatrix();g&&(o.getMeshUniformBuffer().bindToEffect(T,"Mesh"),o.transferToEffect(y)),this.forceBackFacesOnly&&l.setState(!0,0,!1,!0,c.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(a),this.onBeforeShadowMapRenderObservable.notifyObservers(T),a._processRendering(o,e,T,c.fillMode,_,g,(M,b)=>{o!==a&&!M?(a.getMeshUniformBuffer().bindToEffect(T,"Mesh"),a.transferToEffect(b)):(o.getMeshUniformBuffer().bindToEffect(T,"Mesh"),o.transferToEffect(M?b:y))}),this.forceBackFacesOnly&&l.setState(!0,0,!1,!1,c.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(T),this.onAfterShadowMapRenderMeshObservable.notifyObservers(a)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}_applyFilterValues(){this._shadowMap&&(this.filter===n.FILTER_NONE||this.filter===n.FILTER_PCSS?this._shadowMap.updateSamplingMode(L.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(L.BILINEAR_SAMPLINGMODE))}forceCompilation(e,i){let s=Xe({useInstances:!1},i),r=this.getShadowMap();if(!r){e&&e(this);return}let a=r.renderList;if(!a){e&&e(this);return}let o=new Array;for(let c of a)o.push(...c.subMeshes);if(o.length===0){e&&e(this);return}let h=0,l=()=>{var c,d;if(!(!this._scene||!this._scene.getEngine())){for(;this.isReady(o[h],s.useInstances,(d=(c=o[h].getMaterial())===null||c===void 0?void 0:c.needAlphaBlendingForMesh(o[h].getMesh()))!==null&&d!==void 0?d:!1);)if(h++,h>=o.length){e&&e(this);return}setTimeout(l,16)}};l()}forceCompilationAsync(e){return new Promise(i=>{this.forceCompilation(()=>{i()},e)})}_isReadyCustomDefines(e,i,s){}_prepareShadowDefines(e,i,s,r){s.push("#define SM_LIGHTTYPE_"+this._light.getClassName().toUpperCase()),s.push("#define SM_FLOAT "+(this._textureType!==0?"1":"0")),s.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),s.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));let a=e.getMesh();return s.push("#define SM_NORMALBIAS "+(this.normalBias&&a.isVerticesDataPresent(m.NormalKind)?"1":"0")),s.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===re.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),s.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),s.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&r?"1":"0")),this._isReadyCustomDefines(s,e,i),s}isReady(e,i,s){var r;let a=e.getMaterial(),o=a?.shadowDepthWrapper;if(!a)return!1;let h=[];if(this._prepareShadowDefines(e,i,h,s),o){if(!o.isReadyForSubMesh(e,h,this,i,this._scene.getEngine().currentRenderPassId))return!1}else{let l=e._getDrawWrapper(void 0,!0),c=l.effect,d=l.defines,u=[m.PositionKind],f=e.getMesh();this.normalBias&&f.isVerticesDataPresent(m.NormalKind)&&(u.push(m.NormalKind),h.push("#define NORMAL"),f.nonUniformScaling&&h.push("#define NONUNIFORMSCALING"));let _=a?.needAlphaTesting(),g=a?.needAlphaBlending();if(a&&(_||g)){let y=null;if(this.useOpacityTextureForTransparentShadow?y=a.opacityTexture:y=a.getAlphaTestTexture(),y){if(!y.isReady())return!1;let M=(r=a.alphaCutOff)!==null&&r!==void 0?r:n.DEFAULT_ALPHA_CUTOFF;h.push("#define ALPHATEXTURE"),_&&h.push(`#define ALPHATESTVALUE ${M}${M%1===0?".":""}`),f.isVerticesDataPresent(m.UVKind)&&(u.push(m.UVKind),h.push("#define UV1")),f.isVerticesDataPresent(m.UV2Kind)&&y.coordinatesIndex===1&&(u.push(m.UV2Kind),h.push("#define UV2"))}}let p=new Gi;if(f.useBones&&f.computeBonesUsingShaders&&f.skeleton){u.push(m.MatricesIndicesKind),u.push(m.MatricesWeightsKind),f.numBoneInfluencers>4&&(u.push(m.MatricesIndicesExtraKind),u.push(m.MatricesWeightsExtraKind));let y=f.skeleton;h.push("#define NUM_BONE_INFLUENCERS "+f.numBoneInfluencers),f.numBoneInfluencers>0&&p.addCPUSkinningFallback(0,f),y.isUsingTextureForMatrices?h.push("#define BONETEXTURE"):h.push("#define BonesPerMesh "+(y.bones.length+1))}else h.push("#define NUM_BONE_INFLUENCERS 0");let E=f.morphTargetManager,T=0;if(E&&E.numInfluencers>0&&(h.push("#define MORPHTARGETS"),T=E.numInfluencers,h.push("#define NUM_MORPH_INFLUENCERS "+T),E.isUsingTextureForTargets&&h.push("#define MORPHTARGETS_TEXTURE"),K.PrepareAttributesForMorphTargetsInfluencers(u,f,T)),$r(a,this._scene,h),i&&(h.push("#define INSTANCES"),K.PushAttributesForInstances(u),e.getRenderingMesh().hasThinInstances&&h.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(let y of this.customShaderOptions.defines)h.indexOf(y)===-1&&h.push(y);let R=h.join(`
`);if(d!==R){d=R;let y="shadowMap",M=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","boneTextureWidth","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices"],b=["diffuseSampler","boneSampler","morphTargets"],x=["Scene","Mesh"];if(xs(M),this.customShaderOptions){if(y=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(let I of this.customShaderOptions.attributes)u.indexOf(I)===-1&&u.push(I);if(this.customShaderOptions.uniforms)for(let I of this.customShaderOptions.uniforms)M.indexOf(I)===-1&&M.push(I);if(this.customShaderOptions.samplers)for(let I of this.customShaderOptions.samplers)b.indexOf(I)===-1&&b.push(I)}let F=this._scene.getEngine();c=F.createEffect(y,{attributes:u,uniformsNames:M,uniformBuffersNames:x,samplers:b,defines:R,fallbacks:p,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:T}},F),l.setEffect(c,d)}if(!c.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(!this._blurPostProcesses||!this._blurPostProcesses.length)&&this._initializeBlurRTTAndPostProcesses(),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady()||this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady()||this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady())}prepareDefines(e,i){let s=this._scene,r=this._light;!s.shadowsEnabled||!r.shadowEnabled||(e["SHADOW"+i]=!0,this.useContactHardeningShadow?(e["SHADOWPCSS"+i]=!0,this._filteringQuality===n.QUALITY_LOW?e["SHADOWLOWQUALITY"+i]=!0:this._filteringQuality===n.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+i]=!0)):this.usePercentageCloserFiltering?(e["SHADOWPCF"+i]=!0,this._filteringQuality===n.QUALITY_LOW?e["SHADOWLOWQUALITY"+i]=!0:this._filteringQuality===n.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+i]=!0)):this.usePoissonSampling?e["SHADOWPOISSON"+i]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e["SHADOWESM"+i]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(e["SHADOWCLOSEESM"+i]=!0),r.needCube()&&(e["SHADOWCUBE"+i]=!0))}bindShadowLight(e,i){let s=this._light;if(!this._scene.shadowsEnabled||!s.shadowEnabled)return;let r=this._getCamera();if(!r)return;let a=this.getShadowMap();a&&(s.needCube()||i.setMatrix("lightMatrix"+e,this.getTransformMatrix()),this._filter===n.FILTER_PCF?(i.setDepthStencilTexture("shadowSampler"+e,this.getShadowMapForRendering()),s._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),a.getSize().width,1/a.getSize().width,this.frustumEdgeFalloff,e)):this._filter===n.FILTER_PCSS?(i.setDepthStencilTexture("shadowSampler"+e,this.getShadowMapForRendering()),i.setTexture("depthSampler"+e,this.getShadowMapForRendering()),s._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/a.getSize().width,this._contactHardeningLightSizeUVRatio*a.getSize().width,this.frustumEdgeFalloff,e)):(i.setTexture("shadowSampler"+e,this.getShadowMapForRendering()),s._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/a.getSize().width,this.depthScale,this.frustumEdgeFalloff,e)),s._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(r),this.getLight().getDepthMinZ(r)+this.getLight().getDepthMaxZ(r),e))}getTransformMatrix(){let e=this._scene;if(this._currentRenderId===e.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=e.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;let i=this._light.position;if(this._light.computeTransformedInformation()&&(i=this._light.transformedPosition),v.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),Math.abs(v.Dot(this._lightDirection,v.Up()))===1&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!i.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(i),this._cachedDirection.copyFrom(this._lightDirection),P.LookAtLHToRef(i,i.add(this._lightDirection),v.Up(),this._viewMatrix);let s=this.getShadowMap();if(s){let r=s.renderList;r&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,r)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix}recreateShadowMap(){let e=this._shadowMap;if(!e)return;let i=e.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),i){this._shadowMap.renderList||(this._shadowMap.renderList=[]);for(let s of i)this._shadowMap.renderList.push(s)}else this._shadowMap.renderList=null}_disposeBlurPostProcesses(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]}_disposeRTTandPostProcesses(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()}_disposeSceneUBOs(){if(this._sceneUBOs){for(let e of this._sceneUBOs)e.dispose();this._sceneUBOs=[]}}dispose(){if(this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light){if(this._light._shadowGenerators){let e=this._light._shadowGenerators.entries();for(let i=e.next();i.done!==!0;i=e.next()){let[s,r]=i.value;r===this&&this._light._shadowGenerators.delete(s)}this._light._shadowGenerators.size===0&&(this._light._shadowGenerators=null)}this._light._markMeshesAsLightDirty()}this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()}serialize(){var e;let i={},s=this.getShadowMap();if(!s)return i;if(i.className=this.getClassName(),i.lightId=this._light.id,i.cameraId=(e=this._camera)===null||e===void 0?void 0:e.id,i.id=this.id,i.mapSize=s.getRenderSize(),i.forceBackFacesOnly=this.forceBackFacesOnly,i.darkness=this.getDarkness(),i.transparencyShadow=this._transparencyShadow,i.frustumEdgeFalloff=this.frustumEdgeFalloff,i.bias=this.bias,i.normalBias=this.normalBias,i.usePercentageCloserFiltering=this.usePercentageCloserFiltering,i.useContactHardeningShadow=this.useContactHardeningShadow,i.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,i.filteringQuality=this.filteringQuality,i.useExponentialShadowMap=this.useExponentialShadowMap,i.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,i.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,i.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,i.usePoissonSampling=this.usePoissonSampling,i.depthScale=this.depthScale,i.blurBoxOffset=this.blurBoxOffset,i.blurKernel=this.blurKernel,i.blurScale=this.blurScale,i.useKernelBlur=this.useKernelBlur,i.renderList=[],s.renderList)for(let r=0;r<s.renderList.length;r++){let a=s.renderList[r];i.renderList.push(a.id)}return i}static Parse(e,i,s){let r=i.getLightById(e.lightId),a=e.cameraId!==void 0?i.getCameraById(e.cameraId):null,o=s?s(e.mapSize,r,a):new n(e.mapSize,r,void 0,a),h=o.getShadowMap();for(let l=0;l<e.renderList.length;l++)i.getMeshesById(e.renderList[l]).forEach(function(c){h&&(h.renderList||(h.renderList=[]),h.renderList.push(c))});return e.id!==void 0&&(o.id=e.id),o.forceBackFacesOnly=!!e.forceBackFacesOnly,e.darkness!==void 0&&o.setDarkness(e.darkness),e.transparencyShadow&&o.setTransparencyShadow(!0),e.frustumEdgeFalloff!==void 0&&(o.frustumEdgeFalloff=e.frustumEdgeFalloff),e.bias!==void 0&&(o.bias=e.bias),e.normalBias!==void 0&&(o.normalBias=e.normalBias),e.usePercentageCloserFiltering?o.usePercentageCloserFiltering=!0:e.useContactHardeningShadow?o.useContactHardeningShadow=!0:e.usePoissonSampling?o.usePoissonSampling=!0:e.useExponentialShadowMap?o.useExponentialShadowMap=!0:e.useBlurExponentialShadowMap?o.useBlurExponentialShadowMap=!0:e.useCloseExponentialShadowMap?o.useCloseExponentialShadowMap=!0:e.useBlurCloseExponentialShadowMap?o.useBlurCloseExponentialShadowMap=!0:e.useVarianceShadowMap?o.useExponentialShadowMap=!0:e.useBlurVarianceShadowMap&&(o.useBlurExponentialShadowMap=!0),e.contactHardeningLightSizeUVRatio!==void 0&&(o.contactHardeningLightSizeUVRatio=e.contactHardeningLightSizeUVRatio),e.filteringQuality!==void 0&&(o.filteringQuality=e.filteringQuality),e.depthScale&&(o.depthScale=e.depthScale),e.blurScale&&(o.blurScale=e.blurScale),e.blurBoxOffset&&(o.blurBoxOffset=e.blurBoxOffset),e.useKernelBlur&&(o.useKernelBlur=e.useKernelBlur),e.blurKernel&&(o.blurKernel=e.blurKernel),o}}return n.CLASSNAME="ShadowGenerator",n.FILTER_NONE=0,n.FILTER_EXPONENTIALSHADOWMAP=1,n.FILTER_POISSONSAMPLING=2,n.FILTER_BLUREXPONENTIALSHADOWMAP=3,n.FILTER_CLOSEEXPONENTIALSHADOWMAP=4,n.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5,n.FILTER_PCF=6,n.FILTER_PCSS=7,n.QUALITY_HIGH=0,n.QUALITY_MEDIUM=1,n.QUALITY_LOW=2,n.DEFAULT_ALPHA_CUTOFF=.5,n._SceneComponentInitialization=t=>{throw H("ShadowGeneratorSceneComponent")},n})(),zo="depthPixelShader",Xo=`#ifdef ALPHATEST
varying vec2 vUV;
uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
varying float vDepthMetric;
#ifdef PACKED
#include<packingFunctions>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
#ifdef NONLINEARDEPTH
#ifdef PACKED
gl_FragColor=pack(gl_FragCoord.z);
#else
gl_FragColor=vec4(gl_FragCoord.z,0.0,0.0,0.0);
#endif
#else
#ifdef PACKED
gl_FragColor=pack(vDepthMetric);
#else
gl_FragColor=vec4(vDepthMetric,0.0,0.0,1.0);
#endif
#endif
}`;w.ShadersStore[zo]=Xo;var Ho="instancesDeclaration",Ko=`#ifdef INSTANCES
attribute vec4 world0;
attribute vec4 world1;
attribute vec4 world2;
attribute vec4 world3;
#ifdef INSTANCESCOLOR
attribute vec4 instanceColor;
#endif
#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
attribute vec4 previousWorld0;
attribute vec4 previousWorld1;
attribute vec4 previousWorld2;
attribute vec4 previousWorld3;
#ifdef THIN_INSTANCES
uniform mat4 previousWorld;
#endif
#endif
#else
#if !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
uniform mat4 previousWorld;
#endif
#endif
`;w.IncludesShadersStore[Ho]=Ko;var Yo="depthVertexShader",jo=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform mat4 viewProjection;
uniform vec2 depthValues;
#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;
uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
varying float vDepthMetric;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{
vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#include<clipPlaneVertex>
gl_Position=viewProjection*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric=((-gl_Position.z+depthValues.x)/(depthValues.y));
#else
vDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));
#endif
#if defined(ALPHATEST) || defined(BASIC_RENDER)
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
}
`;w.ShadersStore[Yo]=jo;var qo=(()=>{class n{constructor(e,i=1,s=null,r=!1,a=L.TRILINEAR_SAMPLINGMODE){this.enabled=!0,this.forceDepthWriteTransparentMeshes=!1,this.useOnlyInActiveCamera=!1,this._scene=e,this._storeNonLinearDepth=r,this.isPacked=i===0,this.isPacked?this._clearColor=new ie(1,1,1,1):this._clearColor=new ie(1,0,0,1),n._SceneComponentInitialization(this._scene);let o=e.getEngine();this._camera=s,a!==L.NEAREST_SAMPLINGMODE&&(i===1&&!o._caps.textureFloatLinearFiltering&&(a=L.NEAREST_SAMPLINGMODE),i===2&&!o._caps.textureHalfFloatLinearFiltering&&(a=L.NEAREST_SAMPLINGMODE));let h=this.isPacked||!o._features.supportExtendedTextureFormats?5:6;this._depthMap=new li("DepthRenderer",{width:o.getRenderWidth(),height:o.getRenderHeight()},this._scene,!1,!0,i,!1,a,void 0,void 0,void 0,h),this._depthMap.wrapU=L.CLAMP_ADDRESSMODE,this._depthMap.wrapV=L.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=!0,this._depthMap.useCameraPostProcesses=!1,this._depthMap.onClearObservable.add(c=>{c.clear(this._clearColor,!0,!0,!0)}),this._depthMap.onBeforeBindObservable.add(()=>{var c;(c=o._debugPushGroup)===null||c===void 0||c.call(o,"depth renderer",1)}),this._depthMap.onAfterUnbindObservable.add(()=>{var c;(c=o._debugPopGroup)===null||c===void 0||c.call(o,1)}),this._depthMap.customIsReadyFunction=(c,d,u)=>{if((u||d===0)&&c.subMeshes)for(let f=0;f<c.subMeshes.length;++f){let _=c.subMeshes[f],g=_.getRenderingMesh(),p=g._getInstancesRenderList(_._id,!!_.getReplacementMesh()),E=o.getCaps().instancedArrays&&(p.visibleInstances[_._id]!==null&&p.visibleInstances[_._id]!==void 0||g.hasThinInstances);if(!this.isReady(_,E))return!1}return!0};let l=c=>{var d,u;let f=c.getRenderingMesh(),_=c.getEffectiveMesh(),g=this._scene,p=g.getEngine(),E=c.getMaterial();if(_._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!E||_.infiniteDistance||E.disableDepthWrite||c.verticesCount===0||c._renderId===g.getRenderId())return;let T=_._getWorldMatrixDeterminant()<0,R=(d=f.overrideMaterialSideOrientation)!==null&&d!==void 0?d:E.sideOrientation;T&&(R=R===0?1:0);let y=R===0;p.setState(E.backFaceCulling,0,!1,y,E.cullBackFaces);let M=f._getInstancesRenderList(c._id,!!c.getReplacementMesh());if(M.mustReturn)return;let b=p.getCaps().instancedArrays&&(M.visibleInstances[c._id]!==null&&M.visibleInstances[c._id]!==void 0||f.hasThinInstances),x=this._camera||g.activeCamera;if(this.isReady(c,b)&&x){c._renderId=g.getRenderId();let F=(u=_._internalAbstractMeshDataInfo._materialForRenderPass)===null||u===void 0?void 0:u[p.currentRenderPassId],I=c._getDrawWrapper();!I&&F&&(I=F._getDrawWrapper());let N=x.mode===ne.ORTHOGRAPHIC_CAMERA;if(!I)return;let G=I.effect;p.enableEffect(I),b||f._bind(c,G,E.fillMode),F?F.bindForSubMesh(_.getWorldMatrix(),_,c):(G.setMatrix("viewProjection",g.getTransformMatrix()),G.setMatrix("world",_.getWorldMatrix()));let Y,q;if(N?(Y=!p.useReverseDepthBuffer&&p.isNDCHalfZRange?0:1,q=p.useReverseDepthBuffer&&p.isNDCHalfZRange?0:1):(Y=p.useReverseDepthBuffer&&p.isNDCHalfZRange?x.minZ:p.isNDCHalfZRange?0:x.minZ,q=p.useReverseDepthBuffer&&p.isNDCHalfZRange?0:x.maxZ),G.setFloat2("depthValues",Y,Y+q),!F){if(E.needAlphaTesting()){let j=E.getAlphaTestTexture();j&&(G.setTexture("diffuseSampler",j),G.setMatrix("diffuseMatrix",j.getTextureMatrix()))}if(f.useBones&&f.computeBonesUsingShaders&&f.skeleton){let j=f.skeleton;if(j.isUsingTextureForMatrices){let $=j.getTransformMatrixTexture(f);if(!$)return;G.setTexture("boneSampler",$),G.setFloat("boneTextureWidth",4*(j.bones.length+1))}else G.setMatrices("mBones",j.getTransformMatrices(f))}Ms(G,E,g),K.BindMorphTargetParameters(f,G),f.morphTargetManager&&f.morphTargetManager.isUsingTextureForTargets&&f.morphTargetManager._bind(G)}f._processRendering(_,c,G,E.fillMode,M,b,(j,$)=>G.setMatrix("world",$))}};this._depthMap.customRenderFunction=(c,d,u,f)=>{let _;if(f.length)for(_=0;_<f.length;_++)l(f.data[_]);for(_=0;_<c.length;_++)l(c.data[_]);for(_=0;_<d.length;_++)l(d.data[_]);if(this.forceDepthWriteTransparentMeshes)for(_=0;_<u.length;_++)l(u.data[_]);else for(_=0;_<u.length;_++)u.data[_].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}}setMaterialForRendering(e,i){this._depthMap.setMaterialForRendering(e,i)}isReady(e,i){var s;let r=this._scene.getEngine(),a=e.getMesh(),o=a.getScene(),h=(s=a._internalAbstractMeshDataInfo._materialForRenderPass)===null||s===void 0?void 0:s[r.currentRenderPassId];if(h)return h.isReadyForSubMesh(a,e,i);let l=e.getMaterial();if(!l||l.disableDepthWrite)return!1;let c=[],d=[m.PositionKind];if(l&&l.needAlphaTesting()&&l.getAlphaTestTexture()&&(c.push("#define ALPHATEST"),a.isVerticesDataPresent(m.UVKind)&&(d.push(m.UVKind),c.push("#define UV1")),a.isVerticesDataPresent(m.UV2Kind)&&(d.push(m.UV2Kind),c.push("#define UV2"))),a.useBones&&a.computeBonesUsingShaders){d.push(m.MatricesIndicesKind),d.push(m.MatricesWeightsKind),a.numBoneInfluencers>4&&(d.push(m.MatricesIndicesExtraKind),d.push(m.MatricesWeightsExtraKind)),c.push("#define NUM_BONE_INFLUENCERS "+a.numBoneInfluencers),c.push("#define BonesPerMesh "+(a.skeleton?a.skeleton.bones.length+1:0));let E=e.getRenderingMesh().skeleton;E!=null&&E.isUsingTextureForMatrices&&c.push("#define BONETEXTURE")}else c.push("#define NUM_BONE_INFLUENCERS 0");let u=a.morphTargetManager,f=0;u&&u.numInfluencers>0&&(f=u.numInfluencers,c.push("#define MORPHTARGETS"),c.push("#define NUM_MORPH_INFLUENCERS "+f),u.isUsingTextureForTargets&&c.push("#define MORPHTARGETS_TEXTURE"),K.PrepareAttributesForMorphTargetsInfluencers(d,a,f)),i&&(c.push("#define INSTANCES"),K.PushAttributesForInstances(d),e.getRenderingMesh().hasThinInstances&&c.push("#define THIN_INSTANCES")),this._storeNonLinearDepth&&c.push("#define NONLINEARDEPTH"),this.isPacked&&c.push("#define PACKED"),$r(l,o,c);let _=e._getDrawWrapper(void 0,!0),g=_.defines,p=c.join(`
`);if(g!==p){let E=["world","mBones","boneTextureWidth","viewProjection","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"];xs(E),_.setEffect(r.createEffect("depth",d,E,["diffuseSampler","morphTargets","boneSampler"],p,void 0,void 0,void 0,{maxSimultaneousMorphTargets:f}),p)}return _.effect.isReady()}getDepthMap(){return this._depthMap}dispose(){let e=[];for(let i in this._scene._depthRenderer)this._scene._depthRenderer[i]===this&&e.push(i);if(e.length>0){this._depthMap.dispose();for(let i of e)delete this._scene._depthRenderer[i]}}}return n._SceneComponentInitialization=t=>{throw H("DepthRendererSceneComponent")},n})(),Zo="minmaxReduxPixelShader",Qo=`varying vec2 vUV;
uniform sampler2D textureSampler;
#if defined(INITIAL)
uniform sampler2D sourceTexture;
uniform vec2 texSize;
void main(void)
{
ivec2 coord=ivec2(vUV*(texSize-1.0));
float f1=texelFetch(sourceTexture,coord,0).r;
float f2=texelFetch(sourceTexture,coord+ivec2(1,0),0).r;
float f3=texelFetch(sourceTexture,coord+ivec2(1,1),0).r;
float f4=texelFetch(sourceTexture,coord+ivec2(0,1),0).r;
float minz=min(min(min(f1,f2),f3),f4);
#ifdef DEPTH_REDUX
float maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);
#else
float maxz=max(max(max(f1,f2),f3),f4);
#endif
glFragColor=vec4(minz,maxz,0.,0.);
}
#elif defined(MAIN)
uniform vec2 texSize;
void main(void)
{
ivec2 coord=ivec2(vUV*(texSize-1.0));
vec2 f1=texelFetch(textureSampler,coord,0).rg;
vec2 f2=texelFetch(textureSampler,coord+ivec2(1,0),0).rg;
vec2 f3=texelFetch(textureSampler,coord+ivec2(1,1),0).rg;
vec2 f4=texelFetch(textureSampler,coord+ivec2(0,1),0).rg;
float minz=min(min(min(f1.x,f2.x),f3.x),f4.x);
float maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);
glFragColor=vec4(minz,maxz,0.,0.);
}
#elif defined(ONEBEFORELAST)
uniform ivec2 texSize;
void main(void)
{
ivec2 coord=ivec2(vUV*vec2(texSize-1));
vec2 f1=texelFetch(textureSampler,coord % texSize,0).rg;
vec2 f2=texelFetch(textureSampler,(coord+ivec2(1,0)) % texSize,0).rg;
vec2 f3=texelFetch(textureSampler,(coord+ivec2(1,1)) % texSize,0).rg;
vec2 f4=texelFetch(textureSampler,(coord+ivec2(0,1)) % texSize,0).rg;
float minz=min(f1.x,f2.x);
float maxz=max(f1.y,f2.y);
glFragColor=vec4(minz,maxz,0.,0.);
}
#elif defined(LAST)
void main(void)
{
glFragColor=vec4(0.);
if (true) { 
discard;
}
}
#endif
`;w.ShadersStore[Zo]=Qo;var Dr=class{constructor(t){this.onAfterReductionPerformed=new D,this._forceFullscreenViewport=!0,this._activated=!1,this._camera=t,this._postProcessManager=new ui(t.getScene()),this._onContextRestoredObserver=t.getEngine().onContextRestoredObservable.add(()=>{this._postProcessManager._rebuild()})}get sourceTexture(){return this._sourceTexture}setSourceTexture(t,e,i=2,s=!0){if(t===this._sourceTexture)return;this.dispose(!1),this._sourceTexture=t,this._reductionSteps=[],this._forceFullscreenViewport=s;let r=this._camera.getScene(),a=new Ce("Initial reduction phase","minmaxRedux",["texSize"],["sourceTexture"],1,null,1,r.getEngine(),!1,"#define INITIAL"+(e?`
#define DEPTH_REDUX`:""),i,void 0,void 0,void 0,7);a.autoClear=!1,a.forceFullscreenViewport=s;let o=this._sourceTexture.getRenderWidth(),h=this._sourceTexture.getRenderHeight();a.onApply=((c,d)=>u=>{u.setTexture("sourceTexture",this._sourceTexture),u.setFloat2("texSize",c,d)})(o,h),this._reductionSteps.push(a);let l=1;for(;o>1||h>1;){o=Math.max(Math.round(o/2),1),h=Math.max(Math.round(h/2),1);let c=new Ce("Reduction phase "+l,"minmaxRedux",["texSize"],null,{width:o,height:h},null,1,r.getEngine(),!1,"#define "+(o==1&&h==1?"LAST":o==1||h==1?"ONEBEFORELAST":"MAIN"),i,void 0,void 0,void 0,7);if(c.autoClear=!1,c.forceFullscreenViewport=s,c.onApply=((d,u)=>f=>{d==1||u==1?f.setInt2("texSize",d,u):f.setFloat2("texSize",d,u)})(o,h),this._reductionSteps.push(c),l++,o==1&&h==1){let d=(u,f,_)=>{let g=new Float32Array(4*u*f),p={min:0,max:0};return()=>{r.getEngine()._readTexturePixels(_.inputTexture.texture,u,f,-1,0,g,!1),p.min=g[0],p.max=g[1],this.onAfterReductionPerformed.notifyObservers(p)}};c.onAfterRenderObservable.add(d(o,h,c))}}}get refreshRate(){return this._sourceTexture?this._sourceTexture.refreshRate:-1}set refreshRate(t){this._sourceTexture&&(this._sourceTexture.refreshRate=t)}get activated(){return this._activated}activate(){this._onAfterUnbindObserver||!this._sourceTexture||(this._onAfterUnbindObserver=this._sourceTexture.onAfterUnbindObservable.add(()=>{var t,e;let i=this._camera.getScene().getEngine();(t=i._debugPushGroup)===null||t===void 0||t.call(i,"min max reduction",1),this._reductionSteps[0].activate(this._camera),this._postProcessManager.directRender(this._reductionSteps,this._reductionSteps[0].inputTexture,this._forceFullscreenViewport),i.unBindFramebuffer(this._reductionSteps[0].inputTexture,!1),(e=i._debugPopGroup)===null||e===void 0||e.call(i,1)}),this._activated=!0)}deactivate(){!this._onAfterUnbindObserver||!this._sourceTexture||(this._sourceTexture.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=null,this._activated=!1)}dispose(t=!0){if(t&&(this.onAfterReductionPerformed.clear(),this._onContextRestoredObserver&&(this._camera.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)),this.deactivate(),this._reductionSteps){for(let e=0;e<this._reductionSteps.length;++e)this._reductionSteps[e].dispose();this._reductionSteps=null}this._postProcessManager&&t&&this._postProcessManager.dispose(),this._sourceTexture=null}},Fr=class extends Dr{constructor(t){super(t)}get depthRenderer(){return this._depthRenderer}setDepthRenderer(t=null,e=2,i=!0){let s=this._camera.getScene();this._depthRenderer&&(delete s._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null),t===null&&(s._depthRenderer||(s._depthRenderer={}),t=this._depthRenderer=new qo(s,e,this._camera,!1,1),t.enabled=!1,this._depthRendererId="minmax"+this._camera.id,s._depthRenderer[this._depthRendererId]=t),super.setSourceTexture(t.getDepthMap(),!0,e,i)}setSourceTexture(t,e,i=2,s=!0){super.setSourceTexture(t,e,i,s)}activate(){this._depthRenderer&&(this._depthRenderer.enabled=!0),super.activate()}deactivate(){super.deactivate(),this._depthRenderer&&(this._depthRenderer.enabled=!1)}dispose(t=!0){if(super.dispose(t),this._depthRenderer&&t){let e=this._depthRenderer.getDepthMap().getScene();e&&delete e._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null}}},pn=v.Up(),$o=v.Zero(),be=new v,ii=new v,qi=new P,vt=class n extends qe{constructor(t,e,i,s){if(!n.IsSupported){O.Error("CascadedShadowMap is not supported by the current engine.");return}super(t,e,i,s),this.usePercentageCloserFiltering=!0}_validateFilter(t){return t===qe.FILTER_NONE||t===qe.FILTER_PCF||t===qe.FILTER_PCSS?t:(console.error('Unsupported filter "'+t+'"!'),qe.FILTER_NONE)}get numCascades(){return this._numCascades}set numCascades(t){t=Math.min(Math.max(t,n.MIN_CASCADES_COUNT),n.MAX_CASCADES_COUNT),t!==this._numCascades&&(this._numCascades=t,this.recreateShadowMap(),this._recreateSceneUBOs())}get freezeShadowCastersBoundingInfo(){return this._freezeShadowCastersBoundingInfo}set freezeShadowCastersBoundingInfo(t){this._freezeShadowCastersBoundingInfoObservable&&t&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),!this._freezeShadowCastersBoundingInfoObservable&&!t&&(this._freezeShadowCastersBoundingInfoObservable=this._scene.onBeforeRenderObservable.add(this._computeShadowCastersBoundingInfo.bind(this))),this._freezeShadowCastersBoundingInfo=t,t&&this._computeShadowCastersBoundingInfo()}_computeShadowCastersBoundingInfo(){if(this._scbiMin.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._scbiMax.copyFromFloats(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),this._shadowMap&&this._shadowMap.renderList){let t=this._shadowMap.renderList;for(let i=0;i<t.length;i++){let s=t[i];if(!s)continue;let r=s.getBoundingInfo(),a=r.boundingBox;this._scbiMin.minimizeInPlace(a.minimumWorld),this._scbiMax.maximizeInPlace(a.maximumWorld)}let e=this._scene.meshes;for(let i=0;i<e.length;i++){let s=e[i];if(!s||!s.isVisible||!s.isEnabled||!s.receiveShadows)continue;let r=s.getBoundingInfo(),a=r.boundingBox;this._scbiMin.minimizeInPlace(a.minimumWorld),this._scbiMax.maximizeInPlace(a.maximumWorld)}}this._shadowCastersBoundingInfo.reConstruct(this._scbiMin,this._scbiMax)}get shadowCastersBoundingInfo(){return this._shadowCastersBoundingInfo}set shadowCastersBoundingInfo(t){this._shadowCastersBoundingInfo=t}setMinMaxDistance(t,e){this._minDistance===t&&this._maxDistance===e||(t>e&&(t=0,e=1),t<0&&(t=0),e>1&&(e=1),this._minDistance=t,this._maxDistance=e,this._breaksAreDirty=!0)}get minDistance(){return this._minDistance}get maxDistance(){return this._maxDistance}getClassName(){return n.CLASSNAME}getCascadeMinExtents(t){return t>=0&&t<this._numCascades?this._cascadeMinExtents[t]:null}getCascadeMaxExtents(t){return t>=0&&t<this._numCascades?this._cascadeMaxExtents[t]:null}get shadowMaxZ(){return this._getCamera()?this._shadowMaxZ:0}set shadowMaxZ(t){let e=this._getCamera();if(!e){this._shadowMaxZ=t;return}this._shadowMaxZ===t||t<e.minZ||t>e.maxZ||(this._shadowMaxZ=t,this._light._markMeshesAsLightDirty(),this._breaksAreDirty=!0)}get debug(){return this._debug}set debug(t){this._debug=t,this._light._markMeshesAsLightDirty()}get depthClamp(){return this._depthClamp}set depthClamp(t){this._depthClamp=t}get cascadeBlendPercentage(){return this._cascadeBlendPercentage}set cascadeBlendPercentage(t){this._cascadeBlendPercentage=t,this._light._markMeshesAsLightDirty()}get lambda(){return this._lambda}set lambda(t){let e=Math.min(Math.max(t,0),1);this._lambda!=e&&(this._lambda=e,this._breaksAreDirty=!0)}getCascadeViewMatrix(t){return t>=0&&t<this._numCascades?this._viewMatrices[t]:null}getCascadeProjectionMatrix(t){return t>=0&&t<this._numCascades?this._projectionMatrices[t]:null}getCascadeTransformMatrix(t){return t>=0&&t<this._numCascades?this._transformMatrices[t]:null}setDepthRenderer(t){this._depthRenderer=t,this._depthReducer&&this._depthReducer.setDepthRenderer(this._depthRenderer)}get autoCalcDepthBounds(){return this._autoCalcDepthBounds}set autoCalcDepthBounds(t){let e=this._getCamera();if(e){if(this._autoCalcDepthBounds=t,!t){this._depthReducer&&this._depthReducer.deactivate(),this.setMinMaxDistance(0,1);return}this._depthReducer||(this._depthReducer=new Fr(e),this._depthReducer.onAfterReductionPerformed.add(i=>{let s=i.min,r=i.max;s>=r&&(s=0,r=1),(s!=this._minDistance||r!=this._maxDistance)&&this.setMinMaxDistance(s,r)}),this._depthReducer.setDepthRenderer(this._depthRenderer)),this._depthReducer.activate()}}get autoCalcDepthBoundsRefreshRate(){var t,e,i;return(i=(e=(t=this._depthReducer)===null||t===void 0?void 0:t.depthRenderer)===null||e===void 0?void 0:e.getDepthMap().refreshRate)!==null&&i!==void 0?i:-1}set autoCalcDepthBoundsRefreshRate(t){var e;!((e=this._depthReducer)===null||e===void 0)&&e.depthRenderer&&(this._depthReducer.depthRenderer.getDepthMap().refreshRate=t)}splitFrustum(){this._breaksAreDirty=!0}_splitFrustum(){let t=this._getCamera();if(!t)return;let e=t.minZ,i=t.maxZ,s=i-e,r=this._minDistance,a=this._shadowMaxZ<i&&this._shadowMaxZ>=e?Math.min((this._shadowMaxZ-e)/(i-e),this._maxDistance):this._maxDistance,o=e+r*s,h=e+a*s,l=h-o,c=h/o;for(let d=0;d<this._cascades.length;++d){let u=(d+1)/this._numCascades,f=o*c**u,_=o+l*u,g=this._lambda*(f-_)+_;this._cascades[d].prevBreakDistance=d===0?r:this._cascades[d-1].breakDistance,this._cascades[d].breakDistance=(g-e)/s,this._viewSpaceFrustumsZ[d]=g,this._frustumLengths[d]=(this._cascades[d].breakDistance-this._cascades[d].prevBreakDistance)*s}this._breaksAreDirty=!1}_computeMatrices(){let t=this._scene;if(!this._getCamera())return;v.NormalizeToRef(this._light.getShadowDirection(0),this._lightDirection),Math.abs(v.Dot(this._lightDirection,v.Up()))===1&&(this._lightDirection.z=1e-13),this._cachedDirection.copyFrom(this._lightDirection);let e=t.getEngine().useReverseDepthBuffer;for(let i=0;i<this._numCascades;++i){this._computeFrustumInWorldSpace(i),this._computeCascadeFrustum(i),this._cascadeMaxExtents[i].subtractToRef(this._cascadeMinExtents[i],be),this._frustumCenter[i].addToRef(this._lightDirection.scale(this._cascadeMinExtents[i].z),this._shadowCameraPos[i]),P.LookAtLHToRef(this._shadowCameraPos[i],this._frustumCenter[i],pn,this._viewMatrices[i]);let s=0,r=be.z,a=this._shadowCastersBoundingInfo;a.update(this._viewMatrices[i]),r=Math.min(r,a.boundingBox.maximumWorld.z),!this._depthClamp||this.filter===qe.FILTER_PCSS?s=Math.min(s,a.boundingBox.minimumWorld.z):s=Math.max(s,a.boundingBox.minimumWorld.z),P.OrthoOffCenterLHToRef(this._cascadeMinExtents[i].x,this._cascadeMaxExtents[i].x,this._cascadeMinExtents[i].y,this._cascadeMaxExtents[i].y,e?r:s,e?s:r,this._projectionMatrices[i],t.getEngine().isNDCHalfZRange),this._cascadeMinExtents[i].z=s,this._cascadeMaxExtents[i].z=r,this._viewMatrices[i].multiplyToRef(this._projectionMatrices[i],this._transformMatrices[i]),v.TransformCoordinatesToRef($o,this._transformMatrices[i],be),be.scaleInPlace(this._mapSize/2),ii.copyFromFloats(Math.round(be.x),Math.round(be.y),Math.round(be.z)),ii.subtractInPlace(be).scaleInPlace(2/this._mapSize),P.TranslationToRef(ii.x,ii.y,0,qi),this._projectionMatrices[i].multiplyToRef(qi,this._projectionMatrices[i]),this._viewMatrices[i].multiplyToRef(this._projectionMatrices[i],this._transformMatrices[i]),this._transformMatrices[i].copyToArray(this._transformMatricesAsArray,i*16)}}_computeFrustumInWorldSpace(t){let e=this._getCamera();if(!e)return;let i=this._cascades[t].prevBreakDistance,s=this._cascades[t].breakDistance,r=this._scene.getEngine().isNDCHalfZRange;e.getViewMatrix();let a=P.Invert(e.getTransformationMatrix()),o=this._scene.getEngine().useReverseDepthBuffer?4:0;for(let h=0;h<n._FrustumCornersNDCSpace.length;++h)be.copyFrom(n._FrustumCornersNDCSpace[(h+o)%n._FrustumCornersNDCSpace.length]),r&&be.z===-1&&(be.z=0),v.TransformCoordinatesToRef(be,a,this._frustumCornersWorldSpace[t][h]);for(let h=0;h<n._FrustumCornersNDCSpace.length/2;++h)be.copyFrom(this._frustumCornersWorldSpace[t][h+4]).subtractInPlace(this._frustumCornersWorldSpace[t][h]),ii.copyFrom(be).scaleInPlace(i),be.scaleInPlace(s),be.addInPlace(this._frustumCornersWorldSpace[t][h]),this._frustumCornersWorldSpace[t][h+4].copyFrom(be),this._frustumCornersWorldSpace[t][h].addInPlace(ii)}_computeCascadeFrustum(t){if(this._cascadeMinExtents[t].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cascadeMaxExtents[t].copyFromFloats(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),this._frustumCenter[t].copyFromFloats(0,0,0),!!this._getCamera()){for(let e=0;e<this._frustumCornersWorldSpace[t].length;++e)this._frustumCenter[t].addInPlace(this._frustumCornersWorldSpace[t][e]);if(this._frustumCenter[t].scaleInPlace(1/this._frustumCornersWorldSpace[t].length),this.stabilizeCascades){let e=0;for(let i=0;i<this._frustumCornersWorldSpace[t].length;++i){let s=this._frustumCornersWorldSpace[t][i].subtractToRef(this._frustumCenter[t],be).length();e=Math.max(e,s)}e=Math.ceil(e*16)/16,this._cascadeMaxExtents[t].copyFromFloats(e,e,e),this._cascadeMinExtents[t].copyFromFloats(-e,-e,-e)}else{let e=this._frustumCenter[t];this._frustumCenter[t].addToRef(this._lightDirection,be),P.LookAtLHToRef(e,be,pn,qi);for(let i=0;i<this._frustumCornersWorldSpace[t].length;++i)v.TransformCoordinatesToRef(this._frustumCornersWorldSpace[t][i],qi,be),this._cascadeMinExtents[t].minimizeInPlace(be),this._cascadeMaxExtents[t].maximizeInPlace(be)}}}_recreateSceneUBOs(){if(this._disposeSceneUBOs(),this._sceneUBOs)for(let t=0;t<this._numCascades;++t)this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for CSM Shadow Generator (light "${this._light.name}" cascade #${t})`))}static get IsSupported(){let t=Q.LastCreatedEngine;return t?t._features.supportCSM:!1}_initializeGenerator(){var t,e,i,s,r,a,o,h,l,c,d,u,f,_,g,p,E,T,R,y;this.penumbraDarkness=(t=this.penumbraDarkness)!==null&&t!==void 0?t:1,this._numCascades=(e=this._numCascades)!==null&&e!==void 0?e:n.DEFAULT_CASCADES_COUNT,this.stabilizeCascades=(i=this.stabilizeCascades)!==null&&i!==void 0?i:!1,this._freezeShadowCastersBoundingInfoObservable=(s=this._freezeShadowCastersBoundingInfoObservable)!==null&&s!==void 0?s:null,this.freezeShadowCastersBoundingInfo=(r=this.freezeShadowCastersBoundingInfo)!==null&&r!==void 0?r:!1,this._scbiMin=(a=this._scbiMin)!==null&&a!==void 0?a:new v(0,0,0),this._scbiMax=(o=this._scbiMax)!==null&&o!==void 0?o:new v(0,0,0),this._shadowCastersBoundingInfo=(h=this._shadowCastersBoundingInfo)!==null&&h!==void 0?h:new ht(new v(0,0,0),new v(0,0,0)),this._breaksAreDirty=(l=this._breaksAreDirty)!==null&&l!==void 0?l:!0,this._minDistance=(c=this._minDistance)!==null&&c!==void 0?c:0,this._maxDistance=(d=this._maxDistance)!==null&&d!==void 0?d:1,this._currentLayer=(u=this._currentLayer)!==null&&u!==void 0?u:0,this._shadowMaxZ=(g=(f=this._shadowMaxZ)!==null&&f!==void 0?f:(_=this._getCamera())===null||_===void 0?void 0:_.maxZ)!==null&&g!==void 0?g:1e4,this._debug=(p=this._debug)!==null&&p!==void 0?p:!1,this._depthClamp=(E=this._depthClamp)!==null&&E!==void 0?E:!0,this._cascadeBlendPercentage=(T=this._cascadeBlendPercentage)!==null&&T!==void 0?T:.1,this._lambda=(R=this._lambda)!==null&&R!==void 0?R:.5,this._autoCalcDepthBounds=(y=this._autoCalcDepthBounds)!==null&&y!==void 0?y:!1,this._recreateSceneUBOs(),super._initializeGenerator()}_createTargetRenderTexture(){let t=this._scene.getEngine(),e={width:this._mapSize,height:this._mapSize,layers:this.numCascades};this._shadowMap=new li(this._light.name+"_CSMShadowMap",e,this._scene,!1,!0,this._textureType,!1,void 0,!1,!1,void 0),this._shadowMap.createDepthStencilTexture(t.useReverseDepthBuffer?516:513,!0)}_initializeShadowMap(){if(super._initializeShadowMap(),this._shadowMap===null)return;this._transformMatricesAsArray=new Float32Array(this._numCascades*16),this._viewSpaceFrustumsZ=new Array(this._numCascades),this._frustumLengths=new Array(this._numCascades),this._lightSizeUVCorrection=new Array(this._numCascades*2),this._depthCorrection=new Array(this._numCascades),this._cascades=[],this._viewMatrices=[],this._projectionMatrices=[],this._transformMatrices=[],this._cascadeMinExtents=[],this._cascadeMaxExtents=[],this._frustumCenter=[],this._shadowCameraPos=[],this._frustumCornersWorldSpace=[];for(let e=0;e<this._numCascades;++e){this._cascades[e]={prevBreakDistance:0,breakDistance:0},this._viewMatrices[e]=P.Zero(),this._projectionMatrices[e]=P.Zero(),this._transformMatrices[e]=P.Zero(),this._cascadeMinExtents[e]=new v,this._cascadeMaxExtents[e]=new v,this._frustumCenter[e]=new v,this._shadowCameraPos[e]=new v,this._frustumCornersWorldSpace[e]=new Array(n._FrustumCornersNDCSpace.length);for(let i=0;i<n._FrustumCornersNDCSpace.length;++i)this._frustumCornersWorldSpace[e][i]=new v}let t=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.clear(),this._shadowMap.onBeforeRenderObservable.clear(),this._shadowMap.onBeforeRenderObservable.add(e=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[e]),this._currentLayer=e,this._filter===qe.FILTER_PCF&&t.setColorWrite(!1),this._scene.setTransformMatrix(this.getCascadeViewMatrix(e),this.getCascadeProjectionMatrix(e)),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onBeforeBindObservable.add(()=>{var e;this._currentSceneUBO=this._scene.getSceneUniformBuffer(),(e=t._debugPushGroup)===null||e===void 0||e.call(t,`cascaded shadow map generation for pass id ${t.currentRenderPassId}`,1),this._breaksAreDirty&&this._splitFrustum(),this._computeMatrices()}),this._splitFrustum()}_bindCustomEffectForRenderSubMeshForShadowMap(t,e){e.setMatrix("viewProjection",this.getCascadeTransformMatrix(this._currentLayer))}_isReadyCustomDefines(t){t.push("#define SM_DEPTHCLAMP "+(this._depthClamp&&this._filter!==qe.FILTER_PCSS?"1":"0"))}prepareDefines(t,e){super.prepareDefines(t,e);let i=this._scene,s=this._light;if(!i.shadowsEnabled||!s.shadowEnabled)return;t["SHADOWCSM"+e]=!0,t["SHADOWCSMDEBUG"+e]=this.debug,t["SHADOWCSMNUM_CASCADES"+e]=this.numCascades,t["SHADOWCSM_RIGHTHANDED"+e]=i.useRightHandedSystem;let r=this._getCamera();r&&this._shadowMaxZ<r.maxZ&&(t["SHADOWCSMUSESHADOWMAXZ"+e]=!0),this.cascadeBlendPercentage===0&&(t["SHADOWCSMNOBLEND"+e]=!0)}bindShadowLight(t,e){let i=this._light;if(!this._scene.shadowsEnabled||!i.shadowEnabled)return;let s=this._getCamera();if(!s)return;let r=this.getShadowMap();if(!r)return;let a=r.getSize().width;if(e.setMatrices("lightMatrix"+t,this._transformMatricesAsArray),e.setArray("viewFrustumZ"+t,this._viewSpaceFrustumsZ),e.setFloat("cascadeBlendFactor"+t,this.cascadeBlendPercentage===0?1e4:1/this.cascadeBlendPercentage),e.setArray("frustumLengths"+t,this._frustumLengths),this._filter===qe.FILTER_PCF)e.setDepthStencilTexture("shadowSampler"+t,r),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),a,1/a,this.frustumEdgeFalloff,t);else if(this._filter===qe.FILTER_PCSS){for(let o=0;o<this._numCascades;++o)this._lightSizeUVCorrection[o*2+0]=o===0?1:(this._cascadeMaxExtents[0].x-this._cascadeMinExtents[0].x)/(this._cascadeMaxExtents[o].x-this._cascadeMinExtents[o].x),this._lightSizeUVCorrection[o*2+1]=o===0?1:(this._cascadeMaxExtents[0].y-this._cascadeMinExtents[0].y)/(this._cascadeMaxExtents[o].y-this._cascadeMinExtents[o].y),this._depthCorrection[o]=o===0?1:(this._cascadeMaxExtents[o].z-this._cascadeMinExtents[o].z)/(this._cascadeMaxExtents[0].z-this._cascadeMinExtents[0].z);e.setDepthStencilTexture("shadowSampler"+t,r),e.setTexture("depthSampler"+t,r),e.setArray2("lightSizeUVCorrection"+t,this._lightSizeUVCorrection),e.setArray("depthCorrection"+t,this._depthCorrection),e.setFloat("penumbraDarkness"+t,this.penumbraDarkness),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/a,this._contactHardeningLightSizeUVRatio*a,this.frustumEdgeFalloff,t)}else e.setTexture("shadowSampler"+t,r),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),a,1/a,this.frustumEdgeFalloff,t);i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(s),this.getLight().getDepthMinZ(s)+this.getLight().getDepthMaxZ(s),t)}getTransformMatrix(){return this.getCascadeTransformMatrix(0)}dispose(){super.dispose(),this._freezeShadowCastersBoundingInfoObservable&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._depthReducer&&(this._depthReducer.dispose(),this._depthReducer=null)}serialize(){let t=super.serialize(),e=this.getShadowMap();if(!e)return t;if(t.numCascades=this._numCascades,t.debug=this._debug,t.stabilizeCascades=this.stabilizeCascades,t.lambda=this._lambda,t.cascadeBlendPercentage=this.cascadeBlendPercentage,t.depthClamp=this._depthClamp,t.autoCalcDepthBounds=this.autoCalcDepthBounds,t.shadowMaxZ=this._shadowMaxZ,t.penumbraDarkness=this.penumbraDarkness,t.freezeShadowCastersBoundingInfo=this._freezeShadowCastersBoundingInfo,t.minDistance=this.minDistance,t.maxDistance=this.maxDistance,t.renderList=[],e.renderList)for(let i=0;i<e.renderList.length;i++){let s=e.renderList[i];t.renderList.push(s.id)}return t}static Parse(t,e){let i=qe.Parse(t,e,(s,r,a)=>new n(s,r,void 0,a));return t.numCascades!==void 0&&(i.numCascades=t.numCascades),t.debug!==void 0&&(i.debug=t.debug),t.stabilizeCascades!==void 0&&(i.stabilizeCascades=t.stabilizeCascades),t.lambda!==void 0&&(i.lambda=t.lambda),t.cascadeBlendPercentage!==void 0&&(i.cascadeBlendPercentage=t.cascadeBlendPercentage),t.depthClamp!==void 0&&(i.depthClamp=t.depthClamp),t.autoCalcDepthBounds!==void 0&&(i.autoCalcDepthBounds=t.autoCalcDepthBounds),t.shadowMaxZ!==void 0&&(i.shadowMaxZ=t.shadowMaxZ),t.penumbraDarkness!==void 0&&(i.penumbraDarkness=t.penumbraDarkness),t.freezeShadowCastersBoundingInfo!==void 0&&(i.freezeShadowCastersBoundingInfo=t.freezeShadowCastersBoundingInfo),t.minDistance!==void 0&&t.maxDistance!==void 0&&i.setMinMaxDistance(t.minDistance,t.maxDistance),i}};vt._FrustumCornersNDCSpace=[new v(-1,1,-1),new v(1,1,-1),new v(1,-1,-1),new v(-1,-1,-1),new v(-1,1,1),new v(1,1,1),new v(1,-1,1),new v(-1,-1,1)];vt.CLASSNAME="CascadedShadowGenerator";vt.DEFAULT_CASCADES_COUNT=4;vt.MIN_CASCADES_COUNT=2;vt.MAX_CASCADES_COUNT=4;vt._SceneComponentInitialization=n=>{throw H("ShadowGeneratorSceneComponent")};In.AddParser(fi.NAME_SHADOWGENERATOR,(n,t)=>{if(n.shadowGenerators!==void 0&&n.shadowGenerators!==null)for(let e=0,i=n.shadowGenerators.length;e<i;e++){let s=n.shadowGenerators[e];s.className===vt.CLASSNAME?vt.Parse(s,t):qe.Parse(s,t)}});var wr=class{constructor(t){this.name=fi.NAME_SHADOWGENERATOR,this.scene=t}register(){this.scene._gatherRenderTargetsStage.registerStep(fi.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)}rebuild(){}serialize(t){t.shadowGenerators=[];let e=this.scene.lights;for(let i of e){let s=i.getShadowGenerators();if(s){let r=s.values();for(let a=r.next();a.done!==!0;a=r.next()){let o=a.value;t.shadowGenerators.push(o.serialize())}}}}addFromContainer(t){}removeFromContainer(t,e){}dispose(){}_gatherRenderTargets(t){let e=this.scene;if(this.scene.shadowsEnabled)for(let i=0;i<e.lights.length;i++){let s=e.lights[i],r=s.getShadowGenerators();if(s.isEnabled()&&s.shadowEnabled&&r){let a=r.values();for(let o=a.next();o.done!==!0;o=a.next()){let h=o.value.getShadowMap();e.textures.indexOf(h)!==-1&&t.push(h)}}}}};qe._SceneComponentInitialization=n=>{let t=n._getComponent(fi.NAME_SHADOWGENERATOR);t||(t=new wr(n),n._addComponent(t))};var Jo={enableShadows:!0};function gn(n=Jo){let{enableShadows:t,shadowTransparency:e,intensity:i,scene:s}=n,r=new st("DirectionalLight",new v(-.3,-1,.4),s);r.position=new v(-50,65,-50),r.intensity=.65*i;let a=new mi("HemisphericLight",new v(1,1,0),s);return a.intensity=.4*i,t&&(r.shadowMinZ=1,r.shadowMaxZ=70,r.shadowGenerator=new qe(2048,r),r.shadowGenerator.useCloseExponentialShadowMap=!0,r.shadowGenerator.darkness=e),{directional:r,hemispheric:a}}function Nn(n){let t=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],e=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],i=[],s=[],r=n.width||n.size||1,a=n.height||n.size||1,o=n.depth||n.size||1,h=n.wrap||!1,l=n.topBaseAt===void 0?1:n.topBaseAt,c=n.bottomBaseAt===void 0?0:n.bottomBaseAt;l=(l+4)%4,c=(c+4)%4;let d=[2,0,3,1],u=[2,0,1,3],f=d[l],_=u[c],g=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(h){t=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],g=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];let b=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],x=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]],F=[17,18,19,16],I=[22,23,20,21];for(;f>0;)b.unshift(b.pop()),F.unshift(F.pop()),f--;for(;_>0;)x.unshift(x.pop()),I.unshift(I.pop()),_--;b=b.flat(),x=x.flat(),g=g.concat(b).concat(x),t.push(F[0],F[2],F[3],F[0],F[1],F[2]),t.push(I[0],I[2],I[3],I[0],I[1],I[2])}let p=[r/2,a/2,o/2];s=g.reduce((b,x,F)=>b.concat(x*p[F%3]),[]);let E=n.sideOrientation===0?0:n.sideOrientation||pe.DEFAULTSIDE,T=n.faceUV||new Array(6),R=n.faceColors,y=[];for(let b=0;b<6;b++)T[b]===void 0&&(T[b]=new it(0,0,1,1)),R&&R[b]===void 0&&(R[b]=new ie(1,1,1,1));for(let b=0;b<6;b++)if(i.push(T[b].z,tt.UseOpenGLOrientationForUV?1-T[b].w:T[b].w),i.push(T[b].x,tt.UseOpenGLOrientationForUV?1-T[b].w:T[b].w),i.push(T[b].x,tt.UseOpenGLOrientationForUV?1-T[b].y:T[b].y),i.push(T[b].z,tt.UseOpenGLOrientationForUV?1-T[b].y:T[b].y),R)for(let x=0;x<4;x++)y.push(R[b].r,R[b].g,R[b].b,R[b].a);pe._ComputeSides(E,s,t,e,i,n.frontUVs,n.backUVs);let M=new pe;if(M.indices=t,M.positions=s,M.normals=e,M.uvs=i,R){let b=E===pe.DOUBLESIDE?y.concat(y):y;M.colors=b}return M}function si(n,t={},e=null){let i=new W(n,e);return t.sideOrientation=W._GetDefaultSideOrientation(t.sideOrientation),i._originalBuilderSideOrientation=t.sideOrientation,Nn(t).applyToMesh(i,t.updatable),i}pe.CreateBox=Nn;W.CreateBox=(n,t,e=null,i,s)=>si(n,{size:t,sideOrientation:s,updatable:i},e);var Es=class{constructor(){this.previousWorldMatrices={},this.previousBones={}}static AddUniforms(t){t.push("previousWorld","previousViewProjection","mPreviousBones")}static AddSamplers(t){}bindForSubMesh(t,e,i,s,r){if(e.prePassRenderer&&e.prePassRenderer.enabled&&e.prePassRenderer.currentRTisSceneRT&&e.prePassRenderer.getIndex(2)!==-1){this.previousWorldMatrices[i.uniqueId]||(this.previousWorldMatrices[i.uniqueId]=s.clone()),this.previousViewProjection||(this.previousViewProjection=e.getTransformMatrix().clone(),this.currentViewProjection=e.getTransformMatrix().clone());let a=e.getEngine();this.currentViewProjection.updateFlag!==e.getTransformMatrix().updateFlag?(this._lastUpdateFrameId=a.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection),this.currentViewProjection.copyFrom(e.getTransformMatrix())):this._lastUpdateFrameId!==a.frameId&&(this._lastUpdateFrameId=a.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection)),t.setMatrix("previousWorld",this.previousWorldMatrices[i.uniqueId]),t.setMatrix("previousViewProjection",this.previousViewProjection),this.previousWorldMatrices[i.uniqueId]=s.clone()}}},Ts=class extends B{constructor(t,e,i=!0){super(t,e),this._normalMatrix=new P,this._storeEffectOnSubMeshes=i}getEffect(){return this._storeEffectOnSubMeshes?this._activeEffect:super.getEffect()}isReady(t,e){return t?!this._storeEffectOnSubMeshes||!t.subMeshes||t.subMeshes.length===0?!0:this.isReadyForSubMesh(t,t.subMeshes[0],e):!1}_isReadyForSubMesh(t){let e=t.materialDefines;return!!(!this.checkReadyOnEveryCall&&t.effect&&e&&e._renderId===this.getScene().getRenderId())}bindOnlyWorldMatrix(t){this._activeEffect.setMatrix("world",t)}bindOnlyNormalMatrix(t){this._activeEffect.setMatrix("normalMatrix",t)}bind(t,e){e&&this.bindForSubMesh(t,e,e.subMeshes[0])}_afterBind(t,e=null){super._afterBind(t,e),this.getScene()._cachedEffect=e,e&&(e._forceRebindOnNextCall=!1)}_mustRebind(t,e,i=1){return t.isCachedMaterialInvalid(this,e,i)}},fe=(()=>{class n{static get DiffuseTextureEnabled(){return this._DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){this._DiffuseTextureEnabled!==e&&(this._DiffuseTextureEnabled=e,de.MarkAllMaterialsAsDirty(1))}static get DetailTextureEnabled(){return this._DetailTextureEnabled}static set DetailTextureEnabled(e){this._DetailTextureEnabled!==e&&(this._DetailTextureEnabled=e,de.MarkAllMaterialsAsDirty(1))}static get AmbientTextureEnabled(){return this._AmbientTextureEnabled}static set AmbientTextureEnabled(e){this._AmbientTextureEnabled!==e&&(this._AmbientTextureEnabled=e,de.MarkAllMaterialsAsDirty(1))}static get OpacityTextureEnabled(){return this._OpacityTextureEnabled}static set OpacityTextureEnabled(e){this._OpacityTextureEnabled!==e&&(this._OpacityTextureEnabled=e,de.MarkAllMaterialsAsDirty(1))}static get ReflectionTextureEnabled(){return this._ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){this._ReflectionTextureEnabled!==e&&(this._ReflectionTextureEnabled=e,de.MarkAllMaterialsAsDirty(1))}static get EmissiveTextureEnabled(){return this._EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){this._EmissiveTextureEnabled!==e&&(this._EmissiveTextureEnabled=e,de.MarkAllMaterialsAsDirty(1))}static get SpecularTextureEnabled(){return this._SpecularTextureEnabled}static set SpecularTextureEnabled(e){this._SpecularTextureEnabled!==e&&(this._SpecularTextureEnabled=e,de.MarkAllMaterialsAsDirty(1))}static get BumpTextureEnabled(){return this._BumpTextureEnabled}static set BumpTextureEnabled(e){this._BumpTextureEnabled!==e&&(this._BumpTextureEnabled=e,de.MarkAllMaterialsAsDirty(1))}static get LightmapTextureEnabled(){return this._LightmapTextureEnabled}static set LightmapTextureEnabled(e){this._LightmapTextureEnabled!==e&&(this._LightmapTextureEnabled=e,de.MarkAllMaterialsAsDirty(1))}static get RefractionTextureEnabled(){return this._RefractionTextureEnabled}static set RefractionTextureEnabled(e){this._RefractionTextureEnabled!==e&&(this._RefractionTextureEnabled=e,de.MarkAllMaterialsAsDirty(1))}static get ColorGradingTextureEnabled(){return this._ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){this._ColorGradingTextureEnabled!==e&&(this._ColorGradingTextureEnabled=e,de.MarkAllMaterialsAsDirty(1))}static get FresnelEnabled(){return this._FresnelEnabled}static set FresnelEnabled(e){this._FresnelEnabled!==e&&(this._FresnelEnabled=e,de.MarkAllMaterialsAsDirty(4))}static get ClearCoatTextureEnabled(){return this._ClearCoatTextureEnabled}static set ClearCoatTextureEnabled(e){this._ClearCoatTextureEnabled!==e&&(this._ClearCoatTextureEnabled=e,de.MarkAllMaterialsAsDirty(1))}static get ClearCoatBumpTextureEnabled(){return this._ClearCoatBumpTextureEnabled}static set ClearCoatBumpTextureEnabled(e){this._ClearCoatBumpTextureEnabled!==e&&(this._ClearCoatBumpTextureEnabled=e,de.MarkAllMaterialsAsDirty(1))}static get ClearCoatTintTextureEnabled(){return this._ClearCoatTintTextureEnabled}static set ClearCoatTintTextureEnabled(e){this._ClearCoatTintTextureEnabled!==e&&(this._ClearCoatTintTextureEnabled=e,de.MarkAllMaterialsAsDirty(1))}static get SheenTextureEnabled(){return this._SheenTextureEnabled}static set SheenTextureEnabled(e){this._SheenTextureEnabled!==e&&(this._SheenTextureEnabled=e,de.MarkAllMaterialsAsDirty(1))}static get AnisotropicTextureEnabled(){return this._AnisotropicTextureEnabled}static set AnisotropicTextureEnabled(e){this._AnisotropicTextureEnabled!==e&&(this._AnisotropicTextureEnabled=e,de.MarkAllMaterialsAsDirty(1))}static get ThicknessTextureEnabled(){return this._ThicknessTextureEnabled}static set ThicknessTextureEnabled(e){this._ThicknessTextureEnabled!==e&&(this._ThicknessTextureEnabled=e,de.MarkAllMaterialsAsDirty(1))}static get RefractionIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set RefractionIntensityTextureEnabled(e){this._RefractionIntensityTextureEnabled!==e&&(this._RefractionIntensityTextureEnabled=e,de.MarkAllMaterialsAsDirty(1))}static get TranslucencyIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set TranslucencyIntensityTextureEnabled(e){this._TranslucencyIntensityTextureEnabled!==e&&(this._TranslucencyIntensityTextureEnabled=e,de.MarkAllMaterialsAsDirty(1))}static get IridescenceTextureEnabled(){return this._IridescenceTextureEnabled}static set IridescenceTextureEnabled(e){this._IridescenceTextureEnabled!==e&&(this._IridescenceTextureEnabled=e,de.MarkAllMaterialsAsDirty(1))}}return n._DiffuseTextureEnabled=!0,n._DetailTextureEnabled=!0,n._AmbientTextureEnabled=!0,n._OpacityTextureEnabled=!0,n._ReflectionTextureEnabled=!0,n._EmissiveTextureEnabled=!0,n._SpecularTextureEnabled=!0,n._BumpTextureEnabled=!0,n._LightmapTextureEnabled=!0,n._RefractionTextureEnabled=!0,n._ColorGradingTextureEnabled=!0,n._FresnelEnabled=!0,n._ClearCoatTextureEnabled=!0,n._ClearCoatBumpTextureEnabled=!0,n._ClearCoatTintTextureEnabled=!0,n._SheenTextureEnabled=!0,n._AnisotropicTextureEnabled=!0,n._ThicknessTextureEnabled=!0,n._RefractionIntensityTextureEnabled=!0,n._TranslucencyIntensityTextureEnabled=!0,n._IridescenceTextureEnabled=!0,n})(),eh="defaultFragmentDeclaration",th=`uniform vec4 vEyePosition;
uniform vec4 vDiffuseColor;
#ifdef SPECULARTERM
uniform vec4 vSpecularColor;
#endif
uniform vec3 vEmissiveColor;
uniform vec3 vAmbientColor;
uniform float visibility;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY 
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform vec2 vTangentSpaceParams;
#endif
#ifdef ALPHATEST
uniform float alphaCutOff;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFRACTION
uniform vec4 vRefractionInfos;
#ifndef REFRACTIONMAP_3D
uniform mat4 refractionMatrix;
#endif
#ifdef REFRACTIONFRESNEL
uniform vec4 refractionLeftColor;
uniform vec4 refractionRightColor;
#endif
#if defined(USE_LOCAL_REFRACTIONMAP_CUBIC) && defined(REFRACTIONMAP_3D)
uniform vec3 vRefractionPosition;
uniform vec3 vRefractionSize; 
#endif
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;
#endif
#ifdef DIFFUSEFRESNEL
uniform vec4 diffuseLeftColor;
uniform vec4 diffuseRightColor;
#endif
#ifdef OPACITYFRESNEL
uniform vec4 opacityParts;
#endif
#ifdef EMISSIVEFRESNEL
uniform vec4 emissiveLeftColor;
uniform vec4 emissiveRightColor;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION) || defined(REFLECTIONMAP_EQUIRECTANGULAR) || defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_SKYBOX)
uniform mat4 reflectionMatrix;
#endif
#ifndef REFLECTIONMAP_SKYBOX
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;
uniform vec3 vReflectionSize; 
#endif
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 reflectionLeftColor;
uniform vec4 reflectionRightColor;
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#define ADDITIONAL_FRAGMENT_DECLARATION
`;w.IncludesShadersStore[eh]=th;var ih="defaultUboDeclaration",sh=`layout(std140,column_major) uniform;
uniform Material
{
vec4 diffuseLeftColor;
vec4 diffuseRightColor;
vec4 opacityParts;
vec4 reflectionLeftColor;
vec4 reflectionRightColor;
vec4 refractionLeftColor;
vec4 refractionRightColor;
vec4 emissiveLeftColor;
vec4 emissiveRightColor;
vec2 vDiffuseInfos;
vec2 vAmbientInfos;
vec2 vOpacityInfos;
vec2 vReflectionInfos;
vec3 vReflectionPosition;
vec3 vReflectionSize;
vec2 vEmissiveInfos;
vec2 vLightmapInfos;
vec2 vSpecularInfos;
vec3 vBumpInfos;
mat4 diffuseMatrix;
mat4 ambientMatrix;
mat4 opacityMatrix;
mat4 reflectionMatrix;
mat4 emissiveMatrix;
mat4 lightmapMatrix;
mat4 specularMatrix;
mat4 bumpMatrix;
vec2 vTangentSpaceParams;
float pointSize;
float alphaCutOff;
mat4 refractionMatrix;
vec4 vRefractionInfos;
vec3 vRefractionPosition;
vec3 vRefractionSize;
vec4 vSpecularColor;
vec3 vEmissiveColor;
vec4 vDiffuseColor;
vec3 vAmbientColor;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;w.IncludesShadersStore[ih]=sh;var rh="prePassDeclaration",nh=`#ifdef PREPASS
#extension GL_EXT_draw_buffers : require
layout(location=0) out highp vec4 glFragData[{X}];highp vec4 gl_FragColor;
#ifdef PREPASS_DEPTH
varying highp vec3 vViewPos;
#endif
#ifdef PREPASS_VELOCITY
varying highp vec4 vCurrentPosition;varying highp vec4 vPreviousPosition;
#endif
#endif
`;w.IncludesShadersStore[rh]=nh;var ah="oitDeclaration",oh=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
#extension GL_EXT_draw_buffers : require
layout(location=0) out vec2 depth; 
layout(location=1) out vec4 frontColor;
layout(location=2) out vec4 backColor;
#define MAX_DEPTH 99999.0
highp vec4 gl_FragColor;
uniform sampler2D oitDepthSampler;
uniform sampler2D oitFrontColorSampler;
#endif
`;w.IncludesShadersStore[ah]=oh;var hh="mainUVVaryingDeclaration",lh=`#ifdef MAINUV{X}
varying vec2 vMainUV{X};
#endif
`;w.IncludesShadersStore[hh]=lh;var ch="lightFragmentDeclaration",dh=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};
uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float cascadeBlendFactor{X};
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
uniform highp sampler2DArray depthSampler{X};
uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
#else
uniform highp sampler2DArray shadowSampler{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);
vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowSampler{X};
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowSampler{X};
uniform highp sampler2D depthSampler{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowSampler{X};
#else
uniform sampler2D shadowSampler{X};
#endif
uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};
uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};
uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};
uniform sampler2D projectionLightSampler{X};
#endif
#endif
`;w.IncludesShadersStore[ch]=dh;var uh="lightUboDeclaration",fh=`#ifdef LIGHT{X}
uniform Light{X}
{
vec4 vLightData;
vec4 vLightDiffuse;
vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;
vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#endif
vec4 shadowsInfo;
vec2 depthValues;
} light{X};
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};
uniform sampler2D projectionLightSampler{X};
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float cascadeBlendFactor{X};
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
uniform highp sampler2DArray depthSampler{X};
uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
#else
uniform highp sampler2DArray shadowSampler{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);
vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowSampler{X}; 
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowSampler{X};
uniform highp sampler2D depthSampler{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowSampler{X};
#else
uniform sampler2D shadowSampler{X};
#endif
uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;w.IncludesShadersStore[uh]=fh;var _h="lightsFragmentFunctions",ph=`struct lightingInfo
{
vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef NDOTL
float ndl;
#endif
};
lightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {
lightingInfo result;
vec3 lightVectorW;
float attenuation=1.0;
if (lightData.w==0.)
{
vec3 direction=lightData.xyz-vPositionW;
attenuation=max(0.,1.0-length(direction)/range);
lightVectorW=normalize(direction);
}
else
{
lightVectorW=normalize(-lightData.xyz);
}
float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);
float specComp=max(0.,dot(vNormal,angleW));
specComp=pow(specComp,max(1.,glossiness));
result.specular=specComp*specularColor*attenuation;
#endif
return result;
}
lightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {
lightingInfo result;
vec3 direction=lightData.xyz-vPositionW;
vec3 lightVectorW=normalize(direction);
float attenuation=max(0.,1.0-length(direction)/range);
float cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));
if (cosAngle>=lightDirection.w)
{
cosAngle=max(0.,pow(cosAngle,lightData.w));
attenuation*=cosAngle;
float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);
float specComp=max(0.,dot(vNormal,angleW));
specComp=pow(specComp,max(1.,glossiness));
result.specular=specComp*specularColor*attenuation;
#endif
return result;
}
result.diffuse=vec3(0.);
#ifdef SPECULARTERM
result.specular=vec3(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;
}
lightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {
lightingInfo result;
float ndl=dot(vNormal,lightData.xyz)*0.5+0.5;
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=mix(groundColor,diffuseColor,ndl);
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightData.xyz);
float specComp=max(0.,dot(vNormal,angleW));
specComp=pow(specComp,max(1.,glossiness));
result.specular=specComp*specularColor;
#endif
return result;
}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){
vec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);
strq/=strq.w;
vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;
return textureColor;
}`;w.IncludesShadersStore[_h]=ph;var gh="shadowsFragmentFunctions",mh=`#ifdef SHADOWS
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)
#else
#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)
#endif
#ifndef SHADOWFLOAT
float unpack(vec4 color)
{
const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);
return dot(color,bit_shift);
}
#endif
float computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)
{
float mask=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));
return mix(value,1.0,mask);
}
#define inline
float computeShadowCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
depth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadow=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadow=textureCube(shadowSampler,directionToLight).x;
#endif
return depth>shadow ? darkness : 1.0;
}
#define inline
float computeShadowWithPoissonSamplingCube(vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
depth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
float visibility=1.;
vec3 poissonDisk[4];
poissonDisk[0]=vec3(-1.0,1.0,-1.0);
poissonDisk[1]=vec3(1.0,-1.0,-1.0);
poissonDisk[2]=vec3(-1.0,-1.0,-1.0);
poissonDisk[3]=vec3(1.0,-1.0,1.0);
#ifndef SHADOWFLOAT
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;
#else
if (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;
if (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;
if (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;
if (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;
#endif
return min(1.0,visibility+darkness);
}
#define inline
float computeShadowWithESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
float shadowPixelDepth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness); 
return esm;
}
#define inline
float computeShadowWithCloseESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
float shadowPixelDepth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);
return esm;
}
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define inline
float computeShadowCSM(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray shadowSampler,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
vec3 uvLayer=vec3(uv.x,uv.y,layer);
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(texture2D(shadowSampler,uvLayer));
#else
float shadow=texture2D(shadowSampler,uvLayer).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;
}
#endif
#define inline
float computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadow=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;
}
}
#define inline
float computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
float visibility=1.;
vec2 poissonDisk[4];
poissonDisk[0]=vec2(-0.94201624,-0.39906216);
poissonDisk[1]=vec2(0.94558609,-0.76890725);
poissonDisk[2]=vec2(-0.094184101,-0.92938870);
poissonDisk[3]=vec2(0.34495938,0.29387760);
#ifndef SHADOWFLOAT
if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;
if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;
if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;
if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;
#else
if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;
if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;
if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;
if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;
#endif
return computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);
return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0); 
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);
return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);
}
}
#ifdef IS_NDC_HALF_ZRANGE
#define ZINCLIP clipSpace.z
#else
#define ZINCLIP uvDepth.z
#endif
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define GREATEST_LESS_THAN_ONE 0.99999994
#define inline
float computeShadowWithCSMPCF1(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);
float shadow=texture2D(shadowSampler,uvDepthLayer);
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
#define inline
float computeShadowWithCSMPCF3(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;
vec2 uvw1=1.+2.*st;
vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;
vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));
shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));
shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));
shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));
shadow=shadow/16.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
#define inline
float computeShadowWithCSMPCF5(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;
vec2 uvw1=vec2(7.);
vec2 uvw2=1.+3.*st;
vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;
vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));
shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));
shadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[0]),layer,uvDepth.z));
shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));
shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));
shadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[1]),layer,uvDepth.z));
shadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[2]),layer,uvDepth.z));
shadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[2]),layer,uvDepth.z));
shadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[2]),layer,uvDepth.z));
shadow=shadow/144.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
#define inline
float computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
float shadow=TEXTUREFUNC(shadowSampler,uvDepth,0.);
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;
vec2 uvw1=1.+2.*st;
vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;
vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);
shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);
shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);
shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);
shadow=shadow/16.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;
vec2 uvw1=vec2(7.);
vec2 uvw2=1.+3.*st;
vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;
vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);
shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);
shadow+=uvw2.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z),0.);
shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);
shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);
shadow+=uvw2.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z),0.);
shadow+=uvw0.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z),0.);
shadow+=uvw1.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z),0.);
shadow+=uvw2.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z),0.);
shadow=shadow/144.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
const vec3 PoissonSamplers32[64]=vec3[64](
vec3(0.06407013,0.05409927,0.),
vec3(0.7366577,0.5789394,0.),
vec3(-0.6270542,-0.5320278,0.),
vec3(-0.4096107,0.8411095,0.),
vec3(0.6849564,-0.4990818,0.),
vec3(-0.874181,-0.04579735,0.),
vec3(0.9989998,0.0009880066,0.),
vec3(-0.004920578,-0.9151649,0.),
vec3(0.1805763,0.9747483,0.),
vec3(-0.2138451,0.2635818,0.),
vec3(0.109845,0.3884785,0.),
vec3(0.06876755,-0.3581074,0.),
vec3(0.374073,-0.7661266,0.),
vec3(0.3079132,-0.1216763,0.),
vec3(-0.3794335,-0.8271583,0.),
vec3(-0.203878,-0.07715034,0.),
vec3(0.5912697,0.1469799,0.),
vec3(-0.88069,0.3031784,0.),
vec3(0.5040108,0.8283722,0.),
vec3(-0.5844124,0.5494877,0.),
vec3(0.6017799,-0.1726654,0.),
vec3(-0.5554981,0.1559997,0.),
vec3(-0.3016369,-0.3900928,0.),
vec3(-0.5550632,-0.1723762,0.),
vec3(0.925029,0.2995041,0.),
vec3(-0.2473137,0.5538505,0.),
vec3(0.9183037,-0.2862392,0.),
vec3(0.2469421,0.6718712,0.),
vec3(0.3916397,-0.4328209,0.),
vec3(-0.03576927,-0.6220032,0.),
vec3(-0.04661255,0.7995201,0.),
vec3(0.4402924,0.3640312,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.)
);
const vec3 PoissonSamplers64[64]=vec3[64](
vec3(-0.613392,0.617481,0.),
vec3(0.170019,-0.040254,0.),
vec3(-0.299417,0.791925,0.),
vec3(0.645680,0.493210,0.),
vec3(-0.651784,0.717887,0.),
vec3(0.421003,0.027070,0.),
vec3(-0.817194,-0.271096,0.),
vec3(-0.705374,-0.668203,0.),
vec3(0.977050,-0.108615,0.),
vec3(0.063326,0.142369,0.),
vec3(0.203528,0.214331,0.),
vec3(-0.667531,0.326090,0.),
vec3(-0.098422,-0.295755,0.),
vec3(-0.885922,0.215369,0.),
vec3(0.566637,0.605213,0.),
vec3(0.039766,-0.396100,0.),
vec3(0.751946,0.453352,0.),
vec3(0.078707,-0.715323,0.),
vec3(-0.075838,-0.529344,0.),
vec3(0.724479,-0.580798,0.),
vec3(0.222999,-0.215125,0.),
vec3(-0.467574,-0.405438,0.),
vec3(-0.248268,-0.814753,0.),
vec3(0.354411,-0.887570,0.),
vec3(0.175817,0.382366,0.),
vec3(0.487472,-0.063082,0.),
vec3(-0.084078,0.898312,0.),
vec3(0.488876,-0.783441,0.),
vec3(0.470016,0.217933,0.),
vec3(-0.696890,-0.549791,0.),
vec3(-0.149693,0.605762,0.),
vec3(0.034211,0.979980,0.),
vec3(0.503098,-0.308878,0.),
vec3(-0.016205,-0.872921,0.),
vec3(0.385784,-0.393902,0.),
vec3(-0.146886,-0.859249,0.),
vec3(0.643361,0.164098,0.),
vec3(0.634388,-0.049471,0.),
vec3(-0.688894,0.007843,0.),
vec3(0.464034,-0.188818,0.),
vec3(-0.440840,0.137486,0.),
vec3(0.364483,0.511704,0.),
vec3(0.034028,0.325968,0.),
vec3(0.099094,-0.308023,0.),
vec3(0.693960,-0.366253,0.),
vec3(0.678884,-0.204688,0.),
vec3(0.001801,0.780328,0.),
vec3(0.145177,-0.898984,0.),
vec3(0.062655,-0.611866,0.),
vec3(0.315226,-0.604297,0.),
vec3(-0.780145,0.486251,0.),
vec3(-0.371868,0.882138,0.),
vec3(0.200476,0.494430,0.),
vec3(-0.494552,-0.711051,0.),
vec3(0.612476,0.705252,0.),
vec3(-0.578845,-0.768792,0.),
vec3(-0.772454,-0.090976,0.),
vec3(0.504440,0.372295,0.),
vec3(0.155736,0.065157,0.),
vec3(0.391522,0.849605,0.),
vec3(-0.620106,-0.328104,0.),
vec3(0.789239,-0.419965,0.),
vec3(-0.545396,0.538133,0.),
vec3(-0.178564,-0.596057,0.)
);
#define inline
float computeShadowWithCSMPCSS(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);
float blockerDepth=0.0;
float sumBlockerDepth=0.0;
float numBlocker=0.0;
for (int i=0; i<searchTapCount; i ++) {
blockerDepth=texture2D(depthSampler,vec3(uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer)).r;
if (blockerDepth<depthMetric) {
sumBlockerDepth+=blockerDepth;
numBlocker++;
}
}
float avgBlockerDepth=sumBlockerDepth/numBlocker;
float AAOffset=shadowMapSizeInverse*10.;
float penumbraRatio=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);
vec4 filterRadius=vec4(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);
float random=getRand(vPositionFromLight.xy);
float rotationAngle=random*3.1415926;
vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));
float shadow=0.;
for (int i=0; i<pcfTapCount; i++) {
vec4 offset=vec4(poissonSamplers[i],0.);
offset=vec4(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);
shadow+=texture2D(shadowSampler,uvDepthLayer+offset*filterRadius);
}
shadow/=float(pcfTapCount);
shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));
shadow=mix(darkness,1.,shadow);
if (numBlocker<1.0) {
return 1.0;
}
else
{
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
float blockerDepth=0.0;
float sumBlockerDepth=0.0;
float numBlocker=0.0;
for (int i=0; i<searchTapCount; i ++) {
blockerDepth=TEXTUREFUNC(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0.).r;
if (blockerDepth<depthMetric) {
sumBlockerDepth+=blockerDepth;
numBlocker++;
}
}
if (numBlocker<1.0) {
return 1.0;
}
else
{
float avgBlockerDepth=sumBlockerDepth/numBlocker;
float AAOffset=shadowMapSizeInverse*10.;
float penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);
float filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;
float random=getRand(vPositionFromLight.xy);
float rotationAngle=random*3.1415926;
vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));
float shadow=0.;
for (int i=0; i<pcfTapCount; i++) {
vec3 offset=poissonSamplers[i];
offset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);
shadow+=TEXTUREFUNC(shadowSampler,uvDepth+offset*filterRadius,0.);
}
shadow/=float(pcfTapCount);
shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
}
#define inline
float computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{
return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);
}
#define inline
float computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{
return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);
}
#define inline
float computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{
return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);
}
#define inline
float computeShadowWithCSMPCSS16(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);
}
#define inline
float computeShadowWithCSMPCSS32(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);
}
#define inline
float computeShadowWithCSMPCSS64(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);
}
#endif
#endif
`;w.IncludesShadersStore[gh]=mh;var vh="samplerFragmentDeclaration",Eh=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
uniform sampler2D _SAMPLERNAME_Sampler;
#endif
`;w.IncludesShadersStore[vh]=Eh;var Th="fresnelFunction",Sh=`#ifdef FRESNEL
float computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)
{
float fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);
return clamp(fresnelTerm,0.,1.);
}
#endif
`;w.IncludesShadersStore[Th]=Sh;var bh="reflectionFunction",xh=`vec3 computeFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{
float lon=atan(direction.z,direction.x);
float lat=acos(direction.y);
vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;
float s=sphereCoords.x*0.5+0.5;
float t=sphereCoords.y;
return vec3(s,t,0); 
}
vec3 computeMirroredFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{
float lon=atan(direction.z,direction.x);
float lat=acos(direction.y);
vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;
float s=sphereCoords.x*0.5+0.5;
float t=sphereCoords.y;
return vec3(1.0-s,t,0); 
}
vec3 computeEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{
vec3 cameraToVertex=normalize(worldPos.xyz-eyePosition);
vec3 r=normalize(reflect(cameraToVertex,worldNormal));
r=vec3(reflectionMatrix*vec4(r,0));
float lon=atan(r.z,r.x);
float lat=acos(r.y);
vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;
float s=sphereCoords.x*0.5+0.5;
float t=sphereCoords.y;
return vec3(s,t,0);
}
vec3 computeSphericalCoords(vec4 worldPos,vec3 worldNormal,mat4 view,mat4 reflectionMatrix)
{
vec3 viewDir=normalize(vec3(view*worldPos));
vec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));
vec3 r=reflect(viewDir,viewNormal);
r=vec3(reflectionMatrix*vec4(r,0));
r.z=r.z-1.0;
float m=2.0*length(r);
return vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);
}
vec3 computePlanarCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{
vec3 viewDir=worldPos.xyz-eyePosition;
vec3 coords=normalize(reflect(viewDir,worldNormal));
return vec3(reflectionMatrix*vec4(coords,1));
}
vec3 computeCubicCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{
vec3 viewDir=normalize(worldPos.xyz-eyePosition);
vec3 coords=reflect(viewDir,worldNormal);
coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;
}
vec3 computeCubicLocalCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix,vec3 reflectionSize,vec3 reflectionPosition)
{
vec3 viewDir=normalize(worldPos.xyz-eyePosition);
vec3 coords=reflect(viewDir,worldNormal);
coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);
coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;
}
vec3 computeProjectionCoords(vec4 worldPos,mat4 view,mat4 reflectionMatrix)
{
return vec3(reflectionMatrix*(view*worldPos));
}
vec3 computeSkyBoxCoords(vec3 positionW,mat4 reflectionMatrix)
{
return vec3(reflectionMatrix*vec4(positionW,1.));
}
#ifdef REFLECTION
vec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)
{
#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);
return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);
return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR
return computeEquirectangularCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SPHERICAL
return computeSphericalCoords(worldPos,worldNormal,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_PLANAR
return computePlanarCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_CUBIC
#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC
return computeCubicLocalCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix,vReflectionSize,vReflectionPosition);
#else
return computeCubicCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#endif
#ifdef REFLECTIONMAP_PROJECTION
return computeProjectionCoords(worldPos,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SKYBOX
return computeSkyBoxCoords(vPositionUVW,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_EXPLICIT
return vec3(0,0,0);
#endif
}
#endif
`;w.IncludesShadersStore[bh]=xh;var Mh="imageProcessingDeclaration",Ah=`#ifdef EXPOSURE
uniform float exposureLinear;
#endif
#ifdef CONTRAST
uniform float contrast;
#endif
#if defined(VIGNETTE) || defined(DITHER)
uniform vec2 vInverseScreenSize;
#endif
#ifdef VIGNETTE
uniform vec4 vignetteSettings1;
uniform vec4 vignetteSettings2;
#endif
#ifdef COLORCURVES
uniform vec4 vCameraColorCurveNegative;
uniform vec4 vCameraColorCurveNeutral;
uniform vec4 vCameraColorCurvePositive;
#endif
#ifdef COLORGRADING
#ifdef COLORGRADING3D
uniform highp sampler3D txColorTransform;
#else
uniform sampler2D txColorTransform;
#endif
uniform vec4 colorTransformSettings;
#endif
#ifdef DITHER
uniform float ditherIntensity;
#endif
`;w.IncludesShadersStore[Mh]=Ah;var Rh="imageProcessingFunctions",yh=`#if defined(COLORGRADING) && !defined(COLORGRADING3D)
/** 
* Polyfill for SAMPLE_TEXTURE_3D,which is unsupported in WebGL.
* sampler3dSetting.x=textureOffset (0.5/textureSize).
* sampler3dSetting.y=textureSize.
*/
#define inline
vec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)
{
float sliceSize=2.0*sampler3dSetting.x; 
#ifdef SAMPLER3DGREENDEPTH
float sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;
#else
float sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;
#endif
float sliceInteger=floor(sliceContinuous);
float sliceFraction=sliceContinuous-sliceInteger;
#ifdef SAMPLER3DGREENDEPTH
vec2 sliceUV=color.rb;
#else
vec2 sliceUV=color.rg;
#endif
sliceUV.x*=sliceSize;
sliceUV.x+=sliceInteger*sliceSize;
sliceUV=saturate(sliceUV);
vec4 slice0Color=texture2D(colorTransform,sliceUV);
sliceUV.x+=sliceSize;
sliceUV=saturate(sliceUV);
vec4 slice1Color=texture2D(colorTransform,sliceUV);
vec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);
#ifdef SAMPLER3DBGRMAP
color.rgb=result.rgb;
#else
color.rgb=result.bgr;
#endif
return color;
}
#endif
#ifdef TONEMAPPING_ACES
const mat3 ACESInputMat=mat3(
vec3(0.59719,0.07600,0.02840),
vec3(0.35458,0.90834,0.13383),
vec3(0.04823,0.01566,0.83777)
);
const mat3 ACESOutputMat=mat3(
vec3( 1.60475,-0.10208,-0.00327),
vec3(-0.53108, 1.10813,-0.07276),
vec3(-0.07367,-0.00605, 1.07602)
);
vec3 RRTAndODTFit(vec3 v)
{
vec3 a=v*(v+0.0245786)-0.000090537;
vec3 b=v*(0.983729*v+0.4329510)+0.238081;
return a/b;
}
vec3 ACESFitted(vec3 color)
{
color=ACESInputMat*color;
color=RRTAndODTFit(color);
color=ACESOutputMat*color;
color=saturate(color);
return color;
}
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS
vec4 applyImageProcessing(vec4 result) {
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART
#ifdef EXPOSURE
result.rgb*=exposureLinear;
#endif
#ifdef VIGNETTE
vec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;
viewportXY=viewportXY*2.0-1.0;
vec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);
float vignetteTerm=dot(vignetteXY1,vignetteXY1);
float vignette=pow(vignetteTerm,vignetteSettings2.w);
vec3 vignetteColor=vignetteSettings2.rgb;
#ifdef VIGNETTEBLENDMODEMULTIPLY
vec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);
result.rgb*=vignetteColorMultiplier;
#endif
#ifdef VIGNETTEBLENDMODEOPAQUE
result.rgb=mix(vignetteColor,result.rgb,vignette);
#endif
#endif
#ifdef TONEMAPPING
#ifdef TONEMAPPING_ACES
result.rgb=ACESFitted(result.rgb);
#else
const float tonemappingCalibration=1.590579;
result.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);
#endif
#endif
result.rgb=toGammaSpace(result.rgb);
result.rgb=saturate(result.rgb);
#ifdef CONTRAST
vec3 resultHighContrast=result.rgb*result.rgb*(3.0-2.0*result.rgb);
if (contrast<1.0) {
result.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);
} else {
result.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);
}
#endif
#ifdef COLORGRADING
vec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;
#ifdef COLORGRADING3D
vec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;
#else
vec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;
#endif
result.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);
#endif
#ifdef COLORCURVES
float luma=getLuminance(result.rgb);
vec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));
vec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;
result.rgb*=colorCurve.rgb;
result.rgb=mix(vec3(luma),result.rgb,colorCurve.a);
#endif
#ifdef DITHER
float rand=getRand(gl_FragCoord.xy*vInverseScreenSize);
float dither=mix(-ditherIntensity,ditherIntensity,rand);
result.rgb=saturate(result.rgb+vec3(dither));
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND
return result;
}`;w.IncludesShadersStore[Rh]=yh;var Ch="bumpFragmentMainFunctions",Ih=`#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#ifdef OBJECTSPACE_NORMALMAP
uniform mat4 normalMatrix;
#endif
vec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)
{
#ifdef NORMALXYSCALE
normal=normalize(normal*vec3(scale,scale,1.0));
#endif
return normalize(cotangentFrame*normal);
}
vec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)
{
return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);
}
mat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)
{
vec3 dp1=dFdx(p);
vec3 dp2=dFdy(p);
vec2 duv1=dFdx(uv);
vec2 duv2=dFdy(uv);
vec3 dp2perp=cross(dp2,normal);
vec3 dp1perp=cross(normal,dp1);
vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;
vec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;
tangent*=tangentSpaceParams.x;
bitangent*=tangentSpaceParams.y;
float det=max(dot(tangent,tangent),dot(bitangent,bitangent));
float invmax=det==0.0 ? 0.0 : inversesqrt(det);
return mat3(tangent*invmax,bitangent*invmax,normal);
}
#endif
`;w.IncludesShadersStore[Ch]=Ih;var Ph="bumpFragmentFunctions",Dh=`#if defined(BUMP)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)
#endif
#if defined(DETAIL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)
#endif
#if defined(BUMP) && defined(PARALLAX)
const float minSamples=4.;
const float maxSamples=15.;
const int iMaxSamples=15;
vec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {
float parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;
parallaxLimit*=parallaxScale;
vec2 vOffsetDir=normalize(vViewDirCoT.xy);
vec2 vMaxOffset=vOffsetDir*parallaxLimit;
float numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));
float stepSize=1.0/numSamples;
float currRayHeight=1.0;
vec2 vCurrOffset=vec2(0,0);
vec2 vLastOffset=vec2(0,0);
float lastSampledHeight=1.0;
float currSampledHeight=1.0;
bool keepWorking=true;
for (int i=0; i<iMaxSamples; i++)
{
currSampledHeight=texture2D(bumpSampler,texCoord+vCurrOffset).w;
if (!keepWorking)
{
}
else if (currSampledHeight>currRayHeight)
{
float delta1=currSampledHeight-currRayHeight;
float delta2=(currRayHeight+stepSize)-lastSampledHeight;
float ratio=delta1/(delta1+delta2);
vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;
keepWorking=false;
}
else
{
currRayHeight-=stepSize;
vLastOffset=vCurrOffset;
vCurrOffset+=stepSize*vMaxOffset;
lastSampledHeight=currSampledHeight;
}
}
return vCurrOffset;
}
vec2 parallaxOffset(vec3 viewDir,float heightScale)
{
float height=texture2D(bumpSampler,vBumpUV).w;
vec2 texCoordOffset=heightScale*viewDir.xy*height;
return -texCoordOffset;
}
#endif
`;w.IncludesShadersStore[Ph]=Dh;var Fh="logDepthDeclaration",wh=`#ifdef LOGARITHMICDEPTH
uniform float logarithmicDepthConstant;
varying float vFragmentDepth;
#endif
`;w.IncludesShadersStore[Fh]=wh;var Oh="fogFragmentDeclaration",Lh=`#ifdef FOG
#define FOGMODE_NONE 0.
#define FOGMODE_EXP 1.
#define FOGMODE_EXP2 2.
#define FOGMODE_LINEAR 3.
#define E 2.71828
uniform vec4 vFogInfos;
uniform vec3 vFogColor;
varying vec3 vFogDistance;
float CalcFogFactor()
{
float fogCoeff=1.0;
float fogStart=vFogInfos.y;
float fogEnd=vFogInfos.z;
float fogDensity=vFogInfos.w;
float fogDistance=length(vFogDistance);
if (FOGMODE_LINEAR==vFogInfos.x)
{
fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);
}
else if (FOGMODE_EXP==vFogInfos.x)
{
fogCoeff=1.0/pow(E,fogDistance*fogDensity);
}
else if (FOGMODE_EXP2==vFogInfos.x)
{
fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);
}
return clamp(fogCoeff,0.0,1.0);
}
#endif
`;w.IncludesShadersStore[Oh]=Lh;var Nh="bumpFragment",Bh=`vec2 uvOffset=vec2(0.0,0.0);
#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)
#ifdef NORMALXYSCALE
float normalScale=1.0;
#elif defined(BUMP)
float normalScale=vBumpInfos.y;
#else
float normalScale=1.0;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#elif defined(BUMP)
vec2 TBNUV=gl_FrontFacing ? vBumpUV : -vBumpUV;
mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);
#else
vec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;
mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));
#endif
#elif defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#else
vec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;
mat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));
#endif
#endif
#ifdef PARALLAX
mat3 invTBN=transposeMat3(TBN);
#ifdef PARALLAXOCCLUSION
uvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);
#else
uvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);
#endif
#endif
#ifdef DETAIL
vec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);
vec2 detailNormalRG=detailColor.wy*2.0-1.0;
float detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));
vec3 detailNormal=vec3(detailNormalRG,detailNormalB);
#endif
#ifdef BUMP
#ifdef OBJECTSPACE_NORMALMAP
normalW=normalize(texture2D(bumpSampler,vBumpUV).xyz *2.0-1.0);
normalW=normalize(mat3(normalMatrix)*normalW);
#elif !defined(DETAIL)
normalW=perturbNormal(TBN,texture2D(bumpSampler,vBumpUV+uvOffset).xyz,vBumpInfos.y);
#else
vec3 bumpNormal=texture2D(bumpSampler,vBumpUV+uvOffset).xyz*2.0-1.0;
#if DETAIL_NORMALBLENDMETHOD==0 
detailNormal.xy*=vDetailInfos.z;
vec3 blendedNormal=normalize(vec3(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));
#elif DETAIL_NORMALBLENDMETHOD==1 
detailNormal.xy*=vDetailInfos.z;
bumpNormal+=vec3(0.0,0.0,1.0);
detailNormal*=vec3(-1.0,-1.0,1.0);
vec3 blendedNormal=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;
#endif
normalW=perturbNormalBase(TBN,blendedNormal,vBumpInfos.y);
#endif
#elif defined(DETAIL)
detailNormal.xy*=vDetailInfos.z;
normalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);
#endif
`;w.IncludesShadersStore[Nh]=Bh;var Uh="depthPrePass",kh=`#ifdef DEPTHPREPASS
gl_FragColor=vec4(0.,0.,0.,1.0);
return;
#endif
`;w.IncludesShadersStore[Uh]=kh;var Vh="lightFragment",Gh=`#ifdef LIGHT{X}
#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})
#else
#ifdef PBR
#ifdef SPOTLIGHT{X}
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(POINTLIGHT{X})
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(HEMILIGHT{X})
preInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(DIRLIGHT{X})
preInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#endif
preInfo.NdotV=NdotV;
#ifdef SPOTLIGHT{X}
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
preInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
preInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
preInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
preInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#elif defined(POINTLIGHT{X})
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#endif
#else
preInfo.attenuation=1.0;
#endif
#ifdef HEMILIGHT{X}
preInfo.roughness=roughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#ifdef IRIDESCENCE
preInfo.iridescenceIntensity=iridescenceIntensity;
#endif
#ifdef HEMILIGHT{X}
info.diffuse=computeHemisphericDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb,light{X}.vLightGround);
#elif defined(SS_TRANSLUCENCY)
info.diffuse=computeDiffuseAndTransmittedLighting(preInfo,light{X}.vLightDiffuse.rgb,subSurfaceOut.transmittance);
#else
info.diffuse=computeDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb);
#endif
#ifdef SPECULARTERM
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#else
info.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#endif
#endif
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
#ifdef HEMILIGHT{X}
preInfo.roughness=sheenOut.sheenRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#endif
#ifdef CLEARCOAT
#ifdef HEMILIGHT{X}
preInfo.roughness=clearcoatOut.clearCoatRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light{X}.vLightDiffuse.rgb);
#ifdef CLEARCOAT_TINT
absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);
info.diffuse*=absorption;
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
#else
#ifdef SPOTLIGHT{X}
info=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);
#elif defined(HEMILIGHT{X})
info=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);
#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})
info=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);
#endif
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
info.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightSampler{X},textureProjectionMatrix{X});
#endif
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) 
{
#ifdef SHADOWCSM_RIGHTHANDED{X}
diff{X}=viewFrustumZ{X}[i]+vPositionFromCamera{X}.z;
#else
diff{X}=viewFrustumZ{X}[i]-vPositionFromCamera{X}.z;
#endif
if (diff{X}>=0.) {
index{X}=i;
break;
}
}
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
if (index{X}>=0)
#endif
{
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
shadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
shadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=vec3(shadow)*vCascadeColorsMultiplier{X}[index{X}];
#endif
#ifndef SHADOWCSMNOBLEND{X}
float frustumLength=frustumLengths{X}[index{X}];
float diffRatio=clamp(diff{X}/frustumLength,0.,1.)*cascadeBlendFactor{X};
if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)
{
index{X}+=1;
float nextShadow=0.;
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
nextShadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
nextShadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
nextShadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
shadow=mix(nextShadow,shadow,diffRatio);
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);
#endif
}
#endif
}
#elif defined(SHADOWCLOSEESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithCloseESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPOISSON{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithPoissonSamplingCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#else
#if defined(SHADOWCUBE{X})
shadow=computeShadowCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#endif
#ifdef SHADOWONLY
#ifndef SHADOWINUSE
#define SHADOWINUSE
#endif
globalShadow+=shadow;
shadowLightCount+=1.0;
#endif
#else
shadow=1.;
#endif
#ifndef SHADOWONLY
#ifdef CUSTOMUSERLIGHTING
diffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);
#ifdef SPECULARTERM
specularBase+=computeCustomSpecularLighting(info,specularBase,shadow);
#endif
#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})
diffuseBase+=lightmapColor.rgb*shadow;
#ifdef SPECULARTERM
#ifndef LIGHTMAPNOSPECULAR{X}
specularBase+=info.specular*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef CLEARCOAT
#ifndef LIGHTMAPNOSPECULAR{X}
clearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef SHEEN
#ifndef LIGHTMAPNOSPECULAR{X}
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#else
#ifdef SHADOWCSMDEBUG{X}
diffuseBase+=info.diffuse*shadowDebug{X};
#else 
diffuseBase+=info.diffuse*shadow;
#endif
#ifdef SPECULARTERM
specularBase+=info.specular*shadow;
#endif
#ifdef CLEARCOAT
clearCoatBase+=info.clearCoat.rgb*shadow;
#endif
#ifdef SHEEN
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#endif
#endif
`;w.IncludesShadersStore[Vh]=Gh;var Wh="logDepthFragment",zh=`#ifdef LOGARITHMICDEPTH
gl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;
#endif
`;w.IncludesShadersStore[Wh]=zh;var Xh="fogFragment",Hh=`#ifdef FOG
float fog=CalcFogFactor();
#ifdef PBR
fog=toLinearSpace(fog);
#endif
color.rgb=mix(vFogColor,color.rgb,fog);
#endif
`;w.IncludesShadersStore[Xh]=Hh;var Kh="oitFragment",Yh=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
float fragDepth=gl_FragCoord.z; 
#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS
uint halfFloat=packHalf2x16(vec2(fragDepth));
vec2 full=unpackHalf2x16(halfFloat);
fragDepth=full.x;
#endif
ivec2 fragCoord=ivec2(gl_FragCoord.xy);
vec2 lastDepth=texelFetch(oitDepthSampler,fragCoord,0).rg;
vec4 lastFrontColor=texelFetch(oitFrontColorSampler,fragCoord,0);
depth.rg=vec2(-MAX_DEPTH);
frontColor=lastFrontColor;
backColor=vec4(0.0);
#ifdef USE_REVERSE_DEPTHBUFFER
float furthestDepth=-lastDepth.x;
float nearestDepth=lastDepth.y;
#else
float nearestDepth=-lastDepth.x;
float furthestDepth=lastDepth.y;
#endif
float alphaMultiplier=1.0-lastFrontColor.a;
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth>nearestDepth || fragDepth<furthestDepth) {
#else
if (fragDepth<nearestDepth || fragDepth>furthestDepth) {
#endif
return;
}
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth<nearestDepth && fragDepth>furthestDepth) {
#else
if (fragDepth>nearestDepth && fragDepth<furthestDepth) {
#endif
depth.rg=vec2(-fragDepth,fragDepth);
return;
}
#endif
`;w.IncludesShadersStore[Kh]=Yh;var jh="defaultPixelShader",qh=`#include<__decl__defaultFragment>
#if defined(BUMP) || !defined(NORMAL)
#extension GL_OES_standard_derivatives : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#include<oitDeclaration>
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#define RECIPROCAL_PI2 0.15915494
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#include<helperFunctions>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#ifdef REFRACTION
#ifdef REFRACTIONMAP_3D
uniform samplerCube refractionCubeSampler;
#else
uniform sampler2D refraction2DSampler;
#endif
#endif
#if defined(SPECULARTERM)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)
#endif
#include<fresnelFunction>
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
uniform samplerCube reflectionCubeSampler;
#else
uniform sampler2D reflection2DSampler;
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#include<imageProcessingDeclaration>
#include<imageProcessingFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
vec4 baseColor=vec4(1.,1.,1.,1.);
vec3 diffuseColor=vDiffuseColor.rgb;
float alpha=vDiffuseColor.a;
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));
#endif
#include<bumpFragment>
#ifdef TWOSIDEDLIGHTING
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
#ifdef DIFFUSE
baseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);
#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)
if (baseColor.a<alphaCutOff)
discard;
#endif
#ifdef ALPHAFROMDIFFUSE
alpha*=baseColor.a;
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
baseColor.rgb*=vDiffuseInfos.y;
#endif
#include<depthPrePass>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
baseColor.rgb*=vColor.rgb;
#endif
#ifdef DETAIL
baseColor.rgb=baseColor.rgb*2.0*mix(0.5,detailColor.r,vDetailInfos.y);
#endif
#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE
vec3 baseAmbientColor=vec3(1.,1.,1.);
#ifdef AMBIENT
baseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;
#endif
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
#ifdef SPECULARTERM
float glossiness=vSpecularColor.a;
vec3 specularColor=vSpecularColor.rgb;
#ifdef SPECULAR
vec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);
specularColor=specularMapColor.rgb;
#ifdef GLOSSINESS
glossiness=glossiness*specularMapColor.a;
#endif
#endif
#else
float glossiness=0.;
#endif
vec3 diffuseBase=vec3(0.,0.,0.);
lightingInfo info;
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
float shadow=1.;
#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
#include<lightFragment>[0..maxSimultaneousLights]
vec4 refractionColor=vec4(0.,0.,0.,1.);
#ifdef REFRACTION
vec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));
#ifdef REFRACTIONMAP_3D
#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,vRefractionSize,vRefractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;
if (dot(refractionVector,viewDirectionW)<1.0) {
refractionColor=textureCube(refractionCubeSampler,refractionVector);
}
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));
vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;
refractionCoords.y=1.0-refractionCoords.y;
refractionColor=texture2D(refraction2DSampler,refractionCoords);
#endif
#ifdef RGBDREFRACTION
refractionColor.rgb=fromRGBD(refractionColor);
#endif
#ifdef IS_REFRACTION_LINEAR
refractionColor.rgb=toGammaSpace(refractionColor.rgb);
#endif
refractionColor.rgb*=vRefractionInfos.x;
#endif
vec4 reflectionColor=vec4(0.,0.,0.,1.);
#ifdef REFLECTION
vec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
vReflectionUVW.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
#ifdef ROUGHNESS
float bias=vReflectionInfos.y;
#ifdef SPECULARTERM
#ifdef SPECULAR
#ifdef GLOSSINESS
bias*=(1.0-specularMapColor.a);
#endif
#endif
#endif
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias);
#else
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW);
#endif
#else
vec2 coords=vReflectionUVW.xy;
#ifdef REFLECTIONMAP_PROJECTION
coords/=vReflectionUVW.z;
#endif
coords.y=1.0-coords.y;
reflectionColor=texture2D(reflection2DSampler,coords);
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef IS_REFLECTION_LINEAR
reflectionColor.rgb=toGammaSpace(reflectionColor.rgb);
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#ifdef REFLECTIONFRESNEL
float reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);
#ifdef REFLECTIONFRESNELFROMSPECULAR
#ifdef SPECULARTERM
reflectionColor.rgb*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#endif
#endif
#ifdef REFRACTIONFRESNEL
float refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);
refractionColor.rgb*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#ifdef OPACITYRGB
opacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);
alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;
#else
alpha*=opacityMap.a*vOpacityInfos.y;
#endif
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
#ifdef OPACITYFRESNEL
float opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);
alpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;
#endif
#ifdef ALPHATEST
#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS
if (alpha<alphaCutOff)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
vec3 emissiveColor=vEmissiveColor;
#ifdef EMISSIVE
emissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;
#endif
#ifdef EMISSIVEFRESNEL
float emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);
emissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;
#endif
#ifdef DIFFUSEFRESNEL
float diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);
diffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;
#endif
#ifdef EMISSIVEASILLUMINATION
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
#ifdef LINKEMISSIVEWITHDIFFUSE
vec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#endif
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase*specularColor;
#ifdef SPECULAROVERALPHA
alpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#else
vec3 finalSpecular=vec3(0.0);
#endif
#ifdef REFLECTIONOVERALPHA
alpha=clamp(alpha+dot(reflectionColor.rgb,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#ifdef EMISSIVEASILLUMINATION
vec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);
#else
vec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);
#endif
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
color.rgb*=lightmapColor.rgb;
#else
color.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
#define CUSTOM_FRAGMENT_BEFORE_FOG
color.rgb=max(color.rgb,0.);
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
color.rgb=toLinearSpace(color.rgb);
#else
#ifdef IMAGEPROCESSING
color.rgb=toLinearSpace(color.rgb);
color=applyImageProcessing(color);
#endif
#endif
color.a*=visibility;
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
float writeGeometryInfo=color.a>0.4 ? 1.0 : 0.0;
gl_FragData[0]=color; 
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;
vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;
vec2 velocity=abs(a-b);
velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;
gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_IRRADIANCE
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_NORMAL
gl_FragData[PREPASS_NORMAL_INDEX]=vec4((view*vec4(normalW,0.0)).rgb,writeGeometryInfo); 
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_REFLECTIVITY
#if defined(SPECULARTERM)
#if defined(SPECULAR)
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularMapColor)*writeGeometryInfo; 
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularColor,1.0)*writeGeometryInfo;
#endif
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(0.0,0.0,0.0,1.0)*writeGeometryInfo;
#endif
#endif
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=color;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {
frontColor.rgb+=color.rgb*color.a*alphaMultiplier;
frontColor.a=1.0-alphaMultiplier*(1.0-color.a);
} else {
backColor+=color;
}
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}
`;w.ShadersStore[jh]=qh;var Zh="defaultVertexDeclaration",Qh=`uniform mat4 viewProjection;
uniform mat4 view;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;
uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;
uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
uniform mat4 lightmapMatrix;
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;
uniform mat4 specularMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform mat4 bumpMatrix;
#endif
#ifdef REFLECTION
uniform mat4 reflectionMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
uniform mat4 detailMatrix;
#endif
#define ADDITIONAL_VERTEX_DECLARATION
`;w.IncludesShadersStore[Zh]=Qh;var $h="uvAttributeDeclaration",Jh=`#ifdef UV{X}
attribute vec2 uv{X};
#endif
`;w.IncludesShadersStore[$h]=Jh;var el="prePassVertexDeclaration",tl=`#ifdef PREPASS
#ifdef PREPASS_DEPTH
varying vec3 vViewPos;
#endif
#ifdef PREPASS_VELOCITY
uniform mat4 previousViewProjection;
varying vec4 vCurrentPosition;
varying vec4 vPreviousPosition;
#endif
#endif
`;w.IncludesShadersStore[el]=tl;var il="samplerVertexDeclaration",sl=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
varying vec2 v_VARYINGNAME_UV;
#endif
`;w.IncludesShadersStore[il]=sl;var rl="bumpVertexDeclaration",nl=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#endif
`;w.IncludesShadersStore[rl]=nl;var al="fogVertexDeclaration",ol=`#ifdef FOG
varying vec3 vFogDistance;
#endif
`;w.IncludesShadersStore[al]=ol;var hl="lightVxFragmentDeclaration",ll=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};
uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};
uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};
uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#endif
`;w.IncludesShadersStore[hl]=ll;var cl="lightVxUboDeclaration",dl=`#ifdef LIGHT{X}
uniform Light{X}
{
vec4 vLightData;
vec4 vLightDiffuse;
vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;
vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#endif
vec4 shadowsInfo;
vec2 depthValues;
} light{X};
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;w.IncludesShadersStore[cl]=dl;var ul="prePassVertex",fl=`#ifdef PREPASS_DEPTH
vViewPos=(view*worldPos).rgb;
#endif
#if defined(PREPASS_VELOCITY) && defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*worldPos;
#if NUM_BONE_INFLUENCERS>0
mat4 previousInfluence;
previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);
#else
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#endif
`;w.IncludesShadersStore[ul]=fl;var _l="uvVariableDeclaration",pl=`#if !defined(UV{X}) && defined(MAINUV{X})
vec2 uv{X}=vec2(0.,0.);
#endif
#ifdef MAINUV{X}
vMainUV{X}=uv{X};
#endif
`;w.IncludesShadersStore[_l]=pl;var gl="samplerVertexImplementation",ml=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
if (v_INFONAME_==0.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uvUpdated,1.0,0.0));
}
#ifdef UV2
else if (v_INFONAME_==1.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv2,1.0,0.0));
}
#endif
#ifdef UV3
else if (v_INFONAME_==2.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv3,1.0,0.0));
}
#endif
#ifdef UV4
else if (v_INFONAME_==3.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv4,1.0,0.0));
}
#endif
#ifdef UV5
else if (v_INFONAME_==4.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv5,1.0,0.0));
}
#endif
#ifdef UV6
else if (v_INFONAME_==5.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv6,1.0,0.0));
}
#endif
#endif
`;w.IncludesShadersStore[gl]=ml;var vl="bumpVertex",El=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
vec3 tbnNormal=normalize(normalUpdated);
vec3 tbnTangent=normalize(tangentUpdated.xyz);
vec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;
vTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);
#endif
#endif
`;w.IncludesShadersStore[vl]=El;var Tl="fogVertex",Sl=`#ifdef FOG
vFogDistance=(view*worldPos).xyz;
#endif
`;w.IncludesShadersStore[Tl]=Sl;var bl="shadowsVertex",xl=`#ifdef SHADOWS
#if defined(SHADOWCSM{X})
vPositionFromCamera{X}=view*worldPos;
for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) {
vPositionFromLight{X}[i]=lightMatrix{X}[i]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}[i]=(-vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}[i]=(vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
}
#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})
vPositionFromLight{X}=lightMatrix{X}*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}=(-vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}=(vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif
#endif
`;w.IncludesShadersStore[bl]=xl;var Ml="vertexColorMixing",Al=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
vColor=vec4(1.0);
#ifdef VERTEXCOLOR
#ifdef VERTEXALPHA
vColor*=color;
#else
vColor.rgb*=color.rgb;
#endif
#endif
#ifdef INSTANCESCOLOR
vColor*=instanceColor;
#endif
#endif
`;w.IncludesShadersStore[Ml]=Al;var Rl="pointCloudVertex",yl=`#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
`;w.IncludesShadersStore[Rl]=yl;var Cl="logDepthVertex",Il=`#ifdef LOGARITHMICDEPTH
vFragmentDepth=1.0+gl_Position.w;
gl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;
#endif
`;w.IncludesShadersStore[Cl]=Il;var Pl="defaultVertexShader",Dl=`#include<__decl__defaultVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<mainUVVaryingDeclaration>[1..7]
#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#if defined(SPECULARTERM)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)
#endif
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));
vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {
gl_Position=viewProjection*worldPos;
} else {
gl_Position=viewProjectionR*worldPos;
}
#else
gl_Position=viewProjection*worldPos;
#endif
vPositionW=vec3(worldPos);
#include<prePassVertex>
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#include<uvVariableDeclaration>[2..7]
#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#if defined(SPECULARTERM)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)
#endif
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#include<pointCloudVertex>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;w.ShadersStore[Pl]=Dl;var Fl=new RegExp("^([gimus]+)!"),wl=(()=>{class n{constructor(e){this._plugins=[],this._activePlugins=[],this._activePluginsForExtraEvents=[],this._material=e,this._scene=e.getScene(),this._engine=this._scene.getEngine()}_addPlugin(e){for(let r=0;r<this._plugins.length;++r)if(this._plugins[r].name===e.name)throw`Plugin "${e.name}" already added to the material "${this._material.name}"!`;if(this._material._uniformBufferLayoutBuilt)throw`The plugin "${e.name}" can't be added to the material "${this._material.name}" because this material has already been used for rendering! Please add plugins to materials before any rendering with this material occurs.`;let i=e.getClassName();n._MaterialPluginClassToMainDefine[i]||(n._MaterialPluginClassToMainDefine[i]="MATERIALPLUGIN_"+ ++n._MaterialPluginCounter),this._material._callbackPluginEventGeneric=this._handlePluginEvent.bind(this),this._plugins.push(e),this._plugins.sort((r,a)=>r.priority-a.priority),this._codeInjectionPoints={};let s={};s[n._MaterialPluginClassToMainDefine[i]]={type:"boolean",default:!0};for(let r of this._plugins)r.collectDefines(s),this._collectPointNames("vertex",r.getCustomCode("vertex")),this._collectPointNames("fragment",r.getCustomCode("fragment"));this._defineNamesFromPlugins=s}_activatePlugin(e){this._activePlugins.indexOf(e)===-1&&(this._activePlugins.push(e),this._activePlugins.sort((i,s)=>i.priority-s.priority),this._material._callbackPluginEventIsReadyForSubMesh=this._handlePluginEventIsReadyForSubMesh.bind(this),this._material._callbackPluginEventPrepareDefinesBeforeAttributes=this._handlePluginEventPrepareDefinesBeforeAttributes.bind(this),this._material._callbackPluginEventPrepareDefines=this._handlePluginEventPrepareDefines.bind(this),this._material._callbackPluginEventBindForSubMesh=this._handlePluginEventBindForSubMesh.bind(this),e.registerForExtraEvents&&(this._activePluginsForExtraEvents.push(e),this._activePluginsForExtraEvents.sort((i,s)=>i.priority-s.priority),this._material._callbackPluginEventHasRenderTargetTextures=this._handlePluginEventHasRenderTargetTextures.bind(this),this._material._callbackPluginEventFillRenderTargetTextures=this._handlePluginEventFillRenderTargetTextures.bind(this),this._material._callbackPluginEventHardBindForSubMesh=this._handlePluginEventHardBindForSubMesh.bind(this)))}getPlugin(e){for(let i=0;i<this._plugins.length;++i)if(this._plugins[i].name===e)return this._plugins[i];return null}_handlePluginEventIsReadyForSubMesh(e){let i=!0;for(let s of this._activePlugins)i=i&&s.isReadyForSubMesh(e.defines,this._scene,this._engine,e.subMesh);e.isReadyForSubMesh=i}_handlePluginEventPrepareDefinesBeforeAttributes(e){for(let i of this._activePlugins)i.prepareDefinesBeforeAttributes(e.defines,this._scene,e.mesh)}_handlePluginEventPrepareDefines(e){for(let i of this._activePlugins)i.prepareDefines(e.defines,this._scene,e.mesh)}_handlePluginEventHardBindForSubMesh(e){for(let i of this._activePluginsForExtraEvents)i.hardBindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventBindForSubMesh(e){for(let i of this._activePlugins)i.bindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventHasRenderTargetTextures(e){let i=!1;for(let s of this._activePluginsForExtraEvents)if(i=s.hasRenderTargetTextures(),i)break;e.hasRenderTargetTextures=i}_handlePluginEventFillRenderTargetTextures(e){for(let i of this._activePluginsForExtraEvents)i.fillRenderTargetTextures(e.renderTargets)}_handlePluginEvent(e,i){switch(e){case Ue.GetActiveTextures:{let s=i;for(let r of this._activePlugins)r.getActiveTextures(s.activeTextures);break}case Ue.GetAnimatables:{let s=i;for(let r of this._activePlugins)r.getAnimatables(s.animatables);break}case Ue.HasTexture:{let s=i,r=!1;for(let a of this._activePlugins)if(r=a.hasTexture(s.texture),r)break;s.hasTexture=r;break}case Ue.Disposed:{let s=i;for(let r of this._plugins)r.dispose(s.forceDisposeTextures);break}case Ue.GetDefineNames:{let s=i;s.defineNames=this._defineNamesFromPlugins;break}case Ue.PrepareEffect:{let s=i;for(let r of this._activePlugins)s.fallbackRank=r.addFallbacks(s.defines,s.fallbacks,s.fallbackRank),r.getAttributes(s.attributes,this._scene,s.mesh);this._uniformList.length>0&&s.uniforms.push(...this._uniformList),this._samplerList.length>0&&s.samplers.push(...this._samplerList),this._uboList.length>0&&s.uniformBuffersNames.push(...this._uboList),s.customCode=this._injectCustomCode(s.customCode);break}case Ue.PrepareUniformBuffer:{let s=i;this._uboDeclaration="",this._vertexDeclaration="",this._fragmentDeclaration="",this._uniformList=[],this._samplerList=[],this._uboList=[];for(let r of this._plugins){let a=r.getUniforms();if(a){if(a.ubo)for(let o of a.ubo)s.ubo.addUniform(o.name,o.size),this._uboDeclaration+=`${o.type} ${o.name};\r
`,this._uniformList.push(o.name);a.vertex&&(this._vertexDeclaration+=a.vertex+`\r
`),a.fragment&&(this._fragmentDeclaration+=a.fragment+`\r
`)}r.getSamplers(this._samplerList),r.getUniformBuffersNames(this._uboList)}break}}}_collectPointNames(e,i){if(i)for(let s in i)this._codeInjectionPoints[e]||(this._codeInjectionPoints[e]={}),this._codeInjectionPoints[e][s]=!0}_injectCustomCode(e){return(i,s)=>{var r;e&&(s=e(i,s)),this._uboDeclaration&&(s=s.replace("#define ADDITIONAL_UBO_DECLARATION",this._uboDeclaration)),this._vertexDeclaration&&(s=s.replace("#define ADDITIONAL_VERTEX_DECLARATION",this._vertexDeclaration)),this._fragmentDeclaration&&(s=s.replace("#define ADDITIONAL_FRAGMENT_DECLARATION",this._fragmentDeclaration));let a=(r=this._codeInjectionPoints)===null||r===void 0?void 0:r[i];if(!a)return s;for(let o in a){let h="";for(let l of this._activePlugins){let c=l.getCustomCode(i);c!=null&&c[o]&&(h+=c[o]+`\r
`)}if(h.length>0)if(o.charAt(0)==="!"){o=o.substring(1);let l="g";if(o.charAt(0)==="!")l="",o=o.substring(1);else{let f=Fl.exec(o);f&&f.length>=2&&(l=f[1],o=o.substring(l.length+1))}l.indexOf("g")<0&&(l+="g");let c=s,d=new RegExp(o,l),u=d.exec(c);for(;u!==null;){let f=h;for(let _=0;_<u.length;++_)f=f.replace("$"+_,u[_]);s=s.replace(u[0],f),u=d.exec(c)}}else{let l="#define "+o;s=s.replace(l,`\r
`+h+`\r
`+l)}}return s}}}return n._MaterialPluginClassToMainDefine={},n._MaterialPluginCounter=0,n})(),vi=class{constructor(t,e,i,s,r=!0,a=!1){this.priority=500,this.registerForExtraEvents=!1,this._material=t,this.name=e,this.priority=i,t.pluginManager||(t.pluginManager=new wl(t)),this._pluginDefineNames=s,this._pluginManager=t.pluginManager,r&&this._pluginManager._addPlugin(this),a&&this._enable(!0),this.markAllDefinesAsDirty=t._dirtyCallbacks[63]}_enable(t){t&&this._pluginManager._activatePlugin(this)}getClassName(){return"MaterialPluginBase"}isReadyForSubMesh(t,e,i,s){return!0}hardBindForSubMesh(t,e,i,s){}bindForSubMesh(t,e,i,s){}dispose(t){}getCustomCode(t){return null}collectDefines(t){if(this._pluginDefineNames)for(let e of Object.keys(this._pluginDefineNames)){if(e[0]==="_")continue;let i=typeof this._pluginDefineNames[e];t[e]={type:i==="number"?"number":i==="string"?"string":i==="boolean"?"boolean":"object",default:this._pluginDefineNames[e]}}}prepareDefinesBeforeAttributes(t,e,i){}prepareDefines(t,e,i){}hasTexture(t){return!1}hasRenderTargetTextures(){return!1}fillRenderTargetTextures(t){}getActiveTextures(t){}getAnimatables(t){}addFallbacks(t,e,i){return i}getSamplers(t){}getAttributes(t,e,i){}getUniformBuffersNames(t){}getUniforms(){return{}}copyTo(t){ee.Clone(()=>t,this)}serialize(){return ee.Serialize(this)}parse(t,e,i){ee.Parse(()=>this,t,e,i)}};S([A()],vi.prototype,"name",void 0);S([A()],vi.prototype,"priority",void 0);S([A()],vi.prototype,"registerForExtraEvents",void 0);var Or=class extends Oi{constructor(){super(...arguments),this.DETAIL=!1,this.DETAILDIRECTUV=0,this.DETAIL_NORMALBLENDMETHOD=0}},Lt=class extends vi{constructor(t,e=!0){super(t,"DetailMap",140,new Or,e),this._texture=null,this.diffuseBlendLevel=1,this.roughnessBlendLevel=1,this.bumpLevel=1,this._normalBlendMethod=B.MATERIAL_NORMALBLENDMETHOD_WHITEOUT,this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=t._dirtyCallbacks[1]}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isReadyForSubMesh(t,e,i){return this._isEnabled?!(t._areTexturesDirty&&e.texturesEnabled&&i.getCaps().standardDerivatives&&this._texture&&fe.DetailTextureEnabled&&!this._texture.isReady()):!0}prepareDefines(t,e){if(this._isEnabled){t.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod;let i=e.getEngine();t._areTexturesDirty&&(i.getCaps().standardDerivatives&&this._texture&&fe.DetailTextureEnabled&&this._isEnabled?(K.PrepareDefinesForMergedUV(this._texture,t,"DETAIL"),t.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod):t.DETAIL=!1)}else t.DETAIL=!1}bindForSubMesh(t,e){if(!this._isEnabled)return;let i=this._material.isFrozen;(!t.useUbo||!i||!t.isSync)&&this._texture&&fe.DetailTextureEnabled&&(t.updateFloat4("vDetailInfos",this._texture.coordinatesIndex,this.diffuseBlendLevel,this.bumpLevel,this.roughnessBlendLevel),K.BindTextureMatrix(this._texture,t,"detail")),e.texturesEnabled&&this._texture&&fe.DetailTextureEnabled&&t.setTexture("detailSampler",this._texture)}hasTexture(t){return this._texture===t}getActiveTextures(t){this._texture&&t.push(this._texture)}getAnimatables(t){this._texture&&this._texture.animations&&this._texture.animations.length>0&&t.push(this._texture)}dispose(t){var e;t&&((e=this._texture)===null||e===void 0||e.dispose())}getClassName(){return"DetailMapConfiguration"}getSamplers(t){t.push("detailSampler")}getUniforms(){return{ubo:[{name:"vDetailInfos",size:4,type:"vec4"},{name:"detailMatrix",size:16,type:"mat4"}]}}};S([rt("detailTexture"),ae("_markAllSubMeshesAsTexturesDirty")],Lt.prototype,"texture",void 0);S([A()],Lt.prototype,"diffuseBlendLevel",void 0);S([A()],Lt.prototype,"roughnessBlendLevel",void 0);S([A()],Lt.prototype,"bumpLevel",void 0);S([A(),ae("_markAllSubMeshesAsTexturesDirty")],Lt.prototype,"normalBlendMethod",void 0);S([A(),ae("_markAllSubMeshesAsTexturesDirty")],Lt.prototype,"isEnabled",void 0);var ks={effect:null,subMesh:null},Lr=class extends Oi{constructor(t){super(t),this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.OPACITY=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.REFLECTION=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.SPECULAR=!1,this.SPECULARDIRECTUV=0,this.BUMP=!1,this.BUMPDIRECTUV=0,this.PARALLAX=!1,this.PARALLAXOCCLUSION=!1,this.SPECULAROVERALPHA=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHAFROMDIFFUSE=!1,this.POINTSIZE=!1,this.FOG=!1,this.SPECULARTERM=!1,this.DIFFUSEFRESNEL=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONFRESNEL=!1,this.REFRACTIONFRESNEL=!1,this.EMISSIVEFRESNEL=!1,this.FRESNEL=!1,this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.VERTEXCOLOR=!1,this.VERTEXALPHA=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.GLOSSINESS=!1,this.ROUGHNESS=!1,this.EMISSIVEASILLUMINATION=!1,this.LINKEMISSIVEWITHDIFFUSE=!1,this.REFLECTIONFRESNELFROMSPECULAR=!1,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.USELIGHTMAPASSHADOWMAP=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.INVERTCUBICMAP=!1,this.LOGARITHMICDEPTH=!1,this.REFRACTION=!1,this.REFRACTIONMAP_3D=!1,this.REFLECTIONOVERALPHA=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.NONUNIFORMSCALING=!1,this.PREMULTIPLYALPHA=!1,this.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,this.ALPHABLEND=!0,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.RGBDLIGHTMAP=!1,this.RGBDREFLECTION=!1,this.RGBDREFRACTION=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.IS_REFLECTION_LINEAR=!1,this.IS_REFRACTION_LINEAR=!1,this.EXPOSURE=!1,this.rebuild()}setReflectionMode(t){let e=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"];for(let i of e)this[i]=i===t}},k=class n extends Ts{constructor(t,e){super(t,e),this._diffuseTexture=null,this._ambientTexture=null,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._specularTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._refractionTexture=null,this.ambientColor=new me(0,0,0),this.diffuseColor=new me(1,1,1),this.specularColor=new me(1,1,1),this.emissiveColor=new me(0,0,0),this.specularPower=64,this._useAlphaFromDiffuseTexture=!1,this._useEmissiveAsIllumination=!1,this._linkEmissiveWithDiffuse=!1,this._useSpecularOverAlpha=!1,this._useReflectionOverAlpha=!1,this._disableLighting=!1,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this._roughness=0,this.indexOfRefraction=.98,this.invertRefractionY=!0,this.alphaCutOff=.4,this._useLightmapAsShadowmap=!1,this._useReflectionFresnelFromSpecular=!1,this._useGlossinessFromSpecularMapAlpha=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._renderTargets=new Ze(16),this._worldViewProjectionMatrix=P.Zero(),this._globalAmbientColor=new me(0,0,0),this._cacheHasRenderTargetTextures=!1,this.detailMap=new Lt(this),this._attachImageProcessingConfiguration(null),this.prePassConfiguration=new Es,this.getRenderTargetTextures=()=>(this._renderTargets.reset(),n.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),n.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&this._renderTargets.push(this._refractionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets)}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(t){this._attachImageProcessingConfiguration(t),this._markAllSubMeshesAsTexturesDirty()}_attachImageProcessingConfiguration(t){t!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),t?this._imageProcessingConfiguration=t:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}get isPrePassCapable(){return!this.disableDepthWrite}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(t){this.imageProcessingConfiguration.colorCurvesEnabled=t}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(t){this.imageProcessingConfiguration.colorGradingEnabled=t}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(t){this._imageProcessingConfiguration.toneMappingEnabled=t}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(t){this._imageProcessingConfiguration.exposure=t}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(t){this._imageProcessingConfiguration.contrast=t}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(t){this._imageProcessingConfiguration.colorGradingTexture=t}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(t){this._imageProcessingConfiguration.colorCurves=t}get canRenderToMRT(){return!0}get hasRenderTargetTextures(){return n.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget||n.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures}getClassName(){return"StandardMaterial"}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(t){this._useLogarithmicDepth=t&&this.getScene().getEngine().getCaps().fragmentDepthSupported,this._markAllSubMeshesAsMiscDirty()}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled}needAlphaTesting(){return this._forceAlphaTest?!0:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===B.MATERIAL_ALPHATEST)}_shouldUseAlphaFromDiffuseTexture(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==B.MATERIAL_OPAQUE}_hasAlphaChannel(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._opacityTexture!=null}getAlphaTestTexture(){return this._diffuseTexture}isReadyForSubMesh(t,e,i=!1){if(this._uniformBufferLayoutBuilt||this.buildUniformLayout(),e.effect&&this.isFrozen&&e.effect._wasPreviouslyReady&&e.effect._wasPreviouslyUsingInstances===i)return!0;e.materialDefines||(this._callbackPluginEventGeneric(Ue.GetDefineNames,this._eventInfo),e.materialDefines=new Lr(this._eventInfo.defineNames));let s=this.getScene(),r=e.materialDefines;if(this._isReadyForSubMesh(e))return!0;let a=s.getEngine();r._needNormals=K.PrepareDefinesForLights(s,t,r,!0,this._maxSimultaneousLights,this._disableLighting),K.PrepareDefinesForMultiview(s,r);let o=this.needAlphaBlendingForMesh(t)&&this.getScene().useOrderIndependentTransparency;if(K.PrepareDefinesForPrePass(s,r,this.canRenderToMRT&&!o),K.PrepareDefinesForOIT(s,r,o),r._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,r._needUVs=!1;for(let l=1;l<=6;++l)r["MAINUV"+l]=!1;if(s.texturesEnabled){if(r.DIFFUSEDIRECTUV=0,r.BUMPDIRECTUV=0,r.AMBIENTDIRECTUV=0,r.OPACITYDIRECTUV=0,r.EMISSIVEDIRECTUV=0,r.SPECULARDIRECTUV=0,r.LIGHTMAPDIRECTUV=0,this._diffuseTexture&&n.DiffuseTextureEnabled)if(this._diffuseTexture.isReadyOrNotBlocking())K.PrepareDefinesForMergedUV(this._diffuseTexture,r,"DIFFUSE");else return!1;else r.DIFFUSE=!1;if(this._ambientTexture&&n.AmbientTextureEnabled)if(this._ambientTexture.isReadyOrNotBlocking())K.PrepareDefinesForMergedUV(this._ambientTexture,r,"AMBIENT");else return!1;else r.AMBIENT=!1;if(this._opacityTexture&&n.OpacityTextureEnabled)if(this._opacityTexture.isReadyOrNotBlocking())K.PrepareDefinesForMergedUV(this._opacityTexture,r,"OPACITY"),r.OPACITYRGB=this._opacityTexture.getAlphaFromRGB;else return!1;else r.OPACITY=!1;if(this._reflectionTexture&&n.ReflectionTextureEnabled)if(this._reflectionTexture.isReadyOrNotBlocking()){switch(r._needNormals=!0,r.REFLECTION=!0,r.ROUGHNESS=this._roughness>0,r.REFLECTIONOVERALPHA=this._useReflectionOverAlpha,r.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===L.INVCUBIC_MODE,r.REFLECTIONMAP_3D=this._reflectionTexture.isCube,r.REFLECTIONMAP_OPPOSITEZ=r.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!this._reflectionTexture.invertZ:this._reflectionTexture.invertZ,r.RGBDREFLECTION=this._reflectionTexture.isRGBD,this._reflectionTexture.coordinatesMode){case L.EXPLICIT_MODE:r.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case L.PLANAR_MODE:r.setReflectionMode("REFLECTIONMAP_PLANAR");break;case L.PROJECTION_MODE:r.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case L.SKYBOX_MODE:r.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case L.SPHERICAL_MODE:r.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case L.EQUIRECTANGULAR_MODE:r.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case L.FIXED_EQUIRECTANGULAR_MODE:r.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case L.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:r.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break;case L.CUBIC_MODE:case L.INVCUBIC_MODE:default:r.setReflectionMode("REFLECTIONMAP_CUBIC");break}r.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this._reflectionTexture.boundingBoxSize}else return!1;else r.REFLECTION=!1,r.REFLECTIONMAP_OPPOSITEZ=!1;if(this._emissiveTexture&&n.EmissiveTextureEnabled)if(this._emissiveTexture.isReadyOrNotBlocking())K.PrepareDefinesForMergedUV(this._emissiveTexture,r,"EMISSIVE");else return!1;else r.EMISSIVE=!1;if(this._lightmapTexture&&n.LightmapTextureEnabled)if(this._lightmapTexture.isReadyOrNotBlocking())K.PrepareDefinesForMergedUV(this._lightmapTexture,r,"LIGHTMAP"),r.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,r.RGBDLIGHTMAP=this._lightmapTexture.isRGBD;else return!1;else r.LIGHTMAP=!1;if(this._specularTexture&&n.SpecularTextureEnabled)if(this._specularTexture.isReadyOrNotBlocking())K.PrepareDefinesForMergedUV(this._specularTexture,r,"SPECULAR"),r.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha;else return!1;else r.SPECULAR=!1;if(s.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&n.BumpTextureEnabled){if(this._bumpTexture.isReady())K.PrepareDefinesForMergedUV(this._bumpTexture,r,"BUMP"),r.PARALLAX=this._useParallax,r.PARALLAXOCCLUSION=this._useParallaxOcclusion;else return!1;r.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else r.BUMP=!1,r.PARALLAX=!1,r.PARALLAXOCCLUSION=!1;if(this._refractionTexture&&n.RefractionTextureEnabled)if(this._refractionTexture.isReadyOrNotBlocking())r._needUVs=!0,r.REFRACTION=!0,r.REFRACTIONMAP_3D=this._refractionTexture.isCube,r.RGBDREFRACTION=this._refractionTexture.isRGBD,r.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize;else return!1;else r.REFRACTION=!1;r.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else r.DIFFUSE=!1,r.AMBIENT=!1,r.OPACITY=!1,r.REFLECTION=!1,r.EMISSIVE=!1,r.LIGHTMAP=!1,r.BUMP=!1,r.REFRACTION=!1;r.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),r.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,r.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,r.SPECULAROVERALPHA=this._useSpecularOverAlpha,r.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,r.ALPHATEST_AFTERALLALPHACOMPUTATIONS=this.transparencyMode!==null,r.ALPHABLEND=this.transparencyMode===null||this.needAlphaBlendingForMesh(t)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=r,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(r._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(r),r.IS_REFLECTION_LINEAR=this.reflectionTexture!=null&&!this.reflectionTexture.gammaSpace,r.IS_REFRACTION_LINEAR=this.refractionTexture!=null&&!this.refractionTexture.gammaSpace}r._areFresnelDirty&&(n.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(r.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,r.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,r.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,r.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,r.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,r.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,r._needNormals=!0,r.FRESNEL=!0):r.FRESNEL=!1),K.PrepareDefinesForMisc(t,s,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(t)||this._forceAlphaTest,r),K.PrepareDefinesForFrameBoundValues(s,a,this,r,i,null,e.getRenderingMesh().hasThinInstances),this._eventInfo.defines=r,this._eventInfo.mesh=t,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),K.PrepareDefinesForAttributes(t,r,!0,!0,!0),this._callbackPluginEventPrepareDefines(this._eventInfo);let h=!1;if(r.isDirty){let l=r._areLightsDisposed;r.markAsProcessed();let c=new Gi;r.REFLECTION&&c.addFallback(0,"REFLECTION"),r.SPECULAR&&c.addFallback(0,"SPECULAR"),r.BUMP&&c.addFallback(0,"BUMP"),r.PARALLAX&&c.addFallback(1,"PARALLAX"),r.PARALLAXOCCLUSION&&c.addFallback(0,"PARALLAXOCCLUSION"),r.SPECULAROVERALPHA&&c.addFallback(0,"SPECULAROVERALPHA"),r.FOG&&c.addFallback(1,"FOG"),r.POINTSIZE&&c.addFallback(0,"POINTSIZE"),r.LOGARITHMICDEPTH&&c.addFallback(0,"LOGARITHMICDEPTH"),K.HandleFallbacksForShadows(r,c,this._maxSimultaneousLights),r.SPECULARTERM&&c.addFallback(0,"SPECULARTERM"),r.DIFFUSEFRESNEL&&c.addFallback(1,"DIFFUSEFRESNEL"),r.OPACITYFRESNEL&&c.addFallback(2,"OPACITYFRESNEL"),r.REFLECTIONFRESNEL&&c.addFallback(3,"REFLECTIONFRESNEL"),r.EMISSIVEFRESNEL&&c.addFallback(4,"EMISSIVEFRESNEL"),r.FRESNEL&&c.addFallback(4,"FRESNEL"),r.MULTIVIEW&&c.addFallback(0,"MULTIVIEW");let d=[m.PositionKind];r.NORMAL&&d.push(m.NormalKind),r.TANGENT&&d.push(m.TangentKind);for(let y=1;y<=6;++y)r["UV"+y]&&d.push(`uv${y===1?"":y}`);r.VERTEXCOLOR&&d.push(m.ColorKind),K.PrepareAttributesForBones(d,t,r,c),K.PrepareAttributesForInstances(d,r),K.PrepareAttributesForMorphTargets(d,t,r),K.PrepareAttributesForBakedVertexAnimation(d,t,r);let u="default",f=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],_=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],g=["Material","Scene","Mesh"];this._eventInfo.fallbacks=c,this._eventInfo.fallbackRank=0,this._eventInfo.defines=r,this._eventInfo.uniforms=f,this._eventInfo.attributes=d,this._eventInfo.samplers=_,this._eventInfo.uniformBuffersNames=g,this._eventInfo.customCode=void 0,this._eventInfo.mesh=t,this._callbackPluginEventGeneric(Ue.PrepareEffect,this._eventInfo),Es.AddUniforms(f),ue&&(ue.PrepareUniforms(f,r),ue.PrepareSamplers(_,r)),K.PrepareUniformsAndSamplersList({uniformsNames:f,uniformBuffersNames:g,samplers:_,defines:r,maxSimultaneousLights:this._maxSimultaneousLights}),xs(f);let p={};this.customShaderNameResolve&&(u=this.customShaderNameResolve(u,f,g,_,r,d,p));let E=r.toString(),T=e.effect,R=s.getEngine().createEffect(u,{attributes:d,uniformsNames:f,uniformBuffersNames:g,samplers:_,defines:E,fallbacks:c,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:r.NUM_MORPH_INFLUENCERS},processFinalCode:p.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:r.PREPASS},a);if(this._eventInfo.customCode=void 0,R)if(this._onEffectCreatedObservable&&(ks.effect=R,ks.subMesh=e,this._onEffectCreatedObservable.notifyObservers(ks)),this.allowShaderHotSwapping&&T&&!R.isReady()){if(R=T,r.markAsUnprocessed(),h=this.isFrozen,l)return r._areLightsDisposed=!0,!1}else s.resetCachedMaterial(),e.setEffect(R,r,this._materialContext)}return!e.effect||!e.effect.isReady()?!1:(r._renderId=s.getRenderId(),e.effect._wasPreviouslyReady=!h,e.effect._wasPreviouslyUsingInstances=i,s.performancePriority!==mt.BackwardCompatible&&(this.checkReadyOnlyOnce=!0),!0)}buildUniformLayout(){let t=this._uniformBuffer;t.addUniform("diffuseLeftColor",4),t.addUniform("diffuseRightColor",4),t.addUniform("opacityParts",4),t.addUniform("reflectionLeftColor",4),t.addUniform("reflectionRightColor",4),t.addUniform("refractionLeftColor",4),t.addUniform("refractionRightColor",4),t.addUniform("emissiveLeftColor",4),t.addUniform("emissiveRightColor",4),t.addUniform("vDiffuseInfos",2),t.addUniform("vAmbientInfos",2),t.addUniform("vOpacityInfos",2),t.addUniform("vReflectionInfos",2),t.addUniform("vReflectionPosition",3),t.addUniform("vReflectionSize",3),t.addUniform("vEmissiveInfos",2),t.addUniform("vLightmapInfos",2),t.addUniform("vSpecularInfos",2),t.addUniform("vBumpInfos",3),t.addUniform("diffuseMatrix",16),t.addUniform("ambientMatrix",16),t.addUniform("opacityMatrix",16),t.addUniform("reflectionMatrix",16),t.addUniform("emissiveMatrix",16),t.addUniform("lightmapMatrix",16),t.addUniform("specularMatrix",16),t.addUniform("bumpMatrix",16),t.addUniform("vTangentSpaceParams",2),t.addUniform("pointSize",1),t.addUniform("alphaCutOff",1),t.addUniform("refractionMatrix",16),t.addUniform("vRefractionInfos",4),t.addUniform("vRefractionPosition",3),t.addUniform("vRefractionSize",3),t.addUniform("vSpecularColor",4),t.addUniform("vEmissiveColor",3),t.addUniform("vDiffuseColor",4),t.addUniform("vAmbientColor",3),super.buildUniformLayout()}bindForSubMesh(t,e,i){var s;let r=this.getScene(),a=i.materialDefines;if(!a)return;let o=i.effect;if(!o)return;this._activeEffect=o,e.getMeshUniformBuffer().bindToEffect(o,"Mesh"),e.transferToEffect(t),this._uniformBuffer.bindToEffect(o,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,r,e,t,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),a.OBJECTSPACE_NORMALMAP&&(t.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));let h=o._forceRebindOnNextCall||this._mustRebind(r,o,e.visibility);K.BindBonesParameters(e,o);let l=this._uniformBuffer;if(h){if(this.bindViewProjection(o),!l.useUbo||!this.isFrozen||!l.isSync||o._forceRebindOnNextCall){if(n.FresnelEnabled&&a.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(l.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),l.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&l.updateColor4("opacityParts",new me(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(l.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),l.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(l.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),l.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(l.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),l.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),r.texturesEnabled){if(this._diffuseTexture&&n.DiffuseTextureEnabled&&(l.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),K.BindTextureMatrix(this._diffuseTexture,l,"diffuse")),this._ambientTexture&&n.AmbientTextureEnabled&&(l.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),K.BindTextureMatrix(this._ambientTexture,l,"ambient")),this._opacityTexture&&n.OpacityTextureEnabled&&(l.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),K.BindTextureMatrix(this._opacityTexture,l,"opacity")),this._hasAlphaChannel()&&l.updateFloat("alphaCutOff",this.alphaCutOff),this._reflectionTexture&&n.ReflectionTextureEnabled&&(l.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness),l.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix()),this._reflectionTexture.boundingBoxSize)){let c=this._reflectionTexture;l.updateVector3("vReflectionPosition",c.boundingBoxPosition),l.updateVector3("vReflectionSize",c.boundingBoxSize)}if(this._emissiveTexture&&n.EmissiveTextureEnabled&&(l.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),K.BindTextureMatrix(this._emissiveTexture,l,"emissive")),this._lightmapTexture&&n.LightmapTextureEnabled&&(l.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),K.BindTextureMatrix(this._lightmapTexture,l,"lightmap")),this._specularTexture&&n.SpecularTextureEnabled&&(l.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),K.BindTextureMatrix(this._specularTexture,l,"specular")),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&n.BumpTextureEnabled&&(l.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),K.BindTextureMatrix(this._bumpTexture,l,"bump"),r._mirroredCameraPosition?l.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):l.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&n.RefractionTextureEnabled){let c=1;if(this._refractionTexture.isCube||(l.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(c=this._refractionTexture.depth)),l.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,c,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){let d=this._refractionTexture;l.updateVector3("vRefractionPosition",d.boundingBoxPosition),l.updateVector3("vRefractionSize",d.boundingBoxSize)}}}this.pointsCloud&&l.updateFloat("pointSize",this.pointSize),a.SPECULARTERM&&l.updateColor4("vSpecularColor",this.specularColor,this.specularPower),l.updateColor3("vEmissiveColor",n.EmissiveTextureEnabled?this.emissiveColor:me.BlackReadOnly),l.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),r.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),l.updateColor3("vAmbientColor",this._globalAmbientColor)}r.texturesEnabled&&(this._diffuseTexture&&n.DiffuseTextureEnabled&&o.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&n.AmbientTextureEnabled&&o.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&n.OpacityTextureEnabled&&o.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&n.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?o.setTexture("reflectionCubeSampler",this._reflectionTexture):o.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&n.EmissiveTextureEnabled&&o.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&n.LightmapTextureEnabled&&o.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&n.SpecularTextureEnabled&&o.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&n.BumpTextureEnabled&&o.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&n.RefractionTextureEnabled&&(this._refractionTexture.isCube?o.setTexture("refractionCubeSampler",this._refractionTexture):o.setTexture("refraction2DSampler",this._refractionTexture))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(e)&&this.getScene().depthPeelingRenderer.bind(o),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),Ms(o,this,r),this.bindEyePosition(o)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(h||!this.isFrozen)&&(r.lightsEnabled&&!this._disableLighting&&K.BindLights(r,e,o,a,this._maxSimultaneousLights),(r.fogEnabled&&e.applyFog&&r.fogMode!==te.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||e.receiveShadows||a.PREPASS)&&this.bindView(o),K.BindFogParameters(r,e,o),a.NUM_MORPH_INFLUENCERS&&K.BindMorphTargetParameters(e,o),a.BAKED_VERTEX_ANIMATION_TEXTURE&&((s=e.bakedVertexAnimationManager)===null||s===void 0||s.bind(o,a.INSTANCES)),this.useLogarithmicDepth&&K.BindLogDepth(a,o,r),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(e,this._activeEffect),l.update()}getAnimatables(){let t=super.getAnimatables();return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&t.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&t.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&t.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&t.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&t.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&t.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&t.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&t.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&t.push(this._refractionTexture),t}getActiveTextures(){let t=super.getActiveTextures();return this._diffuseTexture&&t.push(this._diffuseTexture),this._ambientTexture&&t.push(this._ambientTexture),this._opacityTexture&&t.push(this._opacityTexture),this._reflectionTexture&&t.push(this._reflectionTexture),this._emissiveTexture&&t.push(this._emissiveTexture),this._specularTexture&&t.push(this._specularTexture),this._bumpTexture&&t.push(this._bumpTexture),this._lightmapTexture&&t.push(this._lightmapTexture),this._refractionTexture&&t.push(this._refractionTexture),t}hasTexture(t){return!!(super.hasTexture(t)||this._diffuseTexture===t||this._ambientTexture===t||this._opacityTexture===t||this._reflectionTexture===t||this._emissiveTexture===t||this._specularTexture===t||this._bumpTexture===t||this._lightmapTexture===t||this._refractionTexture===t)}dispose(t,e){var i,s,r,a,o,h,l,c,d;e&&((i=this._diffuseTexture)===null||i===void 0||i.dispose(),(s=this._ambientTexture)===null||s===void 0||s.dispose(),(r=this._opacityTexture)===null||r===void 0||r.dispose(),(a=this._reflectionTexture)===null||a===void 0||a.dispose(),(o=this._emissiveTexture)===null||o===void 0||o.dispose(),(h=this._specularTexture)===null||h===void 0||h.dispose(),(l=this._bumpTexture)===null||l===void 0||l.dispose(),(c=this._lightmapTexture)===null||c===void 0||c.dispose(),(d=this._refractionTexture)===null||d===void 0||d.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(t,e)}clone(t){let e=ee.Clone(()=>new n(t,this.getScene()),this);return e.name=t,e.id=t,this.stencil.copyTo(e.stencil),e}static Parse(t,e,i){let s=ee.Parse(()=>new n(t.name,e),t,e,i);return t.stencil&&s.stencil.parse(t.stencil,e,i),s}static get DiffuseTextureEnabled(){return fe.DiffuseTextureEnabled}static set DiffuseTextureEnabled(t){fe.DiffuseTextureEnabled=t}static get DetailTextureEnabled(){return fe.DetailTextureEnabled}static set DetailTextureEnabled(t){fe.DetailTextureEnabled=t}static get AmbientTextureEnabled(){return fe.AmbientTextureEnabled}static set AmbientTextureEnabled(t){fe.AmbientTextureEnabled=t}static get OpacityTextureEnabled(){return fe.OpacityTextureEnabled}static set OpacityTextureEnabled(t){fe.OpacityTextureEnabled=t}static get ReflectionTextureEnabled(){return fe.ReflectionTextureEnabled}static set ReflectionTextureEnabled(t){fe.ReflectionTextureEnabled=t}static get EmissiveTextureEnabled(){return fe.EmissiveTextureEnabled}static set EmissiveTextureEnabled(t){fe.EmissiveTextureEnabled=t}static get SpecularTextureEnabled(){return fe.SpecularTextureEnabled}static set SpecularTextureEnabled(t){fe.SpecularTextureEnabled=t}static get BumpTextureEnabled(){return fe.BumpTextureEnabled}static set BumpTextureEnabled(t){fe.BumpTextureEnabled=t}static get LightmapTextureEnabled(){return fe.LightmapTextureEnabled}static set LightmapTextureEnabled(t){fe.LightmapTextureEnabled=t}static get RefractionTextureEnabled(){return fe.RefractionTextureEnabled}static set RefractionTextureEnabled(t){fe.RefractionTextureEnabled=t}static get ColorGradingTextureEnabled(){return fe.ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(t){fe.ColorGradingTextureEnabled=t}static get FresnelEnabled(){return fe.FresnelEnabled}static set FresnelEnabled(t){fe.FresnelEnabled=t}};S([rt("diffuseTexture")],k.prototype,"_diffuseTexture",void 0);S([ae("_markAllSubMeshesAsTexturesAndMiscDirty")],k.prototype,"diffuseTexture",void 0);S([rt("ambientTexture")],k.prototype,"_ambientTexture",void 0);S([ae("_markAllSubMeshesAsTexturesDirty")],k.prototype,"ambientTexture",void 0);S([rt("opacityTexture")],k.prototype,"_opacityTexture",void 0);S([ae("_markAllSubMeshesAsTexturesAndMiscDirty")],k.prototype,"opacityTexture",void 0);S([rt("reflectionTexture")],k.prototype,"_reflectionTexture",void 0);S([ae("_markAllSubMeshesAsTexturesDirty")],k.prototype,"reflectionTexture",void 0);S([rt("emissiveTexture")],k.prototype,"_emissiveTexture",void 0);S([ae("_markAllSubMeshesAsTexturesDirty")],k.prototype,"emissiveTexture",void 0);S([rt("specularTexture")],k.prototype,"_specularTexture",void 0);S([ae("_markAllSubMeshesAsTexturesDirty")],k.prototype,"specularTexture",void 0);S([rt("bumpTexture")],k.prototype,"_bumpTexture",void 0);S([ae("_markAllSubMeshesAsTexturesDirty")],k.prototype,"bumpTexture",void 0);S([rt("lightmapTexture")],k.prototype,"_lightmapTexture",void 0);S([ae("_markAllSubMeshesAsTexturesDirty")],k.prototype,"lightmapTexture",void 0);S([rt("refractionTexture")],k.prototype,"_refractionTexture",void 0);S([ae("_markAllSubMeshesAsTexturesDirty")],k.prototype,"refractionTexture",void 0);S([Jt("ambient")],k.prototype,"ambientColor",void 0);S([Jt("diffuse")],k.prototype,"diffuseColor",void 0);S([Jt("specular")],k.prototype,"specularColor",void 0);S([Jt("emissive")],k.prototype,"emissiveColor",void 0);S([A()],k.prototype,"specularPower",void 0);S([A("useAlphaFromDiffuseTexture")],k.prototype,"_useAlphaFromDiffuseTexture",void 0);S([ae("_markAllSubMeshesAsTexturesAndMiscDirty")],k.prototype,"useAlphaFromDiffuseTexture",void 0);S([A("useEmissiveAsIllumination")],k.prototype,"_useEmissiveAsIllumination",void 0);S([ae("_markAllSubMeshesAsTexturesDirty")],k.prototype,"useEmissiveAsIllumination",void 0);S([A("linkEmissiveWithDiffuse")],k.prototype,"_linkEmissiveWithDiffuse",void 0);S([ae("_markAllSubMeshesAsTexturesDirty")],k.prototype,"linkEmissiveWithDiffuse",void 0);S([A("useSpecularOverAlpha")],k.prototype,"_useSpecularOverAlpha",void 0);S([ae("_markAllSubMeshesAsTexturesDirty")],k.prototype,"useSpecularOverAlpha",void 0);S([A("useReflectionOverAlpha")],k.prototype,"_useReflectionOverAlpha",void 0);S([ae("_markAllSubMeshesAsTexturesDirty")],k.prototype,"useReflectionOverAlpha",void 0);S([A("disableLighting")],k.prototype,"_disableLighting",void 0);S([ae("_markAllSubMeshesAsLightsDirty")],k.prototype,"disableLighting",void 0);S([A("useObjectSpaceNormalMap")],k.prototype,"_useObjectSpaceNormalMap",void 0);S([ae("_markAllSubMeshesAsTexturesDirty")],k.prototype,"useObjectSpaceNormalMap",void 0);S([A("useParallax")],k.prototype,"_useParallax",void 0);S([ae("_markAllSubMeshesAsTexturesDirty")],k.prototype,"useParallax",void 0);S([A("useParallaxOcclusion")],k.prototype,"_useParallaxOcclusion",void 0);S([ae("_markAllSubMeshesAsTexturesDirty")],k.prototype,"useParallaxOcclusion",void 0);S([A()],k.prototype,"parallaxScaleBias",void 0);S([A("roughness")],k.prototype,"_roughness",void 0);S([ae("_markAllSubMeshesAsTexturesDirty")],k.prototype,"roughness",void 0);S([A()],k.prototype,"indexOfRefraction",void 0);S([A()],k.prototype,"invertRefractionY",void 0);S([A()],k.prototype,"alphaCutOff",void 0);S([A("useLightmapAsShadowmap")],k.prototype,"_useLightmapAsShadowmap",void 0);S([ae("_markAllSubMeshesAsTexturesDirty")],k.prototype,"useLightmapAsShadowmap",void 0);S([zi("diffuseFresnelParameters")],k.prototype,"_diffuseFresnelParameters",void 0);S([ae("_markAllSubMeshesAsFresnelDirty")],k.prototype,"diffuseFresnelParameters",void 0);S([zi("opacityFresnelParameters")],k.prototype,"_opacityFresnelParameters",void 0);S([ae("_markAllSubMeshesAsFresnelAndMiscDirty")],k.prototype,"opacityFresnelParameters",void 0);S([zi("reflectionFresnelParameters")],k.prototype,"_reflectionFresnelParameters",void 0);S([ae("_markAllSubMeshesAsFresnelDirty")],k.prototype,"reflectionFresnelParameters",void 0);S([zi("refractionFresnelParameters")],k.prototype,"_refractionFresnelParameters",void 0);S([ae("_markAllSubMeshesAsFresnelDirty")],k.prototype,"refractionFresnelParameters",void 0);S([zi("emissiveFresnelParameters")],k.prototype,"_emissiveFresnelParameters",void 0);S([ae("_markAllSubMeshesAsFresnelDirty")],k.prototype,"emissiveFresnelParameters",void 0);S([A("useReflectionFresnelFromSpecular")],k.prototype,"_useReflectionFresnelFromSpecular",void 0);S([ae("_markAllSubMeshesAsFresnelDirty")],k.prototype,"useReflectionFresnelFromSpecular",void 0);S([A("useGlossinessFromSpecularMapAlpha")],k.prototype,"_useGlossinessFromSpecularMapAlpha",void 0);S([ae("_markAllSubMeshesAsTexturesDirty")],k.prototype,"useGlossinessFromSpecularMapAlpha",void 0);S([A("maxSimultaneousLights")],k.prototype,"_maxSimultaneousLights",void 0);S([ae("_markAllSubMeshesAsLightsDirty")],k.prototype,"maxSimultaneousLights",void 0);S([A("invertNormalMapX")],k.prototype,"_invertNormalMapX",void 0);S([ae("_markAllSubMeshesAsTexturesDirty")],k.prototype,"invertNormalMapX",void 0);S([A("invertNormalMapY")],k.prototype,"_invertNormalMapY",void 0);S([ae("_markAllSubMeshesAsTexturesDirty")],k.prototype,"invertNormalMapY",void 0);S([A("twoSidedLighting")],k.prototype,"_twoSidedLighting",void 0);S([ae("_markAllSubMeshesAsTexturesDirty")],k.prototype,"twoSidedLighting",void 0);S([A()],k.prototype,"useLogarithmicDepth",null);Ye("BABYLON.StandardMaterial",k);te.DefaultMaterialFactory=n=>new k("default material",n);var Ol="imageProcessingCompatibility",Ll=`#ifdef IMAGEPROCESSINGPOSTPROCESS
gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(2.2));
#endif
`;w.IncludesShadersStore[Ol]=Ll;var Nl="shadowOnlyPixelShader",Bl=`precision highp float;
uniform vec4 vEyePosition;
uniform float alpha;
uniform vec3 shadowColor;
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#include<helperFunctions>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=vec3(1.0,1.0,1.0);
#endif
vec3 diffuseBase=vec3(0.,0.,0.);
lightingInfo info;
float shadow=1.;
float glossiness=0.;
#include<lightFragment>[0..1]
vec4 color=vec4(shadowColor,(1.0-clamp(shadow,0.,1.))*alpha);
#include<fogFragment>
gl_FragColor=color;
#include<imageProcessingCompatibility>
#define CUSTOM_FRAGMENT_MAIN_END
}`;w.ShadersStore[Nl]=Bl;var Ul="shadowOnlyVertexShader",kl=`precision highp float;
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
uniform mat4 view;
uniform mat4 viewProjection;
#ifdef POINTSIZE
uniform float pointSize;
#endif
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef VERTEXCOLOR
varying vec4 vColor;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(position,1.0);
gl_Position=viewProjection*worldPos;
vPositionW=vec3(worldPos);
#ifdef NORMAL
vNormalW=normalize(vec3(finalWorld*vec4(normal,0.0)));
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#define CUSTOM_VERTEX_MAIN_END
}
`;w.ShadersStore[Ul]=kl;var Nr=class extends Oi{constructor(){super(),this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.NORMAL=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.rebuild()}},Ss=class n extends Ts{constructor(t,e){super(t,e),this._needAlphaBlending=!0,this.shadowColor=me.Black()}needAlphaBlending(){return this._needAlphaBlending}needAlphaTesting(){return!1}getAlphaTestTexture(){return null}get activeLight(){return this._activeLight}set activeLight(t){this._activeLight=t}_getFirstShadowLightForMesh(t){for(let e of t.lightSources)if(e.shadowEnabled)return e;return null}isReadyForSubMesh(t,e,i){var s;if(this.isFrozen&&e.effect&&e.effect._wasPreviouslyReady&&e.effect._wasPreviouslyUsingInstances===i)return!0;e.materialDefines||(e.materialDefines=new Nr);let r=e.materialDefines,a=this.getScene();if(this._isReadyForSubMesh(e))return!0;let o=a.getEngine();if(this._activeLight){for(let l of t.lightSources)if(l.shadowEnabled){if(this._activeLight===l)break;let c=t.lightSources.indexOf(this._activeLight);c!==-1&&(t.lightSources.splice(c,1),t.lightSources.splice(0,0,this._activeLight));break}}K.PrepareDefinesForFrameBoundValues(a,o,this,r,!!i),K.PrepareDefinesForMisc(t,a,!1,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(t),r),r._needNormals=K.PrepareDefinesForLights(a,t,r,!1,1);let h=(s=this._getFirstShadowLightForMesh(t))===null||s===void 0?void 0:s.getShadowGenerator();if(this._needAlphaBlending=!0,h&&h.getClassName&&h.getClassName()==="CascadedShadowGenerator"){let l=h;this._needAlphaBlending=!l.autoCalcDepthBounds}if(K.PrepareDefinesForAttributes(t,r,!1,!0),r.isDirty){r.markAsProcessed(),a.resetCachedMaterial();let l=new Gi;r.FOG&&l.addFallback(1,"FOG"),K.HandleFallbacksForShadows(r,l,1),r.NUM_BONE_INFLUENCERS>0&&l.addCPUSkinningFallback(0,t),r.IMAGEPROCESSINGPOSTPROCESS=a.imageProcessingConfiguration.applyByPostProcess;let c=[m.PositionKind];r.NORMAL&&c.push(m.NormalKind),K.PrepareAttributesForBones(c,t,r,l),K.PrepareAttributesForInstances(c,r);let d="shadowOnly",u=r.toString(),f=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","alpha","shadowColor","mBones"],_=new Array,g=new Array;xs(f),K.PrepareUniformsAndSamplersList({uniformsNames:f,uniformBuffersNames:g,samplers:_,defines:r,maxSimultaneousLights:1}),e.setEffect(a.getEngine().createEffect(d,{attributes:c,uniformsNames:f,uniformBuffersNames:g,samplers:_,defines:u,fallbacks:l,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:1}},o),r,this._materialContext)}return!e.effect||!e.effect.isReady()?!1:(r._renderId=a.getRenderId(),e.effect._wasPreviouslyReady=!0,e.effect._wasPreviouslyUsingInstances=!!i,!0)}bindForSubMesh(t,e,i){let s=this.getScene(),r=i.materialDefines;if(!r)return;let a=i.effect;if(a){if(this._activeEffect=a,this.bindOnlyWorldMatrix(t),this._activeEffect.setMatrix("viewProjection",s.getTransformMatrix()),K.BindBonesParameters(e,this._activeEffect),this._mustRebind(s,a)&&(Ms(a,this,s),this.pointsCloud&&this._activeEffect.setFloat("pointSize",this.pointSize),this._activeEffect.setFloat("alpha",this.alpha),this._activeEffect.setColor3("shadowColor",this.shadowColor),s.bindEyePosition(a)),s.lightsEnabled){K.BindLights(s,e,this._activeEffect,r,1);let o=this._getFirstShadowLightForMesh(e);o&&(o._renderId=-1)}(s.fogEnabled&&e.applyFog&&s.fogMode!==te.FOGMODE_NONE||r.SHADOWCSM0)&&this._activeEffect.setMatrix("view",s.getViewMatrix()),K.BindFogParameters(s,e,this._activeEffect),this._afterBind(e,this._activeEffect)}}clone(t){return ee.Clone(()=>new n(t,this.getScene()),this)}serialize(){let t=super.serialize();return t.customType="BABYLON.ShadowOnlyMaterial",t}getClassName(){return"ShadowOnlyMaterial"}static Parse(t,e,i){return ee.Parse(()=>new n(t.name,e),t,e,i)}};Ye("BABYLON.ShadowOnlyMaterial",Ss);var Vl={aspect:300/150,enableDebugging:!1,enableShadows:!0},Br=class{constructor(t){ot(this,"size",9.5),this.config=Xe(Xe({},Vl),t),this.create()}create(t){this.destroy(),Object.assign(this.config,t);let{aspect:e,enableDebugging:i=!0,enableShadows:s}=this.config,r=30,a;this.box=new oe("diceBox"),i?(a=new k("diceBox_material"),a.alpha=.7,a.diffuseColor=new me(1,1,0)):s&&(a=new Ss("shadowOnly",this.config.scene));let o=si("ground",{width:this.size*2,height:1,depth:this.size*2},this.config.scene);if(o.scaling=new v(e,1,1),o.material=a,o.receiveShadows=!0,o.setParent(this.box),i){let h=si("wallTop",{width:this.size,height:r,depth:1},this.config.scene);h.position.y=r/2,h.position.z=this.size/-2,h.scaling=new v(e,1,1),h.material=a,h.setParent(this.box);let l=si("wallRight",{width:1,height:r,depth:this.size},this.config.scene);l.position.x=this.size*e/2,l.position.y=r/2,l.material=a,l.setParent(this.box);let c=si("wallBottom",{width:this.size,height:r,depth:1},this.config.scene);c.position.y=r/2,c.position.z=this.size/2,c.scaling=new v(e,1,1),c.material=a,c.setParent(this.box);let d=si("wallLeft",{width:1,height:r,depth:this.size},this.config.scene);d.position.x=this.size*e/-2,d.position.y=r/2,d.material=a,d.setParent(this.box)}}destroy(){this.box&&this.box.dispose()}},kt;(function(n){n[n.Clean=0]="Clean",n[n.Stop=1]="Stop",n[n.Sync=2]="Sync",n[n.NoSync=3]="NoSync"})(kt||(kt={}));var Ae=class n{static get ForceFullSceneLoadingForIncremental(){return ft.ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(t){ft.ForceFullSceneLoadingForIncremental=t}static get ShowLoadingScreen(){return ft.ShowLoadingScreen}static set ShowLoadingScreen(t){ft.ShowLoadingScreen=t}static get loggingLevel(){return ft.loggingLevel}static set loggingLevel(t){ft.loggingLevel=t}static get CleanBoneMatrixWeights(){return ft.CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(t){ft.CleanBoneMatrixWeights=t}static GetDefaultPlugin(){return n._RegisteredPlugins[".babylon"]}static _GetPluginForExtension(t){return n._RegisteredPlugins[t]||(O.Warn("Unable to find a plugin to load "+t+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/features/featuresDeepDive/importers/loadingFileTypes"),n.GetDefaultPlugin())}static _GetPluginForDirectLoad(t){for(let e in n._RegisteredPlugins){let i=n._RegisteredPlugins[e].plugin;if(i.canDirectLoad&&i.canDirectLoad(t))return n._RegisteredPlugins[e]}return n.GetDefaultPlugin()}static _GetPluginForFilename(t){let e=t.indexOf("?");e!==-1&&(t=t.substring(0,e));let i=t.lastIndexOf("."),s=t.substring(i,t.length).toLowerCase();return n._GetPluginForExtension(s)}static _GetDirectLoad(t){return t.substr(0,5)==="data:"?t.substr(5):null}static _FormatErrorMessage(t,e,i){let s="Unable to load from "+t.url;return e?s+=`: ${e}`:i&&(s+=`: ${i}`),s}static _LoadData(t,e,i,s,r,a,o){let h=n._GetDirectLoad(t.url),l=o?n._GetPluginForExtension(o):h?n._GetPluginForDirectLoad(t.url):n._GetPluginForFilename(t.url),c;if(l.plugin.createPlugin!==void 0?c=l.plugin.createPlugin():c=l.plugin,!c)throw"The loader plugin corresponding to the file type you are trying to load has not been found. If using es6, please import the plugin you wish to use before.";if(n.OnPluginActivatedObservable.notifyObservers(c),h&&(c.canDirectLoad&&c.canDirectLoad(t.url)||!jr(t.url))){if(c.directLoad){let R=c.directLoad(e,h);R.then?R.then(y=>{i(c,y)}).catch(y=>{r("Error in directLoad of _loadData: "+y,y)}):i(c,R)}else i(c,h);return c}let d=l.isBinary,u=(R,y)=>{if(e.isDisposed){r("Scene has been disposed");return}i(c,R,y)},f=null,_=!1,g=c.onDisposeObservable;g&&g.add(()=>{_=!0,f&&(f.abort(),f=null),a()});let p=()=>{if(_)return;let R=(M,b)=>{r(M?.statusText,b)},y=t.file||t.url;f=c.loadFile?c.loadFile(e,y,u,s,d,R):e._loadFile(y,u,s,!0,d,R)},E=e.getEngine(),T=E.enableOfflineSupport;if(T){let R=!1;for(let y of e.disableOfflineSupportExceptionRules)if(y.test(t.url)){R=!0;break}T=!R}return T&&de.OfflineProviderFactory?e.offlineProvider=de.OfflineProviderFactory(t.url,p,E.disableManifestCheck):p(),c}static _GetFileInfo(t,e){let i,s,r=null;if(!e)i=t,s=Z.GetFilename(t),t=Z.GetFolderPath(t);else if(e.name){let a=e;i=`file:${a.name}`,s=a.name,r=a}else if(typeof e=="string"&&e.startsWith("data:"))i=e,s="";else{let a=e;if(a.substr(0,1)==="/")return Z.Error("Wrong sceneFilename parameter"),null;i=t+a,s=a}return{url:i,rootUrl:t,name:s,file:r}}static GetPluginForExtension(t){return n._GetPluginForExtension(t).plugin}static IsPluginForExtensionAvailable(t){return!!n._RegisteredPlugins[t]}static RegisterPlugin(t){if(typeof t.extensions=="string"){let e=t.extensions;n._RegisteredPlugins[e.toLowerCase()]={plugin:t,isBinary:!1}}else{let e=t.extensions;Object.keys(e).forEach(i=>{n._RegisteredPlugins[i.toLowerCase()]={plugin:t,isBinary:e[i].isBinary}})}}static ImportMesh(t,e,i="",s=Q.LastCreatedScene,r=null,a=null,o=null,h=null){if(!s)return O.Error("No scene available to import mesh to"),null;let l=n._GetFileInfo(e,i);if(!l)return null;let c={};s.addPendingData(c);let d=()=>{s.removePendingData(c)},u=(g,p)=>{let E=n._FormatErrorMessage(l,g,p);o?o(s,E,new Dt(E,qt.SceneLoaderError,p)):O.Error(E),d()},f=a?g=>{try{a(g)}catch(p){u("Error in onProgress callback: "+p,p)}}:void 0,_=(g,p,E,T,R,y,M)=>{if(s.importedMeshesFiles.push(l.url),r)try{r(g,p,E,T,R,y,M)}catch(b){u("Error in onSuccess callback: "+b,b)}s.removePendingData(c)};return n._LoadData(l,s,(g,p,E)=>{if(g.rewriteRootURL&&(l.rootUrl=g.rewriteRootURL(l.rootUrl,E)),g.importMesh){let T=g,R=new Array,y=new Array,M=new Array;if(!T.importMesh(t,s,p,l.rootUrl,R,y,M,u))return;s.loadingPluginName=g.name,_(R,y,M,[],[],[],[])}else g.importMeshAsync(t,s,p,l.rootUrl,f,l.name).then(T=>{s.loadingPluginName=g.name,_(T.meshes,T.particleSystems,T.skeletons,T.animationGroups,T.transformNodes,T.geometries,T.lights)}).catch(T=>{u(T.message,T)})},f,u,d,h)}static ImportMeshAsync(t,e,i="",s=Q.LastCreatedScene,r=null,a=null){return new Promise((o,h)=>{n.ImportMesh(t,e,i,s,(l,c,d,u,f,_,g)=>{o({meshes:l,particleSystems:c,skeletons:d,animationGroups:u,transformNodes:f,geometries:_,lights:g})},r,(l,c,d)=>{h(d||new Error(c))},a)})}static Load(t,e="",i=Q.LastCreatedEngine,s=null,r=null,a=null,o=null){return i?n.Append(t,e,new te(i),s,r,a,o):(Z.Error("No engine available"),null)}static LoadAsync(t,e="",i=Q.LastCreatedEngine,s=null,r=null){return new Promise((a,o)=>{n.Load(t,e,i,h=>{a(h)},s,(h,l,c)=>{o(c||new Error(l))},r)})}static Append(t,e="",i=Q.LastCreatedScene,s=null,r=null,a=null,o=null){if(!i)return O.Error("No scene available to append to"),null;let h=n._GetFileInfo(t,e);if(!h)return null;let l={};i.addPendingData(l);let c=()=>{i.removePendingData(l)};n.ShowLoadingScreen&&!this._ShowingLoadingScreen&&(this._ShowingLoadingScreen=!0,i.getEngine().displayLoadingUI(),i.executeWhenReady(()=>{i.getEngine().hideLoadingUI(),this._ShowingLoadingScreen=!1}));let d=(_,g)=>{let p=n._FormatErrorMessage(h,_,g);a?a(i,p,new Dt(p,qt.SceneLoaderError,g)):O.Error(p),c()},u=r?_=>{try{r(_)}catch(g){d("Error in onProgress callback",g)}}:void 0,f=()=>{if(s)try{s(i)}catch(_){d("Error in onSuccess callback",_)}i.removePendingData(l)};return n._LoadData(h,i,(_,g)=>{if(_.load){if(!_.load(i,g,h.rootUrl,d))return;i.loadingPluginName=_.name,f()}else _.loadAsync(i,g,h.rootUrl,u,h.name).then(()=>{i.loadingPluginName=_.name,f()}).catch(p=>{d(p.message,p)})},u,d,c,o)}static AppendAsync(t,e="",i=Q.LastCreatedScene,s=null,r=null){return new Promise((a,o)=>{n.Append(t,e,i,h=>{a(h)},s,(h,l,c)=>{o(c||new Error(l))},r)})}static LoadAssetContainer(t,e="",i=Q.LastCreatedScene,s=null,r=null,a=null,o=null){if(!i)return O.Error("No scene available to load asset container to"),null;let h=n._GetFileInfo(t,e);if(!h)return null;let l={};i.addPendingData(l);let c=()=>{i.removePendingData(l)},d=(_,g)=>{let p=n._FormatErrorMessage(h,_,g);a?a(i,p,new Dt(p,qt.SceneLoaderError,g)):O.Error(p),c()},u=r?_=>{try{r(_)}catch(g){d("Error in onProgress callback",g)}}:void 0,f=_=>{if(s)try{s(_)}catch(g){d("Error in onSuccess callback",g)}i.removePendingData(l)};return n._LoadData(h,i,(_,g)=>{if(_.loadAssetContainer){let p=_.loadAssetContainer(i,g,h.rootUrl,d);if(!p)return;i.loadingPluginName=_.name,f(p)}else _.loadAssetContainerAsync?_.loadAssetContainerAsync(i,g,h.rootUrl,u,h.name).then(p=>{i.loadingPluginName=_.name,f(p)}).catch(p=>{d(p.message,p)}):d("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")},u,d,c,o)}static LoadAssetContainerAsync(t,e="",i=Q.LastCreatedScene,s=null,r=null){return new Promise((a,o)=>{n.LoadAssetContainer(t,e,i,h=>{a(h)},s,(h,l,c)=>{o(c||new Error(l))},r)})}static ImportAnimations(t,e="",i=Q.LastCreatedScene,s=!0,r=kt.Clean,a=null,o=null,h=null,l=null,c=null){if(!i){O.Error("No scene available to load animations to");return}if(s){for(let f of i.animatables)f.reset();i.stopAllAnimations(),i.animationGroups.slice().forEach(f=>{f.dispose()}),i.getNodes().forEach(f=>{f.animations&&(f.animations=[])})}else switch(r){case kt.Clean:i.animationGroups.slice().forEach(f=>{f.dispose()});break;case kt.Stop:i.animationGroups.forEach(f=>{f.stop()});break;case kt.Sync:i.animationGroups.forEach(f=>{f.reset(),f.restart()});break;case kt.NoSync:break;default:O.Error("Unknown animation group loading mode value '"+r+"'");return}let d=i.animatables.length,u=f=>{f.mergeAnimationsTo(i,i.animatables.slice(d),a),f.dispose(),i.onAnimationFileImportedObservable.notifyObservers(i),o&&o(i)};this.LoadAssetContainer(t,e,i,u,h,l,c)}static ImportAnimationsAsync(t,e="",i=Q.LastCreatedScene,s=!0,r=kt.Clean,a=null,o=null,h=null,l=null,c=null){return new Promise((d,u)=>{n.ImportAnimations(t,e,i,s,r,a,f=>{d(f)},h,(f,_,g)=>{u(g||new Error(_))},c)})}};Ae.NO_LOGGING=0;Ae.MINIMAL_LOGGING=1;Ae.SUMMARY_LOGGING=2;Ae.DETAILED_LOGGING=3;Ae.OnPluginActivatedObservable=new D;Ae._RegisteredPlugins={};Ae._ShowingLoadingScreen=!1;var ke=class n{constructor(t,e,i=Number.MAX_VALUE){this.origin=t,this.direction=e,this.length=i}clone(){return new n(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(t,e,i=0){let s=n._TmpVector3[0].copyFromFloats(t.x-i,t.y-i,t.z-i),r=n._TmpVector3[1].copyFromFloats(e.x+i,e.y+i,e.z+i),a=0,o=Number.MAX_VALUE,h,l,c,d;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<s.x||this.origin.x>r.x)return!1}else if(h=1/this.direction.x,l=(s.x-this.origin.x)*h,c=(r.x-this.origin.x)*h,c===-1/0&&(c=1/0),l>c&&(d=l,l=c,c=d),a=Math.max(l,a),o=Math.min(c,o),a>o)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<s.y||this.origin.y>r.y)return!1}else if(h=1/this.direction.y,l=(s.y-this.origin.y)*h,c=(r.y-this.origin.y)*h,c===-1/0&&(c=1/0),l>c&&(d=l,l=c,c=d),a=Math.max(l,a),o=Math.min(c,o),a>o)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<s.z||this.origin.z>r.z)return!1}else if(h=1/this.direction.z,l=(s.z-this.origin.z)*h,c=(r.z-this.origin.z)*h,c===-1/0&&(c=1/0),l>c&&(d=l,l=c,c=d),a=Math.max(l,a),o=Math.min(c,o),a>o)return!1;return!0}intersectsBox(t,e=0){return this.intersectsBoxMinMax(t.minimum,t.maximum,e)}intersectsSphere(t,e=0){let i=t.center.x-this.origin.x,s=t.center.y-this.origin.y,r=t.center.z-this.origin.z,a=i*i+s*s+r*r,o=t.radius+e,h=o*o;if(a<=h)return!0;let l=i*this.direction.x+s*this.direction.y+r*this.direction.z;return l<0?!1:a-l*l<=h}intersectsTriangle(t,e,i){let s=n._TmpVector3[0],r=n._TmpVector3[1],a=n._TmpVector3[2],o=n._TmpVector3[3],h=n._TmpVector3[4];e.subtractToRef(t,s),i.subtractToRef(t,r),v.CrossToRef(this.direction,r,a);let l=v.Dot(s,a);if(l===0)return null;let c=1/l;this.origin.subtractToRef(t,o);let d=v.Dot(o,a)*c;if(d<0||d>1)return null;v.CrossToRef(o,s,h);let u=v.Dot(this.direction,h)*c;if(u<0||d+u>1)return null;let f=v.Dot(r,h)*c;return f>this.length?null:new Ni(1-d-u,d,f)}intersectsPlane(t){let e,i=v.Dot(t.normal,this.direction);if(Math.abs(i)<999999997475243e-21)return null;{let s=v.Dot(t.normal,this.origin);return e=(-t.d-s)/i,e<0?e<-999999997475243e-21?null:0:e}}intersectsAxis(t,e=0){switch(t){case"y":{let i=(this.origin.y-e)/this.direction.y;return i>0?null:new v(this.origin.x+this.direction.x*-i,e,this.origin.z+this.direction.z*-i)}case"x":{let i=(this.origin.x-e)/this.direction.x;return i>0?null:new v(e,this.origin.y+this.direction.y*-i,this.origin.z+this.direction.z*-i)}case"z":{let i=(this.origin.z-e)/this.direction.z;return i>0?null:new v(this.origin.x+this.direction.x*-i,this.origin.y+this.direction.y*-i,e)}default:return null}}intersectsMesh(t,e){let i=C.Matrix[0];return t.getWorldMatrix().invertToRef(i),this._tmpRay?n.TransformToRef(this,i,this._tmpRay):this._tmpRay=n.Transform(this,i),t.intersects(this._tmpRay,e)}intersectsMeshes(t,e,i){i?i.length=0:i=[];for(let s=0;s<t.length;s++){let r=this.intersectsMesh(t[s],e);r.hit&&i.push(r)}return i.sort(this._comparePickingInfo),i}_comparePickingInfo(t,e){return t.distance<e.distance?-1:t.distance>e.distance?1:0}intersectionSegment(t,e,i){let s=this.origin,r=C.Vector3[0],a=C.Vector3[1],o=C.Vector3[2],h=C.Vector3[3];e.subtractToRef(t,r),this.direction.scaleToRef(n._Rayl,o),s.addToRef(o,a),t.subtractToRef(s,h);let l=v.Dot(r,r),c=v.Dot(r,o),d=v.Dot(o,o),u=v.Dot(r,h),f=v.Dot(o,h),_=l*d-c*c,g,p=_,E,T=_;_<n._Smallnum?(g=0,p=1,E=f,T=d):(g=c*f-d*u,E=l*f-c*u,g<0?(g=0,E=f,T=d):g>p&&(g=p,E=f+c,T=d)),E<0?(E=0,-u<0?g=0:-u>l?g=p:(g=-u,p=l)):E>T&&(E=T,-u+c<0?g=0:-u+c>l?g=p:(g=-u+c,p=l));let R=Math.abs(g)<n._Smallnum?0:g/p,y=Math.abs(E)<n._Smallnum?0:E/T,M=C.Vector3[4];o.scaleToRef(y,M);let b=C.Vector3[5];r.scaleToRef(R,b),b.addInPlace(h);let x=C.Vector3[6];return b.subtractToRef(M,x),y>0&&y<=this.length&&x.lengthSquared()<i*i?b.length():-1}update(t,e,i,s,r,a,o,h=!1){if(h){n._RayDistant||(n._RayDistant=n.Zero()),n._RayDistant.unprojectRayToRef(t,e,i,s,P.IdentityReadOnly,a,o);let l=C.Matrix[0];r.invertToRef(l),n.TransformToRef(n._RayDistant,l,this)}else this.unprojectRayToRef(t,e,i,s,r,a,o);return this}static Zero(){return new n(v.Zero(),v.Zero())}static CreateNew(t,e,i,s,r,a,o){return n.Zero().update(t,e,i,s,r,a,o)}static CreateNewFromTo(t,e,i=P.IdentityReadOnly){let s=e.subtract(t),r=Math.sqrt(s.x*s.x+s.y*s.y+s.z*s.z);return s.normalize(),n.Transform(new n(t,s,r),i)}static Transform(t,e){let i=new n(new v(0,0,0),new v(0,0,0));return n.TransformToRef(t,e,i),i}static TransformToRef(t,e,i){v.TransformCoordinatesToRef(t.origin,e,i.origin),v.TransformNormalToRef(t.direction,e,i.direction),i.length=t.length;let s=i.direction,r=s.length();if(!(r===0||r===1)){let a=1/r;s.x*=a,s.y*=a,s.z*=a,i.length*=r}}unprojectRayToRef(t,e,i,s,r,a,o){var h;let l=C.Matrix[0];r.multiplyToRef(a,l),l.multiplyToRef(o,l),l.invert();let c=C.Vector3[0];c.x=t/i*2-1,c.y=-(e/s*2-1),c.z=!((h=Q.LastCreatedEngine)===null||h===void 0)&&h.isNDCHalfZRange?0:-1;let d=C.Vector3[1].copyFromFloats(c.x,c.y,1-1e-8),u=C.Vector3[2],f=C.Vector3[3];v._UnprojectFromInvertedMatrixToRef(c,l,u),v._UnprojectFromInvertedMatrixToRef(d,l,f),this.origin.copyFrom(u),f.subtractToRef(u,this.direction),this.direction.normalize()}};ke._TmpVector3=we.BuildArray(6,v.Zero);ke._RayDistant=ke.Zero();ke._Smallnum=1e-8;ke._Rayl=1e9;te.prototype.createPickingRay=function(n,t,e,i,s=!1){let r=ke.Zero();return this.createPickingRayToRef(n,t,e,r,i,s),r};te.prototype.createPickingRayToRef=function(n,t,e,i,s,r=!1,a=!1){let o=this.getEngine();if(!s){if(!this.activeCamera)return this;s=this.activeCamera}let h=s.viewport.toGlobal(o.getRenderWidth(),o.getRenderHeight());return n=n/o.getHardwareScalingLevel()-h.x,t=t/o.getHardwareScalingLevel()-(o.getRenderHeight()-h.y-h.height),i.update(n,t,h.width,h.height,e||P.IdentityReadOnly,r?P.IdentityReadOnly:s.getViewMatrix(),s.getProjectionMatrix(),a),this};te.prototype.createPickingRayInCameraSpace=function(n,t,e){let i=ke.Zero();return this.createPickingRayInCameraSpaceToRef(n,t,i,e),i};te.prototype.createPickingRayInCameraSpaceToRef=function(n,t,e,i){if(!lt)return this;let s=this.getEngine();if(!i){if(!this.activeCamera)throw new Error("Active camera not set");i=this.activeCamera}let r=i.viewport.toGlobal(s.getRenderWidth(),s.getRenderHeight()),a=P.Identity();return n=n/s.getHardwareScalingLevel()-r.x,t=t/s.getHardwareScalingLevel()-(s.getRenderHeight()-r.y-r.height),e.update(n,t,r.width,r.height,a,a,i.getProjectionMatrix()),this};te.prototype._internalPickForMesh=function(n,t,e,i,s,r,a,o){let h=t(i,e.enableDistantPicking),l=e.intersects(h,s,a,r,i,o);return!l||!l.hit||!s&&n!=null&&l.distance>=n.distance?null:l};te.prototype._internalPick=function(n,t,e,i,s){let r=null;for(let a=0;a<this.meshes.length;a++){let o=this.meshes[a];if(t){if(!t(o))continue}else if(!o.isEnabled()||!o.isVisible||!o.isPickable)continue;let h=o.getWorldMatrix();if(o.hasThinInstances&&o.thinInstanceEnablePicking){let l=this._internalPickForMesh(r,n,o,h,!0,!0,s);if(l){if(i)return l;let c=C.Matrix[1],d=o.thinInstanceGetWorldMatrices();for(let u=0;u<d.length;u++){d[u].multiplyToRef(h,c);let f=this._internalPickForMesh(r,n,o,c,e,i,s,!0);if(f&&(r=f,r.thinInstanceIndex=u,e))return r}}}else{let l=this._internalPickForMesh(r,n,o,h,e,i,s);if(l&&(r=l,e))return r}}return r||new lt};te.prototype._internalMultiPick=function(n,t,e){if(!lt)return null;let i=new Array;for(let s=0;s<this.meshes.length;s++){let r=this.meshes[s];if(t){if(!t(r))continue}else if(!r.isEnabled()||!r.isVisible||!r.isPickable)continue;let a=r.getWorldMatrix();if(r.hasThinInstances&&r.thinInstanceEnablePicking){if(this._internalPickForMesh(null,n,r,a,!0,!0,e)){let o=C.Matrix[1],h=r.thinInstanceGetWorldMatrices();for(let l=0;l<h.length;l++){h[l].multiplyToRef(a,o);let c=this._internalPickForMesh(null,n,r,o,!1,!1,e,!0);c&&(c.thinInstanceIndex=l,i.push(c))}}}else{let o=this._internalPickForMesh(null,n,r,a,!1,!1,e);o&&i.push(o)}}return i};te.prototype.pickWithBoundingInfo=function(n,t,e,i,s){if(!lt)return null;let r=this._internalPick(a=>(this._tempPickingRay||(this._tempPickingRay=ke.Zero()),this.createPickingRayToRef(n,t,a,this._tempPickingRay,s||null),this._tempPickingRay),e,i,!0);return r&&(r.ray=this.createPickingRay(n,t,P.Identity(),s||null)),r};Object.defineProperty(te.prototype,"_pickingAvailable",{get:()=>!0,enumerable:!1,configurable:!1});te.prototype.pick=function(n,t,e,i,s,r,a=!1){let o=this._internalPick((h,l)=>(this._tempPickingRay||(this._tempPickingRay=ke.Zero()),this.createPickingRayToRef(n,t,h,this._tempPickingRay,s||null,!1,l),this._tempPickingRay),e,i,!1,r);return o&&(o.ray=this.createPickingRay(n,t,P.Identity(),s||null)),o};te.prototype.pickWithRay=function(n,t,e,i){let s=this._internalPick(r=>(this._pickWithRayInverseMatrix||(this._pickWithRayInverseMatrix=P.Identity()),r.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||(this._cachedRayForTransform=ke.Zero()),ke.TransformToRef(n,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform),t,e,!1,i);return s&&(s.ray=n),s};te.prototype.multiPick=function(n,t,e,i,s){return this._internalMultiPick(r=>this.createPickingRay(n,t,r,i||null),e,s)};te.prototype.multiPickWithRay=function(n,t,e){return this._internalMultiPick(i=>(this._pickWithRayInverseMatrix||(this._pickWithRayInverseMatrix=P.Identity()),i.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||(this._cachedRayForTransform=ke.Zero()),ke.TransformToRef(n,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform),t,e)};ne.prototype.getForwardRay=function(n=100,t,e){return this.getForwardRayToRef(new ke(v.Zero(),v.Zero(),n),n,t,e)};ne.prototype.getForwardRayToRef=function(n,t=100,e,i){return e||(e=this.getWorldMatrix()),n.length=t,i?n.origin.copyFrom(i):n.origin.copyFrom(this.position),C.Vector3[2].set(0,0,this._scene.useRightHandedSystem?-1:1),v.TransformNormalToRef(C.Vector3[2],e,C.Vector3[3]),v.NormalizeToRef(C.Vector3[3],n.direction),n};var Gl=function(n,t,e){for(var i in t)if(n.name===t[i])return e.push(n.id),!0;return n.parentId&&e.indexOf(n.parentId)!==-1?(e.push(n.id),!0):!1},Zi=function(n,t){return n+" of "+(t?t.file+" from "+t.name+" version: "+t.version+", exporter version: "+t.exporter_version:"unknown")};Ae.RegisterPlugin({name:"babylon.js",extensions:".json",canDirectLoad:function(n){return n.indexOf("json"),!0},importMesh:function(n,t,e,i,s,r,a,o){var h="importMesh has failed JSON parse";try{var l=JSON.parse(e);l.physicsEnabled=!1,l?.meshes.map(T=>delete T.physicsImpostor),h="";var c=Ae.loggingLevel===Ae.DETAILED_LOGGING;n?Array.isArray(n)||(n=[n]):n=null;var d=new Array;if(l.meshes!==void 0&&l.meshes!==null){var u,f;for(u=0,f=l.meshes.length;u<f;u++){var _=l.meshes[u];if(n===null||Gl(_,n,d)){n!==null&&delete n[n.indexOf(_.name)];var g=W.Parse(_,t,i);s.push(g),h+=`
	Mesh `+g.toString(c)}}var p;for(u=0,f=t.meshes.length;u<f;u++)p=t.meshes[u],p._waitingParentId&&(p.parent=t.getLastEntryByID(p._waitingParentId),p._waitingParentId=null),p.computeWorldMatrix(!0)}return!0}catch(T){var E=Zi("importMesh",l?l.producer:"Unknown")+h;if(o)o(E,T);else throw O.Log(E),T}finally{h!==null&&Ae.loggingLevel!==Ae.NO_LOGGING&&O.Log(Zi("importMesh",l?l.producer:"Unknown")+(Ae.loggingLevel!==Ae.MINIMAL_LOGGING?h:""))}return!1},load:function(n,t,e,i){var s="importScene has failed JSON parse";try{var r=JSON.parse(t);s="",r.clearColor!==void 0&&r.clearColor!==null&&(n.clearColor=Color4.FromArray(r.clearColor));var a=loadAssetContainer(n,t,e,i,!0);return!!a}catch(h){var o=Zi("importScene",r?r.producer:"Unknown")+s;if(i)i(o,h);else throw O.Log(o),h}finally{s!==null&&Ae.loggingLevel!==Ae.NO_LOGGING&&O.Log(Zi("importScene",r?r.producer:"Unknown")+(Ae.loggingLevel!==Ae.MINIMAL_LOGGING?s:""))}return!1},loadAssetContainer:function(n,t,e,i){var s=loadAssetContainer(n,t,e,i);return s}});W._instancedMeshFactory=(n,t)=>{let e=new Ur(n,t);if(t.instancedBuffers){e.instancedBuffers={};for(let i in t.instancedBuffers)e.instancedBuffers[i]=t.instancedBuffers[i]}return e};var Ur=class extends Qr{constructor(t,e){super(t,e.getScene()),this._indexInSourceMeshInstanceArray=-1,this._distanceToCamera=0,e.addInstance(this),this._sourceMesh=e,this._unIndexed=e._unIndexed,this.position.copyFrom(e.position),this.rotation.copyFrom(e.rotation),this.scaling.copyFrom(e.scaling),e.rotationQuaternion&&(this.rotationQuaternion=e.rotationQuaternion.clone()),this.animations=e.animations.slice();for(let i of e.getAnimationRanges())i!=null&&this.createAnimationRange(i.name,i.from,i.to);this.infiniteDistance=e.infiniteDistance,this.setPivotMatrix(e.getPivotMatrix()),this.refreshBoundingInfo(!0,!0),this._syncSubMeshes()}getClassName(){return"InstancedMesh"}get lightSources(){return this._sourceMesh._lightSources}_resyncLightSources(){}_resyncLightSource(){}_removeLightSource(){}get receiveShadows(){return this._sourceMesh.receiveShadows}get material(){return this._sourceMesh.material}get visibility(){return this._sourceMesh.visibility}get skeleton(){return this._sourceMesh.skeleton}get renderingGroupId(){return this._sourceMesh.renderingGroupId}set renderingGroupId(t){!this._sourceMesh||t===this._sourceMesh.renderingGroupId||O.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")}getTotalVertices(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0}getTotalIndices(){return this._sourceMesh.getTotalIndices()}get sourceMesh(){return this._sourceMesh}createInstance(t){return this._sourceMesh.createInstance(t)}isReady(t=!1){return this._sourceMesh.isReady(t,!0)}getVerticesData(t,e){return this._sourceMesh.getVerticesData(t,e)}setVerticesData(t,e,i,s){return this.sourceMesh&&this.sourceMesh.setVerticesData(t,e,i,s),this.sourceMesh}updateVerticesData(t,e,i,s){return this.sourceMesh&&this.sourceMesh.updateVerticesData(t,e,i,s),this.sourceMesh}setIndices(t,e=null){return this.sourceMesh&&this.sourceMesh.setIndices(t,e),this.sourceMesh}isVerticesDataPresent(t){return this._sourceMesh.isVerticesDataPresent(t)}getIndices(){return this._sourceMesh.getIndices()}get _positions(){return this._sourceMesh._positions}refreshBoundingInfo(t=!1,e=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;let i=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getPositionData(t,e),i),this}_preActivate(){return this._currentLOD&&this._currentLOD._preActivate(),this}_activate(t,e){if(super._activate(t,e),this._sourceMesh.subMeshes||O.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){if(this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,t),e){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1}_postActivate(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)}getWorldMatrix(){if(this._currentLOD&&this._currentLOD.billboardMode!==oe.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new P);let t=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,C.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(C.Vector3[7]),this._currentLOD._masterMesh=t,this._billboardWorldMatrix}return super.getWorldMatrix()}get isAnInstance(){return!0}getLOD(t){if(!t)return this;let e=this.sourceMesh.getLODLevels();if(!e||e.length===0)this._currentLOD=this.sourceMesh;else{let i=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(t,i.boundingSphere)}return this._currentLOD}_preActivateForIntermediateRendering(t){return this.sourceMesh._preActivateForIntermediateRendering(t)}_syncSubMeshes(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(let t=0;t<this._sourceMesh.subMeshes.length;t++)this._sourceMesh.subMeshes[t].clone(this,this._sourceMesh);return this}_generatePointsArray(){return this._sourceMesh._generatePointsArray()}_updateBoundingInfo(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}clone(t,e=null,i,s){let r=(s||this._sourceMesh).createInstance(t);if(Fi.DeepCopy(this,r,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo"],[]),this.refreshBoundingInfo(),e&&(r.parent=e),!i)for(let a=0;a<this.getScene().meshes.length;a++){let o=this.getScene().meshes[a];o.parent===this&&o.clone(o.name,r)}return r.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(r),r}dispose(t,e=!1){this._sourceMesh.removeInstance(this),super.dispose(t,e)}_serializeAsParent(t){super._serializeAsParent(t),t.parentId=this._sourceMesh.uniqueId,t.parentInstanceIndex=this._indexInSourceMeshInstanceArray}instantiateHierarchy(t=null,e,i){let s=this.clone("Clone of "+(this.name||this.id),t||this.parent,!0,e&&e.newSourcedMesh);s&&i&&i(this,s);for(let r of this.getChildTransformNodes(!0))r.instantiateHierarchy(s,e,i);return s}};W.prototype.registerInstancedBuffer=function(n,t){var e,i;if((i=(e=this._userInstancedBuffersStorage)===null||e===void 0?void 0:e.vertexBuffers[n])===null||i===void 0||i.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(let s of this.instances)s.instancedBuffers={};this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0})}this.instancedBuffers[n]=null,this._userInstancedBuffersStorage.strides[n]=t,this._userInstancedBuffersStorage.sizes[n]=t*32,this._userInstancedBuffersStorage.data[n]=new Float32Array(this._userInstancedBuffersStorage.sizes[n]),this._userInstancedBuffersStorage.vertexBuffers[n]=new m(this.getEngine(),this._userInstancedBuffersStorage.data[n],n,!0,!1,t,!0);for(let s of this.instances)s.instancedBuffers[n]=null;this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()};W.prototype._processInstancedBuffers=function(n,t){let e=n?n.length:0;for(let i in this.instancedBuffers){let s=this._userInstancedBuffersStorage.sizes[i],r=this._userInstancedBuffersStorage.strides[i],a=(e+1)*r;for(;s<a;)s*=2;this._userInstancedBuffersStorage.data[i].length!=s&&(this._userInstancedBuffersStorage.data[i]=new Float32Array(s),this._userInstancedBuffersStorage.sizes[i]=s,this._userInstancedBuffersStorage.vertexBuffers[i]&&(this._userInstancedBuffersStorage.vertexBuffers[i].dispose(),this._userInstancedBuffersStorage.vertexBuffers[i]=null));let o=this._userInstancedBuffersStorage.data[i],h=0;if(t){let l=this.instancedBuffers[i];l.toArray?l.toArray(o,h):l.copyToArray?l.copyToArray(o,h):o[h]=l,h+=r}for(let l=0;l<e;l++){let c=n[l].instancedBuffers[i];c.toArray?c.toArray(o,h):c.copyToArray?c.copyToArray(o,h):o[h]=c,h+=r}this._userInstancedBuffersStorage.vertexBuffers[i]?this._userInstancedBuffersStorage.vertexBuffers[i].updateDirectly(o,0):(this._userInstancedBuffersStorage.vertexBuffers[i]=new m(this.getEngine(),this._userInstancedBuffersStorage.data[i],i,!0,!1,r,!0),this._invalidateInstanceVertexArrayObject())}};W.prototype._invalidateInstanceVertexArrayObject=function(){if(!(!this._userInstancedBuffersStorage||this._userInstancedBuffersStorage.vertexArrayObjects===void 0)){for(let n in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[n]);this._userInstancedBuffersStorage.vertexArrayObjects={}}};W.prototype._disposeInstanceSpecificData=function(){for(this._instanceDataStorage.instancesBuffer&&(this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(let n in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[n]&&this._userInstancedBuffersStorage.vertexBuffers[n].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}};var Wl={assetPath:"",enableShadows:!1,groupId:null,id:null,lights:[],rollId:null,scene:null},Ut=class{constructor(n,t){ot(this,"value",0),ot(this,"asleep",!1),this.config=Xe(Xe({},Wl),n),this.id=this.config.id!==void 0?this.config.id:Date.now(),this.sides=this.config.sides,this.dieType=this.config.dieType,this.comboKey=`${this.config.theme}_${this.config.dieType}`,this.scene=t,this.createInstance()}createInstance(){let n=`${this.config.meshName}_${this.dieType}_${this.config.theme}${this.config.colorSuffix}`,t=`${n}-instance-${this.id}`,e=this.scene.getMeshByName(n).createInstance(t);if(this.config.colorSuffix.length>0){let i=me.FromHexString(this.config.themeColor);e.instancedBuffers.customColor=i}e.position.y=-100,e.scaling=new v(e.scaling.x*this.config.scale,e.scaling.y*this.config.scale,e.scaling.z*this.config.scale),this.config.enableShadows&&this.config.lights.directional.shadowGenerator.addShadowCaster(e),this.mesh=e}static loadDie(n,t){return Ne(this,null,function*(){let{sides:e,theme:i="default",meshName:s,colorSuffix:r}=n;n.dieType||(n.dieType=Number.isInteger(e)?`d${e}`:e);let a=s+"_"+n.dieType,o=a+"_"+i+r,h=t.getMeshByName(o);return h||(h=t.getMeshByName(a).clone(o)),h.material||(h.material=t.getMaterialByName(i+r),r.length>0&&h.registerInstancedBuffer("customColor",3)),n})}static loadModels(n,t){return Ne(this,null,function*(){let{meshFilePath:e,meshName:i,scale:s,d4FaceDown:r=!0}=n,a=!1,o=!1,h=yield fetch(`${e}`).then(l=>{if(l.ok){let c=l.headers.get("content-type");if(c&&c.indexOf("application/json")!==-1||l.type&&l.type==="basic")return l.json();throw new Error(`Incorrect contentType: ${c}. Expected "application/json" or "basic"`)}else throw new Error(`Unable to load 3D mesh file: '${e}'. Request rejected with status ${l.status}: ${l.statusText}`)}).catch(l=>console.error(l));if(h)return Ae.ImportMeshAsync(null,null,"data:"+JSON.stringify(h),t).then(l=>{if(l.meshes.forEach(c=>{c.name==="__root__"&&c.dispose(),c.name.includes("collider")&&(c.scaling=new v(c.scaling.x*.9,c.scaling.y*.9,c.scaling.z*.9)),a||(a=c.name==="d100"),o||(o=c.name==="d10"),c.setEnabled(!1),c.freezeNormals(),c.freezeWorldMatrix(),c.isPickable=!1,c.doNotSyncBoundingInfo=!0,c.name=i+"_"+c.name}),!a&&o&&(t.getMeshByName(i+"_d10").clone(i+"_d100"),t.getMeshByName(i+"_d10_collider").clone(i+"_d100_collider"),h.colliderFaceMap&&(h.colliderFaceMap.d100=ws(h.colliderFaceMap.d10),Object.values(h.colliderFaceMap.d100).forEach((c,d)=>{h.colliderFaceMap.d100[d]=c*(c===10?0:10)}))),!h.colliderFaceMap)throw new Error(`'colliderFaceMap' data not found in ${e}. Without the colliderFaceMap data dice values can not be resolved.`);t.themeData[i]={},t.themeData[i].colliderFaceMap=h.colliderFaceMap,t.themeData[i].d4FaceDown=r}).catch(l=>console.error(l)),h.meshes.filter(l=>l.name.includes("collider"))})}updateConfig(n){this.config=Xe(Xe({},this.config),n)}static setVector3(n,t,e){return Ut.vector3.set(n,t,e)}static getVector3(){return Ut.vector3}static getRollResult(n,t){return Ne(this,null,function*(){let e=(i=n)=>new Promise((s,r)=>{let a=n.config.parentMesh||n.config.meshName,o=t.themeData[a].colliderFaceMap,h=t.themeData[a].d4FaceDown;if(!o[i.dieType])throw new Error(`No colliderFaceMap data for ${i.dieType}`);let l=t.getMeshByName(`${a}_${i.dieType}_collider`).createInstance(`${a}_${i.dieType}-hitbox-${i.id}`);l.isPickable=!0,l.isVisible=!0,l.setEnabled(!0),l.position=i.mesh.position,l.rotationQuaternion=i.mesh.rotationQuaternion;let c=Ut.setVector3(0,1,0);i.dieType==="d4"&&h&&(c=Ut.setVector3(0,-1,0)),Ut.ray.direction=c,Ut.ray.origin=n.mesh.position;let d=t.pickWithRay(Ut.ray);if(l.dispose(),i.value=o[i.dieType][d.faceId],i.value===void 0)throw new Error(`colliderFaceMap Error: No value found for ${i.dieType} mesh face ${d.faceId}`);return s(i.value)}).catch(s=>console.error(s));return n.mesh?yield e():n.value})}},Gt=Ut;ot(Gt,"ray",new ke(v.Zero(),v.Zero(),1)),ot(Gt,"vector3",v.Zero());var kr=class{constructor(){}},bs=(()=>{class n extends k{constructor(e,i){super(e,i),this.CustomParts=new kr,this.customShaderNameResolve=this.Builder,this.FragmentShader=Re.ShadersStore.defaultPixelShader,this.VertexShader=Re.ShadersStore.defaultVertexShader}AttachAfterBind(e,i){if(this._newUniformInstances)for(let s in this._newUniformInstances){let r=s.toString().split("-");r[0]=="vec2"?i.setVector2(r[1],this._newUniformInstances[s]):r[0]=="vec3"?i.setVector3(r[1],this._newUniformInstances[s]):r[0]=="vec4"?i.setVector4(r[1],this._newUniformInstances[s]):r[0]=="mat4"?i.setMatrix(r[1],this._newUniformInstances[s]):r[0]=="float"&&i.setFloat(r[1],this._newUniformInstances[s])}if(this._newSamplerInstances)for(let s in this._newSamplerInstances){let r=s.toString().split("-");r[0]=="sampler2D"&&this._newSamplerInstances[s].isReady&&this._newSamplerInstances[s].isReady()&&i.setTexture(r[1],this._newSamplerInstances[s])}}ReviewUniform(e,i){if(e=="uniform"&&this._newUniforms)for(let s=0;s<this._newUniforms.length;s++)this._customUniform[s].indexOf("sampler")==-1&&i.push(this._newUniforms[s]);if(e=="sampler"&&this._newUniforms)for(let s=0;s<this._newUniforms.length;s++)this._customUniform[s].indexOf("sampler")!=-1&&i.push(this._newUniforms[s]);return i}Builder(e,i,s,r,a,o){if(o&&this._customAttributes&&this._customAttributes.length>0&&o.push(...this._customAttributes),this.ReviewUniform("uniform",i),this.ReviewUniform("sampler",r),this._isCreatedShader)return this._createdShaderName;this._isCreatedShader=!1,n.ShaderIndexer++;let h="custom_"+n.ShaderIndexer,l=this._afterBind.bind(this);return this._afterBind=(c,d)=>{if(d){this.AttachAfterBind(c,d);try{l(c,d)}catch{}}},Re.ShadersStore[h+"VertexShader"]=this.VertexShader.replace("#define CUSTOM_VERTEX_BEGIN",this.CustomParts.Vertex_Begin?this.CustomParts.Vertex_Begin:"").replace("#define CUSTOM_VERTEX_DEFINITIONS",(this._customUniform?this._customUniform.join(`
`):"")+(this.CustomParts.Vertex_Definitions?this.CustomParts.Vertex_Definitions:"")).replace("#define CUSTOM_VERTEX_MAIN_BEGIN",this.CustomParts.Vertex_MainBegin?this.CustomParts.Vertex_MainBegin:"").replace("#define CUSTOM_VERTEX_UPDATE_POSITION",this.CustomParts.Vertex_Before_PositionUpdated?this.CustomParts.Vertex_Before_PositionUpdated:"").replace("#define CUSTOM_VERTEX_UPDATE_NORMAL",this.CustomParts.Vertex_Before_NormalUpdated?this.CustomParts.Vertex_Before_NormalUpdated:"").replace("#define CUSTOM_VERTEX_MAIN_END",this.CustomParts.Vertex_MainEnd?this.CustomParts.Vertex_MainEnd:""),this.CustomParts.Vertex_After_WorldPosComputed&&(Re.ShadersStore[h+"VertexShader"]=Re.ShadersStore[h+"VertexShader"].replace("#define CUSTOM_VERTEX_UPDATE_WORLDPOS",this.CustomParts.Vertex_After_WorldPosComputed)),Re.ShadersStore[h+"PixelShader"]=this.FragmentShader.replace("#define CUSTOM_FRAGMENT_BEGIN",this.CustomParts.Fragment_Begin?this.CustomParts.Fragment_Begin:"").replace("#define CUSTOM_FRAGMENT_MAIN_BEGIN",this.CustomParts.Fragment_MainBegin?this.CustomParts.Fragment_MainBegin:"").replace("#define CUSTOM_FRAGMENT_DEFINITIONS",(this._customUniform?this._customUniform.join(`
`):"")+(this.CustomParts.Fragment_Definitions?this.CustomParts.Fragment_Definitions:"")).replace("#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE",this.CustomParts.Fragment_Custom_Diffuse?this.CustomParts.Fragment_Custom_Diffuse:"").replace("#define CUSTOM_FRAGMENT_UPDATE_ALPHA",this.CustomParts.Fragment_Custom_Alpha?this.CustomParts.Fragment_Custom_Alpha:"").replace("#define CUSTOM_FRAGMENT_BEFORE_LIGHTS",this.CustomParts.Fragment_Before_Lights?this.CustomParts.Fragment_Before_Lights:"").replace("#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR",this.CustomParts.Fragment_Before_FragColor?this.CustomParts.Fragment_Before_FragColor:"").replace("#define CUSTOM_FRAGMENT_MAIN_END",this.CustomParts.Fragment_MainEnd?this.CustomParts.Fragment_MainEnd:""),this.CustomParts.Fragment_Before_Fog&&(Re.ShadersStore[h+"PixelShader"]=Re.ShadersStore[h+"PixelShader"].replace("#define CUSTOM_FRAGMENT_BEFORE_FOG",this.CustomParts.Fragment_Before_Fog)),this._isCreatedShader=!0,this._createdShaderName=h,h}AddUniform(e,i,s){return this._customUniform||(this._customUniform=new Array,this._newUniforms=new Array,this._newSamplerInstances={},this._newUniformInstances={}),s&&(i.indexOf("sampler")!=-1?this._newSamplerInstances[i+"-"+e]=s:this._newUniformInstances[i+"-"+e]=s),this._customUniform.push("uniform "+i+" "+e+";"),this._newUniforms.push(e),this}AddAttribute(e){return this._customAttributes||(this._customAttributes=[]),this._customAttributes.push(e),this}Fragment_Begin(e){return this.CustomParts.Fragment_Begin=e,this}Fragment_Definitions(e){return this.CustomParts.Fragment_Definitions=e,this}Fragment_MainBegin(e){return this.CustomParts.Fragment_MainBegin=e,this}Fragment_MainEnd(e){return this.CustomParts.Fragment_MainEnd=e,this}Fragment_Custom_Diffuse(e){return this.CustomParts.Fragment_Custom_Diffuse=e.replace("result","diffuseColor"),this}Fragment_Custom_Alpha(e){return this.CustomParts.Fragment_Custom_Alpha=e.replace("result","alpha"),this}Fragment_Before_Lights(e){return this.CustomParts.Fragment_Before_Lights=e,this}Fragment_Before_Fog(e){return this.CustomParts.Fragment_Before_Fog=e,this}Fragment_Before_FragColor(e){return this.CustomParts.Fragment_Before_FragColor=e.replace("result","color"),this}Vertex_Begin(e){return this.CustomParts.Vertex_Begin=e,this}Vertex_Definitions(e){return this.CustomParts.Vertex_Definitions=e,this}Vertex_MainBegin(e){return this.CustomParts.Vertex_MainBegin=e,this}Vertex_Before_PositionUpdated(e){return this.CustomParts.Vertex_Before_PositionUpdated=e.replace("result","positionUpdated"),this}Vertex_Before_NormalUpdated(e){return this.CustomParts.Vertex_Before_NormalUpdated=e.replace("result","normalUpdated"),this}Vertex_After_WorldPosComputed(e){return this.CustomParts.Vertex_After_WorldPosComputed=e,this}Vertex_MainEnd(e){return this.CustomParts.Vertex_MainEnd=e,this}}return n.ShaderIndexer=1,n})();Ye("BABYLON.CustomMaterial",bs);bs.prototype.clone=function(n){let t=this,e=ee.Clone(()=>new bs(n,this.getScene()),this);return e.name=n,e.id=n,e.CustomParts.Fragment_Begin=t.CustomParts.Fragment_Begin,e.CustomParts.Fragment_Definitions=t.CustomParts.Fragment_Definitions,e.CustomParts.Fragment_MainBegin=t.CustomParts.Fragment_MainBegin,e.CustomParts.Fragment_Custom_Diffuse=t.CustomParts.Fragment_Custom_Diffuse,e.CustomParts.Fragment_Before_Lights=t.CustomParts.Fragment_Before_Lights,e.CustomParts.Fragment_Before_Fog=t.CustomParts.Fragment_Before_Fog,e.CustomParts.Fragment_Custom_Alpha=t.CustomParts.Fragment_Custom_Alpha,e.CustomParts.Fragment_Before_FragColor=t.CustomParts.Fragment_Before_FragColor,e.CustomParts.Vertex_Begin=t.CustomParts.Vertex_Begin,e.CustomParts.Vertex_Definitions=t.CustomParts.Vertex_Definitions,e.CustomParts.Vertex_MainBegin=t.CustomParts.Vertex_MainBegin,e.CustomParts.Vertex_Before_PositionUpdated=t.CustomParts.Vertex_Before_PositionUpdated,e.CustomParts.Vertex_Before_NormalUpdated=t.CustomParts.Vertex_Before_NormalUpdated,e.CustomParts.Vertex_After_WorldPosComputed=t.CustomParts.Vertex_After_WorldPosComputed,e.CustomParts.Vertex_MainEnd=t.CustomParts.Vertex_MainEnd,e};var Vr=class{constructor(t){ot(this,"loadedThemes",{}),ot(this,"themeData",{}),this.scene=t.scene}loadStandardMaterial(t){return Ne(this,null,function*(){let{theme:e,material:i}=t,s=new k(e,this.scene);i.diffuseTexture&&(s.diffuseTexture=yield this.getTexture("diffuse",t)),i.bumpTexture&&(s.bumpTexture=yield this.getTexture("bump",t)),i.specularTexture&&(s.specularTexture=yield this.getTexture("specular",t)),s.allowShaderHotSwapping=!1})}loadColorMaterial(t){return Ne(this,null,function*(){let{theme:e,material:i}=t,s=new bs(e+"_light",this.scene),r=ws(t);i.diffuseTexture&&i.diffuseTexture.light&&(r.material.diffuseTexture=t.material.diffuseTexture.light,s.diffuseTexture=yield this.getTexture("diffuse",r)),i.bumpTexture&&(s.bumpTexture=yield this.getTexture("bump",t)),i.specularTexture&&(s.specularTexture=yield this.getTexture("specular",t)),s.allowShaderHotSwapping=!1,s.Vertex_Definitions(`
      attribute vec3 customColor;
      varying vec3 vColor;
    `).Vertex_MainEnd(`
      vColor = customColor;
    `).Fragment_Definitions(`
      varying vec3 vColor;
    `).Fragment_Custom_Diffuse(`
      baseColor.rgb = mix(vColor.rgb, baseColor.rgb, baseColor.a);
    `),s.AddAttribute("customColor");let a=s.clone(e+"_dark");i.diffuseTexture&&i.diffuseTexture.dark&&(r.material.diffuseTexture=t.material.diffuseTexture.dark,a.diffuseTexture=yield this.getTexture("diffuse",r)),a.AddAttribute("customColor")})}getTexture(t,e){return Ne(this,null,function*(){let{basePath:i,material:s,theme:r}=e,a,o=t+"Level",h=t+"Texture";try{switch(t){case"diffuse":a=yield this.importTextureAsync(`${i}/${s[h]}`,r),s[o]&&(a.level=s[o]);break;case"bump":a=yield this.importTextureAsync(`${i}/${s[h]}`,r),s[o]&&(a.level=s[o]);break;case"specular":a=yield this.importTextureAsync(`${i}/${s[h]}`,r),s.specularPower&&(a.specularPower=s.specularPower);break;default:throw new Error(`Texture type: ${t} is not supported`)}}catch(l){console.error(l)}return a})}importTextureAsync(t,e){return Ne(this,null,function*(){return new Promise((i,s)=>{let r=t.match(/^(.*\/)(.*)$/),a=new L(t,this.scene,void 0,!0,void 0,()=>i(a),()=>s(`Unable to load texture '${r[2]}' for theme: '${e}'. Check that your assetPath is configured correctly and that the files exist at path: '${r[1]}'`))}).catch(i=>console.error(i))})}load(t){return Ne(this,null,function*(){let{material:e}=t;e.type==="color"?yield this.loadColorMaterial(t):e.type==="standard"?yield this.loadStandardMaterial(t):console.error(`Material type: ${e.type} not supported`)})}},Pe,xi,At,Mi,ut,at,Ve,Gr,pt,es,ts,et,is,Wr,Bn,mn=class{constructor(t){je(this,Wr),ot(this,"config"),ot(this,"initialized",!1),je(this,Pe,{}),je(this,xi,0),je(this,At,0),je(this,Mi,[]),je(this,ut,void 0),je(this,at,void 0),je(this,Ve,void 0),je(this,Gr,void 0),je(this,pt,void 0),je(this,es,void 0),je(this,ts,void 0),je(this,et,void 0),je(this,is,{}),ot(this,"noop",()=>{}),ot(this,"diceBufferView",new Float32Array(8e3)),this.onInitComplete=t.onInitComplete||this.noop,this.onThemeLoaded=t.onThemeLoaded||this.noop,this.onRollResult=t.onRollResult||this.noop,this.onRollComplete=t.onRollComplete||this.noop,this.onDieRemoved=t.onDieRemoved||this.noop,this.initialized=this.initScene(t)}initScene(t){return Ne(this,null,function*(){$e(this,ut,t.canvas),z(this,ut).width=t.width,z(this,ut).height=t.height,this.config=t.options,$e(this,at,Zn(z(this,ut))),$e(this,Ve,pa({engine:z(this,at)})),$e(this,Gr,ga({engine:z(this,at),scene:z(this,Ve)})),$e(this,pt,gn({enableShadows:this.config.enableShadows,shadowTransparency:this.config.shadowTransparency,intensity:this.config.lightIntensity,scene:z(this,Ve)})),$e(this,es,new Br({enableShadows:this.config.enableShadows,aspect:z(this,ut).width/z(this,ut).height,lights:z(this,pt),scene:z(this,Ve)})),$e(this,ts,new Vr({scene:z(this,Ve)})),this.onInitComplete()})}connect(t){$e(this,et,t),z(this,et).postMessage({action:"initBuffer",diceBuffer:this.diceBufferView.buffer},[this.diceBufferView.buffer]),z(this,et).onmessage=e=>{switch(e.data.action){case"updates":this.updatesFromPhysics(e.data.diceBuffer);break;default:console.error("action from physicsWorker not found in offscreen worker");break}}}updateConfig(t){let e=this.config;this.config=t,e.enableShadows!==this.config.enableShadows&&(Object.values(z(this,pt)).forEach(i=>i.dispose()),$e(this,pt,gn({enableShadows:this.config.enableShadows}))),e.scale!==this.config.scale&&Object.values(z(this,Pe)).forEach(({mesh:i})=>{i&&(i.scaling=new v(this.config.scale,this.config.scale,this.config.scale))}),e.shadowTransparency!==this.config.shadowTransparency&&(z(this,pt).directional.shadowGenerator.darkness=this.config.shadowTransparency),e.lightIntensity!==this.config.lightIntensity&&(z(this,pt).directional.intensity=.65*this.config.lightIntensity,z(this,pt).hemispheric.intensity=.4*this.config.lightIntensity)}render(t){z(this,at).runRenderLoop(this.renderLoop.bind(this)),z(this,et).postMessage({action:"resumeSimulation",newStartPoint:t})}renderLoop(){z(this,At)&&z(this,At)===Object.keys(z(this,Pe)).length?(z(this,at).stopRenderLoop(),z(this,et).postMessage({action:"stopSimulation"}),this.onRollComplete()):z(this,Ve).render()}loadTheme(t){return Ne(this,null,function*(){let{theme:e,basePath:i,material:s,meshFilePath:r,meshName:a}=t;if(yield z(this,ts).load({theme:e,basePath:i,material:s}),!Object.keys(z(this,is)).includes(a)){z(this,is)[a]=r;let o=yield Gt.loadModels({meshFilePath:r,meshName:a},z(this,Ve));if(!o)throw new Error("No colliders returned from the 3D mesh file. Low poly colliders are expected to be in the same file as the high poly dice and the mesh name contains the word 'collider'");z(this,et).postMessage({action:"loadModels",options:{colliders:o,meshName:a}})}this.onThemeLoaded({id:e})})}clear(){!Object.keys(z(this,Pe)).length&&!z(this,At)||(this.diceBufferView.byteLength&&this.diceBufferView.fill(0),z(this,Mi).forEach(t=>clearTimeout(t)),z(this,at).stopRenderLoop(),Object.values(z(this,Pe)).forEach(t=>{t.mesh&&t.mesh.dispose()}),$e(this,Pe,{}),$e(this,xi,0),$e(this,At,0),z(this,Ve).render())}add(t){Gt.loadDie(t,z(this,Ve)).then(e=>{z(this,Mi).push(setTimeout(()=>{Gn(this,Wr,Bn).call(this,e)},Ei(this,xi)._++*this.config.delay))})}addNonDie(t){z(this,at).activeRenderLoops.length===0&&this.render(!1);let a=t,{id:e,value:i}=a,s=Jr(a,["id","value"]),r={id:e,value:i,config:s};z(this,Pe)[e]=r,setTimeout(()=>{z(this,Mi).push(setTimeout(()=>{this.handleAsleep(r)},Ei(this,xi)._++*this.config.delay))},10)}remove(t){let e=z(this,Pe)[t.id];e.hasOwnProperty("d10Instance")&&(z(this,Pe)[e.d10Instance.id].mesh&&(z(this,Pe)[e.d10Instance.id].mesh.dispose(),z(this,et).postMessage({action:"removeDie",id:e.d10Instance.id})),delete z(this,Pe)[e.d10Instance.id],Ei(this,At)._--),z(this,Pe)[t.id].mesh&&z(this,Pe)[t.id].mesh.dispose(),delete z(this,Pe)[t.id],Ei(this,At)._--,z(this,Ve).render(),this.onDieRemoved(t.rollId)}updatesFromPhysics(t){this.diceBufferView=new Float32Array(t);let e=1;for(let i=0,s=this.diceBufferView[0];i<s;i++){if(!Object.keys(z(this,Pe)).length)continue;let r=z(this,Pe)[`${this.diceBufferView[e]}`];if(!r){console.log("Error: die not available in scene to animate");break}if(this.diceBufferView[e+1]===-1)this.handleAsleep(r);else{let a=this.diceBufferView[e+1],o=this.diceBufferView[e+2],h=this.diceBufferView[e+3],l=this.diceBufferView[e+4],c=this.diceBufferView[e+5],d=this.diceBufferView[e+6],u=this.diceBufferView[e+7];r.mesh.position.set(a,o,h),r.mesh.rotationQuaternion.set(l,c,d,u)}e=e+8}requestAnimationFrame(()=>{z(this,et).postMessage({action:"stepSimulation",diceBuffer:this.diceBufferView.buffer},[this.diceBufferView.buffer])})}handleAsleep(t){return Ne(this,null,function*(){var e,i;if(t.asleep=!0,yield Gt.getRollResult(t,z(this,Ve)),t.d10Instance||t.dieParent){if((e=t?.d10Instance)!=null&&e.asleep||(i=t?.dieParent)!=null&&i.asleep){let s=t.config.sides===100?t:t.dieParent,r=t.config.sides===10?t:t.d10Instance;r.value===0&&s.value===0?s.value=100:s.value=s.value+r.value,this.onRollResult({rollId:s.config.rollId,value:s.value})}}else t.config.sides===10&&t.value===0&&(t.value=10),this.onRollResult({rollId:t.config.rollId,value:t.value});Ei(this,At)._++})}resize(t){let e=z(this,ut).width=t.width,i=z(this,ut).height=t.height;z(this,es).create({aspect:e/i}),z(this,at).resize()}};Pe=new WeakMap,xi=new WeakMap,At=new WeakMap,Mi=new WeakMap,ut=new WeakMap,at=new WeakMap,Ve=new WeakMap,Gr=new WeakMap,pt=new WeakMap,es=new WeakMap,ts=new WeakMap,et=new WeakMap,is=new WeakMap,Wr=new WeakSet,Bn=function(n){return Ne(this,null,function*(){z(this,at).activeRenderLoops.length===0&&this.render(n.newStartPoint);let t=Fs(Xe({},n),{assetPath:this.config.assetPath,enableShadows:this.config.enableShadows,scale:this.config.scale,lights:z(this,pt)}),e=new Gt(t,z(this,Ve));return z(this,Pe)[e.id]=e,z(this,et).postMessage({action:"addDie",options:{sides:n.sides,scale:this.config.scale,id:e.id,newStartPoint:n.newStartPoint,theme:n.theme,meshName:n.meshName}}),n.sides===100&&n.data!=="single"&&(e.d10Instance=yield Gt.loadDie(Fs(Xe({},t),{dieType:"d10",sides:10,id:e.id+1e4}),z(this,Ve)).then(i=>{let s=new Gt(i,z(this,Ve));return s.dieParent=e,s}),z(this,Pe)[`${e.d10Instance.id}`]=e.d10Instance,z(this,et).postMessage({action:"addDie",options:{sides:10,scale:this.config.scale,id:e.d10Instance.id,theme:n.theme,meshName:n.meshName}})),e})};export{mn as default};
